<?php
declare(strict_types=1);

require_once __DIR__ . '/../../../includes/core/auth.php';
require_once __DIR__.'/../../../services/ar/armarkerstorage.php';
require_once __DIR__.'/../../../includes/Core/APIResponse.php';

// Initialize database connection
$pdo = Core\Auth::getDBConnection();
ARMarkerStorage::initialize($pdo);

try {
    // Validate API key
    if (!Core\Auth::validateApiKey()) {
        APIResponse::error(401, 'Invalid API key');
    }

    // Get and validate input
    $input = json_decode(file_get_contents('php://input'), true);
    if (!isset($input['marker_id'])) {
        APIResponse::error(400, 'Missing marker_id parameter');
    }

    $markerId = (int)$input['marker_id'];
    $strict = $input['strict'] ?? true;

    // Validate marker
    $marker = ARMarkerStorage::getById($markerId);
    if (!$marker) {
        APIResponse::error(404, 'Marker not found');
    }

    $isValid = $strict 
        ? ARMarkerStorage::validateActive($markerId)
        : true;

    // Record usage if valid
    if ($isValid) {
        ARMarkerStorage::recordUsage($markerId);
    }

    APIResponse::success([
        'valid' => $isValid,
        'expires_at' => $marker['expires_at'],
        'usage_count' => $marker['usage_count'] + ($isValid ? 1 : 0)
    ]);

} catch (Exception $e) {
    APIResponse::error(500, $e->getMessage());
}
