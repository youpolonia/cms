<?php
/**
 * AI Content Generator API for Theme Builder
 */

if (!defined('CMS_ROOT')) {
    define('CMS_ROOT', dirname(dirname(__DIR__)));
}

require_once CMS_ROOT . '/config.php';
require_once CMS_ROOT . '/core/session_boot.php';
cms_session_start('admin');

header('Content-Type: application/json');

// Check admin auth
$isAdmin = isset($_SESSION['admin_logged_in']) && $_SESSION['admin_logged_in'] === true;
if (!$isAdmin && isset($_SESSION['admin_user_id'])) $isAdmin = true;
if (!$isAdmin && isset($_SESSION['user_id'])) $isAdmin = true;

if (!$isAdmin) {
    echo json_encode(['success' => false, 'error' => 'Unauthorized']);
    exit;
}

// Validate CSRF token
require_once CMS_ROOT . '/core/csrf.php';
csrf_boot('admin');
$csrfToken = $_POST['csrf_token'] ?? '';
if (!csrf_validate($csrfToken)) {
    echo json_encode(['success' => false, 'error' => 'Invalid CSRF token']);
    exit;
}

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    echo json_encode(['success' => false, 'error' => 'Method not allowed']);
    exit;
}

$type = $_POST['type'] ?? 'paragraph';
$prompt = trim($_POST['prompt'] ?? '');

if (empty($prompt)) {
    echo json_encode(['success' => false, 'error' => 'Prompt is required']);
    exit;
}

require_once CMS_ROOT . '/core/ai_content.php';
$config = ai_config_load();

if (empty($config['api_key'])) {
    echo json_encode(['success' => false, 'error' => 'AI not configured - no API key']);
    exit;
}

$systemPrompts = [
    // Text content
    'heading' => 'Generate a short compelling headline (max 10 words). Return ONLY the headline text.',
    'paragraph' => 'Generate a concise paragraph (2-4 sentences). Return ONLY the paragraph text.',
    'cta' => 'Generate a compelling call-to-action (1-2 sentences). Return ONLY the CTA text.',
    'features' => 'Generate a brief feature description (2-3 sentences). Return ONLY the text.',
    'testimonial' => 'Generate a brief testimonial (2-3 sentences). Return ONLY the text.',
    
    // HTML components
    'html' => 'You are an expert HTML developer. Generate clean, semantic HTML code for a widget/component based on the description. Use inline styles for visual appearance. Include appropriate HTML tags (div, h1-h6, p, ul, li, a, span, etc.). Make it visually appealing with colors, padding, margins. Return ONLY the HTML code, no markdown, no explanation, no ```html tags.',
    'html_banner' => 'Generate a promotional HTML banner with eye-catching design. Use inline CSS for styling (background colors/gradients, padding, text styling, border-radius). Include heading, description, and call-to-action button. Return ONLY the HTML code.',
    'html_card' => 'Generate an HTML card component with clean design. Include heading, content, and optional button. Use inline CSS for modern styling. Return ONLY the HTML code.',
    'html_list' => 'Generate an HTML list/features section. Use ul/li or div structure with icons (emoji or HTML entities). Apply inline CSS for spacing and styling. Return ONLY the HTML code.',
    'html_contact' => 'Generate an HTML contact information block. Include address, phone, email with appropriate icons. Style with inline CSS. Return ONLY the HTML code.',
    
    // Code snippets
    'code_js' => 'You are an expert JavaScript developer. Generate clean, well-commented JavaScript code based on the description. Use modern ES6+ syntax. Include error handling where appropriate. Return ONLY the JavaScript code wrapped in <script> tags, no markdown, no explanation.',
    'code_css' => 'You are an expert CSS developer. Generate clean, well-organized CSS code based on the description. Use modern CSS features. Include helpful comments. Return ONLY the CSS code wrapped in <style> tags, no markdown, no explanation.',
    'code_json' => 'You are an expert in JSON configuration. Generate valid, well-structured JSON based on the description. Use descriptive keys. Return ONLY the raw JSON object, no markdown, no explanation, no wrapping.',
    'code_schema' => 'You are an expert in Schema.org structured data. Generate valid JSON-LD schema markup based on the description. Follow Schema.org specifications. Return ONLY the complete <script type="application/ld+json"> tag with the JSON-LD inside, no markdown, no explanation.',
    'code_analytics' => 'You are an expert in web analytics. Generate the tracking/analytics code snippet based on the description. Include necessary script tags and initialization. Return ONLY the code, no markdown, no explanation.',
    'code_embed' => 'Generate an embed code snippet based on the description. Include proper HTML structure and any necessary wrapper divs with styling. Return ONLY the HTML/embed code, no markdown, no explanation.',
    'code_iframe' => 'Generate an iframe embed code based on the description. Include proper attributes (src, width, height, frameborder, allow, etc.) and a responsive wrapper div if needed. Return ONLY the HTML code, no markdown, no explanation.',
    
    // Markdown content
    'markdown' => 'Generate well-formatted Markdown content based on the description. Use proper Markdown syntax: # for headings, **bold**, *italic*, - for lists, > for quotes, ``` for code blocks. Return ONLY the Markdown text, no explanation.',
    'markdown_faq' => 'Generate an FAQ section in Markdown format. Use ## for questions, regular text for answers. Include 3-5 relevant Q&A pairs. Return ONLY the Markdown, no explanation.',
    'markdown_terms' => 'Generate a legal document structure in Markdown. Use proper headings hierarchy (##, ###), numbered lists for terms, and professional language. Return ONLY the Markdown, no explanation.',
    
    // Shortcodes
    'shortcode' => 'Generate a shortcode based on the description. Use format [shortcode_name attr="value"]. Include helpful comments about available attributes. Return ONLY the shortcode with brief attribute documentation.',
    'shortcode_form' => 'Generate a contact form shortcode with common fields. Format: [contact_form fields="name,email,message" submit="Send"]. Include attribute explanations. Return ONLY the shortcode.',
    'shortcode_gallery' => 'Generate a gallery shortcode. Format: [gallery ids="1,2,3" columns="3" lightbox="true"]. Include attribute explanations. Return ONLY the shortcode.'
];

// Map widget content types to appropriate prompt
$promptType = $type;
if ($type === 'paragraph' && (stripos($prompt, 'banner') !== false || stripos($prompt, 'html') !== false)) {
    $promptType = 'html';
}

// Set max_tokens based on content type (code/markdown needs more)
$maxTokens = 500;
if (strpos($type, 'code_') === 0 || strpos($type, 'html') === 0 || strpos($type, 'markdown') === 0) {
    $maxTokens = 1500;
}

$payload = [
    'model' => $config['model'] ?? 'gpt-4o-mini',
    'messages' => [
        ['role' => 'system', 'content' => $systemPrompts[$promptType] ?? $systemPrompts['paragraph']],
        ['role' => 'user', 'content' => $prompt]
    ],
    'max_tokens' => $maxTokens,
    'temperature' => 0.8
];

$ch = curl_init('https://api.openai.com/v1/chat/completions');
curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_POST => true,
    CURLOPT_HTTPHEADER => [
        'Authorization: Bearer ' . $config['api_key'],
        'Content-Type: application/json'
    ],
    CURLOPT_POSTFIELDS => json_encode($payload),
    CURLOPT_TIMEOUT => 30,
    CURLOPT_SSL_VERIFYPEER => false,
    CURLOPT_SSL_VERIFYHOST => 0
]);

$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$curlError = curl_error($ch);
curl_close($ch);

if ($response === false) {
    echo json_encode(['success' => false, 'error' => 'Connection failed: ' . $curlError]);
    exit;
}

$data = json_decode($response, true);

if ($httpCode !== 200) {
    echo json_encode(['success' => false, 'error' => $data['error']['message'] ?? 'API error ' . $httpCode]);
    exit;
}

$content = trim($data['choices'][0]['message']['content'] ?? '', '"\' ');

// Remove markdown code blocks if present
$content = preg_replace('/^```(?:html|css|javascript|js)?\s*/i', '', $content);
$content = preg_replace('/\s*```$/i', '', $content);
$content = trim($content);

if (empty($content)) {
    echo json_encode(['success' => false, 'error' => 'No content generated']);
    exit;
}

echo json_encode(['success' => true, 'content' => $content]);
