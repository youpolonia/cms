<?php
/**
 * Default Theme Layout
 * Static header/footer with theme colors from theme.json
 */

if (!defined('CMS_ROOT')) {
    define('CMS_ROOT', dirname(__DIR__, 2));
}
if (!defined('CMS_APP')) {
    define('CMS_APP', CMS_ROOT . '/app');
}

require_once CMS_APP . '/helpers/functions.php';

if (file_exists(CMS_ROOT . '/includes/helpers/menu.php')) {
    require_once CMS_ROOT . '/includes/helpers/menu.php';
}

// Load theme.json
$themeDesign = [];
if (file_exists(__DIR__ . '/theme.json')) {
    $themeDesign = json_decode(@file_get_contents(__DIR__ . '/theme.json'), true) ?: [];
}

// Load options.json
$themeOptions = [];
if (file_exists(__DIR__ . '/options.json')) {
    $themeOptions = json_decode(@file_get_contents(__DIR__ . '/options.json'), true) ?: [];
}

// Colors from theme.json
$colors = $themeDesign['colors'] ?? [];
$primaryColor = $colors['primary'] ?? '#1e40af';
$secondaryColor = $colors['secondary'] ?? '#3b82f6';
$accentColor = $colors['accent'] ?? '#f59e0b';
$bgColor = $colors['background'] ?? '#0f172a';
$surfaceColor = $colors['surface'] ?? '#1e293b';
$textColor = $colors['text'] ?? '#f1f5f9';
$textMuted = $colors['text_muted'] ?? '#a0a0b0';
$borderColor = $colors['border'] ?? '#2d2d3a';

// Options
$showHeader = $themeOptions['show_header'] ?? true;
$showFooter = $themeOptions['show_footer'] ?? true;
$preloadFonts = $themeOptions['preload_fonts'] ?? true;

// Site info
$siteName = get_site_name();
$siteLogo = get_site_logo();

// SEO
$pageData = $page ?? [];
if (!empty($title) && empty($pageData['title'])) {
    $pageData['title'] = $title;
}
?><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <?= render_seo_meta($pageData) ?>
    <?php if ($preloadFonts): ?>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <?php endif; ?>
    <link rel="stylesheet" href="/assets/css/fontawesome.min.css">
    <link rel="stylesheet" href="/assets/css/tb-frontend.css">
    <style>
        :root {
            --primary: <?= esc($primaryColor) ?>;
            --color-primary: <?= esc($primaryColor) ?>;
            --secondary: <?= esc($secondaryColor) ?>;
            --color-secondary: <?= esc($secondaryColor) ?>;
            --accent: <?= esc($accentColor) ?>;
            --color-accent: <?= esc($accentColor) ?>;
            --background: <?= esc($bgColor) ?>;
            --color-background: <?= esc($bgColor) ?>;
            --surface: <?= esc($surfaceColor) ?>;
            --color-surface: <?= esc($surfaceColor) ?>;
            --text: <?= esc($textColor) ?>;
            --color-text: <?= esc($textColor) ?>;
            --text-muted: <?= esc($textMuted) ?>;
            --color-text-muted: <?= esc($textMuted) ?>;
            --border: <?= esc($borderColor) ?>;
            --color-border: <?= esc($borderColor) ?>;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: var(--text); background: var(--background); }
        body.tb-page { background: transparent !important; }
        body.tb-page .site-header { position: absolute; top: 0; left: 0; right: 0; z-index: 100; background: transparent !important; }
        body.tb-page .site-footer { margin-top: 0; }
        /* TB section backgrounds must show */
        .tb-section { position: relative; z-index: 1; }
        .tb-section-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1; }
        .tb-section-inner { position: relative; z-index: 2; }
        a { color: var(--primary); }
        a:hover { color: var(--accent); }
        .site-header { background: var(--surface); padding: 20px 0; }
        .site-header .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .site-header .logo { color: var(--text); font-size: 1.5rem; font-weight: 700; text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .site-header .logo img { height: 40px; width: auto; }
        .site-header .nav-menu { list-style: none; display: flex; gap: 30px; margin: 0; padding: 0; }
        .site-header .nav-link { color: var(--text); text-decoration: none; }
        .site-header .nav-link:hover { color: var(--accent); }
        .site-footer { background: var(--surface); color: var(--text); padding: 40px 0; margin-top: 60px; text-align: center; }
        .site-footer .nav-menu { list-style: none; display: flex; justify-content: center; gap: 20px; margin: 0 0 20px 0; padding: 0; }
        .site-footer .nav-link { color: var(--text-muted); text-decoration: none; }
        .site-footer .nav-link:hover { color: var(--text); }
    </style>
</head>
<?php $isTbPage = !empty($page["is_tb_page"]); ?>
<body class="<?= esc(get_body_class()) ?><?= $isTbPage ? ' tb-page' : '' ?>">

<?php if ($showHeader): ?>
<header class="site-header">
    <div class="container">
        <a href="/" class="logo">
            <?php if ($siteLogo): ?><img src="<?= esc($siteLogo) ?>" alt="<?= esc($siteName) ?>"><?php endif; ?>
            <span><?= esc($siteName) ?></span>
        </a>
        <?= render_menu('header', ['class' => 'nav-menu', 'link_class' => 'nav-link']) ?>
    </div>
</header>
<?php endif; ?>

<?php if ($isTbPage): ?>
    <!-- TB Page - content controls layout, no wrapper -->
<?= $content ?? '' ?>
<?php else: ?>
<main>
    <?= $content ?? '' ?>
</main>
<?php endif; ?>

<?php if ($showFooter): ?>
<footer class="site-footer">
    <?= render_menu('footer', ['class' => 'nav-menu', 'link_class' => 'nav-link']) ?>
    <p>&copy; <?= date('Y') ?> <?= esc($siteName) ?>. All rights reserved.</p>
</footer>
<?php endif; ?>

</body>
</html>
