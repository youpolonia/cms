<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REST API Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            font-family: monospace;
        }
        select, input, button {
            padding: 8px;
            margin: 5px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .history-item {
            padding: 5px;
            margin: 5px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .history-item:hover {
            background: #f0f0f0;
        }
        .response-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>REST API Tester</h1>
    <div class="container">
        <div class="panel">
            <h2>Request</h2>
            <div>
                <select id="method">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="PATCH">PATCH</option>
                </select>
                <input type="text" id="url" placeholder="Endpoint URL" style="width: 70%">
            </div>
            <h3>Payload (JSON)</h3>
            <textarea id="payload">{
    "example": "data"
}</textarea>
            <div>
                <button id="send">Send Request</button>
                <button id="save">Save Request</button>
            </div>
        </div>

        <div class="panel">
            <h2>Response</h2>
            <div>
                <select id="format">
                    <option value="pretty">Pretty</option>
                    <option value="raw">Raw</option>
                    <option value="tree">Tree View</option>
                </select>
            </div>
            <div class="response-info">
                Status: <span id="status">-</span> | 
                Time: <span id="time">-</span>
            </div>
            <textarea id="response" readonly></textarea>
        </div>

        <div class="panel" style="grid-column: span 2;">
            <h2>History</h2>
            <div id="history"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const apiTester = {
                sendRequest: async function(method, url, payload, format) {
                    try {
                        const response = await fetch('ApiTester.php?action=test', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                method,
                                endpoint: url,
                                data: payload,
                                options: { format }
                            })
                        });
                        return await response.json();
                    } catch (error) {
                        return { error: error.message };
                    }
                },

                formatResponse: function(response, format) {
                    if (format === 'raw') return JSON.stringify(response);
                    if (format === 'tree') return this.formatAsTree(response);
                    return JSON.stringify(response, null, 2);
                },

                formatAsTree: function(data, depth = 0) {
                    let output = '';
                    for (const key in data) {
                        output += ' '.repeat(depth * 4) + key + ': ';
                        if (typeof data[key] === 'object' && data[key] !== null) {
                            output += '\n' + this.formatAsTree(data[key], depth + 1);
                        } else {
                            output += data[key] + '\n';
                        }
                    }
                    return output;
                },

                addToHistory: function(request) {
                    const history = JSON.parse(localStorage.getItem('apiHistory') || []);
                    history.unshift(request);
                    if (history.length > 50) history.pop();
                    localStorage.setItem('apiHistory', JSON.stringify(history));
                    this.updateHistoryView();
                },

                updateHistoryView: function() {
                    const history = JSON.parse(localStorage.getItem('apiHistory') || []);
                    const historyEl = document.getElementById('history');
                    historyEl.innerHTML = history.map(item => `
                        <div class="history-item" data-method="${item.method}" data-url="${item.url}">
                            [${item.method}] ${item.url} - ${item.status} (${new Date(item.timestamp * 1000).toLocaleString()})
                        </div>
                    `).join('');

                    document.querySelectorAll('.history-item').forEach(item => {
                        item.addEventListener('click', () => {
                            document.getElementById('method').value = item.dataset.method;
                            document.getElementById('url').value = item.dataset.url;
                        });
                    });
                }
            };

            // Event listeners
            document.getElementById('send').addEventListener('click', async function() {
                const method = document.getElementById('method').value;
                const url = document.getElementById('url').value;
                const payload = document.getElementById('payload').value;
                const format = document.getElementById('format').value;

                try {
                    JSON.parse(payload); // Validate JSON
                    const response = await apiTester.sendRequest(method, url, payload, format);
                    
                    document.getElementById('response').value = apiTester.formatResponse(response, format);
                    document.getElementById('status').textContent = response.status || '-';
                    document.getElementById('time').textContent = new Date().toLocaleTimeString();
                    
                    apiTester.addToHistory({
                        method,
                        url,
                        status: response.status,
                        timestamp: Math.floor(Date.now() / 1000)
                    });
                } catch (error) {
                    document.getElementById('response').value = `Invalid JSON: ${error.message}`;
                }
            });

            document.getElementById('save').addEventListener('click', function() {
                const method = document.getElementById('method').value;
                const url = document.getElementById('url').value;
                const payload = document.getElementById('payload').value;
                const name = prompt('Save as:');
                
                if (name) {
                    const savedRequests = JSON.parse(localStorage.getItem('savedRequests') || {});
                    savedRequests[name] = { method, url, payload };
                    localStorage.setItem('savedRequests', JSON.stringify(savedRequests));
                    alert('Request saved!');
                }
            });

            // Initialize history view
            apiTester.updateHistoryView();
        });
    </script>
</body>
</html>