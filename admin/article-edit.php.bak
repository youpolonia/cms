<?php
/**
 * Article Editor with TinyMCE WYSIWYG + AI Tools + SEO Analysis
 * Full-featured editor like WordPress with AI integration
 */

declare(strict_types=1);

define('CMS_ROOT', realpath(__DIR__ . '/..'));;

require_once __DIR__ . '/../includes/init.php'; // Session init
require_once CMS_ROOT . '/config.php';
require_once CMS_ROOT . '/core/session_boot.php';
cms_session_start('admin');

require_once CMS_ROOT . '/core/csrf.php';
csrf_boot('admin');

require_once CMS_ROOT . '/admin/includes/permissions.php';
cms_require_admin_role();

require_once CMS_ROOT . '/core/database.php';
require_once CMS_ROOT . '/core/ai_models.php';

// Load Settings for API keys
require_once CMS_ROOT . '/admin/models/settingsmodel.php';
$settingsModel = new SettingsModel();
$pexelsApiKey = $settingsModel->getValue('pexels_api_key', '');

// Load AI Images module if available
$aiImagesAvailable = false;
if (file_exists(CMS_ROOT . '/core/ai_images.php')) {
    require_once CMS_ROOT . '/core/ai_images.php';
    $aiImagesAvailable = function_exists('ai_images_is_configured') && ai_images_is_configured();
}

$db = \core\Database::connection();

// Get article if editing
$articleId = (int)($_GET['id'] ?? 0);
$article = null;

if ($articleId > 0) {
    $stmt = $db->prepare("SELECT * FROM articles WHERE id = ?");
    $stmt->execute([$articleId]);
    $article = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$article) {
        header('Location: /admin/articles.php');
        exit;
    }
}

// Get categories
$categories = $db->query("SELECT * FROM article_categories ORDER BY name")->fetchAll(PDO::FETCH_ASSOC);

// Get media files from upload folder (no database dependency)
$mediaFiles = [];
$mediaDir = CMS_ROOT . '/uploads/media/';
if (is_dir($mediaDir)) {
    $files = scandir($mediaDir, SCANDIR_SORT_DESCENDING);
    foreach ($files as $file) {
        if ($file === '.' || $file === '..' || $file === 'thumbs' || is_dir($mediaDir . $file)) continue;
        $ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));
        if (in_array($ext, ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'])) {
            $mediaFiles[] = [
                'filename' => $file,
                'mime_type' => 'image/' . ($ext === 'jpg' ? 'jpeg' : $ext)
            ];
        }
        if (count($mediaFiles) >= 100) break;
    }
}

// Load AI settings
$aiSettingsFile = CMS_ROOT . '/config/ai_settings.json';
$aiSettings = file_exists($aiSettingsFile) ? json_decode(file_get_contents($aiSettingsFile), true) : [];

// Support both old format (api_key at root) and new format (providers.openai.api_key)
$openaiApiKey = '';
$openaiModel = 'gpt-3.5-turbo';
if (!empty($aiSettings['api_key'])) {
    $openaiApiKey = $aiSettings['api_key'];
    $openaiModel = $aiSettings['model'] ?? 'gpt-3.5-turbo';
} elseif (!empty($aiSettings['openai_api_key'])) {
    $openaiApiKey = $aiSettings['openai_api_key'];
    $openaiModel = $aiSettings['openai_model'] ?? 'gpt-3.5-turbo';
} elseif (!empty($aiSettings['providers']['openai']['api_key'])) {
    $openaiApiKey = $aiSettings['providers']['openai']['api_key'];
    $openaiModel = $aiSettings['providers']['openai']['default_model'] ?? 'gpt-5.2';
}
$aiConfigured = !empty($openaiApiKey);

// Handle save
$message = '';
$messageType = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST' && !isset($_POST['ajax'])) {
    csrf_validate_or_403();
    
    $title = trim($_POST['title'] ?? '');
    $content = $_POST['content'] ?? '';
    $excerpt = trim($_POST['excerpt'] ?? '');
    $slug = trim($_POST['slug'] ?? '');
    $categoryId = (int)($_POST['category_id'] ?? 0) ?: null;
    $featuredImage = trim($_POST['featured_image'] ?? '');
    $status = $_POST['status'] ?? 'draft';
    $publishDate = $_POST['publish_date'] ?? null;
    $metaTitle = trim($_POST['meta_title'] ?? '');
    $metaDescription = trim($_POST['meta_description'] ?? '');
    $focusKeyword = trim($_POST['focus_keyword'] ?? '');
    
    // Generate slug if empty
    if (empty($slug)) {
        $slug = strtolower(preg_replace('/[^a-z0-9]+/i', '-', $title));
        $slug = trim($slug, '-');
    }
    
    // Validate
    $errors = [];
    if (empty($title)) {
        $errors[] = 'Title is required';
    }
    
    // Check slug uniqueness
    $slugCheck = $db->prepare("SELECT id FROM articles WHERE slug = ? AND id != ?");
    $slugCheck->execute([$slug, $articleId]);
    if ($slugCheck->fetch()) {
        $slug .= '-' . time();
    }
    
    if (empty($errors)) {
        $authorId = $_SESSION['admin_id'] ?? 1;
        
        try {
            // Set published_at when publishing
            $publishedAt = null;
            if ($status === 'published') {
                $publishedAt = date('Y-m-d H:i:s');
            }
            
            if ($articleId > 0) {
                // Update
                $stmt = $db->prepare("UPDATE articles SET 
                    title = ?, slug = ?, content = ?, excerpt = ?, 
                    featured_image = ?, category_id = ?, status = ?,
                    meta_title = ?, meta_description = ?, 
                    published_at = COALESCE(published_at, ?), updated_at = NOW()
                    WHERE id = ?");
                $stmt->execute([
                    $title, $slug, $content, $excerpt,
                    $featuredImage ?: null, $categoryId, $status,
                    $metaTitle, $metaDescription,
                    $publishedAt, $articleId
                ]);
                $message = 'Article updated successfully!';
                $messageType = 'success';
            } else {
                // Insert
                $stmt = $db->prepare("INSERT INTO articles 
                    (title, slug, content, excerpt, featured_image, category_id, 
                    author_id, status, meta_title, meta_description, published_at, created_at, updated_at)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())");
                $stmt->execute([
                    $title, $slug, $content, $excerpt,
                    $featuredImage ?: null, $categoryId,
                    $authorId, $status,
                    $metaTitle, $metaDescription, $publishedAt
                ]);
                $articleId = (int)$db->lastInsertId();
                $message = 'Article created successfully!';
                $messageType = 'success';
                
                // Redirect to edit page
                header("Location: /admin/article-edit.php?id={$articleId}&saved=1");
                exit;
            }
        } catch (PDOException $e) {
            $message = 'Database error: ' . $e->getMessage();
            $messageType = 'error';
            error_log('[ARTICLE_EDIT] Save error: ' . $e->getMessage());
        }
        
        // Refresh article data
        $stmt = $db->prepare("SELECT * FROM articles WHERE id = ?");
        $stmt->execute([$articleId]);
        $article = $stmt->fetch(PDO::FETCH_ASSOC);
    } else {
        $message = implode(', ', $errors);
        $messageType = 'error';
    }
}

// Handle AJAX AI requests
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['ajax'])) {
    header('Content-Type: application/json');
    
    if (!csrf_validate($_POST['csrf_token'] ?? '')) {
        echo json_encode(['success' => false, 'error' => 'Invalid CSRF token']);
        exit;
    }
    
    $action = $_POST['ajax_action'] ?? '';
    $text = $_POST['text'] ?? '';
    $type = $_POST['type'] ?? '';
    
    // Load AI config
    if (!$aiConfigured) {
        echo json_encode(['success' => false, 'error' => 'AI not configured. Go to AI Settings.']);
        exit;
    }
    
    $apiKey = $openaiApiKey;

    // Use centralized model selector or fall back to configured default
    $model = trim($_POST['ai_model'] ?? '');
    if (!ai_is_valid_model($model)) {
        $model = $openaiModel; // Fall back to configured model
    }

    $prompts = [
        'generate_title' => "Generate 5 catchy, SEO-optimized article titles for the following content. Return only the titles, one per line:\n\n{$text}",
        'generate_excerpt' => "Write a compelling 2-3 sentence excerpt/summary for SEO purposes for this article:\n\n{$text}",
        'generate_meta' => "Write an SEO-optimized meta description (max 155 characters) for this article:\n\n{$text}",
        'generate_keywords' => "Extract 5-8 relevant SEO keywords from this article, comma-separated:\n\n{$text}",
        'improve_content' => "Improve this text to be more engaging, clear, and SEO-friendly while keeping the same meaning:\n\n{$text}",
        'expand_content' => "Expand this text with more details, examples, and explanations:\n\n{$text}",
        'simplify' => "Simplify this text to be easier to read (aim for 8th grade reading level):\n\n{$text}",
        'translate_en' => "Translate this text to English:\n\n{$text}",
        'translate_pl' => "Translate this text to Polish:\n\n{$text}",
        'translate_de' => "Translate this text to German:\n\n{$text}",
        'fix_grammar' => "Fix any grammar, spelling, and punctuation errors in this text:\n\n{$text}",
        'make_formal' => "Rewrite this text in a formal, professional tone:\n\n{$text}",
        'make_casual' => "Rewrite this text in a casual, friendly tone:\n\n{$text}",
    ];
    
    if (!isset($prompts[$action])) {
        echo json_encode(['success' => false, 'error' => 'Unknown action']);
        exit;
    }
    
    $prompt = $prompts[$action];

    // Use centralized payload builder
    $systemPrompt = 'You are a helpful content writing assistant specializing in SEO and engaging content.';
    $payload = ai_build_payload($model, $systemPrompt, $prompt, ['max_tokens' => 1000]);
    
    // Call OpenAI
    $ch = curl_init('https://api.openai.com/v1/chat/completions');
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_POST => true,
        CURLOPT_HTTPHEADER => [
            'Content-Type: application/json',
            'Authorization: Bearer ' . $apiKey
        ],
        CURLOPT_POSTFIELDS => json_encode($payload),
        CURLOPT_TIMEOUT => 60
    ]);
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $curlError = curl_error($ch);
    curl_close($ch);
    
    if ($curlError) {
        error_log('[ARTICLE_EDIT_AI] cURL error: ' . $curlError);
        echo json_encode(['success' => false, 'error' => 'Connection error: ' . $curlError]);
        exit;
    }
    
    if ($httpCode !== 200) {
        $error = json_decode($response, true);
        $errorMsg = $error['error']['message'] ?? 'API error (HTTP ' . $httpCode . ')';
        error_log('[ARTICLE_EDIT_AI] API error: ' . $errorMsg);
        echo json_encode(['success' => false, 'error' => $errorMsg]);
        exit;
    }
    
    $result = json_decode($response, true);
    if (!$result) {
        error_log('[ARTICLE_EDIT_AI] Invalid JSON response');
        echo json_encode(['success' => false, 'error' => 'Invalid API response']);
        exit;
    }

    // Use centralized response parser
    $content = ai_parse_response($result);

    echo json_encode(['success' => true, 'content' => trim($content ?? '')]);
    exit;
}

// Check for saved message
if (isset($_GET['saved'])) {
    $message = 'Article saved successfully!';
    $messageType = 'success';
}

$pageTitle = $article ? 'Edit Article' : 'New Article';
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= htmlspecialchars($pageTitle) ?> - CMS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tiny.cloud/1/ao66hh39zj4w2paxlg6mobrzgc46tgo1km3yf80iyxd914hg/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --primary: #89b4fa;
            --primary-dark: #b4befe;
            --sidebar-bg: #181825;
            --content-bg: #1e1e2e;
            --card-bg: #181825;
            --border: #313244;
            --text: #cdd6f4;
            --text-muted: #6c7086;
            --success: #a6e3a1;
            --warning: #f9e2af;
            --danger: #f38ba8;
        }
        
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--content-bg); color: var(--text); line-height: 1.5; }
        
        .editor-layout { display: flex; min-height: 100vh; }
        .editor-main { flex: 1; padding: 1.5rem; max-width: 900px; }
        .editor-sidebar { width: 360px; background: var(--card-bg); border-left: 1px solid var(--border); position: sticky; top: 0; height: 100vh; overflow-y: auto; }
        
        .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .editor-header h1 { font-size: 1.25rem; font-weight: 600; }
        .header-actions { display: flex; gap: 0.75rem; }
        
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; text-decoration: none; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: #1e1e2e; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: #313244; color: var(--text); }
        .btn-success { background: var(--success); color: #1e1e2e; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: rgba(255,255,255,0.05); border-color: var(--primary); }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8125rem; }
        .btn-ai { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; }
        .btn-ai:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); }
        
        .alert { padding: 0.875rem 1rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.875rem; }
        .alert-success { background: rgba(166, 227, 161, 0.15); color: #a6e3a1; border: 1px solid rgba(166, 227, 161, 0.3); }
        .alert-error { background: rgba(243, 139, 168, 0.15); color: #f38ba8; border: 1px solid rgba(243, 139, 168, 0.3); }
        
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.625rem 0.875rem; font-size: 0.9375rem; border: 1px solid var(--border); border-radius: 6px; background: var(--card-bg); color: var(--text); transition: border-color 0.2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .form-textarea { min-height: 80px; resize: vertical; font-family: inherit; }
        .form-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }
        
        .title-input { font-size: 1.75rem; font-weight: 600; border: none; padding: 0.5rem 0; margin-bottom: 1rem; }
        .title-input:focus { outline: none; box-shadow: none; }
        
        .editor-wrapper { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        
        /* Sidebar Tabs */
        .sidebar-tabs { display: flex; border-bottom: 1px solid var(--border); background: #11111b; }
        .sidebar-tab { flex: 1; padding: 0.75rem; text-align: center; font-size: 0.75rem; font-weight: 500; cursor: pointer; border: none; background: none; color: var(--text-muted); transition: all 0.2s; }
        .sidebar-tab:hover { color: var(--text); background: rgba(137, 180, 250, 0.1); }
        .sidebar-tab.active { color: var(--primary); background: var(--card-bg); border-bottom: 2px solid var(--primary); margin-bottom: -1px; }
        
        .sidebar-content { display: none; padding: 1.25rem; }
        .sidebar-content.active { display: block; }
        
        .sidebar-section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
        .sidebar-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .sidebar-title { font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        
        /* Status Options */
        .status-options { display: flex; flex-direction: column; gap: 0.5rem; }
        .status-option { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .status-option:hover { border-color: var(--primary); }
        .status-option.selected { border-color: var(--primary); background: rgba(137, 180, 250, 0.1); }
        .status-option input { display: none; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.draft { background: var(--warning); }
        .status-dot.published { background: var(--success); }
        .status-dot.archived { background: #6b7280; }
        
        /* Featured Image */
        .featured-image-box { border: 2px dashed var(--border); border-radius: 8px; padding: 2rem 1rem; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
        .featured-image-box:hover { border-color: var(--primary); background: rgba(137, 180, 250, 0.05); }
        .featured-image-box.has-image { padding: 0; border-style: solid; }
        .featured-image-box img { width: 100%; border-radius: 6px; }
        .featured-image-box .remove-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; }
        
        /* AI Tools */
        .ai-tool-group { margin-bottom: 1rem; }
        .ai-tool-label { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .ai-tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .ai-tool-btn { padding: 0.5rem; font-size: 0.75rem; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.375rem; justify-content: center; }
        .ai-tool-btn:hover { border-color: var(--primary); background: rgba(137, 180, 250, 0.1); }
        .ai-tool-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .ai-tool-btn.loading { background: var(--primary); color: white; }
        
        /* SEO Analysis */
        .seo-score { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #11111b; border-radius: 8px; margin-bottom: 1rem; }
        .seo-score-circle { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: 700; color: white; }
        .seo-score-circle.good { background: var(--success); }
        .seo-score-circle.ok { background: var(--warning); }
        .seo-score-circle.poor { background: var(--danger); }
        .seo-score-details { flex: 1; }
        .seo-score-label { font-size: 0.875rem; font-weight: 600; }
        .seo-score-hint { font-size: 0.75rem; color: var(--text-muted); }
        
        .seo-checklist { list-style: none; }
        .seo-checklist li { display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.5rem 0; font-size: 0.8125rem; border-bottom: 1px solid var(--border); }
        .seo-checklist li:last-child { border-bottom: none; }
        .seo-check { width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0; }
        .seo-check.pass { background: rgba(166, 227, 161, 0.2); color: #a6e3a1; }
        .seo-check.fail { background: rgba(243, 139, 168, 0.2); color: #f38ba8; }
        .seo-check.warn { background: rgba(249, 226, 175, 0.2); color: #f9e2af; }
        
        /* Word count bar */
        .word-count { display: flex; gap: 1rem; padding: 0.75rem; background: #11111b; border-radius: 6px; font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 1rem; }
        .word-count strong { color: var(--text); }
        
        /* SERP Preview */
        .seo-preview { background: #11111b; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .seo-preview-title { color: #89b4fa; font-size: 1.125rem; font-weight: 500; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .seo-preview-url { color: #a6e3a1; font-size: 0.8125rem; margin-bottom: 0.25rem; }
        .seo-preview-desc { color: #a6adc8; font-size: 0.8125rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* Char count */
        .char-count { font-size: 0.75rem; color: var(--text-muted); text-align: right; margin-top: 0.25rem; }
        .char-count.warning { color: var(--warning); }
        .char-count.danger { color: var(--danger); }
        
        /* Media Browser Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--card-bg); border-radius: 12px; width: 90%; max-width: 900px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 1rem; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
        .modal-body { flex: 1; overflow-y: auto; padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; }
        
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; }
        .media-item { aspect-ratio: 1; border: 2px solid var(--border); border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s; position: relative; }
        .media-item:hover { border-color: var(--primary); }
        .media-item.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
        .media-item img { width: 100%; height: 100%; object-fit: cover; }
        .media-item .filename { position: absolute; bottom: 0; left: 0; right: 0; padding: 0.25rem 0.5rem; background: rgba(0,0,0,0.7); color: white; font-size: 0.625rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Upload area in modal */
        .upload-area { border: 2px dashed var(--border); border-radius: 8px; padding: 2rem; text-align: center; margin-bottom: 1.5rem; transition: all 0.2s; }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary); background: rgba(137, 180, 250, 0.1); }
        .upload-area input { display: none; }
        
        /* AI Results */
        .ai-result { background: #11111b; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .ai-result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .ai-result-title { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); }
        .ai-result-content { font-size: 0.875rem; line-height: 1.6; white-space: pre-wrap; }
        .ai-result-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
        
        /* Collapsible */
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 0.5rem 0; }
        .collapsible-header::after { content: '‚ñº'; font-size: 0.625rem; transition: transform 0.2s; }
        .collapsible-header.collapsed::after { transform: rotate(-90deg); }
        .collapsible-content.hidden { display: none; }
        
        .toast { position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 1001; animation: slideIn 0.3s ease; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        @media (max-width: 1024px) {
            .editor-layout { flex-direction: column; }
            .editor-sidebar { width: 100%; height: auto; position: static; border-left: none; border-top: 1px solid var(--border); }
        }
        
        /* Media Tabs */
        .media-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.75rem; }
        .media-tab { padding: 0.625rem 1rem; background: transparent; color: var(--text-muted); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .media-tab:hover { color: var(--text); background: rgba(255,255,255,0.05); }
        .media-tab.active { color: var(--primary); background: rgba(137, 180, 250, 0.15); }
        .media-tab-content { display: none; }
        .media-tab-content.active { display: block; }
        
        /* Stock Photos */
        .stock-search { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; }
        .stock-search input { flex: 1; padding: 0.75rem 1rem; background: var(--sidebar-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.875rem; }
        .stock-search input:focus { outline: none; border-color: var(--primary); }
        .stock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem; }
        .stock-item { aspect-ratio: 4/3; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative; border: 2px solid transparent; transition: all 0.2s; }
        .stock-item:hover { border-color: var(--primary); transform: scale(1.02); }
        .stock-item.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(137, 180, 250, 0.3); }
        .stock-item img { width: 100%; height: 100%; object-fit: cover; }
        .stock-item .credit { position: absolute; bottom: 0; left: 0; right: 0; padding: 0.375rem 0.5rem; background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: white; font-size: 0.625rem; }
        .stock-loading { text-align: center; padding: 3rem; color: var(--text-muted); }
        
        /* AI Image Generator */
        .ai-gen-form { display: flex; flex-direction: column; gap: 1rem; }
        .ai-gen-prompt { padding: 0.875rem 1rem; background: var(--sidebar-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.875rem; min-height: 80px; resize: vertical; font-family: inherit; }
        .ai-gen-prompt:focus { outline: none; border-color: var(--primary); }
        .ai-gen-options { display: flex; gap: 1rem; flex-wrap: wrap; }
        .ai-gen-options select { padding: 0.625rem 1rem; background: var(--sidebar-bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem; }
        .ai-gen-preview { margin-top: 1.5rem; }
        .ai-gen-result { max-width: 100%; border-radius: 12px; border: 2px solid var(--primary); }
        .ai-gen-status { text-align: center; padding: 2rem; color: var(--text-muted); }
    </style>
</head>
<body>
<?php require_once CMS_ROOT . '/admin/includes/topbar_nav.php'; ?>
    <form method="POST" id="article-form">
        <?= csrf_field() ?>
        
        <div class="editor-layout">
            <div class="editor-main">
                <div class="editor-header">
                    <h1>
                        <a href="/admin/articles.php" style="text-decoration: none; color: var(--text-muted);">‚Üê</a>
                        <?= $article ? 'Edit Article' : 'New Article' ?>
                    </h1>
                    <div class="header-actions">
                        <a href="/admin/articles.php" class="btn btn-secondary">Cancel</a>
                        <?php if ($article && $article['status'] === 'published'): ?>
                        <a href="/article/<?= htmlspecialchars($article['slug']) ?>" target="_blank" class="btn btn-outline">üëÅ View</a>
                        <?php endif; ?>
                        <button type="submit" class="btn btn-primary" id="saveBtn">üíæ Save</button>
                        <button type="button" class="btn btn-success" id="publishBtn" onclick="publishArticle()">üöÄ Publish</button>
                    </div>
                </div>
                
                <?php if ($message): ?>
                <div class="alert alert-<?= $messageType ?>">
                    <?= htmlspecialchars($message) ?>
                </div>
                <?php endif; ?>
                
                <input type="text" name="title" id="article-title" class="form-input title-input" 
                       placeholder="Article title..."
                       value="<?= htmlspecialchars($article['title'] ?? '') ?>"
                       required
                       oninput="updateSeoPreview(); analyzeSeo();">
                
                <div class="word-count" id="word-count">
                    <span><strong id="wc-words">0</strong> words</span>
                    <span><strong id="wc-chars">0</strong> characters</span>
                    <span><strong id="wc-reading">0</strong> min read</span>
                </div>
                
                <div class="editor-wrapper">
                    <textarea name="content" id="editor"><?= htmlspecialchars($article['content'] ?? '') ?></textarea>
                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label class="form-label">Excerpt</label>
                        <button type="button" class="btn btn-ai btn-sm" onclick="aiGenerate('generate_excerpt')">‚ú® Generate</button>
                    </div>
                    <textarea name="excerpt" id="excerpt" class="form-textarea" rows="3" 
                              placeholder="Brief summary of the article..."
                              oninput="updateSeoPreview()"><?= htmlspecialchars($article['excerpt'] ?? '') ?></textarea>
                    <div class="form-hint">Used in article listings and SEO descriptions.</div>
                </div>
            </div>
            
            <div class="editor-sidebar">
                <!-- Sidebar Tabs -->
                <div class="sidebar-tabs">
                    <button type="button" class="sidebar-tab active" data-tab="publish">üì§ Publish</button>
                    <button type="button" class="sidebar-tab" data-tab="seo">üéØ SEO</button>
                    <button type="button" class="sidebar-tab" data-tab="ai">ü§ñ AI</button>
                </div>
                
                <!-- Publish Tab -->
                <div class="sidebar-content active" id="tab-publish">
                    <div class="sidebar-section">
                        <div class="sidebar-title">üì§ Status</div>
                        <div class="status-options">
                            <label class="status-option <?= ($article['status'] ?? 'draft') === 'draft' ? 'selected' : '' ?>">
                                <input type="radio" name="status" value="draft" <?= ($article['status'] ?? 'draft') === 'draft' ? 'checked' : '' ?>>
                                <span class="status-dot draft"></span>
                                <span>Draft</span>
                            </label>
                            <label class="status-option <?= ($article['status'] ?? '') === 'published' ? 'selected' : '' ?>">
                                <input type="radio" name="status" value="published" <?= ($article['status'] ?? '') === 'published' ? 'checked' : '' ?>>
                                <span class="status-dot published"></span>
                                <span>Published</span>
                            </label>
                            <label class="status-option <?= ($article['status'] ?? '') === 'archived' ? 'selected' : '' ?>">
                                <input type="radio" name="status" value="archived" <?= ($article['status'] ?? '') === 'archived' ? 'checked' : '' ?>>
                                <span class="status-dot archived"></span>
                                <span>Archived</span>
                            </label>
                        </div>
                        
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">Published Date</label>
                            <input type="datetime-local" name="published_at" class="form-input" readonly
                                   value="<?= !empty($article['published_at']) ? date('Y-m-d\TH:i', strtotime($article['published_at'])) : '' ?>">
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-title">üìÅ Category</div>
                        <select name="category_id" class="form-select">
                            <option value="">‚Äî No Category ‚Äî</option>
                            <?php foreach ($categories as $cat): ?>
                            <option value="<?= $cat['id'] ?>" <?= ($article['category_id'] ?? '') == $cat['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($cat['name']) ?>
                            </option>
                            <?php endforeach; ?>
                        </select>
                        <a href="/admin/article-categories.php" style="font-size: 0.75rem; color: var(--primary); margin-top: 0.5rem; display: inline-block;">+ Manage Categories</a>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-title">üñºÔ∏è Featured Image</div>
                        <div class="featured-image-box <?= !empty($article['featured_image']) ? 'has-image' : '' ?>" 
                             id="featured-image-box"
                             onclick="openMediaBrowser()">
                            <?php if (!empty($article['featured_image'])): ?>
                            <img src="<?= htmlspecialchars($article['featured_image']) ?>" alt="Featured">
                            <button type="button" class="remove-btn" onclick="event.stopPropagation(); removeFeaturedImage();">√ó</button>
                            <?php else: ?>
                            <div class="placeholder">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∑</div>
                                <div>Click to select image</div>
                            </div>
                            <?php endif; ?>
                        </div>
                        <input type="hidden" name="featured_image" id="featured-image-value"
                               value="<?= htmlspecialchars($article['featured_image'] ?? '') ?>">
                        <?php if ($aiImagesAvailable): ?>
                        <button type="button" class="btn btn-ai" onclick="openAiImageModal()" style="margin-top: 8px; width: 100%;">
                            üé® Generate AI Image
                        </button>
                        <?php endif; ?>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-title">üîó URL Slug</div>
                        <input type="text" name="slug" class="form-input" 
                               placeholder="article-url-slug"
                               value="<?= htmlspecialchars($article['slug'] ?? '') ?>">
                        <div class="form-hint">Leave empty to auto-generate</div>
                    </div>
                </div>
                
                <!-- SEO Tab -->
                <div class="sidebar-content" id="tab-seo">
                    <div class="sidebar-section">
                        <div class="seo-score" id="seo-score">
                            <div class="seo-score-circle ok" id="seo-score-circle">0</div>
                            <div class="seo-score-details">
                                <div class="seo-score-label">SEO Score</div>
                                <div class="seo-score-hint" id="seo-score-hint">Add content to analyze</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <div style="flex: 1; background: #11111b; padding: 0.5rem; border-radius: 6px; text-align: center;">
                                <div style="font-size: 0.625rem; color: var(--text-muted); text-transform: uppercase;">Readability</div>
                                <div id="readability-score" style="font-size: 1rem; font-weight: 600; color: var(--success);">‚Äî</div>
                            </div>
                            <div style="flex: 1; background: #11111b; padding: 0.5rem; border-radius: 6px; text-align: center;">
                                <div style="font-size: 0.625rem; color: var(--text-muted); text-transform: uppercase;">Grade</div>
                                <div id="reading-grade" style="font-size: 1rem; font-weight: 600;">‚Äî</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Focus Keyword</label>
                            <input type="text" name="focus_keyword" id="focus-keyword" class="form-input" 
                                   placeholder="Main keyword to optimize for"
                                   value="<?= htmlspecialchars($article['meta_keywords'] ?? '') ?>"
                                   oninput="analyzeSeo()">
                        </div>
                        
                        <a href="/admin/ai-seo-assistant.php" target="_blank" class="btn btn-ai btn-sm" style="width: 100%; justify-content: center; margin-top: 0.5rem;">üéØ Full AI SEO Analysis ‚Üí</a>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-title">üìã SEO Checklist</div>
                        <ul class="seo-checklist" id="seo-checklist">
                            <li><span class="seo-check fail">‚úó</span> Add focus keyword</li>
                        </ul>
                    </div>
                    
                    <div class="sidebar-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <label class="form-label" style="margin: 0;">Meta Title</label>
                            <button type="button" class="btn btn-ai btn-sm" onclick="aiGenerate('generate_title')">‚ú® Generate</button>
                        </div>
                        <input type="text" name="meta_title" class="form-input" id="meta-title"
                               placeholder="SEO title (max 60 chars)"
                               value="<?= htmlspecialchars($article['meta_title'] ?? '') ?>"
                               oninput="updateSeoPreview(); updateCharCount(this, 60); analyzeSeo()">
                        <div class="char-count" id="meta-title-count">0/60</div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; margin-top: 1rem;">
                            <label class="form-label" style="margin: 0;">Meta Description</label>
                            <button type="button" class="btn btn-ai btn-sm" onclick="aiGenerate('generate_meta')">‚ú® Generate</button>
                        </div>
                        <textarea name="meta_description" class="form-textarea" id="meta-desc" rows="2"
                                  placeholder="SEO description (max 160 chars)"
                                  oninput="updateSeoPreview(); updateCharCount(this, 160); analyzeSeo()"><?= htmlspecialchars($article['meta_description'] ?? '') ?></textarea>
                        <div class="char-count" id="meta-desc-count">0/160</div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; margin-top: 1rem;">
                            <label class="form-label" style="margin: 0;">Keywords</label>
                            <button type="button" class="btn btn-ai btn-sm" onclick="aiGenerate('generate_keywords')">‚ú® Extract</button>
                        </div>
                        <input type="text" name="meta_keywords" class="form-input"
                               placeholder="keyword1, keyword2, keyword3"
                               value="<?= htmlspecialchars($article['meta_keywords'] ?? '') ?>">
                        
                        <div class="seo-preview">
                            <div class="seo-preview-title" id="seo-title"><?= htmlspecialchars($article['meta_title'] ?? $article['title'] ?? 'Article Title') ?></div>
                            <div class="seo-preview-url">example.com/article/<?= htmlspecialchars($article['slug'] ?? 'article-slug') ?></div>
                            <div class="seo-preview-desc" id="seo-desc"><?= htmlspecialchars($article['meta_description'] ?? $article['excerpt'] ?? 'Article description...') ?></div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Tab -->
                <div class="sidebar-content" id="tab-ai">
                    <?php if (!$aiConfigured): ?>
                    <div class="alert alert-error">
                        AI not configured. <a href="/admin/ai-settings.php">Configure API key</a>
                    </div>
                    <?php else: ?>
                    <div class="sidebar-section">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label">ü§ñ AI Model</label>
                            <?= ai_render_model_selector('ai_model', 'aiModelSelect', null, ['class' => 'form-select']) ?>
                        </div>
                    </div>
                    <div class="sidebar-section">
                        <div class="sidebar-title">‚úçÔ∏è Content Tools</div>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem;">
                            Select text in editor first, then click a tool.
                        </p>
                        
                        <div class="ai-tool-group">
                            <div class="ai-tool-label">Improve</div>
                            <div class="ai-tools-grid">
                                <button type="button" class="ai-tool-btn" onclick="aiTransformSelection('improve_content')">‚ú® Improve</button>
                                <button type="button" class="ai-tool-btn" onclick="aiTransformSelection('expand_content')">üìù Expand</button>
                                <button type="button" class="ai-tool-btn" onclick="aiTransformSelection('simplify')">üìñ Simplify</button>
                                <button type="button" class="ai-tool-btn" onclick="aiTransformSelection('fix_grammar')">‚úì Fix Grammar</button>
                            </div>
                        </div>
                        
                        <div class="ai-tool-group">
                            <div class="ai-tool-label">Tone</div>
                            <div class="ai-tools-grid">
                                <button type="button" class="ai-tool-btn" onclick="aiTransformSelection('make_formal')">üëî Formal</button>
                                <button type="button" class="ai-tool-btn" onclick="aiTransformSelection('make_casual')">üòä Casual</button>
                            </div>
                        </div>
                        
                        <div class="ai-tool-group">
                            <div class="ai-tool-label">Translate</div>
                            <div class="ai-tools-grid">
                                <button type="button" class="ai-tool-btn" onclick="aiTransformSelection('translate_en')">üá¨üáß English</button>
                                <button type="button" class="ai-tool-btn" onclick="aiTransformSelection('translate_pl')">üáµüá± Polish</button>
                                <button type="button" class="ai-tool-btn" onclick="aiTransformSelection('translate_de')">üá©üá™ German</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-title">üöÄ Quick Generate</div>
                        <div class="ai-tools-grid" style="grid-template-columns: 1fr;">
                            <button type="button" class="ai-tool-btn" onclick="aiGenerate('generate_title')" style="justify-content: flex-start;">üìù Generate Titles</button>
                            <button type="button" class="ai-tool-btn" onclick="aiGenerate('generate_excerpt')" style="justify-content: flex-start;">üìÑ Generate Excerpt</button>
                            <button type="button" class="ai-tool-btn" onclick="aiGenerate('generate_meta')" style="justify-content: flex-start;">üéØ Generate Meta Description</button>
                            <button type="button" class="ai-tool-btn" onclick="aiGenerate('generate_keywords')" style="justify-content: flex-start;">üîë Extract Keywords</button>
                        </div>
                    </div>
                    
                    <div id="ai-result-container"></div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </form>
    
    <!-- Media Browser Modal -->
    <div class="modal-overlay" id="media-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>üìÅ Media Library</h3>
                <button type="button" class="modal-close" onclick="closeMediaBrowser()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Media Tabs -->
                <div class="media-tabs">
                    <button type="button" class="media-tab active" data-media-tab="upload">üì§ Upload</button>
                    <button type="button" class="media-tab" data-media-tab="library">üñºÔ∏è Library</button>
                    <button type="button" class="media-tab" data-media-tab="stock">üì∑ Stock Photos</button>
                    <button type="button" class="media-tab" data-media-tab="ai-generate">‚ú® AI Generate</button>
                </div>
                
                <!-- Upload Tab -->
                <div class="media-tab-content active" id="media-tab-upload">
                    <div class="upload-area" id="upload-area">
                        <input type="file" id="media-upload" accept="image/*">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì§</div>
                        <div>Drop image here or <label for="media-upload" style="color: var(--primary); cursor: pointer;">browse</label></div>
                    </div>
                </div>
                
                <!-- Library Tab -->
                <div class="media-tab-content" id="media-tab-library">
                    <div class="media-grid" id="media-grid">
                        <?php foreach ($mediaFiles as $media): ?>
                        <?php if (strpos($media['mime_type'] ?? '', 'image/') === 0): ?>
                        <div class="media-item" data-url="/uploads/media/<?= htmlspecialchars($media['filename']) ?>">
                            <img src="/uploads/media/<?= htmlspecialchars($media['filename']) ?>" alt="">
                            <div class="filename"><?= htmlspecialchars($media['filename']) ?></div>
                        </div>
                        <?php endif; ?>
                        <?php endforeach; ?>
                    </div>
                </div>
                
                <!-- Stock Photos Tab -->
                <div class="media-tab-content" id="media-tab-stock">
                    <div class="stock-search">
                        <input type="text" id="stock-search-input" placeholder="Search free stock photos (Pexels)...">
                        <button type="button" class="btn btn-primary" onclick="searchStockPhotos()">üîç Search</button>
                    </div>
                    <div id="stock-results">
                        <div class="stock-loading">
                            <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">üì∑</p>
                            <p>Search for beautiful free photos from Pexels</p>
                        </div>
                    </div>
                </div>
                
                <!-- AI Generate Tab -->
                <div class="media-tab-content" id="media-tab-ai-generate">
                    <div class="ai-gen-form">
                        <label style="font-weight: 500; margin-bottom: 0.25rem;">Describe the image you want to create:</label>
                        <textarea class="ai-gen-prompt" id="ai-image-prompt" placeholder="A futuristic cityscape at sunset with flying cars and neon lights, digital art style..."></textarea>
                        
                        <div class="ai-gen-options">
                            <select id="ai-image-style">
                                <option value="photorealistic">üì∏ Photorealistic</option>
                                <option value="digital-art">üé® Digital Art</option>
                                <option value="illustration">‚úèÔ∏è Illustration</option>
                                <option value="3d-render">üßä 3D Render</option>
                                <option value="anime">üéå Anime</option>
                                <option value="watercolor">üñåÔ∏è Watercolor</option>
                            </select>
                            <select id="ai-image-size">
                                <option value="1024x1024">Square (1024√ó1024)</option>
                                <option value="1792x1024">Landscape (1792√ó1024)</option>
                                <option value="1024x1792">Portrait (1024√ó1792)</option>
                            </select>
                            <button type="button" class="btn btn-ai" onclick="generateAiImage()">‚ú® Generate Image</button>
                        </div>
                    </div>
                    
                    <div class="ai-gen-preview" id="ai-gen-preview">
                        <div class="ai-gen-status">
                            <p style="font-size: 2rem; margin-bottom: 0.5rem;">üé®</p>
                            <p>Describe your image and click Generate</p>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">Powered by DALL-E 3</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeMediaBrowser()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="selectMedia()" id="select-media-btn" disabled>Select Image</button>
            </div>
        </div>
    </div>
    
    <script>
    const CSRF_TOKEN = '<?= csrf_token() ?>';
    let selectedMediaUrl = null;
    
    // Initialize TinyMCE
    tinymce.init({
        selector: '#editor',
        height: 500,
        menubar: true,
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount',
            'emoticons', 'codesample', 'quickbars'
        ],
        toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | ' +
                 'forecolor backcolor | alignleft aligncenter alignright alignjustify | ' +
                 'bullist numlist outdent indent | link customimage media table | ' +
                 'emoticons charmap | code fullscreen preview | removeformat help',
        toolbar_mode: 'sliding',
        quickbars_selection_toolbar: 'bold italic | quicklink h2 h3 blockquote',
        quickbars_insert_toolbar: 'customimage quicktable',
        content_style: `
            body { font-family: 'Inter', -apple-system, sans-serif; font-size: 16px; line-height: 1.7; max-width: 100%; padding: 1rem; }
            h1, h2, h3, h4, h5, h6 { font-weight: 600; margin-top: 1.5em; margin-bottom: 0.5em; }
            p { margin-bottom: 1em; }
            img { max-width: 100%; height: auto; }
            pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 6px; }
            blockquote { border-left: 4px solid #6366f1; padding-left: 1rem; margin: 1rem 0; color: #64748b; font-style: italic; }
        `,
        font_family_formats: 'Inter=Inter, sans-serif; Arial=arial,helvetica,sans-serif; Georgia=georgia,palatino; Helvetica=helvetica; Times New Roman=times new roman,times; Courier New=courier new,courier',
        font_size_formats: '12px 14px 16px 18px 20px 24px 28px 32px 36px 48px 72px',
        promotion: false,
        branding: false,
        setup: function(editor) {
            // Custom image button
            editor.ui.registry.addButton('customimage', {
                icon: 'image',
                tooltip: 'Insert image from Media Library',
                onAction: function() {
                    openMediaBrowser('editor');
                }
            });
            
            editor.on('keyup change', function() {
                updateWordCount();
                analyzeSeo();
            });
            
            editor.on('init', function() {
                updateWordCount();
                analyzeSeo();
            });
        }
    });
    
    // Tab switching
    document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('tab-' + this.dataset.tab).classList.add('active');
        });
    });
    
    // Status options
    document.querySelectorAll('.status-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.status-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
        });
    });
    
    // Word count
    function updateWordCount() {
        if (typeof tinymce !== 'undefined' && tinymce.get('editor')) {
            const content = tinymce.get('editor').getContent({ format: 'text' });
            const words = content.trim() ? content.trim().split(/\s+/).length : 0;
            const chars = content.length;
            const reading = Math.ceil(words / 200);
            
            document.getElementById('wc-words').textContent = words;
            document.getElementById('wc-chars').textContent = chars;
            document.getElementById('wc-reading').textContent = reading;
        }
    }
    
    // SEO Preview
    function updateSeoPreview() {
        const title = document.getElementById('meta-title').value || document.getElementById('article-title').value || 'Article Title';
        const desc = document.getElementById('meta-desc').value || document.getElementById('excerpt').value || 'Article description...';
        
        document.getElementById('seo-title').textContent = title;
        document.getElementById('seo-desc').textContent = desc;
    }
    
    // Char count
    function updateCharCount(input, max) {
        const count = input.value.length;
        const countEl = document.getElementById(input.id + '-count');
        countEl.textContent = count + '/' + max;
        
        countEl.classList.remove('warning', 'danger');
        if (count > max) countEl.classList.add('danger');
        else if (count > max * 0.9) countEl.classList.add('warning');
    }
    
    // Readability Score (Flesch-Kincaid)
    function calculateReadability(text) {
        if (!text || text.trim().length < 100) return { score: null, grade: null };
        
        // Count sentences (. ! ?)
        const sentences = (text.match(/[.!?]+/g) || []).length || 1;
        
        // Count words
        const words = text.trim().split(/\s+/).filter(w => w.length > 0);
        const wordCount = words.length;
        if (wordCount < 10) return { score: null, grade: null };
        
        // Count syllables (simplified)
        function countSyllables(word) {
            word = word.toLowerCase().replace(/[^a-z]/g, '');
            if (word.length <= 3) return 1;
            word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
            word = word.replace(/^y/, '');
            const syllables = word.match(/[aeiouy]{1,2}/g);
            return syllables ? syllables.length : 1;
        }
        
        let totalSyllables = 0;
        words.forEach(w => totalSyllables += countSyllables(w));
        
        // Flesch Reading Ease = 206.835 - 1.015*(words/sentences) - 84.6*(syllables/words)
        const avgSentenceLen = wordCount / sentences;
        const avgSyllables = totalSyllables / wordCount;
        const flesch = 206.835 - (1.015 * avgSentenceLen) - (84.6 * avgSyllables);
        
        // Flesch-Kincaid Grade Level
        const grade = (0.39 * avgSentenceLen) + (11.8 * avgSyllables) - 15.59;
        
        return {
            score: Math.round(Math.max(0, Math.min(100, flesch))),
            grade: Math.round(Math.max(1, Math.min(18, grade)))
        };
    }
    
    function updateReadability() {
        const content = tinymce.get('editor') ? tinymce.get('editor').getContent({ format: 'text' }) : '';
        const result = calculateReadability(content);
        
        const scoreEl = document.getElementById('readability-score');
        const gradeEl = document.getElementById('reading-grade');
        
        if (result.score !== null) {
            scoreEl.textContent = result.score;
            gradeEl.textContent = result.grade;
            
            // Color code score
            if (result.score >= 60) {
                scoreEl.style.color = 'var(--success)';
            } else if (result.score >= 40) {
                scoreEl.style.color = 'var(--warning)';
            } else {
                scoreEl.style.color = 'var(--danger)';
            }
        } else {
            scoreEl.textContent = '‚Äî';
            gradeEl.textContent = '‚Äî';
        }
    }
    
    // SEO Analysis
    function analyzeSeo() {
        updateReadability();
        const title = document.getElementById('article-title').value;
        const metaTitle = document.getElementById('meta-title').value;
        const metaDesc = document.getElementById('meta-desc').value;
        const focusKeyword = document.getElementById('focus-keyword').value.toLowerCase();
        const content = tinymce.get('editor') ? tinymce.get('editor').getContent({ format: 'text' }) : '';
        const wordCount = content.trim() ? content.trim().split(/\s+/).length : 0;
        
        let score = 0;
        let checks = [];
        
        // Focus keyword
        if (focusKeyword) {
            score += 10;
            checks.push({ pass: true, text: 'Focus keyword is set' });
            
            // Keyword in title
            if (title.toLowerCase().includes(focusKeyword)) {
                score += 15;
                checks.push({ pass: true, text: 'Keyword in title' });
            } else {
                checks.push({ pass: false, text: 'Add keyword to title' });
            }
            
            // Keyword in meta
            if (metaDesc.toLowerCase().includes(focusKeyword)) {
                score += 10;
                checks.push({ pass: true, text: 'Keyword in meta description' });
            } else {
                checks.push({ pass: false, text: 'Add keyword to meta description' });
            }
            
            // Keyword in content
            const keywordCount = (content.toLowerCase().match(new RegExp(focusKeyword, 'g')) || []).length;
            const density = wordCount > 0 ? (keywordCount / wordCount * 100) : 0;
            
            if (keywordCount >= 3 && density >= 0.5 && density <= 2.5) {
                score += 15;
                checks.push({ pass: true, text: `Keyword density: ${density.toFixed(1)}% (${keywordCount}x)` });
            } else if (keywordCount > 0) {
                score += 5;
                checks.push({ pass: 'warn', text: `Keyword density: ${density.toFixed(1)}% - aim for 0.5-2.5%` });
            } else {
                checks.push({ pass: false, text: 'Add keyword to content' });
            }
        } else {
            checks.push({ pass: false, text: 'Set a focus keyword' });
        }
        
        // Meta title length
        if (metaTitle.length >= 30 && metaTitle.length <= 60) {
            score += 15;
            checks.push({ pass: true, text: `Meta title length: ${metaTitle.length}/60` });
        } else if (metaTitle.length > 0) {
            score += 5;
            checks.push({ pass: 'warn', text: `Meta title: ${metaTitle.length} chars (aim for 30-60)` });
        } else {
            checks.push({ pass: false, text: 'Add meta title' });
        }
        
        // Meta description length
        if (metaDesc.length >= 120 && metaDesc.length <= 160) {
            score += 15;
            checks.push({ pass: true, text: `Meta description length: ${metaDesc.length}/160` });
        } else if (metaDesc.length > 0) {
            score += 5;
            checks.push({ pass: 'warn', text: `Meta description: ${metaDesc.length} chars (aim for 120-160)` });
        } else {
            checks.push({ pass: false, text: 'Add meta description' });
        }
        
        // Content length
        if (wordCount >= 300) {
            score += 20;
            checks.push({ pass: true, text: `Content length: ${wordCount} words` });
        } else if (wordCount >= 100) {
            score += 10;
            checks.push({ pass: 'warn', text: `Content: ${wordCount} words (aim for 300+)` });
        } else {
            checks.push({ pass: false, text: `Add more content (${wordCount} words)` });
        }
        
        // Update UI
        const scoreCircle = document.getElementById('seo-score-circle');
        scoreCircle.textContent = score;
        scoreCircle.className = 'seo-score-circle';
        
        if (score >= 70) {
            scoreCircle.classList.add('good');
            document.getElementById('seo-score-hint').textContent = 'Great! Your content is well optimized';
        } else if (score >= 40) {
            scoreCircle.classList.add('ok');
            document.getElementById('seo-score-hint').textContent = 'Good, but could be improved';
        } else {
            scoreCircle.classList.add('poor');
            document.getElementById('seo-score-hint').textContent = 'Needs improvement';
        }
        
        // Update checklist
        const checklist = document.getElementById('seo-checklist');
        checklist.innerHTML = checks.map(c => `
            <li>
                <span class="seo-check ${c.pass === true ? 'pass' : c.pass === 'warn' ? 'warn' : 'fail'}">
                    ${c.pass === true ? '‚úì' : c.pass === 'warn' ? '!' : '‚úó'}
                </span>
                ${c.text}
            </li>
        `).join('');
    }
    
    // Media Browser
    let mediaTarget = 'featured'; // 'featured' or 'editor'
    
    function openMediaBrowser(target = 'featured') {
        mediaTarget = target;
        selectedMediaUrl = null;
        document.getElementById('select-media-btn').disabled = true;
        document.querySelectorAll('.media-item').forEach(item => item.classList.remove('selected'));
        document.getElementById('media-modal').classList.add('active');
    }
    
    function closeMediaBrowser() {
        document.getElementById('media-modal').classList.remove('active');
    }
    
    document.querySelectorAll('.media-item').forEach(item => {
        item.addEventListener('click', function() {
            document.querySelectorAll('.media-item').forEach(i => i.classList.remove('selected'));
            this.classList.add('selected');
            selectedMediaUrl = this.dataset.url;
            document.getElementById('select-media-btn').disabled = false;
        });
    });
    
    function selectMedia() {
        if (!selectedMediaUrl) return;
        
        if (mediaTarget === 'featured') {
            document.getElementById('featured-image-value').value = selectedMediaUrl;
            const box = document.getElementById('featured-image-box');
            box.innerHTML = `<img src="${selectedMediaUrl}" alt="Featured"><button type="button" class="remove-btn" onclick="event.stopPropagation(); removeFeaturedImage();">√ó</button>`;
            box.classList.add('has-image');
        } else if (mediaTarget === 'editor') {
            tinymce.get('editor').insertContent(`<img src="${selectedMediaUrl}" alt="" style="max-width: 100%;">`);
        }
        
        closeMediaBrowser();
    }
    
    function removeFeaturedImage() {
        document.getElementById('featured-image-value').value = '';
        const box = document.getElementById('featured-image-box');
        box.innerHTML = '<div class="placeholder"><div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∑</div><div>Click to select image</div></div>';
        box.classList.remove('has-image');
    }
    
    // File upload
    const uploadArea = document.getElementById('upload-area');
    const uploadInput = document.getElementById('media-upload');
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            uploadFile(e.dataTransfer.files[0]);
        }
    });
    
    uploadInput.addEventListener('change', () => {
        if (uploadInput.files.length) {
            uploadFile(uploadInput.files[0]);
        }
    });
    
    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('csrf_token', CSRF_TOKEN);
        
        fetch('/admin/api/article-image-upload.php', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            // Support both formats: {success, url} or {ok, file:{url}}
            const success = data.success || data.ok;
            const url = data.url || (data.file && data.file.url);
            const filename = data.filename || (data.file && data.file.name) || 'image';
            
            if (success && url) {
                const grid = document.getElementById('media-grid');
                const item = document.createElement('div');
                item.className = 'media-item selected';
                item.dataset.url = url;
                item.innerHTML = `<img src="${url}" alt=""><div class="filename">${filename}</div>`;
                item.addEventListener('click', function() {
                    document.querySelectorAll('.media-item').forEach(i => i.classList.remove('selected'));
                    document.querySelectorAll('.stock-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMediaUrl = this.dataset.url;
                    document.getElementById('select-media-btn').disabled = false;
                });
                grid.insertBefore(item, grid.firstChild);
                
                selectedMediaUrl = url;
                document.getElementById('select-media-btn').disabled = false;
                // Switch to library tab
                document.querySelector('[data-media-tab="library"]').click();
                showToast('Image uploaded!', 'success');
            } else {
                showToast(data.error || 'Upload failed', 'error');
            }
        })
        .catch(() => showToast('Upload failed', 'error'));
    }
    
    // Media Tabs
    document.querySelectorAll('.media-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.media-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.media-tab-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('media-tab-' + this.dataset.mediaTab).classList.add('active');
        });
    });
    
    // Stock Photos (Pexels)
    function searchStockPhotos() {
        const query = document.getElementById('stock-search-input').value.trim();
        if (!query) {
            showToast('Please enter a search term', 'error');
            return;
        }
        
        const results = document.getElementById('stock-results');
        results.innerHTML = '<div class="stock-loading"><p>üîç Searching...</p></div>';
        
        const apiKey = '<?= htmlspecialchars($pexelsApiKey) ?>';
        
        if (!apiKey) {
            results.innerHTML = `
                <div class="stock-loading">
                    <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</p>
                    <p>Pexels API key not configured</p>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                        Get free key at <a href="https://www.pexels.com/api/" target="_blank" style="color: var(--primary);">pexels.com/api</a><br>
                        Then add in Settings ‚Üí API Keys
                    </p>
                </div>
            `;
            return;
        }
        
        fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=20`, {
            headers: { 'Authorization': apiKey }
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                results.innerHTML = `<div class="stock-loading"><p>‚ùå API Error: ${data.error}</p></div>`;
                return;
            }
            if (!data.photos || data.photos.length === 0) {
                results.innerHTML = '<div class="stock-loading"><p>No photos found. Try different keywords.</p></div>';
                return;
            }
            
            let html = '<div class="stock-grid">';
            data.photos.forEach(photo => {
                html += `
                    <div class="stock-item" data-url="${photo.src.large}">
                        <img src="${photo.src.small}" alt="${photo.alt || ''}">
                        <div class="credit">üì∑ ${photo.photographer}</div>
                    </div>
                `;
            });
            html += '</div>';
            html += '<p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 1rem; text-align: center;">Photos from <a href="https://www.pexels.com" target="_blank" style="color: var(--primary);">Pexels</a> - Free to use</p>';
            results.innerHTML = html;
            
            // Bind click events
            document.querySelectorAll('.stock-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.media-item').forEach(i => i.classList.remove('selected'));
                    document.querySelectorAll('.stock-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMediaUrl = this.dataset.url;
                    document.getElementById('select-media-btn').disabled = false;
                });
            });
        })
        .catch(err => {
            results.innerHTML = '<div class="stock-loading"><p>‚ùå Error loading photos. Try again.</p></div>';
            console.error(err);
        });
    }
    
    // Enter key for stock search
    document.getElementById('stock-search-input')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchStockPhotos();
        }
    });
    
    // AI Image Generator
    function generateAiImage() {
        const prompt = document.getElementById('ai-image-prompt').value.trim();
        if (!prompt) {
            showToast('Please describe the image you want to create', 'error');
            return;
        }
        
        const style = document.getElementById('ai-image-style').value;
        const size = document.getElementById('ai-image-size').value;
        const preview = document.getElementById('ai-gen-preview');
        
        preview.innerHTML = '<div class="ai-gen-status"><div style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div><p>üé® Generating your image...</p><p style="font-size: 0.75rem; color: var(--text-muted);">This may take 10-30 seconds</p></div>';
        
        // Add spinner animation
        if (!document.getElementById('spinner-style')) {
            const styleEl = document.createElement('style');
            styleEl.id = 'spinner-style';
            styleEl.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
            document.head.appendChild(styleEl);
        }
        
        fetch('/admin/api/ai-image-generate.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                csrf_token: CSRF_TOKEN,
                prompt: prompt,
                style: style,
                size: size
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.ok && data.url) {
                preview.innerHTML = `
                    <div style="text-align: center;">
                        <img src="${data.url}" alt="AI Generated" class="ai-gen-result" style="max-height: 400px;">
                        <p style="font-size: 0.75rem; color: var(--success); margin-top: 1rem;">‚úÖ Image generated!</p>
                    </div>
                `;
                selectedMediaUrl = data.url;
                document.getElementById('select-media-btn').disabled = false;
                
                // Add to media grid
                const grid = document.getElementById('media-grid');
                const item = document.createElement('div');
                item.className = 'media-item';
                item.dataset.url = data.url;
                item.innerHTML = `<img src="${data.url}" alt="AI Generated"><div class="filename">ai-generated.png</div>`;
                item.addEventListener('click', function() {
                    document.querySelectorAll('.media-item').forEach(i => i.classList.remove('selected'));
                    document.querySelectorAll('.stock-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMediaUrl = this.dataset.url;
                    document.getElementById('select-media-btn').disabled = false;
                });
                grid.insertBefore(item, grid.firstChild);
                
                showToast('Image generated successfully!', 'success');
            } else {
                preview.innerHTML = `<div class="ai-gen-status"><p>‚ùå ${data.error || 'Generation failed'}</p></div>`;
            }
        })
        .catch(err => {
            preview.innerHTML = '<div class="ai-gen-status"><p>‚ùå Error generating image</p></div>';
            console.error(err);
        });
    }
    
    // AI Functions
    async function aiGenerate(action) {
        const content = tinymce.get('editor') ? tinymce.get('editor').getContent({ format: 'text' }) : '';
        
        if (!content.trim() && action !== 'generate_title') {
            showToast('Add some content first', 'error');
            return;
        }
        
        const text = content.substring(0, 2000); // Limit text
        
        showToast('AI is working...', 'success');
        
        try {
            const selectedModel = document.getElementById('aiModelSelect')?.value || '';
            const response = await fetch(window.location.href, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    ajax: '1',
                    csrf_token: CSRF_TOKEN,
                    ajax_action: action,
                    ai_model: selectedModel,
                    text: text
                })
            });

            const result = await response.json();

            if (result.success) {
                showAiResult(action, result.content);
            } else {
                showToast(result.error || 'AI request failed', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }

    async function aiTransformSelection(action) {
        const editor = tinymce.get('editor');
        const selection = editor.selection.getContent({ format: 'text' });

        if (!selection.trim()) {
            showToast('Select some text first', 'error');
            return;
        }

        showToast('AI is working...', 'success');

        try {
            const selectedModel = document.getElementById('aiModelSelect')?.value || '';
            const response = await fetch(window.location.href, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    ajax: '1',
                    csrf_token: CSRF_TOKEN,
                    ajax_action: action,
                    ai_model: selectedModel,
                    text: selection
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAiResult(action, result.content, selection);
            } else {
                showToast(result.error || 'AI request failed', 'error');
            }
        } catch (e) {
            showToast('Network error', 'error');
        }
    }
    
    function showAiResult(action, content, originalSelection = null) {
        const container = document.getElementById('ai-result-container');
        const actionLabels = {
            'generate_title': 'üìù Generated Titles',
            'generate_excerpt': 'üìÑ Generated Excerpt',
            'generate_meta': 'üéØ Meta Description',
            'generate_keywords': 'üîë Keywords',
            'improve_content': '‚ú® Improved Text',
            'expand_content': 'üìù Expanded Text',
            'simplify': 'üìñ Simplified Text',
            'translate_en': 'üá¨üáß English Translation',
            'translate_pl': 'üáµüá± Polish Translation',
            'translate_de': 'üá©üá™ German Translation',
            'fix_grammar': '‚úì Fixed Text',
            'make_formal': 'üëî Formal Version',
            'make_casual': 'üòä Casual Version'
        };
        
        let applyBtn = '';
        if (action === 'generate_excerpt') {
            applyBtn = `<button type="button" class="btn btn-sm btn-primary" onclick="document.getElementById('excerpt').value = this.closest('.ai-result').querySelector('.ai-result-content').textContent; showToast('Applied!', 'success');">Apply to Excerpt</button>`;
        } else if (action === 'generate_meta') {
            applyBtn = `<button type="button" class="btn btn-sm btn-primary" onclick="document.getElementById('meta-desc').value = this.closest('.ai-result').querySelector('.ai-result-content').textContent.substring(0, 160); updateCharCount(document.getElementById('meta-desc'), 160); showToast('Applied!', 'success');">Apply</button>`;
        } else if (action === 'generate_keywords') {
            applyBtn = `<button type="button" class="btn btn-sm btn-primary" onclick="document.querySelector('[name=meta_keywords]').value = this.closest('.ai-result').querySelector('.ai-result-content').textContent; showToast('Applied!', 'success');">Apply</button>`;
        } else if (originalSelection && ['improve_content', 'expand_content', 'simplify', 'fix_grammar', 'make_formal', 'make_casual', 'translate_en', 'translate_pl', 'translate_de'].includes(action)) {
            applyBtn = `<button type="button" class="btn btn-sm btn-primary" onclick="tinymce.get('editor').selection.setContent(this.closest('.ai-result').querySelector('.ai-result-content').textContent); showToast('Replaced!', 'success');">Replace Selection</button>`;
        }
        
        container.innerHTML = `
            <div class="ai-result">
                <div class="ai-result-header">
                    <div class="ai-result-title">${actionLabels[action] || 'AI Result'}</div>
                    <button type="button" style="background: none; border: none; cursor: pointer;" onclick="this.closest('.ai-result').remove()">√ó</button>
                </div>
                <div class="ai-result-content">${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                <div class="ai-result-actions">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="navigator.clipboard.writeText(this.closest('.ai-result').querySelector('.ai-result-content').textContent); showToast('Copied!', 'success');">üìã Copy</button>
                    ${applyBtn}
                </div>
            </div>
        `;
        
        // Switch to AI tab
        document.querySelector('[data-tab="ai"]').click();
    }
    
    function showToast(message, type = 'success') {
        const existing = document.querySelector('.toast');
        if (existing) existing.remove();
        
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    // Init
    updateCharCount(document.getElementById('meta-title'), 60);
    updateCharCount(document.getElementById('meta-desc'), 160);
    </script>

<?php if ($aiImagesAvailable): ?>
<!-- AI Image Generator Modal (Dark Theme) -->
<div id="ai-image-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10000; overflow-y: auto;">
    <div style="max-width: 600px; margin: 50px auto; background: #1e1e2e; border-radius: 16px; padding: 24px; color: #cdd6f4; border: 1px solid #313244;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; font-size: 18px;">üé® Generate AI Image</h3>
            <button onclick="closeAiImageModal()" style="background: none; border: none; color: #a6adc8; font-size: 24px; cursor: pointer;">&times;</button>
        </div>

        <div id="ai-image-form">
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #cdd6f4;">Image Description</label>
                <textarea id="ai-image-prompt" rows="3" style="width: 100%; padding: 10px; background: #313244; border: 1px solid #45475a; border-radius: 8px; color: #cdd6f4; font-size: 14px; font-family: inherit;" placeholder="Describe the image you want to generate..."></textarea>
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #cdd6f4;">SEO Filename <span style="color: #6c7086; font-weight: normal;">(auto-generated if empty)</span></label>
                <input type="text" id="ai-image-seo-name" style="width: 100%; padding: 10px; background: #313244; border: 1px solid #45475a; border-radius: 8px; color: #cdd6f4; font-size: 14px;" placeholder="e.g., professional-business-meeting">
                <small style="color: #6c7086; font-size: 11px;">Use lowercase letters, numbers, and hyphens</small>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #cdd6f4;">Style</label>
                    <select id="ai-image-style" style="width: 100%; padding: 10px; background: #313244; border: 1px solid #45475a; border-radius: 8px; color: #cdd6f4;">
                        <option value="photorealistic">Photorealistic</option>
                        <option value="illustration">Illustration</option>
                        <option value="3d">3D Render</option>
                        <option value="minimalist">Minimalist</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #cdd6f4;">Aspect Ratio</label>
                    <select id="ai-image-aspect" style="width: 100%; padding: 10px; background: #313244; border: 1px solid #45475a; border-radius: 8px; color: #cdd6f4;">
                        <option value="16:9">16:9 (Landscape)</option>
                        <option value="1:1">1:1 (Square)</option>
                        <option value="9:16">9:16 (Portrait)</option>
                    </select>
                </div>
            </div>

            <button type="button" onclick="generateAiImage()" id="ai-generate-btn" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #89b4fa, #b4befe); color: #1e1e2e; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                ‚ú® Generate Image
            </button>
        </div>

        <div id="ai-image-result" style="display: none; margin-top: 20px;">
            <img id="ai-image-preview" src="" style="width: 100%; border-radius: 8px; margin-bottom: 12px;">
            <div style="display: flex; gap: 8px;">
                <button type="button" onclick="useAiImage()" style="flex: 1; padding: 10px; background: #a6e3a1; color: #1e1e2e; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    ‚úì Use as Featured Image
                </button>
                <button type="button" onclick="generateAiImage()" style="flex: 1; padding: 10px; background: #45475a; color: #cdd6f4; border: none; border-radius: 8px; cursor: pointer;">
                    ‚Üª Regenerate
                </button>
            </div>
        </div>

        <div id="ai-image-loading" style="display: none; text-align: center; padding: 40px; color: #a6adc8;">
            <div style="font-size: 32px; margin-bottom: 12px;">‚è≥</div>
            <p>Generating image with DALL-E... (15-30 seconds)</p>
        </div>

        <div id="ai-image-error" style="display: none; padding: 12px; background: rgba(243,139,168,0.15); border-radius: 8px; color: #f38ba8; margin-top: 12px;"></div>
    </div>
</div>

<script>
let generatedImagePath = '';

function openAiImageModal() {
    document.getElementById('ai-image-modal').style.display = 'block';
    document.getElementById('ai-image-form').style.display = 'block';
    document.getElementById('ai-image-result').style.display = 'none';
    document.getElementById('ai-image-loading').style.display = 'none';
    document.getElementById('ai-image-error').style.display = 'none';

    // Pre-fill prompt and SEO name from article title if empty
    const prompt = document.getElementById('ai-image-prompt');
    const seoName = document.getElementById('ai-image-seo-name');
    const titleEl = document.getElementById('article-title');
    
    if (titleEl && titleEl.value) {
        const title = titleEl.value;
        if (!prompt.value) {
            prompt.value = 'Professional image for article about: ' + title;
        }
        if (!seoName.value) {
            // Generate SEO slug from title
            seoName.value = title.toLowerCase()
                .replace(/[ƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]/g, function(c) {
                    return {'ƒÖ':'a','ƒá':'c','ƒô':'e','≈Ç':'l','≈Ñ':'n','√≥':'o','≈õ':'s','≈∫':'z','≈º':'z'}[c] || c;
                })
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '')
                .substring(0, 50);
        }
    }
}

function closeAiImageModal() {
    document.getElementById('ai-image-modal').style.display = 'none';
}

function generateAiImage() {
    const prompt = document.getElementById('ai-image-prompt').value.trim();
    if (!prompt) {
        alert('Please enter an image description');
        return;
    }

    document.getElementById('ai-image-form').style.display = 'none';
    document.getElementById('ai-image-result').style.display = 'none';
    document.getElementById('ai-image-loading').style.display = 'block';
    document.getElementById('ai-image-error').style.display = 'none';

    const formData = new FormData();
    formData.append('action', 'generate_image');
    formData.append('prompt', prompt);
    formData.append('style', document.getElementById('ai-image-style').value);
    formData.append('aspect', document.getElementById('ai-image-aspect').value);
    formData.append('quality', 'standard');
    formData.append('seo_name', document.getElementById('ai-image-seo-name').value);
    formData.append('csrf_token', '<?= csrf_token() ?>');
    formData.append('ajax', '1');

    fetch('/admin/ai-images.php', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('ai-image-loading').style.display = 'none';

        if (data.ok && data.path) {
            generatedImagePath = data.path;
            document.getElementById('ai-image-preview').src = data.path;
            document.getElementById('ai-image-result').style.display = 'block';
        } else {
            document.getElementById('ai-image-form').style.display = 'block';
            document.getElementById('ai-image-error').style.display = 'block';
            document.getElementById('ai-image-error').textContent = data.error || 'Failed to generate image';
        }
    })
    .catch(err => {
        document.getElementById('ai-image-loading').style.display = 'none';
        document.getElementById('ai-image-form').style.display = 'block';
        document.getElementById('ai-image-error').style.display = 'block';
        document.getElementById('ai-image-error').textContent = 'Network error: ' + err.message;
    });
}

function useAiImage() {
    if (generatedImagePath) {
        // Set featured image
        document.getElementById('featured-image-value').value = generatedImagePath;

        // Update preview
        const box = document.getElementById('featured-image-box');
        box.innerHTML = '<img src="' + generatedImagePath + '" alt="Featured"><button type="button" class="remove-btn" onclick="event.stopPropagation(); removeFeaturedImage();">√ó</button>';
        box.classList.add('has-image');

        closeAiImageModal();
        showToast('AI image set as featured image!', 'success');
    }
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAiImageModal();
    }
});

// Close modal on background click
document.getElementById('ai-image-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeAiImageModal();
    }
});

// Publish article function
function publishArticle() {
    // Set status to published
    const publishedRadio = document.querySelector('input[name="status"][value="published"]');
    if (publishedRadio) {
        publishedRadio.checked = true;
        // Trigger change event to update UI
        publishedRadio.dispatchEvent(new Event('change', { bubbles: true }));
    }
    // Submit the form
    document.getElementById('article-form').submit();
}
</script>
<?php endif; ?>

</body>
</html>
