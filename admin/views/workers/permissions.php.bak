<?php
/**
 * Worker Permissions Management UI
 */

// Check permissions
if (!$auth->userHasPermission('manage_worker_permissions')) {
    $response->setStatusCode(403)->send();
    exit;
}

// Get existing data
$roles = $permissionsController->getRoleHierarchy();
$permissions = $permissionsController->getPermissions();


<?php
$layout = require_once __DIR__ . '/layout.php';
echo $layout;


<?php ob_start(); 
<div class="container-fluid">
    <h1>Worker Permissions Management</h1>

    <div class="row">
        <!-- Roles Section -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Roles</h3>
                    <button class="btn btn-primary float-right" data-toggle="modal" data-target="#createRoleModal">
                        Add Role
                    </button>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php
                            function renderRoleRow($role, $level = 0) {
                                $indent = str_repeat('&nbsp;&nbsp;&nbsp;', $level);
                                echo '<tr>';
                                echo '<td>'.$indent.htmlspecialchars($role['name']).'</td>';
                                echo '<td>'.htmlspecialchars($role['description']).'</td>';
                                echo '<td>';
                                echo '<a href="#" class="btn btn-sm btn-info">Edit</a> ';
                                echo '<a href="#" class="btn btn-sm btn-danger">Delete</a>';
                                echo '</td>';
                                echo '</tr>';
                                
                                foreach ($role['children'] as $child) {
                                    renderRoleRow($child, $level + 1);
                                }
                            }
                            
                            foreach ($roles as $role) {
                                renderRoleRow($role);
                            }
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Permissions Section -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Permissions</h3>
                    <button class="btn btn-primary float-right" data-toggle="modal" data-target="#createPermissionModal">
                        Add Permission
                    </button>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($permissions as $perm) {  ?>
                            <tr>
                                <td><?php echo htmlspecialchars($perm['name']) ?></td>
                                <td><?php echo htmlspecialchars($perm['description']) ?></td>
                                <td>
                                    <a href="#" class="btn btn-sm btn-info">Edit</a>
                                    <a href="#" class="btn btn-sm btn-danger">Delete</a>
                                </td>
                            </tr>
                            <?php } 
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Role-Permission Assignment Section -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>Role-Permission Assignments</h3>
                </div>
                <div class="card-body">
                    <form id="rolePermissionForm">
                        <input type="hidden" name="csrf_token" value="<?= $auth->getCsrfToken() ?>">
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">Select Role:</label>
                            <div class="col-sm-4">
                                <select class="form-control" name="role_id" required>
                                    <option value="">-- Select Role --</option>
                                    <?php
                                    function renderRoleSelectOptions($roles, $level = 0) {
                                        $indent = str_repeat('&nbsp;&nbsp;', $level);
                                        foreach ($roles as $role) {
                                            echo '<option value="'.$role['id'].'">'.$indent.htmlspecialchars($role['name']).'</option>';
                                            if (!empty($role['children'])) {
                                                renderRoleSelectOptions($role['children'], $level + 1);
                                            }
                                        }
                                    }
                                    renderRoleSelectOptions($roles);
                                    
                                </select>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-sm-10 offset-sm-2">
                                <div class="alert alert-info">
                                    <small>Permissions are inherited from parent roles</small>
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">Available Permissions:</label>
                            <div class="col-sm-10">
                                <?php foreach ($permissions as $perm) {  ?>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="permissions[]"
                                           value="<?php echo $perm['id'] ?>" id="perm_<?php echo $perm['id'] ?>">
                                    <label class="form-check-label" for="perm_<?php echo $perm['id'] ?>">
                                        <?php echo htmlspecialchars($perm['name'])  ?>
                                    </label>
                                </div>
                                <?php } 
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Assignments</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Role Modal -->
<div class="modal fade" id="createRoleModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Role</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="createRoleForm" action="/admin/workers/permissions" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="<?php echo $auth->getCsrfToken() ?>">
                    <input type="hidden" name="action" value="create_role">
                    <div class="form-group">
                        <label>Role Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Parent Role</label>
                        <select name="parent_id" class="form-control">
                            <option value="">-- No Parent --</option>
                            <?php
                            function renderRoleOptions($roles, $level = 0) {
                                $indent = str_repeat('&nbsp;&nbsp;', $level);
                                foreach ($roles as $role) {
                                    echo '<option value="'.$role['id'].'">'.$indent.htmlspecialchars($role['name']).'</option>';
                                    if (!empty($role['children'])) {
                                        renderRoleOptions($role['children'], $level + 1);
                                    }
                                }
                            }
                            renderRoleOptions($roles);
                            
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" class="form-control"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create Role</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Permission Modal -->
<div class="modal fade" id="createPermissionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Permission</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="createPermissionForm" action="/admin/workers/permissions" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="<?php echo $auth->getCsrfToken() ?>">
                    <input type="hidden" name="action" value="create_permission">
                    <div class="form-group">
                        <label>Permission Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" class="form-control"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create Permission</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Handle form submissions
    $('#createRoleForm').on('submit', function(e) {
        e.preventDefault();
        $.post($(this).attr('action'), $(this).serialize(), function() {
            location.reload();
        });
    });

    $('#createPermissionForm').on('submit', function(e) {
        e.preventDefault();
        let data = $(this).serializeArray();
        data.push({name: 'csrf_token', value: '<?= $_SESSION['csrf_token'] ?>'});
        $.post($(this).attr('action'), $.param(data), function() {
            location.reload();
        });
    });

    $('#rolePermissionForm').on('submit', function(e) {
        e.preventDefault();
        $.post('/admin/workers/permissions', {
            action: 'assign_permissions',
            role_id: $('select[name="role_id"]').val(),
            permissions: $('input[name="permissions[]"]:checked').map(function() {
                return this.value;
            }).get(),
            csrf_token: '<?= $_SESSION['csrf_token'] ?>'
        }, function() {
            location.reload();
        });
    });
});
</script>
<?php
$content = ob_get_clean();
echo $content;
