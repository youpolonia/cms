<?php
/**
 * Theme Editor - Edit theme settings, colors, and CSS
 * DO NOT add closing ?> tag
 */

if (!defined('CMS_ROOT')) {
    define('CMS_ROOT', realpath(__DIR__ . '/..'));
}

require_once CMS_ROOT . '/config.php';
require_once CMS_ROOT . '/core/session_boot.php';
cms_session_start('admin');

require_once CMS_ROOT . '/core/csrf.php';
csrf_boot('admin');

require_once CMS_ROOT . '/admin/includes/permissions.php';
cms_require_admin_role();

function esc($str) {
    return htmlspecialchars((string)$str, ENT_QUOTES, 'UTF-8');
}

$themeName = preg_replace('/[^a-z0-9_-]/i', '', $_GET['name'] ?? '');
$themePath = CMS_ROOT . '/themes/' . $themeName;
$message = '';
$messageType = '';

// Validate theme exists
if (empty($themeName) || !is_dir($themePath)) {
    header('Location: /admin/themes');
    exit;
}

// Load theme data
$themeJson = [];
$jsonPath = $themePath . '/theme.json';
if (file_exists($jsonPath)) {
    $themeJson = json_decode(file_get_contents($jsonPath), true) ?: [];
}

// Load CSS
$cssPath = $themePath . '/assets/css/style.css';
if (!file_exists($cssPath)) {
    $cssPath = $themePath . '/style.css';
}
$cssContent = file_exists($cssPath) ? file_get_contents($cssPath) : '';

// Handle save
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    csrf_validate_or_403();
    
    $action = $_POST['action'] ?? '';
    
    if ($action === 'save_settings') {
        $themeJson['name'] = $_POST['theme_name'] ?? $themeJson['name'] ?? ucfirst($themeName);
        $themeJson['description'] = $_POST['description'] ?? '';
        $themeJson['version'] = $_POST['version'] ?? '1.0.0';
        $themeJson['author'] = $_POST['author'] ?? '';
        
        // Colors
        $themeJson['colors'] = [
            'primary' => $_POST['color_primary'] ?? '#8b5cf6',
            'secondary' => $_POST['color_secondary'] ?? '#6366f1',
            'accent' => $_POST['color_accent'] ?? '#ec4899',
            'background' => $_POST['color_background'] ?? '#0f0f12',
            'surface' => $_POST['color_surface'] ?? '#1a1a21',
            'text' => $_POST['color_text'] ?? '#ffffff',
            'text_muted' => $_POST['color_text_muted'] ?? '#a0a0b0',
        ];
        
        if (file_put_contents($jsonPath, json_encode($themeJson, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES))) {
            $message = 'Theme settings saved successfully!';
            $messageType = 'success';
        } else {
            $message = 'Failed to save settings. Check file permissions.';
            $messageType = 'error';
        }
    }
    
    if ($action === 'save_css') {
        $newCss = $_POST['css_content'] ?? '';
        $targetCss = $themePath . '/assets/css/style.css';
        
        // Create directory if needed
        $cssDir = dirname($targetCss);
        if (!is_dir($cssDir)) {
            @mkdir($cssDir, 0755, true);
        }
        
        if (file_put_contents($targetCss, $newCss)) {
            $cssContent = $newCss;
            $cssPath = $targetCss;
            $message = 'CSS saved successfully!';
            $messageType = 'success';
        } else {
            $message = 'Failed to save CSS. Check file permissions.';
            $messageType = 'error';
        }
    }
}

$pageTitle = 'Edit Theme: ' . esc($themeJson['name'] ?? $themeName);
require_once CMS_ROOT . '/admin/includes/header.php';
?>

<style>
.theme-editor { display: grid; grid-template-columns: 350px 1fr; gap: 1.5rem; min-height: 600px; }
.editor-sidebar { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; }
.editor-main { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; }

.sidebar-section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
.sidebar-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
.section-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 1rem; }

.form-group { margin-bottom: 1rem; }
.form-group label { display: block; font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.375rem; color: var(--text); }
.form-group input, .form-group textarea { width: 100%; padding: 0.625rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem; }
.form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
.form-group textarea { min-height: 80px; resize: vertical; }

.color-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
.color-item { display: flex; align-items: center; gap: 0.5rem; }
.color-item label { flex: 1; font-size: 0.75rem; color: var(--text-muted); }
.color-item input[type="color"] { width: 32px; height: 32px; border: 2px solid var(--border); border-radius: 6px; cursor: pointer; padding: 0; }
.color-item input[type="text"] { width: 80px; padding: 0.375rem 0.5rem; font-family: monospace; font-size: 0.75rem; }

.editor-tabs { display: flex; border-bottom: 1px solid var(--border); }
.editor-tab { padding: 1rem 1.5rem; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-weight: 500; cursor: pointer; transition: all 0.15s; }
.editor-tab:hover { color: var(--text); }
.editor-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

.editor-content { flex: 1; display: flex; flex-direction: column; }
.css-editor { flex: 1; display: flex; flex-direction: column; }
.css-editor textarea { flex: 1; width: 100%; padding: 1rem; background: #1e1e2e; color: #cdd6f4; font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; line-height: 1.6; border: none; resize: none; }
.css-editor textarea:focus { outline: none; }

.preview-frame { flex: 1; border: none; background: white; }

.editor-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.editor-actions { display: flex; gap: 0.75rem; }

.theme-preview-box { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-top: 1rem; }
.preview-colors { display: flex; gap: 0.25rem; margin-bottom: 0.5rem; }
.preview-color { width: 24px; height: 24px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); }
.preview-text { font-size: 0.75rem; color: var(--text-muted); }

.tab-content { display: none; flex: 1; flex-direction: column; }
.tab-content.active { display: flex; }
</style>

<?php if ($message): ?>
<div class="alert alert-<?= $messageType ?>">
    <?= esc($message) ?>
</div>
<?php endif; ?>

<div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div>
        <h1 style="margin: 0;">Edit Theme: <?= esc($themeJson['name'] ?? $themeName) ?></h1>
        <p style="color: var(--text-muted); margin: 0.25rem 0 0;">Customize theme settings and styles</p>
    </div>
    <div style="display: flex; gap: 0.75rem;">
        <a href="/?theme=<?= urlencode($themeName) ?>" target="_blank" class="btn">Preview ‚Üí</a>
        <a href="/admin/themes" class="btn">‚Üê Back to Themes</a>
    </div>
</div>

<div class="theme-editor">
    <div class="editor-sidebar">
        <form method="POST">
            <?= csrf_field() ?>
            <input type="hidden" name="action" value="save_settings">
            
            <div class="sidebar-section">
                <div class="section-title">Theme Info</div>
                <div class="form-group">
                    <label>Theme Name</label>
                    <input type="text" name="theme_name" value="<?= esc($themeJson['name'] ?? ucfirst($themeName)) ?>">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description"><?= esc($themeJson['description'] ?? '') ?></textarea>
                </div>
                <div class="form-group">
                    <label>Version</label>
                    <input type="text" name="version" value="<?= esc($themeJson['version'] ?? '1.0.0') ?>">
                </div>
                <div class="form-group">
                    <label>Author</label>
                    <input type="text" name="author" value="<?= esc($themeJson['author'] ?? '') ?>">
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="section-title">Colors</div>
                <div class="color-grid">
                    <?php
                    $colors = [
                        'primary' => 'Primary',
                        'secondary' => 'Secondary', 
                        'accent' => 'Accent',
                        'background' => 'Background',
                        'surface' => 'Surface',
                        'text' => 'Text',
                        'text_muted' => 'Text Muted',
                    ];
                    $themeColors = $themeJson['colors'] ?? [];
                    $defaults = [
                        'primary' => '#8b5cf6',
                        'secondary' => '#6366f1',
                        'accent' => '#ec4899',
                        'background' => '#0f0f12',
                        'surface' => '#1a1a21',
                        'text' => '#ffffff',
                        'text_muted' => '#a0a0b0',
                    ];
                    foreach ($colors as $key => $label):
                        $value = $themeColors[$key] ?? $defaults[$key];
                    ?>
                    <div class="color-item">
                        <label><?= $label ?></label>
                        <input type="color" value="<?= esc($value) ?>" onchange="this.nextElementSibling.value = this.value; this.nextElementSibling.dispatchEvent(new Event('input'));">
                        <input type="text" name="color_<?= $key ?>" value="<?= esc($value) ?>" onchange="this.previousElementSibling.value = this.value">
                    </div>
                    <?php endforeach; ?>
                </div>
                
                <div class="theme-preview-box">
                    <div class="preview-colors">
                        <?php foreach ($themeColors as $key => $color): ?>
                        <div class="preview-color" style="background: <?= esc($color) ?>" title="<?= esc($key) ?>"></div>
                        <?php endforeach; ?>
                    </div>
                    <div class="preview-text">Theme color palette preview</div>
                </div>
            </div>
            
            <button type="submit" class="btn primary" style="width: 100%;">Save Settings</button>
        </form>
    </div>
    
    <div class="editor-main">
        <div class="editor-tabs">
            <button class="editor-tab active" onclick="switchTab('css', this)">CSS Editor</button>
            <button class="editor-tab" onclick="switchTab('preview', this)">Live Preview</button>
            <button class="editor-tab" onclick="switchTab('files', this)">Theme Files</button>
        </div>
        
        <div id="tab-css" class="tab-content active">
            <form method="POST" class="css-editor">
                <?= csrf_field() ?>
                <input type="hidden" name="action" value="save_css">
                <textarea name="css_content" placeholder="/* Theme CSS */"><?= esc($cssContent) ?></textarea>
                <div class="editor-footer">
                    <span style="color: var(--text-muted); font-size: 0.8125rem;">
                        <?= file_exists($cssPath) ? 'Editing: ' . str_replace(CMS_ROOT, '', $cssPath) : 'No CSS file found' ?>
                    </span>
                    <div class="editor-actions">
                        <button type="submit" class="btn primary">Save CSS</button>
                    </div>
                </div>
            </form>
        </div>
        
        <div id="tab-preview" class="tab-content">
            <iframe src="/?theme=<?= urlencode($themeName) ?>" class="preview-frame"></iframe>
        </div>
        
        <div id="tab-files" class="tab-content" style="padding: 1.5rem;">
            <div class="section-title">Theme Files</div>
            <div style="background: var(--bg); border-radius: 8px; padding: 1rem; font-family: monospace; font-size: 0.8125rem;">
                <?php
                function listThemeFiles($dir, $base = '', $level = 0) {
                    $files = @scandir($dir);
                    if (!$files) return;
                    foreach ($files as $file) {
                        if ($file === '.' || $file === '..') continue;
                        $path = $dir . '/' . $file;
                        $indent = str_repeat('&nbsp;&nbsp;&nbsp;&nbsp;', $level);
                        if (is_dir($path)) {
                            echo "<div style='color: var(--primary);'>$indentüìÅ $file/</div>";
                            listThemeFiles($path, $base . $file . '/', $level + 1);
                        } else {
                            $size = number_format(filesize($path) / 1024, 1) . ' KB';
                            echo "<div style='color: var(--text-muted);'>$indentüìÑ $file <span style='opacity: 0.5;'>($size)</span></div>";
                        }
                    }
                }
                listThemeFiles($themePath);
                ?>
            </div>
        </div>
    </div>
</div>

<script>
function switchTab(tabId, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    btn.classList.add('active');
}

// Sync color inputs
document.querySelectorAll('.color-item input[type="color"]').forEach(input => {
    input.addEventListener('input', function() {
        this.nextElementSibling.value = this.value;
    });
});
document.querySelectorAll('.color-item input[type="text"]').forEach(input => {
    input.addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
            this.previousElementSibling.value = this.value;
        }
    });
});
</script>

<?php require_once CMS_ROOT . '/admin/includes/footer.php';
