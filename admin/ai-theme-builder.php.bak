<?php
/**
 * AI Theme Builder v2.0
 * Professional theme customization with AI-powered suggestions
 */
require_once __DIR__ . '/../config.php';
require_once __DIR__ . '/../core/database.php';
require_once __DIR__ . '/../core/session_boot.php';
cms_session_start('admin');
require_once __DIR__ . '/../core/csrf.php';
csrf_boot();

// Get real stats from database
$pdo = \core\Database::connection();
$totalPages = (int) $pdo->query("SELECT COUNT(*) FROM pages")->fetchColumn();
$totalArticles = (int) $pdo->query("SELECT COUNT(*) FROM articles")->fetchColumn();
$totalUsers = (int) $pdo->query("SELECT COUNT(*) FROM admins")->fetchColumn();

// Get recent content for preview
$recentContent = $pdo->query("
    SELECT title, status, created_at 
    FROM articles 
    ORDER BY created_at DESC 
    LIMIT 3
")->fetchAll(PDO::FETCH_ASSOC);

// Load AI settings
$aiSettings = [];
$aiSettingsFile = __DIR__ . '/../config/ai_settings.json';
if (file_exists($aiSettingsFile)) {
    $aiSettings = json_decode(file_get_contents($aiSettingsFile), true) ?: [];
}

$aiConfigured = false;
if (!empty($aiSettings['providers']['openai']['api_key'])) {
    $aiConfigured = true;
} elseif (!empty($aiSettings['api_key'])) {
    $aiConfigured = true;
}

// Load saved themes
$themesDir = __DIR__ . '/../config/themes';
if (!is_dir($themesDir)) {
    mkdir($themesDir, 0755, true);
}

$savedThemes = [];
foreach (glob($themesDir . '/*.json') as $file) {
    $theme = json_decode(file_get_contents($file), true);
    if ($theme) {
        $theme['filename'] = basename($file, '.json');
        $savedThemes[] = $theme;
    }
}

// Handle AJAX requests
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['ajax_action'])) {
    header('Content-Type: application/json');
    csrf_validate_or_403();
    
    $action = $_POST['ajax_action'];
    
    if ($action === 'save_theme') {
        $themeName = preg_replace('/[^a-z0-9\-_]/', '-', strtolower(trim($_POST['name'] ?? 'custom-theme')));
        $themeData = json_decode($_POST['theme_data'] ?? '{}', true);
        
        if (empty($themeName) || empty($themeData)) {
            echo json_encode(['success' => false, 'error' => 'Invalid theme data']);
            exit;
        }
        
        $themeData['name'] = $_POST['name'] ?? 'Custom Theme';
        $themeData['created'] = date('Y-m-d H:i:s');
        
        $filename = $themesDir . '/' . $themeName . '.json';
        if (file_put_contents($filename, json_encode($themeData, JSON_PRETTY_PRINT))) {
            echo json_encode(['success' => true, 'message' => 'Theme saved successfully']);
        } else {
            echo json_encode(['success' => false, 'error' => 'Failed to save theme']);
        }
        exit;
    }
    
    if ($action === 'generate_palette') {
        $prompt = trim($_POST['prompt'] ?? '');
        
        if (!$aiConfigured) {
            echo json_encode(['success' => false, 'error' => 'AI not configured. Please set up OpenAI API key in AI Settings.']);
            exit;
        }
        
        $apiKey = $aiSettings['providers']['openai']['api_key'] ?? $aiSettings['api_key'] ?? '';
        
        $systemPrompt = "You are a professional UI/UX designer specializing in color theory and web design. Generate a cohesive color palette for a web admin dashboard based on the user's description. Return ONLY a valid JSON object with these exact keys:
- bgPrimary: main background color (cards, modals)
- bgSecondary: page background
- bgTertiary: hover states, secondary backgrounds
- textPrimary: main text color
- textSecondary: secondary text
- textMuted: muted/disabled text
- accent: primary accent/brand color
- accentHover: accent hover state
- success: success color
- warning: warning color
- danger: danger/error color
- border: border color

Use hex color codes. Consider contrast ratios for accessibility. The palette should feel modern and professional.";

        $ch = curl_init('https://api.openai.com/v1/chat/completions');
        curl_setopt_array($ch, [
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_POST => true,
            CURLOPT_HTTPHEADER => [
                'Content-Type: application/json',
                'Authorization: Bearer ' . $apiKey
            ],
            CURLOPT_POSTFIELDS => json_encode([
                'model' => 'gpt-4o-mini',
                'messages' => [
                    ['role' => 'system', 'content' => $systemPrompt],
                    ['role' => 'user', 'content' => $prompt]
                ],
                'temperature' => 0.7,
                'max_tokens' => 500
            ])
        ]);
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        
        if ($httpCode !== 200) {
            echo json_encode(['success' => false, 'error' => 'API request failed']);
            exit;
        }
        
        $data = json_decode($response, true);
        $content = $data['choices'][0]['message']['content'] ?? '';
        
        // Extract JSON from response
        preg_match('/\{[\s\S]*\}/', $content, $matches);
        if (!empty($matches[0])) {
            $palette = json_decode($matches[0], true);
            if ($palette) {
                echo json_encode(['success' => true, 'palette' => $palette]);
                exit;
            }
        }
        
        echo json_encode(['success' => false, 'error' => 'Failed to parse AI response']);
        exit;
    }
    
    if ($action === 'delete_theme') {
        $filename = preg_replace('/[^a-z0-9\-_]/', '', strtolower($_POST['filename'] ?? ''));
        $filepath = $themesDir . '/' . $filename . '.json';
        
        if (file_exists($filepath) && unlink($filepath)) {
            echo json_encode(['success' => true]);
        } else {
            echo json_encode(['success' => false, 'error' => 'Failed to delete theme']);
        }
        exit;
    }
    
    if ($action === 'apply_theme') {
        $themeData = json_decode($_POST['theme_data'] ?? '{}', true);
        
        // Generate CSS file
        $css = generateThemeCSS($themeData);
        $cssFile = __DIR__ . '/../assets/css/theme-custom.css';
        
        if (file_put_contents($cssFile, $css)) {
            echo json_encode(['success' => true, 'message' => 'Theme applied successfully']);
        } else {
            echo json_encode(['success' => false, 'error' => 'Failed to apply theme']);
        }
        exit;
    }
    
    exit;
}

function generateThemeCSS($theme) {
    $colors = $theme['colors'] ?? [];
    $typography = $theme['typography'] ?? [];
    $spacing = $theme['spacing'] ?? [];
    
    $css = "/* Auto-generated theme - " . date('Y-m-d H:i:s') . " */\n";
    $css .= ":root {\n";
    
    // Colors
    if (!empty($colors['bgPrimary'])) $css .= "    --color-bg-primary: {$colors['bgPrimary']};\n";
    if (!empty($colors['bgSecondary'])) $css .= "    --color-bg-secondary: {$colors['bgSecondary']};\n";
    if (!empty($colors['bgTertiary'])) $css .= "    --color-bg-tertiary: {$colors['bgTertiary']};\n";
    if (!empty($colors['textPrimary'])) $css .= "    --color-text-primary: {$colors['textPrimary']};\n";
    if (!empty($colors['textSecondary'])) $css .= "    --color-text-secondary: {$colors['textSecondary']};\n";
    if (!empty($colors['textMuted'])) $css .= "    --color-text-muted: {$colors['textMuted']};\n";
    if (!empty($colors['accent'])) $css .= "    --color-accent: {$colors['accent']};\n";
    if (!empty($colors['accentHover'])) $css .= "    --color-accent-hover: {$colors['accentHover']};\n";
    if (!empty($colors['success'])) $css .= "    --color-success: {$colors['success']};\n";
    if (!empty($colors['warning'])) $css .= "    --color-warning: {$colors['warning']};\n";
    if (!empty($colors['danger'])) $css .= "    --color-danger: {$colors['danger']};\n";
    if (!empty($colors['border'])) $css .= "    --color-border: {$colors['border']};\n";
    
    // Typography
    if (!empty($typography['fontFamily'])) $css .= "    --font-sans: {$typography['fontFamily']};\n";
    if (!empty($typography['fontSize'])) $css .= "    --text-base: {$typography['fontSize']};\n";
    
    // Spacing
    if (!empty($spacing['borderRadius'])) $css .= "    --radius-md: {$spacing['borderRadius']};\n";
    if (!empty($spacing['sidebarWidth'])) $css .= "    --sidebar-width: {$spacing['sidebarWidth']};\n";
    
    $css .= "}\n";
    
    return $css;
}

// Preset themes
$presetThemes = [
    [
        'name' => 'Midnight Blue',
        'description' => 'Deep blue dark theme',
        'colors' => [
            'bgPrimary' => '#1a1f36',
            'bgSecondary' => '#0f1322',
            'bgTertiary' => '#252d4a',
            'textPrimary' => '#e6e9f0',
            'textSecondary' => '#a3accd',
            'textMuted' => '#6b7394',
            'accent' => '#5e72e4',
            'accentHover' => '#7c8cf5',
            'success' => '#2dce89',
            'warning' => '#fb6340',
            'danger' => '#f5365c',
            'border' => '#2d3561'
        ]
    ],
    [
        'name' => 'Forest Green',
        'description' => 'Nature-inspired green theme',
        'colors' => [
            'bgPrimary' => '#1a2421',
            'bgSecondary' => '#0f1613',
            'bgTertiary' => '#243029',
            'textPrimary' => '#e8f0ed',
            'textSecondary' => '#a8c4b8',
            'textMuted' => '#6a8a7a',
            'accent' => '#22c55e',
            'accentHover' => '#4ade80',
            'success' => '#22c55e',
            'warning' => '#eab308',
            'danger' => '#ef4444',
            'border' => '#2d4038'
        ]
    ],
    [
        'name' => 'Sunset Orange',
        'description' => 'Warm orange and coral theme',
        'colors' => [
            'bgPrimary' => '#2a1f1a',
            'bgSecondary' => '#1a1410',
            'bgTertiary' => '#3d2d24',
            'textPrimary' => '#f5ebe6',
            'textSecondary' => '#d4b8a8',
            'textMuted' => '#a07a64',
            'accent' => '#f97316',
            'accentHover' => '#fb923c',
            'success' => '#22c55e',
            'warning' => '#eab308',
            'danger' => '#ef4444',
            'border' => '#4a3828'
        ]
    ],
    [
        'name' => 'Purple Haze',
        'description' => 'Rich purple dark theme',
        'colors' => [
            'bgPrimary' => '#1e1a2e',
            'bgSecondary' => '#13101d',
            'bgTertiary' => '#2d2644',
            'textPrimary' => '#ebe6f5',
            'textSecondary' => '#b8a8d4',
            'textMuted' => '#7a64a0',
            'accent' => '#a855f7',
            'accentHover' => '#c084fc',
            'success' => '#22c55e',
            'warning' => '#eab308',
            'danger' => '#ef4444',
            'border' => '#3d3260'
        ]
    ],
    [
        'name' => 'Ocean Breeze',
        'description' => 'Calm teal and cyan theme',
        'colors' => [
            'bgPrimary' => '#1a2428',
            'bgSecondary' => '#101619',
            'bgTertiary' => '#243338',
            'textPrimary' => '#e6f2f5',
            'textSecondary' => '#a8ccd4',
            'textMuted' => '#6a9aa8',
            'accent' => '#06b6d4',
            'accentHover' => '#22d3ee',
            'success' => '#22c55e',
            'warning' => '#eab308',
            'danger' => '#ef4444',
            'border' => '#2d4248'
        ]
    ],
    [
        'name' => 'Clean Light',
        'description' => 'Minimal light theme',
        'colors' => [
            'bgPrimary' => '#ffffff',
            'bgSecondary' => '#f8fafc',
            'bgTertiary' => '#f1f5f9',
            'textPrimary' => '#0f172a',
            'textSecondary' => '#475569',
            'textMuted' => '#94a3b8',
            'accent' => '#3b82f6',
            'accentHover' => '#2563eb',
            'success' => '#22c55e',
            'warning' => '#f59e0b',
            'danger' => '#ef4444',
            'border' => '#e2e8f0'
        ]
    ]
];
?>
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Theme Builder - CMS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
    :root {
        --bg-primary: #1e1e2e;
        --bg-secondary: #181825;
        --bg-tertiary: #313244;
        --text-primary: #cdd6f4;
        --text-secondary: #a6adc8;
        --text-muted: #6c7086;
        --accent: #89b4fa;
        --accent-hover: #b4befe;
        --success: #a6e3a1;
        --warning: #f9e2af;
        --danger: #f38ba8;
        --border: #313244;
        --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
        font-family: var(--font-sans);
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        line-height: 1.5;
    }

    /* Layout */
    .builder-layout {
        display: grid;
        grid-template-columns: 340px 1fr 320px;
        min-height: 100vh;
    }

    /* Left Panel - Controls */
    .panel-left {
        background: var(--bg-primary);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .panel-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .panel-title {
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .panel-title-icon {
        font-size: 24px;
    }

    .panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    /* Tabs */
    .tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 20px;
        background: var(--bg-secondary);
        padding: 4px;
        border-radius: 10px;
    }

    .tab {
        flex: 1;
        padding: 10px;
        font-size: 13px;
        font-weight: 500;
        text-align: center;
        background: transparent;
        border: none;
        border-radius: 8px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .tab:hover {
        color: var(--text-primary);
    }

    .tab.active {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Section */
    .section {
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 12px;
    }

    /* Color Picker Row */
    .color-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
        padding: 10px 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
        transition: background 0.2s;
    }

    .color-row:hover {
        background: var(--bg-tertiary);
    }

    .color-preview {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 2px solid var(--border);
        cursor: pointer;
        transition: transform 0.2s;
    }

    .color-preview:hover {
        transform: scale(1.1);
    }

    .color-info {
        flex: 1;
    }

    .color-label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
    }

    .color-value {
        font-size: 12px;
        font-family: monospace;
        color: var(--text-muted);
    }

    .color-input {
        position: absolute;
        width: 36px;
        height: 36px;
        opacity: 0;
        cursor: pointer;
    }

    /* Form Elements */
    .form-group {
        margin-bottom: 16px;
    }

    .form-label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 6px;
    }

    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 10px 12px;
        font-family: inherit;
        font-size: 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        transition: border-color 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: var(--accent);
    }

    .form-textarea {
        min-height: 80px;
        resize: vertical;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 16px;
        font-family: inherit;
        font-size: 14px;
        font-weight: 500;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: var(--accent);
        color: #000;
    }

    .btn-primary:hover {
        background: var(--accent-hover);
    }

    .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .btn-secondary:hover {
        background: var(--border);
    }

    .btn-danger {
        background: rgba(243, 139, 168, 0.2);
        color: var(--danger);
    }

    .btn-danger:hover {
        background: var(--danger);
        color: #000;
    }

    .btn-block {
        width: 100%;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
    }

    .btn-group {
        display: flex;
        gap: 8px;
    }

    /* AI Prompt Section */
    .ai-section {
        background: linear-gradient(135deg, rgba(137, 180, 250, 0.1), rgba(180, 190, 254, 0.1));
        border: 1px solid rgba(137, 180, 250, 0.3);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
    }

    .ai-section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 12px;
    }

    /* Preset Themes Grid */
    .presets-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .preset-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .preset-card:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
    }

    .preset-colors {
        display: flex;
        gap: 4px;
        margin-bottom: 10px;
    }

    .preset-color {
        width: 24px;
        height: 24px;
        border-radius: 6px;
    }

    .preset-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .preset-desc {
        font-size: 11px;
        color: var(--text-muted);
    }

    /* Center - Preview */
    .panel-center {
        background: var(--bg-secondary);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .preview-header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--bg-primary);
    }

    .preview-title {
        font-size: 14px;
        font-weight: 600;
    }

    .preview-actions {
        display: flex;
        gap: 8px;
    }

    .preview-container {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
    }

    .preview-frame {
        background: var(--preview-bg-secondary, #181825);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    /* Preview Components */
    .preview-topbar {
        height: 50px;
        background: var(--preview-bg-primary, #1e1e2e);
        border-bottom: 1px solid var(--preview-border, #313244);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
    }

    .preview-topbar-title {
        font-weight: 600;
        color: var(--preview-text-primary, #cdd6f4);
    }

    .preview-btn {
        padding: 6px 14px;
        font-size: 13px;
        font-weight: 500;
        border-radius: 6px;
        border: none;
        cursor: pointer;
    }

    .preview-btn-primary {
        background: var(--preview-accent, #89b4fa);
        color: #000;
    }

    .preview-content {
        padding: 24px;
    }

    .preview-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }

    .preview-stat {
        background: var(--preview-bg-primary, #1e1e2e);
        border: 1px solid var(--preview-border, #313244);
        border-radius: 10px;
        padding: 16px;
    }

    .preview-stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--preview-text-primary, #cdd6f4);
    }

    .preview-stat-label {
        font-size: 13px;
        color: var(--preview-text-muted, #6c7086);
        margin-top: 4px;
    }

    .preview-card {
        background: var(--preview-bg-primary, #1e1e2e);
        border: 1px solid var(--preview-border, #313244);
        border-radius: 10px;
        overflow: hidden;
    }

    .preview-card-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--preview-border, #313244);
        font-weight: 600;
        color: var(--preview-text-primary, #cdd6f4);
    }

    .preview-card-body {
        padding: 20px;
    }

    .preview-table {
        width: 100%;
        border-collapse: collapse;
    }

    .preview-table th {
        text-align: left;
        padding: 10px 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--preview-text-muted, #6c7086);
        background: var(--preview-bg-tertiary, #313244);
    }

    .preview-table td {
        padding: 12px;
        border-bottom: 1px solid var(--preview-border, #313244);
        color: var(--preview-text-secondary, #a6adc8);
    }

    .preview-badge {
        display: inline-block;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 20px;
    }

    .preview-badge-success {
        background: rgba(166, 227, 161, 0.2);
        color: var(--preview-success, #a6e3a1);
    }

    .preview-badge-warning {
        background: rgba(249, 226, 175, 0.2);
        color: var(--preview-warning, #f9e2af);
    }

    /* Right Panel - Saved Themes */
    .panel-right {
        background: var(--bg-primary);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .saved-themes-list {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .saved-theme-item {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 14px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .saved-theme-item:hover {
        border-color: var(--accent);
    }

    .saved-theme-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .saved-theme-name {
        font-weight: 600;
        color: var(--text-primary);
    }

    .saved-theme-date {
        font-size: 11px;
        color: var(--text-muted);
    }

    .saved-theme-colors {
        display: flex;
        gap: 4px;
    }

    .saved-theme-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }

    .saved-theme-actions {
        display: flex;
        gap: 6px;
        margin-top: 10px;
    }

    /* Loading */
    .loading {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Toast */
    .toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1000;
    }

    .toast {
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 14px 20px;
        margin-top: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease;
    }

    .toast.success { border-left: 3px solid var(--success); }
    .toast.error { border-left: 3px solid var(--danger); }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Back button */
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 13px;
        margin-bottom: 16px;
        transition: color 0.2s;
    }

    .back-link:hover {
        color: var(--accent);
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .builder-layout {
            grid-template-columns: 300px 1fr;
        }
        .panel-right {
            display: none;
        }
    }

    @media (max-width: 768px) {
        .builder-layout {
            grid-template-columns: 1fr;
        }
        .panel-left {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 300px;
            z-index: 100;
            transform: translateX(-100%);
            transition: transform 0.3s;
        }
        .panel-left.open {
            transform: translateX(0);
        }
    }
    </style>
</head>
<body>
<?php require_once CMS_ROOT . '/admin/includes/topbar_nav.php'; ?>

    <div class="builder-layout">
        <!-- Left Panel - Controls -->
        <div class="panel-left">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-title-icon">üé®</span>
                    Theme Builder
                </div>
            </div>
            
            <div class="panel-body">
                <a href="/admin" class="back-link">
                    ‚Üê Back to Dashboard
                </a>
                
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" data-tab="colors">Colors</button>
                    <button class="tab" data-tab="presets">Presets</button>
                    <button class="tab" data-tab="ai">AI ‚ú®</button>
                </div>
                
                <!-- Colors Tab -->
                <div class="tab-content active" id="tab-colors">
                    <div class="section">
                        <div class="section-title">Background Colors</div>
                        
                        <div class="color-row">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="color-bgPrimary" value="#1e1e2e" data-color="bgPrimary">
                                <div class="color-preview" id="preview-bgPrimary" style="background: #1e1e2e;"></div>
                            </div>
                            <div class="color-info">
                                <div class="color-label">Primary Background</div>
                                <div class="color-value" id="value-bgPrimary">#1e1e2e</div>
                            </div>
                        </div>
                        
                        <div class="color-row">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="color-bgSecondary" value="#181825" data-color="bgSecondary">
                                <div class="color-preview" id="preview-bgSecondary" style="background: #181825;"></div>
                            </div>
                            <div class="color-info">
                                <div class="color-label">Secondary Background</div>
                                <div class="color-value" id="value-bgSecondary">#181825</div>
                            </div>
                        </div>
                        
                        <div class="color-row">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="color-bgTertiary" value="#313244" data-color="bgTertiary">
                                <div class="color-preview" id="preview-bgTertiary" style="background: #313244;"></div>
                            </div>
                            <div class="color-info">
                                <div class="color-label">Tertiary Background</div>
                                <div class="color-value" id="value-bgTertiary">#313244</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Text Colors</div>
                        
                        <div class="color-row">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="color-textPrimary" value="#cdd6f4" data-color="textPrimary">
                                <div class="color-preview" id="preview-textPrimary" style="background: #cdd6f4;"></div>
                            </div>
                            <div class="color-info">
                                <div class="color-label">Primary Text</div>
                                <div class="color-value" id="value-textPrimary">#cdd6f4</div>
                            </div>
                        </div>
                        
                        <div class="color-row">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="color-textSecondary" value="#a6adc8" data-color="textSecondary">
                                <div class="color-preview" id="preview-textSecondary" style="background: #a6adc8;"></div>
                            </div>
                            <div class="color-info">
                                <div class="color-label">Secondary Text</div>
                                <div class="color-value" id="value-textSecondary">#a6adc8</div>
                            </div>
                        </div>
                        
                        <div class="color-row">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="color-textMuted" value="#6c7086" data-color="textMuted">
                                <div class="color-preview" id="preview-textMuted" style="background: #6c7086;"></div>
                            </div>
                            <div class="color-info">
                                <div class="color-label">Muted Text</div>
                                <div class="color-value" id="value-textMuted">#6c7086</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Accent & Status Colors</div>
                        
                        <div class="color-row">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="color-accent" value="#89b4fa" data-color="accent">
                                <div class="color-preview" id="preview-accent" style="background: #89b4fa;"></div>
                            </div>
                            <div class="color-info">
                                <div class="color-label">Accent Color</div>
                                <div class="color-value" id="value-accent">#89b4fa</div>
                            </div>
                        </div>
                        
                        <div class="color-row">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="color-success" value="#a6e3a1" data-color="success">
                                <div class="color-preview" id="preview-success" style="background: #a6e3a1;"></div>
                            </div>
                            <div class="color-info">
                                <div class="color-label">Success</div>
                                <div class="color-value" id="value-success">#a6e3a1</div>
                            </div>
                        </div>
                        
                        <div class="color-row">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="color-warning" value="#f9e2af" data-color="warning">
                                <div class="color-preview" id="preview-warning" style="background: #f9e2af;"></div>
                            </div>
                            <div class="color-info">
                                <div class="color-label">Warning</div>
                                <div class="color-value" id="value-warning">#f9e2af</div>
                            </div>
                        </div>
                        
                        <div class="color-row">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="color-danger" value="#f38ba8" data-color="danger">
                                <div class="color-preview" id="preview-danger" style="background: #f38ba8;"></div>
                            </div>
                            <div class="color-info">
                                <div class="color-label">Danger</div>
                                <div class="color-value" id="value-danger">#f38ba8</div>
                            </div>
                        </div>
                        
                        <div class="color-row">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="color-border" value="#313244" data-color="border">
                                <div class="color-preview" id="preview-border" style="background: #313244;"></div>
                            </div>
                            <div class="color-info">
                                <div class="color-label">Border</div>
                                <div class="color-value" id="value-border">#313244</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Presets Tab -->
                <div class="tab-content" id="tab-presets">
                    <div class="section">
                        <div class="section-title">Ready-to-use Themes</div>
                        <div class="presets-grid">
                            <?php foreach ($presetThemes as $i => $preset): ?>
                            <div class="preset-card" data-preset="<?= $i ?>">
                                <div class="preset-colors">
                                    <div class="preset-color" style="background: <?= $preset['colors']['bgPrimary'] ?>"></div>
                                    <div class="preset-color" style="background: <?= $preset['colors']['accent'] ?>"></div>
                                    <div class="preset-color" style="background: <?= $preset['colors']['success'] ?>"></div>
                                    <div class="preset-color" style="background: <?= $preset['colors']['textPrimary'] ?>"></div>
                                </div>
                                <div class="preset-name"><?= htmlspecialchars($preset['name']) ?></div>
                                <div class="preset-desc"><?= htmlspecialchars($preset['description']) ?></div>
                            </div>
                            <?php endforeach; ?>
                        </div>
                    </div>
                </div>
                
                <!-- AI Tab -->
                <div class="tab-content" id="tab-ai">
                    <div class="ai-section">
                        <div class="ai-section-title">
                            <span>‚ú®</span>
                            AI Palette Generator
                        </div>
                        <div class="form-group">
                            <label class="form-label">Describe your ideal theme</label>
                            <textarea class="form-textarea" id="ai-prompt" placeholder="e.g., A modern dark theme with blue accents, inspired by VS Code. Professional and easy on the eyes for long coding sessions..."></textarea>
                        </div>
                        <button class="btn btn-primary btn-block" id="generate-ai-btn" <?= !$aiConfigured ? 'disabled' : '' ?>>
                            <span class="btn-text">üé® Generate Palette</span>
                            <span class="btn-loading" style="display:none;"><span class="spinner"></span> Generating...</span>
                        </button>
                        <?php if (!$aiConfigured): ?>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 10px;">
                            ‚ö†Ô∏è Configure OpenAI API key in <a href="/admin/ai-settings.php" style="color: var(--accent);">AI Settings</a> to enable this feature.
                        </p>
                        <?php endif; ?>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Quick Suggestions</div>
                        <div class="btn-group" style="flex-wrap: wrap;">
                            <button class="btn btn-secondary btn-sm ai-suggestion" data-prompt="Dark theme with purple and pink accents, gaming inspired">üéÆ Gaming</button>
                            <button class="btn btn-secondary btn-sm ai-suggestion" data-prompt="Clean minimal dark theme with blue accents, professional SaaS style">üíº SaaS</button>
                            <button class="btn btn-secondary btn-sm ai-suggestion" data-prompt="Warm cozy dark theme with orange and brown tones, like a coffee shop">‚òï Cozy</button>
                            <button class="btn btn-secondary btn-sm ai-suggestion" data-prompt="Cyberpunk neon theme with cyan and magenta on dark background">üåÉ Cyber</button>
                            <button class="btn btn-secondary btn-sm ai-suggestion" data-prompt="Nature inspired theme with green and earth tones">üåø Nature</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Center - Preview -->
        <div class="panel-center">
            <div class="preview-header">
                <div class="preview-title">Live Preview</div>
                <div class="preview-actions">
                    <button class="btn btn-secondary btn-sm" id="reset-btn">‚Ü∫ Reset</button>
                    <button class="btn btn-primary btn-sm" id="save-btn">üíæ Save Theme</button>
                </div>
            </div>
            
            <div class="preview-container">
                <div class="preview-frame" id="preview-frame">
                    <div class="preview-topbar">
                        <div class="preview-topbar-title">Dashboard</div>
                        <button class="preview-btn preview-btn-primary">+ New</button>
                    </div>
                    <div class="preview-content">
                        <div class="preview-stats">
                            <div class="preview-stat">
                                <div class="preview-stat-value"><?= number_format($totalPages) ?></div>
                                <div class="preview-stat-label">Total Pages</div>
                            </div>
                            <div class="preview-stat">
                                <div class="preview-stat-value"><?= number_format($totalArticles) ?></div>
                                <div class="preview-stat-label">Articles</div>
                            </div>
                            <div class="preview-stat">
                                <div class="preview-stat-value"><?= number_format($totalUsers) ?></div>
                                <div class="preview-stat-label">Admins</div>
                            </div>
                        </div>
                        
                        <div class="preview-card">
                            <div class="preview-card-header">Recent Content</div>
                            <div class="preview-card-body" style="padding: 0;">
                                <table class="preview-table">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php if (empty($recentContent)): ?>
                                        <tr>
                                            <td colspan="3" style="text-align: center; color: var(--text-muted);">No articles yet</td>
                                        </tr>
                                        <?php else: ?>
                                        <?php foreach ($recentContent as $article): ?>
                                        <tr>
                                            <td><?= htmlspecialchars($article['title']) ?></td>
                                            <td><span class="preview-badge preview-badge-<?= $article['status'] === 'published' ? 'success' : 'warning' ?>"><?= ucfirst($article['status']) ?></span></td>
                                            <td><?= date('M j, Y', strtotime($article['created_at'])) ?></td>
                                        </tr>
                                        <?php endforeach; ?>
                                        <?php endif; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel - Saved Themes -->
        <div class="panel-right">
            <div class="panel-header">
                <div class="panel-title">Saved Themes</div>
            </div>
            <div class="saved-themes-list" id="saved-themes-list">
                <?php if (empty($savedThemes)): ?>
                <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                    <div style="font-size: 32px; margin-bottom: 10px;">üìÅ</div>
                    <div>No saved themes yet</div>
                    <div style="font-size: 12px; margin-top: 4px;">Create and save your first theme!</div>
                </div>
                <?php else: ?>
                <?php foreach ($savedThemes as $theme): ?>
                <div class="saved-theme-item" data-theme='<?= htmlspecialchars(json_encode($theme)) ?>'>
                    <div class="saved-theme-header">
                        <div class="saved-theme-name"><?= htmlspecialchars($theme['name'] ?? 'Untitled') ?></div>
                        <div class="saved-theme-date"><?= date('M j', strtotime($theme['created'] ?? 'now')) ?></div>
                    </div>
                    <div class="saved-theme-colors">
                        <?php 
                        $colors = $theme['colors'] ?? [];
                        foreach (['bgPrimary', 'accent', 'success', 'textPrimary'] as $key): 
                            if (!empty($colors[$key])):
                        ?>
                        <div class="saved-theme-color" style="background: <?= htmlspecialchars($colors[$key]) ?>"></div>
                        <?php endif; endforeach; ?>
                    </div>
                    <div class="saved-theme-actions">
                        <button class="btn btn-secondary btn-sm load-theme-btn">Load</button>
                        <button class="btn btn-primary btn-sm apply-theme-btn">Apply</button>
                        <button class="btn btn-danger btn-sm delete-theme-btn" data-filename="<?= htmlspecialchars($theme['filename'] ?? '') ?>">üóë</button>
                    </div>
                </div>
                <?php endforeach; ?>
                <?php endif; ?>
            </div>
        </div>
    </div>
    
    <div class="toast-container" id="toast-container"></div>
    
    <script>
    const csrfToken = '<?= csrf_token() ?>';
    const presetThemes = <?= json_encode($presetThemes) ?>;
    
    // Current theme state
    let currentTheme = {
        colors: {
            bgPrimary: '#1e1e2e',
            bgSecondary: '#181825',
            bgTertiary: '#313244',
            textPrimary: '#cdd6f4',
            textSecondary: '#a6adc8',
            textMuted: '#6c7086',
            accent: '#89b4fa',
            accentHover: '#b4befe',
            success: '#a6e3a1',
            warning: '#f9e2af',
            danger: '#f38ba8',
            border: '#313244'
        }
    };
    
    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        });
    });
    
    // Color pickers
    document.querySelectorAll('.color-input').forEach(input => {
        input.addEventListener('input', (e) => {
            const color = e.target.value;
            const key = e.target.dataset.color;
            
            currentTheme.colors[key] = color;
            document.getElementById('preview-' + key).style.background = color;
            document.getElementById('value-' + key).textContent = color;
            
            updatePreview();
        });
        
        // Click on preview to open picker
        const preview = document.getElementById('preview-' + input.dataset.color);
        if (preview) {
            preview.addEventListener('click', () => input.click());
        }
    });
    
    // Update preview
    function updatePreview() {
        const frame = document.getElementById('preview-frame');
        const c = currentTheme.colors;
        
        frame.style.setProperty('--preview-bg-primary', c.bgPrimary);
        frame.style.setProperty('--preview-bg-secondary', c.bgSecondary);
        frame.style.setProperty('--preview-bg-tertiary', c.bgTertiary);
        frame.style.setProperty('--preview-text-primary', c.textPrimary);
        frame.style.setProperty('--preview-text-secondary', c.textSecondary);
        frame.style.setProperty('--preview-text-muted', c.textMuted);
        frame.style.setProperty('--preview-accent', c.accent);
        frame.style.setProperty('--preview-success', c.success);
        frame.style.setProperty('--preview-warning', c.warning);
        frame.style.setProperty('--preview-danger', c.danger);
        frame.style.setProperty('--preview-border', c.border);
        
        frame.style.background = c.bgSecondary;
    }
    
    // Apply colors to UI
    function applyColors(colors) {
        currentTheme.colors = { ...currentTheme.colors, ...colors };
        
        Object.keys(colors).forEach(key => {
            const input = document.getElementById('color-' + key);
            const preview = document.getElementById('preview-' + key);
            const value = document.getElementById('value-' + key);
            
            if (input) input.value = colors[key];
            if (preview) preview.style.background = colors[key];
            if (value) value.textContent = colors[key];
        });
        
        updatePreview();
    }
    
    // Preset themes
    document.querySelectorAll('.preset-card').forEach(card => {
        card.addEventListener('click', () => {
            const preset = presetThemes[card.dataset.preset];
            if (preset) {
                applyColors(preset.colors);
                showToast('Preset "' + preset.name + '" loaded!', 'success');
            }
        });
    });
    
    // AI Generation
    document.getElementById('generate-ai-btn')?.addEventListener('click', async () => {
        const prompt = document.getElementById('ai-prompt').value.trim();
        if (!prompt) {
            showToast('Please enter a description', 'error');
            return;
        }
        
        const btn = document.getElementById('generate-ai-btn');
        btn.querySelector('.btn-text').style.display = 'none';
        btn.querySelector('.btn-loading').style.display = 'inline-flex';
        btn.disabled = true;
        
        try {
            const formData = new FormData();
            formData.append('ajax_action', 'generate_palette');
            formData.append('prompt', prompt);
            formData.append('csrf_token', csrfToken);
            
            const response = await fetch('', { method: 'POST', body: formData });
            const data = await response.json();
            
            if (data.success && data.palette) {
                applyColors(data.palette);
                showToast('AI palette generated!', 'success');
            } else {
                showToast(data.error || 'Failed to generate palette', 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        } finally {
            btn.querySelector('.btn-text').style.display = 'inline';
            btn.querySelector('.btn-loading').style.display = 'none';
            btn.disabled = false;
        }
    });
    
    // AI Suggestions
    document.querySelectorAll('.ai-suggestion').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('ai-prompt').value = btn.dataset.prompt;
            document.getElementById('generate-ai-btn').click();
        });
    });
    
    // Save theme
    document.getElementById('save-btn').addEventListener('click', async () => {
        const name = prompt('Enter theme name:', 'My Custom Theme');
        if (!name) return;
        
        const formData = new FormData();
        formData.append('ajax_action', 'save_theme');
        formData.append('name', name);
        formData.append('theme_data', JSON.stringify(currentTheme));
        formData.append('csrf_token', csrfToken);
        
        try {
            const response = await fetch('', { method: 'POST', body: formData });
            const data = await response.json();
            
            if (data.success) {
                showToast('Theme saved!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    });
    
    // Reset
    document.getElementById('reset-btn').addEventListener('click', () => {
        applyColors({
            bgPrimary: '#1e1e2e',
            bgSecondary: '#181825',
            bgTertiary: '#313244',
            textPrimary: '#cdd6f4',
            textSecondary: '#a6adc8',
            textMuted: '#6c7086',
            accent: '#89b4fa',
            accentHover: '#b4befe',
            success: '#a6e3a1',
            warning: '#f9e2af',
            danger: '#f38ba8',
            border: '#313244'
        });
        showToast('Reset to defaults', 'success');
    });
    
    // Load saved theme
    document.querySelectorAll('.load-theme-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const themeData = JSON.parse(btn.closest('.saved-theme-item').dataset.theme);
            if (themeData.colors) {
                applyColors(themeData.colors);
                showToast('Theme loaded!', 'success');
            }
        });
    });
    
    // Apply theme
    document.querySelectorAll('.apply-theme-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const themeData = JSON.parse(btn.closest('.saved-theme-item').dataset.theme);
            
            const formData = new FormData();
            formData.append('ajax_action', 'apply_theme');
            formData.append('theme_data', JSON.stringify(themeData));
            formData.append('csrf_token', csrfToken);
            
            try {
                const response = await fetch('', { method: 'POST', body: formData });
                const data = await response.json();
                
                if (data.success) {
                    showToast('Theme applied to CMS!', 'success');
                } else {
                    showToast(data.error || 'Failed to apply', 'error');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        });
    });
    
    // Delete theme
    document.querySelectorAll('.delete-theme-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (!confirm('Delete this theme?')) return;
            
            const formData = new FormData();
            formData.append('ajax_action', 'delete_theme');
            formData.append('filename', btn.dataset.filename);
            formData.append('csrf_token', csrfToken);
            
            try {
                const response = await fetch('', { method: 'POST', body: formData });
                const data = await response.json();
                
                if (data.success) {
                    btn.closest('.saved-theme-item').remove();
                    showToast('Theme deleted', 'success');
                } else {
                    showToast(data.error || 'Failed to delete', 'error');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        });
    });
    
    // Toast
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : '‚úó'}</span><span>${message}</span>`;
        container.appendChild(toast);
        
        setTimeout(() => toast.remove(), 3000);
    }
    
    // Initialize preview
    updatePreview();
    </script>
</body>
</html>
