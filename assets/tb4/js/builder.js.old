/**
 * TB4 Visual Builder - Main Application
 *
 * Vanilla JavaScript ES6+ page builder
 * No frameworks, no jQuery, no transpilation needed
 *
 * @version 1.0.0
 */

// Debug logging for builder initialization
console.log('[TB4] builder.js loaded');
console.log('[TB4] TB4 config:', window.TB4);

const TB4Builder = {
    // ==========================================================================
    // STATE MANAGEMENT
    // ==========================================================================

    state: {
        content: {
            sections: []
        },
        selected: null,
        selectedType: null, // 'section', 'row', 'column', 'module'
        device: 'desktop',
        zoom: 100,
        history: [],
        historyIndex: -1,
        maxHistory: 50,
        isDirty: false,
        isLoading: false,
        autoSaveTimer: null,
        autoSaveInterval: 60000, // 60 seconds
        pendingRowSectionId: null,
        pendingChangeLayoutRowId: null
    },

    // ==========================================================================
    // CONFIGURATION
    // ==========================================================================

    config: {
        apiUrl: '',
        csrfToken: '',
        pageId: null,
        contentType: 'page',
        modules: {}
    },

    // ==========================================================================
    // DOM REFERENCES
    // ==========================================================================

    dom: {
        canvas: null,
        sidebar: null,
        settingsPanel: null,
        toolbar: null,
        moduleList: null,
        deviceButtons: null,
        zoomDisplay: null
    },

    // ==========================================================================
    // INITIALIZATION
    // ==========================================================================

    /**
     * Initialize the builder
     */
    init() {
        console.log('[TB4] init() called');

        // Load config from global TB4 object
        if (window.TB4) {
            this.config.apiUrl = window.TB4.apiUrl || '';
            this.config.csrfToken = window.TB4.csrfToken || '';
            this.config.pageId = window.TB4.pageId || null;
            this.config.contentType = window.TB4.contentType || 'page';
            this.config.modules = window.TB4.modules || {};
            console.log('[TB4] Config loaded:', this.config);
        } else {
            console.error('[TB4] window.TB4 not found!');
        }

        // Cache DOM elements
        this.cacheDom();

        // Initialize subsystems
        this.initCanvas();
        this.initSidebar();
        this.initToolbar();
        this.initSettingsPanel();
        this.initDragDrop();
        this.initKeyboardShortcuts();
        this.initLayoutPicker();

        // Load existing content if available (check both 'content' and 'initialContent' for compatibility)
        if (window.TB4) {
            const contentData = window.TB4.content || window.TB4.initialContent;
            if (contentData && (contentData.sections || Array.isArray(contentData))) {
                console.log('[TB4] Loading content from window.TB4:', contentData);
                this.loadContent(contentData);
            }
        }

        // Start auto-save
        this.startAutoSave();

        // Dispatch ready event
        document.dispatchEvent(new CustomEvent('tb4:ready', { detail: this }));

        console.log('[TB4] Builder initialized successfully');
    },

    /**
     * Cache DOM element references
     */
    cacheDom() {
        this.dom.canvas = document.getElementById('tb4-canvas');
        this.dom.sidebar = document.getElementById('tb4-sidebar');
        this.dom.settingsPanel = document.getElementById('tb4-settings-panel');
        this.dom.toolbar = document.getElementById('tb4-toolbar');
        this.dom.moduleList = document.getElementById('tb4-module-list');
        this.dom.deviceButtons = document.querySelectorAll('[data-device]');
        this.dom.zoomDisplay = document.getElementById('tb4-zoom-display');

        // Debug: Log found elements
        console.log('[TB4] DOM elements cached:', {
            canvas: !!this.dom.canvas,
            sidebar: !!this.dom.sidebar,
            settingsPanel: !!this.dom.settingsPanel,
            toolbar: !!this.dom.toolbar,
            moduleList: !!this.dom.moduleList,
            deviceButtons: this.dom.deviceButtons.length,
            zoomDisplay: !!this.dom.zoomDisplay
        });
    },

    // ==========================================================================
    // CANVAS MANAGEMENT
    // ==========================================================================

    /**
     * Initialize the canvas
     */
    initCanvas() {
        if (!this.dom.canvas) return;

        // Click handler for selection
        this.dom.canvas.addEventListener('click', (e) => {
            const element = e.target.closest('[data-tb4-id]');
            if (element) {
                e.stopPropagation();
                this.selectElement(element.dataset.tb4Id, element.dataset.tb4Type);
            } else {
                this.deselectAll();
            }
        });

        // Double-click for inline editing
        this.dom.canvas.addEventListener('dblclick', (e) => {
            const module = e.target.closest('[data-tb4-type="module"]');
            if (module) {
                this.enableInlineEdit(module);
            }
        });
    },

    /**
     * Render the canvas content
     */
    renderCanvas() {
        if (!this.dom.canvas) return;

        const content = this.state.content;
        let html = '';

        if (content.sections && content.sections.length > 0) {
            content.sections.forEach(section => {
                html += this.renderSection(section);
            });
        }

        // Add empty state if no content
        if (!html) {
            html = this.renderEmptyState();
        }

        this.dom.canvas.innerHTML = html;

        // Re-initialize drag targets
        this.initCanvasDropZones();

        // Re-select if something was selected
        if (this.state.selected) {
            const el = this.dom.canvas.querySelector(`[data-tb4-id="${this.state.selected}"]`);
            if (el) {
                el.classList.add('tb4-selected');
            }
        }
    },

    /**
     * Render empty canvas state
     */
    renderEmptyState() {
        return `
            <div class="tb4-empty-state" data-drop-zone="section">
                <div class="tb4-empty-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <line x1="12" y1="8" x2="12" y2="16"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                    </svg>
                </div>
                <p>Drag a section here to start building</p>
                <button type="button" class="tb4-btn tb4-btn-primary" onclick="TB4Builder.addSection()">
                    Add Section
                </button>
            </div>
        `;
    },

    /**
     * Render a section
     */
    renderSection(section) {
        const styles = this.buildInlineStyles(section.settings || {});
        const classes = ['tb4-section'];

        if (section.settings?.cssClass) {
            classes.push(section.settings.cssClass);
        }

        let rowsHtml = '';
        if (section.rows && section.rows.length > 0) {
            section.rows.forEach(row => {
                rowsHtml += this.renderRow(row);
            });
        } else {
            rowsHtml = `<div class="tb4-add-row" data-drop-zone="row" data-section-id="${section.id}">
                <span>+ Add Row</span>
            </div>`;
        }

        return `
            <div class="${classes.join(' ')}"
                 data-tb4-id="${section.id}"
                 data-tb4-type="section"
                 style="${styles}">
                <div class="tb4-element-actions">
                    <button type="button" class="tb4-action-btn" onclick="TB4Builder.moveElement('${section.id}', 'up')" title="Move Up">‚Üë</button>
                    <button type="button" class="tb4-action-btn" onclick="TB4Builder.moveElement('${section.id}', 'down')" title="Move Down">‚Üì</button>
                    <button type="button" class="tb4-action-btn" onclick="TB4Builder.duplicateElement('${section.id}')" title="Duplicate">‚ßâ</button>
                    <button type="button" class="tb4-action-btn tb4-action-delete" onclick="TB4Builder.deleteElement('${section.id}')" title="Delete">√ó</button>
                </div>
                <div class="tb4-section-inner">
                    ${rowsHtml}
                </div>
                <div class="tb4-add-row-btn" onclick="TB4Builder.showLayoutPicker('${section.id}')">+ Add Row</div>
            </div>
        `;
    },

    /**
     * Render a row
     */
    renderRow(row) {
        const styles = this.buildInlineStyles(row.settings || {});
        const classes = ['tb4-row'];
        const layout = row.layout || '1';

        classes.push(`tb4-row-${layout.replace(/\//g, '-')}`);

        let columnsHtml = '';
        if (row.columns && row.columns.length > 0) {
            row.columns.forEach(column => {
                columnsHtml += this.renderColumn(column);
            });
        }

        return `
            <div class="${classes.join(' ')}"
                 data-tb4-id="${row.id}"
                 data-tb4-type="row"
                 data-layout="${layout}"
                 style="${styles}">
                <div class="tb4-element-actions">
                    <button type="button" class="tb4-action-btn" onclick="TB4Builder.changeRowLayout('${row.id}')" title="Change Layout">‚äû</button>
                    <button type="button" class="tb4-action-btn" onclick="TB4Builder.moveElement('${row.id}', 'up')" title="Move Up">‚Üë</button>
                    <button type="button" class="tb4-action-btn" onclick="TB4Builder.moveElement('${row.id}', 'down')" title="Move Down">‚Üì</button>
                    <button type="button" class="tb4-action-btn" onclick="TB4Builder.duplicateElement('${row.id}')" title="Duplicate">‚ßâ</button>
                    <button type="button" class="tb4-action-btn tb4-action-delete" onclick="TB4Builder.deleteElement('${row.id}')" title="Delete">√ó</button>
                </div>
                <div class="tb4-row-inner">
                    ${columnsHtml}
                </div>
            </div>
        `;
    },

    /**
     * Render a column
     */
    renderColumn(column) {
        const styles = this.buildInlineStyles(column.settings || {});
        const classes = ['tb4-column'];
        const width = column.width || 100;

        let modulesHtml = '';
        if (column.modules && column.modules.length > 0) {
            column.modules.forEach(module => {
                modulesHtml += this.renderModule(module);
            });
        } else {
            modulesHtml = `<div class="tb4-module-placeholder" data-drop-zone="module" data-column-id="${column.id}">
                <span>Drop module here</span>
            </div>`;
        }

        return `
            <div class="${classes.join(' ')}"
                 data-tb4-id="${column.id}"
                 data-tb4-type="column"
                 style="width: ${width}%; ${styles}">
                <div class="tb4-column-inner" data-drop-zone="module" data-column-id="${column.id}">
                    ${modulesHtml}
                </div>
            </div>
        `;
    },

    /**
     * Render a module
     */
    renderModule(module) {
        const styles = this.buildInlineStyles(module.settings || {});
        // Normalize module type - remove tb4_ prefix if present
        const moduleType = (module.type || '').replace(/^tb4_/, '');
        const classes = ['tb4-module', `tb4-module-${moduleType}`];

        if (module.settings?.cssClass) {
            classes.push(module.settings.cssClass);
        }

        const moduleConfig = this.config.modules[moduleType] || {};
        const content = this.renderModuleContent(module);

        return `
            <div class="${classes.join(' ')}"
                 data-tb4-id="${module.id}"
                 data-tb4-type="module"
                 data-module-type="${module.type}"
                 style="${styles}">
                <div class="tb4-element-actions">
                    <span class="tb4-module-label">${moduleConfig.name || module.type}</span>
                    <button type="button" class="tb4-action-btn" onclick="TB4Builder.moveElement('${module.id}', 'up')" title="Move Up">‚Üë</button>
                    <button type="button" class="tb4-action-btn" onclick="TB4Builder.moveElement('${module.id}', 'down')" title="Move Down">‚Üì</button>
                    <button type="button" class="tb4-action-btn" onclick="TB4Builder.duplicateElement('${module.id}')" title="Duplicate">‚ßâ</button>
                    <button type="button" class="tb4-action-btn tb4-action-delete" onclick="TB4Builder.deleteElement('${module.id}')" title="Delete">√ó</button>
                </div>
                <div class="tb4-module-content">
                    ${content}
                </div>
            </div>
        `;
    },

    /**
     * Render module content based on type
     */
    renderModuleContent(module) {
        const data = module.content || {};
        // Normalize module type - remove tb4_ prefix if present
        const moduleType = (module.type || '').replace(/^tb4_/, '');

        switch (moduleType) {
            case 'text':
                return `<div class="tb4-text-content">${data.text || '<p>Click to edit text...</p>'}</div>`;

            case 'heading':
                const tag = data.tag || 'h2';
                return `<${tag} class="tb4-heading">${data.text || 'Heading'}</${tag}>`;

            case 'image':
                if (data.src) {
                    return `<img src="${this.escapeHtml(data.src)}" alt="${this.escapeHtml(data.alt || '')}" class="tb4-image"/>`;
                }
                return `<div class="tb4-image-placeholder">Click to add image</div>`;

            case 'button':
                const btnStyle = data.style || 'primary';
                return `<a href="${this.escapeHtml(data.url || '#')}" class="tb4-button tb4-button-${btnStyle}">${data.text || 'Button'}</a>`;

            case 'video':
                if (data.url) {
                    return `<div class="tb4-video-wrapper">${this.renderVideoEmbed(data.url)}</div>`;
                }
                return `<div class="tb4-video-placeholder">Click to add video</div>`;

            case 'divider':
                const divStyle = data.style || 'solid';
                return `<hr class="tb4-divider tb4-divider-${divStyle}"/>`;

            case 'spacer':
                const height = data.height || 50;
                return `<div class="tb4-spacer" style="height: ${height}px;"></div>`;

            case 'html':
                return `<div class="tb4-html-content">${data.html || '<!-- Custom HTML -->'}</div>`;

            case 'gallery':
                return this.renderGalleryContent(data);

            case 'accordion':
                return this.renderAccordionContent(data);

            case 'tabs':
                return this.renderTabsContent(data);

            case 'icon':
                const iconName = data.icon_name || 'star';
                // Handle icon_size with or without px suffix
                let iconSize = data.icon_size || '48';
                if (typeof iconSize === 'string' && iconSize.endsWith('px')) {
                    iconSize = iconSize.replace('px', '');
                }
                const iconColor = data.icon_color || '#6b7280';
                const iconPath = this.getIconSvgPath(iconName);
                console.log('[TB4] Icon render:', { iconName, iconSize, iconColor, hasPath: !!iconPath });
                return `<div class="tb4-icon-preview" style="text-align:center;padding:20px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="${iconSize}" height="${iconSize}" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        ${iconPath}
                    </svg>
                </div>`;

            case 'list':
                return this.renderListContent(data);

            case 'quote':
                return `<blockquote class="tb4-quote">
                    <p>${data.text || 'Quote text...'}</p>
                    ${data.author ? `<cite>‚Äî ${this.escapeHtml(data.author)}</cite>` : ''}
                </blockquote>`;

            case 'map':
                return `<div class="tb4-map-placeholder">Map: ${this.escapeHtml(data.address || 'No address set')}</div>`;

            case 'form':
                return `<div class="tb4-form-placeholder">Form: ${this.escapeHtml(data.formId || 'No form selected')}</div>`;

            case 'cta':
                return `<div class="tb4-cta">
                    <h3 class="tb4-cta-title">${this.escapeHtml(data.title || 'Call to Action')}</h3>
                    <p class="tb4-cta-text">${this.escapeHtml(data.text || 'Take action today!')}</p>
                    <a href="${this.escapeHtml(data.button_url || '#')}" class="tb4-cta-button">${this.escapeHtml(data.button_text || 'Learn More')}</a>
                </div>`;

            case 'testimonial':
                return `<div class="tb4-testimonial">
                    <blockquote class="tb4-testimonial-quote">${this.escapeHtml(data.quote || 'Customer testimonial...')}</blockquote>
                    <div class="tb4-testimonial-author">
                        <span class="tb4-testimonial-name">${this.escapeHtml(data.author_name || 'Customer Name')}</span>
                        ${data.author_title ? `<span class="tb4-testimonial-title">${this.escapeHtml(data.author_title)}</span>` : ''}
                    </div>
                </div>`;

            case 'audio':
                if (data.src || data.audio_url) {
                    return `<div class="tb4-audio">
                        <audio controls src="${this.escapeHtml(data.src || data.audio_url)}"></audio>
                        ${data.title ? `<p class="tb4-audio-title">${this.escapeHtml(data.title)}</p>` : ''}
                    </div>`;
                }
                return '<div class="tb4-audio-placeholder">Click to add audio</div>';

            case 'social':
                return `<div class="tb4-social">
                    <div class="tb4-social-icons">
                        ${data.facebook ? '<span class="tb4-social-icon">üìò</span>' : ''}
                        ${data.twitter ? '<span class="tb4-social-icon">üê¶</span>' : ''}
                        ${data.instagram ? '<span class="tb4-social-icon">üì∑</span>' : ''}
                        ${data.linkedin ? '<span class="tb4-social-icon">üíº</span>' : ''}
                        ${data.youtube ? '<span class="tb4-social-icon">‚ñ∂Ô∏è</span>' : ''}
                    </div>
                    ${(!data.facebook && !data.twitter && !data.instagram && !data.linkedin && !data.youtube) ? '<span>Social Links (configure in settings)</span>' : ''}
                </div>`;

            case 'hero':
                return `<div class="tb4-hero" style="padding:40px 20px;text-align:center;background:#f5f5f5;">
                    <h1 class="tb4-hero-title">${this.escapeHtml(data.title || 'Hero Title')}</h1>
                    <p class="tb4-hero-subtitle">${this.escapeHtml(data.subtitle || 'Hero subtitle text')}</p>
                    ${data.button_text ? `<a href="${this.escapeHtml(data.button_url || '#')}" class="tb4-hero-button">${this.escapeHtml(data.button_text)}</a>` : ''}
                </div>`;

            case 'team':
                return `<div class="tb4-team">
                    <div class="tb4-team-member" style="text-align:center;">
                        ${data.image ? `<img src="${this.escapeHtml(data.image)}" alt="" style="width:100px;height:100px;border-radius:50%;object-fit:cover;">` : '<div style="width:100px;height:100px;border-radius:50%;background:#ddd;margin:0 auto;"></div>'}
                        <h4 class="tb4-team-name">${this.escapeHtml(data.name || 'Team Member')}</h4>
                        <p class="tb4-team-role">${this.escapeHtml(data.role || 'Role / Position')}</p>
                    </div>
                </div>`;

            case 'code':
                return `<div class="tb4-code">
                    <pre style="background:#1e1e1e;color:#d4d4d4;padding:16px;border-radius:4px;overflow-x:auto;"><code>${this.escapeHtml(data.code || '// Your code here')}</code></pre>
                </div>`;

            case 'blurb':
                const blurbIconName = data.icon || 'star';
                const blurbIconColor = data.icon_color || '#6b7280';
                const blurbIconPath = this.getIconSvgPath(blurbIconName);
                return `<div class="tb4-blurb">
                    <div class="tb4-blurb-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="${blurbIconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            ${blurbIconPath}
                        </svg>
                    </div>
                    <h3 class="tb4-blurb-title">${this.escapeHtml(data.title || 'Blurb Title')}</h3>
                    <p class="tb4-blurb-text">${this.escapeHtml(data.text || 'Blurb description text...')}</p>
                </div>`;

            case 'slider_item': {
                let slideHeading = data.heading || 'Slide Title';
                let slideSub = data.subheading || '';
                let slideBg = data.background_color || '#1e3a5f';
                let slideBtn = data.button_text || 'Learn More';
                return '<div class="tb4-slider-item-preview" style="background:' + slideBg + ';">' +
                    '<div class="tb4-slider-item-content">' +
                        '<h3 class="tb4-slider-item-heading">' + this.escapeHtml(slideHeading) + '</h3>' +
                        (slideSub ? '<p class="tb4-slider-item-sub">' + this.escapeHtml(slideSub) + '</p>' : '') +
                        '<span class="tb4-slider-item-btn">' + this.escapeHtml(slideBtn) + '</span>' +
                    '</div>' +
                '</div>';
            }

            // Login module
            case 'login':
                return `<div class="tb4-login-preview" style="padding:20px;background:#f9fafb;border-radius:8px;">
                    <div class="tb4-login-form" style="display:flex;flex-direction:column;gap:10px;max-width:300px;margin:0 auto;">
                        <input type="text" placeholder="Username" disabled style="padding:8px;border:1px solid #d1d5db;border-radius:4px;"/>
                        <input type="password" placeholder="Password" disabled style="padding:8px;border:1px solid #d1d5db;border-radius:4px;"/>
                        <button type="button" style="padding:10px;background:#3b82f6;color:white;border:none;border-radius:4px;cursor:pointer;">Login</button>
                    </div>
                </div>`;

            // Search module
            case 'search':
                return `<div class="tb4-search-preview" style="display:flex;gap:8px;padding:10px;">
                    <input type="text" placeholder="${this.escapeHtml(data.placeholder || 'Search...')}" disabled style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:4px;"/>
                    <button type="button" style="padding:8px 16px;background:#3b82f6;color:white;border:none;border-radius:4px;">üîç</button>
                </div>`;

            // Signup module
            case 'signup':
                return `<div class="tb4-signup-preview" style="display:flex;gap:8px;padding:10px;background:#f3f4f6;border-radius:8px;">
                    <input type="email" placeholder="Enter your email" disabled style="flex:1;padding:10px;border:1px solid #d1d5db;border-radius:4px;"/>
                    <button type="button" style="padding:10px 20px;background:#10b981;color:white;border:none;border-radius:4px;">${this.escapeHtml(data.button_text || 'Subscribe')}</button>
                </div>`;

            // Blog module
            case 'blog': {
                let blogPostsCount = parseInt(data.posts_count) || 6;
                let blogLayout = data.layout || 'grid';
                let blogColumns = data.columns || '3';
                let blogShowImage = data.show_image !== 'no';
                let blogShowTitle = data.show_title !== 'no';
                let blogShowExcerpt = data.show_excerpt !== 'no';
                let blogShowDate = data.show_date !== 'no';
                let blogShowAuthor = data.show_author !== 'no';
                let blogShowCategory = data.show_category !== 'no';
                let blogShowReadMore = data.show_read_more !== 'no';
                let blogReadMoreText = data.read_more_text || 'Read More';

                let blogCardBg = data.card_background || '#ffffff';
                let blogCardBorder = data.card_border_color || '#e5e7eb';
                let blogCardRadius = data.card_border_radius || '12px';
                let blogCardShadowVal = data.card_shadow || 'sm';
                let blogGap = data.gap || '24px';
                let blogImageHeight = data.image_height || '200px';
                let blogContentPadding = data.content_padding || '20px';
                let blogTitleColor = data.title_color || '#111827';
                let blogTitleSize = data.title_font_size || '20px';
                let blogExcerptColor = data.excerpt_color || '#6b7280';
                let blogMetaColor = data.meta_color || '#9ca3af';
                let blogCategoryBg = data.category_bg_color || '#2563eb';
                let blogCategoryColor = data.category_text_color || '#ffffff';
                let blogReadMoreColor = data.read_more_color || '#2563eb';

                let blogShadowMap = {
                    'none': 'none',
                    'sm': '0 1px 3px rgba(0,0,0,0.1)',
                    'md': '0 4px 6px rgba(0,0,0,0.1)',
                    'lg': '0 10px 15px rgba(0,0,0,0.1)'
                };
                let blogShadow = blogShadowMap[blogCardShadowVal] || blogShadowMap['sm'];

                let blogSamplePosts = [
                    {title: 'Getting Started with Web Design', excerpt: 'Learn the fundamentals of modern web design and create stunning websites.', category: 'Design', author: 'John Doe', date: 'Jan 5, 2026'},
                    {title: 'Top 10 SEO Tips for 2026', excerpt: 'Discover the latest SEO strategies to improve your website ranking.', category: 'Marketing', author: 'Jane Smith', date: 'Jan 4, 2026'},
                    {title: 'The Future of AI in Business', excerpt: 'Explore how artificial intelligence is transforming businesses.', category: 'Technology', author: 'Mike Johnson', date: 'Jan 3, 2026'},
                    {title: 'Building a Strong Brand', excerpt: 'A guide to creating a memorable brand identity for your business.', category: 'Branding', author: 'Sarah Williams', date: 'Jan 2, 2026'},
                    {title: 'E-commerce Best Practices', excerpt: 'Essential tips for running a successful online store.', category: 'E-commerce', author: 'Tom Brown', date: 'Jan 1, 2026'},
                    {title: 'Social Media Marketing', excerpt: 'Effective strategies to grow your following and increase engagement.', category: 'Marketing', author: 'Lisa Davis', date: 'Dec 31, 2025'}
                ];

                let layoutClass = blogLayout === 'list' ? ' layout-list' : '';
                let gridStyle = blogLayout === 'list' ? 'display:flex;flex-direction:column;' : 'display:grid;grid-template-columns:repeat(' + blogColumns + ',1fr);';

                let blogHtml = '<div class="tb4-blog-preview">';
                blogHtml += '<div class="tb4-blog-grid' + layoutClass + '" style="' + gridStyle + 'gap:' + blogGap + ';">';

                for (let bi = 0; bi < Math.min(blogPostsCount, blogSamplePosts.length); bi++) {
                    let post = blogSamplePosts[bi];
                    let cardStyle = 'background:' + blogCardBg + ';border:1px solid ' + blogCardBorder + ';border-radius:' + blogCardRadius + ';box-shadow:' + blogShadow + ';overflow:hidden;';
                    
                    if (blogLayout === 'list') {
                        cardStyle += 'display:flex;flex-direction:row;';
                    }

                    blogHtml += '<div class="tb4-blog-card" style="' + cardStyle + '">';

                    if (blogShowImage) {
                        let imgStyle = 'width:100%;height:' + blogImageHeight + ';background:linear-gradient(135deg,#e5e7eb 0%,#f3f4f6 100%);display:flex;align-items:center;justify-content:center;color:#9ca3af;position:relative;';
                        if (blogLayout === 'list') {
                            imgStyle = 'width:250px;min-width:250px;height:auto;min-height:180px;background:linear-gradient(135deg,#e5e7eb 0%,#f3f4f6 100%);display:flex;align-items:center;justify-content:center;color:#9ca3af;position:relative;';
                        }
                        blogHtml += '<div class="tb4-blog-image" style="' + imgStyle + '">';
                        blogHtml += '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>';
                        if (blogShowCategory) {
                            blogHtml += '<span style="position:absolute;top:12px;left:12px;background:' + blogCategoryBg + ';color:' + blogCategoryColor + ';padding:4px 10px;border-radius:4px;font-size:11px;font-weight:500;">' + post.category + '</span>';
                        }
                        blogHtml += '</div>';
                    }

                    blogHtml += '<div class="tb4-blog-content" style="padding:' + blogContentPadding + ';flex:1;">';
                    
                    if (blogShowTitle) {
                        blogHtml += '<h3 style="margin:0 0 8px 0;font-size:' + blogTitleSize + ';font-weight:600;color:' + blogTitleColor + ';line-height:1.3;">' + post.title + '</h3>';
                    }
                    
                    if (blogShowDate || blogShowAuthor) {
                        blogHtml += '<div style="display:flex;gap:12px;margin-bottom:10px;font-size:13px;color:' + blogMetaColor + ';">';
                        if (blogShowDate) blogHtml += '<span>' + post.date + '</span>';
                        if (blogShowAuthor) blogHtml += '<span>by ' + post.author + '</span>';
                        blogHtml += '</div>';
                    }
                    
                    if (blogShowExcerpt) {
                        blogHtml += '<p style="margin:0 0 12px 0;font-size:14px;color:' + blogExcerptColor + ';line-height:1.5;">' + post.excerpt + '</p>';
                    }
                    
                    if (blogShowReadMore) {
                        blogHtml += '<a href="#" style="color:' + blogReadMoreColor + ';font-size:14px;font-weight:500;text-decoration:none;">' + blogReadMoreText + ' ‚Üí</a>';
                    }
                    
                    blogHtml += '</div></div>';
                }

                blogHtml += '</div></div>';
                return blogHtml;
            }

            // Portfolio module
            case 'portfolio': {
                let portfolioCount = parseInt(data.items_count) || 6;
                let portfolioColumns = data.columns || '3';
                let portfolioShowTitle = data.show_title !== 'no';
                let portfolioShowCategory = data.show_category !== 'no';
                let portfolioHoverEffect = data.hover_effect || 'fade';
                let portfolioShowFilter = data.show_filter === 'yes';

                let portfolioGap = data.gap || '16px';
                let portfolioRadius = data.item_border_radius || '12px';
                let portfolioOverlay = data.overlay_color || 'rgba(0,0,0,0.7)';
                let portfolioTitleColor = data.title_color || '#ffffff';
                let portfolioTitleSize = data.title_font_size || '18px';
                let portfolioCategoryColor = data.category_color || 'rgba(255,255,255,0.8)';
                let portfolioFilterBg = data.filter_bg_color || '#f3f4f6';
                let portfolioFilterActiveBg = data.filter_active_bg || '#2563eb';
                let portfolioFilterText = data.filter_text_color || '#374151';
                let portfolioFilterActiveText = data.filter_active_text || '#ffffff';

                let portfolioSamples = [
                    {title: 'Brand Identity Design', category: 'Branding', color: '#667eea'},
                    {title: 'E-commerce Website', category: 'Web Design', color: '#f59e0b'},
                    {title: 'Mobile App UI', category: 'UI/UX', color: '#10b981'},
                    {title: 'Marketing Campaign', category: 'Marketing', color: '#ef4444'},
                    {title: 'Product Photography', category: 'Photography', color: '#8b5cf6'},
                    {title: 'Corporate Video', category: 'Video', color: '#06b6d4'},
                    {title: 'Social Media Kit', category: 'Branding', color: '#ec4899'},
                    {title: 'Landing Page', category: 'Web Design', color: '#84cc16'},
                    {title: 'Dashboard Design', category: 'UI/UX', color: '#f97316'}
                ];

                let portfolioHtml = '<div class="tb4-portfolio-preview">';

                if (portfolioShowFilter) {
                    portfolioHtml += '<div class="tb4-portfolio-filter" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:24px;justify-content:center;">';
                    portfolioHtml += '<button style="padding:8px 20px;background:' + portfolioFilterActiveBg + ';border:none;border-radius:6px;font-size:14px;font-weight:500;color:' + portfolioFilterActiveText + ';cursor:pointer;">All</button>';
                    ['Branding', 'Web Design', 'UI/UX'].forEach(function(cat) {
                        portfolioHtml += '<button style="padding:8px 20px;background:' + portfolioFilterBg + ';border:none;border-radius:6px;font-size:14px;font-weight:500;color:' + portfolioFilterText + ';cursor:pointer;">' + cat + '</button>';
                    });
                    portfolioHtml += '</div>';
                }

                portfolioHtml += '<div class="tb4-portfolio-grid" style="display:grid;grid-template-columns:repeat(' + portfolioColumns + ',1fr);gap:' + portfolioGap + ';">';

                for (let pi = 0; pi < Math.min(portfolioCount, portfolioSamples.length); pi++) {
                    let item = portfolioSamples[pi];
                    
                    portfolioHtml += '<div class="tb4-portfolio-item" style="position:relative;overflow:hidden;border-radius:' + portfolioRadius + ';cursor:pointer;aspect-ratio:1/1;">';
                    
                    portfolioHtml += '<div class="tb4-portfolio-image" style="width:100%;height:100%;background:linear-gradient(135deg,' + item.color + ' 0%,' + item.color + '99 100%);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.3);transition:transform 0.4s;">';
                    portfolioHtml += '<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>';
                    portfolioHtml += '</div>';

                    portfolioHtml += '<div class="tb4-portfolio-overlay" style="position:absolute;inset:0;background:' + portfolioOverlay + ';display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;">';
                    
                    portfolioHtml += '<div style="width:48px;height:48px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;margin-bottom:16px;">';
                    portfolioHtml += '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/><path d="M11 8v6M8 11h6"/></svg>';
                    portfolioHtml += '</div>';

                    if (portfolioShowTitle) {
                        portfolioHtml += '<h4 style="font-size:' + portfolioTitleSize + ';font-weight:600;color:' + portfolioTitleColor + ';margin:0 0 4px 0;text-align:center;padding:0 16px;">' + item.title + '</h4>';
                    }
                    if (portfolioShowCategory) {
                        portfolioHtml += '<span style="font-size:12px;color:' + portfolioCategoryColor + ';text-transform:uppercase;letter-spacing:1px;">' + item.category + '</span>';
                    }

                    portfolioHtml += '</div></div>';
                }

                portfolioHtml += '</div></div>';
                portfolioHtml += '<style>.tb4-portfolio-item:hover .tb4-portfolio-overlay{opacity:1!important}.tb4-portfolio-item:hover .tb4-portfolio-image{transform:scale(1.1)}</style>';

                return portfolioHtml;
            }

            // Post Slider module
            case 'post_slider': {
                let psPostsCount = parseInt(data.posts_count) || 4;
                let psVisiblePosts = parseInt(data.visible_posts) || 3;
                let psShowImage = data.show_image !== 'no';
                let psShowTitle = data.show_title !== 'no';
                let psShowExcerpt = data.show_excerpt !== 'no';
                let psShowDate = data.show_date !== 'no';
                let psShowCategory = data.show_category !== 'no';
                let psShowArrows = data.show_arrows !== 'no';
                let psShowDots = data.show_dots !== 'no';

                let psCardBg = data.card_background || '#ffffff';
                let psCardRadius = data.card_border_radius || '12px';
                let psCardShadowVal = data.card_shadow || 'sm';
                let psGap = data.gap || '24px';
                let psImageHeight = data.image_height || '200px';
                let psTitleColor = data.title_color || '#111827';
                let psTitleSize = data.title_font_size || '18px';
                let psExcerptColor = data.excerpt_color || '#6b7280';
                let psMetaColor = data.meta_color || '#9ca3af';
                let psCategoryBg = data.category_bg || '#2563eb';
                let psCategoryColor = data.category_color || '#ffffff';
                let psArrowColor = data.arrow_color || '#374151';
                let psArrowBg = data.arrow_bg || '#ffffff';
                let psDotColor = data.dot_color || '#d1d5db';
                let psDotActive = data.dot_active_color || '#2563eb';

                let psShadowMap = {
                    'none': 'none',
                    'sm': '0 1px 3px rgba(0,0,0,0.1)',
                    'md': '0 4px 6px rgba(0,0,0,0.1)',
                    'lg': '0 10px 15px rgba(0,0,0,0.1)'
                };
                let psShadow = psShadowMap[psCardShadowVal] || psShadowMap['sm'];

                let psSamplePosts = [
                    {title: 'Getting Started with Web Design', excerpt: 'Learn the fundamentals of modern web design.', category: 'Design', date: 'Jan 5, 2026'},
                    {title: 'Top 10 SEO Tips for 2026', excerpt: 'Discover the latest SEO strategies.', category: 'Marketing', date: 'Jan 4, 2026'},
                    {title: 'The Future of AI in Business', excerpt: 'How AI is transforming businesses.', category: 'Technology', date: 'Jan 3, 2026'},
                    {title: 'Building a Strong Brand', excerpt: 'Create a memorable brand identity.', category: 'Branding', date: 'Jan 2, 2026'}
                ];

                let psHtml = '<div class="tb4-post-slider-preview" style="position:relative;padding:20px 0;">';
                
                if (psShowArrows) {
                    psHtml += '<button style="position:absolute;left:0;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:50%;background:' + psArrowBg + ';border:1px solid #e5e7eb;color:' + psArrowColor + ';cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.1);z-index:10;">‚óÄ</button>';
                    psHtml += '<button style="position:absolute;right:0;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:50%;background:' + psArrowBg + ';border:1px solid #e5e7eb;color:' + psArrowColor + ';cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.1);z-index:10;">‚ñ∂</button>';
                }

                psHtml += '<div class="tb4-post-slider-track" style="display:flex;gap:' + psGap + ';padding:0 50px;overflow:hidden;">';

                for (let psi = 0; psi < Math.min(psVisiblePosts, psSamplePosts.length); psi++) {
                    let post = psSamplePosts[psi];
                    psHtml += '<div class="tb4-post-slider-card" style="flex:1;background:' + psCardBg + ';border-radius:' + psCardRadius + ';box-shadow:' + psShadow + ';overflow:hidden;">';
                    
                    if (psShowImage) {
                        psHtml += '<div style="height:' + psImageHeight + ';background:linear-gradient(135deg,#e5e7eb,#f3f4f6);display:flex;align-items:center;justify-content:center;color:#9ca3af;position:relative;">';
                        psHtml += '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>';
                        if (psShowCategory) {
                            psHtml += '<span style="position:absolute;top:10px;left:10px;background:' + psCategoryBg + ';color:' + psCategoryColor + ';padding:4px 10px;border-radius:4px;font-size:11px;font-weight:500;">' + post.category + '</span>';
                        }
                        psHtml += '</div>';
                    }

                    psHtml += '<div style="padding:16px;">';
                    if (psShowDate) {
                        psHtml += '<div style="font-size:12px;color:' + psMetaColor + ';margin-bottom:8px;">' + post.date + '</div>';
                    }
                    if (psShowTitle) {
                        psHtml += '<h4 style="margin:0 0 8px 0;font-size:' + psTitleSize + ';font-weight:600;color:' + psTitleColor + ';line-height:1.3;">' + post.title + '</h4>';
                    }
                    if (psShowExcerpt) {
                        psHtml += '<p style="margin:0;font-size:14px;color:' + psExcerptColor + ';line-height:1.5;">' + post.excerpt + '</p>';
                    }
                    psHtml += '</div></div>';
                }

                psHtml += '</div>';

                if (psShowDots) {
                    psHtml += '<div style="display:flex;justify-content:center;gap:8px;margin-top:20px;">';
                    for (let di = 0; di < Math.ceil(psPostsCount / psVisiblePosts); di++) {
                        let dotBg = di === 0 ? psDotActive : psDotColor;
                        psHtml += '<span style="width:10px;height:10px;border-radius:50%;background:' + dotBg + ';cursor:pointer;"></span>';
                    }
                    psHtml += '</div>';
                }

                psHtml += '</div>';
                return psHtml;
            }

            // Post Content module
            case 'post_content':
                return `<div class="tb4-post-content-preview" style="padding:20px;background:#fafafa;border-left:4px solid #3b82f6;">
                    <p style="color:#6b7280;margin:0;">Post content will appear here...</p>
                </div>`;

            // Post Title module
            case 'post_title':
                return `<div class="tb4-post-title-preview" style="padding:10px;">
                    <h2 style="margin:0;color:#1f2937;">Post Title</h2>
                </div>`;

            // Post Navigation module
            case 'post_nav':
                return `<div class="tb4-post-nav-preview" style="display:flex;justify-content:space-between;padding:15px;background:#f3f4f6;border-radius:8px;">
                    <span style="color:#3b82f6;">‚Üê Previous Post</span>
                    <span style="color:#3b82f6;">Next Post ‚Üí</span>
                </div>`;

            // Comments module
            case 'comments':
                return `<div class="tb4-comments-preview" style="padding:20px;background:#f9fafb;border-radius:8px;">
                    <div class="tb4-comment" style="display:flex;gap:10px;align-items:center;color:#6b7280;">
                        <span style="font-size:24px;">üí¨</span>
                        <span>Comments Section (${data.count || 0} comments)</span>
                    </div>
                </div>`;

            // Number Counter module
            case 'number':
                return `<div class="tb4-number-preview" style="text-align:center;padding:20px;">
                    <div class="tb4-number-value" style="font-size:48px;font-weight:bold;color:#3b82f6;">${this.escapeHtml(data.number || '100')}</div>
                    <div class="tb4-number-title" style="color:#6b7280;margin-top:8px;">${this.escapeHtml(data.title || 'Counter')}</div>
                </div>`;

            // Circle Counter module
            case 'circle':
                return `<div class="tb4-circle-preview" style="text-align:center;padding:20px;">
                    <div class="tb4-circle-ring" style="width:100px;height:100px;border:8px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;margin:0 auto;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;">${data.percent || '75'}%</div>
                    <div class="tb4-circle-title" style="color:#6b7280;margin-top:12px;">${this.escapeHtml(data.title || 'Progress')}</div>
                </div>`;

            // Countdown module
            case 'countdown':
                return `<div class="tb4-countdown-preview" style="display:flex;justify-content:center;gap:16px;padding:20px;background:#1f2937;border-radius:8px;">
                    <div style="text-align:center;color:white;"><div style="font-size:32px;font-weight:bold;">00</div><div style="font-size:12px;">DAYS</div></div>
                    <div style="font-size:32px;color:white;">:</div>
                    <div style="text-align:center;color:white;"><div style="font-size:32px;font-weight:bold;">00</div><div style="font-size:12px;">HOURS</div></div>
                    <div style="font-size:32px;color:white;">:</div>
                    <div style="text-align:center;color:white;"><div style="font-size:32px;font-weight:bold;">00</div><div style="font-size:12px;">MINS</div></div>
                    <div style="font-size:32px;color:white;">:</div>
                    <div style="text-align:center;color:white;"><div style="font-size:32px;font-weight:bold;">00</div><div style="font-size:12px;">SECS</div></div>
                </div>`;

            // Progress Bar module
            case 'progress': {
                const progressPercent = data.percent || 50;
                return `<div class="tb4-progress-preview" style="padding:10px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                        <span style="font-size:14px;color:#374151;">${this.escapeHtml(data.title || 'Progress')}</span>
                        <span style="font-size:14px;color:#6b7280;">${progressPercent}%</span>
                    </div>
                    <div style="height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden;">
                        <div style="width:${progressPercent}%;height:100%;background:#3b82f6;border-radius:4px;"></div>
                    </div>
                </div>`;
            }

            // Pricing module
            case 'pricing':
                return `<div class="tb4-pricing-preview" style="text-align:center;padding:30px;background:#fff;border:2px solid #e5e7eb;border-radius:12px;">
                    <div style="font-size:20px;font-weight:600;color:#1f2937;">${this.escapeHtml(data.title || 'Basic Plan')}</div>
                    <div style="font-size:48px;font-weight:bold;color:#3b82f6;margin:20px 0;">${this.escapeHtml(data.price || '29')}<span style="font-size:16px;color:#6b7280;">/mo</span></div>
                    <button style="padding:12px 32px;background:#3b82f6;color:white;border:none;border-radius:6px;">Get Started</button>
                </div>`;

            // Toggle module
            case 'toggle':
                return `<div class="tb4-toggle-preview" style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;">
                    <div style="padding:16px;background:#f9fafb;cursor:pointer;display:flex;align-items:center;gap:10px;">
                        <span>‚ñ∂</span>
                        <span style="font-weight:500;">${this.escapeHtml(data.title || 'Toggle Title')}</span>
                    </div>
                </div>`;

            // Contact Form module
            case 'contact':
                return `<div class="tb4-contact-preview" style="padding:20px;background:#f9fafb;border-radius:8px;">
                    <div style="display:flex;flex-direction:column;gap:12px;max-width:400px;">
                        <input placeholder="Name" disabled style="padding:10px;border:1px solid #d1d5db;border-radius:4px;"/>
                        <input placeholder="Email" disabled style="padding:10px;border:1px solid #d1d5db;border-radius:4px;"/>
                        <textarea placeholder="Message" disabled style="padding:10px;border:1px solid #d1d5db;border-radius:4px;min-height:100px;"></textarea>
                        <button type="button" style="padding:12px;background:#3b82f6;color:white;border:none;border-radius:4px;">Send Message</button>
                    </div>
                </div>`;

            // Slider module
            case 'slider':
                return `<div class="tb4-slider-preview" style="padding:60px 20px;background:linear-gradient(135deg,#4f46e5,#7c3aed);color:white;text-align:center;border-radius:8px;">
                    <div style="display:flex;justify-content:center;align-items:center;gap:40px;">
                        <span style="font-size:32px;">‚óÄ</span>
                        <div>
                            <h3 style="margin:0 0 10px 0;font-size:24px;">Slider Content</h3>
                            <p style="margin:0;opacity:0.8;">Slide 1 of ${(data.slides && data.slides.length) || 3}</p>
                        </div>
                        <span style="font-size:32px;">‚ñ∂</span>
                    </div>
                </div>`;

            // Fullwidth Header module
            case 'fw_header':
                return `<div class="tb4-fw-header-preview" style="padding:60px 20px;background:linear-gradient(135deg,#1e3a5f,#2563eb);color:white;text-align:center;">
                    <h1 style="margin:0 0 16px 0;font-size:36px;">${this.escapeHtml(data.title || 'Fullwidth Header')}</h1>
                    <p style="margin:0;font-size:18px;opacity:0.9;">${this.escapeHtml(data.subtitle || 'Subtitle text here')}</p>
                </div>`;

            // Fullwidth Image module
            case 'fw_image':
                if (data.src) {
                    return `<div class="tb4-fw-image-preview"><img src="${this.escapeHtml(data.src)}" alt="" style="width:100%;height:auto;display:block;"/></div>`;
                }
                return `<div class="tb4-fw-image-preview" style="padding:80px 20px;background:#e5e7eb;text-align:center;">
                    <span style="font-size:48px;">üñºÔ∏è</span>
                    <p style="margin:10px 0 0 0;color:#6b7280;">Fullwidth Image</p>
                </div>`;

            // Fullwidth Slider module
            case 'fw_slider':
                return `<div class="tb4-fw-slider-preview" style="padding:80px 20px;background:linear-gradient(135deg,#059669,#10b981);color:white;text-align:center;">
                    <div style="display:flex;justify-content:center;align-items:center;gap:40px;">
                        <span style="font-size:36px;">‚óÄ</span>
                        <span style="font-size:24px;">Fullwidth Slider</span>
                        <span style="font-size:36px;">‚ñ∂</span>
                    </div>
                </div>`;

            // Fullwidth Map module
            case 'fw_map':
                return `<div class="tb4-fw-map-preview" style="padding:80px 20px;background:#d1d5db;text-align:center;">
                    <span style="font-size:48px;">üó∫Ô∏è</span>
                    <p style="margin:10px 0 0 0;color:#374151;">Fullwidth Map</p>
                    ${data.address ? `<p style="margin:5px 0 0 0;color:#6b7280;font-size:14px;">${this.escapeHtml(data.address)}</p>` : ''}
                </div>`;

            // Fullwidth Menu module
            case 'fw_menu':
                return `<div class="tb4-fw-menu-preview" style="padding:20px;background:#1f2937;text-align:center;">
                    <span style="font-size:24px;color:white;">‚ò∞ Fullwidth Menu</span>
                </div>`;

            // Fullwidth Portfolio module
            case 'fw_portfolio':
                return `<div class="tb4-fw-portfolio-preview" style="padding:40px 20px;background:#f3f4f6;text-align:center;">
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;max-width:800px;margin:0 auto;">
                        <div style="padding:40px;background:#e5e7eb;border-radius:4px;">üé®</div>
                        <div style="padding:40px;background:#e5e7eb;border-radius:4px;">üé®</div>
                        <div style="padding:40px;background:#e5e7eb;border-radius:4px;">üé®</div>
                        <div style="padding:40px;background:#e5e7eb;border-radius:4px;">üé®</div>
                    </div>
                </div>`;

            // Fullwidth Post Slider module
            case 'fw_post_slider':
                return `<div class="tb4-fw-post-slider-preview" style="padding:60px 20px;background:linear-gradient(135deg,#7c3aed,#a855f7);color:white;text-align:center;">
                    <div style="display:flex;justify-content:center;align-items:center;gap:40px;">
                        <span style="font-size:36px;">‚óÄ</span>
                        <span style="font-size:24px;">Fullwidth Post Slider</span>
                        <span style="font-size:36px;">‚ñ∂</span>
                    </div>
                </div>`;

            // Fullwidth Code module
            case 'fw_code':
                return `<div class="tb4-fw-code-preview" style="background:#1e1e1e;padding:20px;">
                    <pre style="margin:0;color:#d4d4d4;overflow-x:auto;"><code>${this.escapeHtml(data.code || '// Fullwidth Code Block')}</code></pre>
                </div>`;

            default:
                return `<div class="tb4-unknown-module">Unknown module type: ${moduleType}</div>`;
        }
    },

    /**
     * Render gallery content
     */
    renderGalleryContent(data) {
        const images = data.images || [];
        if (images.length === 0) {
            return '<div class="tb4-gallery-placeholder">Click to add images</div>';
        }

        let html = '<div class="tb4-gallery">';
        images.forEach(img => {
            html += `<div class="tb4-gallery-item"><img src="${this.escapeHtml(img.src)}" alt="${this.escapeHtml(img.alt || '')}"/></div>`;
        });
        html += '</div>';
        return html;
    },

    /**
     * Render accordion content
     */
    renderAccordionContent(data) {
        const items = data.items || [{ title: 'Accordion Item', content: 'Content here...' }];
        let html = '<div class="tb4-accordion">';
        items.forEach((item, i) => {
            html += `
                <div class="tb4-accordion-item">
                    <div class="tb4-accordion-header">${this.escapeHtml(item.title)}</div>
                    <div class="tb4-accordion-content">${item.content}</div>
                </div>
            `;
        });
        html += '</div>';
        return html;
    },

    /**
     * Render tabs content
     */
    renderTabsContent(data) {
        const tabs = data.tabs || [{ title: 'Tab 1', content: 'Tab content...' }];
        let navHtml = '<div class="tb4-tabs-nav">';
        let contentHtml = '<div class="tb4-tabs-content">';

        tabs.forEach((tab, i) => {
            const active = i === 0 ? ' active' : '';
            navHtml += `<button class="tb4-tab-btn${active}">${this.escapeHtml(tab.title)}</button>`;
            contentHtml += `<div class="tb4-tab-pane${active}">${tab.content}</div>`;
        });

        navHtml += '</div>';
        contentHtml += '</div>';

        return `<div class="tb4-tabs">${navHtml}${contentHtml}</div>`;
    },

    /**
     * Render list content
     */
    renderListContent(data) {
        const items = data.items || ['List item 1', 'List item 2'];
        const type = data.type || 'ul';

        let html = `<${type} class="tb4-list">`;
        items.forEach(item => {
            html += `<li>${this.escapeHtml(item)}</li>`;
        });
        html += `</${type}>`;
        return html;
    },

    /**
     * Render video embed
     */
    renderVideoEmbed(url) {
        // YouTube
        const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/);
        if (ytMatch) {
            return `<iframe src="https://www.youtube.com/embed/${ytMatch[1]}" frameborder="0" allowfullscreen></iframe>`;
        }

        // Vimeo
        const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
        if (vimeoMatch) {
            return `<iframe src="https://player.vimeo.com/video/${vimeoMatch[1]}" frameborder="0" allowfullscreen></iframe>`;
        }

        // Direct video
        return `<video src="${this.escapeHtml(url)}" controls></video>`;
    },

    // ==========================================================================
    // SIDEBAR MANAGEMENT
    // ==========================================================================

    /**
     * Initialize the sidebar
     */
    initSidebar() {
        if (!this.dom.sidebar) return;

        // Render module list
        this.renderModuleList();

        // Tab switching
        this.dom.sidebar.querySelectorAll('[data-sidebar-tab]').forEach(tab => {
            tab.addEventListener('click', () => {
                this.switchSidebarTab(tab.dataset.sidebarTab);
            });
        });
    },

    /**
     * Render the module list in sidebar
     */
    renderModuleList() {
        if (!this.dom.moduleList) {
            console.log('[TB4] renderModuleList: moduleList element not found');
            return;
        }

        // Check if modules are already hardcoded in HTML (from PHP)
        const existingModules = this.dom.moduleList.querySelectorAll('[data-module-type]');
        
        if (existingModules.length > 0) {
            console.log('[TB4] renderModuleList: Using existing hardcoded modules from PHP (' + existingModules.length + ' modules)');
        } else {
            // No hardcoded modules - generate from config
            const categories = this.categorizeModules();
            const hasConfigModules = Object.keys(categories).length > 0;

            console.log('[TB4] renderModuleList: Generating from config, hasConfigModules =', hasConfigModules);

            if (hasConfigModules) {
                let html = '';

                Object.entries(categories).forEach(([category, modules]) => {
                    html += `
                        <div class="tb4-module-category">
                            <div class="tb4-category-title">${category}</div>
                            <div class="tb4-modules-grid">
                    `;

                    modules.forEach(mod => {
                        const iconName = (mod.icon || 'box').replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
                        html += `
                            <div class="tb4-module-item"
                                 draggable="true"
                                 data-module-type="${mod.type}"
                                 title="${this.escapeHtml(mod.description || mod.name)}">
                                <i data-lucide="${iconName}" class="tb4-module-icon"></i>
                                <div class="tb4-module-name">${mod.name}</div>
                            </div>
                        `;
                    });

                    html += '</div></div>';
                });

                this.dom.moduleList.innerHTML = html;
                
                if (window.lucide) {
                    lucide.createIcons();
                }
            }
        }

        // Add drag handlers to ALL modules (dynamic or hardcoded)
        const moduleItems = this.dom.moduleList.querySelectorAll('[data-module-type]');
        console.log('[TB4] renderModuleList: Found', moduleItems.length, 'module items');

        moduleItems.forEach(item => {
            item.addEventListener('dragstart', (e) => this.handleModuleDragStart(e));
            item.addEventListener('dragend', (e) => this.handleModuleDragEnd(e));
        });
    },

    /**
     * Categorize modules for sidebar display
     */
    categorizeModules() {
        const categories = {
            'Basic': [],
            'Media': [],
            'Layout': [],
            'Advanced': []
        };

        Object.entries(this.config.modules).forEach(([slug, config]) => {
            // Skip child modules - they shouldn't appear in sidebar
            if (config.type === 'child') {
                return;
            }
            const cat = config.category || 'Basic';
            if (!categories[cat]) {
                categories[cat] = [];
            }
            // Use slug for module type, spread config but preserve slug as 'type' for drag/drop
            categories[cat].push({ ...config, type: slug });
        });

        // Remove empty categories
        Object.keys(categories).forEach(cat => {
            if (categories[cat].length === 0) {
                delete categories[cat];
            }
        });

        return categories;
    },

    /**
     * Switch sidebar tab
     */
    switchSidebarTab(tabName) {
        // Update tab buttons
        this.dom.sidebar.querySelectorAll('[data-sidebar-tab]').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.sidebarTab === tabName);
        });

        // Update tab content
        this.dom.sidebar.querySelectorAll('[data-sidebar-content]').forEach(content => {
            content.classList.toggle('active', content.dataset.sidebarContent === tabName);
        });
    },

    // ==========================================================================
    // TOOLBAR MANAGEMENT
    // ==========================================================================

    /**
     * Initialize the toolbar
     */
    initToolbar() {
        if (!this.dom.toolbar) return;

        // Device switcher
        this.dom.deviceButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                this.setDevice(btn.dataset.device);
            });
        });

        // Zoom controls
        const zoomIn = this.dom.toolbar.querySelector('[data-action="zoom-in"]');
        const zoomOut = this.dom.toolbar.querySelector('[data-action="zoom-out"]');
        const zoomReset = this.dom.toolbar.querySelector('[data-action="zoom-reset"]');

        if (zoomIn) zoomIn.addEventListener('click', () => this.adjustZoom(10));
        if (zoomOut) zoomOut.addEventListener('click', () => this.adjustZoom(-10));
        if (zoomReset) zoomReset.addEventListener('click', () => this.setZoom(100));

        // Undo/Redo
        const undoBtn = this.dom.toolbar.querySelector('[data-action="undo"]');
        const redoBtn = this.dom.toolbar.querySelector('[data-action="redo"]');

        if (undoBtn) undoBtn.addEventListener('click', () => this.undo());
        if (redoBtn) redoBtn.addEventListener('click', () => this.redo());

        // Save button
        const saveBtn = this.dom.toolbar.querySelector('[data-action="save"]');
        if (saveBtn) saveBtn.addEventListener('click', () => this.save());

        // Preview button
        const previewBtn = this.dom.toolbar.querySelector('[data-action="preview"]');
        if (previewBtn) previewBtn.addEventListener('click', () => this.preview());
    },

    /**
     * Set device preview mode
     */
    setDevice(device) {
        this.state.device = device;

        // Update buttons
        this.dom.deviceButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.device === device);
        });

        // Update canvas
        if (this.dom.canvas) {
            this.dom.canvas.className = `tb4-canvas tb4-device-${device}`;
        }
    },

    /**
     * Adjust zoom level
     */
    adjustZoom(delta) {
        this.setZoom(this.state.zoom + delta);
    },

    /**
     * Set zoom level
     */
    setZoom(level) {
        this.state.zoom = Math.max(25, Math.min(200, level));

        if (this.dom.canvas) {
            this.dom.canvas.style.transform = `scale(${this.state.zoom / 100})`;
        }

        if (this.dom.zoomDisplay) {
            this.dom.zoomDisplay.textContent = `${this.state.zoom}%`;
        }
    },

    // ==========================================================================
    // SETTINGS PANEL
    // ==========================================================================

    /**
     * Initialize the settings panel
     */
    initSettingsPanel() {
        if (!this.dom.settingsPanel) return;

        // Tab switching
        this.dom.settingsPanel.querySelectorAll('[data-settings-tab]').forEach(tab => {
            tab.addEventListener('click', () => {
                this.switchSettingsTab(tab.dataset.settingsTab);
            });
        });
    },

    /**
     * Show settings for selected element
     */
    showSettings(elementId, elementType) {
        if (!this.dom.settingsPanel) return;

        const element = this.findElement(elementId);
        if (!element) return;

        this.dom.settingsPanel.classList.add('active');

        // Generate form based on element type
        const form = this.generateSettingsForm(element, elementType);
        const contentTab = this.dom.settingsPanel.querySelector('[data-settings-content="content"]');
        const designTab = this.dom.settingsPanel.querySelector('[data-settings-content="design"]');
        const advancedTab = this.dom.settingsPanel.querySelector('[data-settings-content="advanced"]');

        if (contentTab) contentTab.innerHTML = form.content;
        if (designTab) designTab.innerHTML = form.design;
        if (advancedTab) advancedTab.innerHTML = form.advanced;

        // Bind form events
        this.bindSettingsEvents();
    },

    /**
     * Hide settings panel
     */
    hideSettings() {
        if (this.dom.settingsPanel) {
            this.dom.settingsPanel.classList.remove('active');
        }
    },

    /**
     * Switch settings tab
     */
    switchSettingsTab(tabName) {
        if (!this.dom.settingsPanel) return;

        // Update tab buttons
        this.dom.settingsPanel.querySelectorAll('[data-settings-tab]').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.settingsTab === tabName);
        });

        // Update tab content
        this.dom.settingsPanel.querySelectorAll('[data-settings-content]').forEach(content => {
            content.classList.toggle('active', content.dataset.settingsContent === tabName);
        });
    },

    /**
     * Generate settings form for element
     */
    generateSettingsForm(element, type) {
        const form = {
            content: '',
            design: '',
            advanced: ''
        };

        // Content settings (varies by type)
        if (type === 'module') {
            form.content = this.generateModuleContentForm(element);
        } else if (type === 'section') {
            form.content = this.generateSectionContentForm(element);
        } else if (type === 'row') {
            form.content = this.generateRowContentForm(element);
        } else if (type === 'column') {
            form.content = this.generateColumnContentForm(element);
        }

        // Design settings (common)
        form.design = this.generateDesignForm(element, type);

        // Advanced settings (common)
        form.advanced = this.generateAdvancedForm(element, type);

        return form;
    },

    /**
     * Generate module content form
     */
    generateModuleContentForm(module) {
        const moduleConfig = this.config.modules[module.type] || {};
        const fields = Array.isArray(moduleConfig.fields) ? moduleConfig.fields : [];
        const content = module.content || {};

        let html = `<div class="tb4-settings-group">
            <h4>${moduleConfig.name || module.type} Content</h4>`;

        fields.forEach(field => {
            html += this.renderSettingsField(field, content[field.name]);
        });

        html += '</div>';
        return html;
    },

    /**
     * Generate section content form
     */
    generateSectionContentForm(section) {
        return `
            <div class="tb4-settings-group">
                <h4>Section Settings</h4>
                ${this.renderSettingsField({
                    name: 'containerWidth',
                    type: 'select',
                    label: 'Container Width',
                    options: [
                        { value: 'full', label: 'Full Width' },
                        { value: 'boxed', label: 'Boxed' },
                        { value: 'narrow', label: 'Narrow' }
                    ]
                }, section.settings?.containerWidth || 'boxed')}
            </div>
        `;
    },

    /**
     * Generate row content form
     */
    generateRowContentForm(row) {
        return `
            <div class="tb4-settings-group">
                <h4>Row Layout</h4>
                <div class="tb4-layout-picker">
                    ${this.renderLayoutOptions(row.layout || '1')}
                </div>
            </div>
        `;
    },

    /**
     * Generate column content form
     */
    generateColumnContentForm(column) {
        return `
            <div class="tb4-settings-group">
                <h4>Column Settings</h4>
                ${this.renderSettingsField({
                    name: 'width',
                    type: 'range',
                    label: 'Width (%)',
                    min: 10,
                    max: 100,
                    step: 5
                }, column.width || 100)}
            </div>
        `;
    },

    /**
     * Generate design form (common styles)
     */
    generateDesignForm(element, type) {
        const settings = element.settings || {};

        return `
            <div class="tb4-settings-group">
                <h4>Background</h4>
                ${this.renderSettingsField({ name: 'backgroundColor', type: 'color', label: 'Background Color' }, settings.backgroundColor)}
                ${this.renderSettingsField({ name: 'backgroundImage', type: 'image', label: 'Background Image' }, settings.backgroundImage)}
            </div>
            <div class="tb4-settings-group">
                <h4>Spacing</h4>
                ${this.renderSpacingControl('padding', settings.padding)}
                ${this.renderSpacingControl('margin', settings.margin)}
            </div>
            <div class="tb4-settings-group">
                <h4>Border</h4>
                ${this.renderSettingsField({ name: 'borderWidth', type: 'number', label: 'Border Width', min: 0, max: 20 }, settings.borderWidth)}
                ${this.renderSettingsField({ name: 'borderColor', type: 'color', label: 'Border Color' }, settings.borderColor)}
                ${this.renderSettingsField({ name: 'borderRadius', type: 'number', label: 'Border Radius', min: 0, max: 100 }, settings.borderRadius)}
            </div>
        `;
    },

    /**
     * Generate advanced form
     */
    generateAdvancedForm(element, type) {
        const settings = element.settings || {};

        return `
            <div class="tb4-settings-group">
                <h4>CSS</h4>
                ${this.renderSettingsField({ name: 'cssClass', type: 'text', label: 'CSS Class' }, settings.cssClass)}
                ${this.renderSettingsField({ name: 'cssId', type: 'text', label: 'CSS ID' }, settings.cssId)}
                ${this.renderSettingsField({ name: 'customCss', type: 'textarea', label: 'Custom CSS', rows: 5 }, settings.customCss)}
            </div>
            <div class="tb4-settings-group">
                <h4>Visibility</h4>
                ${this.renderSettingsField({ name: 'hideOnDesktop', type: 'checkbox', label: 'Hide on Desktop' }, settings.hideOnDesktop)}
                ${this.renderSettingsField({ name: 'hideOnTablet', type: 'checkbox', label: 'Hide on Tablet' }, settings.hideOnTablet)}
                ${this.renderSettingsField({ name: 'hideOnMobile', type: 'checkbox', label: 'Hide on Mobile' }, settings.hideOnMobile)}
            </div>
            <div class="tb4-settings-group">
                <h4>Animation</h4>
                ${this.renderSettingsField({
                    name: 'animation',
                    type: 'select',
                    label: 'Entrance Animation',
                    options: [
                        { value: '', label: 'None' },
                        { value: 'fadeIn', label: 'Fade In' },
                        { value: 'slideUp', label: 'Slide Up' },
                        { value: 'slideLeft', label: 'Slide Left' },
                        { value: 'slideRight', label: 'Slide Right' },
                        { value: 'zoomIn', label: 'Zoom In' }
                    ]
                }, settings.animation)}
            </div>
        `;
    },

    /**
     * Render a settings field
     */
    renderSettingsField(field, value) {
        const id = `tb4-field-${field.name}`;
        const escapedValue = value !== undefined ? this.escapeHtml(String(value)) : '';

        let input = '';

        switch (field.type) {
            case 'text':
                input = `<input type="text" id="${id}" name="${field.name}" value="${escapedValue}" class="tb4-input"/>`;
                break;

            case 'textarea':
                input = `<textarea id="${id}" name="${field.name}" class="tb4-textarea" rows="${field.rows || 3}">${escapedValue}</textarea>`;
                break;

            case 'number':
                input = `<input type="number" id="${id}" name="${field.name}" value="${escapedValue}"
                         class="tb4-input" min="${field.min || 0}" max="${field.max || 9999}" step="${field.step || 1}"/>`;
                break;

            case 'range':
                input = `<input type="range" id="${id}" name="${field.name}" value="${value || field.min || 0}"
                         class="tb4-range" min="${field.min || 0}" max="${field.max || 100}" step="${field.step || 1}"/>
                         <span class="tb4-range-value">${value || field.min || 0}</span>`;
                break;

            case 'select':
                const options = (field.options || []).map(opt =>
                    `<option value="${this.escapeHtml(opt.value)}" ${opt.value === value ? 'selected' : ''}>${this.escapeHtml(opt.label)}</option>`
                ).join('');
                input = `<select id="${id}" name="${field.name}" class="tb4-select">${options}</select>`;
                break;

            case 'checkbox':
                input = `<input type="checkbox" id="${id}" name="${field.name}" class="tb4-checkbox" ${value ? 'checked' : ''}/>`;
                break;

            case 'color':
                input = `<input type="color" id="${id}" name="${field.name}" value="${escapedValue || '#000000'}" class="tb4-color"/>
                         <input type="text" name="${field.name}_text" value="${escapedValue}" class="tb4-input tb4-color-text" placeholder="#000000"/>`;
                break;

            case 'image':
                input = `<div class="tb4-image-picker">
                    <input type="hidden" id="${id}" name="${field.name}" value="${escapedValue}"/>
                    <div class="tb4-image-preview">${value ? `<img src="${escapedValue}"/>` : ''}</div>
                    <button type="button" class="tb4-btn tb4-btn-sm" onclick="TB4Builder.openMediaPicker('${field.name}')">Choose Image</button>
                    ${value ? `<button type="button" class="tb4-btn tb4-btn-sm tb4-btn-danger" onclick="TB4Builder.clearImage('${field.name}')">Remove</button>` : ''}
                </div>`;
                break;

            case 'wysiwyg':
                input = `<div class="tb4-wysiwyg" id="${id}" name="${field.name}" contenteditable="true">${value || ''}</div>`;
                break;

            case 'icon':
                input = `<div class="tb4-icon-picker">
                    <input type="text" id="${id}" name="${field.name}" value="${escapedValue}" class="tb4-input"/>
                    <button type="button" class="tb4-btn tb4-btn-sm" onclick="TB4Builder.openIconPicker('${field.name}')">Choose Icon</button>
                </div>`;
                break;

            default:
                input = `<input type="text" id="${id}" name="${field.name}" value="${escapedValue}" class="tb4-input"/>`;
        }

        return `
            <div class="tb4-field tb4-field-${field.type}">
                <label for="${id}" class="tb4-label">${field.label || field.name}</label>
                ${input}
                ${field.description ? `<p class="tb4-field-desc">${field.description}</p>` : ''}
            </div>
        `;
    },

    /**
     * Render spacing control (padding/margin)
     */
    renderSpacingControl(name, value) {
        const v = value || { top: 0, right: 0, bottom: 0, left: 0 };

        return `
            <div class="tb4-spacing-control" data-spacing="${name}">
                <label class="tb4-label">${name.charAt(0).toUpperCase() + name.slice(1)}</label>
                <div class="tb4-spacing-inputs">
                    <input type="number" name="${name}Top" value="${v.top || 0}" class="tb4-spacing-input" placeholder="Top"/>
                    <input type="number" name="${name}Right" value="${v.right || 0}" class="tb4-spacing-input" placeholder="Right"/>
                    <input type="number" name="${name}Bottom" value="${v.bottom || 0}" class="tb4-spacing-input" placeholder="Bottom"/>
                    <input type="number" name="${name}Left" value="${v.left || 0}" class="tb4-spacing-input" placeholder="Left"/>
                    <button type="button" class="tb4-btn tb4-btn-sm tb4-spacing-link" title="Link values">üîó</button>
                </div>
            </div>
        `;
    },

    /**
     * Render layout picker options
     */
    renderLayoutOptions(current) {
        const layouts = [
            { value: '1', label: '1 Column', icon: '‚ñÆ' },
            { value: '1/2-1/2', label: '2 Equal', icon: '‚ñÆ‚ñÆ' },
            { value: '1/3-2/3', label: '1/3 - 2/3', icon: '‚ñØ‚ñÆ' },
            { value: '2/3-1/3', label: '2/3 - 1/3', icon: '‚ñÆ‚ñØ' },
            { value: '1/3-1/3-1/3', label: '3 Equal', icon: '‚ñÆ‚ñÆ‚ñÆ' },
            { value: '1/4-1/4-1/4-1/4', label: '4 Equal', icon: '‚ñÆ‚ñÆ‚ñÆ‚ñÆ' },
            { value: '1/4-1/2-1/4', label: '1/4 - 1/2 - 1/4', icon: '‚ñØ‚ñÆ‚ñØ' }
        ];

        return layouts.map(layout => `
            <button type="button"
                    class="tb4-layout-option ${layout.value === current ? 'active' : ''}"
                    data-layout="${layout.value}"
                    title="${layout.label}">
                <span class="tb4-layout-icon">${layout.icon}</span>
            </button>
        `).join('');
    },

    /**
     * Bind settings form events
     */
    bindSettingsEvents() {
        if (!this.dom.settingsPanel) return;

        // Input changes
        this.dom.settingsPanel.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('change', (e) => this.handleSettingChange(e));
            input.addEventListener('input', (e) => {
                // Real-time preview for certain types
                if (e.target.type === 'range' || e.target.type === 'color') {
                    this.handleSettingChange(e);
                }
            });
        });

        // Range value display
        this.dom.settingsPanel.querySelectorAll('.tb4-range').forEach(range => {
            range.addEventListener('input', (e) => {
                const display = e.target.nextElementSibling;
                if (display && display.classList.contains('tb4-range-value')) {
                    display.textContent = e.target.value;
                }
            });
        });

        // Layout picker
        this.dom.settingsPanel.querySelectorAll('.tb4-layout-option').forEach(btn => {
            btn.addEventListener('click', () => {
                this.changeRowLayout(this.state.selected, btn.dataset.layout);
            });
        });

        // Color picker sync
        this.dom.settingsPanel.querySelectorAll('.tb4-color').forEach(picker => {
            picker.addEventListener('input', (e) => {
                const textInput = e.target.nextElementSibling;
                if (textInput) textInput.value = e.target.value;
            });
        });
    },

    /**
     * Handle setting change
     */
    handleSettingChange(e) {
        if (!this.state.selected) return;

        const element = this.findElement(this.state.selected);
        if (!element) return;

        const name = e.target.name;
        let value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;

        // Handle spacing controls
        if (name.match(/^(padding|margin)(Top|Right|Bottom|Left)$/)) {
            const prop = name.match(/^(padding|margin)/)[1];
            const side = name.match(/(Top|Right|Bottom|Left)$/)[1].toLowerCase();

            if (!element.settings) element.settings = {};
            if (!element.settings[prop]) element.settings[prop] = {};
            element.settings[prop][side] = parseInt(value) || 0;
        }
        // Handle content fields for modules
        else if (this.state.selectedType === 'module') {
            const moduleConfig = this.config.modules[element.type] || {};
            const fields = Array.isArray(moduleConfig.fields) ? moduleConfig.fields : [];
            const isContentField = fields.some(f => f.name === name);

            if (isContentField) {
                if (!element.content) element.content = {};
                element.content[name] = value;
            } else {
                if (!element.settings) element.settings = {};
                element.settings[name] = value;
            }
        }
        // Handle settings fields
        else {
            if (!element.settings) element.settings = {};
            element.settings[name] = value;
        }

        this.state.isDirty = true;
        this.renderCanvas();
        this.pushHistory();
    },

    // ==========================================================================
    // DRAG AND DROP
    // ==========================================================================

    /**
     * Initialize drag and drop
     */
    initDragDrop() {
        // Global drag events
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
        });
    },

    /**
     * Initialize canvas drop zones
     */
    initCanvasDropZones() {
        if (!this.dom.canvas) return;

        // Drop zones
        this.dom.canvas.querySelectorAll('[data-drop-zone]').forEach(zone => {
            zone.addEventListener('dragover', (e) => this.handleDragOver(e));
            zone.addEventListener('dragleave', (e) => this.handleDragLeave(e));
            zone.addEventListener('drop', (e) => this.handleDrop(e));
        });

        // Existing elements (for reordering)
        this.dom.canvas.querySelectorAll('[data-tb4-type]').forEach(el => {
            el.setAttribute('draggable', 'true');
            el.addEventListener('dragstart', (e) => this.handleElementDragStart(e));
            el.addEventListener('dragend', (e) => this.handleElementDragEnd(e));
        });
    },

    /**
     * Handle module drag start from sidebar
     */
    handleModuleDragStart(e) {
        const moduleType = e.target.dataset.moduleType;
        e.dataTransfer.setData('text/plain', JSON.stringify({
            action: 'add-module',
            type: moduleType
        }));
        e.dataTransfer.effectAllowed = 'copy';
        e.target.classList.add('dragging');
    },

    /**
     * Handle module drag end from sidebar
     */
    handleModuleDragEnd(e) {
        e.target.classList.remove('dragging');
        this.clearDropHighlights();
    },

    /**
     * Handle element drag start (reordering)
     */
    handleElementDragStart(e) {
        const element = e.target.closest('[data-tb4-id]');
        if (!element) return;

        e.dataTransfer.setData('text/plain', JSON.stringify({
            action: 'move',
            id: element.dataset.tb4Id,
            type: element.dataset.tb4Type
        }));
        e.dataTransfer.effectAllowed = 'move';
        element.classList.add('dragging');

        // Prevent drag on child elements
        e.stopPropagation();
    },

    /**
     * Handle element drag end (reordering)
     */
    handleElementDragEnd(e) {
        const element = e.target.closest('[data-tb4-id]');
        if (element) {
            element.classList.remove('dragging');
        }
        this.clearDropHighlights();
    },

    /**
     * Handle drag over drop zone
     */
    handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();

        const zone = e.target.closest('[data-drop-zone]');
        if (zone) {
            zone.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'copy';
        }
    },

    /**
     * Handle drag leave drop zone
     */
    handleDragLeave(e) {
        const zone = e.target.closest('[data-drop-zone]');
        if (zone && !zone.contains(e.relatedTarget)) {
            zone.classList.remove('drag-over');
        }
    },

    /**
     * Handle drop
     */
    handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();

        this.clearDropHighlights();

        const zone = e.target.closest('[data-drop-zone]');
        if (!zone) return;

        let data;
        try {
            data = JSON.parse(e.dataTransfer.getData('text/plain'));
        } catch {
            return;
        }

        const zoneType = zone.dataset.dropZone;

        if (data.action === 'add-module') {
            if (zoneType === 'module') {
                const columnId = zone.dataset.columnId;
                this.addModule(columnId, data.type);
            } else if (zoneType === 'section') {
                // Create section -> row -> column -> module
                const section = this.addSection();
                const row = this.addRowWithLayout(section.id, '1');
                this.addModule(row.columns[0].id, data.type);
            }
        } else if (data.action === 'move') {
            this.handleMoveElement(data.id, data.type, zone);
        }
    },

    /**
     * Handle moving an element to a new location
     */
    handleMoveElement(elementId, elementType, dropZone) {
        // For now, just re-render (complex reordering logic would go here)
        this.renderCanvas();
    },

    /**
     * Clear all drop zone highlights
     */
    clearDropHighlights() {
        document.querySelectorAll('.drag-over').forEach(el => {
            el.classList.remove('drag-over');
        });
    },

    // ==========================================================================
    // ELEMENT OPERATIONS
    // ==========================================================================

    /**
     * Add a new section
     */
    addSection(afterSectionId = null) {
        console.log('[TB4] addSection() called');

        // Ensure state.content exists
        if (!this.state.content) {
            this.state.content = {
                version: '1.0',
                sections: []
            };
        }

        // Ensure sections array exists
        if (!this.state.content.sections) {
            this.state.content.sections = [];
        }

        const section = {
            id: this.generateId(),
            type: 'section',
            settings: {
                containerWidth: 'boxed'
            },
            rows: []
        };

        if (afterSectionId) {
            const index = this.state.content.sections.findIndex(s => s.id === afterSectionId);
            if (index !== -1) {
                this.state.content.sections.splice(index + 1, 0, section);
            } else {
                this.state.content.sections.push(section);
            }
        } else {
            this.state.content.sections.push(section);
        }

        console.log('[TB4] Section added:', section.id);
        console.log('[TB4] Total sections:', this.state.content.sections.length);

        this.state.isDirty = true;
        this.renderCanvas();
        this.pushHistory();
        this.selectElement(section.id, 'section');

        return section;
    },

    /**
     * Add a new row to a section with specified layout
     */
    addRowWithLayout(sectionId, layout = '1') {
        const section = this.findElement(sectionId);
        if (!section || !section.rows) return null;

        const columns = this.createColumnsFromLayout(layout);

        const row = {
            id: this.generateId(),
            type: 'row',
            layout: layout,
            settings: {},
            columns: columns
        };

        section.rows.push(row);

        this.state.isDirty = true;
        this.renderCanvas();
        this.pushHistory();
        this.selectElement(row.id, 'row');

        return row;
    },

    /**
     * Create columns from layout string
     */
    createColumnsFromLayout(layout) {
        const widths = {
            '1': [100],
            '1/2-1/2': [50, 50],
            '1/3-2/3': [33.33, 66.67],
            '2/3-1/3': [66.67, 33.33],
            '1/3-1/3-1/3': [33.33, 33.33, 33.33],
            '1/4-1/4-1/4-1/4': [25, 25, 25, 25],
            '1/4-1/2-1/4': [25, 50, 25]
        };

        const colWidths = widths[layout] || [100];

        return colWidths.map(width => ({
            id: this.generateId(),
            type: 'column',
            width: width,
            settings: {},
            modules: []
        }));
    },

    /**
     * Change row layout
     */
    changeRowLayout(rowId, newLayout) {
        const row = this.findElement(rowId);
        if (!row) return;

        // Collect all existing modules
        const existingModules = [];
        if (row.columns) {
            row.columns.forEach(col => {
                if (col.modules) {
                    existingModules.push(...col.modules);
                }
            });
        }

        // Create new columns
        row.columns = this.createColumnsFromLayout(newLayout);
        row.layout = newLayout;

        // Redistribute modules to first column
        if (existingModules.length > 0 && row.columns.length > 0) {
            row.columns[0].modules = existingModules;
        }

        this.state.isDirty = true;
        this.renderCanvas();
        this.pushHistory();

        // Update settings panel if row is selected
        if (this.state.selected === rowId) {
            this.showSettings(rowId, 'row');
        }
    },

    /**
     * Add a module to a column
     */
    addModule(columnId, moduleType) {
        const column = this.findElement(columnId);
        if (!column) return null;

        if (!column.modules) {
            column.modules = [];
        }

        const moduleConfig = this.config.modules[moduleType] || {};
        const defaultContent = {};

        // Set default values from module config
        if (Array.isArray(moduleConfig.fields)) {
            moduleConfig.fields.forEach(field => {
                if (field.default !== undefined) {
                    defaultContent[field.name] = field.default;
                }
            });
        }

        const module = {
            id: this.generateId(),
            type: moduleType,
            content: defaultContent,
            settings: {}
        };

        column.modules.push(module);

        this.state.isDirty = true;
        this.renderCanvas();
        this.pushHistory();
        this.selectElement(module.id, 'module');

        return module;
    },

    /**
     * Select an element
     */
    selectElement(elementId, elementType) {
        // Deselect previous
        this.deselectAll();

        this.state.selected = elementId;
        this.state.selectedType = elementType;

        // Add visual selection
        const el = this.dom.canvas?.querySelector(`[data-tb4-id="${elementId}"]`);
        if (el) {
            el.classList.add('tb4-selected');
        }

        // Show settings
        this.showSettings(elementId, elementType);

        // Dispatch event
        document.dispatchEvent(new CustomEvent('tb4:select', {
            detail: { id: elementId, type: elementType }
        }));
    },

    /**
     * Deselect all elements
     */
    deselectAll() {
        this.state.selected = null;
        this.state.selectedType = null;

        this.dom.canvas?.querySelectorAll('.tb4-selected').forEach(el => {
            el.classList.remove('tb4-selected');
        });

        this.hideSettings();
    },

    /**
     * Delete an element
     */
    deleteElement(elementId) {
        const result = this.removeElementFromContent(this.state.content.sections, elementId);

        if (result) {
            if (this.state.selected === elementId) {
                this.deselectAll();
            }

            this.state.isDirty = true;
            this.renderCanvas();
            this.pushHistory();
        }
    },

    /**
     * Recursively remove element from content
     */
    removeElementFromContent(items, elementId) {
        if (!items) return false;

        for (let i = 0; i < items.length; i++) {
            if (items[i].id === elementId) {
                items.splice(i, 1);
                return true;
            }

            // Check nested elements
            if (items[i].rows && this.removeElementFromContent(items[i].rows, elementId)) {
                return true;
            }
            if (items[i].columns && this.removeElementFromContent(items[i].columns, elementId)) {
                return true;
            }
            if (items[i].modules && this.removeElementFromContent(items[i].modules, elementId)) {
                return true;
            }
        }

        return false;
    },

    /**
     * Duplicate an element
     */
    duplicateElement(elementId) {
        const element = this.findElement(elementId);
        if (!element) return;

        const clone = this.deepClone(element);
        this.regenerateIds(clone);

        // Find parent and insert after
        const parent = this.findParent(elementId);
        if (parent) {
            let array;
            if (element.type === 'section') {
                array = this.state.content.sections;
            } else if (element.type === 'row') {
                array = parent.rows;
            } else if (element.type === 'column') {
                array = parent.columns;
            } else if (element.type === 'module') {
                array = parent.modules;
            }

            if (array) {
                const index = array.findIndex(item => item.id === elementId);
                if (index !== -1) {
                    array.splice(index + 1, 0, clone);
                }
            }
        }

        this.state.isDirty = true;
        this.renderCanvas();
        this.pushHistory();
        this.selectElement(clone.id, clone.type);
    },

    /**
     * Move an element up or down
     */
    moveElement(elementId, direction) {
        const parent = this.findParent(elementId);
        if (!parent) {
            // It's a section
            const index = this.state.content.sections.findIndex(s => s.id === elementId);
            if (index !== -1) {
                const newIndex = direction === 'up' ? index - 1 : index + 1;
                if (newIndex >= 0 && newIndex < this.state.content.sections.length) {
                    const section = this.state.content.sections.splice(index, 1)[0];
                    this.state.content.sections.splice(newIndex, 0, section);
                    this.state.isDirty = true;
                    this.renderCanvas();
                    this.pushHistory();
                }
            }
            return;
        }

        const element = this.findElement(elementId);
        if (!element) return;

        let array;
        if (element.rows !== undefined) { // It's a section
            array = this.state.content.sections;
        } else if (element.columns !== undefined) { // It's a row
            array = parent.rows;
        } else if (element.modules !== undefined) { // It's a column
            array = parent.columns;
        } else { // It's a module
            array = parent.modules;
        }

        if (!array) return;

        const index = array.findIndex(item => item.id === elementId);
        if (index === -1) return;

        const newIndex = direction === 'up' ? index - 1 : index + 1;
        if (newIndex < 0 || newIndex >= array.length) return;

        // Swap
        const temp = array[index];
        array[index] = array[newIndex];
        array[newIndex] = temp;

        this.state.isDirty = true;
        this.renderCanvas();
        this.pushHistory();
    },

    /**
     * Enable inline editing for a module
     */
    enableInlineEdit(moduleElement) {
        const moduleId = moduleElement.dataset.tb4Id;
        const module = this.findElement(moduleId);
        if (!module) return;

        // Only enable for text-based modules
        const editableTypes = ['text', 'heading', 'quote'];
        if (!editableTypes.includes(module.type)) return;

        const contentEl = moduleElement.querySelector('.tb4-module-content');
        if (!contentEl) return;

        contentEl.contentEditable = true;
        contentEl.focus();

        const saveInline = () => {
            contentEl.contentEditable = false;

            if (module.type === 'text') {
                module.content.text = contentEl.innerHTML;
            } else if (module.type === 'heading') {
                const heading = contentEl.querySelector('.tb4-heading');
                if (heading) {
                    module.content.text = heading.textContent;
                }
            } else if (module.type === 'quote') {
                const quote = contentEl.querySelector('p');
                if (quote) {
                    module.content.text = quote.textContent;
                }
            }

            this.state.isDirty = true;
            this.pushHistory();
        };

        contentEl.addEventListener('blur', saveInline, { once: true });
        contentEl.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                contentEl.blur();
            }
        });
    },

    // ==========================================================================
    // KEYBOARD SHORTCUTS
    // ==========================================================================

    /**
     * Initialize keyboard shortcuts
     */
    initKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input
            if (e.target.matches('input, textarea, [contenteditable="true"]')) {
                return;
            }

            // Ctrl/Cmd + S: Save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                this.save();
            }

            // Ctrl/Cmd + Z: Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                this.undo();
            }

            // Ctrl/Cmd + Y or Ctrl/Cmd + Shift + Z: Redo
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                this.redo();
            }

            // Delete/Backspace: Remove selected
            if ((e.key === 'Delete' || e.key === 'Backspace') && this.state.selected) {
                e.preventDefault();
                this.deleteElement(this.state.selected);
            }

            // Ctrl/Cmd + D: Duplicate
            if ((e.ctrlKey || e.metaKey) && e.key === 'd' && this.state.selected) {
                e.preventDefault();
                this.duplicateElement(this.state.selected);
            }

            // Escape: Deselect
            if (e.key === 'Escape') {
                this.deselectAll();
            }
        });
    },

    // ==========================================================================
    // HISTORY (UNDO/REDO)
    // ==========================================================================

    /**
     * Push current state to history
     */
    pushHistory() {
        // Remove any future history if we're not at the end
        if (this.state.historyIndex < this.state.history.length - 1) {
            this.state.history = this.state.history.slice(0, this.state.historyIndex + 1);
        }

        // Add current state
        const snapshot = this.deepClone(this.state.content);
        this.state.history.push(snapshot);

        // Limit history size
        if (this.state.history.length > this.state.maxHistory) {
            this.state.history.shift();
        }

        this.state.historyIndex = this.state.history.length - 1;
        this.updateHistoryButtons();
    },

    /**
     * Undo last change
     */
    undo() {
        if (this.state.historyIndex <= 0) return;

        this.state.historyIndex--;
        this.state.content = this.deepClone(this.state.history[this.state.historyIndex]);
        this.state.isDirty = true;
        this.renderCanvas();
        this.updateHistoryButtons();

        // Update settings if something is selected
        if (this.state.selected) {
            this.showSettings(this.state.selected, this.state.selectedType);
        }
    },

    /**
     * Redo last undone change
     */
    redo() {
        if (this.state.historyIndex >= this.state.history.length - 1) return;

        this.state.historyIndex++;
        this.state.content = this.deepClone(this.state.history[this.state.historyIndex]);
        this.state.isDirty = true;
        this.renderCanvas();
        this.updateHistoryButtons();

        // Update settings if something is selected
        if (this.state.selected) {
            this.showSettings(this.state.selected, this.state.selectedType);
        }
    },

    /**
     * Update undo/redo button states
     */
    updateHistoryButtons() {
        const undoBtn = this.dom.toolbar?.querySelector('[data-action="undo"]');
        const redoBtn = this.dom.toolbar?.querySelector('[data-action="redo"]');

        if (undoBtn) {
            undoBtn.disabled = this.state.historyIndex <= 0;
        }
        if (redoBtn) {
            redoBtn.disabled = this.state.historyIndex >= this.state.history.length - 1;
        }
    },

    // ==========================================================================
    // API INTEGRATION
    // ==========================================================================

    /**
     * Save content to server
     */
    async save() {
        if (this.state.isLoading) return;

        this.state.isLoading = true;
        this.updateSaveButton('Saving...');

        try {
            const response = await fetch(`${this.config.apiUrl}?action=save_page_content`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': this.config.csrfToken
                },
                body: JSON.stringify({
                    page_id: this.config.pageId,
                    content_type: this.config.contentType,
                    content: this.state.content,
                    csrf_token: this.config.csrfToken
                })
            });

            const result = await response.json();

            if (result.success) {
                this.state.isDirty = false;
                this.showNotification('Saved successfully', 'success');
            } else {
                throw new Error(result.message || 'Save failed');
            }
        } catch (error) {
            console.error('Save error:', error);
            this.showNotification('Failed to save: ' + error.message, 'error');
        } finally {
            this.state.isLoading = false;
            this.updateSaveButton('Save');
        }
    },

    /**
     * Load content from server or provided data
     */
    loadContent(content) {
        console.log('[TB4] loadContent() called with:', typeof content);

        if (typeof content === 'string') {
            try {
                content = JSON.parse(content);
            } catch {
                console.error('Failed to parse content JSON');
                return;
            }
        }

        // Ensure content is a valid object with sections array
        if (!content || typeof content !== 'object') {
            content = { sections: [] };
        }

        // Ensure sections array exists
        if (!content.sections || !Array.isArray(content.sections)) {
            content.sections = [];
        }

        this.state.content = content;
        this.state.isDirty = false;
        this.state.history = [this.deepClone(this.state.content)];
        this.state.historyIndex = 0;

        console.log('[TB4] Content loaded with', this.state.content.sections.length, 'sections');

        this.renderCanvas();
        this.updateHistoryButtons();
    },

    /**
     * Start auto-save timer
     */
    startAutoSave() {
        if (this.state.autoSaveTimer) {
            clearInterval(this.state.autoSaveTimer);
        }

        this.state.autoSaveTimer = setInterval(() => {
            if (this.state.isDirty && !this.state.isLoading) {
                this.saveDraft();
            }
        }, this.state.autoSaveInterval);
    },

    /**
     * Save draft to server
     */
    async saveDraft() {
        try {
            await fetch(`${this.config.apiUrl}?action=save_draft`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': this.config.csrfToken
                },
                body: JSON.stringify({
                    page_id: this.config.pageId,
                    content: this.state.content,
                    csrf_token: this.config.csrfToken
                })
            });
            console.log('Draft auto-saved');
        } catch (error) {
            console.error('Auto-save failed:', error);
        }
    },

    /**
     * Preview the page
     */
    preview() {
        // Open preview in new window
        const previewUrl = `${this.config.apiUrl}/preview?id=${this.config.pageId}`;
        window.open(previewUrl, '_blank');
    },

    /**
     * Update save button text
     */
    updateSaveButton(text) {
        const saveBtn = this.dom.toolbar?.querySelector('[data-action="save"]');
        if (saveBtn) {
            saveBtn.textContent = text;
        }
    },

    // ==========================================================================
    // MEDIA PICKER
    // ==========================================================================

    /**
     * Open media picker
     */
    openMediaPicker(fieldName) {
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'tb4-modal tb4-media-picker-modal';
        modal.innerHTML = `
            <div class="tb4-modal-content">
                <div class="tb4-modal-header">
                    <h3>Select Image</h3>
                    <button type="button" class="tb4-modal-close" onclick="this.closest('.tb4-modal').remove()">√ó</button>
                </div>
                <div class="tb4-modal-body">
                    <div class="tb4-media-tabs">
                        <button type="button" class="tb4-media-tab active" data-tab="upload">Upload</button>
                        <button type="button" class="tb4-media-tab" data-tab="library">Media Library</button>
                        <button type="button" class="tb4-media-tab" data-tab="url">External URL</button>
                    </div>
                    <div class="tb4-media-content" data-content="upload">
                        <div class="tb4-upload-area">
                            <input type="file" accept="image/*" id="tb4-image-upload"/>
                            <label for="tb4-image-upload">
                                <span>Drop image here or click to upload</span>
                            </label>
                        </div>
                    </div>
                    <div class="tb4-media-content" data-content="library" style="display:none;">
                        <div class="tb4-media-grid" id="tb4-media-grid">
                            <p>Loading media library...</p>
                        </div>
                    </div>
                    <div class="tb4-media-content" data-content="url" style="display:none;">
                        <input type="text" class="tb4-input" placeholder="Enter image URL" id="tb4-image-url"/>
                        <button type="button" class="tb4-btn tb4-btn-primary" onclick="TB4Builder.insertImageUrl('${fieldName}')">Insert</button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Tab switching
        modal.querySelectorAll('.tb4-media-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                modal.querySelectorAll('.tb4-media-tab').forEach(t => t.classList.remove('active'));
                modal.querySelectorAll('.tb4-media-content').forEach(c => c.style.display = 'none');
                tab.classList.add('active');
                modal.querySelector(`[data-content="${tab.dataset.tab}"]`).style.display = 'block';

                if (tab.dataset.tab === 'library') {
                    this.loadMediaLibrary();
                }
            });
        });

        // File upload
        const fileInput = modal.querySelector('#tb4-image-upload');
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                this.uploadImage(e.target.files[0], fieldName, modal);
            }
        });

        // Store current field name
        modal.dataset.fieldName = fieldName;
    },

    /**
     * Load media library
     */
    async loadMediaLibrary() {
        const grid = document.getElementById('tb4-media-grid');
        if (!grid) return;

        try {
            const response = await fetch(`${this.config.apiUrl}/media?limit=50`, {
                headers: {
                    'X-CSRF-Token': this.config.csrfToken
                }
            });
            const result = await response.json();

            if (result.success && result.data) {
                let html = '';
                result.data.forEach(item => {
                    html += `
                        <div class="tb4-media-item" onclick="TB4Builder.selectMediaItem('${item.url}')">
                            <img src="${this.escapeHtml(item.thumbnail || item.url)}" alt="${this.escapeHtml(item.name)}"/>
                        </div>
                    `;
                });
                grid.innerHTML = html || '<p>No images found</p>';
            }
        } catch (error) {
            grid.innerHTML = '<p>Failed to load media library</p>';
        }
    },

    /**
     * Upload an image
     */
    async uploadImage(file, fieldName, modal) {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('csrf_token', this.config.csrfToken);

        try {
            const response = await fetch(`${this.config.apiUrl}/upload`, {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': this.config.csrfToken
                },
                body: formData
            });

            const result = await response.json();

            if (result.success && result.url) {
                this.setFieldValue(fieldName, result.url);
                modal.remove();
            } else {
                throw new Error(result.message || 'Upload failed');
            }
        } catch (error) {
            this.showNotification('Upload failed: ' + error.message, 'error');
        }
    },

    /**
     * Select media item from library
     */
    selectMediaItem(url) {
        const modal = document.querySelector('.tb4-media-picker-modal');
        if (modal) {
            const fieldName = modal.dataset.fieldName;
            this.setFieldValue(fieldName, url);
            modal.remove();
        }
    },

    /**
     * Insert image from URL
     */
    insertImageUrl(fieldName) {
        const urlInput = document.getElementById('tb4-image-url');
        if (urlInput && urlInput.value) {
            this.setFieldValue(fieldName, urlInput.value);
            document.querySelector('.tb4-media-picker-modal')?.remove();
        }
    },

    /**
     * Clear image field
     */
    clearImage(fieldName) {
        this.setFieldValue(fieldName, '');
    },

    /**
     * Set a field value and trigger update
     */
    setFieldValue(fieldName, value) {
        const input = this.dom.settingsPanel?.querySelector(`[name="${fieldName}"]`);
        if (input) {
            input.value = value;
            input.dispatchEvent(new Event('change', { bubbles: true }));
        }
    },

    // ==========================================================================
    // ICON PICKER
    // ==========================================================================

    /**
     * Open icon picker - uses Lucide icons matching getIconSvgPath()
     */
    openIconPicker(fieldName) {
        // Lucide icon names matching getIconSvgPath()
        const icons = [
            'star', 'heart', 'check', 'x', 'plus', 'minus',
            'search', 'menu', 'settings', 'home', 'user',
            'arrow-right', 'arrow-left', 'mail', 'phone', 'map-pin',
            'globe', 'clock', 'calendar', 'link', 'eye',
            'bell', 'lock', 'shield', 'check-circle', 'alert-circle',
            'info', 'zap', 'award', 'coffee', 'smile',
            'rocket', 'flame', 'lightbulb', 'target', 'image',
            'video', 'music', 'play', 'share', 'download', 'upload'
        ];

        const self = this;
        const modal = document.createElement('div');
        modal.className = 'tb4-modal tb4-icon-picker-modal';
        modal.innerHTML = `
            <div class="tb4-modal-content">
                <div class="tb4-modal-header">
                    <h3>Select Icon</h3>
                    <button type="button" class="tb4-modal-close" onclick="this.closest('.tb4-modal').remove()">√ó</button>
                </div>
                <div class="tb4-modal-body">
                    <div class="tb4-icon-grid">
                        ${icons.map(icon => `
                            <button type="button" class="tb4-icon-option" data-icon="${icon}" onclick="TB4Builder.selectIcon('${fieldName}', '${icon}')" title="${icon}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    ${self.getIconSvgPath(icon)}
                                </svg>
                            </button>
                        `).join('')}
                    </div>
                    <div class="tb4-icon-custom">
                        <input type="text" class="tb4-input" placeholder="Or enter icon name (e.g., star, heart)" id="tb4-custom-icon"/>
                        <button type="button" class="tb4-btn tb4-btn-sm" onclick="TB4Builder.selectIcon('${fieldName}', document.getElementById('tb4-custom-icon').value)">Use</button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    },

    /**
     * Select an icon
     */
    selectIcon(fieldName, iconClass) {
        this.setFieldValue(fieldName, iconClass);
        document.querySelector('.tb4-icon-picker-modal')?.remove();
    },

    // ==========================================================================
    // UTILITY FUNCTIONS
    // ==========================================================================

    /**
     * Generate unique ID
     */
    generateId() {
        return 'tb4_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
    },

    /**
     * Deep clone an object
     */
    deepClone(obj) {
        return JSON.parse(JSON.stringify(obj));
    },

    /**
     * Regenerate IDs for cloned element
     */
    regenerateIds(element) {
        element.id = this.generateId();

        if (element.rows) {
            element.rows.forEach(row => this.regenerateIds(row));
        }
        if (element.columns) {
            element.columns.forEach(col => this.regenerateIds(col));
        }
        if (element.modules) {
            element.modules.forEach(mod => this.regenerateIds(mod));
        }
    },

    /**
     * Find element by ID in content tree
     */
    findElement(elementId) {
        return this.searchElement(this.state.content.sections, elementId);
    },

    /**
     * Recursively search for element
     */
    searchElement(items, elementId) {
        if (!items) return null;

        for (const item of items) {
            if (item.id === elementId) return item;

            if (item.rows) {
                const found = this.searchElement(item.rows, elementId);
                if (found) return found;
            }
            if (item.columns) {
                const found = this.searchElement(item.columns, elementId);
                if (found) return found;
            }
            if (item.modules) {
                const found = this.searchElement(item.modules, elementId);
                if (found) return found;
            }
        }

        return null;
    },

    /**
     * Find parent of element
     */
    findParent(elementId) {
        return this.searchParent(this.state.content.sections, elementId, null);
    },

    /**
     * Recursively search for parent
     */
    searchParent(items, elementId, parent) {
        if (!items) return null;

        for (const item of items) {
            if (item.id === elementId) return parent;

            if (item.rows) {
                const found = this.searchParent(item.rows, elementId, item);
                if (found) return found;
            }
            if (item.columns) {
                const found = this.searchParent(item.columns, elementId, item);
                if (found) return found;
            }
            if (item.modules) {
                const found = this.searchParent(item.modules, elementId, item);
                if (found) return found;
            }
        }

        return null;
    },

    /**
     * Escape HTML entities
     */
    escapeHtml(str) {
        if (typeof str !== 'string') return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    },

    /**
     * Get Lucide icon SVG path by name
     * Subset of icons matching the PHP iconmodule.php
     */
    getIconSvgPath(name) {
        const icons = {
            'heart': '<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>',
            'star': '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
            'check': '<path d="M20 6 9 17l-5-5"/>',
            'x': '<path d="M18 6 6 18"/><path d="m6 6 12 12"/>',
            'plus': '<path d="M5 12h14"/><path d="M12 5v14"/>',
            'minus': '<path d="M5 12h14"/>',
            'search': '<circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>',
            'menu': '<line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>',
            'settings': '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>',
            'home': '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
            'user': '<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
            'arrow-right': '<path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>',
            'arrow-left': '<path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>',
            'mail': '<rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>',
            'phone': '<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>',
            'map-pin': '<path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>',
            'globe': '<circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/>',
            'clock': '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
            'calendar': '<rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/>',
            'link': '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>',
            'eye': '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>',
            'bell': '<path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>',
            'lock': '<rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
            'shield': '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>',
            'check-circle': '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
            'alert-circle': '<circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/>',
            'info': '<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>',
            'zap': '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
            'award': '<circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/>',
            'coffee': '<path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/>',
            'smile': '<circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/>',
            'rocket': '<path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/>',
            'flame': '<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>',
            'lightbulb': '<path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/>',
            'target': '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>',
            'image': '<rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>',
            'video': '<path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/>',
            'music': '<path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>',
            'play': '<polygon points="5 3 19 12 5 21 5 3"/>',
            'share': '<circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/>',
            'download': '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>',
            'upload': '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>'
        };
        return icons[name] || icons['star'];
    },

    /**
     * Build inline styles from settings
     */
    buildInlineStyles(settings) {
        const styles = [];

        if (settings.backgroundColor) {
            styles.push(`background-color: ${settings.backgroundColor}`);
        }
        if (settings.backgroundImage) {
            styles.push(`background-image: url('${settings.backgroundImage}')`);
            styles.push('background-size: cover');
            styles.push('background-position: center');
        }
        if (settings.padding) {
            const p = settings.padding;
            styles.push(`padding: ${p.top || 0}px ${p.right || 0}px ${p.bottom || 0}px ${p.left || 0}px`);
        }
        if (settings.margin) {
            const m = settings.margin;
            styles.push(`margin: ${m.top || 0}px ${m.right || 0}px ${m.bottom || 0}px ${m.left || 0}px`);
        }
        if (settings.borderWidth) {
            styles.push(`border-width: ${settings.borderWidth}px`);
            styles.push('border-style: solid');
        }
        if (settings.borderColor) {
            styles.push(`border-color: ${settings.borderColor}`);
        }
        if (settings.borderRadius) {
            styles.push(`border-radius: ${settings.borderRadius}px`);
        }

        return styles.join('; ');
    },

    /**
     * Show notification
     */
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `tb4-notification tb4-notification-${type}`;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => notification.classList.add('show'), 10);

        // Remove after delay
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    },

    /**
     * Get export data
     */
    getExportData() {
        return {
            version: '1.0',
            content: this.state.content,
            timestamp: new Date().toISOString()
        };
    },

    /**
     * Import data
     */

    // ==========================================================================
    // LAYOUT PICKER
    // ==========================================================================

    /**
     * Show layout picker modal for adding new row
     */
    showLayoutPicker(sectionId) {
        this.state.pendingRowSectionId = sectionId;
        this.state.pendingChangeLayoutRowId = null;
        const modal = document.getElementById('layoutPickerModal');
        if (modal) {
            modal.classList.add('active');
        }
    },

    /**
     * Show layout picker modal for changing existing row layout
     */
    showLayoutPickerForRow(rowId) {
        this.state.pendingRowSectionId = null;
        this.state.pendingChangeLayoutRowId = rowId;
        const modal = document.getElementById('layoutPickerModal');
        if (modal) {
            modal.classList.add('active');
        }
    },

    /**
     * Hide layout picker modal
     */
    hideLayoutPicker() {
        const modal = document.getElementById('layoutPickerModal');
        if (modal) {
            modal.classList.remove('active');
        }
        this.state.pendingRowSectionId = null;
        this.state.pendingChangeLayoutRowId = null;
    },

    /**
     * Initialize layout picker click handlers
     */
    initLayoutPicker() {
        const modal = document.getElementById('layoutPickerModal');
        if (!modal) return;

        // Close on backdrop click
        const backdrop = modal.querySelector('.tb4-layout-modal-backdrop');
        if (backdrop) {
            backdrop.addEventListener('click', () => this.hideLayoutPicker());
        }

        // Handle layout choice clicks
        modal.querySelectorAll('.tb4-layout-choice').forEach(btn => {
            btn.addEventListener('click', () => {
                const layout = btn.dataset.layout;
                if (this.state.pendingRowSectionId) {
                    // Adding new row
                    this.addRowWithLayout(this.state.pendingRowSectionId, layout);
                } else if (this.state.pendingChangeLayoutRowId) {
                    // Changing existing row layout
                    this.changeRowLayout(this.state.pendingChangeLayoutRowId, layout);
                }
                this.hideLayoutPicker();
            });
        });

        console.log('[TB4] Layout picker initialized');
    },
    importData(data) {
        if (data && data.content) {
            this.loadContent(data.content);
            this.pushHistory();
        }
    }
};

// ==========================================================================
// AUTO-INITIALIZE
// ==========================================================================

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => TB4Builder.init());
} else {
    TB4Builder.init();
}

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', (e) => {
    if (TB4Builder.state.isDirty) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    }
});

// Export for module systems
if (typeof module !== 'undefined' && module.exports) {
    module.exports = TB4Builder;
}
