# CMS Root .htaccess
# Main routing for CMS with MVC integration

Options +FollowSymLinks
DirectoryIndex index.php
DirectorySlash Off

RewriteEngine On
RewriteBase /

# Block access to sensitive directories
RewriteRule ^(app|core|config|storage|modules)/.*$ - [F,L]
RewriteRule ^vendor/.*$ - [F,L]

# Static assets
RewriteRule ^assets/(.*)$ public/assets/$1 [L]
RewriteRule ^favicon\.ico$ public/favicon.ico [L]
RewriteRule ^robots\.txt$ public/robots.txt [L]

# ============================================================
# CENTRAL PREVIEW SYSTEM
# ============================================================
# Legacy TB preview format (used by Theme Builder panel)
RewriteRule ^tb-preview/([^/]+)/?$ preview.php?type=tb&slug=$1 [QSA,L]
# /preview/tb/26 -> preview.php?type=tb&id=26
RewriteRule ^preview/tb/([0-9]+)/?$ preview.php?type=tb&id=$1 [QSA,L]
# /preview/tb/slug/test-page -> preview.php?type=tb&slug=test-page
RewriteRule ^preview/tb/slug/([^/]+)/?$ preview.php?type=tb&slug=$1 [QSA,L]
# /preview/page/3 -> preview.php?type=page&id=3
RewriteRule ^preview/page/([0-9]+)/?$ preview.php?type=page&id=$1 [QSA,L]
# /preview/page/slug/about -> preview.php?type=page&slug=about
RewriteRule ^preview/page/slug/([^/]+)/?$ preview.php?type=page&slug=$1 [QSA,L]
# /preview/article/5 -> preview.php?type=article&id=5
RewriteRule ^preview/article/([0-9]+)/?$ preview.php?type=article&id=$1 [QSA,L]
# /preview/template/1 -> preview.php?type=template&id=1
RewriteRule ^preview/template/([0-9]+)/?$ preview.php?type=template&id=$1 [QSA,L]

# ============================================================
# MVC ADMIN ROUTES - Route to index.php for MVC controller handling
# These take priority over legacy .php files
# ============================================================

# Auth routes - use legacy login (better UI)
RewriteRule ^admin/login/?$ admin/login.php [QSA,L]
RewriteRule ^admin/logout/?$ admin/logout.php [QSA,L]

# Dashboard (root admin)
RewriteRule ^admin/?$ index.php [QSA,L]
RewriteRule ^admin/dashboard/?$ index.php [QSA,L]

# Pages CRUD
RewriteRule ^admin/pages/?$ index.php [QSA,L]
RewriteRule ^admin/pages/create/?$ index.php [QSA,L]
RewriteRule ^admin/pages/([0-9]+)/?$ index.php [QSA,L]
RewriteRule ^admin/pages/([0-9]+)/edit/?$ index.php [QSA,L]
RewriteRule ^admin/pages/([0-9]+)/delete/?$ index.php [QSA,L]

# Articles CRUD - MVC
RewriteRule ^admin/articles/?$ index.php [QSA,L]
RewriteRule ^admin/articles/create/?$ index.php [QSA,L]
RewriteRule ^admin/articles/([0-9]+)/edit/?$ index.php [QSA,L]
RewriteRule ^admin/articles/([0-9]+)/?$ index.php [QSA,L]
RewriteRule ^admin/articles/([0-9]+)/delete/?$ index.php [QSA,L]

# Categories CRUD
RewriteRule ^admin/categories/?$ index.php [QSA,L]
RewriteRule ^admin/categories/create/?$ index.php [QSA,L]
RewriteRule ^admin/categories/([0-9]+)/?$ index.php [QSA,L]
RewriteRule ^admin/categories/([0-9]+)/edit/?$ index.php [QSA,L]
RewriteRule ^admin/categories/([0-9]+)/delete/?$ index.php [QSA,L]

# Users CRUD
RewriteRule ^admin/users/?$ index.php [QSA,L]
RewriteRule ^admin/users/create/?$ index.php [QSA,L]
RewriteRule ^admin/users/([0-9]+)/?$ index.php [QSA,L]
RewriteRule ^admin/users/([0-9]+)/edit/?$ index.php [QSA,L]
RewriteRule ^admin/users/([0-9]+)/delete/?$ index.php [QSA,L]

# Comments moderation
RewriteRule ^admin/comments/?$ index.php [QSA,L]
RewriteRule ^admin/comments/([0-9]+)/(approve|spam|trash|restore|delete)/?$ index.php [QSA,L]
RewriteRule ^admin/comments/bulk/?$ index.php [QSA,L]

# Menus CRUD
RewriteRule ^admin/menus/?$ index.php [QSA,L]
RewriteRule ^admin/menus/create/?$ index.php [QSA,L]
RewriteRule ^admin/menus/([0-9]+)/?$ index.php [QSA,L]
RewriteRule ^admin/menus/([0-9]+)/edit/?$ index.php [QSA,L]
RewriteRule ^admin/menus/([0-9]+)/delete/?$ index.php [QSA,L]
RewriteRule ^admin/menus/([0-9]+)/items/?$ index.php [QSA,L]
RewriteRule ^admin/menus/([0-9]+)/items/([0-9]+)/delete/?$ index.php [QSA,L]
RewriteRule ^admin/menus/([0-9]+)/items/reorder/?$ index.php [QSA,L]

# Widgets CRUD
RewriteRule ^admin/widgets/?$ index.php [QSA,L]
RewriteRule ^admin/widgets/create/?$ index.php [QSA,L]
RewriteRule ^admin/widgets/([0-9]+)/?$ index.php [QSA,L]
RewriteRule ^admin/widgets/([0-9]+)/edit/?$ index.php [QSA,L]
RewriteRule ^admin/widgets/([0-9]+)/toggle/?$ index.php [QSA,L]
RewriteRule ^admin/widgets/([0-9]+)/delete/?$ index.php [QSA,L]

# Galleries CRUD
RewriteRule ^admin/galleries/?$ index.php [QSA,L]
RewriteRule ^admin/galleries/create/?$ index.php [QSA,L]
RewriteRule ^admin/galleries/([0-9]+)/?$ index.php [QSA,L]
RewriteRule ^admin/galleries/([0-9]+)/edit/?$ index.php [QSA,L]
RewriteRule ^admin/galleries/([0-9]+)/delete/?$ index.php [QSA,L]
RewriteRule ^admin/galleries/([0-9]+)/images/?$ index.php [QSA,L]
RewriteRule ^admin/galleries/([0-9]+)/images/([0-9]+)/delete/?$ index.php [QSA,L]

# Logs viewer
RewriteRule ^admin/logs/?$ index.php [QSA,L]
RewriteRule ^admin/logs/clear/?$ index.php [QSA,L]
RewriteRule ^admin/logs/files/?$ index.php [QSA,L]
RewriteRule ^admin/logs/view/?$ index.php [QSA,L]

# URL Redirects
RewriteRule ^admin/urls/?$ index.php [QSA,L]
RewriteRule ^admin/urls/create/?$ index.php [QSA,L]
RewriteRule ^admin/urls/([0-9]+)/?$ index.php [QSA,L]
RewriteRule ^admin/urls/([0-9]+)/edit/?$ index.php [QSA,L]
RewriteRule ^admin/urls/([0-9]+)/toggle/?$ index.php [QSA,L]
RewriteRule ^admin/urls/([0-9]+)/delete/?$ index.php [QSA,L]

# Search
RewriteRule ^admin/search/?$ index.php [QSA,L]
RewriteRule ^admin/search/analytics/?$ index.php [QSA,L]
RewriteRule ^admin/search/clear/?$ index.php [QSA,L]

# Backup
RewriteRule ^admin/backup/?$ index.php [QSA,L]
RewriteRule ^admin/backup/([0-9]+)/download/?$ index.php [QSA,L]
RewriteRule ^admin/backup/([0-9]+)/delete/?$ index.php [QSA,L]
RewriteRule ^admin/backup/cleanup/?$ index.php [QSA,L]

# Content blocks
RewriteRule ^admin/content/?$ index.php [QSA,L]
RewriteRule ^admin/content/create/?$ index.php [QSA,L]
RewriteRule ^admin/content/([0-9]+)/?$ index.php [QSA,L]
RewriteRule ^admin/content/([0-9]+)/edit/?$ index.php [QSA,L]
RewriteRule ^admin/content/([0-9]+)/toggle/?$ index.php [QSA,L]
RewriteRule ^admin/content/([0-9]+)/delete/?$ index.php [QSA,L]

# Extensions
RewriteRule ^admin/plugins/?$ index.php [QSA,L]
RewriteRule ^admin/plugins/install/?$ index.php [QSA,L]
RewriteRule ^admin/plugins/([a-zA-Z0-9_-]+)/toggle/?$ index.php [QSA,L]
RewriteRule ^admin/plugins/([a-zA-Z0-9_-]+)/uninstall/?$ index.php [QSA,L]
RewriteRule ^admin/plugins/([a-zA-Z0-9_-]+)/settings/?$ index.php [QSA,L]

# Migrations
RewriteRule ^admin/migrations/?$ index.php [QSA,L]
RewriteRule ^admin/migrations/run/?$ index.php [QSA,L]
RewriteRule ^admin/migrations/run-single/?$ index.php [QSA,L]
RewriteRule ^admin/migrations/rollback/?$ index.php [QSA,L]
RewriteRule ^admin/migrations/create/?$ index.php [QSA,L]

# Maintenance
RewriteRule ^admin/maintenance/?$ index.php [QSA,L]
RewriteRule ^admin/maintenance/toggle/?$ index.php [QSA,L]
RewriteRule ^admin/maintenance/update/?$ index.php [QSA,L]
RewriteRule ^admin/maintenance/add-ip/?$ index.php [QSA,L]
RewriteRule ^admin/maintenance/remove-ip/?$ index.php [QSA,L]

# Email Queue
RewriteRule ^admin/email-queue/?$ index.php [QSA,L]
RewriteRule ^admin/email-queue/compose/?$ index.php [QSA,L]
RewriteRule ^admin/email-queue/send/?$ index.php [QSA,L]
RewriteRule ^admin/email-queue/([0-9]+)/?$ index.php [QSA,L]
RewriteRule ^admin/email-queue/([0-9]+)/retry/?$ index.php [QSA,L]
RewriteRule ^admin/email-queue/([0-9]+)/delete/?$ index.php [QSA,L]
RewriteRule ^admin/email-queue/bulk/?$ index.php [QSA,L]
RewriteRule ^admin/email-queue/clear/?$ index.php [QSA,L]

# Notifications (MVC)
RewriteRule ^admin/notifications/?$ index.php [QSA,L]
RewriteRule ^admin/notifications/mark-all-read/?$ index.php [QSA,L]
RewriteRule ^admin/notifications/delete/?$ index.php [QSA,L]
RewriteRule ^admin/notifications/clear-all/?$ index.php [QSA,L]

# Media Library
RewriteRule ^admin/media/?$ index.php [QSA,L]
RewriteRule ^admin/media/upload/?$ index.php [QSA,L]
RewriteRule ^admin/media/([0-9]+)/?$ index.php [QSA,L]
RewriteRule ^admin/media/([0-9]+)/edit/?$ index.php [QSA,L]
RewriteRule ^admin/media/([0-9]+)/delete/?$ index.php [QSA,L]
RewriteRule ^admin/media/bulk-delete/?$ index.php [QSA,L]

# Themes (MVC)
RewriteRule ^admin/themes/?$ index.php [QSA,L]
RewriteRule ^admin/themes/activate/?$ index.php [QSA,L]

# Theme Builder 3.0 (MVC)
RewriteRule ^admin/theme-builder/?$ index.php [QSA,L]
RewriteRule ^admin/theme-builder/create/?$ index.php [QSA,L]
RewriteRule ^admin/theme-builder/([0-9]+)/edit/?$ index.php [QSA,L]
RewriteRule ^admin/theme-builder/page/([0-9]+)/edit/?$ index.php [QSA,L]
RewriteRule ^admin/theme-builder/save/?$ index.php [QSA,L]
RewriteRule ^admin/theme-builder/([0-9]+)/content/?$ index.php [QSA,L]
RewriteRule ^admin/theme-builder/modules/?$ index.php [QSA,L]
RewriteRule ^admin/theme-builder/revision/([0-9]+)/?$ index.php [QSA,L]
RewriteRule ^admin/theme-builder/revision/restore/?$ index.php [QSA,L]
RewriteRule ^admin/theme-builder/preview/?$ index.php [QSA,L]
RewriteRule ^admin/theme-builder/([0-9]+)/delete/?$ index.php [QSA,L]

# ============================================================
# LEGACY ADMIN ROUTES - Serve .php files directly
# For AI tools, SEO, n8n, analytics, etc. without MVC equivalent
# ============================================================

# IMPORTANT: These must come BEFORE the directory check
# Redirect clean URLs to legacy .php files (even if folder exists)
RewriteRule ^admin/ai-seo-assistant/?$ admin/ai-seo-assistant.php [L]
RewriteRule ^admin/ai-seo-pages/?$ admin/ai-seo-pages.php [L]
RewriteRule ^admin/ai-seo-articles/?$ admin/ai-seo-articles.php [L]
RewriteRule ^admin/ai-seo-keywords/?$ admin/ai-seo-keywords.php [L]
RewriteRule ^admin/ai-seo-reports/?$ admin/ai-seo-reports.php [L]
RewriteRule ^admin/ai-seo-dashboard/?$ admin/ai-seo-dashboard.php [L]
RewriteRule ^admin/ai-seo-competitors/?$ admin/ai-seo-competitors.php [L]
RewriteRule ^admin/ai-seo-research/?$ admin/ai-seo-research.php [L]
RewriteRule ^admin/ai-seo-linking/?$ admin/ai-seo-linking.php [L]
RewriteRule ^admin/ai-seo-brief/?$ admin/ai-seo-brief.php [L]
RewriteRule ^admin/ai-seo-decay/?$ admin/ai-seo-decay.php [L]
RewriteRule ^admin/ai-seo-schema/?$ admin/ai-seo-schema.php [L]
RewriteRule ^admin/ai-seo/?$ admin/ai-seo.php [L]
RewriteRule ^admin/ai-copywriter/?$ admin/ai-copywriter.php [L]
RewriteRule ^admin/ai-content-rewrite/?$ admin/ai-content-rewrite.php [L]
RewriteRule ^admin/ai-content-creator/?$ admin/ai-content-creator.php [L]
RewriteRule ^admin/content-quality/?$ admin/content-quality.php [L]
RewriteRule ^admin/ai-content/?$ admin/ai-content.php [L]
RewriteRule ^admin/ai-components/?$ admin/ai-components.php [L]
RewriteRule ^admin/ai-images/?$ admin/ai-images.php [L]
RewriteRule ^admin/ai-translate/?$ admin/ai-translate.php [L]
RewriteRule ^admin/ai-translation/?$ admin/ai-translation.php [L]
RewriteRule ^admin/ai-landing/?$ admin/ai-landing.php [L]
RewriteRule ^admin/ai-landing-generator/?$ admin/ai-landing-generator.php [L]
RewriteRule ^admin/ai-forms/?$ admin/ai-forms.php [L]
RewriteRule ^admin/ai-workflow-generator/?$ admin/ai-workflow-generator.php [L]
RewriteRule ^admin/ai-settings/?$ admin/ai-settings.php [L]
RewriteRule ^admin/ai-alt-generator/?$ admin/ai-alt-generator.php [L]
RewriteRule ^admin/ai-email-automation/?$ admin/ai-email-automation.php [L]
RewriteRule ^admin/ai-email-campaign/?$ admin/ai-email-campaign.php [L]
RewriteRule ^admin/ai-insights/?$ admin/ai-insights.php [L]
RewriteRule ^admin/ai-logs/?$ admin/ai-logs.php [L]
RewriteRule ^admin/ai-plugin-builder/?$ admin/ai-plugin-builder.php [L]
RewriteRule ^admin/ai-student-materials/?$ admin/ai-student-materials.php [L]
RewriteRule ^admin/ai-theme-builder/?$ admin/ai-theme-builder.php [L]
RewriteRule ^admin/ai-toolkit/?$ admin/ai-toolkit.php [L]
RewriteRule ^admin/ai-website-optimizer/?$ admin/ai-website-optimizer.php [L]
RewriteRule ^admin/analytics/?$ admin/analytics.php [L]
RewriteRule ^admin/analytics-dashboard/?$ admin/analytics-dashboard.php [L]
RewriteRule ^admin/settings/?$ admin/settings.php [L]
RewriteRule ^admin/n8n/?$ admin/n8n.php [L]
RewriteRule ^admin/scheduler/?$ admin/scheduler.php [L]
RewriteRule ^admin/scheduler-manager/?$ admin/scheduler_manager.php [L]
RewriteRule ^admin/security/?$ admin/security.php [L]
RewriteRule ^admin/security-audit/?$ admin/security-audit.php [L]
RewriteRule ^admin/security-dashboard/?$ admin/security-dashboard.php [L]
RewriteRule ^admin/seo-dashboard/?$ admin/seo-dashboard.php [L]
RewriteRule ^admin/seo-edit/?$ admin/seo-edit.php [L]
RewriteRule ^admin/seo-metadata/?$ admin/seo-metadata.php [L]
RewriteRule ^admin/seo-redirects/?$ admin/seo-redirects.php [L]
RewriteRule ^admin/seo-robots/?$ admin/seo-robots.php [L]
RewriteRule ^admin/seo-sitemap/?$ admin/seo-sitemap.php [L]
RewriteRule ^admin/seo-url-inspector/?$ admin/seo-url-inspector.php [L]
RewriteRule ^admin/hf-settings/?$ admin/hf-settings.php [L]
RewriteRule ^admin/roadmap-dashboard/?$ admin/roadmap-dashboard.php [L]
RewriteRule ^admin/automations/?$ admin/automations.php [L]
RewriteRule ^admin/automation-rules/?$ admin/automation-rules.php [L]
RewriteRule ^admin/automation-settings/?$ admin/automation-settings.php [L]
RewriteRule ^admin/workflows/?$ admin/workflows.php [L]
RewriteRule ^admin/content-approval/?$ admin/content-approval.php [L]
RewriteRule ^admin/content-suggestions/?$ admin/content-suggestions.php [L]
RewriteRule ^admin/navigation/?$ admin/navigation.php [L]
RewriteRule ^admin/email-campaigns/?$ admin/email-campaigns.php [L]
RewriteRule ^admin/email-settings/?$ admin/email-settings.php [L]
RewriteRule ^admin/notifications-admin/?$ admin/notifications-admin.php [L]
RewriteRule ^admin/n8n-workflows/?$ admin/n8n-workflows.php [L]
RewriteRule ^admin/n8n-workflow-builder/?$ admin/n8n-workflow-builder.php [L]
RewriteRule ^admin/n8n-bindings/?$ admin/n8n-bindings.php [L]
# Modules - MVC
RewriteRule ^admin/modules/?$ index.php [QSA,L]
RewriteRule ^admin/modules/([a-zA-Z0-9_-]+)/?$ index.php [QSA,L]
RewriteRule ^admin/modules/([a-zA-Z0-9_-]+)/toggle/?$ index.php [QSA,L]

# Profile - MVC
RewriteRule ^admin/profile/?$ index.php [QSA,L]
RewriteRule ^admin/profile/update/?$ index.php [QSA,L]
RewriteRule ^admin/profile/password/?$ index.php [QSA,L]
RewriteRule ^admin/profile/password/update/?$ index.php [QSA,L]

RewriteRule ^admin/gdpr-tools/?$ admin/gdpr-tools.php [L]
RewriteRule ^admin/version-control/?$ admin/version-control.php [L]

RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^admin/.*\.php$ - [L]

# Frontend blog routes (must come before directory check)
RewriteRule ^blog/?$ index.php [QSA,L]
RewriteRule ^blog/([a-zA-Z0-9_-]+)/?$ index.php [QSA,L]

# All other non-file/non-dir requests to main index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [QSA,L]

# Block sensitive files
<FilesMatch "\.(env|log|md|json|lock|yml|yaml|ini|sql)$">
    Require all denied
</FilesMatch>

# Block dotfiles
<FilesMatch "^\.">
    Require all denied
</FilesMatch>
