<?php
/**
 * Theme Builder 3.0 - Visual Builder (Full Screen)
 * Three-panel layout: Modules | Canvas | Settings
 */
// DEBUG - check what variables are available
file_put_contents('/tmp/edit_debug.log', date('Y-m-d H:i:s')." EDIT.PHP loaded\n", FILE_APPEND);
file_put_contents('/tmp/edit_debug.log', "modulesJson isset: ".(isset($modulesJson)?'YES':'NO')."\n", FILE_APPEND);
file_put_contents('/tmp/edit_debug.log', "modulesJson length: ".strlen($modulesJson ?? '')."\n", FILE_APPEND);
file_put_contents('/tmp/edit_debug.log', "modules isset: ".(isset($modules)?'YES':'NO')."\n", FILE_APPEND);

if (!defined('CMS_ROOT')) { define('CMS_ROOT', dirname(__DIR__, 5)); }

$pageTitle = esc($page['title'] ?? 'New Page');
$pageId = (int)($page['id'] ?? $pageId ?? 0);
$pageSlug = esc($page['slug'] ?? '');
$pageStatus = $page['status'] ?? 'draft';
// Use pre-encoded JSON from controller if available, otherwise encode from arrays
if (!isset($contentJson) || empty($contentJson)) {
    $contentJson = json_encode($content ?? ['sections' => []], JSON_UNESCAPED_UNICODE);
}
if (!isset($modulesJson) || empty($modulesJson)) {
    $modulesJson = json_encode($modules ?? [], JSON_UNESCAPED_UNICODE);
}
if (!isset($categoriesJson) || empty($categoriesJson)) {
    $categoriesJson = json_encode($categories ?? [], JSON_UNESCAPED_UNICODE);
}
$csrfToken = csrf_token();
?>
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theme Builder - <?= $pageTitle ?></title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icon Libraries for Icon Picker -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined">
    <link rel="stylesheet" href="/assets/css/fontawesome.min.css">
    <style>
    :root {
        --tb-bg: #1e1e2e;
        --tb-surface: #181825;
        --tb-surface-2: #313244;
        --tb-border: #45475a;
        --tb-text: #cdd6f4;
        --tb-text-muted: #6c7086;
        --tb-accent: #89b4fa;
        --tb-accent-hover: #b4befe;
        --tb-success: #a6e3a1;
        --tb-warning: #f9e2af;
        --tb-danger: #f38ba8;
        --tb-panel-width: 280px;
        --tb-toolbar-height: 56px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { 
        height: 100%; 
        overflow: hidden;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        color: var(--tb-text);
        background: var(--tb-surface-2);
    }
    
    /* ═══════════════════════════════════════════════════════════
       TOOLBAR
       ═══════════════════════════════════════════════════════════ */
    .tb-toolbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: var(--tb-toolbar-height);
        background: var(--tb-surface);
        border-bottom: 1px solid var(--tb-border);
        display: flex;
        align-items: center;
        padding: 0 16px;
        gap: 16px;
        z-index: 1000;
    }
    .tb-toolbar-left, .tb-toolbar-center, .tb-toolbar-right {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tb-toolbar-left { flex: 0 0 auto; }
    .tb-toolbar-center { flex: 1; justify-content: center; }
    .tb-toolbar-right { flex: 0 0 auto; }
    
    .tb-logo {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 15px;
    }
    .tb-logo svg { opacity: 0.8; }
    
    .tb-page-title {
        background: transparent;
        border: 1px solid transparent;
        color: var(--tb-text);
        font-size: 15px;
        font-weight: 500;
        padding: 6px 12px;
        border-radius: 6px;
        text-align: center;
        min-width: 200px;
    }
    .tb-page-title:hover { border-color: var(--tb-border); }
    .tb-page-title:focus {
        outline: none;
        border-color: var(--tb-accent);
        background: var(--tb-surface-2);
    }
    
    .tb-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        font-size: 13px;
        font-weight: 500;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.15s;
        background: var(--tb-surface-2);
        color: var(--tb-text);
    }
    .tb-btn:hover { background: var(--tb-border); }
    .tb-btn-primary { background: var(--tb-accent); color: #1e1e2e; }
    .tb-btn-primary:hover { background: var(--tb-accent-hover); }
    .tb-btn-icon {
        padding: 8px;
        background: transparent;
    }
    .tb-btn-icon:hover { background: var(--tb-surface-2); }
    .tb-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .tb-btn-ai {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        margin-top: 8px;
        width: 100%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.15s;
    }
    .tb-btn-ai:hover { opacity: 0.9; transform: translateY(-1px); }
    .tb-btn-ai:disabled { opacity: 0.6; cursor: wait; transform: none; }
    .tb-btn-media { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s; flex: 0 0 auto; }
    .tb-btn-media:hover { opacity: 0.9; transform: translateY(-1px); }

    /* Media Gallery Modal */
    .tb-media-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
    .tb-media-modal.active { display: flex; }
    .tb-media-dialog { background: var(--tb-surface); border-radius: 12px; width: 90%; max-width: 900px; max-height: 80vh; display: flex; flex-direction: column; border: 1px solid var(--tb-border); }
    .tb-media-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--tb-border); display: flex; justify-content: space-between; align-items: center; }
    .tb-media-header h3 { font-size: 1rem; font-weight: 600; color: var(--tb-text); margin: 0; }
    .tb-media-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--tb-text-muted); }
    .tb-media-close:hover { color: var(--tb-text); }
    .tb-media-body { flex: 1; overflow-y: auto; padding: 1.5rem; }
    .tb-media-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--tb-border); display: flex; justify-content: flex-end; gap: 0.75rem; }

    .tb-media-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--tb-border); padding-bottom: 0.75rem; }
    .tb-media-tab { padding: 0.625rem 1rem; background: transparent; color: var(--tb-text-muted); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; }
    .tb-media-tab:hover { color: var(--tb-text); background: rgba(255,255,255,0.05); }
    .tb-media-tab.active { color: var(--tb-accent); background: rgba(137, 180, 250, 0.15); }
    .tb-media-tab-content { display: none; }
    .tb-media-tab-content.active { display: block; }

    .tb-upload-area { border: 2px dashed var(--tb-border); border-radius: 8px; padding: 2rem; text-align: center; transition: all 0.2s; cursor: pointer; }
    .tb-upload-area:hover, .tb-upload-area.dragover { border-color: var(--tb-accent); background: rgba(137, 180, 250, 0.05); }
    .tb-upload-area input { display: none; }

    .tb-media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.75rem; }
    .tb-media-item { aspect-ratio: 1; border: 2px solid var(--tb-border); border-radius: 6px; overflow: hidden; cursor: pointer; transition: all 0.2s; position: relative; }
    .tb-media-item:hover { border-color: var(--tb-accent); }
    .tb-media-item.selected { border-color: var(--tb-accent); box-shadow: 0 0 0 3px rgba(137, 180, 250, 0.3); }
    .tb-media-item img { width: 100%; height: 100%; object-fit: cover; }
    .tb-media-filename { position: absolute; bottom: 0; left: 0; right: 0; padding: 0.25rem; background: rgba(0,0,0,0.7); color: white; font-size: 0.6rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .tb-stock-search { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
    .tb-stock-search input { flex: 1; padding: 0.625rem 1rem; background: var(--tb-surface-2); border: 1px solid var(--tb-border); border-radius: 6px; color: var(--tb-text); }
    .tb-stock-search input:focus { outline: none; border-color: var(--tb-accent); }
    .tb-stock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; }
    .tb-stock-item { aspect-ratio: 4/3; border-radius: 6px; overflow: hidden; cursor: pointer; position: relative; border: 1px solid var(--tb-border); transition: all 0.2s; }
    .tb-stock-item:hover { border-color: var(--tb-accent); }
    .tb-stock-item.selected { border-color: var(--tb-accent); box-shadow: 0 0 0 3px rgba(137, 180, 250, 0.3); }
    .tb-stock-item img { width: 100%; height: 100%; object-fit: cover; }
    .tb-stock-credit { position: absolute; bottom: 0; left: 0; right: 0; padding: 0.25rem 0.5rem; background: linear-gradient(transparent, rgba(0,0,0,0.8)); color: white; font-size: 0.6rem; }
    .tb-stock-loading { text-align: center; padding: 2rem; color: var(--tb-text-muted); }

    /* ═══════════════════════════════════════════════════════════
       LAYOUT LIBRARY MODAL (Divi-style integration)
       ═══════════════════════════════════════════════════════════ */
    .tb-library-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10000;
        background: rgba(0,0,0,0.75);
        align-items: center;
        justify-content: center;
    }
    .tb-library-modal.active { display: flex; }
    .tb-library-dialog {
        background: var(--tb-surface);
        border-radius: 12px;
        width: 90%;
        max-width: 1100px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--tb-border);
        box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    }
    .tb-library-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--tb-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, rgba(137, 180, 250, 0.1), rgba(137, 180, 250, 0.05));
    }
    .tb-library-header h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--tb-text);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .tb-library-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--tb-text-muted);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        transition: all 0.15s;
    }
    .tb-library-close:hover { color: var(--tb-danger); background: rgba(243, 139, 168, 0.1); }
    .tb-library-toolbar {
        padding: 0.75rem 1.5rem;
        border-bottom: 1px solid var(--tb-border);
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
    }
    .tb-library-search {
        flex: 1;
        min-width: 200px;
        padding: 0.5rem 1rem;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 6px;
        color: var(--tb-text);
        font-size: 0.875rem;
    }
    .tb-library-search:focus { outline: none; border-color: var(--tb-accent); }
    .tb-library-filter {
        padding: 0.5rem 0.75rem;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 6px;
        color: var(--tb-text);
        font-size: 0.875rem;
        cursor: pointer;
    }
    .tb-library-body {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }
    .tb-library-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 1rem;
    }
    .tb-library-card {
        background: var(--tb-surface-2);
        border: 2px solid var(--tb-border);
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
    }
    .tb-library-card:hover { border-color: var(--tb-accent); transform: translateY(-2px); }
    .tb-library-card.selected { border-color: var(--tb-accent); box-shadow: 0 0 0 3px rgba(137, 180, 250, 0.3); }
    .tb-library-thumbnail {
        height: 140px;
        background: linear-gradient(135deg, var(--tb-bg) 0%, var(--tb-surface-2) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: var(--tb-text-muted);
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-library-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
    .tb-library-info { padding: 0.875rem; }
    .tb-library-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--tb-text);
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .tb-library-meta {
        display: flex;
        gap: 0.75rem;
        font-size: 0.75rem;
        color: var(--tb-text-muted);
    }
    .tb-library-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.125rem 0.5rem;
        background: rgba(137, 180, 250, 0.15);
        border-radius: 4px;
        font-size: 0.7rem;
        color: var(--tb-accent);
    }
    .tb-library-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--tb-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--tb-surface);
    }
    .tb-library-actions { display: flex; gap: 0.75rem; }
    .tb-library-loading {
        text-align: center;
        padding: 3rem;
        color: var(--tb-text-muted);
    }
    .tb-library-empty {
        text-align: center;
        padding: 3rem;
        color: var(--tb-text-muted);
    }
    /* Page selector within layout */
    .tb-library-pages {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--tb-border);
        background: rgba(137, 180, 250, 0.05);
    }
    .tb-library-pages-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--tb-text-muted);
        margin-bottom: 0.5rem;
    }
    .tb-library-pages-list {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .tb-library-page-btn {
        padding: 0.375rem 0.75rem;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.15s;
    }
    .tb-library-page-btn:hover { border-color: var(--tb-accent); }
    .tb-library-page-btn.active {
        background: var(--tb-accent);
        color: var(--tb-bg);
        border-color: var(--tb-accent);
    }
    /* Insert mode selector */
    .tb-insert-mode {
        display: flex;
        gap: 0.5rem;
        margin-right: auto;
    }
    .tb-insert-mode label {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.5rem 0.75rem;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.15s;
    }
    .tb-insert-mode label:hover { border-color: var(--tb-accent); }
    .tb-insert-mode input[type="radio"] { accent-color: var(--tb-accent); }
    .tb-insert-mode input[type="radio"]:checked + span { color: var(--tb-accent); }

    .tb-ai-gen-form { display: flex; flex-direction: column; gap: 1rem; }
    .tb-ai-gen-prompt { padding: 0.75rem; background: var(--tb-surface-2); border: 1px solid var(--tb-border); border-radius: 6px; color: var(--tb-text); min-height: 80px; resize: vertical; font-family: inherit; }
    .tb-ai-gen-prompt:focus { outline: none; border-color: var(--tb-accent); }
    .tb-ai-gen-options { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .tb-ai-gen-options select { padding: 0.5rem 0.75rem; background: var(--tb-surface-2); border: 1px solid var(--tb-border); border-radius: 6px; color: var(--tb-text); }
    .tb-ai-gen-preview { margin-top: 1rem; }
    .tb-ai-gen-status { text-align: center; padding: 2rem; color: var(--tb-text-muted); }
    .tb-spinner { width: 30px; height: 30px; border: 3px solid var(--tb-border); border-top-color: var(--tb-accent); border-radius: 50%; animation: tb-spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes tb-spin { to { transform: rotate(360deg); } }
    .tb-btn-ai.loading::after {
        content: '';
        width: 12px;
        height: 12px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: tb-spin 0.8s linear infinite;
    }
    @keyframes tb-spin { to { transform: rotate(360deg); } }

    .tb-divider {
        width: 1px;
        height: 24px;
        background: var(--tb-border);
        margin: 0 4px;
    }
    
    /* ═══════════════════════════════════════════════════════════
       MAIN LAYOUT
       ═══════════════════════════════════════════════════════════ */
    .tb-main {
        position: fixed;
        top: var(--tb-toolbar-height);
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
    }
    
    /* ═══════════════════════════════════════════════════════════
       LEFT PANEL - MODULES
       ═══════════════════════════════════════════════════════════ */
    .tb-panel-left {
        width: var(--tb-panel-width);
        background: var(--tb-surface);
        border-right: 1px solid var(--tb-border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .tb-panel-header {
        padding: 16px;
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-panel-title {
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--tb-text-muted);
    }
    .tb-search {
        width: 100%;
        padding: 8px 12px;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 6px;
        color: var(--tb-text);
        font-size: 13px;
        margin-top: 12px;
    }
    .tb-search:focus {
        outline: none;
        border-color: var(--tb-accent);
    }
    .tb-panel-body {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 12px;
    }
    
    .tb-module-category {
        margin-bottom: 16px;
    }
    .tb-category-title {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--tb-text-muted);
        margin-bottom: 8px;
        padding: 0 4px;
    }
    .tb-modules-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    .tb-module-item {
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        padding: 12px 8px;
        text-align: center;
        cursor: grab;
        transition: all 0.15s;
        overflow: hidden;
    }
    .tb-module-item:hover {
        border-color: var(--tb-accent);
        background: var(--tb-surface-2);
    }
    .tb-module-item.dragging {
        opacity: 0.5;
    }
    .tb-module-icon {
        font-size: 20px;
        margin-bottom: 6px;
        pointer-events: none;
    }
    .tb-module-name {
        font-size: 10px;
        font-weight: 500;
        color: var(--tb-text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        pointer-events: none;
    }
    
    /* ═══════════════════════════════════════════════════════════
       CENTER - CANVAS
       ═══════════════════════════════════════════════════════════ */
    .tb-canvas-wrapper {
        flex: 1;
        background: var(--tb-surface-2);
        overflow: auto;
        display: flex;
        flex-direction: column;
    }
    .tb-canvas-toolbar {
        padding: 12px 16px;
        background: var(--tb-surface);
        border-bottom: 1px solid var(--tb-border);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tb-viewport-btns {
        display: flex;
        gap: 4px;
    }
    .tb-viewport-btn {
        padding: 6px 10px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        color: var(--tb-text-muted);
        cursor: pointer;
    }
    .tb-viewport-btn:hover { background: var(--tb-surface-2); }
    .tb-viewport-btn.active {
        background: var(--tb-surface-2);
        border-color: var(--tb-border);
        color: var(--tb-text);
    }
    
    .tb-canvas {
        flex: 1;
        padding: 24px;
        overflow: auto;
    }
    .tb-canvas-inner {
        background: var(--tb-surface-2);
        min-height: 600px;
        border-radius: 8px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.3);
        margin: 0 auto;
        transition: width 0.3s;
        overflow: hidden;
    }
    .tb-canvas-inner.desktop { width: 100%; max-width: 1200px; }
    .tb-canvas-inner.tablet { width: 768px; }
    .tb-canvas-inner.mobile { width: 375px; }
    
    /* Canvas Drop Zones */
    .tb-drop-zone {
        min-height: 120px;
        border: 2px dashed var(--tb-border);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--tb-text-muted);
        margin: 16px;
        transition: all 0.15s;
    }
    .tb-drop-zone:hover, .tb-drop-zone.drag-over {
        border-color: var(--tb-accent);
        background: rgba(137, 180, 250, 0.1);
    }
    .tb-drop-zone-text {
        text-align: center;
    }
    .tb-drop-zone-icon {
        font-size: 32px;
        margin-bottom: 8px;
        opacity: 0.5;
    }
    
    /* ═══════════════════════════════════════════════════════════
       RIGHT PANEL - SETTINGS
       ═══════════════════════════════════════════════════════════ */
    .tb-panel-right {
        width: var(--tb-panel-width);
        background: var(--tb-surface);
        border-left: 1px solid var(--tb-border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .tb-tabs {
        display: flex;
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-tab {
        flex: 1;
        padding: 12px 16px;
        font-size: 13px;
        font-weight: 500;
        text-align: center;
        background: transparent;
        border: none;
        color: var(--tb-text-muted);
        cursor: pointer;
        transition: all 0.15s;
    }
    .tb-tab:hover { color: var(--tb-text); }
    .tb-tab.active {
        color: var(--tb-accent);
        box-shadow: inset 0 -2px 0 var(--tb-accent);
    }

    /* ═══════════════════════════════════════════════════════════
       RESPONSIVE DEVICE TOGGLE (Divi-style)
       ═══════════════════════════════════════════════════════════ */
    .tb-device-toggle {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 8px 12px;
        background: var(--tb-surface-2);
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-device-toggle-label {
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--tb-text-muted);
        margin-right: 8px;
    }
    .tb-device-btn {
        padding: 5px 8px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        color: var(--tb-text-muted);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .tb-device-btn:hover {
        background: var(--tb-surface-2);
        color: var(--tb-text);
    }
    .tb-device-btn.active {
        background: var(--tb-accent);
        color: var(--tb-bg);
        border-color: var(--tb-accent);
    }
    .tb-device-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Responsive input wrapper */
    .tb-responsive-input-wrap {
        position: relative;
    }
    .tb-responsive-indicator {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        gap: 4px;
        pointer-events: none;
    }
    .tb-responsive-icon {
        font-size: 10px;
        opacity: 0.6;
    }
    .tb-responsive-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--tb-text-muted);
    }
    .tb-responsive-dot.has-custom {
        background: var(--tb-accent);
    }
    .tb-responsive-dot.inherited {
        background: transparent;
        border: 1px dashed var(--tb-text-muted);
    }

    /* Responsive input with device icon */
    .tb-input-with-device {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    .tb-input-with-device .tb-device-icon {
        font-size: 12px;
        color: var(--tb-text-muted);
        min-width: 18px;
        text-align: center;
    }
    .tb-input-with-device .tb-device-icon.desktop { color: var(--tb-accent); }
    .tb-input-with-device .tb-device-icon.tablet { color: var(--tb-warning); }
    .tb-input-with-device .tb-device-icon.mobile { color: var(--tb-success); }

    /* Responsive values indicator badge */
    .tb-responsive-badge {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        font-size: 9px;
        padding: 2px 4px;
        border-radius: 3px;
        background: var(--tb-surface-2);
        color: var(--tb-text-muted);
        margin-left: 4px;
    }
    .tb-responsive-badge.has-responsive {
        background: rgba(137, 180, 250, 0.2);
        color: var(--tb-accent);
    }

    .tb-settings-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }
    .tb-setting-group {
        margin-bottom: 20px;
    }
    .tb-setting-label {
        font-size: 12px;
        font-weight: 500;
        color: var(--tb-text-muted);
        margin-bottom: 6px;
    }
    .tb-setting-input {
        width: 100%;
        padding: 8px 10px;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 6px;
        color: var(--tb-text);
        font-size: 13px;
    }
    .tb-setting-input:focus {
        outline: none;
        border-color: var(--tb-accent);
    }

    /* ═══════════════════════════════════════════════════════════
       SPACING BOX UI (Divi-style)
       ═══════════════════════════════════════════════════════════ */
    .tb-spacing-box {
        position: relative;
        width: 100%;
        padding: 8px;
        margin-bottom: 12px;
    }
    .tb-spacing-box-outer {
        position: relative;
        background: rgba(249, 226, 175, 0.15);
        border: 2px dashed rgba(249, 226, 175, 0.5);
        border-radius: 8px;
        padding: 24px;
    }
    .tb-spacing-box-inner {
        position: relative;
        background: rgba(166, 227, 161, 0.15);
        border: 2px dashed rgba(166, 227, 161, 0.5);
        border-radius: 6px;
        padding: 20px;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .tb-spacing-box-content {
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 11px;
        color: var(--tb-text-muted);
    }
    .tb-spacing-label {
        position: absolute;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 2px 6px;
        border-radius: 3px;
    }
    .tb-spacing-label-margin {
        top: 4px;
        left: 8px;
        background: rgba(249, 226, 175, 0.3);
        color: #c9a227;
    }
    .tb-spacing-label-padding {
        top: 4px;
        left: 8px;
        background: rgba(166, 227, 161, 0.3);
        color: #40a02b;
    }
    .tb-spacing-input-wrap {
        position: absolute;
        display: flex;
        align-items: center;
        gap: 2px;
    }
    .tb-spacing-input-wrap input {
        width: 44px;
        padding: 4px 6px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
        text-align: center;
    }
    .tb-spacing-input-wrap input:focus {
        outline: none;
        border-color: var(--tb-accent);
    }
    .tb-spacing-input-wrap .tb-spacing-unit {
        font-size: 10px;
        color: var(--tb-text-muted);
    }
    /* Margin inputs positioning */
    .tb-spacing-margin-top { top: -12px; left: 50%; transform: translateX(-50%); }
    .tb-spacing-margin-right { right: -12px; top: 50%; transform: translateY(-50%); }
    .tb-spacing-margin-bottom { bottom: -12px; left: 50%; transform: translateX(-50%); }
    .tb-spacing-margin-left { left: -12px; top: 50%; transform: translateY(-50%); }
    /* Padding inputs positioning */
    .tb-spacing-padding-top { top: -12px; left: 50%; transform: translateX(-50%); }
    .tb-spacing-padding-right { right: -12px; top: 50%; transform: translateY(-50%); }
    .tb-spacing-padding-bottom { bottom: -12px; left: 50%; transform: translateX(-50%); }
    .tb-spacing-padding-left { left: -12px; top: 50%; transform: translateY(-50%); }
    /* Link button */
    .tb-spacing-link-btn {
        position: absolute;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        color: var(--tb-text-muted);
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
    }
    .tb-spacing-link-btn:hover {
        background: var(--tb-accent);
        color: #1e1e2e;
        border-color: var(--tb-accent);
    }
    .tb-spacing-link-btn.linked {
        background: var(--tb-accent);
        color: #1e1e2e;
        border-color: var(--tb-accent);
    }
    .tb-spacing-link-margin { top: 50%; right: 50%; transform: translate(50%, -50%); }
    .tb-spacing-link-padding { top: 50%; left: 50%; transform: translate(-50%, -50%); }
    /* Collapsible section */
    .tb-spacing-section {
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    .tb-spacing-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: var(--tb-surface-2);
        cursor: pointer;
        user-select: none;
    }
    .tb-spacing-section-header:hover {
        background: var(--tb-border);
    }
    .tb-spacing-section-title {
        font-size: 12px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tb-spacing-section-toggle {
        font-size: 10px;
        color: var(--tb-text-muted);
        transition: transform 0.2s;
    }
    .tb-spacing-section.collapsed .tb-spacing-section-toggle {
        transform: rotate(-90deg);
    }
    .tb-spacing-section-body {
        padding: 12px;
        display: block;
    }
    .tb-spacing-section.collapsed .tb-spacing-section-body {
        display: none;
    }

    /* ═══════════════════════════════════════════════════════════
       BORDER BOX UI (Divi-style per-side controls)
       ═══════════════════════════════════════════════════════════ */
    .tb-border-section {
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    .tb-border-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: var(--tb-surface-2);
        cursor: pointer;
        user-select: none;
    }
    .tb-border-section-header:hover {
        background: var(--tb-border);
    }
    .tb-border-section-title {
        font-size: 12px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tb-border-section-toggle {
        font-size: 10px;
        color: var(--tb-text-muted);
        transition: transform 0.2s;
    }
    .tb-border-section.collapsed .tb-border-section-toggle {
        transform: rotate(-90deg);
    }
    .tb-border-section-body {
        padding: 12px;
        display: block;
    }
    .tb-border-section.collapsed .tb-border-section-body {
        display: none;
    }
    .tb-border-box {
        position: relative;
        width: 100%;
        padding: 8px;
        margin-bottom: 12px;
    }
    .tb-border-box-outer {
        position: relative;
        background: rgba(180, 190, 254, 0.1);
        border: 2px dashed rgba(180, 190, 254, 0.4);
        border-radius: 8px;
        padding: 28px;
    }
    .tb-border-box-inner {
        position: relative;
        background: var(--tb-surface);
        border: 2px solid rgba(180, 190, 254, 0.6);
        border-radius: 6px;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .tb-border-box-content {
        font-size: 11px;
        color: var(--tb-text-muted);
        text-align: center;
        padding: 8px;
    }
    .tb-border-label {
        position: absolute;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 2px 6px;
        border-radius: 3px;
        top: 4px;
        left: 8px;
        background: rgba(180, 190, 254, 0.3);
        color: #7c7fea;
    }
    .tb-border-input-wrap {
        position: absolute;
        display: flex;
        align-items: center;
        gap: 2px;
    }
    .tb-border-input-wrap input {
        width: 44px;
        padding: 4px 6px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
        text-align: center;
    }
    .tb-border-input-wrap input:focus {
        outline: none;
        border-color: var(--tb-accent);
    }
    /* Border width inputs positioning */
    .tb-border-width-top { top: -12px; left: 50%; transform: translateX(-50%); }
    .tb-border-width-right { right: -12px; top: 50%; transform: translateY(-50%); }
    .tb-border-width-bottom { bottom: -12px; left: 50%; transform: translateX(-50%); }
    .tb-border-width-left { left: -12px; top: 50%; transform: translateY(-50%); }
    /* Border link button */
    .tb-border-link-btn {
        position: absolute;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        color: var(--tb-text-muted);
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    .tb-border-link-btn:hover {
        background: var(--tb-accent);
        color: #1e1e2e;
        border-color: var(--tb-accent);
    }
    .tb-border-link-btn.linked {
        background: var(--tb-accent);
        color: #1e1e2e;
        border-color: var(--tb-accent);
    }
    /* Border radius box */
    .tb-radius-box {
        position: relative;
        width: 100%;
        padding: 8px;
        margin-bottom: 12px;
    }
    .tb-radius-box-visual {
        position: relative;
        width: 100%;
        height: 100px;
        background: var(--tb-surface);
        border: 2px solid rgba(245, 194, 231, 0.6);
        border-radius: 8px;
        transition: border-radius 0.2s;
    }
    .tb-radius-corner {
        position: absolute;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .tb-radius-corner input {
        width: 36px;
        padding: 4px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 10px;
        text-align: center;
    }
    .tb-radius-corner input:focus {
        outline: none;
        border-color: var(--tb-accent);
    }
    .tb-radius-tl { top: -18px; left: -18px; }
    .tb-radius-tr { top: -18px; right: -18px; }
    .tb-radius-br { bottom: -18px; right: -18px; }
    .tb-radius-bl { bottom: -18px; left: -18px; }
    .tb-radius-link-btn {
        position: absolute;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        color: var(--tb-text-muted);
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    .tb-radius-link-btn:hover {
        background: var(--tb-accent);
        color: #1e1e2e;
        border-color: var(--tb-accent);
    }
    .tb-radius-link-btn.linked {
        background: var(--tb-accent);
        color: #1e1e2e;
        border-color: var(--tb-accent);
    }
    .tb-radius-label {
        position: absolute;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 2px 6px;
        border-radius: 3px;
        top: 4px;
        left: 8px;
        background: rgba(245, 194, 231, 0.3);
        color: #d5679d;
    }
    /* Border style dropdown row */
    .tb-border-style-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
    }
    .tb-border-style-row label {
        font-size: 11px;
        color: var(--tb-text-muted);
        min-width: 50px;
    }
    .tb-border-style-row select {
        flex: 1;
        padding: 6px 8px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
    }
    /* Border color row */
    .tb-border-color-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
    }
    .tb-border-color-row label {
        font-size: 11px;
        color: var(--tb-text-muted);
        min-width: 50px;
    }
    .tb-border-color-row input[type="color"] {
        width: 36px;
        height: 28px;
        padding: 2px;
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        cursor: pointer;
    }
    .tb-border-color-row input[type="text"] {
        flex: 1;
        padding: 6px 8px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
    }

    /* ═══════════════════════════════════════════════════════════
       BOX SHADOW UI (Divi-style controls)
       ═══════════════════════════════════════════════════════════ */
    .tb-shadow-section {
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    .tb-shadow-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: var(--tb-surface-2);
        cursor: pointer;
        user-select: none;
    }
    .tb-shadow-section-header:hover {
        background: var(--tb-border);
    }
    .tb-shadow-section-title {
        font-size: 12px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tb-shadow-section-toggle {
        font-size: 10px;
        color: var(--tb-text-muted);
        transition: transform 0.2s;
    }
    .tb-shadow-section.collapsed .tb-shadow-section-toggle {
        transform: rotate(-90deg);
    }
    .tb-shadow-section-body {
        padding: 12px;
        display: block;
    }
    .tb-shadow-section.collapsed .tb-shadow-section-body {
        display: none;
    }
    .tb-shadow-preview-box {
        width: 60px;
        height: 60px;
        background: #ffffff;
        border-radius: 8px;
        margin: 0 auto 16px;
        transition: box-shadow 0.2s ease;
    }
    .tb-shadow-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .tb-shadow-control-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tb-shadow-control-row label {
        font-size: 11px;
        color: var(--tb-text-muted);
        min-width: 80px;
        flex-shrink: 0;
    }
    .tb-shadow-control-row input[type="range"] {
        flex: 1;
        height: 4px;
        -webkit-appearance: none;
        appearance: none;
        background: var(--tb-border);
        border-radius: 2px;
        outline: none;
    }
    .tb-shadow-control-row input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 14px;
        height: 14px;
        background: var(--tb-accent);
        border-radius: 50%;
        cursor: pointer;
    }
    .tb-shadow-control-row input[type="range"]::-moz-range-thumb {
        width: 14px;
        height: 14px;
        background: var(--tb-accent);
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }
    .tb-shadow-control-row input[type="number"] {
        width: 54px;
        padding: 4px 6px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
        text-align: center;
    }
    .tb-shadow-control-row input[type="color"] {
        width: 36px;
        height: 28px;
        padding: 2px;
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        cursor: pointer;
    }
    .tb-shadow-control-row input[type="text"] {
        flex: 1;
        padding: 6px 8px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
    }
    .tb-shadow-control-row select {
        flex: 1;
        padding: 6px 8px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
    }
    .tb-shadow-enable-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
        border-bottom: 1px solid var(--tb-border);
        margin-bottom: 12px;
    }
    .tb-shadow-enable-row label {
        font-size: 12px;
        color: var(--tb-text);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tb-shadow-enable-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
    }
    .tb-shadow-inset-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--tb-border);
        margin-top: 12px;
    }
    .tb-shadow-inset-row label {
        font-size: 11px;
        color: var(--tb-text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tb-shadow-inset-row input[type="checkbox"] {
        width: 14px;
        height: 14px;
        cursor: pointer;
    }
    .tb-shadow-preset-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--tb-border);
        margin-bottom: 12px;
    }
    .tb-shadow-preset-row label {
        font-size: 11px;
        color: var(--tb-text-muted);
        min-width: 50px;
    }
    .tb-shadow-disabled {
        opacity: 0.4;
        pointer-events: none;
    }

    /* ═══════════════════════════════════════════════════════════
       HOVER STATE SYSTEM (Divi-style hover editing)
       ═══════════════════════════════════════════════════════════ */
    .tb-state-toggle {
        display: flex;
        gap: 0;
        margin-bottom: 16px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        overflow: hidden;
    }
    .tb-state-btn {
        flex: 1;
        padding: 10px 16px;
        background: transparent;
        border: none;
        color: var(--tb-text-muted);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.15s;
    }
    .tb-state-btn:first-child {
        border-right: 1px solid var(--tb-border);
    }
    .tb-state-btn:hover {
        background: var(--tb-surface-2);
        color: var(--tb-text);
    }
    .tb-state-btn.active {
        background: var(--tb-accent);
        color: #1e1e2e;
    }
    .tb-state-btn.active.hover-state {
        background: #f9e2af;
        color: #1e1e2e;
    }
    .tb-state-indicator {
        font-size: 14px;
    }
    .tb-hover-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background: #f9e2af;
        color: #1e1e2e;
        border-radius: 4px;
        font-size: 10px;
        margin-left: 4px;
        vertical-align: middle;
    }
    .tb-hover-section {
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    .tb-hover-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: linear-gradient(135deg, rgba(249, 226, 175, 0.15), rgba(249, 226, 175, 0.05));
        cursor: pointer;
        user-select: none;
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-hover-section-header:hover {
        background: linear-gradient(135deg, rgba(249, 226, 175, 0.25), rgba(249, 226, 175, 0.1));
    }
    .tb-hover-section-title {
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #f9e2af;
    }
    .tb-hover-section-toggle {
        font-size: 10px;
        color: var(--tb-text-muted);
        transition: transform 0.2s;
    }
    .tb-hover-section.collapsed .tb-hover-section-toggle {
        transform: rotate(-90deg);
    }
    .tb-hover-section-body {
        padding: 12px;
        display: block;
    }
    .tb-hover-section.collapsed .tb-hover-section-body {
        display: none;
    }
    .tb-hover-enable-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
        border-bottom: 1px solid var(--tb-border);
        margin-bottom: 12px;
    }
    .tb-hover-enable-row label {
        font-size: 12px;
        color: var(--tb-text);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tb-hover-enable-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
        accent-color: #f9e2af;
    }
    .tb-hover-control-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
    }
    .tb-hover-control-row label {
        font-size: 11px;
        color: var(--tb-text-muted);
        min-width: 100px;
        flex-shrink: 0;
    }
    .tb-hover-control-row input[type="range"] {
        flex: 1;
        height: 4px;
        -webkit-appearance: none;
        appearance: none;
        background: var(--tb-border);
        border-radius: 2px;
        outline: none;
    }
    .tb-hover-control-row input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 14px;
        height: 14px;
        background: #f9e2af;
        border-radius: 50%;
        cursor: pointer;
    }
    .tb-hover-control-row input[type="number"],
    .tb-hover-control-row input[type="text"] {
        width: 70px;
        padding: 4px 6px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
        text-align: center;
    }
    .tb-hover-control-row input[type="color"] {
        width: 36px;
        height: 28px;
        padding: 2px;
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        cursor: pointer;
    }
    .tb-hover-control-row select {
        flex: 1;
        padding: 6px 8px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
    }
    .tb-hover-colors-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 12px;
    }
    .tb-hover-color-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .tb-hover-color-item label {
        font-size: 10px;
        color: var(--tb-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    .tb-hover-color-input {
        display: flex;
        gap: 4px;
        align-items: center;
    }
    .tb-hover-color-input input[type="color"] {
        width: 32px;
        height: 26px;
        padding: 1px;
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        cursor: pointer;
    }
    .tb-hover-color-input input[type="text"] {
        flex: 1;
        padding: 4px 6px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 10px;
    }
    .tb-hover-transform-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
        border-bottom: 1px solid rgba(249, 226, 175, 0.2);
    }
    .tb-hover-transform-row:last-child {
        border-bottom: none;
    }
    .tb-hover-transform-row label {
        font-size: 11px;
        color: var(--tb-text-muted);
        min-width: 90px;
    }
    .tb-hover-preview-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        width: 100%;
        padding: 8px 12px;
        background: linear-gradient(135deg, rgba(249, 226, 175, 0.2), rgba(249, 226, 175, 0.1));
        border: 1px solid rgba(249, 226, 175, 0.3);
        border-radius: 6px;
        color: #f9e2af;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 12px;
        transition: all 0.15s;
    }
    .tb-hover-preview-btn:hover {
        background: linear-gradient(135deg, rgba(249, 226, 175, 0.3), rgba(249, 226, 175, 0.2));
    }
    .tb-hover-preview-btn.active {
        background: #f9e2af;
        color: #1e1e2e;
    }
    .tb-hover-disabled {
        opacity: 0.4;
        pointer-events: none;
    }
    /* Editing state indicator in canvas */
    .tb-canvas.hover-editing .tb-module-preview {
        outline: 2px dashed rgba(249, 226, 175, 0.5);
        outline-offset: 2px;
    }

    /* ═══════════════════════════════════════════════════════════
       TRANSFORM SECTION STYLES (Divi-style transforms)
       ═══════════════════════════════════════════════════════════ */
    .tb-transform-section {
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    .tb-transform-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: linear-gradient(135deg, rgba(137, 180, 250, 0.15), rgba(137, 180, 250, 0.08));
        cursor: pointer;
        user-select: none;
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-transform-section-header:hover {
        background: linear-gradient(135deg, rgba(137, 180, 250, 0.25), rgba(137, 180, 250, 0.12));
    }
    .tb-transform-section-title {
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #89b4fa;
    }
    .tb-transform-section-toggle {
        font-size: 10px;
        color: var(--tb-text-muted);
        transition: transform 0.2s;
    }
    .tb-transform-section.collapsed .tb-transform-section-toggle {
        transform: rotate(-90deg);
    }
    .tb-transform-section-body {
        padding: 12px;
        display: block;
    }
    .tb-transform-section.collapsed .tb-transform-section-body {
        display: none;
    }
    .tb-transform-subsection {
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(137, 180, 250, 0.15);
    }
    .tb-transform-subsection:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    .tb-transform-subsection-title {
        font-size: 11px;
        font-weight: 600;
        color: var(--tb-text-muted);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .tb-transform-control-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
    }
    .tb-transform-control-row:last-child {
        margin-bottom: 0;
    }
    .tb-transform-control-row label {
        font-size: 11px;
        color: var(--tb-text-muted);
        min-width: 80px;
        flex-shrink: 0;
    }
    .tb-transform-control-row input[type="range"] {
        flex: 1;
        height: 4px;
        -webkit-appearance: none;
        appearance: none;
        background: var(--tb-border);
        border-radius: 2px;
        outline: none;
    }
    .tb-transform-control-row input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 14px;
        height: 14px;
        background: #89b4fa;
        border-radius: 50%;
        cursor: pointer;
    }
    .tb-transform-control-row input[type="number"] {
        width: 60px;
        padding: 4px 6px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
        text-align: center;
    }
    .tb-transform-control-row .tb-unit-label {
        font-size: 11px;
        color: var(--tb-text-muted);
        min-width: 20px;
    }
    /* Scale Link Toggle */
    .tb-scale-link-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 10px;
        padding: 6px 8px;
        background: rgba(137, 180, 250, 0.1);
        border-radius: 4px;
        cursor: pointer;
        user-select: none;
        font-size: 11px;
        color: var(--tb-text-muted);
    }
    .tb-scale-link-toggle:hover {
        background: rgba(137, 180, 250, 0.15);
    }
    .tb-scale-link-toggle input[type="checkbox"] {
        width: 14px;
        height: 14px;
        accent-color: #89b4fa;
    }
    .tb-scale-link-toggle.linked {
        background: rgba(137, 180, 250, 0.2);
        color: #89b4fa;
    }
    /* Transform Origin Grid */
    .tb-transform-origin-wrapper {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .tb-transform-origin-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
        width: 90px;
        height: 90px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 6px;
        padding: 6px;
    }
    .tb-transform-origin-point {
        width: 100%;
        aspect-ratio: 1;
        background: var(--tb-border);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .tb-transform-origin-point:hover {
        background: rgba(137, 180, 250, 0.4);
    }
    .tb-transform-origin-point.active {
        background: #89b4fa;
        box-shadow: 0 0 8px rgba(137, 180, 250, 0.5);
    }
    .tb-transform-origin-point::after {
        content: '';
        width: 6px;
        height: 6px;
        background: var(--tb-text-muted);
        border-radius: 50%;
        opacity: 0.5;
    }
    .tb-transform-origin-point.active::after {
        background: #1e1e2e;
        opacity: 1;
    }
    .tb-transform-origin-value {
        font-size: 11px;
        color: var(--tb-text-muted);
        text-align: center;
        padding: 4px 8px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
    }
    .tb-transform-origin-custom {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }
    .tb-transform-origin-custom input {
        width: 60px;
        padding: 4px 6px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
        text-align: center;
    }
    .tb-transform-origin-custom label {
        font-size: 10px;
        color: var(--tb-text-muted);
        display: flex;
        flex-direction: column;
        gap: 2px;
        align-items: center;
    }
    /* Transform Reset Button */
    .tb-transform-reset-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        width: 100%;
        padding: 8px 12px;
        background: rgba(137, 180, 250, 0.1);
        border: 1px solid rgba(137, 180, 250, 0.2);
        border-radius: 6px;
        color: #89b4fa;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 12px;
        transition: all 0.15s;
    }
    .tb-transform-reset-btn:hover {
        background: rgba(137, 180, 250, 0.2);
    }
    /* Transform badge for modules */
    .tb-transform-badge {
        font-size: 10px;
        padding: 2px 4px;
        background: rgba(137, 180, 250, 0.2);
        border-radius: 3px;
        margin-left: 4px;
        vertical-align: middle;
    }

    /* ═══════════════════════════════════════════════════════════
       FILTER SECTION STYLES (Divi-style CSS filters)
       ═══════════════════════════════════════════════════════════ */
    .tb-filter-section {
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    .tb-filter-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(249, 115, 22, 0.08));
        cursor: pointer;
        user-select: none;
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-filter-section-header:hover {
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.25), rgba(249, 115, 22, 0.12));
    }
    .tb-filter-section-title {
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #f97316;
    }
    .tb-filter-section-toggle {
        font-size: 10px;
        color: var(--tb-text-muted);
        transition: transform 0.2s;
    }
    .tb-filter-section.collapsed .tb-filter-section-toggle {
        transform: rotate(-90deg);
    }
    .tb-filter-section-body {
        padding: 12px;
        display: block;
    }
    .tb-filter-section.collapsed .tb-filter-section-body {
        display: none;
    }
    .tb-filter-preset-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(249, 115, 22, 0.15);
    }
    .tb-filter-preset-row label {
        font-size: 11px;
        color: var(--tb-text-muted);
        min-width: 50px;
        flex-shrink: 0;
    }
    .tb-filter-preset-row select {
        flex: 1;
        padding: 6px 10px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
        cursor: pointer;
    }
    .tb-filter-preset-row select:hover {
        border-color: #f97316;
    }
    .tb-filter-subsection {
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(249, 115, 22, 0.15);
    }
    .tb-filter-subsection:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    .tb-filter-subsection-title {
        font-size: 11px;
        font-weight: 600;
        color: var(--tb-text-muted);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .tb-filter-control-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
    }
    .tb-filter-control-row:last-child {
        margin-bottom: 0;
    }
    .tb-filter-control-row label {
        font-size: 11px;
        color: var(--tb-text-muted);
        min-width: 80px;
        flex-shrink: 0;
    }
    .tb-filter-control-row input[type="range"] {
        flex: 1;
        height: 4px;
        -webkit-appearance: none;
        appearance: none;
        background: var(--tb-border);
        border-radius: 2px;
        outline: none;
    }
    .tb-filter-control-row input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 14px;
        height: 14px;
        background: #f97316;
        border-radius: 50%;
        cursor: pointer;
    }
    .tb-filter-control-row input[type="range"]::-moz-range-thumb {
        width: 14px;
        height: 14px;
        background: #f97316;
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }
    .tb-filter-control-row input[type="number"] {
        width: 60px;
        padding: 4px 6px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
        text-align: center;
    }
    .tb-filter-control-row .tb-unit-label {
        font-size: 11px;
        color: var(--tb-text-muted);
        min-width: 20px;
    }
    /* Hue Rotate Color Wheel */
    .tb-hue-wheel-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tb-hue-wheel {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
        position: relative;
        flex-shrink: 0;
    }
    .tb-hue-wheel::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 8px;
        height: 8px;
        background: var(--tb-surface);
        border: 2px solid #fff;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .tb-hue-indicator {
        position: absolute;
        top: 0;
        left: 50%;
        width: 4px;
        height: 4px;
        background: var(--tb-surface-2);
        border-radius: 50%;
        transform-origin: 50% 10px;
        box-shadow: 0 0 3px rgba(0,0,0,0.5);
    }
    /* Filter Preview Thumbnail */
    .tb-filter-preview {
        width: 100%;
        height: 60px;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 12px;
        position: relative;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .tb-filter-preview-content {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #fff;
        font-size: 11px;
        font-weight: 500;
    }
    .tb-filter-preview-icon {
        font-size: 24px;
    }
    .tb-filter-preview-label {
        position: absolute;
        bottom: 4px;
        right: 6px;
        font-size: 9px;
        color: rgba(255,255,255,0.7);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    /* Filter Reset Button */
    .tb-filter-reset-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        width: 100%;
        padding: 8px 12px;
        background: rgba(249, 115, 22, 0.1);
        border: 1px solid rgba(249, 115, 22, 0.2);
        border-radius: 6px;
        color: #f97316;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 12px;
        transition: all 0.15s;
    }
    .tb-filter-reset-btn:hover {
        background: rgba(249, 115, 22, 0.2);
    }
    /* Filter badge for modules */
    .tb-filter-badge {
        font-size: 10px;
        padding: 2px 4px;
        background: rgba(249, 115, 22, 0.2);
        border-radius: 3px;
        margin-left: 4px;
        vertical-align: middle;
        color: #f97316;
    }

    /* ═══════════════════════════════════════════════════════════
       POSITION SECTION STYLES (Divi-style positioning)
       ═══════════════════════════════════════════════════════════ */
    .tb-position-section {
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    .tb-position-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.08));
        cursor: pointer;
        user-select: none;
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-position-section-header:hover {
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.25), rgba(168, 85, 247, 0.12));
    }
    .tb-position-section-title {
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #a855f7;
    }
    .tb-position-section-toggle {
        font-size: 10px;
        color: var(--tb-text-muted);
        transition: transform 0.2s;
    }
    .tb-position-section.collapsed .tb-position-section-toggle {
        transform: rotate(-90deg);
    }
    .tb-position-section-body {
        padding: 12px;
        display: block;
    }
    .tb-position-section.collapsed .tb-position-section-body {
        display: none;
    }
    .tb-position-type-row {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(168, 85, 247, 0.15);
    }
    .tb-position-type-row label {
        font-size: 11px;
        font-weight: 600;
        color: var(--tb-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    .tb-position-type-row select {
        width: 100%;
        padding: 8px 12px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 6px;
        color: var(--tb-text);
        font-size: 12px;
        cursor: pointer;
    }
    .tb-position-type-row select:hover {
        border-color: #a855f7;
    }
    .tb-position-info {
        font-size: 10px;
        color: var(--tb-text-muted);
        padding: 8px;
        background: rgba(168, 85, 247, 0.08);
        border-radius: 4px;
        line-height: 1.4;
    }
    .tb-position-info code {
        background: rgba(168, 85, 247, 0.15);
        padding: 1px 4px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 10px;
    }
    .tb-position-warning {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        font-size: 10px;
        color: #f59e0b;
        padding: 8px 10px;
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.2);
        border-radius: 6px;
        margin-bottom: 12px;
    }
    .tb-position-warning-icon {
        font-size: 14px;
        flex-shrink: 0;
    }
    /* Position Offset Box (visual box model style) */
    .tb-position-offset-box {
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(168, 85, 247, 0.15);
    }
    .tb-position-offset-title {
        font-size: 11px;
        font-weight: 600;
        color: var(--tb-text-muted);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .tb-position-offset-visual {
        position: relative;
        width: 100%;
        height: 140px;
        background: var(--tb-surface);
        border: 2px dashed rgba(168, 85, 247, 0.3);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .tb-position-offset-center {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(168, 85, 247, 0.15));
        border: 2px solid rgba(168, 85, 247, 0.5);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #a855f7;
        font-weight: 600;
    }
    .tb-position-offset-input {
        position: absolute;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .tb-position-offset-input.top {
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        flex-direction: column;
    }
    .tb-position-offset-input.right {
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        flex-direction: row-reverse;
    }
    .tb-position-offset-input.bottom {
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        flex-direction: column-reverse;
    }
    .tb-position-offset-input.left {
        left: 8px;
        top: 50%;
        transform: translateY(-50%);
    }
    .tb-position-offset-input input {
        width: 50px;
        padding: 4px 6px;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 10px;
        text-align: center;
    }
    .tb-position-offset-input input:focus {
        border-color: #a855f7;
        outline: none;
    }
    .tb-position-offset-input input.has-value {
        border-color: #a855f7;
        background: rgba(168, 85, 247, 0.1);
    }
    .tb-position-offset-input select {
        width: 40px;
        padding: 4px 2px;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 9px;
    }
    .tb-position-offset-label {
        font-size: 9px;
        color: var(--tb-text-muted);
        text-transform: uppercase;
    }
    /* Z-Index Section */
    .tb-zindex-section {
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(168, 85, 247, 0.15);
    }
    .tb-zindex-title {
        font-size: 11px;
        font-weight: 600;
        color: var(--tb-text-muted);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .tb-zindex-input-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }
    .tb-zindex-input-row input {
        flex: 1;
        padding: 8px 12px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 6px;
        color: var(--tb-text);
        font-size: 12px;
        text-align: center;
    }
    .tb-zindex-input-row input:focus {
        border-color: #a855f7;
        outline: none;
    }
    .tb-zindex-presets {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }
    .tb-zindex-preset {
        padding: 4px 8px;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text-muted);
        font-size: 10px;
        cursor: pointer;
        transition: all 0.15s;
    }
    .tb-zindex-preset:hover {
        border-color: #a855f7;
        color: #a855f7;
    }
    .tb-zindex-preset.active {
        background: rgba(168, 85, 247, 0.15);
        border-color: #a855f7;
        color: #a855f7;
    }
    /* Sticky Options */
    .tb-sticky-section {
        margin-bottom: 12px;
    }
    .tb-sticky-title {
        font-size: 11px;
        font-weight: 600;
        color: var(--tb-text-muted);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .tb-sticky-control-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }
    .tb-sticky-control-row label {
        font-size: 11px;
        color: var(--tb-text-muted);
        min-width: 100px;
        flex-shrink: 0;
    }
    .tb-sticky-control-row input {
        flex: 1;
        padding: 6px 10px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
    }
    .tb-sticky-control-row input:focus {
        border-color: #a855f7;
        outline: none;
    }
    /* Quick Position Actions */
    .tb-position-quick-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .tb-position-quick-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 6px 10px;
        background: rgba(168, 85, 247, 0.1);
        border: 1px solid rgba(168, 85, 247, 0.2);
        border-radius: 4px;
        color: #a855f7;
        font-size: 10px;
        cursor: pointer;
        transition: all 0.15s;
    }
    .tb-position-quick-btn:hover {
        background: rgba(168, 85, 247, 0.2);
    }
    /* Position badge for modules */
    .tb-position-badge {
        font-size: 10px;
        padding: 2px 4px;
        background: rgba(168, 85, 247, 0.2);
        border-radius: 3px;
        margin-left: 4px;
        vertical-align: middle;
        color: #a855f7;
    }
    /* Positioned module canvas indicators */
    .tb-module.tb-positioned {
        position: relative;
    }
    .tb-module.tb-positioned::before {
        content: '';
        position: absolute;
        inset: -2px;
        border: 2px dashed rgba(168, 85, 247, 0.5);
        border-radius: 6px;
        pointer-events: none;
        z-index: 1;
    }
    .tb-module.tb-position-absolute::before,
    .tb-module.tb-position-fixed::before {
        border-color: rgba(245, 158, 11, 0.6);
        animation: tb-position-pulse 2s ease-in-out infinite;
    }
    @keyframes tb-position-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .tb-zindex-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        min-width: 20px;
        height: 20px;
        background: #a855f7;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: 600;
        color: #fff;
        z-index: 10;
        padding: 0 4px;
    }
    .tb-position-disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    .tb-no-selection {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--tb-text-muted);
        text-align: center;
    }
    .tb-no-selection-icon {
        font-size: 32px;
        margin-bottom: 12px;
        opacity: 0.5;
    }
    
    /* ═══════════════════════════════════════════════════════════
       SECTION/ROW/COLUMN/MODULE ELEMENTS
       ═══════════════════════════════════════════════════════════ */
    .tb-section {
        background: var(--tb-bg-secondary);
        position: relative;
        padding: 48px 16px 20px 16px;
        border: 1px solid var(--tb-border);
        transition: all 0.15s;
        margin-top: 8px;
    }
    .tb-section:hover { border-color: rgba(137, 180, 250, 0.3); }
    .tb-section.selected { border-color: var(--tb-accent); }
    
    .tb-row {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px 16px;
        margin-bottom: 16px;
        background: transparent;
        border-radius: 8px;
        border: 1px dashed transparent;
        transition: border-color 0.2s;
    }
    .tb-row:hover {
        border-color: rgba(137, 180, 250, 0.3);
    }
    .tb-row-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px 0;
        opacity: 1;
        transition: opacity 0.2s;
        pointer-events: auto;
    }
    .tb-row:hover .tb-row-header {
        opacity: 1;
        pointer-events: auto;
    }
    .tb-row-columns {
        display: flex;
        gap: 16px;
    }
    .tb-layout-selector {
        display: flex;
        align-items: center;
        gap: 4px;
        background: var(--tb-surface);
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid var(--tb-border);
    }
    .tb-layout-btn {
        width: 36px;
        height: 24px;
        padding: 2px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        color: var(--tb-text-muted);
        transition: all 0.15s;
    }
    .tb-layout-btn:hover {
        background: var(--tb-surface-2);
        color: var(--tb-text);
        border-color: var(--tb-border);
    }
    .tb-layout-btn.active {
        background: var(--tb-accent);
        color: #fff;
        border-color: var(--tb-accent);
    }
    .tb-layout-btn svg {
        width: 100%;
        height: 100%;
    }
    .tb-layout-divider {
        width: 1px;
        height: 16px;
        background: var(--tb-border);
        margin: 0 4px;
    }
    .tb-row-actions {
        display: flex;
        gap: 4px;
    }
    .tb-row-action-btn {
        width: 24px;
        height: 24px;
        padding: 0;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        cursor: pointer;
        color: var(--tb-text-muted);
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
    }
    .tb-row-action-btn:hover {
        background: #f87171;
        border-color: #f87171;
        color: #fff;
    }
    
    .tb-column {
        flex: 1;
        min-height: 60px;
        padding: 8px;
        background: var(--tb-bg-tertiary); border: 2px dashed var(--tb-border);
        border-radius: 4px;
    }
    .tb-column:hover { border-color: var(--tb-accent); }
    
    .tb-module {
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        
        
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.15s;
    }
    .tb-module:hover {
        border-color: var(--tb-accent);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .tb-module.selected {
        border-color: var(--tb-accent);
        box-shadow: 0 0 0 3px rgba(137, 180, 250, 0.2);
    }
    
    /* Element Controls */
    .tb-element-controls {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 6px;
        padding: 4px;
        gap: 4px;
        z-index: 100;
    }
    .tb-section:hover .tb-element-controls,
    .tb-section.selected .tb-element-controls {
        display: flex;
    }
    .tb-control-btn {
        padding: 4px 8px;
        background: transparent;
        border: none;
        color: var(--tb-text-muted);
        cursor: pointer;
        border-radius: 4px;
        font-size: 12px;
    }
    .tb-control-btn:hover {
        background: var(--tb-surface-2);
        color: var(--tb-text);
    }
    .tb-control-btn.danger:hover { color: var(--tb-danger); }
    
    /* Toast Notifications */
    .tb-toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    }
    .tb-toast.success { border-color: var(--tb-success); }
    .tb-toast.error { border-color: var(--tb-danger); }
    @keyframes slideIn {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    /* Loading Overlay */
    .tb-loading {
        position: fixed;
        inset: 0;
        background: rgba(30, 30, 46, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }
    .tb-loading.hidden { display: none; }
    .tb-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--tb-border);
        border-top-color: var(--tb-accent);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
        /* Drag & Drop Enhancements */
    .tb-module-item.dragging {
        opacity: 0.5;
        transform: scale(0.95);
    }
    
    .tb-drop-target {
        box-shadow: 0 0 0 2px var(--tb-accent);
    }
    
    .tb-column.tb-drag-over {
        background: rgba(137, 180, 250, 0.1);
        border-color: var(--tb-accent) !important;
    }
    
    .tb-insertion-line {
        height: 3px;
        background: var(--tb-accent);
        margin: 4px 0;
        border-radius: 2px;
        animation: pulse 1s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .tb-column-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 24px 12px;
        color: var(--tb-text-muted);
        font-size: 12px;
        gap: 8px;
    }
    
    .tb-column-empty-icon {
        font-size: 24px;
        opacity: 0.5;
    }
    
    .tb-module.tb-dragging {
        opacity: 0.4;
        transform: rotate(2deg);
    }
    
    .tb-module-header {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 8px;
        background: var(--tb-surface-2);
        border-radius: 4px 4px 0 0;
        margin: -12px -12px 8px -12px;
        border-bottom: 1px solid var(--tb-border);
    }
    
    .tb-module-type-icon {
        font-size: 14px;
    }
    
    .tb-module-type-label {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--tb-text-muted);
        flex: 1;
    }
    .tb-module-header .tb-hover-badge {
        font-size: 10px;
        padding: 2px 4px;
        margin-left: 4px;
        animation: tb-hover-pulse 2s ease-in-out infinite;
    }
    @keyframes tb-hover-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    .tb-module.tb-has-hover {
        box-shadow: 0 0 0 1px rgba(249, 226, 175, 0.3);
    }
    .tb-module.tb-hover-preview-active .tb-module-preview {
        outline: 3px solid #f9e2af !important;
        outline-offset: -3px;
    }

    /* ═══════════════════════════════════════════════════════════
       ANIMATION SYSTEM - CSS Keyframes
       ═══════════════════════════════════════════════════════════ */

    /* Animation badge for modules with animations enabled */
    .tb-module.tb-has-animation {
        box-shadow: 0 0 0 1px rgba(137, 180, 250, 0.3);
    }
    .tb-module-header .tb-animation-badge {
        font-size: 10px;
        padding: 2px 4px;
        margin-left: 4px;
        animation: tb-animation-pulse 2s ease-in-out infinite;
        background: rgba(137, 180, 250, 0.2);
        border-radius: 3px;
    }
    @keyframes tb-animation-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Animation Section Styles */
    .tb-animation-section {
        margin-top: 16px;
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        overflow: hidden;
    }
    .tb-animation-section.collapsed .tb-animation-section-body {
        display: none;
    }
    .tb-animation-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: var(--tb-surface-2);
        cursor: pointer;
        user-select: none;
    }
    .tb-animation-section-header:hover {
        background: var(--tb-surface-2);
    }
    .tb-animation-section-title {
        font-weight: 600;
        font-size: 12px;
        color: var(--tb-accent);
    }
    .tb-animation-section-toggle {
        font-size: 10px;
        color: var(--tb-text-muted);
        transition: transform 0.2s;
    }
    .tb-animation-section.collapsed .tb-animation-section-toggle {
        transform: rotate(-90deg);
    }
    .tb-animation-section-body {
        padding: 12px;
        background: var(--tb-surface);
    }

    /* Animation Enable Row */
    .tb-animation-enable-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--tb-border);
        margin-bottom: 12px;
    }
    .tb-animation-enable-row label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        cursor: pointer;
    }
    .tb-animation-enable-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
    }

    /* Animation Controls */
    .tb-animation-controls.tb-animation-disabled {
        opacity: 0.4;
        pointer-events: none;
    }
    .tb-animation-control-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
    }
    .tb-animation-control-row label {
        min-width: 80px;
        font-size: 11px;
        color: var(--tb-text-muted);
    }
    .tb-animation-control-row input[type="range"] {
        flex: 1;
        height: 4px;
        -webkit-appearance: none;
        background: var(--tb-surface-2);
        border-radius: 2px;
    }
    .tb-animation-control-row input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        background: var(--tb-accent);
        border-radius: 50%;
        cursor: pointer;
    }
    .tb-animation-control-row input[type="number"],
    .tb-animation-control-row select {
        width: 80px;
        padding: 4px 6px;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 11px;
    }
    .tb-animation-control-row select {
        width: 120px;
    }

    /* Animation Subsections */
    .tb-animation-subsection {
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-animation-subsection:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    .tb-animation-subsection-title {
        font-size: 11px;
        font-weight: 600;
        color: var(--tb-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: 10px;
    }

    /* Animation Preview Button */
    .tb-animation-preview-btn {
        width: 100%;
        padding: 10px 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 6px;
        color: #fff;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 12px;
        transition: all 0.15s;
    }
    .tb-animation-preview-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .tb-animation-preview-btn.playing {
        background: linear-gradient(135deg, #f38ba8 0%, #eb6f92 100%);
    }

    /* Animation Preview Panel */
    .tb-animation-preview-panel {
        margin-top: 12px;
        padding: 12px;
        background: var(--tb-surface-2);
        border-radius: 8px;
        text-align: center;
    }
    .tb-animation-preview-box {
        width: 80px;
        height: 80px;
        margin: 0 auto 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    .tb-animation-preview-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        font-size: 11px;
        color: var(--tb-text-muted);
    }
    .tb-animation-preview-controls label {
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
    }
    .tb-animation-speed-select {
        padding: 2px 6px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text);
        font-size: 10px;
    }

    /* ═══════════════════════════════════════════════════════════
       ENTRANCE ANIMATION KEYFRAMES
       ═══════════════════════════════════════════════════════════ */

    /* Fade Animations */
    @keyframes tb-fade {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes tb-fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes tb-fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes tb-fadeInDown {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes tb-fadeInLeft {
        from { opacity: 0; transform: translateX(-30px); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes tb-fadeInRight {
        from { opacity: 0; transform: translateX(30px); }
        to { opacity: 1; transform: translateX(0); }
    }

    /* Slide Animations */
    @keyframes tb-slideInUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    @keyframes tb-slideInDown {
        from { transform: translateY(-100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    @keyframes tb-slideInLeft {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes tb-slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Zoom Animations */
    @keyframes tb-zoomIn {
        from { opacity: 0; transform: scale(0.3); }
        to { opacity: 1; transform: scale(1); }
    }
    @keyframes tb-zoomInUp {
        from { opacity: 0; transform: scale(0.3) translateY(100px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
    @keyframes tb-zoomInDown {
        from { opacity: 0; transform: scale(0.3) translateY(-100px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }

    /* Bounce Animations */
    @keyframes tb-bounceIn {
        0% { opacity: 0; transform: scale(0.3); }
        50% { opacity: 1; transform: scale(1.05); }
        70% { transform: scale(0.9); }
        100% { transform: scale(1); }
    }
    @keyframes tb-bounceInUp {
        0% { opacity: 0; transform: translateY(100px); }
        60% { opacity: 1; transform: translateY(-20px); }
        80% { transform: translateY(10px); }
        100% { transform: translateY(0); }
    }
    @keyframes tb-bounceInDown {
        0% { opacity: 0; transform: translateY(-100px); }
        60% { opacity: 1; transform: translateY(20px); }
        80% { transform: translateY(-10px); }
        100% { transform: translateY(0); }
    }

    /* Flip Animations */
    @keyframes tb-flipInX {
        0% { opacity: 0; transform: perspective(400px) rotateX(90deg); }
        40% { transform: perspective(400px) rotateX(-20deg); }
        60% { opacity: 1; transform: perspective(400px) rotateX(10deg); }
        80% { transform: perspective(400px) rotateX(-5deg); }
        100% { transform: perspective(400px) rotateX(0deg); }
    }
    @keyframes tb-flipInY {
        0% { opacity: 0; transform: perspective(400px) rotateY(90deg); }
        40% { transform: perspective(400px) rotateY(-20deg); }
        60% { opacity: 1; transform: perspective(400px) rotateY(10deg); }
        80% { transform: perspective(400px) rotateY(-5deg); }
        100% { transform: perspective(400px) rotateY(0deg); }
    }

    /* Roll Animation */
    @keyframes tb-rollIn {
        from { opacity: 0; transform: translateX(-100%) rotate(-120deg); }
        to { opacity: 1; transform: translateX(0) rotate(0deg); }
    }

    /* Special Animations */
    @keyframes tb-lightSpeedIn {
        0% { opacity: 0; transform: translateX(100%) skewX(-30deg); }
        60% { opacity: 1; transform: skewX(20deg); }
        80% { transform: skewX(-5deg); }
        100% { transform: translateX(0) skewX(0deg); }
    }
    @keyframes tb-jackInTheBox {
        0% { opacity: 0; transform: scale(0.1) rotate(30deg); transform-origin: center bottom; }
        50% { transform: rotate(-10deg); }
        70% { transform: rotate(3deg); }
        100% { opacity: 1; transform: scale(1) rotate(0deg); }
    }

    /* Animation utility class for triggering */
    .tb-animate-active {
        animation-fill-mode: both;
    }
    .tb-animate-paused {
        animation-play-state: paused;
    }

    .tb-module-actions {
        display: flex;
        gap: 2px;
        opacity: 0;
        transition: opacity 0.15s;
    }
    
    .tb-module:hover .tb-module-actions {
        opacity: 1;
    }
    
    .tb-module-action-btn {
        padding: 2px 6px;
        background: transparent;
        border: none;
        color: var(--tb-text-muted);
        cursor: pointer;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .tb-module-action-btn:hover {
        background: var(--tb-surface);
        color: var(--tb-text);
    }
    
    .tb-module-action-btn.danger:hover {
        background: var(--tb-danger);
        color: #dc2626;
    }
    
    .tb-module-preview {
        min-height: 20px;
        overflow: hidden;
    }
    
    .tb-row-controls {
        position: absolute;
        right: -60px;
        top: 50%;
        transform: translateY(-50%);
        display: none;
        flex-direction: column;
        gap: 4px;
    }
    
    .tb-row:hover .tb-row-controls {
        display: flex;
    }
    
    .tb-row {
        position: relative;
    }
    
    .tb-control-btn-small {
        padding: 2px 6px;
        font-size: 10px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        color: var(--tb-text-muted);
        cursor: pointer;
        border-radius: 3px;
    }
    
    .tb-control-btn-small:hover {
        background: var(--tb-surface-2);
        color: var(--tb-text);
    }
    
    .tb-main-drop-zone.drag-over {
        border-color: var(--tb-accent);
        background: rgba(137, 180, 250, 0.1);
    }
    
    .tb-add-section-zone.drag-over {
        border-color: var(--tb-accent);
        background: rgba(137, 180, 250, 0.1);
    }

    /* ═══════════════════════════════════════════════════════════
       ICON PICKER MODAL
       ═══════════════════════════════════════════════════════════ */
    .tb-icon-picker-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
    }
    .tb-icon-picker-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    .tb-icon-picker-modal {
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 12px;
        width: 600px;
        max-width: 95vw;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        transform: scale(0.95);
        transition: transform 0.2s ease;
        overflow: hidden;
    }
    .tb-icon-picker-header,
    .tb-icon-picker-tabs,
    .tb-icon-picker-search {
        flex-shrink: 0;
    }
    .tb-icon-picker-overlay.active .tb-icon-picker-modal {
        transform: scale(1);
    }
    .tb-icon-picker-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-icon-picker-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--tb-text);
    }
    .tb-icon-picker-close {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: var(--tb-text-muted);
        font-size: 20px;
        cursor: pointer;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
    }
    .tb-icon-picker-close:hover {
        background: var(--tb-surface);
        color: var(--tb-text);
    }
    .tb-icon-picker-tabs {
        display: flex;
        gap: 16px;
        padding: 16px 20px;
        border-bottom: 1px solid var(--tb-border);
        overflow: visible;
        background: var(--tb-surface-2);
    }
    .tb-icon-picker-tab {
        padding: 8px 16px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 6px;
        color: var(--tb-text-muted);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.15s;
    }
    .tb-icon-picker-tab:hover {
        background: var(--tb-surface);
        color: var(--tb-text);
    }
    .tb-icon-picker-tab.active {
        background: var(--tb-accent);
        color: #1e1e2e;
        border-color: var(--tb-accent);
    }
    .tb-icon-picker-search {
        padding: 12px 20px;
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-icon-picker-search input {
        width: 100%;
        padding: 10px 14px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        color: var(--tb-text);
        font-size: 14px;
    }
    .tb-icon-picker-search input:focus {
        outline: none;
        border-color: var(--tb-accent);
    }
    .tb-icon-picker-search input::placeholder {
        color: var(--tb-text-muted);
    }
    .tb-icon-picker-grid {
        flex: 1;
        overflow-y: auto;
        padding: 16px 20px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
        gap: 8px;
        align-content: start;
    }
    .tb-icon-picker-item {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        cursor: pointer;
        font-size: 20px;
        color: var(--tb-text);
        transition: all 0.15s;
    }
    .tb-icon-picker-item:hover {
        background: var(--tb-accent);
        border-color: var(--tb-accent);
        color: #1e1e2e;
        transform: scale(1.1);
    }
    .tb-icon-picker-item i {
        font-size: 20px;
    }
    .tb-icon-picker-item .material-icons,
    .tb-icon-picker-item .material-icons-outlined {
        font-size: 24px;
    }
    .tb-icon-picker-empty {
        grid-column: 1 / -1;
        text-align: center;
        padding: 40px 20px;
        color: var(--tb-text-muted);
    }

    /* New Icon Picker styles */
    .tb-icon-picker-tabs .tb-icon-tab {
        padding: 10px 24px;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        border-radius: 0;
        color: var(--tb-text-muted);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
        box-shadow: none;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
    }
    .tb-icon-picker-tabs .tb-icon-tab:hover {
        background: transparent;
        color: var(--tb-text);
        border-bottom-color: var(--tb-text-muted);
    }
    .tb-icon-picker-tabs .tb-icon-tab.active {
        background: transparent;
        color: var(--tb-accent);
        border-bottom-color: var(--tb-accent);
    }
    .tb-icon-categories {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 8px 20px;
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-icon-category { display: inline-block; margin: 4px;
        padding: 4px 10px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 4px;
        color: var(--tb-text-muted);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.15s;
    }
    .tb-icon-category:hover {
        background: var(--tb-surface-2);
        color: var(--tb-text);
    }
    .tb-icon-category.active {
        background: var(--tb-accent);
        color: #1e1e2e;
        border-color: var(--tb-accent);
    }
    .tb-icon-option {
        width: 52px;
        height: 52px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        cursor: pointer;
        color: var(--tb-text);
        transition: all 0.15s;
    }
    .tb-icon-option:hover {
        background: var(--tb-accent);
        border-color: var(--tb-accent);
        color: #1e1e2e;
        transform: scale(1.05);
    }
    .tb-icon-option svg {
        width: 28px;
        height: 28px;
    }
    .tb-icon-option i {
        font-size: 26px;
        line-height: 1;
    }
    .tb-icon-option.emoji {
        font-size: 26px;
    }
    .tb-icon-picker-preview {
        padding: 12px 20px;
        border-top: 1px solid var(--tb-border);
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--tb-surface);
    }
    .tb-icon-picker-preview-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        font-size: 24px;
    }
    .tb-icon-picker-preview-info {
        flex: 1;
    }
    .tb-icon-picker-preview-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--tb-text);
    }
    .tb-icon-picker-preview-code {
        font-size: 12px;
        color: var(--tb-text-muted);
        font-family: monospace;
    }

    /* ═══════════════════════════════════════════════════════════
       FONT PICKER MODAL
       ═══════════════════════════════════════════════════════════ */
    .tb-font-picker-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
    }
    .tb-font-picker-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    .tb-font-picker-modal {
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 12px;
        width: 650px;
        max-width: 95vw;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        transform: scale(0.95);
        transition: transform 0.2s ease;
    }
    .tb-font-picker-overlay.active .tb-font-picker-modal {
        transform: scale(1);
    }
    .tb-font-picker-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-font-picker-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--tb-text);
    }
    .tb-font-picker-close {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: var(--tb-text-muted);
        font-size: 20px;
        cursor: pointer;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
    }
    .tb-font-picker-close:hover {
        background: var(--tb-surface);
        color: var(--tb-text);
    }
    .tb-font-picker-preview-box {
        padding: 20px;
        background: var(--tb-surface);
        border-bottom: 1px solid var(--tb-border);
        text-align: center;
    }
    .tb-font-picker-preview-text {
        font-size: 24px;
        color: var(--tb-text);
        padding: 16px;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .tb-font-picker-tabs {
        display: flex;
        gap: 4px;
        padding: 12px 20px;
        border-bottom: 1px solid var(--tb-border);
        overflow-x: auto;
    }
    .tb-font-picker-tab {
        padding: 8px 16px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 6px;
        color: var(--tb-text-muted);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.15s;
    }
    .tb-font-picker-tab:hover {
        background: var(--tb-surface);
        color: var(--tb-text);
    }
    .tb-font-picker-tab.active {
        background: var(--tb-accent);
        color: #1e1e2e;
        border-color: var(--tb-accent);
    }
    .tb-font-picker-search {
        padding: 12px 20px;
        border-bottom: 1px solid var(--tb-border);
    }
    .tb-font-picker-search input {
        width: 100%;
        padding: 10px 14px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        color: var(--tb-text);
        font-size: 14px;
    }
    .tb-font-picker-search input:focus {
        outline: none;
        border-color: var(--tb-accent);
    }
    .tb-font-picker-list {
        flex: 1;
        overflow-y: auto;
        padding: 12px 20px;
    }
    .tb-font-picker-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background: var(--tb-surface);
        border: 1px solid var(--tb-border);
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 8px;
        transition: all 0.15s;
    }
    .tb-font-picker-item:hover {
        background: var(--tb-surface-2);
        border-color: var(--tb-accent);
    }
    .tb-font-picker-item.selected {
        background: rgba(137, 180, 250, 0.15);
        border-color: var(--tb-accent);
    }
    .tb-font-picker-item-name {
        flex: 1;
        font-size: 18px;
        color: var(--tb-text);
    }
    .tb-font-picker-item-category {
        font-size: 11px;
        color: var(--tb-text-muted);
        background: var(--tb-surface-2);
        padding: 4px 8px;
        border-radius: 4px;
    }
    .tb-font-picker-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--tb-border);
        display: flex;
        gap: 12px;
        align-items: center;
        background: var(--tb-surface);
    }
    .tb-font-picker-options {
        display: flex;
        gap: 12px;
        flex: 1;
    }
    .tb-font-picker-option {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .tb-font-picker-option label {
        font-size: 11px;
        color: var(--tb-text-muted);
        text-transform: uppercase;
    }
    .tb-font-picker-option select,
    .tb-font-picker-option input {
        padding: 6px 10px;
        background: var(--tb-surface-2);
        border: 1px solid var(--tb-border);
        border-radius: 6px;
        color: var(--tb-text);
        font-size: 13px;
        min-width: 80px;
    }
    .tb-font-picker-empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--tb-text-muted);
    }

    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="tb-loading hidden" id="tb-loading">
        <div class="tb-spinner"></div>
    </div>

    <!-- Toolbar -->
    <header class="tb-toolbar">
        <div class="tb-toolbar-left">
            <a href="/admin/theme-builder" class="tb-btn tb-btn-icon" title="Exit Builder">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </a>
            <span class="tb-divider"></span>
            <div class="tb-logo">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>
                </svg>
                Theme Builder
            </div>
        </div>
        
        <div class="tb-toolbar-center">
            <input type="text" class="tb-page-title" id="page-title" value="<?= $pageTitle ?>" placeholder="Page Title">
        </div>
        
        <div class="tb-toolbar-right">
            <button type="button" class="tb-btn tb-btn-icon" id="btn-undo" title="Undo" disabled>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v6h6M3 13c0-4.97 4.03-9 9-9a9 9 0 0 1 6.36 2.64"/>
                </svg>
            </button>
            <button type="button" class="tb-btn tb-btn-icon" id="btn-redo" title="Redo" disabled>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 7v6h-6M21 13c0-4.97-4.03-9-9-9a9 9 0 0 0-6.36 2.64"/>
                </svg>
            </button>
            <span class="tb-divider"></span>
            <button type="button" class="tb-btn" id="btn-preview" title="Preview">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                Preview
            </button>
            <button type="button" class="tb-btn" id="btn-settings" title="Page Settings">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            </button>
            <span class="tb-divider"></span>
            <button type="button" class="tb-btn" id="btn-load-library" title="Load from Layout Library">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                    <path d="M12 11v6M9 14h6"/>
                </svg>
                Library
            </button>
            <span class="tb-divider"></span>
            <select id="page-status-select" class="tb-btn" style="padding:8px 12px;border-radius:6px;background:var(--tb-bg-tertiary);color:var(--tb-text-primary);border:1px solid var(--tb-border);cursor:pointer;margin-right:8px">
                <option value="draft"<?= $pageStatus === "draft" ? " selected" : "" ?>>Draft</option>
                <option value="published"<?= $pageStatus === "published" ? " selected" : "" ?>>Published</option>
            </select>
            <button type="button" class="tb-btn tb-btn-primary" id="btn-save">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                </svg>
                Save
            </button>
        </div>
    </header>
    
    <!-- Main Layout -->
    <div class="tb-main">
        <!-- Left Panel - Modules -->
        <aside class="tb-panel-left">
            <div class="tb-panel-header">
                <div class="tb-panel-title">Modules</div>
                <input type="text" class="tb-search" id="module-search" placeholder="Search modules...">
            </div>
            <div class="tb-panel-body" id="modules-panel">
                <!-- Module categories will be populated by JS -->
            </div>
        </aside>
        
        <!-- Center - Canvas -->
        <main class="tb-canvas-wrapper">
            <div class="tb-canvas-toolbar">
                <div class="tb-viewport-btns">
                    <button type="button" class="tb-viewport-btn active" data-viewport="desktop" title="Desktop">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
                        </svg>
                    </button>
                    <button type="button" class="tb-viewport-btn" data-viewport="tablet" title="Tablet">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="4" y="2" width="16" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18"/>
                        </svg>
                    </button>
                    <button type="button" class="tb-viewport-btn" data-viewport="mobile" title="Mobile">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18"/>
                        </svg>
                    </button>
                </div>
                <span style="flex:1"></span>
                <button type="button" class="tb-btn" id="btn-add-section">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Section
                </button>
            </div>
            <div class="tb-canvas" id="tb-canvas">
                <!-- Dynamic hover styles for modules -->
                <style id="tb-hover-styles">/* Hover styles will be generated dynamically */</style>
                <!-- Dynamic animation styles for modules -->
                <style id="tb-animation-styles">/* Animation styles will be generated dynamically */</style>
                <div class="tb-canvas-inner desktop" id="canvas-inner">
                    <!-- Canvas content will be rendered by JS -->
                    <div class="tb-drop-zone" id="main-drop-zone">
                        <div class="tb-drop-zone-text">
                            <div class="tb-drop-zone-icon">📦</div>
                            <div>Drag modules here or click "Add Section" to start building</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Right Panel - Settings -->
        <aside class="tb-panel-right">
            <div class="tb-tabs">
                <button type="button" class="tb-tab active" data-tab="content">Content</button>
                <button type="button" class="tb-tab" data-tab="design">Design</button>
                <button type="button" class="tb-tab" data-tab="advanced">Advanced</button>
            </div>
            <!-- Responsive Device Toggle -->
            <div class="tb-device-toggle" id="device-toggle">
                <span class="tb-device-toggle-label">Device</span>
                <button type="button" class="tb-device-btn active" data-device="desktop" title="Desktop" onclick="TB.setDevice('desktop')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                </button>
                <button type="button" class="tb-device-btn" data-device="tablet" title="Tablet" onclick="TB.setDevice('tablet')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="2" width="16" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18"/>
                    </svg>
                </button>
                <button type="button" class="tb-device-btn" data-device="mobile" title="Mobile" onclick="TB.setDevice('mobile')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="tb-settings-body" id="settings-panel">
                <div class="tb-no-selection">
                    <div class="tb-no-selection-icon">👆</div>
                    <div>Select an element to edit its settings</div>
                </div>
            </div>
        </aside>
    </div>
    
    <!-- Hidden data -->
    <input type="hidden" id="page-id" value="<?= $pageId ?>">
    <input type="hidden" id="page-slug" value="<?= $pageSlug ?>">
    <input type="hidden" id="page-status" value="<?= $pageStatus ?>">
    <input type="hidden" id="csrf-token" value="<?= $csrfToken ?>">
    
        <script>
    // ═══════════════════════════════════════════════════════════
    // THEME BUILDER 3.0 - CLIENT-SIDE APPLICATION
    // Complete Drag & Drop System with Module Insertion
    // ═══════════════════════════════════════════════════════════

    // Module type to icon mapping
    const MODULE_ICONS = {
        text: '📝',
        heading: '📰',
        image: '🖼',
        button: '🔘',
        divider: '➖',
        spacer: '⬜',
        video: '🎬',
        audio: '🎵',
        code: '💻',
        html: '🔧',
        gallery: '🖼',
        list: '📋',
        quote: '💬',
        accordion: '📁',
        toggle: '📂',
        tabs: '📑',
        map: '🗺',
        form: '📧',
        social: '🔗',
        icon: '⭐',
        countdown: '⏱',
        progress: '📊',
        testimonial: '💭',
        pricing: '💰',
        blurb: '💡',
        team: '👥',
        cta: '📢',
        hero: '🏆',
        footer: '📍',
        header: '🔝',
        navigation: '🧭',
        sidebar: '📐',
        search: '🔍',
        slider: '🎠',
        carousel: '🎪',
        blog: '📰',
        counter: '🔢',
        menu: '☰',
        bar_counters: '📊',
        circle_counter: '⭕',
        login: '🔐',
        portfolio: '🎨',
        video_slider: '🎬',
        post_slider: '📰',
        post_title: '📝',
        post_content: '📄',
        posts_navigation: '↔️',
        comments: '💬',
        fullwidth_code: '📟',
        fullwidth_image: '🌅',
        fullwidth_map: '🗺️',
        fullwidth_menu: '☰',
        fullwidth_slider: '🎞️',
        fullwidth_portfolio: '🎨',
        fullwidth_header: '🔝',
        fullwidth_post_slider: '📰',
        newsletter: '📩',
        signup: '📝'
    };

    const TB = {
        pageId: parseInt(document.getElementById('page-id').value) || 0,
        csrfToken: document.getElementById('csrf-token').value,
        content: <?= $contentJson ?>,
        modules: <?= $modulesJson ?>,
        categories: <?= $categoriesJson ?>,
        themeColors: <?= $themeColorsJson ?? '{}' ?>,
        selectedElement: null,
        history: [],
        historyIndex: -1,
        draggedModule: null,
        draggedElement: null,
        dragOverColumn: null,
        insertionIndex: -1,

        // Responsive device state
        currentDevice: 'desktop',

        // Active settings tab
        currentTab: 'content',

        // Hover state system
        currentState: 'normal', // 'normal' or 'hover'
        hoverStyles: {}, // Cache of generated hover CSS per module
        hoverPreviewActive: false, // Whether hover preview mode is active

        init() {
            // Load Font Awesome icons
            fetch('/assets/fonts/fontawesome/fa-icons.json')
                .then(r => r.json())
                .then(data => { this.fontawesomeIcons = data; })
                .catch(e => console.warn('FA icons not loaded:', e));
            
            this.migrateContent(); // Migrate old data structure to new format
            this.renderModulesPanel();
            this.renderCanvas();
            this.bindEvents();
            this.bindDragDropEvents();
            this.saveToHistory();
            this.updateHoverStylesheet(); // Initialize hover styles
            
            // Sync status dropdown with hidden input
            const statusSelect = document.getElementById("page-status-select");
            if (statusSelect) {
                statusSelect.addEventListener("change", (e) => {
                    document.getElementById("page-status").value = e.target.value;
                });
            }
        },

        // Migrate old content structure to new rows/columns format
        migrateContent() {
            if (!this.content.sections) return;

            this.content.sections.forEach(section => {
                // If section has no rows, create default structure
                if (!section.rows || section.rows.length === 0) {
                    // Check if section has old-style columns directly
                    if (section.columns && section.columns.length > 0) {
                        section.rows = [{ id: 'row_' + Date.now(), columns: section.columns }];
                        delete section.columns;
                    }
                    // Check if section has modules directly (very old format)
                    else if (section.modules && section.modules.length > 0) {
                        section.rows = [{ id: 'row_' + Date.now(), columns: [{ id: 'col_' + Date.now(), width: '100%', modules: section.modules }] }];
                        delete section.modules;
                    }
                    // Otherwise create empty row
                    else {
                        section.rows = [{ id: 'row_' + Date.now(), columns: [{ id: 'col_' + Date.now(), width: '100%', modules: [] }] }];
                    }
                }

                // Ensure each row has columns
                section.rows.forEach(row => {
                    if (!row.columns || row.columns.length === 0) {
                        // Check if row has modules directly
                        if (row.modules && row.modules.length > 0) {
                            row.columns = [{ id: 'col_' + Date.now(), width: '100%', modules: row.modules }];
                            delete row.modules;
                        } else {
                            row.columns = [{ id: 'col_' + Date.now(), width: '100%', modules: [] }];
                        }
                    }

                    // Ensure each column has modules array and width
                    row.columns.forEach(col => {
                        if (!col.modules) col.modules = [];
                        if (!col.width) col.width = (100 / row.columns.length).toFixed(2) + '%';
                        if (!col.id) col.id = 'col_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    });

                    if (!row.id) row.id = 'row_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                });
            });

            console.log('Content migrated:', JSON.stringify(this.content, null, 2));
        },

        getModuleIcon(type) {
            return MODULE_ICONS[type] || this.modules[type]?.icon || '📦';
        },

        renderModulesPanel() {
            const panel = document.getElementById('modules-panel');
            let html = '';
            const modulesByCategory = {};
            for (const [slug, mod] of Object.entries(this.modules)) {
                const cat = mod.category || 'basic';
                if (!modulesByCategory[cat]) modulesByCategory[cat] = [];
                modulesByCategory[cat].push({ slug, ...mod });
            }
            for (const [category, mods] of Object.entries(modulesByCategory)) {
                const catLabel = this.categories[category] || category;
                html += '<div class="tb-module-category" data-category="' + category + '">';
                html += '<div class="tb-category-title">' + this.escapeHtml(catLabel) + '</div>';
                html += '<div class="tb-modules-grid">';
                for (const mod of mods) {
                    const icon = this.getModuleIcon(mod.slug);
                    html += '<div class="tb-module-item" draggable="true" data-module="' + mod.slug + '" title="' + this.escapeHtml(mod.description || mod.name || mod.slug) + '">';
                    html += '<div class="tb-module-icon">' + icon + '</div>';
                    html += '<div class="tb-module-name">' + this.escapeHtml(mod.name || mod.slug) + '</div>';
                    html += '</div>';
                }
                html += '</div></div>';
            }
            panel.innerHTML = html;
            this.bindModulePanelDrag();
        },

        renderCanvas() {
            console.log('=== renderCanvas called ===');
            const canvas = document.getElementById('canvas-inner');
            const sections = this.content.sections || [];
            console.log('sections count:', sections.length);
            if (sections.length === 0) {
                canvas.innerHTML = '<div class="tb-drop-zone tb-main-drop-zone" id="main-drop-zone" ondragover="TB.handleMainDropZoneDragOver(event)" ondragleave="TB.handleMainDropZoneDragLeave(event)" ondrop="TB.handleMainDropZoneDrop(event)"><div class="tb-drop-zone-text"><div class="tb-drop-zone-icon">📦</div><div>Drag modules here or click "Add Section" to start building</div></div></div>';
                this.updateHoverStylesheet(); // Update hover styles even for empty canvas
                return;
            }
            let html = '';
            sections.forEach((section, sIdx) => { html += this.renderSection(section, sIdx); });
            html += '<div class="tb-drop-zone tb-add-section-zone" style="margin: 16px; min-height: 60px;" onclick="TB.addSection()" ondragover="TB.handleMainDropZoneDragOver(event)" ondragleave="TB.handleMainDropZoneDragLeave(event)" ondrop="TB.handleMainDropZoneDrop(event)"><span>+ Add Section</span></div>';
            canvas.innerHTML = html;
            this.bindCanvasDragEvents();
            this.updateHoverStylesheet(); // Regenerate hover styles after canvas render
        },

        renderSection(section, sIdx) {
            const rows = section.rows || [];
            let rowsHtml = '';
            rows.forEach((row, rIdx) => { rowsHtml += this.renderRow(row, sIdx, rIdx); });
            const bgStyle = section.settings?.backgroundColor ? 'background-color:' + section.settings.backgroundColor + ';' : '';
            const paddingStyle = section.settings?.padding ? 'padding:' + section.settings.padding + ';' : '';
            return '<div class="tb-section" data-section-idx="' + sIdx + '" style="' + bgStyle + paddingStyle + '"><div class="tb-element-controls"><button type="button" class="tb-control-btn" onclick="TB.moveSection(' + sIdx + ', -1)" title="Move Up">↑</button><button type="button" class="tb-control-btn" onclick="TB.moveSection(' + sIdx + ', 1)" title="Move Down">↓</button><button type="button" class="tb-control-btn" onclick="TB.editSection(' + sIdx + ')" title="Settings">⚙</button><button type="button" class="tb-control-btn" onclick="TB.addRow(' + sIdx + ')" title="Add Row">+</button><button type="button" class="tb-control-btn" onclick="TB.duplicateSection(' + sIdx + ')" title="Duplicate">⧉</button><button type="button" class="tb-control-btn danger" onclick="TB.deleteSection(' + sIdx + ')" title="Delete">×</button></div>' + rowsHtml + '</div>';
        },

        renderRow(row, sIdx, rIdx) {
            const columns = row.columns || [{ modules: [] }];
            let colsHtml = '';
            columns.forEach((col, cIdx) => { colsHtml += this.renderColumn(col, sIdx, rIdx, cIdx); });

            // Determine current layout based on column count
            const colCount = columns.length;

            // Column structure selector with SVG icons
            const layoutOptions = `
                <div class="tb-layout-selector">
                    <button type="button" class="tb-layout-btn ${colCount === 1 ? 'active' : ''}" onclick="TB.setColumnLayout(${sIdx}, ${rIdx}, '1')" title="1 Column">
                        <svg viewBox="0 0 48 24"><rect x="2" y="4" width="44" height="16" rx="2" fill="currentColor"/></svg>
                    </button>
                    <button type="button" class="tb-layout-btn ${colCount === 2 ? 'active' : ''}" onclick="TB.setColumnLayout(${sIdx}, ${rIdx}, '1-1')" title="2 Columns 50/50">
                        <svg viewBox="0 0 48 24"><rect x="2" y="4" width="20" height="16" rx="2" fill="currentColor"/><rect x="26" y="4" width="20" height="16" rx="2" fill="currentColor"/></svg>
                    </button>
                    <button type="button" class="tb-layout-btn ${colCount === 3 ? 'active' : ''}" onclick="TB.setColumnLayout(${sIdx}, ${rIdx}, '1-1-1')" title="3 Columns 33/33/33">
                        <svg viewBox="0 0 48 24"><rect x="2" y="4" width="12" height="16" rx="2" fill="currentColor"/><rect x="18" y="4" width="12" height="16" rx="2" fill="currentColor"/><rect x="34" y="4" width="12" height="16" rx="2" fill="currentColor"/></svg>
                    </button>
                    <button type="button" class="tb-layout-btn ${colCount === 4 ? 'active' : ''}" onclick="TB.setColumnLayout(${sIdx}, ${rIdx}, '1-1-1-1')" title="4 Columns 25/25/25/25">
                        <svg viewBox="0 0 48 24"><rect x="2" y="4" width="8" height="16" rx="2" fill="currentColor"/><rect x="14" y="4" width="8" height="16" rx="2" fill="currentColor"/><rect x="26" y="4" width="8" height="16" rx="2" fill="currentColor"/><rect x="38" y="4" width="8" height="16" rx="2" fill="currentColor"/></svg>
                    </button>
                    <span class="tb-layout-divider"></span>
                    <button type="button" class="tb-layout-btn" onclick="TB.setColumnLayout(${sIdx}, ${rIdx}, '2-1')" title="2 Columns 66/33">
                        <svg viewBox="0 0 48 24"><rect x="2" y="4" width="28" height="16" rx="2" fill="currentColor"/><rect x="34" y="4" width="12" height="16" rx="2" fill="currentColor"/></svg>
                    </button>
                    <button type="button" class="tb-layout-btn" onclick="TB.setColumnLayout(${sIdx}, ${rIdx}, '1-2')" title="2 Columns 33/66">
                        <svg viewBox="0 0 48 24"><rect x="2" y="4" width="12" height="16" rx="2" fill="currentColor"/><rect x="18" y="4" width="28" height="16" rx="2" fill="currentColor"/></svg>
                    </button>
                    <button type="button" class="tb-layout-btn" onclick="TB.setColumnLayout(${sIdx}, ${rIdx}, '3-1')" title="2 Columns 75/25">
                        <svg viewBox="0 0 48 24"><rect x="2" y="4" width="32" height="16" rx="2" fill="currentColor"/><rect x="38" y="4" width="8" height="16" rx="2" fill="currentColor"/></svg>
                    </button>
                    <button type="button" class="tb-layout-btn" onclick="TB.setColumnLayout(${sIdx}, ${rIdx}, '1-3')" title="2 Columns 25/75">
                        <svg viewBox="0 0 48 24"><rect x="2" y="4" width="8" height="16" rx="2" fill="currentColor"/><rect x="14" y="4" width="32" height="16" rx="2" fill="currentColor"/></svg>
                    </button>
                    <button type="button" class="tb-layout-btn" onclick="TB.setColumnLayout(${sIdx}, ${rIdx}, '1-2-1')" title="3 Columns 25/50/25">
                        <svg viewBox="0 0 48 24"><rect x="2" y="4" width="8" height="16" rx="2" fill="currentColor"/><rect x="14" y="4" width="20" height="16" rx="2" fill="currentColor"/><rect x="38" y="4" width="8" height="16" rx="2" fill="currentColor"/></svg>
                    </button>
                </div>
            `;

            return '<div class="tb-row" data-row-idx="' + rIdx + '" data-section-idx="' + sIdx + '"><div class="tb-row-header">' + layoutOptions + '<div class="tb-row-actions"><button type="button" class="tb-row-action-btn" onclick="TB.deleteRow(' + sIdx + ', ' + rIdx + ')" title="Delete Row">×</button></div></div><div class="tb-row-columns">' + colsHtml + '</div></div>';
        },

        renderColumn(col, sIdx, rIdx, cIdx) {
            const modules = col.modules || [];
            let modsHtml = '<div class="tb-insertion-line tb-insertion-top" data-insert-idx="0" style="display:none;"></div>';
            modules.forEach((mod, mIdx) => {
                modsHtml += this.renderModule(mod, sIdx, rIdx, cIdx, mIdx);
                modsHtml += '<div class="tb-insertion-line" data-insert-idx="' + (mIdx + 1) + '" style="display:none;"></div>';
            });
            if (modules.length === 0) {
                modsHtml += '<div class="tb-column-empty"><span class="tb-column-empty-icon">📥</span><span>Drop module here</span></div>';
            }
            const widthStyle = col.width ? 'flex:0 0 ' + col.width + ';' : '';
            return '<div class="tb-column" data-col-idx="' + cIdx + '" data-row-idx="' + rIdx + '" data-section-idx="' + sIdx + '" data-path="' + sIdx + '-' + rIdx + '-' + cIdx + '" style="' + widthStyle + '" ondragover="TB.handleColumnDragOver(event, ' + sIdx + ', ' + rIdx + ', ' + cIdx + ')" ondragleave="TB.handleColumnDragLeave(event)" ondrop="TB.handleColumnDrop(event, ' + sIdx + ', ' + rIdx + ', ' + cIdx + ')">' + modsHtml + '</div>';
        },

        renderModule(mod, sIdx, rIdx, cIdx, mIdx) {
            const type = mod.type || 'text';
            const content = mod.content || {};
            const settings = mod.settings || {};
            const design = mod.design || {};
            const icon = this.getModuleIcon(type);
            const typoStyles = this.getTypographyStyles(settings);
            let preview = '';
            switch (type) {
                case 'text':
                    const textBodyTypo = this.getElementTypographyStyles(settings, 'body');
                    preview = content.text ? '<p style="color:#333;margin:0;' + textBodyTypo + '">' + this.escapeHtml(content.text.substring(0, 100)) + (content.text.length > 100 ? '...' : '') + '</p>' : '<p style="color:#94a3b8;font-style:italic;' + textBodyTypo + '">Click to add text...</p>';
                    break;
                case 'heading':
                    const tag = content.tag || 'h2';
                    const headingTitleTypo = this.getElementTypographyStyles(settings, 'title');
                    preview = '<' + tag + ' style="margin:0;color:#333;' + headingTitleTypo + '">' + this.escapeHtml(content.text || 'Heading') + '</' + tag + '>';
                    break;
                case 'image':
                    preview = content.src ? '<img src="' + this.escapeHtml(content.src) + '" alt="' + this.escapeHtml(content.alt || '') + '" style="max-width:100%;height:auto;border-radius:4px">' : '<div style="background:#e2e8f0;height:80px;display:flex;align-items:center;justify-content:center;border-radius:4px;color:#64748b">🖼 Click to add image</div>';
                    break;
                case 'button':
                    const btnStyle = content.style || 'primary';
                    const buttonTypo = this.getElementTypographyStyles(settings, 'button');
                    preview = '<button style="background:' + (btnStyle === 'secondary' ? '#64748b' : '#6366f1') + ';color:#fff;border:none;padding:10px 20px;border-radius:6px;font-weight:500;' + buttonTypo + '">' + this.escapeHtml(content.text || 'Button') + '</button>';
                    break;
                case 'divider':
                    preview = '<hr style="border:none;border-top:2px ' + (content.style || 'solid') + ' #e2e8f0;margin:8px 0">';
                    break;
                case 'spacer':
                    const height = content.height || '40px';
                    preview = '<div style="height:' + height + ';background:repeating-linear-gradient(45deg,#f8fafc,#f8fafc 10px,#f1f5f9 10px,#f1f5f9 20px);border-radius:4px;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:11px">' + height + ' spacer</div>';
                    break;
                case 'video':
                    preview = content.url ? '<div style="background:#1e293b;height:120px;display:flex;align-items:center;justify-content:center;border-radius:4px;color:#fff">🎬 Video</div>' : '<div style="background:#1e293b;height:80px;display:flex;align-items:center;justify-content:center;border-radius:4px;color:#94a3b8">🎬 Click to add video</div>';
                    break;
                case 'audio':
                    const audioUrl = content.audio_url || '';
                    const audioTitle = content.title || 'Untitled Track';
                    const audioArtist = content.artist || 'Unknown Artist';
                    const audioAlbum = content.album || '';
                    const audioCover = content.cover_image || '';
                    const audioStyle = content.style || 'default';
                    const audioShowCover = content.show_cover !== false;
                    const audioCoverSize = content.cover_size || '120px';
                    const audioBgColor = content.background_color || '#1e1e2e';
                    const audioTextColor = content.text_color || '#ffffff';
                    const audioAccentColor = content.accent_color || '#0073e6';
                    const audioShowDownload = content.show_download || false;

                    if (!audioUrl) {
                        preview = '<div style="background:' + audioBgColor + ';padding:24px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#94a3b8;flex-direction:column;gap:8px">';
                        preview += '<span style="font-size:32px">🎵</span>';
                        preview += '<span style="font-size:12px">Click to add audio</span>';
                        preview += '</div>';
                    } else {
                        // Different styles
                        if (audioStyle === 'minimal') {
                            // Minimal style - just controls
                            preview = '<div style="background:' + audioBgColor + ';padding:16px;border-radius:8px;color:' + audioTextColor + '">';
                            preview += '<div style="display:flex;align-items:center;gap:12px">';
                            preview += '<button style="width:40px;height:40px;border-radius:50%;background:' + audioAccentColor + ';border:none;color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center">▶</button>';
                            preview += '<div style="flex:1">';
                            preview += '<div style="font-size:14px;font-weight:500">' + this.escapeHtml(audioTitle) + '</div>';
                            preview += '<div style="font-size:12px;opacity:0.7">' + this.escapeHtml(audioArtist) + '</div>';
                            preview += '</div>';
                            preview += '<span style="font-size:12px;opacity:0.6">0:00 / 3:45</span>';
                            preview += '</div>';
                            preview += '<div style="margin-top:12px;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden"><div style="width:30%;height:100%;background:' + audioAccentColor + ';border-radius:2px"></div></div>';
                            preview += '</div>';
                        } else if (audioStyle === 'card') {
                            // Card style - vertical layout
                            preview = '<div style="background:' + audioBgColor + ';padding:20px;border-radius:12px;color:' + audioTextColor + ';text-align:center;max-width:280px;margin:0 auto">';
                            if (audioShowCover) {
                                if (audioCover) {
                                    preview += '<img src="' + this.escapeHtml(audioCover) + '" style="width:' + audioCoverSize + ';height:' + audioCoverSize + ';object-fit:cover;border-radius:8px;margin-bottom:16px">';
                                } else {
                                    preview += '<div style="width:' + audioCoverSize + ';height:' + audioCoverSize + ';background:rgba(255,255,255,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:48px">🎵</div>';
                                }
                            }
                            preview += '<div style="font-size:16px;font-weight:600;margin-bottom:4px">' + this.escapeHtml(audioTitle) + '</div>';
                            preview += '<div style="font-size:13px;opacity:0.7;margin-bottom:4px">' + this.escapeHtml(audioArtist) + '</div>';
                            if (audioAlbum) preview += '<div style="font-size:12px;opacity:0.5;margin-bottom:16px">' + this.escapeHtml(audioAlbum) + '</div>';
                            preview += '<div style="display:flex;align-items:center;justify-content:center;gap:16px;margin:16px 0">';
                            preview += '<span style="opacity:0.6;font-size:18px">⏮</span>';
                            preview += '<button style="width:48px;height:48px;border-radius:50%;background:' + audioAccentColor + ';border:none;color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center">▶</button>';
                            preview += '<span style="opacity:0.6;font-size:18px">⏭</span>';
                            preview += '</div>';
                            preview += '<div style="display:flex;align-items:center;gap:8px;font-size:11px;opacity:0.6"><span>0:00</span><div style="flex:1;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden"><div style="width:30%;height:100%;background:' + audioAccentColor + '"></div></div><span>3:45</span></div>';
                            if (audioShowDownload) preview += '<div style="margin-top:12px"><span style="font-size:12px;opacity:0.6;cursor:pointer">⬇ Download</span></div>';
                            preview += '</div>';
                        } else {
                            // Default style - horizontal with cover
                            preview = '<div style="background:' + audioBgColor + ';padding:16px;border-radius:8px;display:flex;align-items:center;gap:16px;color:' + audioTextColor + '">';
                            if (audioShowCover) {
                                if (audioCover) {
                                    preview += '<img src="' + this.escapeHtml(audioCover) + '" style="width:' + audioCoverSize + ';height:' + audioCoverSize + ';object-fit:cover;border-radius:8px;flex-shrink:0">';
                                } else {
                                    preview += '<div style="width:' + audioCoverSize + ';height:' + audioCoverSize + ';background:rgba(255,255,255,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:48px">🎵</div>';
                                }
                            }
                            preview += '<div style="flex:1;min-width:0">';
                            preview += '<div style="font-size:16px;font-weight:600;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + this.escapeHtml(audioTitle) + '</div>';
                            preview += '<div style="font-size:13px;opacity:0.7;margin-bottom:2px">' + this.escapeHtml(audioArtist) + '</div>';
                            if (audioAlbum) preview += '<div style="font-size:12px;opacity:0.5;margin-bottom:12px">' + this.escapeHtml(audioAlbum) + '</div>';
                            preview += '<div style="display:flex;align-items:center;gap:12px">';
                            preview += '<button style="width:36px;height:36px;border-radius:50%;background:' + audioAccentColor + ';border:none;color:#fff;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0">▶</button>';
                            preview += '<div style="flex:1;display:flex;flex-direction:column;gap:4px">';
                            preview += '<div style="height:4px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden"><div style="width:30%;height:100%;background:' + audioAccentColor + '"></div></div>';
                            preview += '<div style="display:flex;justify-content:space-between;font-size:10px;opacity:0.6"><span>0:00</span><span>3:45</span></div>';
                            preview += '</div>';
                            preview += '<span style="font-size:16px;opacity:0.6;flex-shrink:0">🔊</span>';
                            if (audioShowDownload) preview += '<span style="font-size:14px;opacity:0.6;cursor:pointer;flex-shrink:0" title="Download">⬇</span>';
                            preview += '</div></div></div>';
                        }
                    }
                    break;
                case 'code':
                    preview = content.code ? '<pre style="background:#1e293b;color:#a5f3fc;padding:12px;border-radius:4px;font-size:11px;overflow:hidden;max-height:80px;margin:0">' + this.escapeHtml(content.code.substring(0, 150)) + '</pre>' : '<div style="background:#1e293b;padding:12px;border-radius:4px;color:#94a3b8;font-family:monospace">💻 Code block</div>';
                    break;
                case 'html':
                    preview = '<div style="background:#fef3c7;padding:12px;border-radius:4px;color:#92400e;font-size:12px">🔧 Custom HTML block</div>';
                    break;
                case 'quote':
                    const quoteTypo = this.getElementTypographyStyles(settings, 'quote');
                    const quoteAuthorTypo = this.getElementTypographyStyles(settings, 'author');
                    if (content.text) {
                        preview = '<blockquote style="border-left:4px solid #6366f1;padding-left:16px;margin:0;color:#475569;font-style:italic;' + quoteTypo + '">"' + this.escapeHtml(content.text.substring(0, 80)) + '..."</blockquote>';
                        if (content.author) {
                            preview += '<div style="padding-left:16px;margin-top:8px;font-size:13px;color:#64748b;' + quoteAuthorTypo + '">— ' + this.escapeHtml(content.author) + '</div>';
                        }
                    } else {
                        preview = '<blockquote style="border-left:4px solid #e2e8f0;padding-left:16px;margin:0;color:#94a3b8;font-style:italic;' + quoteTypo + '">💬 Add quote text...</blockquote>';
                    }
                    break;
                case 'blurb':
                    const blurbLayout = content.layout || 'top';
                    const blurbAlign = content.alignment || 'center';
                    const blurbIcon = content.icon || 'star';
                    const blurbIconSize = content.icon_size || '64px';
                    const blurbIconColor = content.icon_color || '#0073e6';
                    const blurbTitle = content.title || 'Your Title Here';
                    const blurbText = content.text || 'Your description text goes here.';
                    const blurbUseImage = content.use_image || false;
                    const blurbImage = content.image || '';
                    const blurbTitleTypo = this.getElementTypographyStyles(settings, 'title');
                    const blurbTextTypo = this.getElementTypographyStyles(settings, 'text');
                    let blurbIconHtml = '';
                    if (blurbUseImage && blurbImage) {
                        blurbIconHtml = '<img src="' + this.escapeHtml(blurbImage) + '" style="width:' + blurbIconSize + ';height:' + blurbIconSize + ';object-fit:cover;border-radius:8px">';
                    } else {
                        // Use renderIconFromFormat for full icon library support (fa:star, material:home, etc.)
                        blurbIconHtml = '<div style="font-size:' + blurbIconSize + ';line-height:1;color:' + blurbIconColor + '">' + this.renderIconFromFormat(blurbIcon) + '</div>';
                    }
                    const blurbFlexDir = blurbLayout === 'left' ? 'row' : (blurbLayout === 'right' ? 'row-reverse' : 'column');
                    const blurbTextAlign = blurbLayout === 'top' ? blurbAlign : 'left';
                    preview = '<div style="display:flex;flex-direction:' + blurbFlexDir + ';align-items:' + (blurbLayout === 'top' ? blurbAlign : 'flex-start') + ';gap:16px;text-align:' + blurbTextAlign + '">';
                    preview += '<div style="flex-shrink:0">' + blurbIconHtml + '</div>';
                    preview += '<div style="flex:1"><h4 style="margin:0 0 8px 0;font-size:18px;color:#333;' + blurbTitleTypo + '">' + this.escapeHtml(blurbTitle) + '</h4>';
                    preview += '<p style="margin:0;font-size:14px;color:#666;' + blurbTextTypo + '">' + this.escapeHtml(blurbText.substring(0, 100)) + (blurbText.length > 100 ? '...' : '') + '</p></div></div>';
                    break;
                case 'hero':
                    const heroTitle = content.title || 'Welcome to Our Site';
                    const heroSubtitle = content.subtitle || 'We build amazing digital experiences';
                    const heroBgType = content.background_type || 'color';
                    const heroBgColor = content.background_color || '#1e1e2e';
                    const heroBgImage = content.background_image || '';
                    const heroGradientStart = content.gradient_start || '#667eea';
                    const heroGradientEnd = content.gradient_end || '#764ba2';
                    const heroOverlay = content.overlay_color || 'rgba(0,0,0,0.5)';
                    const heroMinHeight = content.min_height || '600px';
                    const heroTextColor = content.text_color || '#ffffff';
                    const heroAlign = content.alignment || 'center';
                    const heroPrimaryText = content.primary_button_text || 'Get Started';
                    const heroSecondaryText = content.secondary_button_text || 'Learn More';
                    const heroShowSecondary = content.show_secondary !== false;
                    const heroTitleTypo = this.getElementTypographyStyles(settings, 'title');
                    const heroSubtitleTypo = this.getElementTypographyStyles(settings, 'subtitle');
                    const heroButtonTypo = this.getElementTypographyStyles(settings, 'button');
                    let heroBgStyle = '';
                    if (heroBgType === 'gradient') {
                        heroBgStyle = 'background:linear-gradient(135deg,' + heroGradientStart + ',' + heroGradientEnd + ')';
                    } else if (heroBgType === 'image' && heroBgImage) {
                        heroBgStyle = 'background:linear-gradient(' + heroOverlay + ',' + heroOverlay + '),url(' + this.escapeHtml(heroBgImage) + ') center/cover no-repeat';
                    } else {
                        heroBgStyle = 'background:' + heroBgColor;
                    }
                    preview = '<div style="' + heroBgStyle + ';min-height:200px;padding:40px 20px;display:flex;flex-direction:column;justify-content:center;align-items:' + heroAlign + ';text-align:' + heroAlign + ';border-radius:8px">';
                    preview += '<h1 style="margin:0 0 12px 0;font-size:28px;font-weight:700;color:' + heroTextColor + ';' + heroTitleTypo + '">' + this.escapeHtml(heroTitle) + '</h1>';
                    preview += '<p style="margin:0 0 20px 0;font-size:16px;color:' + heroTextColor + ';opacity:0.9;' + heroSubtitleTypo + '">' + this.escapeHtml(heroSubtitle) + '</p>';
                    preview += '<div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:' + heroAlign + '">';
                    preview += '<button style="padding:10px 20px;background:#0073e6;color:#fff;border:none;border-radius:4px;font-size:14px;cursor:pointer;' + heroButtonTypo + '">' + this.escapeHtml(heroPrimaryText) + '</button>';
                    if (heroShowSecondary) {
                        preview += '<button style="padding:10px 20px;background:transparent;color:' + heroTextColor + ';border:2px solid ' + heroTextColor + ';border-radius:4px;font-size:14px;cursor:pointer;' + heroButtonTypo + '">' + this.escapeHtml(heroSecondaryText) + '</button>';
                    }
                    preview += '</div></div>';
                    break;
                case 'slider':
                    const slides = content.slides || [{ title: 'Slide 1', text: 'Description for slide 1', image: '', button_text: 'Learn More', button_url: '#' }];
                    const sliderMinHeight = content.min_height || '400px';
                    const sliderShowArrows = content.show_arrows !== false;
                    const sliderShowDots = content.show_dots !== false;
                    const sliderAutoplay = content.autoplay !== false;
                    const sliderTitleTypo = this.getElementTypographyStyles(settings, 'title');
                    const sliderTextTypo = this.getElementTypographyStyles(settings, 'text');
                    const sliderButtonTypo = this.getElementTypographyStyles(settings, 'button');
                    const currentSlide = slides[0] || {};
                    const slideImage = currentSlide.image || '';
                    const slideTitle = currentSlide.title || 'Slide Title';
                    const slideText = currentSlide.text || 'Slide description';
                    const slideButtonText = currentSlide.button_text || 'Learn More';
                    let slideBg = slideImage ? 'background:linear-gradient(rgba(0,0,0,0.4),rgba(0,0,0,0.4)),url(' + this.escapeHtml(slideImage) + ') center/cover no-repeat' : 'background:linear-gradient(135deg,#667eea,#764ba2)';
                    preview = '<div style="position:relative;' + slideBg + ';min-height:200px;border-radius:8px;overflow:hidden">';
                    preview += '<div style="position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px">';
                    preview += '<h3 style="margin:0 0 8px 0;font-size:22px;font-weight:700;color:#fff;' + sliderTitleTypo + '">' + this.escapeHtml(slideTitle) + '</h3>';
                    preview += '<p style="margin:0 0 16px 0;font-size:14px;color:#fff;opacity:0.9;' + sliderTextTypo + '">' + this.escapeHtml(slideText) + '</p>';
                    preview += '<button style="padding:8px 16px;background:#0073e6;color:#fff;border:none;border-radius:4px;font-size:13px;cursor:pointer;' + sliderButtonTypo + '">' + this.escapeHtml(slideButtonText) + '</button>';
                    preview += '</div>';
                    if (sliderShowArrows) {
                        preview += '<div style="position:absolute;left:8px;top:50%;transform:translateY(-50%);width:28px;height:28px;background:rgba(255,255,255,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px">❮</div>';
                        preview += '<div style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:28px;height:28px;background:rgba(255,255,255,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px">❯</div>';
                    }
                    if (sliderShowDots && slides.length > 0) {
                        preview += '<div style="position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:6px">';
                        for (let i = 0; i < Math.min(slides.length, 5); i++) {
                            preview += '<div style="width:8px;height:8px;border-radius:50%;background:' + (i === 0 ? '#fff' : 'rgba(255,255,255,0.5)') + '"></div>';
                        }
                        if (slides.length > 5) preview += '<div style="color:#fff;font-size:10px;margin-left:4px">+' + (slides.length - 5) + '</div>';
                        preview += '</div>';
                    }
                    preview += '<div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);color:#fff;padding:2px 8px;border-radius:4px;font-size:11px">' + slides.length + ' slide' + (slides.length !== 1 ? 's' : '') + (sliderAutoplay ? ' • Auto' : '') + '</div>';
                    preview += '</div>';
                    break;
                case 'video_slider':
                    const vsVideos = content.videos || [{ title: 'Video One', url: '', thumbnail: '', description: '' }];
                    const vsLayout = content.layout || 'slider';
                    const vsColumns = parseInt(content.columns) || 3;
                    const vsShowThumbs = content.show_thumbnails !== false;
                    const vsThumbPosition = content.thumbnail_position || 'bottom';
                    const vsShowTitle = content.show_title !== false;
                    const vsShowDesc = content.show_description || false;
                    const vsShowArrows = content.show_arrows !== false;
                    const vsShowDots = content.show_dots !== false;
                    const vsAutoplay = content.autoplay_slider || false;
                    const vsPlayIconColor = content.play_icon_color || '#ffffff';
                    const vsPlayIconSize = content.play_icon_size || '64px';
                    const vsOverlayColor = content.overlay_color || 'rgba(0,0,0,0.3)';
                    const vsAspectRatio = content.aspect_ratio || '16:9';
                    const vsBorderRadius = content.border_radius || '8px';
                    const vsGap = content.gap || '16px';
                    const vsTitleTypo = this.getElementTypographyStyles(settings, 'title');
                    const vsDescTypo = this.getElementTypographyStyles(settings, 'description');
                    // Calculate aspect ratio padding
                    const vsAspectMap = { '1:1': '100%', '4:3': '75%', '16:9': '56.25%' };
                    const vsAspectPadding = vsAspectMap[vsAspectRatio] || '56.25%';
                    // Get current video (first one for preview)
                    const currentVideo = vsVideos[0] || { title: 'Video', url: '', thumbnail: '' };
                    // Try to get thumbnail from YouTube URL if not provided
                    const getYouTubeThumbnail = (url) => {
                        if (!url) return '';
                        const ytMatch = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                        if (ytMatch) return 'https://img.youtube.com/vi/' + ytMatch[1] + '/maxresdefault.jpg';
                        return '';
                    };
                    const currentThumb = currentVideo.thumbnail || getYouTubeThumbnail(currentVideo.url);
                    if (vsLayout === 'slider') {
                        // Slider layout
                        let vsBg = currentThumb ? 'background:url(' + this.escapeHtml(currentThumb) + ') center/cover no-repeat' : 'background:linear-gradient(135deg,#1e293b,#334155)';
                        preview = '<div style="position:relative;' + vsBg + ';padding-bottom:' + vsAspectPadding + ';border-radius:' + vsBorderRadius + ';overflow:hidden">';
                        // Overlay
                        preview += '<div style="position:absolute;inset:0;background:' + vsOverlayColor + '">';
                        // Play button
                        preview += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:' + vsPlayIconSize + ';height:' + vsPlayIconSize + ';background:rgba(0,0,0,0.6);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer">';
                        preview += '<span style="color:' + vsPlayIconColor + ';font-size:calc(' + vsPlayIconSize + ' * 0.4);margin-left:4px">▶</span>';
                        preview += '</div>';
                        // Title overlay
                        if (vsShowTitle && currentVideo.title) {
                            preview += '<div style="position:absolute;bottom:' + (vsShowThumbs && vsThumbPosition === 'bottom' ? '70px' : '12px') + ';left:12px;right:12px;color:#fff;font-size:16px;font-weight:600;text-shadow:0 1px 3px rgba(0,0,0,0.5);' + vsTitleTypo + '">' + this.escapeHtml(currentVideo.title) + '</div>';
                        }
                        preview += '</div>';
                        // Navigation arrows
                        if (vsShowArrows && vsVideos.length > 1) {
                            preview += '<div style="position:absolute;left:8px;top:50%;transform:translateY(-50%);width:28px;height:28px;background:rgba(255,255,255,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px">❮</div>';
                            preview += '<div style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:28px;height:28px;background:rgba(255,255,255,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px">❯</div>';
                        }
                        // Dots
                        if (vsShowDots && vsVideos.length > 1) {
                            preview += '<div style="position:absolute;bottom:' + (vsShowThumbs && vsThumbPosition === 'bottom' ? '60px' : '8px') + ';left:50%;transform:translateX(-50%);display:flex;gap:6px">';
                            for (let i = 0; i < Math.min(vsVideos.length, 5); i++) {
                                preview += '<div style="width:8px;height:8px;border-radius:50%;background:' + (i === 0 ? '#fff' : 'rgba(255,255,255,0.5)') + '"></div>';
                            }
                            if (vsVideos.length > 5) preview += '<div style="color:#fff;font-size:10px;margin-left:4px">+' + (vsVideos.length - 5) + '</div>';
                            preview += '</div>';
                        }
                        // Video count badge
                        preview += '<div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);color:#fff;padding:2px 8px;border-radius:4px;font-size:11px">🎬 ' + vsVideos.length + ' video' + (vsVideos.length !== 1 ? 's' : '') + (vsAutoplay ? ' • Auto' : '') + '</div>';
                        preview += '</div>';
                        // Thumbnail strip (if enabled and position is bottom)
                        if (vsShowThumbs && vsThumbPosition === 'bottom' && vsVideos.length > 1) {
                            preview += '<div style="display:flex;gap:8px;margin-top:8px;overflow-x:auto;padding:4px 0">';
                            vsVideos.slice(0, 5).forEach((vid, idx) => {
                                const thumbUrl = vid.thumbnail || getYouTubeThumbnail(vid.url);
                                preview += '<div style="flex:0 0 80px;height:45px;border-radius:4px;overflow:hidden;border:2px solid ' + (idx === 0 ? '#0073e6' : 'transparent') + ';cursor:pointer">';
                                if (thumbUrl) {
                                    preview += '<img src="' + this.escapeHtml(thumbUrl) + '" style="width:100%;height:100%;object-fit:cover">';
                                } else {
                                    preview += '<div style="width:100%;height:100%;background:#334155;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:16px">🎬</div>';
                                }
                                preview += '</div>';
                            });
                            if (vsVideos.length > 5) preview += '<div style="flex:0 0 40px;height:45px;display:flex;align-items:center;justify-content:center;color:#64748b;font-size:12px">+' + (vsVideos.length - 5) + '</div>';
                            preview += '</div>';
                        }
                    } else if (vsLayout === 'grid') {
                        // Grid layout
                        const displayCount = Math.min(vsVideos.length, 6);
                        const gridCols = Math.min(vsColumns, 3);
                        preview = '<div style="display:grid;grid-template-columns:repeat(' + gridCols + ',1fr);gap:' + vsGap + '">';
                        for (let i = 0; i < displayCount; i++) {
                            const vid = vsVideos[i];
                            const thumbUrl = vid.thumbnail || getYouTubeThumbnail(vid.url);
                            preview += '<div style="position:relative;border-radius:' + vsBorderRadius + ';overflow:hidden">';
                            preview += '<div style="padding-bottom:' + vsAspectPadding + ';background:' + (thumbUrl ? 'url(' + this.escapeHtml(thumbUrl) + ') center/cover no-repeat' : 'linear-gradient(135deg,#1e293b,#334155)') + '">';
                            // Overlay with play button
                            preview += '<div style="position:absolute;inset:0;background:' + vsOverlayColor + ';display:flex;align-items:center;justify-content:center">';
                            preview += '<div style="width:40px;height:40px;background:rgba(0,0,0,0.6);border-radius:50%;display:flex;align-items:center;justify-content:center">';
                            preview += '<span style="color:' + vsPlayIconColor + ';font-size:16px;margin-left:2px">▶</span>';
                            preview += '</div></div>';
                            // Title
                            if (vsShowTitle && vid.title) {
                                preview += '<div style="position:absolute;bottom:8px;left:8px;right:8px;color:#fff;font-size:12px;font-weight:500;text-shadow:0 1px 2px rgba(0,0,0,0.5);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;' + vsTitleTypo + '">' + this.escapeHtml(vid.title) + '</div>';
                            }
                            preview += '</div></div>';
                        }
                        preview += '</div>';
                        if (vsVideos.length > 6) {
                            preview += '<div style="text-align:center;margin-top:8px;color:#64748b;font-size:11px">+' + (vsVideos.length - 6) + ' more videos</div>';
                        }
                    } else {
                        // List layout
                        const listCount = Math.min(vsVideos.length, 4);
                        preview = '<div style="display:flex;flex-direction:column;gap:' + vsGap + '">';
                        for (let i = 0; i < listCount; i++) {
                            const vid = vsVideos[i];
                            const thumbUrl = vid.thumbnail || getYouTubeThumbnail(vid.url);
                            preview += '<div style="display:flex;gap:12px;align-items:center">';
                            // Thumbnail
                            preview += '<div style="flex:0 0 120px;position:relative;border-radius:' + vsBorderRadius + ';overflow:hidden">';
                            preview += '<div style="padding-bottom:56.25%;background:' + (thumbUrl ? 'url(' + this.escapeHtml(thumbUrl) + ') center/cover no-repeat' : 'linear-gradient(135deg,#1e293b,#334155)') + '">';
                            preview += '<div style="position:absolute;inset:0;background:' + vsOverlayColor + ';display:flex;align-items:center;justify-content:center">';
                            preview += '<div style="width:32px;height:32px;background:rgba(0,0,0,0.6);border-radius:50%;display:flex;align-items:center;justify-content:center">';
                            preview += '<span style="color:' + vsPlayIconColor + ';font-size:12px;margin-left:2px">▶</span>';
                            preview += '</div></div></div></div>';
                            // Info
                            preview += '<div style="flex:1;min-width:0">';
                            if (vsShowTitle) preview += '<div style="font-size:13px;font-weight:600;color:#1e293b;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;' + vsTitleTypo + '">' + this.escapeHtml(vid.title || 'Untitled Video') + '</div>';
                            if (vsShowDesc && vid.description) preview += '<div style="font-size:11px;color:#64748b;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;' + vsDescTypo + '">' + this.escapeHtml(vid.description) + '</div>';
                            preview += '</div></div>';
                        }
                        preview += '</div>';
                        if (vsVideos.length > 4) {
                            preview += '<div style="text-align:center;margin-top:8px;color:#64748b;font-size:11px">+' + (vsVideos.length - 4) + ' more videos</div>';
                        }
                    }
                    break;
                case 'blog':
                    const blogPostsCount = parseInt(content.posts_count) || 6;
                    const blogColumns = parseInt(content.columns) || 3;
                    const blogGap = content.gap || '30px';
                    const blogCardStyle = content.card_style || 'card';
                    const blogShowImage = content.show_image !== false;
                    const blogShowExcerpt = content.show_excerpt !== false;
                    const blogShowDate = content.show_date !== false;
                    const blogShowAuthor = content.show_author !== false;
                    const blogCategory = content.category || 'All Categories';
                    // Sample posts for preview
                    const samplePosts = [
                        { title: 'Getting Started with Our Platform', date: 'Dec 10, 2025', author: 'Admin' },
                        { title: 'Best Practices for Content Creation', date: 'Dec 8, 2025', author: 'Editor' },
                        { title: 'Understanding Your Analytics', date: 'Dec 5, 2025', author: 'Admin' }
                    ];
                    const displayPosts = Math.min(blogPostsCount, 3);
                    const cardBg = blogCardStyle === 'minimal' ? 'transparent' : '#fff';
                    const cardBorder = blogCardStyle === 'card' ? 'border:1px solid #e2e8f0;border-radius:8px;overflow:hidden' : '';
                    const cardShadow = blogCardStyle === 'card' ? 'box-shadow:0 2px 4px rgba(0,0,0,0.1)' : '';
                    preview = '<div style="display:grid;grid-template-columns:repeat(' + Math.min(blogColumns, 3) + ',1fr);gap:12px">';
                    for (let i = 0; i < displayPosts; i++) {
                        const post = samplePosts[i];
                        preview += '<div style="background:' + cardBg + ';' + cardBorder + ';' + cardShadow + '">';
                        if (blogShowImage) {
                            preview += '<div style="background:linear-gradient(135deg,#667eea,#764ba2);height:80px;display:flex;align-items:center;justify-content:center"><span style="color:#fff;font-size:24px">📷</span></div>';
                        }
                        preview += '<div style="padding:12px">';
                        preview += '<h4 style="margin:0 0 6px 0;font-size:13px;font-weight:600;color:#1e293b;line-height:1.3">' + this.escapeHtml(post.title) + '</h4>';
                        if (blogShowExcerpt) {
                            preview += '<p style="margin:0 0 8px 0;font-size:11px;color:#64748b;line-height:1.4">Lorem ipsum dolor sit amet, consectetur adipiscing elit...</p>';
                        }
                        if (blogShowDate || blogShowAuthor) {
                            preview += '<div style="font-size:10px;color:#94a3b8">';
                            if (blogShowDate) preview += post.date;
                            if (blogShowDate && blogShowAuthor) preview += ' • ';
                            if (blogShowAuthor) preview += post.author;
                            preview += '</div>';
                        }
                        preview += '</div></div>';
                    }
                    preview += '</div>';
                    preview += '<div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center;font-size:10px;color:#64748b">';
                    preview += '<span>📰 ' + blogPostsCount + ' posts • ' + blogColumns + ' columns</span>';
                    preview += '<span>' + (blogCategory ? blogCategory : 'All') + '</span>';
                    preview += '</div>';
                    break;
                case 'post_slider':
                    // Post Slider - Dynamic slider pulling posts from CMS database
                    const psPostCount = parseInt(content.post_count) || 5;
                    const psCategory = content.category || '';
                    const psOrderBy = content.order_by || 'date';
                    const psOrder = content.order || 'desc';
                    const psShowImage = content.show_image !== false;
                    const psShowTitle = content.show_title !== false;
                    const psShowMeta = content.show_meta !== false;
                    const psShowExcerpt = content.show_excerpt !== false;
                    const psExcerptLength = parseInt(content.excerpt_length) || 150;
                    const psShowReadMore = content.show_read_more !== false;
                    const psReadMoreText = content.read_more_text || 'Read More';
                    const psMinHeight = content.min_height || '500px';
                    const psBgOverlay = content.background_overlay || 'rgba(0,0,0,0.4)';
                    const psTextColor = content.text_color || '#ffffff';
                    const psTitleSize = content.title_size || '36px';
                    const psContentWidth = content.content_width || '800px';
                    const psTextAlign = content.text_alignment || 'center';
                    const psAutoplay = content.autoplay !== false;
                    const psShowArrows = content.show_arrows !== false;
                    const psShowDots = content.show_dots !== false;
                    const psParallax = content.parallax || false;
                    const psUseBgImage = content.use_bg_image !== false;
                    const psTitleTypo = this.getElementTypographyStyles(settings, 'title');
                    const psMetaTypo = this.getElementTypographyStyles(settings, 'meta');
                    const psExcerptTypo = this.getElementTypographyStyles(settings, 'excerpt');
                    const psButtonTypo = this.getElementTypographyStyles(settings, 'button');

                    // Sample posts for preview (simulating dynamic content)
                    const psSamplePosts = [
                        { title: 'Sample Post Title', date: 'Dec 15, 2025', author: 'Admin', category: 'Category' },
                        { title: 'Another Great Article', date: 'Dec 14, 2025', author: 'Editor', category: 'News' },
                        { title: 'Latest Updates & News', date: 'Dec 13, 2025', author: 'Admin', category: 'Updates' }
                    ];
                    const psCurrentPost = psSamplePosts[0];

                    // Fullwidth slider preview
                    let psBgStyle = psUseBgImage
                        ? 'background:linear-gradient(' + psBgOverlay + ',' + psBgOverlay + '),url(data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect fill="#667eea" width="400" height="300"/><text x="200" y="150" fill="#fff" font-size="48" text-anchor="middle" dominant-baseline="middle">📷</text></svg>') + ') center/cover no-repeat'
                        : 'background:linear-gradient(' + psBgOverlay + ',' + psBgOverlay + '),linear-gradient(135deg,#667eea,#764ba2)';

                    preview = '<div style="position:relative;' + psBgStyle + ';min-height:200px;border-radius:8px;overflow:hidden">';
                    preview += '<div style="position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:' + psTextAlign + ';text-align:' + psTextAlign + ';padding:20px">';
                    preview += '<div style="max-width:' + psContentWidth + ';width:100%">';

                    // Title
                    if (psShowTitle) {
                        preview += '<h2 style="margin:0 0 12px 0;font-size:22px;font-weight:700;color:' + psTextColor + ';' + psTitleTypo + '">' + this.escapeHtml(psCurrentPost.title) + '</h2>';
                    }

                    // Meta (date | author | category)
                    if (psShowMeta) {
                        preview += '<div style="margin:0 0 12px 0;font-size:12px;color:' + psTextColor + ';opacity:0.85;' + psMetaTypo + '">';
                        preview += this.escapeHtml(psCurrentPost.date) + ' | by ' + this.escapeHtml(psCurrentPost.author) + ' | in ' + this.escapeHtml(psCurrentPost.category);
                        preview += '</div>';
                    }

                    // Excerpt
                    if (psShowExcerpt) {
                        preview += '<p style="margin:0 0 16px 0;font-size:13px;color:' + psTextColor + ';opacity:0.9;line-height:1.5;' + psExcerptTypo + '">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua...</p>';
                    }

                    // Read More button
                    if (psShowReadMore) {
                        preview += '<button style="padding:10px 20px;background:#0073e6;color:#fff;border:none;border-radius:4px;font-size:13px;cursor:pointer;' + psButtonTypo + '">' + this.escapeHtml(psReadMoreText) + '</button>';
                    }

                    preview += '</div></div>';

                    // Navigation arrows
                    if (psShowArrows) {
                        preview += '<div style="position:absolute;left:8px;top:50%;transform:translateY(-50%);width:32px;height:32px;background:rgba(255,255,255,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;box-shadow:0 2px 4px rgba(0,0,0,0.2)">❮</div>';
                        preview += '<div style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:32px;height:32px;background:rgba(255,255,255,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;box-shadow:0 2px 4px rgba(0,0,0,0.2)">❯</div>';
                    }

                    // Navigation dots
                    if (psShowDots && psPostCount > 0) {
                        preview += '<div style="position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:6px">';
                        for (let i = 0; i < Math.min(psPostCount, 5); i++) {
                            preview += '<div style="width:10px;height:10px;border-radius:50%;background:' + (i === 0 ? '#fff' : 'rgba(255,255,255,0.5)') + ';cursor:pointer"></div>';
                        }
                        if (psPostCount > 5) preview += '<div style="color:#fff;font-size:10px;margin-left:4px">+' + (psPostCount - 5) + '</div>';
                        preview += '</div>';
                    }

                    // Info badge
                    preview += '<div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);color:#fff;padding:4px 10px;border-radius:4px;font-size:11px">';
                    preview += '📰 ' + psPostCount + ' post' + (psPostCount !== 1 ? 's' : '');
                    if (psCategory) preview += ' • ' + this.escapeHtml(psCategory);
                    if (psAutoplay) preview += ' • Auto';
                    if (psParallax) preview += ' • Parallax';
                    preview += '</div>';

                    // Dynamic content note
                    preview += '<div style="position:absolute;top:8px;left:8px;background:rgba(59,130,246,0.9);color:#fff;padding:4px 8px;border-radius:4px;font-size:10px">⚡ Dynamic</div>';

                    preview += '</div>';
                    break;
                case 'post_title':
                    // Post Title - Dynamic post/page title with meta info for theme builder templates
                    const ptShowTitle = content.show_title !== false;
                    const ptShowMeta = content.show_meta !== false;
                    const ptShowAuthor = content.show_author !== false;
                    const ptShowDate = content.show_date !== false;
                    const ptShowCategories = content.show_categories !== false;
                    const ptShowComments = content.show_comments_count !== false;
                    const ptShowFeaturedImage = content.show_featured_image !== false;
                    const ptFeaturedImagePlacement = content.featured_image_placement || 'background';
                    const ptDateFormat = content.date_format || 'M d, Y';
                    const ptTitleLevel = content.title_level || 'h1';
                    const ptTitleSize = content.title_size || '42px';
                    const ptTitleColor = content.title_color || '#1e293b';
                    const ptMetaColor = content.meta_color || '#64748b';
                    const ptMetaSize = content.meta_size || '14px';
                    const ptMetaSeparator = content.meta_separator || '|';
                    const ptTextAlignment = content.text_alignment || 'left';
                    const ptBgOverlay = content.background_overlay || 'rgba(0,0,0,0.5)';
                    const ptTextOnImageColor = content.text_on_image_color || '#ffffff';
                    const ptMinHeight = content.min_height || '400px';
                    const ptContentWidth = content.content_width || '100%';
                    const ptPaddingTop = content.padding_top || '60px';
                    const ptPaddingBottom = content.padding_bottom || '60px';
                    const ptTitleTypo = this.getElementTypographyStyles(settings, 'title');
                    const ptMetaTypo = this.getElementTypographyStyles(settings, 'meta');

                    // Placeholder content for preview
                    const ptPlaceholderTitle = 'Dynamic Post Title';
                    const ptPlaceholderDate = 'Dec 15, 2025';
                    const ptPlaceholderAuthor = 'Admin';
                    const ptPlaceholderCategory = 'Category';
                    const ptPlaceholderComments = '5 Comments';

                    // Build meta line
                    let ptMetaParts = [];
                    if (ptShowMeta) {
                        if (ptShowDate) ptMetaParts.push(ptPlaceholderDate);
                        if (ptShowAuthor) ptMetaParts.push(ptPlaceholderAuthor);
                        if (ptShowCategories) ptMetaParts.push(ptPlaceholderCategory);
                        if (ptShowComments) ptMetaParts.push(ptPlaceholderComments);
                    }
                    const ptMetaLine = ptMetaParts.join(' ' + ptMetaSeparator + ' ');

                    // Determine colors based on featured image placement
                    const ptHasImageBg = ptShowFeaturedImage && ptFeaturedImagePlacement === 'background';
                    const ptCurrentTitleColor = ptHasImageBg ? ptTextOnImageColor : ptTitleColor;
                    const ptCurrentMetaColor = ptHasImageBg ? ptTextOnImageColor : ptMetaColor;

                    if (ptHasImageBg) {
                        // Background image mode
                        let ptBgStyle = 'background:linear-gradient(' + ptBgOverlay + ',' + ptBgOverlay + '),url(data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect fill="#667eea" width="800" height="400"/><text x="400" y="200" fill="#fff" font-size="64" text-anchor="middle" dominant-baseline="middle">📷</text></svg>') + ') center/cover no-repeat';
                        preview = '<div style="position:relative;' + ptBgStyle + ';min-height:200px;border-radius:8px;overflow:hidden;padding:' + ptPaddingTop + ' 20px ' + ptPaddingBottom + ';display:flex;flex-direction:column;justify-content:center;align-items:' + ptTextAlignment + ';text-align:' + ptTextAlignment + '">';
                        preview += '<div style="max-width:' + ptContentWidth + ';width:100%">';
                        if (ptShowTitle) {
                            preview += '<' + ptTitleLevel + ' style="margin:0 0 12px 0;font-size:' + ptTitleSize + ';font-weight:700;color:' + ptCurrentTitleColor + ';' + ptTitleTypo + '">' + this.escapeHtml(ptPlaceholderTitle) + '</' + ptTitleLevel + '>';
                        }
                        if (ptMetaLine) {
                            preview += '<div style="font-size:' + ptMetaSize + ';color:' + ptCurrentMetaColor + ';opacity:0.9;' + ptMetaTypo + '">' + this.escapeHtml(ptMetaLine) + '</div>';
                        }
                        preview += '</div>';
                        // Dynamic content badge
                        preview += '<div style="position:absolute;top:8px;left:8px;background:rgba(59,130,246,0.9);color:#fff;padding:4px 8px;border-radius:4px;font-size:10px">⚡ Dynamic Content</div>';
                        preview += '</div>';
                    } else if (ptShowFeaturedImage && ptFeaturedImagePlacement === 'above') {
                        // Featured image above title
                        preview = '<div style="border-radius:8px;overflow:hidden">';
                        preview += '<div style="background:linear-gradient(135deg,#667eea,#764ba2);height:120px;display:flex;align-items:center;justify-content:center"><span style="font-size:48px;color:#fff">📷</span></div>';
                        preview += '<div style="padding:16px;text-align:' + ptTextAlignment + '">';
                        if (ptShowTitle) {
                            preview += '<' + ptTitleLevel + ' style="margin:0 0 8px 0;font-size:' + ptTitleSize + ';font-weight:700;color:' + ptCurrentTitleColor + ';' + ptTitleTypo + '">' + this.escapeHtml(ptPlaceholderTitle) + '</' + ptTitleLevel + '>';
                        }
                        if (ptMetaLine) {
                            preview += '<div style="font-size:' + ptMetaSize + ';color:' + ptCurrentMetaColor + ';' + ptMetaTypo + '">' + this.escapeHtml(ptMetaLine) + '</div>';
                        }
                        preview += '</div>';
                        preview += '<div style="position:absolute;top:8px;left:8px;background:rgba(59,130,246,0.9);color:#fff;padding:4px 8px;border-radius:4px;font-size:10px">⚡ Dynamic Content</div>';
                        preview += '</div>';
                    } else if (ptShowFeaturedImage && ptFeaturedImagePlacement === 'below') {
                        // Featured image below title
                        preview = '<div style="border-radius:8px;overflow:hidden;position:relative">';
                        preview += '<div style="padding:16px;text-align:' + ptTextAlignment + '">';
                        if (ptShowTitle) {
                            preview += '<' + ptTitleLevel + ' style="margin:0 0 8px 0;font-size:' + ptTitleSize + ';font-weight:700;color:' + ptCurrentTitleColor + ';' + ptTitleTypo + '">' + this.escapeHtml(ptPlaceholderTitle) + '</' + ptTitleLevel + '>';
                        }
                        if (ptMetaLine) {
                            preview += '<div style="font-size:' + ptMetaSize + ';color:' + ptCurrentMetaColor + ';' + ptMetaTypo + '">' + this.escapeHtml(ptMetaLine) + '</div>';
                        }
                        preview += '</div>';
                        preview += '<div style="background:linear-gradient(135deg,#667eea,#764ba2);height:120px;display:flex;align-items:center;justify-content:center"><span style="font-size:48px;color:#fff">📷</span></div>';
                        preview += '<div style="position:absolute;top:8px;left:8px;background:rgba(59,130,246,0.9);color:#fff;padding:4px 8px;border-radius:4px;font-size:10px">⚡ Dynamic Content</div>';
                        preview += '</div>';
                    } else {
                        // No featured image or none placement
                        preview = '<div style="padding:16px;text-align:' + ptTextAlignment + ';border-radius:8px;border:1px solid #e2e8f0;position:relative">';
                        if (ptShowTitle) {
                            preview += '<' + ptTitleLevel + ' style="margin:0 0 8px 0;font-size:' + ptTitleSize + ';font-weight:700;color:' + ptCurrentTitleColor + ';' + ptTitleTypo + '">' + this.escapeHtml(ptPlaceholderTitle) + '</' + ptTitleLevel + '>';
                        }
                        if (ptMetaLine) {
                            preview += '<div style="font-size:' + ptMetaSize + ';color:' + ptCurrentMetaColor + ';' + ptMetaTypo + '">' + this.escapeHtml(ptMetaLine) + '</div>';
                        }
                        preview += '<div style="position:absolute;top:8px;right:8px;background:rgba(59,130,246,0.9);color:#fff;padding:4px 8px;border-radius:4px;font-size:10px">⚡ Dynamic Content</div>';
                        preview += '</div>';
                    }
                    break;
                case 'post_content':
                    // Post Content - Dynamic post/page body content with rich formatting
                    const pcMaxWidth = content.max_width || '800px';
                    const pcTextColor = content.text_color || '#1e293b';
                    const pcFontSize = content.font_size || '18px';
                    const pcLineHeight = content.line_height || '1.8';
                    const pcParagraphSpacing = content.paragraph_spacing || '1.5em';
                    const pcHeadingColor = content.heading_color || '#0f172a';
                    const pcLinkColor = content.link_color || '#0073e6';
                    const pcImageBorderRadius = content.image_border_radius || '8px';
                    const pcBlockquoteStyle = content.blockquote_style || 'border';
                    const pcBlockquoteBorderColor = content.blockquote_border_color || '#0073e6';
                    const pcCodeBackground = content.code_background || '#f1f5f9';
                    const pcCodeTextColor = content.code_text_color || '#e11d48';
                    const pcListStyle = content.list_style || 'disc';
                    const pcDropcap = content.dropcap || false;
                    const pcDropcapColor = content.dropcap_color || '#0073e6';

                    // Build blockquote style
                    let pcBlockquoteCSS = '';
                    if (pcBlockquoteStyle === 'border') {
                        pcBlockquoteCSS = 'border-left:4px solid ' + pcBlockquoteBorderColor + ';padding-left:20px;margin:1.5em 0;font-style:italic;color:#64748b';
                    } else if (pcBlockquoteStyle === 'background') {
                        pcBlockquoteCSS = 'background:' + pcBlockquoteBorderColor + '15;padding:20px;border-radius:8px;margin:1.5em 0;font-style:italic;color:#64748b';
                    } else {
                        pcBlockquoteCSS = 'font-style:italic;color:#64748b;margin:1.5em 0;padding-left:20px';
                    }

                    // Build list style icon
                    let pcListIcon = '•';
                    if (pcListStyle === 'circle') pcListIcon = '○';
                    else if (pcListStyle === 'square') pcListIcon = '▪';
                    else if (pcListStyle === 'check') pcListIcon = '✓';
                    else if (pcListStyle === 'arrow') pcListIcon = '→';

                    // Container with max width and typography
                    preview = '<div class="tb-post-content" style="max-width:' + pcMaxWidth + ';margin:0 auto;color:' + pcTextColor + ';font-size:' + pcFontSize + ';line-height:' + pcLineHeight + ';position:relative;padding:20px">';

                    // Dynamic content badge
                    preview += '<div style="position:absolute;top:8px;left:8px;background:rgba(59,130,246,0.9);color:#fff;padding:4px 8px;border-radius:4px;font-size:10px;z-index:10">⚡ Dynamic Post Content</div>';
                    preview += '<div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);color:#fff;padding:4px 10px;border-radius:4px;font-size:11px">📄 [Dynamic Post Content]</div>';

                    // Sample heading
                    preview += '<h2 style="color:' + pcHeadingColor + ';font-size:1.75em;font-weight:700;margin:1em 0 0.5em;line-height:1.3">Understanding Modern Web Development</h2>';

                    // First paragraph with optional dropcap
                    if (pcDropcap) {
                        preview += '<p style="margin-bottom:' + pcParagraphSpacing + '"><span style="float:left;font-size:3.5em;line-height:0.8;padding-right:8px;font-weight:700;color:' + pcDropcapColor + '">L</span>orem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.</p>';
                    } else {
                        preview += '<p style="margin-bottom:' + pcParagraphSpacing + '">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.</p>';
                    }

                    // Second paragraph
                    preview += '<p style="margin-bottom:' + pcParagraphSpacing + '">Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident.</p>';

                    // Blockquote
                    preview += '<blockquote style="' + pcBlockquoteCSS + '">"The only way to do great work is to love what you do. If you haven\'t found it yet, keep looking." — Steve Jobs</blockquote>';

                    // Unordered list
                    preview += '<ul style="margin:1.5em 0;padding-left:0;list-style:none">';
                    preview += '<li style="margin-bottom:0.5em;padding-left:1.5em;position:relative"><span style="position:absolute;left:0;color:' + pcLinkColor + '">' + pcListIcon + '</span> First list item with important information</li>';
                    preview += '<li style="margin-bottom:0.5em;padding-left:1.5em;position:relative"><span style="position:absolute;left:0;color:' + pcLinkColor + '">' + pcListIcon + '</span> Second list item demonstrating styling</li>';
                    preview += '<li style="margin-bottom:0.5em;padding-left:1.5em;position:relative"><span style="position:absolute;left:0;color:' + pcLinkColor + '">' + pcListIcon + '</span> Third list item for visual reference</li>';
                    preview += '</ul>';

                    // Paragraph with link
                    preview += '<p style="margin-bottom:' + pcParagraphSpacing + '">For more information, visit our <a href="#" style="color:' + pcLinkColor + ';text-decoration:underline">documentation page</a> to learn about advanced features and best practices.</p>';

                    // Code snippet
                    preview += '<pre style="background:' + pcCodeBackground + ';padding:16px;border-radius:8px;overflow-x:auto;margin:1.5em 0"><code style="color:' + pcCodeTextColor + ';font-family:monospace;font-size:0.9em">const greeting = "Hello, World!";\nconsole.log(greeting);</code></pre>';

                    // Sample image placeholder
                    preview += '<div style="background:linear-gradient(135deg,#f1f5f9,#e2e8f0);height:200px;border-radius:' + pcImageBorderRadius + ';display:flex;align-items:center;justify-content:center;margin:1.5em 0"><span style="font-size:48px;opacity:0.5">🖼</span></div>';

                    preview += '</div>';
                    break;
                case 'portfolio':
                    const portfolioItems = content.items || [];
                    const portfolioColumns = parseInt(content.columns) || 3;
                    const portfolioGap = content.gap || '20px';
                    const portfolioLayout = content.layout || 'grid';
                    const portfolioShowFilters = content.show_filters !== false;
                    const portfolioFilterAllText = content.filter_all_text || 'All';
                    const portfolioShowTitle = content.show_title !== false;
                    const portfolioShowCategory = content.show_category !== false;
                    const portfolioHoverEffect = content.hover_effect || 'fade';
                    const portfolioOverlayColor = content.overlay_color || 'rgba(0, 0, 0, 0.7)';
                    const portfolioTitleColor = content.title_color || '#ffffff';
                    const portfolioCategoryColor = content.category_color || '#94a3b8';
                    const portfolioBorderRadius = content.border_radius || '8px';
                    const portfolioAspectRatio = content.aspect_ratio || '4:3';
                    const portfolioFilterActiveColor = content.filter_active_color || '#0073e6';
                    // Calculate aspect ratio padding
                    const aspectMap = { '1:1': '100%', '4:3': '75%', '16:9': '56.25%', '3:2': '66.67%', 'auto': '75%' };
                    const portfolioAspectPadding = aspectMap[portfolioAspectRatio] || '75%';
                    // Extract unique categories
                    const portfolioCategories = [...new Set(portfolioItems.map(item => item.category).filter(c => c))];
                    // Render filter bar if enabled
                    if (portfolioShowFilters && portfolioCategories.length > 0) {
                        preview = '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">';
                        preview += '<button style="padding:4px 12px;border-radius:4px;font-size:11px;background:' + portfolioFilterActiveColor + ';color:#fff;border:none;cursor:pointer">' + this.escapeHtml(portfolioFilterAllText) + '</button>';
                        portfolioCategories.slice(0, 4).forEach(cat => {
                            preview += '<button style="padding:4px 12px;border-radius:4px;font-size:11px;background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;cursor:pointer">' + this.escapeHtml(cat) + '</button>';
                        });
                        if (portfolioCategories.length > 4) {
                            preview += '<span style="padding:4px 8px;font-size:11px;color:#94a3b8">+' + (portfolioCategories.length - 4) + ' more</span>';
                        }
                        preview += '</div>';
                    } else {
                        preview = '';
                    }
                    // Render portfolio grid
                    const displayItems = Math.min(portfolioItems.length, 6);
                    const previewColumns = Math.min(portfolioColumns, 3);
                    preview += '<div style="display:grid;grid-template-columns:repeat(' + previewColumns + ',1fr);gap:12px">';
                    for (let i = 0; i < displayItems; i++) {
                        const item = portfolioItems[i];
                        preview += '<div style="position:relative;border-radius:' + portfolioBorderRadius + ';overflow:hidden">';
                        // Image container with aspect ratio
                        preview += '<div style="position:relative;padding-bottom:' + portfolioAspectPadding + ';background:linear-gradient(135deg,#667eea,#764ba2)">';
                        if (item.image) {
                            preview += '<img src="' + this.escapeHtml(item.image) + '" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover">';
                        } else {
                            preview += '<div style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center"><span style="font-size:24px;opacity:0.5">🎨</span></div>';
                        }
                        // Overlay with title/category
                        preview += '<div style="position:absolute;bottom:0;left:0;right:0;background:' + portfolioOverlayColor + ';padding:8px">';
                        if (portfolioShowTitle) {
                            preview += '<div style="color:' + portfolioTitleColor + ';font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + this.escapeHtml(item.title || 'Project') + '</div>';
                        }
                        if (portfolioShowCategory) {
                            preview += '<div style="color:' + portfolioCategoryColor + ';font-size:10px">' + this.escapeHtml(item.category || 'Category') + '</div>';
                        }
                        preview += '</div>';
                        preview += '</div></div>';
                    }
                    preview += '</div>';
                    // Info footer
                    preview += '<div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center;font-size:10px;color:#64748b">';
                    preview += '<span>🎨 ' + portfolioItems.length + ' items • ' + portfolioColumns + ' columns</span>';
                    preview += '<span>' + portfolioLayout.charAt(0).toUpperCase() + portfolioLayout.slice(1) + ' layout</span>';
                    preview += '</div>';
                    break;
                case 'team':
                    const teamName = content.name || 'John Doe';
                    const teamRole = content.role || 'CEO & Founder';
                    const teamBio = content.bio || 'A short biography about this team member.';
                    const teamImage = content.image || '';
                    const teamStyle = content.style || 'card';
                    const teamImageSize = content.image_size || '200px';
                    const teamAlignment = content.alignment || 'center';
                    const teamSocial = content.social || [];
                    const teamNameTypo = this.getElementTypographyStyles(settings, 'name');
                    const teamRoleTypo = this.getElementTypographyStyles(settings, 'role');
                    const teamBioTypo = this.getElementTypographyStyles(settings, 'bio');

                    // Style variations
                    const isCircular = teamStyle === 'circular';
                    const isCard = teamStyle === 'card';
                    const cardBgTeam = isCard ? '#fff' : 'transparent';
                    const cardBorderTeam = isCard ? 'border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.08)' : '';
                    const imgBorderRadius = isCircular ? '50%' : (isCard ? '0' : '8px');
                    const imgSizePreview = isCircular ? '80px' : '100%';

                    preview = '<div style="background:' + cardBgTeam + ';' + cardBorderTeam + ';text-align:' + teamAlignment + ';padding:' + (isCard ? '0' : '16px') + '">';

                    // Image/Avatar
                    if (teamImage) {
                        preview += '<div style="' + (isCard && !isCircular ? '' : 'padding:16px 16px 0 16px') + '">';
                        preview += '<img src="' + this.escapeHtml(teamImage) + '" style="width:' + imgSizePreview + ';height:' + (isCircular ? '80px' : 'auto') + ';max-height:120px;object-fit:cover;border-radius:' + imgBorderRadius + ';' + (isCircular ? 'margin:0 auto;display:block' : '') + '">';
                        preview += '</div>';
                    } else {
                        preview += '<div style="' + (isCard && !isCircular ? '' : 'padding:16px 16px 0 16px') + '">';
                        preview += '<div style="width:' + (isCircular ? '80px' : '100%') + ';height:' + (isCircular ? '80px' : '100px') + ';background:linear-gradient(135deg,#667eea,#764ba2);border-radius:' + imgBorderRadius + ';display:flex;align-items:center;justify-content:center;' + (isCircular ? 'margin:0 auto' : '') + '">';
                        preview += '<span style="font-size:' + (isCircular ? '32px' : '40px') + '">👤</span>';
                        preview += '</div></div>';
                    }

                    // Info section
                    preview += '<div style="padding:16px">';
                    preview += '<h4 style="margin:0 0 4px 0;font-size:16px;font-weight:600;color:#1e293b;' + teamNameTypo + '">' + this.escapeHtml(teamName) + '</h4>';
                    preview += '<div style="color:#0073e6;font-size:12px;font-weight:500;margin-bottom:8px;' + teamRoleTypo + '">' + this.escapeHtml(teamRole) + '</div>';
                    preview += '<p style="margin:0 0 12px 0;font-size:11px;color:#64748b;line-height:1.5;' + teamBioTypo + '">' + this.escapeHtml(teamBio.substring(0, 80)) + (teamBio.length > 80 ? '...' : '') + '</p>';

                    // Social icons
                    const socialIcons = { linkedin: '🔗', twitter: '🐦', facebook: '📘', instagram: '📷', github: '💻', email: '✉️' };
                    const activeSocials = teamSocial.filter(s => s.url && s.url.trim());
                    if (activeSocials.length > 0 || teamSocial.length > 0) {
                        preview += '<div style="display:flex;gap:8px;justify-content:' + teamAlignment + '">';
                        teamSocial.forEach(s => {
                            const iconEmoji = socialIcons[s.platform] || '🔗';
                            const opacity = s.url ? '1' : '0.4';
                            preview += '<span style="opacity:' + opacity + ';font-size:16px" title="' + this.escapeHtml(s.platform) + '">' + iconEmoji + '</span>';
                        });
                        preview += '</div>';
                    }
                    preview += '</div></div>';

                    // Style indicator
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">👥 Team Member • ' + teamStyle + ' style</div>';
                    break;
                case 'countdown':
                    const cdTitle = content.title || 'Event Starts In';
                    const cdStyle = content.style || 'boxes';
                    const cdShowDays = content.show_days !== false;
                    const cdShowHours = content.show_hours !== false;
                    const cdShowMinutes = content.show_minutes !== false;
                    const cdShowSeconds = content.show_seconds !== false;
                    const cdNumberSize = content.number_size || '48px';
                    const cdLabelSize = content.label_size || '14px';
                    const cdTitleTypo = this.getElementTypographyStyles(settings, 'title');
                    const cdNumberTypo = this.getElementTypographyStyles(settings, 'number');
                    const cdLabelTypo = this.getElementTypographyStyles(settings, 'label');

                    // Style-based container styling
                    const isCircles = cdStyle === 'circles';
                    const isMinimal = cdStyle === 'minimal';
                    const unitBg = isCircles ? 'background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;width:80px;height:80px;' : (isMinimal ? 'background:transparent;' : 'background:linear-gradient(135deg,#f8fafc,#e2e8f0);border-radius:8px;');
                    const unitPadding = isCircles ? 'padding:0;display:flex;flex-direction:column;align-items:center;justify-content:center;' : (isMinimal ? 'padding:8px 16px;' : 'padding:16px 20px;');
                    const numberColor = isCircles ? 'color:#ffffff;' : (isMinimal ? 'color:#1e293b;' : 'color:#1e293b;');
                    const labelColor = isCircles ? 'color:rgba(255,255,255,0.8);' : 'color:#64748b;';
                    const separatorDisplay = isMinimal ? 'display:inline;' : 'display:none;';

                    preview = '<div style="text-align:center;padding:20px">';
                    preview += '<div style="font-size:14px;font-weight:600;color:#374151;margin-bottom:16px;' + cdTitleTypo + '">' + this.escapeHtml(cdTitle) + '</div>';
                    preview += '<div style="display:flex;justify-content:center;align-items:center;gap:' + (isMinimal ? '4px' : '12px') + ';flex-wrap:wrap">';

                    // Sample countdown values
                    const units = [];
                    if (cdShowDays) units.push({ val: '12', label: 'Days' });
                    if (cdShowHours) units.push({ val: '08', label: 'Hours' });
                    if (cdShowMinutes) units.push({ val: '45', label: 'Minutes' });
                    if (cdShowSeconds) units.push({ val: '30', label: 'Seconds' });

                    units.forEach((u, i) => {
                        if (isMinimal && i > 0) {
                            preview += '<span style="font-size:' + cdNumberSize + ';font-weight:700;color:#64748b;' + cdNumberTypo + '">:</span>';
                        }
                        preview += '<div style="' + unitBg + unitPadding + 'text-align:center;box-shadow:' + (isMinimal ? 'none' : '0 2px 4px rgba(0,0,0,0.05)') + '">';
                        preview += '<div style="font-size:' + cdNumberSize + ';font-weight:700;' + numberColor + 'line-height:1;' + cdNumberTypo + '">' + u.val + '</div>';
                        if (!isMinimal) {
                            preview += '<div style="font-size:' + cdLabelSize + ';' + labelColor + 'text-transform:uppercase;margin-top:4px;' + cdLabelTypo + '">' + u.label + '</div>';
                        }
                        preview += '</div>';
                    });

                    preview += '</div>';
                    preview += '<div style="margin-top:12px;font-size:10px;color:#64748b">⏱ Countdown • ' + cdStyle + ' style</div>';
                    preview += '</div>';
                    break;
                case 'counter':
                    const ctrNumber = content.number || 100;
                    const ctrPrefix = content.prefix || '';
                    const ctrSuffix = content.suffix || '+';
                    const ctrTitle = content.title || 'Happy Clients';
                    const ctrNumberSize = content.number_size || '64px';
                    const ctrNumberColor = content.number_color || '#0073e6';
                    const ctrTitleSize = content.title_size || '18px';
                    const ctrAlignment = content.alignment || 'center';
                    const ctrNumberTypo = this.getElementTypographyStyles(settings, 'number');
                    const ctrTitleTypo = this.getElementTypographyStyles(settings, 'title');

                    preview = '<div style="text-align:' + ctrAlignment + ';padding:24px">';
                    preview += '<div style="font-size:' + ctrNumberSize + ';font-weight:700;color:' + ctrNumberColor + ';line-height:1.1;' + ctrNumberTypo + '">';
                    if (ctrPrefix) preview += '<span style="font-size:calc(' + ctrNumberSize + ' * 0.6);vertical-align:top;margin-right:2px">' + this.escapeHtml(ctrPrefix) + '</span>';
                    preview += this.escapeHtml(String(ctrNumber));
                    if (ctrSuffix) preview += '<span style="font-size:calc(' + ctrNumberSize + ' * 0.6);vertical-align:top;margin-left:2px">' + this.escapeHtml(ctrSuffix) + '</span>';
                    preview += '</div>';
                    preview += '<div style="font-size:' + ctrTitleSize + ';color:#64748b;margin-top:8px;font-weight:500;' + ctrTitleTypo + '">' + this.escapeHtml(ctrTitle) + '</div>';
                    preview += '<div style="margin-top:12px;font-size:10px;color:#94a3b8">🔢 Counter • animated on scroll</div>';
                    preview += '</div>';
                    break;
                case 'form':
                    const formTitle = content.title || 'Get In Touch';
                    const formFields = content.fields || [
                        { type: 'text', label: 'Name', placeholder: 'Your name', required: true },
                        { type: 'email', label: 'Email', placeholder: 'your@email.com', required: true },
                        { type: 'textarea', label: 'Message', placeholder: 'Your message...', required: true }
                    ];
                    const formSubmitText = content.submit_text || 'Send Message';
                    const formStyle = content.style || 'stacked';
                    const formButtonStyle = content.button_style || 'primary';
                    const formButtonFullWidth = content.button_full_width || false;
                    const formLabelPosition = content.label_position || 'top';

                    // Button colors based on style
                    const btnColors = {
                        primary: { bg: '#0073e6', color: '#fff' },
                        secondary: { bg: '#64748b', color: '#fff' },
                        success: { bg: '#10b981', color: '#fff' },
                        outline: { bg: 'transparent', color: '#0073e6', border: '2px solid #0073e6' }
                    };
                    const formBtnStyle = btnColors[formButtonStyle] || btnColors.primary;

                    preview = '<div style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:20px">';

                    // Form title
                    if (formTitle) {
                        preview += '<h3 style="margin:0 0 16px 0;font-size:18px;font-weight:600;color:#1e293b">' + this.escapeHtml(formTitle) + '</h3>';
                    }

                    // Form fields
                    const isInline = formStyle === 'inline';
                    preview += '<div style="display:' + (isInline ? 'flex;flex-wrap:wrap;gap:12px' : 'flex;flex-direction:column;gap:12px') + '">';

                    formFields.forEach((field, idx) => {
                        const fieldLabel = field.label || 'Field ' + (idx + 1);
                        const fieldType = field.type || 'text';
                        const fieldPlaceholder = field.placeholder || '';
                        const fieldRequired = field.required || false;
                        const isLabelTop = formLabelPosition === 'top';

                        preview += '<div style="' + (isInline && fieldType !== 'textarea' ? 'flex:1;min-width:150px' : 'width:100%') + '">';

                        // Label
                        if (fieldLabel) {
                            preview += '<label style="display:block;font-size:12px;font-weight:500;color:#374151;margin-bottom:4px">' + this.escapeHtml(fieldLabel);
                            if (fieldRequired) preview += '<span style="color:#ef4444;margin-left:2px">*</span>';
                            preview += '</label>';
                        }

                        // Field input
                        const inputStyle = 'width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;background:#f9fafb;color:#374151';
                        if (fieldType === 'textarea') {
                            preview += '<textarea style="' + inputStyle + ';min-height:60px;resize:vertical" placeholder="' + this.escapeHtml(fieldPlaceholder) + '" disabled></textarea>';
                        } else if (fieldType === 'select') {
                            const options = field.options || ['Option 1', 'Option 2', 'Option 3'];
                            preview += '<select style="' + inputStyle + '" disabled>';
                            preview += '<option>' + this.escapeHtml(fieldPlaceholder || 'Select...') + '</option>';
                            options.forEach(opt => {
                                preview += '<option>' + this.escapeHtml(opt) + '</option>';
                            });
                            preview += '</select>';
                        } else if (fieldType === 'checkbox') {
                            preview += '<div style="display:flex;align-items:center;gap:8px"><input type="checkbox" disabled style="width:16px;height:16px"><span style="font-size:13px;color:#374151">' + this.escapeHtml(fieldPlaceholder || 'Checkbox option') + '</span></div>';
                        } else {
                            preview += '<input type="' + fieldType + '" style="' + inputStyle + '" placeholder="' + this.escapeHtml(fieldPlaceholder) + '" disabled>';
                        }

                        preview += '</div>';
                    });

                    preview += '</div>';

                    // Submit button
                    const formBtnBorder = formBtnStyle.border || 'none';
                    preview += '<div style="margin-top:16px;' + (formButtonFullWidth ? '' : 'text-align:left') + '">';
                    preview += '<button style="' + (formButtonFullWidth ? 'width:100%;' : '') + 'padding:10px 24px;background:' + formBtnStyle.bg + ';color:' + formBtnStyle.color + ';border:' + formBtnBorder + ';border-radius:6px;font-size:14px;font-weight:500;cursor:pointer">' + this.escapeHtml(formSubmitText) + '</button>';
                    preview += '</div>';

                    preview += '</div>';
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">📝 Contact Form • ' + formFields.length + ' field' + (formFields.length !== 1 ? 's' : '') + '</div>';
                    break;
                case 'login':
                    const loginTitle = content.title || 'Login';
                    const loginUsernameLabel = content.username_label || 'Username or Email';
                    const loginUsernamePlaceholder = content.username_placeholder || 'Enter your username or email';
                    const loginPasswordLabel = content.password_label || 'Password';
                    const loginPasswordPlaceholder = content.password_placeholder || 'Enter your password';
                    const loginSubmitText = content.submit_text || 'Log In';
                    const loginShowRemember = content.show_remember !== false;
                    const loginRememberLabel = content.remember_label || 'Remember Me';
                    const loginShowForgot = content.show_forgot !== false;
                    const loginForgotText = content.forgot_text || 'Forgot Password?';
                    const loginShowRegister = content.show_register !== false;
                    const loginRegisterText = content.register_text || 'Create an Account';
                    const loginStyle = content.style || 'default';
                    const loginBgColor = content.background_color || '#ffffff';
                    const loginInputBg = content.input_background || '#f8fafc';
                    const loginInputBorder = content.input_border_color || '#e2e8f0';
                    const loginInputText = content.input_text_color || '#1e293b';
                    const loginBtnBg = content.button_background || '#0073e6';
                    const loginBtnText = content.button_text_color || '#ffffff';
                    const loginLabelColor = content.label_color || '#374151';
                    const loginLinkColor = content.link_color || '#0073e6';
                    const loginBorderRadius = content.border_radius || '8px';

                    // Container styles based on style variant
                    let loginContainerStyle = 'background:' + loginBgColor + ';padding:24px;';
                    if (loginStyle === 'card') {
                        loginContainerStyle += 'border:1px solid ' + loginInputBorder + ';border-radius:' + loginBorderRadius + ';box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)';
                    } else if (loginStyle === 'minimal') {
                        loginContainerStyle += 'border:none;background:transparent';
                    } else if (loginStyle === 'split') {
                        loginContainerStyle += 'border-left:4px solid ' + loginBtnBg + ';border-radius:0 ' + loginBorderRadius + ' ' + loginBorderRadius + ' 0';
                    } else {
                        loginContainerStyle += 'border:1px solid ' + loginInputBorder + ';border-radius:' + loginBorderRadius;
                    }

                    preview = '<div style="' + loginContainerStyle + '" data-tb-login-form>';

                    // Form title
                    if (loginTitle) {
                        preview += '<h3 style="margin:0 0 20px 0;font-size:20px;font-weight:600;color:' + loginInputText + ';text-align:center">' + this.escapeHtml(loginTitle) + '</h3>';
                    }

                    // Username/Email field
                    preview += '<div style="margin-bottom:16px">';
                    preview += '<label style="display:block;font-size:13px;font-weight:500;color:' + loginLabelColor + ';margin-bottom:6px">' + this.escapeHtml(loginUsernameLabel) + '</label>';
                    preview += '<input type="text" style="width:100%;padding:10px 12px;border:1px solid ' + loginInputBorder + ';border-radius:6px;font-size:14px;background:' + loginInputBg + ';color:' + loginInputText + '" placeholder="' + this.escapeHtml(loginUsernamePlaceholder) + '" disabled>';
                    preview += '</div>';

                    // Password field
                    preview += '<div style="margin-bottom:16px">';
                    preview += '<label style="display:block;font-size:13px;font-weight:500;color:' + loginLabelColor + ';margin-bottom:6px">' + this.escapeHtml(loginPasswordLabel) + '</label>';
                    preview += '<div style="position:relative">';
                    preview += '<input type="password" style="width:100%;padding:10px 40px 10px 12px;border:1px solid ' + loginInputBorder + ';border-radius:6px;font-size:14px;background:' + loginInputBg + ';color:' + loginInputText + '" placeholder="' + this.escapeHtml(loginPasswordPlaceholder) + '" disabled>';
                    preview += '<span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:' + loginLabelColor + ';opacity:0.6;cursor:pointer" title="Toggle password visibility">👁</span>';
                    preview += '</div>';
                    preview += '</div>';

                    // Remember me and Forgot password row
                    if (loginShowRemember || loginShowForgot) {
                        preview += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:8px">';
                        if (loginShowRemember) {
                            preview += '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:' + loginLabelColor + '"><input type="checkbox" disabled style="width:16px;height:16px"><span>' + this.escapeHtml(loginRememberLabel) + '</span></label>';
                        } else {
                            preview += '<span></span>';
                        }
                        if (loginShowForgot) {
                            preview += '<a href="#" style="font-size:13px;color:' + loginLinkColor + ';text-decoration:none">' + this.escapeHtml(loginForgotText) + '</a>';
                        }
                        preview += '</div>';
                    }

                    // Submit button
                    preview += '<button style="width:100%;padding:12px 24px;background:' + loginBtnBg + ';color:' + loginBtnText + ';border:none;border-radius:6px;font-size:15px;font-weight:500;cursor:pointer">' + this.escapeHtml(loginSubmitText) + '</button>';

                    // Register link
                    if (loginShowRegister) {
                        preview += '<div style="margin-top:16px;text-align:center;font-size:13px;color:' + loginLabelColor + '">Don\'t have an account? <a href="#" style="color:' + loginLinkColor + ';text-decoration:none;font-weight:500">' + this.escapeHtml(loginRegisterText) + '</a></div>';
                    }

                    preview += '</div>';
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">🔐 Login Form</div>';
                    break;
                case 'signup':
                    const signupTitle = content.title || 'Subscribe to Newsletter';
                    const signupDesc = content.description || 'Get the latest updates.';
                    const signupPlaceholder = content.email_placeholder || 'Enter your email';
                    const signupBtnText = content.button_text || 'Subscribe';
                    const signupShowName = content.show_name_field || false;
                    const signupStyle = design.style || 'inline';
                    const signupBg = design.background_color || '#f8fafc';
                    const signupInputBg = design.input_background || '#ffffff';
                    const signupInputBorder = design.input_border_color || '#e2e8f0';
                    const signupBtnBg = design.button_background || '#0073e6';
                    const signupBtnColor = design.button_text_color || '#ffffff';
                    const signupRadius = design.border_radius || '8px';
                    preview = '<div style="padding:40px;background:' + signupBg + ';border-radius:' + signupRadius + ';text-align:center">';
                    if (signupTitle) { preview += '<h3 style="margin:0 0 8px 0;font-size:20px;font-weight:600">' + this.escapeHtml(signupTitle) + '</h3>'; }
                    if (signupDesc) { preview += '<p style="margin:0 0 20px 0;font-size:14px;color:#64748b">' + this.escapeHtml(signupDesc) + '</p>'; }
                    const flexDir = signupStyle === 'inline' ? 'row' : 'column';
                    preview += '<div style="display:flex;flex-direction:' + flexDir + ';gap:12px;justify-content:center;align-items:stretch">';
                    if (signupShowName) { preview += '<input type="text" style="flex:1;padding:12px;border:1px solid ' + signupInputBorder + ';border-radius:' + signupRadius + ';background:' + signupInputBg + '" placeholder="Your name" disabled>'; }
                    preview += '<input type="email" style="flex:1;padding:12px;border:1px solid ' + signupInputBorder + ';border-radius:' + signupRadius + ';background:' + signupInputBg + '" placeholder="' + this.escapeHtml(signupPlaceholder) + '" disabled>';
                    preview += '<button style="padding:12px 24px;background:' + signupBtnBg + ';color:' + signupBtnColor + ';border:none;border-radius:' + signupRadius + ';font-weight:500">' + this.escapeHtml(signupBtnText) + '</button>';
                    preview += '</div></div><div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">📧 Newsletter Signup</div>';
                    break;
                case 'fullwidth_code':
                    const fwCode = content.code || '// Your code here';
                    const fwLang = content.language || 'javascript';
                    preview = '<div style="width:100%;background:#1e1e2e;padding:20px;border-radius:8px;overflow:hidden">';
                    preview += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">';
                    preview += '<span style="color:#64748b;font-size:12px;text-transform:uppercase">' + fwLang + '</span>';
                    preview += '<span style="color:#0073e6;font-size:10px">◉ FULLWIDTH</span></div>';
                    preview += '<pre style="margin:0;color:#e2e8f0;font-size:13px;overflow:hidden;white-space:pre-wrap">' + this.escapeHtml(fwCode.substring(0,200)) + '</pre>';
                    preview += '</div>';
                    break;
                case 'fullwidth_image':
                    const fwImgSrc = content.src || '';
                    const fwImgHeight = design.height || '400px';
                    preview = '<div style="width:100%;height:' + fwImgHeight + ';background:#f1f5f9;display:flex;align-items:center;justify-content:center;position:relative">';
                    if (fwImgSrc) {
                        preview += '<img src="' + this.escapeHtml(fwImgSrc) + '" style="width:100%;height:100%;object-fit:cover">';
                    } else {
                        preview += '<div style="text-align:center;color:#94a3b8"><div style="font-size:48px">🖼️</div><div style="font-size:12px;margin-top:8px">Fullwidth Image</div></div>';
                    }
                    preview += '<span style="position:absolute;top:8px;right:8px;background:#0073e6;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px">◉ FULLWIDTH</span></div>';
                    break;
                case 'fullwidth_map':
                    const fwMapHeight = design.height || '400px';
                    const fwMapAddress = content.address || 'No address set';
                    preview = '<div style="width:100%;height:' + fwMapHeight + ';background:linear-gradient(135deg,#e0f2fe,#dbeafe);display:flex;align-items:center;justify-content:center;position:relative">';
                    preview += '<div style="text-align:center;color:#64748b"><div style="font-size:48px">🗏</div><div style="font-size:12px;margin-top:8px">' + this.escapeHtml(fwMapAddress) + '</div></div>';
                    preview += '<span style="position:absolute;top:8px;right:8px;background:#0073e6;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px">◉ FULLWIDTH</span></div>';
                    break;
                                case 'fullwidth_menu':
                    html += '<div class="tb-settings-section-title">Menu Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Logo URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.logo || '') + '" placeholder="Logo image URL" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'logo\',this.value)"></div>';
                    
                    // Menu Items Editor
                    html += '<div class="tb-setting-group" style="display:flex;justify-content:space-between;align-items:center"><div class="tb-setting-label" style="font-weight:600;margin:0">Menu Items</div><button type="button" class="tb-btn tb-btn-sm" style="background:#10b981;color:#fff" onclick="TB.addFullwidthMenuItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Item</button></div>';
                    
                    const fwMenuItems = content.items || [];
                    fwMenuItems.forEach((item, itemIdx) => {
                        html += '<div class="tb-setting-group" style="background:var(--tb-surface-2);padding:12px;border-radius:8px;margin-bottom:8px;border:1px solid var(--tb-border)">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
                        html += '<span style="font-weight:500;font-size:12px;color:var(--tb-text-muted)">Item ' + (itemIdx + 1) + '</span>';
                        html += '<div style="display:flex;gap:4px">';
                        if (itemIdx > 0) html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.moveFullwidthMenuItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',-1)" title="Move Up">↑</button>';
                        if (itemIdx < fwMenuItems.length - 1) html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.moveFullwidthMenuItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',1)" title="Move Down">↓</button>';
                        html += '<button type="button" class="tb-btn tb-btn-sm" style="background:#ef4444;color:#fff" onclick="TB.removeFullwidthMenuItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ')" title="Remove">×</button>';
                        html += '</div></div>';
                        html += '<div style="margin-bottom:8px"><div class="tb-setting-label">Label</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(item.label || '') + '" placeholder="Menu item text" onchange="TB.updateFullwidthMenuItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'label\',this.value)"></div>';
                        html += '<div><div class="tb-setting-label">URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(item.url || '') + '" placeholder="/" onchange="TB.updateFullwidthMenuItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'url\',this.value)"></div>';
                        html += '</div>';
                    });
                    
                    if (fwMenuItems.length === 0) {
                        html += '<div style="font-size:11px;color:var(--tb-text-muted);padding:16px;text-align:center;background:var(--tb-surface-2);border-radius:8px;border:1px dashed var(--tb-border)">No menu items. Click "+ Add Item" to add a link.</div>';
                    }
                    
                    // Design Settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--tb-border)">Design Options</div>';
                    html += this.renderColorPicker('Background Color', design.background_color, 'TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_color\',VALUE)', '#1e1e2e');
                    html += this.renderColorPicker('Text Color', design.text_color, 'TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_color\',VALUE)', '#ffffff');
                    break;
                case 'fullwidth_slider':
                    const fwSlides = content.slides || [{title:'Slide 1',text:'Description'}];
                    const fwSliderHeight = design.min_height || '400px';
                    const fwOverlay = design.overlay_color || 'rgba(0,0,0,0.4)';
                    preview = '<div style="width:100%;height:' + fwSliderHeight + ';background:linear-gradient(135deg,#667eea,#764ba2);position:relative;display:flex;align-items:center;justify-content:center">';
                    preview += '<div style="position:absolute;inset:0;background:' + fwOverlay + '"></div>';
                    preview += '<div style="position:relative;z-index:1;text-align:center;color:#fff">';
                    preview += '<h1 style="margin:0;font-size:36px;font-weight:700">' + this.escapeHtml(fwSlides[0].title || 'Slide Title') + '</h1>';
                    preview += '<p style="margin:12px 0 0;font-size:16px;opacity:0.9">' + this.escapeHtml(fwSlides[0].text || '') + '</p>';
                    preview += '</div>';
                    preview += '<span style="position:absolute;top:8px;right:8px;background:#0073e6;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;z-index:2">◉ FULLWIDTH (' + fwSlides.length + ' slides)</span>';
                    if (design.show_arrows !== false) { preview += '<div style="position:absolute;left:16px;top:50%;transform:translateY(-50%);color:#fff;font-size:24px;opacity:0.7">◀</div><div style="position:absolute;right:16px;top:50%;transform:translateY(-50%);color:#fff;font-size:24px;opacity:0.7">◁</div>'; }
                    preview += '</div>';
                    break;
                case 'fullwidth_header':
                    const fwHeaderTitle = content.title || 'Welcome to Our Site';
                    const fwHeaderSub = content.subtitle || '';
                    const fwHeaderBtn = content.button_text || 'Get Started';
                    const fwHeaderHeight = design.min_height || '500px';
                    const fwHeaderOverlay = design.overlay_color || 'rgba(0,0,0,0.5)';
                    const fwHeaderAlign = design.text_align || 'center';
                    preview = '<div style="width:100%;height:' + fwHeaderHeight + ';background:linear-gradient(135deg,#1e3a5f,#2d5016);position:relative;display:flex;align-items:center;justify-content:center">';
                    preview += '<div style="position:absolute;inset:0;background:' + fwHeaderOverlay + '"></div>';
                    preview += '<div style="position:relative;z-index:1;text-align:' + fwHeaderAlign + ';padding:20px">';
                    preview += '<h1 style="margin:0;font-size:36px;font-weight:700;color:' + (design.title_color || '#fff') + '">' + this.escapeHtml(fwHeaderTitle) + '</h1>';
                    if (fwHeaderSub) { preview += '<p style="margin:12px 0 0;font-size:16px;color:' + (design.subtitle_color || '#e2e8f0') + '">' + this.escapeHtml(fwHeaderSub) + '</p>'; }
                    preview += '<button style="margin-top:20px;padding:12px 24px;background:' + (design.button_background || '#0073e6') + ';color:' + (design.button_text_color || '#fff') + ';border:none;border-radius:6px;font-size:14px;cursor:pointer">' + this.escapeHtml(fwHeaderBtn) + '</button>';
                    preview += '</div>';
                    preview += '<span style="position:absolute;top:8px;right:8px;background:#0073e6;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;z-index:2">◉ HERO HEADER</span></div>';
                    break;
                case 'fullwidth_portfolio':
                    const fwPortItems = content.items || [{title:'Project 1',category:'Web'},{title:'Project 2',category:'Design'},{title:'Project 3',category:'Web'}];
                    const fwPortCols = design.columns || 3;
                    preview = '<div style="width:100%;position:relative">';
                    if (content.show_filter !== false) { preview += '<div style="text-align:center;padding:12px;background:#f1f5f9;border-bottom:1px solid #e2e8f0"><span style="margin:0 8px;padding:4px 12px;background:#0073e6;color:#fff;border-radius:4px;font-size:12px">All</span><span style="margin:0 8px;color:#64748b;font-size:12px">Web</span><span style="margin:0 8px;color:#64748b;font-size:12px">Design</span></div>'; }
                    preview += '<div style="display:grid;grid-template-columns:repeat(' + fwPortCols + ',1fr);gap:' + (design.gap || '0') + '">';
                    fwPortItems.slice(0,6).forEach(item => {
                        preview += '<div style="aspect-ratio:1;background:#e2e8f0;position:relative;overflow:hidden">';
                        if (item.image) { preview += '<img src="' + this.escapeHtml(item.image) + '" style="width:100%;height:100%;object-fit:cover">'; }
                        preview += '<div style="position:absolute;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff">';
                        preview += '<div style="font-weight:600;font-size:14px">' + this.escapeHtml(item.title) + '</div>';
                        preview += '<div style="font-size:11px;opacity:0.8;margin-top:4px">' + this.escapeHtml(item.category || '') + '</div></div></div>';
                    });
                    preview += '</div><span style="position:absolute;top:8px;right:8px;background:#0073e6;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;z-index:2">◉ PORTFOLIO (' + fwPortItems.length + ')</span></div>';
                    break;
                case 'fullwidth_post_slider':
                    const fwPostHeight = design.min_height || '500px';
                    const fwPostOverlay = design.overlay_color || 'rgba(0,0,0,0.5)';
                    const fwPostCount = content.posts_count || 5;
                    preview = '<div style="width:100%;height:' + fwPostHeight + ';background:linear-gradient(135deg,#334155,#222);position:relative;display:flex;align-items:center;justify-content:center">';
                    preview += '<div style="position:absolute;inset:0;background:' + fwPostOverlay + '"></div>';
                    preview += '<div style="position:relative;z-index:1;text-align:center;color:#fff;padding:20px">';
                    if (content.show_date !== false) { preview += '<div style="font-size:12px;opacity:0.8;margin-bottom:8px">December 15, 2025</div>'; }
                    preview += '<h1 style="margin:0;font-size:32px;font-weight:700">Latest Blog Post Title</h1>';
                    if (content.show_excerpt !== false) { preview += '<p style="margin:12px 0 0;font-size:14px;opacity:0.9;max-width:600px">This is a preview of your blog post excerpt that will appear in the slider...</p>'; }
                    if (content.show_author !== false) { preview += '<div style="margin-top:16px;font-size:12px;opacity:0.7">By Author Name</div>'; }
                    preview += '</div>';
                    if (design.show_arrows !== false) { preview += '<div style="position:absolute;left:16px;top:50%;transform:translateY(-50%);color:#fff;font-size:24px;opacity:0.7">◀</div><div style="position:absolute;right:16px;top:50%;transform:translateY(-50%);color:#fff;font-size:24px;opacity:0.7">◁</div>'; }
                    if (design.show_dots !== false) { preview += '<div style="position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:8px"><div style="width:8px;height:8px;background:#fff;border-radius:50%"></div><div style="width:8px;height:8px;background:rgba(255,255,255,0.4);border-radius:50%"></div><div style="width:8px;height:8px;background:rgba(255,255,255,0.4);border-radius:50%"></div></div>'; }
                    preview += '<span style="position:absolute;top:8px;right:8px;background:#0073e6;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;z-index:2">◉ POST SLIDER (' + fwPostCount + ' posts)</span></div>';
                    break;
                case 'search':
                    const searchPlaceholder = content.placeholder || 'Search...';
                    const searchButtonText = content.button_text || 'Search';
                    const searchShowButton = content.show_button !== false;
                    const searchButtonIconOnly = content.button_icon_only || false;
                    const searchScope = content.search_scope || 'all';
                    const searchResultsPage = content.results_page || '/search';
                    const searchStyle = content.style || 'default';
                    const searchLayout = content.layout || 'inline';
                    const searchInputBg = content.input_background || '#ffffff';
                    const searchInputBorder = content.input_border_color || '#e2e8f0';
                    const searchInputText = content.input_text_color || '#1e293b';
                    const searchInputIcon = content.input_icon_color || '#94a3b8';
                    const searchBtnBg = content.button_background || '#0073e6';
                    const searchBtnText = content.button_text_color || '#ffffff';
                    const searchBtnPosition = content.button_position || 'right';
                    const searchHeight = content.height || '48px';
                    const searchBorderRadius = content.border_radius || '8px';
                    const searchShowIcon = content.show_icon !== false;

                    // Calculate border radius based on style
                    let searchInputRadius = searchBorderRadius;
                    let searchBtnRadius = searchBorderRadius;
                    if (searchStyle === 'pill') {
                        searchInputRadius = 'calc(' + searchHeight + ' / 2)';
                        searchBtnRadius = 'calc(' + searchHeight + ' / 2)';
                    } else if (searchStyle === 'rounded') {
                        searchInputRadius = '16px';
                        searchBtnRadius = '16px';
                    } else if (searchStyle === 'minimal') {
                        searchInputRadius = '0';
                        searchBtnRadius = '4px';
                    }

                    // Container style based on layout
                    const isStacked = searchLayout === 'stacked';
                    const flexDirection = isStacked ? 'column' : 'row';
                    const containerGap = isStacked ? '12px' : (searchBtnPosition === 'inside' ? '0' : '8px');

                    // Input styling based on style variant
                    let inputBorderStyle = '1px solid ' + searchInputBorder;
                    if (searchStyle === 'minimal') {
                        inputBorderStyle = 'none';
                    }

                    preview = '<form action="' + this.escapeHtml(searchResultsPage) + '" method="get" style="width:100%" data-tb-search data-scope="' + searchScope + '">';
                    preview += '<div style="display:flex;flex-direction:' + flexDirection + ';gap:' + containerGap + ';align-items:' + (isStacked ? 'stretch' : 'center') + ';width:100%">';

                    // Input wrapper (for inside button position)
                    const inputWrapperStyle = searchBtnPosition === 'inside' ? 'position:relative;flex:1;' : 'flex:1;';
                    preview += '<div style="' + inputWrapperStyle + '">';

                    // Search input
                    const inputPaddingRight = (searchBtnPosition === 'inside' && searchShowButton) ? 'calc(' + searchHeight + ' + 8px)' : '16px';
                    const inputPaddingLeft = searchShowIcon ? '44px' : '16px';
                    preview += '<div style="position:relative;width:100%">';

                    // Magnifying glass icon inside input
                    if (searchShowIcon) {
                        preview += '<span style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:' + searchInputIcon + ';font-size:16px;pointer-events:none">🔍</span>';
                    }

                    preview += '<input type="text" name="s" style="width:100%;height:' + searchHeight + ';padding:0 ' + inputPaddingRight + ' 0 ' + inputPaddingLeft + ';border:' + inputBorderStyle + ';border-radius:' + searchInputRadius + ';font-size:14px;background:' + searchInputBg + ';color:' + searchInputText + ';box-sizing:border-box;' + (searchStyle === 'minimal' ? 'border-bottom:2px solid ' + searchInputBorder + ';' : '') + '" placeholder="' + this.escapeHtml(searchPlaceholder) + '" disabled>';

                    // Inside button
                    if (searchShowButton && searchBtnPosition === 'inside') {
                        const insideBtnContent = searchButtonIconOnly ? '🔍' : this.escapeHtml(searchButtonText);
                        const insideBtnPadding = searchButtonIconOnly ? '0' : '0 16px';
                        const insideBtnWidth = searchButtonIconOnly ? searchHeight : 'auto';
                        preview += '<button type="submit" style="position:absolute;right:4px;top:50%;transform:translateY(-50%);height:calc(' + searchHeight + ' - 8px);width:' + insideBtnWidth + ';padding:' + insideBtnPadding + ';background:' + searchBtnBg + ';color:' + searchBtnText + ';border:none;border-radius:' + searchBtnRadius + ';font-size:14px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center" disabled>' + insideBtnContent + '</button>';
                    }

                    preview += '</div>'; // close input relative wrapper
                    preview += '</div>'; // close input wrapper

                    // Outside right or below button
                    if (searchShowButton && searchBtnPosition !== 'inside') {
                        const btnContent = searchButtonIconOnly ? '🔍' : this.escapeHtml(searchButtonText);
                        const btnPadding = searchButtonIconOnly ? '0' : '0 24px';
                        const btnWidth = searchButtonIconOnly ? searchHeight : (isStacked ? '100%' : 'auto');
                        preview += '<button type="submit" style="height:' + searchHeight + ';width:' + btnWidth + ';padding:' + btnPadding + ';background:' + searchBtnBg + ';color:' + searchBtnText + ';border:none;border-radius:' + searchBtnRadius + ';font-size:14px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0" disabled>' + btnContent + '</button>';
                    }

                    preview += '</div>'; // close flex container
                    preview += '</form>';

                    // Style and scope indicator
                    const scopeLabels = { all: 'All', pages: 'Pages', posts: 'Posts', products: 'Products' };
                    const scopeLabel = scopeLabels[searchScope] || 'All';
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">🔍 Search • ' + searchStyle + ' • ' + scopeLabel + '</div>';
                    break;
                case 'social':
                    const socialNetworks = content.networks || [
                        { platform: 'facebook', url: '' },
                        { platform: 'twitter', url: '' },
                        { platform: 'instagram', url: '' },
                        { platform: 'linkedin', url: '' }
                    ];
                    const socialStyle = content.style || 'icons';
                    const socialIconSize = content.icon_size || '24px';
                    const socialIconColor = content.icon_color || '#333333';
                    const socialGap = content.gap || '16px';
                    const socialAlignment = content.alignment || 'center';

                    // Platform icons mapping (emoji for preview)
                    const platformIcons = {
                        facebook: '📘',
                        twitter: '🐦',
                        instagram: '📷',
                        linkedin: '💼',
                        youtube: '🎬',
                        tiktok: '🎵',
                        pinterest: '📌',
                        github: '💻',
                        dribbble: '🏀',
                        behance: '🎨',
                        snapchat: '👻',
                        whatsapp: '💬',
                        telegram: '✈️',
                        discord: '🎮',
                        twitch: '📺',
                        reddit: '🤖',
                        medium: '📝',
                        email: '✉️',
                        website: '🌐'
                    };

                    // Style-based rendering
                    const isButtonStyle = socialStyle === 'buttons';
                    const isTextStyle = socialStyle === 'text';
                    const iconSizeNum = parseInt(socialIconSize) || 24;

                    preview = '<div style="text-align:' + socialAlignment + ';padding:16px">';
                    preview += '<div style="display:inline-flex;flex-wrap:wrap;gap:' + socialGap + ';justify-content:' + socialAlignment + ';align-items:center">';

                    socialNetworks.forEach(network => {
                        const platformName = network.platform || 'website';
                        const platformIcon = platformIcons[platformName] || '🔗';
                        const hasUrl = network.url && network.url.trim();
                        const opacity = hasUrl ? '1' : '0.4';
                        const displayName = platformName.charAt(0).toUpperCase() + platformName.slice(1);

                        if (isButtonStyle) {
                            // Button style - icon with background
                            preview += '<div style="display:flex;align-items:center;gap:8px;padding:8px 16px;background:' + (hasUrl ? socialIconColor : '#e2e8f0') + ';color:#fff;border-radius:6px;opacity:' + opacity + '">';
                            preview += '<span style="font-size:' + iconSizeNum + 'px">' + platformIcon + '</span>';
                            preview += '<span style="font-size:12px;font-weight:500">' + displayName + '</span>';
                            preview += '</div>';
                        } else if (isTextStyle) {
                            // Text style - text link only
                            preview += '<span style="font-size:14px;color:' + socialIconColor + ';opacity:' + opacity + ';font-weight:500">' + displayName + '</span>';
                        } else {
                            // Icons style (default) - icon only
                            preview += '<span style="font-size:' + iconSizeNum + 'px;opacity:' + opacity + '" title="' + this.escapeHtml(displayName) + '">' + platformIcon + '</span>';
                        }
                    });

                    preview += '</div></div>';

                    // Style indicator
                    const activeCount = socialNetworks.filter(n => n.url && n.url.trim()).length;
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">🔗 Social Follow • ' + socialStyle + ' • ' + activeCount + '/' + socialNetworks.length + ' active</div>';
                    break;
                case 'menu':
                    const menuSource = content.menu_source || 'custom';
                    const menuItems = content.items || [
                        { label: 'Home', url: '/' },
                        { label: 'About', url: '/about' },
                        { label: 'Contact', url: '/contact' }
                    ];
                    const menuOrientation = content.orientation || 'horizontal';
                    const menuAlignment = content.alignment || 'center';
                    const menuGap = content.gap || '24px';
                    const menuFontSize = content.font_size || '16px';
                    const menuTextColor = content.text_color || '#333333';
                    const menuHoverColor = content.hover_color || '#0073e6';
                    const isHorizontal = menuOrientation === 'horizontal';
                    const menuFlexDirection = isHorizontal ? 'row' : 'column';
                    const justifyContent = menuAlignment === 'left' ? 'flex-start' : (menuAlignment === 'right' ? 'flex-end' : 'center');

                    preview = '<div style="padding:16px;background:#fff;border-radius:8px">';
                    preview += '<nav style="display:flex;flex-direction:' + menuFlexDirection + ';gap:' + menuGap + ';justify-content:' + justifyContent + ';align-items:' + (isHorizontal ? 'center' : 'stretch') + ';flex-wrap:wrap">';

                    if (menuSource === 'cms_menu' && content.cms_menu_id) {
                        // CMS Menu placeholder
                        preview += '<span style="font-size:' + menuFontSize + ';color:' + menuTextColor + ';padding:4px 8px;background:#f0f9ff;border:1px dashed #0073e6;border-radius:4px">CMS Menu #' + content.cms_menu_id + '</span>';
                    } else {
                        // Custom menu items with typography
                        const menuLinkTypo = this.getElementTypographyStyles(settings, 'link');
                        menuItems.forEach((item, idx) => {
                            const itemLabel = item.label || 'Link ' + (idx + 1);
                            const itemUrl = item.url || '#';
                            const isActive = itemUrl === '/' || itemUrl === window.location.pathname;
                            const activeStyle = isActive ? 'font-weight:600;color:' + menuHoverColor : 'color:' + menuTextColor;
                            preview += '<a href="javascript:void(0)" style="font-size:' + menuFontSize + ';' + activeStyle + ';text-decoration:none;padding:4px 0;transition:color 0.2s;' + menuLinkTypo + '" onmouseover="this.style.color=\'' + menuHoverColor + '\'" onmouseout="this.style.color=\'' + (isActive ? menuHoverColor : menuTextColor) + '\'">' + this.escapeHtml(itemLabel) + '</a>';
                        });
                    }

                    preview += '</nav></div>';

                    // Style indicator
                    const menuSourceLabel = menuSource === 'cms_menu' ? 'CMS Menu' : 'Custom';
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">☰ Menu • ' + menuOrientation + ' • ' + menuSourceLabel + ' • ' + menuItems.length + ' items</div>';
                    break;
                case 'sidebar':
                    const sidebarWidgetAreaId = content.widget_area_id || null;
                    const sidebarShowTitle = content.show_title !== false;
                    const sidebarTitle = content.title || 'Sidebar';
                    const sidebarBgColor = content.background_color || '#ffffff';
                    const sidebarPadding = content.padding || '20px';
                    const sidebarBorder = content.border || '1px solid #e2e8f0';
                    const sidebarWidth = content.width || '100%';
                    const sidebarTitleTypo = this.getElementTypographyStyles(settings, 'title');

                    preview = '<div style="background:' + sidebarBgColor + ';padding:' + sidebarPadding + ';border:' + sidebarBorder + ';border-radius:8px;width:' + sidebarWidth + '">';

                    // Title
                    if (sidebarShowTitle) {
                        preview += '<h3 style="margin:0 0 16px 0;font-size:18px;font-weight:600;color:#1e293b;border-bottom:2px solid #e2e8f0;padding-bottom:12px;' + sidebarTitleTypo + '">' + this.escapeHtml(sidebarTitle) + '</h3>';
                    }

                    // Dynamic Widget Area badge
                    if (sidebarWidgetAreaId) {
                        preview += '<div style="background:#f0f9ff;border:1px dashed #0073e6;border-radius:6px;padding:12px;margin-bottom:12px;text-align:center">';
                        preview += '<span style="font-size:11px;color:#0073e6;font-weight:500">🔗 Widget Area #' + sidebarWidgetAreaId + '</span>';
                        preview += '</div>';
                    }

                    // Placeholder widgets
                    preview += '<div style="display:flex;flex-direction:column;gap:16px">';

                    // Search widget placeholder
                    preview += '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:12px">';
                    preview += '<div style="font-size:12px;font-weight:600;color:#475569;margin-bottom:8px">🔍 Search</div>';
                    preview += '<div style="background:#fff;border:1px solid #e2e8f0;border-radius:4px;padding:8px;color:#94a3b8;font-size:12px">Search...</div>';
                    preview += '</div>';

                    // Categories widget placeholder
                    preview += '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:12px">';
                    preview += '<div style="font-size:12px;font-weight:600;color:#475569;margin-bottom:8px">📁 Categories</div>';
                    preview += '<div style="font-size:11px;color:#64748b;line-height:1.8">• Technology<br>• Design<br>• Business</div>';
                    preview += '</div>';

                    // Recent Posts widget placeholder
                    preview += '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:12px">';
                    preview += '<div style="font-size:12px;font-weight:600;color:#475569;margin-bottom:8px">📰 Recent Posts</div>';
                    preview += '<div style="font-size:11px;color:#64748b;line-height:1.6">• Getting Started with...<br>• How to Build...<br>• Top 10 Tips for...</div>';
                    preview += '</div>';

                    preview += '</div>';

                    // Dynamic badge
                    preview += '<div style="margin-top:12px;text-align:center">';
                    preview += '<span style="display:inline-block;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-size:9px;font-weight:600;padding:4px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:0.5px">[Dynamic Widget Area]</span>';
                    preview += '</div>';

                    preview += '</div>';

                    // Style indicator
                    const sidebarAreaLabel = sidebarWidgetAreaId ? 'Area #' + sidebarWidgetAreaId : 'No Area';
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">📋 Sidebar • ' + sidebarAreaLabel + '</div>';
                    break;
                case 'testimonial':
                    const testQuote = content.text || 'This is a testimonial quote from a happy customer.';
                    const testAuthor = content.author || 'John Doe';
                    const testRole = content.role || 'CEO, Company';
                    const testAvatar = content.avatar || '';
                    const testStyle = content.style || 'card';
                    const testQuoteTypo = this.getElementTypographyStyles(settings, 'quote');
                    const testAuthorTypo = this.getElementTypographyStyles(settings, 'author');
                    const testRoleTypo = this.getElementTypographyStyles(settings, 'role');
                    const testCardBg = testStyle === 'card' ? 'background:#fff;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);' : '';
                    const testAlign = testStyle === 'centered' ? 'center' : 'left';
                    preview = '<div style="' + testCardBg + 'padding:20px;text-align:' + testAlign + '">';
                    preview += '<div style="font-size:32px;color:#e2e8f0;margin-bottom:8px">"</div>';
                    preview += '<p style="margin:0 0 16px 0;font-size:14px;color:#475569;font-style:italic;line-height:1.6;' + testQuoteTypo + '">' + this.escapeHtml(testQuote.substring(0, 150)) + (testQuote.length > 150 ? '...' : '') + '</p>';
                    preview += '<div style="display:flex;align-items:center;gap:12px;' + (testAlign === 'center' ? 'justify-content:center' : '') + '">';
                    if (testAvatar) {
                        preview += '<img src="' + this.escapeHtml(testAvatar) + '" style="width:48px;height:48px;border-radius:50%;object-fit:cover">';
                    } else {
                        preview += '<div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center"><span style="font-size:20px">👤</span></div>';
                    }
                    preview += '<div>';
                    preview += '<div style="font-weight:600;color:#1e293b;font-size:14px;' + testAuthorTypo + '">' + this.escapeHtml(testAuthor) + '</div>';
                    preview += '<div style="font-size:12px;color:#64748b;' + testRoleTypo + '">' + this.escapeHtml(testRole) + '</div>';
                    preview += '</div></div></div>';
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">💭 Testimonial • ' + testStyle + ' style</div>';
                    break;
                case 'cta':
                    const ctaTitle = content.title || 'Ready to Get Started?';
                    const ctaSubtitle = content.subtitle || 'Join thousands of satisfied customers using our product.';
                    const ctaBtnText = content.button_text || 'Get Started';
                    const ctaBtnUrl = content.button_url || '#';
                    const ctaStyle = content.style || 'centered';
                    const ctaTitleTypo = this.getElementTypographyStyles(settings, 'title');
                    const ctaSubtitleTypo = this.getElementTypographyStyles(settings, 'subtitle');
                    const ctaButtonTypo = this.getElementTypographyStyles(settings, 'button');
                    const ctaAlign = ctaStyle === 'left' ? 'flex-start' : (ctaStyle === 'split' ? 'space-between' : 'center');
                    const ctaTextAlign = ctaStyle === 'left' ? 'left' : (ctaStyle === 'split' ? 'left' : 'center');
                    preview = '<div style="background:linear-gradient(135deg,#667eea,#764ba2);padding:32px;border-radius:12px;display:flex;align-items:center;justify-content:' + ctaAlign + ';gap:24px;' + (ctaStyle === 'split' ? 'flex-wrap:wrap' : 'flex-direction:column') + '">';
                    preview += '<div style="' + (ctaStyle === 'split' ? 'flex:1;min-width:200px' : '') + ';text-align:' + ctaTextAlign + '">';
                    preview += '<h3 style="margin:0 0 8px 0;font-size:24px;font-weight:700;color:#fff;' + ctaTitleTypo + '">' + this.escapeHtml(ctaTitle) + '</h3>';
                    preview += '<p style="margin:0;font-size:14px;color:rgba(255,255,255,0.9);' + ctaSubtitleTypo + '">' + this.escapeHtml(ctaSubtitle) + '</p>';
                    preview += '</div>';
                    preview += '<button style="padding:12px 24px;background:#fff;color:#667eea;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;white-space:nowrap;' + ctaButtonTypo + '">' + this.escapeHtml(ctaBtnText) + '</button>';
                    preview += '</div>';
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">📢 CTA • ' + ctaStyle + ' layout</div>';
                    break;
                case 'pricing':
                    const prcTitle = content.title || 'Professional';
                    const prcPrice = content.price || '$29';
                    const prcPeriod = content.period || '/month';
                    const prcHighlighted = content.highlighted || false;
                    const prcFeatures = content.features || ['Feature 1', 'Feature 2', 'Feature 3'];
                    const prcBtnText = content.button_text || 'Choose Plan';
                    const prcTitleTypo = this.getElementTypographyStyles(settings, 'title');
                    const prcPriceTypo = this.getElementTypographyStyles(settings, 'price');
                    const prcFeaturesTypo = this.getElementTypographyStyles(settings, 'features');
                    const prcButtonTypo = this.getElementTypographyStyles(settings, 'button');
                    const prcBorder = prcHighlighted ? 'border:2px solid #667eea;box-shadow:0 4px 20px rgba(102,126,234,0.25)' : 'border:1px solid #e2e8f0';
                    const prcBadge = prcHighlighted ? '<div style="position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:#667eea;color:#fff;padding:4px 12px;border-radius:12px;font-size:10px;font-weight:600">POPULAR</div>' : '';
                    preview = '<div style="position:relative;background:#fff;' + prcBorder + ';border-radius:12px;padding:24px;text-align:center">';
                    preview += prcBadge;
                    preview += '<h4 style="margin:0 0 8px 0;font-size:18px;font-weight:600;color:#1e293b;' + prcTitleTypo + '">' + this.escapeHtml(prcTitle) + '</h4>';
                    preview += '<div style="margin-bottom:16px;' + prcPriceTypo + '"><span style="font-size:36px;font-weight:700;color:#1e293b">' + this.escapeHtml(prcPrice) + '</span><span style="font-size:14px;color:#64748b">' + this.escapeHtml(prcPeriod) + '</span></div>';
                    preview += '<ul style="list-style:none;padding:0;margin:0 0 20px 0;text-align:left">';
                    prcFeatures.slice(0, 4).forEach(f => {
                        preview += '<li style="padding:6px 0;font-size:13px;color:#475569;display:flex;align-items:center;gap:8px;' + prcFeaturesTypo + '"><span style="color:#10b981">✓</span>' + this.escapeHtml(f) + '</li>';
                    });
                    if (prcFeatures.length > 4) preview += '<li style="padding:6px 0;font-size:12px;color:#94a3b8">+' + (prcFeatures.length - 4) + ' more features</li>';
                    preview += '</ul>';
                    preview += '<button style="width:100%;padding:10px 20px;background:' + (prcHighlighted ? '#667eea' : '#f1f5f9') + ';color:' + (prcHighlighted ? '#fff' : '#475569') + ';border:none;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;' + prcButtonTypo + '">' + this.escapeHtml(prcBtnText) + '</button>';
                    preview += '</div>';
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">💰 Pricing • ' + (prcHighlighted ? 'highlighted' : 'standard') + '</div>';
                    break;
                case 'list':
                    const listItems = content.items || ['Item 1', 'Item 2', 'Item 3'];
                    const listStyle = content.list_style || 'bullet';
                    const listItemTypo = this.getElementTypographyStyles(settings, 'item');
                    const listIcon = listStyle === 'check' ? '✓' : (listStyle === 'arrow' ? '→' : (listStyle === 'number' ? '' : '•'));
                    preview = '<div style="padding:8px">';
                    preview += '<ul style="list-style:' + (listStyle === 'number' ? 'decimal' : 'none') + ';padding-left:' + (listStyle === 'number' ? '20px' : '0') + ';margin:0">';
                    listItems.slice(0, 5).forEach((item, idx) => {
                        const prefix = listStyle === 'number' ? '' : '<span style="color:#667eea;margin-right:8px">' + listIcon + '</span>';
                        preview += '<li style="padding:4px 0;font-size:14px;color:#374141;' + listItemTypo + '">' + prefix + this.escapeHtml(item) + '</li>';
                    });
                    if (listItems.length > 5) preview += '<li style="padding:4px 0;font-size:12px;color:#94a3b8">+' + (listItems.length - 5) + ' more items</li>';
                    preview += '</ul></div>';
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">📋 List • ' + listStyle + ' style • ' + listItems.length + ' items</div>';
                    break;
                case 'toggle':
                    const toggleTitle = content.title || 'Click to expand';
                    const toggleContent = content.content || 'Hidden content goes here...';
                    const toggleOpen = content.open_by_default || false;
                    const toggleIconPos = content.icon_position || 'right';
                    const toggleIconOpen = content.icon_open || '+';
                    const toggleIconClose = content.icon_close || '−';
                    const toggleTitleBg = content.title_background || '#f8fafc';
                    const toggleTitleColor = content.title_color || '#1e293b';
                    const toggleContentBg = content.content_background || '#ffffff';
                    const toggleBorderColor = content.border_color || '#e2e8f0';
                    const toggleBorderRadius = content.border_radius || '8px';
                    const toggleTitleTypo = this.getElementTypographyStyles(settings, 'title');
                    const toggleContentTypo = this.getElementTypographyStyles(settings, 'content');
                    const toggleCurrentIcon = toggleOpen ? toggleIconClose : toggleIconOpen;
                    const toggleIconStyle = 'font-size:18px;font-weight:700;color:' + toggleTitleColor + ';flex-shrink:0;width:24px;text-align:center;transition:transform 0.3s';
                    preview = '<div data-tb-toggle style="border:1px solid ' + toggleBorderColor + ';border-radius:' + toggleBorderRadius + ';overflow:hidden">';
                    // Header
                    preview += '<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:' + toggleTitleBg + ';cursor:pointer;user-select:none">';
                    if (toggleIconPos === 'left') {
                        preview += '<span style="' + toggleIconStyle + '">' + this.escapeHtml(toggleCurrentIcon) + '</span>';
                        preview += '<span style="flex:1;font-size:15px;font-weight:500;color:' + toggleTitleColor + ';margin-left:12px;' + toggleTitleTypo + '">' + this.escapeHtml(toggleTitle) + '</span>';
                    } else {
                        preview += '<span style="flex:1;font-size:15px;font-weight:500;color:' + toggleTitleColor + ';' + toggleTitleTypo + '">' + this.escapeHtml(toggleTitle) + '</span>';
                        preview += '<span style="' + toggleIconStyle + '">' + this.escapeHtml(toggleCurrentIcon) + '</span>';
                    }
                    preview += '</div>';
                    // Content (show if open_by_default)
                    if (toggleOpen) {
                        preview += '<div style="padding:16px;background:' + toggleContentBg + ';border-top:1px solid ' + toggleBorderColor + '">';
                        preview += '<p style="margin:0;font-size:14px;color:#475569;line-height:1.6;' + toggleContentTypo + '">' + this.escapeHtml(toggleContent.substring(0, 150)) + (toggleContent.length > 150 ? '...' : '') + '</p>';
                        preview += '</div>';
                    } else {
                        preview += '<div style="padding:16px;background:' + toggleContentBg + ';border-top:1px solid ' + toggleBorderColor + ';opacity:0.5;font-style:italic">';
                        preview += '<p style="margin:0;font-size:12px;color:#94a3b8">Content hidden (collapsed state)</p>';
                        preview += '</div>';
                    }
                    preview += '</div>';
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">📂 Toggle • ' + (toggleOpen ? 'open' : 'closed') + ' by default • icon ' + toggleIconPos + '</div>';
                    break;
                case 'bar_counters':
                    const bcBars = content.bars || [
                        { label: 'HTML/CSS', percent: 90, color: '#0073e6' },
                        { label: 'JavaScript', percent: 85, color: '#f59e0b' },
                        { label: 'PHP', percent: 80, color: '#8b5cf6' }
                    ];
                    const bcBarHeight = content.bar_height || '20px';
                    const bcBarBg = content.bar_background || '#e2e8f0';
                    const bcBarRadius = content.bar_border_radius || '10px';
                    const bcShowPercent = content.show_percent !== false;
                    const bcPercentPos = content.percent_position || 'inside';
                    const bcLabelColor = content.label_color || '#1e293b';
                    const bcLabelSize = content.label_size || '14px';
                    const bcGap = content.gap || '16px';
                    const bcAnimate = content.animate !== false;
                    const bcAnimDuration = content.animation_duration || '1.5s';
                    const bcLabelTypo = this.getElementTypographyStyles(settings, 'label');
                    const bcPercentTypo = this.getElementTypographyStyles(settings, 'percent');

                    preview = '<div data-tb-bar-counters data-tb-bar-animate="' + (bcAnimate ? 'true' : 'false') + '" style="display:flex;flex-direction:column;gap:' + bcGap + ';padding:8px 0">';

                    bcBars.forEach((bar, idx) => {
                        const barLabel = bar.label || 'Skill ' + (idx + 1);
                        const barPercent = Math.min(100, Math.max(0, parseInt(bar.percent) || 0));
                        const barColor = bar.color || '#0073e6';
                        const barHeightNum = parseInt(bcBarHeight) || 20;
                        const showPercentInside = bcPercentPos === 'inside' && barHeightNum >= 16;

                        preview += '<div class="tb-bar-item">';

                        // Label row (with percent if position is 'above')
                        if (bcPercentPos === 'above') {
                            preview += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
                            preview += '<span style="font-size:' + bcLabelSize + ';color:' + bcLabelColor + ';font-weight:500;' + bcLabelTypo + '">' + this.escapeHtml(barLabel) + '</span>';
                            if (bcShowPercent) {
                                preview += '<span style="font-size:' + bcLabelSize + ';color:' + barColor + ';font-weight:600;' + bcPercentTypo + '">' + barPercent + '%</span>';
                            }
                            preview += '</div>';
                        } else {
                            preview += '<div style="margin-bottom:4px"><span style="font-size:' + bcLabelSize + ';color:' + bcLabelColor + ';font-weight:500;' + bcLabelTypo + '">' + this.escapeHtml(barLabel) + '</span></div>';
                        }

                        // Progress bar container
                        preview += '<div style="position:relative;width:100%;height:' + bcBarHeight + ';background:' + bcBarBg + ';border-radius:' + bcBarRadius + ';overflow:hidden">';

                        // Filled portion with animation
                        const transitionStyle = bcAnimate ? 'transition:width ' + bcAnimDuration + ' ease-out;' : '';
                        preview += '<div style="position:absolute;left:0;top:0;height:100%;width:' + barPercent + '%;background:' + barColor + ';border-radius:' + bcBarRadius + ';' + transitionStyle + 'display:flex;align-items:center;justify-content:flex-end;padding-right:' + (showPercentInside ? '8px' : '0') + '">';

                        // Percent inside bar
                        if (bcShowPercent && showPercentInside) {
                            preview += '<span style="font-size:' + Math.min(barHeightNum - 4, 14) + 'px;color:#fff;font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,0.2);' + bcPercentTypo + '">' + barPercent + '%</span>';
                        }

                        preview += '</div></div>';

                        // Percent outside (to the right)
                        if (bcShowPercent && bcPercentPos === 'outside') {
                            preview += '<div style="display:flex;justify-content:flex-end;margin-top:2px"><span style="font-size:12px;color:' + barColor + ';font-weight:600;' + bcPercentTypo + '">' + barPercent + '%</span></div>';
                        }

                        preview += '</div>';
                    });

                    preview += '</div>';
                    preview += '<div style="margin-top:8px;font-size:10px;color:#64748b;text-align:center">📊 Bar Counters • ' + bcBars.length + ' bar' + (bcBars.length !== 1 ? 's' : '') + (bcAnimate ? ' • animated' : '') + '</div>';
                    break;
                case 'circle_counter':
                    // Circle Counter - SVG-based circular progress indicator
                    const ccPercent = Math.min(100, Math.max(0, parseInt(content.percent) || 75));
                    const ccTitle = content.title || 'Completed';
                    const ccPrefix = content.number_prefix || '';
                    const ccSuffix = content.number_suffix || '%';
                    const ccCircleSize = parseInt(content.circle_size) || 200;
                    const ccBarWidth = parseInt(content.bar_width) || 10;
                    const ccBarColor = content.bar_color || '#0073e6';
                    const ccTrackColor = content.track_color || '#e2e8f0';
                    const ccNumberSize = content.number_size || '48px';
                    const ccNumberColor = content.number_color || '#1e293b';
                    const ccTitleSize = content.title_size || '16px';
                    const ccTitleColor = content.title_color || '#64748b';
                    const ccAnimate = content.animate !== false;
                    const ccAnimDuration = content.animation_duration || '1.5s';
                    const ccLineCap = content.line_cap || 'round';
                    const ccNumberTypo = this.getElementTypographyStyles(settings, 'number');
                    const ccTitleTypo = this.getElementTypographyStyles(settings, 'title');

                    // SVG circle calculations
                    const ccRadius = (ccCircleSize - ccBarWidth) / 2;
                    const ccCircumference = 2 * Math.PI * ccRadius;
                    const ccStrokeDashoffset = ccCircumference - (ccPercent / 100) * ccCircumference;
                    const ccViewBox = ccCircleSize;
                    const ccCenter = ccCircleSize / 2;

                    preview = '<div style="display:flex;flex-direction:column;align-items:center;padding:24px">';

                    // SVG Circle
                    preview += '<div style="position:relative;width:' + ccCircleSize + 'px;height:' + ccCircleSize + 'px">';
                    preview += '<svg width="' + ccCircleSize + '" height="' + ccCircleSize + '" viewBox="0 0 ' + ccViewBox + ' ' + ccViewBox + '" style="transform:rotate(-90deg)">';

                    // Track circle (background)
                    preview += '<circle cx="' + ccCenter + '" cy="' + ccCenter + '" r="' + ccRadius + '" fill="none" stroke="' + ccTrackColor + '" stroke-width="' + ccBarWidth + '"/>';

                    // Progress arc
                    const ccTransition = ccAnimate ? 'transition:stroke-dashoffset ' + ccAnimDuration + ' ease-out;' : '';
                    preview += '<circle cx="' + ccCenter + '" cy="' + ccCenter + '" r="' + ccRadius + '" fill="none" stroke="' + ccBarColor + '" stroke-width="' + ccBarWidth + '" stroke-linecap="' + ccLineCap + '" stroke-dasharray="' + ccCircumference + '" stroke-dashoffset="' + ccStrokeDashoffset + '" style="' + ccTransition + '"/>';

                    preview += '</svg>';

                    // Center content (number and title)
                    preview += '<div style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center">';

                    // Number with prefix/suffix
                    preview += '<div style="font-size:' + ccNumberSize + ';font-weight:700;color:' + ccNumberColor + ';line-height:1.1;' + ccNumberTypo + '">';
                    if (ccPrefix) preview += '<span style="font-size:calc(' + ccNumberSize + ' * 0.5);vertical-align:top;margin-right:1px">' + this.escapeHtml(ccPrefix) + '</span>';
                    preview += this.escapeHtml(String(ccPercent));
                    if (ccSuffix) preview += '<span style="font-size:calc(' + ccNumberSize + ' * 0.5);vertical-align:top;margin-left:1px">' + this.escapeHtml(ccSuffix) + '</span>';
                    preview += '</div>';

                    // Title
                    preview += '<div style="font-size:' + ccTitleSize + ';color:' + ccTitleColor + ';margin-top:4px;font-weight:500;' + ccTitleTypo + '">' + this.escapeHtml(ccTitle) + '</div>';

                    preview += '</div></div>';

                    // Info footer
                    preview += '<div style="margin-top:12px;font-size:10px;color:#94a3b8">⭕ Circle Counter • ' + ccPercent + '%' + (ccAnimate ? ' • animated' : '') + '</div>';
                    preview += '</div>';
                    break;
                case 'posts_navigation':
                    // Posts Navigation - Previous/Next post links
                    const pnPrevLabel = content.prev_label || 'Previous Post';
                    const pnNextLabel = content.next_label || 'Next Post';
                    const pnShowTitle = content.show_title !== false;
                    const pnShowThumbnail = content.show_thumbnail !== false;
                    const pnSameCategory = content.same_category || false;
                    const pnShowArrows = content.show_arrows !== false;
                    const pnStyle = content.style || 'default';
                    const pnLayout = content.layout || 'split';
                    const pnThumbnailSize = content.thumbnail_size || '80px';
                    const pnThumbnailRadius = content.thumbnail_radius || '8px';
                    const pnBgColor = content.background_color || '#f8fafc';
                    const pnHoverBg = content.hover_background || '#f1f5f9';
                    const pnLabelColor = content.label_color || '#64748b';
                    const pnLabelSize = content.label_size || '12px';
                    const pnTitleColor = content.title_color || '#1e293b';
                    const pnTitleSize = content.title_size || '16px';
                    const pnTitleHoverColor = content.title_hover_color || '#0073e6';
                    const pnArrowColor = content.arrow_color || '#94a3b8';
                    const pnBorderColor = content.border_color || '#e2e8f0';
                    const pnPadding = content.padding || '20px';
                    const pnGap = content.gap || '24px';
                    const pnLabelTypo = this.getElementTypographyStyles(settings, 'label');
                    const pnTitleTypo = this.getElementTypographyStyles(settings, 'title');

                    // Style-based container
                    let pnContainerStyle = '';
                    let pnItemStyle = '';
                    if (pnStyle === 'card') {
                        pnContainerStyle = 'background:transparent;';
                        pnItemStyle = 'background:' + pnBgColor + ';border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:' + pnPadding;
                    } else if (pnStyle === 'minimal') {
                        pnContainerStyle = 'background:transparent;';
                        pnItemStyle = 'background:transparent;padding:' + pnPadding;
                    } else if (pnStyle === 'fullwidth') {
                        pnContainerStyle = 'background:' + pnBgColor + ';';
                        pnItemStyle = 'background:transparent;padding:' + pnPadding + ';border-bottom:1px solid ' + pnBorderColor;
                    } else {
                        // default style
                        pnContainerStyle = 'background:' + pnBgColor + ';border:1px solid ' + pnBorderColor + ';border-radius:8px;';
                        pnItemStyle = 'padding:' + pnPadding;
                    }

                    // Layout direction
                    const pnIsStacked = pnLayout === 'stacked' || pnStyle === 'fullwidth';
                    const pnFlexDirection = pnIsStacked ? 'column' : 'row';
                    const pnItemWidth = pnIsStacked ? '100%' : 'calc(50% - ' + pnGap + ' / 2)';
                    const pnBorderBetween = pnIsStacked ? '' : (pnStyle === 'default' ? 'border-right:1px solid ' + pnBorderColor : '');

                    preview = '<div style="' + pnContainerStyle + 'position:relative" data-tb-dynamic="posts_navigation">';

                    // Dynamic badge
                    preview += '<div style="position:absolute;top:8px;left:8px;background:rgba(59,130,246,0.9);color:#fff;padding:4px 8px;border-radius:4px;font-size:10px;z-index:10">⚡ Dynamic Navigation</div>';
                    preview += '<div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);color:#fff;padding:4px 10px;border-radius:4px;font-size:11px">↔️ [Dynamic Navigation]</div>';

                    // Navigation container
                    preview += '<div style="display:flex;flex-direction:' + pnFlexDirection + ';gap:' + pnGap + ';padding-top:32px">';

                    // Previous post
                    preview += '<div style="' + pnItemStyle + ';' + pnBorderBetween + ';width:' + pnItemWidth + ';display:flex;align-items:center;gap:12px">';
                    if (pnShowArrows) {
                        preview += '<span style="font-size:24px;color:' + pnArrowColor + '">←</span>';
                    }
                    if (pnShowThumbnail) {
                        preview += '<div style="width:' + pnThumbnailSize + ';height:' + pnThumbnailSize + ';background:linear-gradient(135deg,#667eea,#764ba2);border-radius:' + pnThumbnailRadius + ';flex-shrink:0;display:flex;align-items:center;justify-content:center"><span style="font-size:20px;color:#fff;opacity:0.7">📷</span></div>';
                    }
                    preview += '<div style="flex:1;min-width:0">';
                    preview += '<div style="font-size:' + pnLabelSize + ';color:' + pnLabelColor + ';margin-bottom:4px;' + pnLabelTypo + '">' + this.escapeHtml(pnPrevLabel) + '</div>';
                    if (pnShowTitle) {
                        preview += '<div style="font-size:' + pnTitleSize + ';color:' + pnTitleColor + ';font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;' + pnTitleTypo + '">Sample Previous Post Title</div>';
                    }
                    preview += '</div></div>';

                    // Next post
                    preview += '<div style="' + pnItemStyle + ';width:' + pnItemWidth + ';display:flex;align-items:center;gap:12px;' + (pnIsStacked ? '' : 'justify-content:flex-end;text-align:right') + '">';
                    preview += '<div style="flex:1;min-width:0;' + (pnIsStacked ? '' : 'order:1') + '">';
                    preview += '<div style="font-size:' + pnLabelSize + ';color:' + pnLabelColor + ';margin-bottom:4px;' + pnLabelTypo + '">' + this.escapeHtml(pnNextLabel) + '</div>';
                    if (pnShowTitle) {
                        preview += '<div style="font-size:' + pnTitleSize + ';color:' + pnTitleColor + ';font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;' + pnTitleTypo + '">Sample Next Post Title</div>';
                    }
                    preview += '</div>';
                    if (pnShowThumbnail) {
                        preview += '<div style="width:' + pnThumbnailSize + ';height:' + pnThumbnailSize + ';background:linear-gradient(135deg,#f59e0b,#ef4444);border-radius:' + pnThumbnailRadius + ';flex-shrink:0;display:flex;align-items:center;justify-content:center;' + (pnIsStacked ? '' : 'order:2') + '"><span style="font-size:20px;color:#fff;opacity:0.7">📷</span></div>';
                    }
                    if (pnShowArrows) {
                        preview += '<span style="font-size:24px;color:' + pnArrowColor + ';' + (pnIsStacked ? '' : 'order:3') + '">→</span>';
                    }
                    preview += '</div>';

                    preview += '</div>';

                    // Info footer
                    preview += '<div style="margin-top:12px;font-size:10px;color:#94a3b8;padding:0 ' + pnPadding + ' ' + pnPadding + '">↔️ Posts Navigation • ' + pnStyle + ' style • ' + pnLayout + ' layout' + (pnSameCategory ? ' • same category' : '') + '</div>';
                    preview += '</div>';
                    break;
                case 'comments':
                    // Comments module - Display and submit comments for posts/pages
                    const cmTitle = content.title || 'Comments';
                    const cmShowTitle = content.show_title !== false;
                    const cmShowCountInTitle = content.show_count_in_title !== false;
                    const cmShowAvatars = content.show_avatars !== false;
                    const cmAvatarSize = content.avatar_size || '48px';
                    const cmShowReplyButton = content.show_reply_button !== false;
                    const cmShowDate = content.show_date !== false;
                    const cmDateFormat = content.date_format || 'M d, Y';
                    const cmFormTitle = content.form_title || 'Leave a Comment';
                    const cmShowForm = content.show_form !== false;
                    const cmRequireNameEmail = content.require_name_email !== false;
                    const cmSubmitText = content.submit_text || 'Post Comment';
                    const cmStyle = content.style || 'default';
                    const cmBgColor = content.background_color || '#ffffff';
                    const cmCommentBg = content.comment_background || '#f8fafc';
                    const cmCommentBorder = content.comment_border_color || '#e2e8f0';
                    const cmAuthorColor = content.author_color || '#1e293b';
                    const cmAuthorSize = content.author_size || '16px';
                    const cmDateColor = content.date_color || '#64748b';
                    const cmDateSize = content.date_size || '12px';
                    const cmTextColor = content.text_color || '#374151';
                    const cmTextSize = content.text_size || '14px';
                    const cmReplyIndent = content.reply_indent || '40px';
                    const cmAvatarRadius = content.avatar_radius || '50%';
                    const cmFormBg = content.form_background || '#f8fafc';
                    const cmInputBg = content.input_background || '#ffffff';
                    const cmInputBorder = content.input_border_color || '#e2e8f0';
                    const cmButtonBg = content.button_background || '#0073e6';
                    const cmButtonText = content.button_text_color || '#ffffff';
                    const cmGap = content.gap || '20px';
                    const cmAuthorTypo = this.getElementTypographyStyles(settings, 'author');
                    const cmDateTypo = this.getElementTypographyStyles(settings, 'date');
                    const cmTextTypo = this.getElementTypographyStyles(settings, 'text');

                    // Style-specific container styling
                    let cmContainerStyle = 'background:' + cmBgColor + ';';
                    let cmCommentStyle = 'background:' + cmCommentBg + ';border:1px solid ' + cmCommentBorder + ';border-radius:8px;padding:16px;';
                    if (cmStyle === 'card') {
                        cmCommentStyle = 'background:' + cmCommentBg + ';border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);';
                    } else if (cmStyle === 'minimal') {
                        cmCommentStyle = 'background:transparent;border-bottom:1px solid ' + cmCommentBorder + ';padding:16px 0;border-radius:0;';
                    } else if (cmStyle === 'threaded') {
                        cmCommentStyle = 'background:' + cmCommentBg + ';border-left:3px solid ' + cmCommentBorder + ';padding:16px;border-radius:0 8px 8px 0;';
                    }

                    preview = '<div style="' + cmContainerStyle + 'padding:20px;position:relative" data-tb-dynamic="comments">';

                    // Dynamic badge
                    preview += '<div style="position:absolute;top:8px;left:8px;background:rgba(59,130,246,0.9);color:#fff;padding:4px 8px;border-radius:4px;font-size:10px;z-index:10">⚡ Dynamic Comments</div>';
                    preview += '<div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);color:#fff;padding:4px 10px;border-radius:4px;font-size:11px">💬 [Dynamic Comments]</div>';

                    // Title section
                    if (cmShowTitle) {
                        const titleDisplay = cmShowCountInTitle ? cmTitle + ' (3)' : cmTitle;
                        preview += '<h3 style="font-size:20px;font-weight:600;color:' + cmAuthorColor + ';margin:32px 0 20px 0;padding-bottom:12px;border-bottom:2px solid ' + cmCommentBorder + '">' + this.escapeHtml(titleDisplay) + '</h3>';
                    }

                    // Comments list
                    preview += '<div style="display:flex;flex-direction:column;gap:' + cmGap + '">';

                    // Comment 1 - John Doe
                    preview += '<div style="' + cmCommentStyle + '">';
                    preview += '<div style="display:flex;gap:12px">';
                    if (cmShowAvatars) {
                        preview += '<div style="width:' + cmAvatarSize + ';height:' + cmAvatarSize + ';background:linear-gradient(135deg,#667eea,#764ba2);border-radius:' + cmAvatarRadius + ';flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff">JD</div>';
                    }
                    preview += '<div style="flex:1;min-width:0">';
                    preview += '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
                    preview += '<span style="font-weight:600;font-size:' + cmAuthorSize + ';color:' + cmAuthorColor + ';' + cmAuthorTypo + '">John Doe</span>';
                    if (cmShowDate) {
                        preview += '<span style="font-size:' + cmDateSize + ';color:' + cmDateColor + ';' + cmDateTypo + '">Dec 15, 2025</span>';
                    }
                    preview += '</div>';
                    preview += '<p style="margin:8px 0;font-size:' + cmTextSize + ';color:' + cmTextColor + ';line-height:1.5;' + cmTextTypo + '">This is a sample comment that demonstrates how comments will appear on your post. The styling adapts based on your design settings.</p>';
                    if (cmShowReplyButton) {
                        preview += '<button style="background:transparent;border:none;color:' + cmButtonBg + ';font-size:12px;cursor:pointer;padding:0;font-weight:500">↩ Reply</button>';
                    }
                    preview += '</div></div></div>';

                    // Comment 2 - Jane Smith with reply
                    preview += '<div style="' + cmCommentStyle + '">';
                    preview += '<div style="display:flex;gap:12px">';
                    if (cmShowAvatars) {
                        preview += '<div style="width:' + cmAvatarSize + ';height:' + cmAvatarSize + ';background:linear-gradient(135deg,#f59e0b,#ef4444);border-radius:' + cmAvatarRadius + ';flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff">JS</div>';
                    }
                    preview += '<div style="flex:1;min-width:0">';
                    preview += '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
                    preview += '<span style="font-weight:600;font-size:' + cmAuthorSize + ';color:' + cmAuthorColor + ';' + cmAuthorTypo + '">Jane Smith</span>';
                    if (cmShowDate) {
                        preview += '<span style="font-size:' + cmDateSize + ';color:' + cmDateColor + ';' + cmDateTypo + '">Dec 14, 2025</span>';
                    }
                    preview += '</div>';
                    preview += '<p style="margin:8px 0;font-size:' + cmTextSize + ';color:' + cmTextColor + ';line-height:1.5;' + cmTextTypo + '">Great article! I really enjoyed reading this and found it very helpful. Thanks for sharing!</p>';
                    if (cmShowReplyButton) {
                        preview += '<button style="background:transparent;border:none;color:' + cmButtonBg + ';font-size:12px;cursor:pointer;padding:0;font-weight:500">↩ Reply</button>';
                    }

                    // Nested reply from Admin
                    preview += '<div style="margin-top:16px;margin-left:' + cmReplyIndent + ';padding-left:16px;border-left:2px solid ' + cmCommentBorder + '">';
                    preview += '<div style="display:flex;gap:12px">';
                    if (cmShowAvatars) {
                        preview += '<div style="width:calc(' + cmAvatarSize + ' * 0.75);height:calc(' + cmAvatarSize + ' * 0.75);background:linear-gradient(135deg,#10b981,#059669);border-radius:' + cmAvatarRadius + ';flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff">A</div>';
                    }
                    preview += '<div style="flex:1;min-width:0">';
                    preview += '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
                    preview += '<span style="font-weight:600;font-size:calc(' + cmAuthorSize + ' * 0.9);color:' + cmAuthorColor + ';' + cmAuthorTypo + '">Admin</span>';
                    preview += '<span style="background:#10b981;color:#fff;font-size:10px;padding:2px 6px;border-radius:3px">Author</span>';
                    if (cmShowDate) {
                        preview += '<span style="font-size:' + cmDateSize + ';color:' + cmDateColor + ';' + cmDateTypo + '">Dec 14, 2025</span>';
                    }
                    preview += '</div>';
                    preview += '<p style="margin:8px 0;font-size:calc(' + cmTextSize + ' * 0.95);color:' + cmTextColor + ';line-height:1.5;' + cmTextTypo + '">Thank you for your kind words! I\'m glad you found it useful.</p>';
                    preview += '</div></div></div>';

                    preview += '</div></div></div>';

                    // Comment form (frontend: integrates with CMS comment system, includes CSRF token)
                    if (cmShowForm) {
                        preview += '<div style="margin-top:' + cmGap + ';background:' + cmFormBg + ';padding:20px;border-radius:8px;border:1px solid ' + cmCommentBorder + '">';
                        preview += '<form data-tb-comment-form>';
                        preview += '<h4 style="font-size:16px;font-weight:600;color:' + cmAuthorColor + ';margin:0 0 16px 0">' + this.escapeHtml(cmFormTitle) + '</h4>';

                        // CSRF token placeholder (rendered by frontend)
                        preview += '<!-- CSRF: <?php csrf_field(); ?> -->';

                        // Name and Email row
                        if (cmRequireNameEmail) {
                            preview += '<div style="display:flex;gap:12px;margin-bottom:12px">';
                            preview += '<input type="text" name="comment_author" placeholder="Name *" required style="flex:1;padding:10px 12px;background:' + cmInputBg + ';border:1px solid ' + cmInputBorder + ';border-radius:6px;font-size:14px;color:' + cmTextColor + '">';
                            preview += '<input type="email" name="comment_email" placeholder="Email *" required style="flex:1;padding:10px 12px;background:' + cmInputBg + ';border:1px solid ' + cmInputBorder + ';border-radius:6px;font-size:14px;color:' + cmTextColor + '">';
                            preview += '</div>';
                        }

                        // Comment textarea
                        preview += '<textarea name="comment_content" placeholder="Write your comment..." required style="width:100%;min-height:100px;padding:12px;background:' + cmInputBg + ';border:1px solid ' + cmInputBorder + ';border-radius:6px;font-size:14px;color:' + cmTextColor + ';resize:vertical;margin-bottom:12px;box-sizing:border-box"></textarea>';

                        // Hidden fields for frontend integration
                        preview += '<!-- Hidden: post_id, parent_id (for replies) -->';

                        // Submit button
                        preview += '<button type="submit" style="background:' + cmButtonBg + ';color:' + cmButtonText + ';border:none;padding:12px 24px;border-radius:6px;font-weight:600;font-size:14px;cursor:pointer">' + this.escapeHtml(cmSubmitText) + '</button>';

                        preview += '</form></div>';
                    }

                    // Info footer
                    preview += '<div style="margin-top:12px;font-size:10px;color:#94a3b8">💬 Comments • ' + cmStyle + ' style' + (cmShowForm ? ' • with form' : ' • list only') + (cmShowAvatars ? ' • avatars' : '') + '</div>';
                    preview += '</div>';
                    break;
                case 'icon':
                    const iconIcon = content.icon || '⭐';
                    const iconSize = content.size || '48px';
                    const iconColor = content.color || '#333333';
                    preview = '<div style="display:flex;align-items:center;justify-content:center;padding:20px">';
                    preview += '<div style="font-size:' + iconSize + ';color:' + iconColor + ';line-height:1">' + this.renderIconFromFormat(iconIcon) + '</div>';
                    preview += '</div>';
                    break;
                default:
                    preview = '<div style="color:#94a3b8;padding:16px;text-align:center;background:#f8fafc;border-radius:4px">' + icon + ' [' + type + ']</div>';
            }
            // Build module wrapper styles from settings
            let moduleStyles = '';

            // Per-side margin (Divi-style)
            if (settings.margin_top || settings.margin_right || settings.margin_bottom || settings.margin_left) {
                const mT = settings.margin_top || '0px';
                const mR = settings.margin_right || '0px';
                const mB = settings.margin_bottom || '0px';
                const mL = settings.margin_left || '0px';
                moduleStyles += 'margin:' + mT + ' ' + mR + ' ' + mB + ' ' + mL + ';';
            } else if (settings.margin) {
                // Fallback to legacy single margin value
                moduleStyles += 'margin:' + settings.margin + ';';
            }

            // Per-side padding (Divi-style)
            if (settings.padding_top || settings.padding_right || settings.padding_bottom || settings.padding_left) {
                const pT = settings.padding_top || '0px';
                const pR = settings.padding_right || '0px';
                const pB = settings.padding_bottom || '0px';
                const pL = settings.padding_left || '0px';
                moduleStyles += 'padding:' + pT + ' ' + pR + ' ' + pB + ' ' + pL + ';';
            } else if (settings.padding) {
                // Fallback to legacy single padding value
                moduleStyles += 'padding:' + settings.padding + ';';
            }

            if (settings.backgroundColor && settings.backgroundColor !== '#ffffff') moduleStyles += 'background-color:' + settings.backgroundColor + ';';
            if (settings.textAlign) moduleStyles += 'text-align:' + settings.textAlign + ';';

            // Per-side border width (Divi-style)
            if (settings.border_width_top || settings.border_width_right || settings.border_width_bottom || settings.border_width_left) {
                const bwT = settings.border_width_top || '0px';
                const bwR = settings.border_width_right || '0px';
                const bwB = settings.border_width_bottom || '0px';
                const bwL = settings.border_width_left || '0px';
                moduleStyles += 'border-width:' + bwT + ' ' + bwR + ' ' + bwB + ' ' + bwL + ';';
            } else if (settings.borderWidth) {
                // Fallback to legacy single border-width value
                moduleStyles += 'border-width:' + settings.borderWidth + ';';
            }

            // Border style
            if (settings.border_style && settings.border_style !== 'none') {
                moduleStyles += 'border-style:' + settings.border_style + ';';
            } else if (settings.borderWidth || settings.border_width_top || settings.border_width_right || settings.border_width_bottom || settings.border_width_left) {
                // Default to solid if width is set but no style specified
                moduleStyles += 'border-style:solid;';
            }

            // Border color
            if (settings.border_color) {
                moduleStyles += 'border-color:' + settings.border_color + ';';
            } else if (settings.borderColor) {
                // Fallback to legacy border color
                moduleStyles += 'border-color:' + settings.borderColor + ';';
            }

            // Per-corner border radius (Divi-style)
            if (settings.border_radius_tl || settings.border_radius_tr || settings.border_radius_br || settings.border_radius_bl) {
                const brTL = settings.border_radius_tl || '0px';
                const brTR = settings.border_radius_tr || '0px';
                const brBR = settings.border_radius_br || '0px';
                const brBL = settings.border_radius_bl || '0px';
                moduleStyles += 'border-radius:' + brTL + ' ' + brTR + ' ' + brBR + ' ' + brBL + ';';
            } else if (settings.borderRadius) {
                // Fallback to legacy single border-radius value
                moduleStyles += 'border-radius:' + settings.borderRadius + ';';
            }

            // Box shadow (Divi-style)
            if (settings.box_shadow_enabled) {
                const bsH = parseInt(settings.box_shadow_horizontal) || 0;
                const bsV = parseInt(settings.box_shadow_vertical) || 4;
                const bsBlur = parseInt(settings.box_shadow_blur) || 10;
                const bsSpread = parseInt(settings.box_shadow_spread) || 0;
                const bsColor = settings.box_shadow_color || 'rgba(0,0,0,0.1)';
                const bsInset = settings.box_shadow_inset ? 'inset ' : '';
                moduleStyles += 'box-shadow:' + bsInset + bsH + 'px ' + bsV + 'px ' + bsBlur + 'px ' + bsSpread + 'px ' + bsColor + ';';
            }

            // Transform (Divi-style)
            const transformParts = [];

            // Translate (applied first for proper transform order)
            const translateX = settings.transform_translate_x || '0';
            const translateY = settings.transform_translate_y || '0';
            if (translateX !== '0' && translateX !== '0px') {
                transformParts.push('translateX(' + (translateX.includes('px') ? translateX : translateX + 'px') + ')');
            }
            if (translateY !== '0' && translateY !== '0px') {
                transformParts.push('translateY(' + (translateY.includes('px') ? translateY : translateY + 'px') + ')');
            }

            // Rotate
            const rotateZ = settings.transform_rotate_z || '0';
            const rotateX = settings.transform_rotate_x || '0';
            const rotateY = settings.transform_rotate_y || '0';
            if (rotateZ !== '0' && rotateZ !== '0deg') {
                transformParts.push('rotateZ(' + (rotateZ.includes('deg') ? rotateZ : rotateZ + 'deg') + ')');
            }
            if (rotateX !== '0' && rotateX !== '0deg') {
                transformParts.push('rotateX(' + (rotateX.includes('deg') ? rotateX : rotateX + 'deg') + ')');
            }
            if (rotateY !== '0' && rotateY !== '0deg') {
                transformParts.push('rotateY(' + (rotateY.includes('deg') ? rotateY : rotateY + 'deg') + ')');
            }

            // Scale
            const scaleX = settings.transform_scale_x || '100';
            const scaleY = settings.transform_scale_y || '100';
            const scaleXVal = parseFloat(scaleX.replace('%', '')) / 100;
            const scaleYVal = parseFloat(scaleY.replace('%', '')) / 100;
            if (scaleXVal !== 1 || scaleYVal !== 1) {
                if (scaleXVal === scaleYVal) {
                    transformParts.push('scale(' + scaleXVal + ')');
                } else {
                    transformParts.push('scale(' + scaleXVal + ',' + scaleYVal + ')');
                }
            }

            // Skew
            const skewX = settings.transform_skew_x || '0';
            const skewY = settings.transform_skew_y || '0';
            if (skewX !== '0' && skewX !== '0deg') {
                transformParts.push('skewX(' + (skewX.includes('deg') ? skewX : skewX + 'deg') + ')');
            }
            if (skewY !== '0' && skewY !== '0deg') {
                transformParts.push('skewY(' + (skewY.includes('deg') ? skewY : skewY + 'deg') + ')');
            }

            // Apply transform if any parts exist
            if (transformParts.length > 0) {
                moduleStyles += 'transform:' + transformParts.join(' ') + ';';
            }

            // Transform origin
            const transformOrigin = settings.transform_origin || 'center center';
            if (transformOrigin !== 'center center') {
                moduleStyles += 'transform-origin:' + transformOrigin + ';';
            }

            // Perspective for 3D transforms
            if ((rotateX !== '0' && rotateX !== '0deg') || (rotateY !== '0' && rotateY !== '0deg')) {
                moduleStyles += 'perspective:1000px;';
            }

            // CSS Filters (Divi-style)
            const filterCSS = this.getFilterCSS(settings);
            if (filterCSS && filterCSS !== 'none') {
                moduleStyles += 'filter:' + filterCSS + ';';
            }

            // Position (Divi-style)
            const positionCSS = this.getPositionCSS(settings);
            if (positionCSS) {
                moduleStyles += positionCSS;
            }

            // Apply typography styles to preview content
            const previewStyles = typoStyles ? 'style="' + typoStyles + '"' : '';
            const wrappedPreview = typoStyles ? '<div ' + previewStyles + '>' + preview + '</div>' : preview;

            // Generate unique module ID for CSS hover targeting
            const moduleId = 'tb-mod-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx;
            const hasHover = settings.hover_enabled ? ' tb-has-hover' : '';

            // Check if module has active filters
            const hasFilters = this.hasActiveFilters(settings);

            // Check if module has non-static position
            const hasPosition = this.hasNonStaticPosition(settings);
            const positionType = settings.position || 'static';
            const positionClasses = hasPosition ? ' tb-positioned tb-position-' + positionType : '';

            // Check if module has animation enabled
            const hasAnimation = this.hasAnimationEnabled(settings);
            const animationClasses = hasAnimation ? ' tb-has-animation' : '';

            // Build badges HTML
            let badgesHtml = '';
            if (settings.hover_enabled) badgesHtml += '<span class="tb-hover-badge" title="Has hover effects">👆</span>';
            if (hasFilters) badgesHtml += '<span class="tb-filter-badge" title="Has CSS filters">🎨</span>';
            if (hasPosition) badgesHtml += '<span class="tb-position-badge" title="Position: ' + positionType + '">📍</span>';
            if (hasAnimation) badgesHtml += '<span class="tb-animation-badge" title="Has entrance animation: ' + (settings.animation_type || 'fadeIn') + '">✨</span>';

            // Build z-index badge (if z-index is set and not auto)
            let zIndexBadge = '';
            if (settings.z_index && settings.z_index !== 'auto') {
                zIndexBadge = '<span class="tb-zindex-badge" title="Z-Index: ' + settings.z_index + '">' + settings.z_index + '</span>';
            }

            return '<div class="tb-module ' + moduleId + hasHover + positionClasses + animationClasses + '" draggable="true" data-module-id="' + moduleId + '" data-module-idx="' + mIdx + '" data-module-type="' + type + '" data-path="' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + '" data-module-coords="' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" data-section-idx="' + sIdx + '" data-row-idx="' + rIdx + '" data-col-idx="' + cIdx + '" onclick="TB.selectModule(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', event)" ondragstart="TB.handleModuleDragStart(event, ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')" ondragend="TB.handleModuleDragEnd(event)">' + zIndexBadge + '<div class="tb-module-header"><span class="tb-module-type-icon">' + icon + '</span><span class="tb-module-type-label">' + type + '</span>' + badgesHtml + '<div class="tb-module-actions"><button type="button" class="tb-module-action-btn" onclick="TB.duplicateModule(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + '); event.stopPropagation();" title="Duplicate">⧉</button><button type="button" class="tb-module-action-btn danger" onclick="TB.removeModule(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + '); event.stopPropagation();" title="Delete">×</button></div></div><div class="tb-module-preview" style="' + moduleStyles + '">' + wrappedPreview + '</div></div>';
        },

        bindModulePanelDrag() {
            const panel = document.getElementById('modules-panel');
            if (!panel) return;

            // Remove old listeners by cloning (clean slate)
            if (!panel.dataset.dragBound) {
                panel.dataset.dragBound = 'true';

                panel.addEventListener('dragstart', (e) => {
                    const item = e.target.closest('.tb-module-item');
                    if (!item) return;
                    this.draggedModule = item.dataset.module;
                    this.draggedElement = null;
                    e.dataTransfer.setData('text/plain', item.dataset.module);
                    e.dataTransfer.effectAllowed = 'copy';
                    item.classList.add('dragging');
                    document.querySelectorAll('.tb-column').forEach(col => col.classList.add('tb-drop-target'));
                    document.querySelectorAll('.tb-drop-zone').forEach(zone => zone.classList.add('tb-drop-target'));
                });

                panel.addEventListener('dragend', (e) => {
                    const item = e.target.closest('.tb-module-item');
                    if (item) item.classList.remove('dragging');
                    // Don't clear draggedModule here - let drop handler do it
                    // Only clear highlights after a short delay to allow drop to complete
                    setTimeout(() => {
                        this.draggedModule = null;
                        this.clearDropHighlights();
                    }, 100);
                });
            }
        },

        bindCanvasDragEvents() {},

        handleModuleDragStart(e, sIdx, rIdx, cIdx, mIdx) {
            this.draggedElement = { sIdx, rIdx, cIdx, mIdx };
            this.draggedModule = null;
            e.dataTransfer.setData('application/json', JSON.stringify({ sIdx, rIdx, cIdx, mIdx }));
            e.dataTransfer.effectAllowed = 'move';
            e.target.classList.add('tb-dragging');
            setTimeout(() => {
                document.querySelectorAll('.tb-column').forEach(col => col.classList.add('tb-drop-target'));
            }, 0);
        },

        handleModuleDragEnd(e) {
            e.target.classList.remove('tb-dragging');
            this.draggedElement = null;
            this.clearDropHighlights();
        },

        handleColumnDragOver(e, sIdx, rIdx, cIdx) {
            e.preventDefault();
            e.dataTransfer.dropEffect = this.draggedModule ? 'copy' : 'move';
            const column = e.currentTarget;
            column.classList.add('tb-drag-over');
            const modules = column.querySelectorAll('.tb-module');
            const insertionLines = column.querySelectorAll('.tb-insertion-line');
            insertionLines.forEach(line => line.style.display = 'none');
            if (modules.length === 0) {
                const topLine = column.querySelector('.tb-insertion-top');
                if (topLine) topLine.style.display = 'block';
                this.insertionIndex = 0;
                return;
            }
            const mouseY = e.clientY;
            let insertIdx = modules.length;
            for (let i = 0; i < modules.length; i++) {
                const modRect = modules[i].getBoundingClientRect();
                if (mouseY < modRect.top + modRect.height / 2) { insertIdx = i; break; }
            }
            const lineToShow = column.querySelector('.tb-insertion-line[data-insert-idx="' + insertIdx + '"]');
            if (lineToShow) lineToShow.style.display = 'block';
            this.insertionIndex = insertIdx;
            this.dragOverColumn = { sIdx, rIdx, cIdx };
        },

        handleColumnDragLeave(e) {
            const column = e.currentTarget;
            if (!column.contains(e.relatedTarget)) {
                column.classList.remove('tb-drag-over');
                column.querySelectorAll('.tb-insertion-line').forEach(line => line.style.display = 'none');
            }
        },

        handleColumnDrop(e, sIdx, rIdx, cIdx) {
            console.log('handleColumnDrop called:', { sIdx, rIdx, cIdx, draggedModule: this.draggedModule });
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('tb-drag-over');
            const insertIdx = this.insertionIndex >= 0 ? this.insertionIndex : (this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules?.length || 0);
            console.log('Column structure:', this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]);
            if (this.draggedModule) {
                console.log('Adding module:', this.draggedModule);
                this.addModuleToColumn(sIdx, rIdx, cIdx, this.draggedModule, insertIdx);
            } else if (this.draggedElement) {
                const from = this.draggedElement;
                if (from.sIdx === sIdx && from.rIdx === rIdx && from.cIdx === cIdx) {
                    let targetIdx = insertIdx;
                    if (from.mIdx < insertIdx) targetIdx--;
                    if (from.mIdx !== targetIdx) this.reorderModuleInColumn(sIdx, rIdx, cIdx, from.mIdx, targetIdx);
                } else {
                    this.moveModuleToColumn(from, { sIdx, rIdx, cIdx, insertIdx });
                }
            }
            this.clearDropHighlights();
            this.draggedModule = null;
            this.draggedElement = null;
            this.insertionIndex = -1;
        },

        handleMainDropZoneDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = this.draggedModule ? 'copy' : 'move';
            e.currentTarget.classList.add('drag-over');
        },

        handleMainDropZoneDragLeave(e) { e.currentTarget.classList.remove('drag-over'); },

        handleMainDropZoneDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            if (this.draggedModule) this.addSectionWithModule(this.draggedModule);
            else if (this.draggedElement) this.addSectionWithExistingModule(this.draggedElement);
            this.clearDropHighlights();
            this.draggedModule = null;
            this.draggedElement = null;
        },

        clearDropHighlights() {
            document.querySelectorAll('.tb-column').forEach(col => col.classList.remove('tb-drop-target', 'tb-drag-over'));
            document.querySelectorAll('.tb-drop-zone').forEach(zone => zone.classList.remove('tb-drop-target', 'drag-over'));
            document.querySelectorAll('.tb-insertion-line').forEach(line => line.style.display = 'none');
            document.querySelectorAll('.tb-module').forEach(mod => mod.classList.remove('tb-dragging'));
        },

        addModuleToColumn(sectionIdx, rowIdx, colIdx, moduleType, insertIdx = null) {
            const column = this.content.sections[sectionIdx]?.rows[rowIdx]?.columns[colIdx];
            if (!column) return;
            if (!column.modules) column.modules = [];
            const newModule = { id: 'mod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9), type: moduleType, content: this.getDefaultContent(moduleType), settings: {} };
            if (insertIdx !== null && insertIdx >= 0 && insertIdx <= column.modules.length) column.modules.splice(insertIdx, 0, newModule);
            else column.modules.push(newModule);
            this.saveToHistory();
            this.renderCanvas();
            const newMIdx = insertIdx !== null ? insertIdx : column.modules.length - 1;
            this.selectModule(sectionIdx, rowIdx, colIdx, newMIdx);
            this.showToast('Added ' + moduleType + ' module', 'success');
        },

        removeModule(sectionIdx, rowIdx, colIdx, moduleIdx) {
            const modules = this.content.sections[sectionIdx]?.rows[rowIdx]?.columns[colIdx]?.modules;
            if (!modules || !modules[moduleIdx]) return;
            modules.splice(moduleIdx, 1);
            this.selectedElement = null;
            this.saveToHistory();
            this.renderCanvas();
            this.renderSettings();
            this.showToast('Module removed', 'success');
        },

        duplicateModule(sectionIdx, rowIdx, colIdx, moduleIdx) {
            const modules = this.content.sections[sectionIdx]?.rows[rowIdx]?.columns[colIdx]?.modules;
            if (!modules || !modules[moduleIdx]) return;
            const duplicate = JSON.parse(JSON.stringify(modules[moduleIdx]));
            duplicate.id = 'mod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            modules.splice(moduleIdx + 1, 0, duplicate);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sectionIdx, rowIdx, colIdx, moduleIdx + 1);
            this.showToast('Module duplicated', 'success');
        },

        reorderModuleInColumn(sectionIdx, rowIdx, colIdx, fromIdx, toIdx) {
            const modules = this.content.sections[sectionIdx]?.rows[rowIdx]?.columns[colIdx]?.modules;
            if (!modules) return;
            const [module] = modules.splice(fromIdx, 1);
            modules.splice(toIdx, 0, module);
            this.saveToHistory();
            this.renderCanvas();
        },

        moveModuleToColumn(fromPath, toPath) {
            const fromModules = this.content.sections[fromPath.sIdx]?.rows[fromPath.rIdx]?.columns[fromPath.cIdx]?.modules;
            const toColumn = this.content.sections[toPath.sIdx]?.rows[toPath.rIdx]?.columns[toPath.cIdx];
            if (!fromModules || !toColumn) return;
            const [module] = fromModules.splice(fromPath.mIdx, 1);
            if (!toColumn.modules) toColumn.modules = [];
            toColumn.modules.splice(toPath.insertIdx !== undefined ? toPath.insertIdx : toColumn.modules.length, 0, module);
            this.saveToHistory();
            this.renderCanvas();
            this.showToast('Module moved', 'success');
        },

        getDefaultContent(moduleType) {
            const defaults = {
                text: { text: '' },
                heading: { text: 'New Heading', tag: 'h2' },
                image: { src: '', alt: '' },
                button: { text: 'Click Me', url: '#', style: 'primary' },
                logo: { image: '', image_alt: 'Site Logo', link_url: '/', link_target: '_self', max_height: '60px', use_site_logo: true },
                menu: { menu_source: 'cms_menu', cms_menu_id: 1, items: [], orientation: 'horizontal', alignment: 'center', gap: '24px' },
                divider: { style: 'solid', color: '#e2e8f0' },
                spacer: { height: '40px' },
                video: { url: '', autoplay: false, controls: true },
                code: { code: '', language: 'javascript' },
                html: { html: '' },
                quote: { text: '', author: '', source: '' },
                list: { items: ['Item 1', 'Item 2', 'Item 3'], type: 'unordered', icon: 'bullet' },
                icon: { icon: '⭐', size: '48px', color: '#333333' },
                map: { address: '', lat: 0, lng: 0, zoom: 14, height: '300px' },
                accordion: { items: [{ title: 'Accordion Item 1', content: 'Content goes here...' }], style: 'default' },
                toggle: { title: 'Click to expand', content: 'Hidden content goes here...', open_by_default: false, icon_position: 'right', icon_open: '+', icon_close: '−', title_background: '#f8fafc', title_color: '#1e293b', content_background: '#ffffff', border_color: '#e2e8f0', border_radius: '8px' },
                tabs: { tabs: [{ title: 'Tab 1', content: 'Tab content goes here...' }], style: 'default' },
                gallery: { images: [], columns: 3, gap: '10px', lightbox: true },
                testimonial: { text: '', author: '', role: '', avatar: '', style: 'card' },
                cta: { title: '', subtitle: '', button_text: 'Get Started', button_url: '#', style: 'centered' },
                pricing: { title: 'Basic', price: '$9', period: '/month', features: ['Feature 1', 'Feature 2'], button_text: 'Choose Plan', button_url: '#', highlighted: false },
                blurb: { icon: 'star', use_image: false, image: '', title: 'Your Title Here', text: 'Your description text goes here.', url: '', icon_size: '64px', icon_color: '#0073e6', layout: 'top', alignment: 'center' },
                hero: { title: 'Welcome to Our Site', subtitle: 'We build amazing digital experiences', primary_button_text: 'Get Started', primary_button_url: '#', secondary_button_text: 'Learn More', secondary_button_url: '#', show_secondary: true, background_type: 'color', background_color: '#1e1e2e', gradient_start: '#667eea', gradient_end: '#764ba2', overlay_color: 'rgba(0,0,0,0.5)', min_height: '600px', text_color: '#ffffff', alignment: 'center', content_width: '800px' },
                slider: { slides: [{ title: 'Slide 1', text: 'Description for slide 1', image: '', button_text: 'Learn More', button_url: '#' }], autoplay: true, autoplay_speed: 5000, show_arrows: true, show_dots: true, animation: 'slide', min_height: '400px' },
                blog: { posts_count: 6, category: '', show_excerpt: true, excerpt_length: 150, show_date: true, show_author: true, show_image: true, columns: 3, gap: '30px', card_style: 'card' },
                team: { name: 'John Doe', role: 'CEO & Founder', bio: 'A short biography about this team member.', image: '', social: [{ platform: 'linkedin', url: '' }, { platform: 'twitter', url: '' }], style: 'card', image_size: '200px', alignment: 'center' },
                countdown: { target_date: '', title: 'Event Starts In', expired_message: 'Event has started!', style: 'boxes', show_days: true, show_hours: true, show_minutes: true, show_seconds: true, number_size: '48px', label_size: '14px' },
                counter: { number: 100, prefix: '', suffix: '+', title: 'Happy Clients', number_size: '64px', number_color: '#0073e6', title_size: '18px', animation_duration: 2000, alignment: 'center' },
                bar_counters: { bars: [{ label: 'HTML/CSS', percent: 90, color: '#0073e6' }, { label: 'JavaScript', percent: 85, color: '#f59e0b' }, { label: 'PHP', percent: 80, color: '#8b5cf6' }], bar_height: '20px', bar_background: '#e2e8f0', bar_border_radius: '10px', show_percent: true, percent_position: 'inside', label_color: '#1e293b', label_size: '14px', gap: '16px', animate: true, animation_duration: '1.5s' },
                login: { title: 'Login', username_label: 'Username or Email', username_placeholder: 'Enter your username or email', password_label: 'Password', password_placeholder: 'Enter your password', submit_text: 'Log In', show_remember: true, remember_label: 'Remember Me', show_forgot: true, forgot_text: 'Forgot Password?', forgot_url: '/forgot-password', redirect_url: '/dashboard', show_register: true, register_text: 'Create an Account', register_url: '/register', style: 'default', background_color: '#ffffff', input_background: '#f8fafc', input_border_color: '#e2e8f0', input_text_color: '#1e293b', button_background: '#0073e6', button_text_color: '#ffffff', label_color: '#374151', link_color: '#0073e6', border_radius: '8px' },
                search: { placeholder: 'Search...', button_text: 'Search', show_button: true, button_icon_only: false, search_scope: 'all', results_page: '/search', style: 'default', layout: 'inline', input_background: '#ffffff', input_border_color: '#e2e8f0', input_text_color: '#1e293b', input_icon_color: '#94a3b8', button_background: '#0073e6', button_text_color: '#ffffff', button_position: 'right', height: '48px', border_radius: '8px', show_icon: true },
                portfolio: { items: [{ title: 'Project One', category: 'Web Design', image: '', link: '#', description: 'Project description...' }, { title: 'Project Two', category: 'Branding', image: '', link: '#', description: 'Project description...' }, { title: 'Project Three', category: 'Web Design', image: '', link: '#', description: 'Project description...' }, { title: 'Project Four', category: 'Photography', image: '', link: '#', description: 'Project description...' }], show_filters: true, filter_all_text: 'All', layout: 'grid', columns: 3, columns_tablet: 2, columns_mobile: 1, gap: '20px', hover_effect: 'fade', show_title: true, show_category: true, show_description: false, overlay_color: 'rgba(0, 0, 0, 0.7)', title_color: '#ffffff', category_color: '#94a3b8', filter_style: 'buttons', filter_active_color: '#0073e6', border_radius: '8px', aspect_ratio: '4:3' },
                video_slider: { videos: [{ title: 'Video One', url: '', thumbnail: '', description: '' }, { title: 'Video Two', url: '', thumbnail: '', description: '' }], layout: 'slider', columns: 3, show_thumbnails: true, thumbnail_position: 'bottom', show_title: true, show_description: false, autoplay_slider: false, slider_speed: 5000, show_arrows: true, show_dots: true, play_icon_color: '#ffffff', play_icon_size: '64px', overlay_color: 'rgba(0,0,0,0.3)', aspect_ratio: '16:9', border_radius: '8px', gap: '16px' },
                post_title: { show_title: true, show_meta: true, show_author: true, show_date: true, show_categories: true, show_comments_count: true, show_featured_image: true, featured_image_placement: 'background', date_format: 'M d, Y', title_level: 'h1', title_size: '42px', title_color: '#1e293b', meta_color: '#64748b', meta_size: '14px', meta_separator: '|', text_alignment: 'left', background_overlay: 'rgba(0,0,0,0.5)', text_on_image_color: '#ffffff', min_height: '400px', content_width: '100%', padding_top: '60px', padding_bottom: '60px' },
                post_content: { max_width: '800px', text_color: '#1e293b', font_size: '18px', line_height: '1.8', paragraph_spacing: '1.5em', heading_color: '#0f172a', link_color: '#0073e6', link_hover_color: '#0056b3', image_border_radius: '8px', blockquote_style: 'border', blockquote_border_color: '#0073e6', code_background: '#f1f5f9', code_text_color: '#e11d48', list_style: 'disc', dropcap: false, dropcap_color: '#0073e6' },
                posts_navigation: { prev_label: 'Previous Post', next_label: 'Next Post', show_title: true, show_thumbnail: true, same_category: false, show_arrows: true, style: 'default', layout: 'split', thumbnail_size: '80px', thumbnail_radius: '8px', background_color: '#f8fafc', hover_background: '#f1f5f9', label_color: '#64748b', label_size: '12px', title_color: '#1e293b', title_size: '16px', title_hover_color: '#0073e6', arrow_color: '#94a3b8', border_color: '#e2e8f0', padding: '20px', gap: '24px' },
                comments: { title: 'Comments', show_title: true, show_count_in_title: true, show_avatars: true, avatar_size: '48px', show_reply_button: true, show_date: true, date_format: 'M d, Y', form_title: 'Leave a Comment', show_form: true, require_name_email: true, submit_text: 'Post Comment', style: 'default', background_color: '#ffffff', comment_background: '#f8fafc', comment_border_color: '#e2e8f0', author_color: '#1e293b', author_size: '16px', date_color: '#64748b', date_size: '12px', text_color: '#374151', text_size: '14px', reply_indent: '40px', avatar_radius: '50%', form_background: '#f8fafc', input_background: '#ffffff', input_border_color: '#e2e8f0', button_background: '#0073e6', button_text_color: '#ffffff', gap: '20px' },
                fullwidth_code: { code: '// Your code here', language: 'javascript' },
                fullwidth_image: { src: '', alt: '', link: '' },
                fullwidth_map: { address: '', zoom: 14 },
                fullwidth_menu: { logo: '', items: [{ label: 'Home', url: '/' }, { label: 'About', url: '/about' }, { label: 'Contact', url: '/contact' }] },
                fullwidth_slider: { slides: [{ title: 'Slide 1', text: 'Description', image: '', button_text: 'Learn More', button_url: '#' }], autoplay: true, show_arrows: true, show_dots: true },
                fullwidth_header: { title: 'Welcome', subtitle: 'Your subtitle here', button_text: 'Get Started', button_url: '#', background_image: '' },
                fullwidth_portfolio: { items: [{ title: 'Project 1', category: 'Design', image: '', link: '#' }], show_filter: true },
                fullwidth_post_slider: { posts_count: 5, show_excerpt: true, show_date: true, show_author: true },
                post_slider: { posts_count: 5, show_excerpt: true, show_date: true, show_author: true, autoplay: true, autoplay_speed: 5000, show_arrows: true, show_dots: true, height: '400px' },
                social: { networks: [{ network: 'facebook', url: '#', enabled: true }, { network: 'twitter', url: '#', enabled: true }, { network: 'instagram', url: '#', enabled: true }], url_new_window: true, show_follow_button: false, icon_size: '40px', icon_color: '', icon_shape: 'circle', gap: '12px', alignment: 'center', background_style: 'filled' }
            };
            return defaults[moduleType] || {};
        },

        addSectionWithModule(moduleType) {
            if (!this.content.sections) this.content.sections = [];
            const newModule = { id: 'mod_' + Date.now(), type: moduleType, content: this.getDefaultContent(moduleType), settings: {} };
            this.content.sections.push({ id: 'sec_' + Date.now(), settings: {}, rows: [{ id: 'row_' + Date.now(), columns: [{ id: 'col_' + Date.now(), modules: [newModule] }] }] });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(this.content.sections.length - 1, 0, 0, 0);
            this.showToast('Section created with module', 'success');
        },

        addSectionWithExistingModule(fromPath) {
            const fromModules = this.content.sections[fromPath.sIdx]?.rows[fromPath.rIdx]?.columns[fromPath.cIdx]?.modules;
            if (!fromModules) return;
            const [module] = fromModules.splice(fromPath.mIdx, 1);
            if (!this.content.sections) this.content.sections = [];
            this.content.sections.push({ id: 'sec_' + Date.now(), settings: {}, rows: [{ id: 'row_' + Date.now(), columns: [{ id: 'col_' + Date.now(), modules: [module] }] }] });
            this.saveToHistory();
            this.renderCanvas();
            this.showToast('Module moved to new section', 'success');
        },

        bindEvents() {
            document.getElementById('btn-save').addEventListener('click', () => this.save());
            document.getElementById('btn-add-section').addEventListener('click', () => this.addSection());
            document.getElementById('btn-preview').addEventListener('click', () => this.preview());
            document.getElementById('btn-load-library').addEventListener('click', () => this.openLibrary());
            // Viewport buttons - sync with responsive device toggle
            document.querySelectorAll('.tb-viewport-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const viewport = btn.dataset.viewport;
                    // Use setDevice to sync both viewport and device toggle
                    this.setDevice(viewport);
                });
            });
            document.querySelectorAll('.tb-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tb-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    this.currentTab = tab.dataset.tab;
                    if (this.selectedElement) this.renderSettings(this.currentTab);
                });
            });
            document.getElementById('module-search').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('.tb-module-item').forEach(item => {
                    const name = item.querySelector('.tb-module-name').textContent.toLowerCase();
                    item.style.display = name.includes(query) || item.dataset.module.toLowerCase().includes(query) ? '' : 'none';
                });
                document.querySelectorAll('.tb-module-category').forEach(cat => {
                    cat.style.display = cat.querySelectorAll('.tb-module-item[style=""],.tb-module-item:not([style])').length > 0 ? '' : 'none';
                });
            });
            document.getElementById('btn-undo').addEventListener('click', () => this.undo());
            document.getElementById('btn-redo').addEventListener('click', () => this.redo());
            document.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 's') { e.preventDefault(); this.save(); }
                if ((e.metaKey || e.ctrlKey) && e.key === 'z') { e.preventDefault(); e.shiftKey ? this.redo() : this.undo(); }
                if ((e.key === 'Delete' || e.key === 'Backspace') && this.selectedElement && !['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
                    e.preventDefault();
                    const { sIdx, rIdx, cIdx, mIdx } = this.selectedElement;
                    this.removeModule(sIdx, rIdx, cIdx, mIdx);
                }
                if (e.key === 'Escape') {
                    this.selectedElement = null;
                    document.querySelectorAll('.tb-module').forEach(m => m.classList.remove('selected'));
                    this.renderSettings();
                }
            });
            document.getElementById('canvas-inner').addEventListener('click', (e) => {
                if (e.target.id === 'canvas-inner' || e.target.classList.contains('tb-section') || e.target.classList.contains('tb-row')) {
                    this.selectedElement = null;
                    document.querySelectorAll('.tb-module').forEach(m => m.classList.remove('selected'));
                    this.renderSettings();
                }
            });
        },

        bindDragDropEvents() { this.bindModulePanelDrag(); },

        // ═══════════════════════════════════════════════════════════
        // RESPONSIVE DEVICE SYSTEM (Divi-style)
        // ═══════════════════════════════════════════════════════════

        // Set the current editing device and sync with canvas viewport
        setDevice(device) {
            if (!['desktop', 'tablet', 'mobile'].includes(device)) return;
            this.currentDevice = device;

            // Update device toggle buttons
            document.querySelectorAll('.tb-device-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.device === device);
            });

            // Sync with canvas viewport buttons
            document.querySelectorAll('.tb-viewport-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.viewport === device);
            });
            document.getElementById('canvas-inner').className = 'tb-canvas-inner ' + device;

            // Re-render settings panel to show values for current device
            this.renderSettings();
        },

        // Get device icon for display
        getDeviceIcon(device) {
            const icons = { desktop: '🖥️', tablet: '📱', mobile: '📲' };
            return icons[device] || '🖥️';
        },

        // Get the property key for current device (adds suffix for tablet/mobile)
        getResponsivePropertyKey(property) {
            if (this.currentDevice === 'desktop') return property;
            return property + '_' + this.currentDevice;
        },

        // Get value for a responsive property based on current device
        // Falls back to desktop value if tablet/mobile not set (inheritance)
        getResponsiveValue(settings, property) {
            if (!settings) return '';
            if (this.currentDevice === 'desktop') {
                return settings[property] || '';
            }
            const deviceKey = property + '_' + this.currentDevice;
            const deviceValue = settings[deviceKey];
            // If device-specific value exists and is not empty, use it
            if (deviceValue !== undefined && deviceValue !== '') {
                return deviceValue;
            }
            // Otherwise inherit from desktop
            return settings[property] || '';
        },

        // Get the actual stored value for current device (not inherited)
        getDeviceSpecificValue(settings, property) {
            if (!settings) return '';
            if (this.currentDevice === 'desktop') {
                return settings[property] || '';
            }
            const deviceKey = property + '_' + this.currentDevice;
            return settings[deviceKey] || '';
        },

        // Check if a property has a custom value for tablet or mobile
        hasResponsiveValues(settings, property) {
            if (!settings) return false;
            const tabletKey = property + '_tablet';
            const mobileKey = property + '_mobile';
            const hasTablet = settings[tabletKey] !== undefined && settings[tabletKey] !== '';
            const hasMobile = settings[mobileKey] !== undefined && settings[mobileKey] !== '';
            return hasTablet || hasMobile;
        },

        // Check if current device has a custom value (not inherited)
        hasCustomValueForDevice(settings, property) {
            if (!settings) return false;
            if (this.currentDevice === 'desktop') {
                return settings[property] !== undefined && settings[property] !== '';
            }
            const deviceKey = property + '_' + this.currentDevice;
            return settings[deviceKey] !== undefined && settings[deviceKey] !== '';
        },

        // Update a responsive property value for the current device
        updateResponsiveValue(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            const key = this.getResponsivePropertyKey(property);
            mod.settings[key] = value;

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Update responsive typography value
        updateResponsiveTypography(sIdx, rIdx, cIdx, mIdx, element, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};
            const typoKey = 'typography_' + element;
            if (!mod.settings[typoKey]) mod.settings[typoKey] = {};

            const key = this.getResponsivePropertyKey(property);
            mod.settings[typoKey][key] = value;

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Update responsive typography value with unit
        updateResponsiveTypographyWithUnit(sIdx, rIdx, cIdx, mIdx, element, property, value, unit) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};
            const typoKey = 'typography_' + element;
            if (!mod.settings[typoKey]) mod.settings[typoKey] = {};

            const key = this.getResponsivePropertyKey(property);
            if (value === '' || value === null || value === undefined) {
                mod.settings[typoKey][key] = '';
            } else {
                mod.settings[typoKey][key] = value + (unit || '');
            }

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Update responsive spacing value
        updateResponsiveSpacing(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            const key = this.getResponsivePropertyKey(property);

            // Ensure value has px unit if numeric
            if (value !== '' && value !== null && value !== undefined) {
                const numVal = parseFloat(value);
                if (!isNaN(numVal) && !String(value).includes('px')) {
                    value = numVal + 'px';
                }
            }

            mod.settings[key] = value || '0px';
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Handle responsive spacing change with link support
        handleResponsiveSpacingChange(sIdx, rIdx, cIdx, mIdx, type, side, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            const suffix = this.currentDevice === 'desktop' ? '' : '_' + this.currentDevice;
            const linkKey = type + '_linked' + suffix;
            const isLinked = mod.settings[linkKey] || false;

            // Ensure value has px unit
            if (value !== '' && value !== null && value !== undefined) {
                const numVal = parseFloat(value);
                if (!isNaN(numVal) && !String(value).includes('px')) {
                    value = numVal + 'px';
                }
            }

            if (isLinked) {
                // Update all sides
                ['top', 'right', 'bottom', 'left'].forEach(s => {
                    const key = type + '_' + s + suffix;
                    mod.settings[key] = value || '0px';
                });
            } else {
                const key = type + '_' + side + suffix;
                mod.settings[key] = value || '0px';
            }

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Toggle responsive spacing link
        toggleResponsiveSpacingLink(sIdx, rIdx, cIdx, mIdx, type) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            const suffix = this.currentDevice === 'desktop' ? '' : '_' + this.currentDevice;
            const linkKey = type + '_linked' + suffix;
            mod.settings[linkKey] = !mod.settings[linkKey];

            // If linking, sync all values to the top value
            if (mod.settings[linkKey]) {
                const topKey = type + '_top' + suffix;
                const topValue = mod.settings[topKey] || '0px';
                ['right', 'bottom', 'left'].forEach(side => {
                    mod.settings[type + '_' + side + suffix] = topValue;
                });
            }

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Get responsive spacing value
        getResponsiveSpacingValue(settings, type, side) {
            if (!settings) return 0;
            const suffix = this.currentDevice === 'desktop' ? '' : '_' + this.currentDevice;
            const key = type + '_' + side + suffix;
            const deviceValue = settings[key];

            // If device-specific value exists, use it
            if (deviceValue !== undefined && deviceValue !== '') {
                return parseInt(deviceValue) || 0;
            }

            // Otherwise inherit from desktop
            if (this.currentDevice !== 'desktop') {
                const desktopKey = type + '_' + side;
                return parseInt(settings[desktopKey]) || 0;
            }

            return 0;
        },

        // Check if responsive spacing is linked
        isResponsiveSpacingLinked(settings, type) {
            if (!settings) return false;
            const suffix = this.currentDevice === 'desktop' ? '' : '_' + this.currentDevice;
            return settings[type + '_linked' + suffix] || false;
        },

        addSection() {
            if (!this.content.sections) this.content.sections = [];
            this.content.sections.push({ id: 'sec_' + Date.now(), settings: {}, rows: [{ id: 'row_' + Date.now(), columns: [{ id: 'col_' + Date.now(), modules: [] }] }] });
            this.saveToHistory();
            this.renderCanvas();
            this.showToast('Section added', 'success');
        },

        addRow(sectionIdx) {
            const section = this.content.sections[sectionIdx];
            if (!section.rows) section.rows = [];
            section.rows.push({ id: 'row_' + Date.now(), columns: [{ id: 'col_' + Date.now(), modules: [] }] });
            this.saveToHistory();
            this.renderCanvas();
        },

        addColumn(sectionIdx, rowIdx) {
            const row = this.content.sections[sectionIdx]?.rows[rowIdx];
            if (!row) return;
            if (!row.columns) row.columns = [];
            row.columns.push({ id: 'col_' + Date.now(), modules: [] });
            this.saveToHistory();
            this.renderCanvas();
        },

        deleteSection(idx) {
            if (confirm('Delete this section and all its content?')) {
                this.content.sections.splice(idx, 1);
                this.selectedElement = null;
                this.saveToHistory();
                this.renderCanvas();
                this.renderSettings();
                this.showToast('Section deleted', 'success');
            }
        },

        deleteRow(sectionIdx, rowIdx) {
            const section = this.content.sections[sectionIdx];
            if (!section || !section.rows) {
                return;
            }
            if (section.rows.length <= 1) {
                if (!confirm('Delete the last row? This will leave the section empty.')) {
                    return;
                }
            }
            const removed = section.rows.splice(rowIdx, 1);
            if (section.rows.length === 0) {
                // Add back an empty row if all rows are deleted
                section.rows.push({ id: 'row_' + Date.now(), columns: [{ id: 'col_' + Date.now(), width: '100%', modules: [] }] });
            }
            this.saveToHistory();
            this.renderCanvas();
            this.showToast('Row deleted', 'success');
        },

        deleteColumn(sectionIdx, rowIdx, colIdx) {
            const row = this.content.sections[sectionIdx]?.rows[rowIdx];
            if (!row || !row.columns) return;
            if (row.columns.length <= 1) {
                this.showToast('Cannot delete last column. Delete the row instead.', 'error');
                return;
            }
            row.columns.splice(colIdx, 1);
            // Redistribute widths evenly
            const newWidth = (100 / row.columns.length).toFixed(1) + '%';
            row.columns.forEach(col => col.width = newWidth);
            this.saveToHistory();
            this.renderCanvas();
            this.showToast('Column deleted', 'success');
        },

        setColumnLayout(sectionIdx, rowIdx, layout) {
            const row = this.content.sections[sectionIdx]?.rows[rowIdx];
            if (!row) return;

            const layouts = {
                '1': ['100%'],
                '1-1': ['50%', '50%'],
                '1-1-1': ['33.33%', '33.33%', '33.33%'],
                '1-1-1-1': ['25%', '25%', '25%', '25%'],
                '2-1': ['66.66%', '33.33%'],
                '1-2': ['33.33%', '66.66%'],
                '3-1': ['75%', '25%'],
                '1-3': ['25%', '75%'],
                '1-2-1': ['25%', '50%', '25%'],
                '1-1-2': ['25%', '25%', '50%'],
                '2-1-1': ['50%', '25%', '25%']
            };

            const widths = layouts[layout];
            if (!widths) return;

            // Preserve existing modules where possible
            const existingModules = row.columns.map(col => col.modules || []);

            // Create new columns with specified widths
            row.columns = widths.map((width, idx) => ({
                id: 'col_' + Date.now() + '_' + idx,
                width: width,
                modules: existingModules[idx] || []
            }));

            this.saveToHistory();
            this.renderCanvas();
            this.showToast('Layout changed to ' + layout.replace(/-/g, ':'), 'success');
        },

        duplicateSection(idx) {
            const original = this.content.sections[idx];
            if (!original) return;
            const duplicate = JSON.parse(JSON.stringify(original));
            duplicate.id = 'sec_' + Date.now();
            duplicate.rows.forEach(row => {
                row.id = 'row_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                row.columns.forEach(col => {
                    col.id = 'col_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    col.modules.forEach(mod => { mod.id = 'mod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5); });
                });
            });
            this.content.sections.splice(idx + 1, 0, duplicate);
            this.saveToHistory();
            this.renderCanvas();
            this.showToast('Section duplicated', 'success');
        },

        moveSection(idx, dir) {
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= this.content.sections.length) return;
            [this.content.sections[idx], this.content.sections[newIdx]] = [this.content.sections[newIdx], this.content.sections[idx]];
            this.saveToHistory();
            this.renderCanvas();
        },

        editSection(idx) {
            this.selectedElement = { type: 'section', sIdx: idx };
            document.querySelectorAll('.tb-module').forEach(m => m.classList.remove('selected'));
            document.querySelectorAll('.tb-section').forEach(s => s.classList.remove('selected'));
            document.querySelectorAll('.tb-section')[idx]?.classList.add('selected');
            this.renderSectionSettings(idx);
        },

        renderSectionSettings(idx) {
            this.selectedElement = { type: 'section', idx };
            document.querySelectorAll('.tb-section').forEach(s => s.classList.remove('selected'));
            document.querySelectorAll('.tb-module').forEach(m => m.classList.remove('selected'));
            const sec = document.querySelector('[data-section="' + idx + '"]');
            if (sec) sec.classList.add('selected');
            const section = this.content.sections[idx];
            if (!section) return;
            const design = section.design || {};
            
            let html = '<div class="tb-setting-group"><div class="tb-setting-label" style="font-size:13px;font-weight:600;color:var(--tb-accent)">📐 SECTION SETTINGS</div></div>';
            
            // BACKGROUND IMAGE with Preview
            html += '<div class="tb-setting-group">';
            html += '<div class="tb-setting-label">Background Image</div>';
            if (design.background_image) {
                html += '<div style="margin-bottom:8px;border-radius:8px;overflow:hidden;border:1px solid var(--tb-border)">';
                html += '<img src="' + this.escapeHtml(design.background_image) + '" style="width:100%;height:80px;object-fit:cover;display:block">';
                html += '<div style="display:flex;background:var(--tb-surface)">';
                html += '<button class="tb-btn" style="flex:1;border-radius:0;font-size:11px" onclick="TB.openMediaGallery(url => TB.updateSectionDesign(' + idx + ',\'background_image\',url))">🔄 Change</button>';
                html += '<button class="tb-btn" style="flex:1;border-radius:0;font-size:11px;color:var(--tb-danger)" onclick="TB.updateSectionDesign(' + idx + ',\'background_image\',\'\')">× Remove</button>';
                html += '</div></div>';
            } else {
                html += '<div onclick="TB.openMediaGallery(url => TB.updateSectionDesign(' + idx + ',\'background_image\',url))" style="border:2px dashed var(--tb-border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s">';
                html += '<div style="font-size:24px;margin-bottom:4px">🖼️</div>';
                html += '<div style="font-size:12px;color:var(--tb-text-muted)">Click to add background image</div>';
                html += '</div>';
            }
            html += '</div>';
            
            // BACKGROUND COLOR with Theme Colors Picker
            html += this.renderColorPicker('Background Color', design.background_color, 'TB.updateSectionDesign(' + idx + ',\'background_color\',VALUE)', '#1e1e2e');
            
            // BACKGROUND OVERLAY with Color + Opacity Slider
            const overlayVal = design.background_overlay || '';
            const overlayMatch = overlayVal.match(/rgba?\((\d+),\s*(\d+),\s*(\d+),?\s*([\d.]*)\)/);
            let overlayColor = '#000000';
            let overlayOpacity = 50;
            if (overlayMatch) {
                const r = parseInt(overlayMatch[1]).toString(16).padStart(2,'0');
                const g = parseInt(overlayMatch[2]).toString(16).padStart(2,'0');
                const b = parseInt(overlayMatch[3]).toString(16).padStart(2,'0');
                overlayColor = '#' + r + g + b;
                overlayOpacity = overlayMatch[4] ? Math.round(parseFloat(overlayMatch[4]) * 100) : 100;
            }
            
            html += '<div class="tb-setting-group">';
            html += '<div class="tb-setting-label">Background Overlay</div>';
            html += '<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">';
            html += '<div style="position:relative;width:40px;height:40px;border-radius:8px;border:2px solid var(--tb-border);overflow:hidden;cursor:pointer" onclick="this.querySelector(\'input\').click()">';
            html += '<div style="width:100%;height:100%;background:' + overlayColor + '"></div>';
            html += '<input type="color" id="overlay-color-' + idx + '" value="' + overlayColor + '" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer" onchange="TB.updateOverlay(' + idx + ')">';
            html += '</div>';
            html += '<div style="flex:1">';
            html += '<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--tb-text-muted);margin-bottom:2px"><span>Opacity</span><span id="opacity-val-' + idx + '">' + overlayOpacity + '%</span></div>';
            html += '<input type="range" id="overlay-opacity-' + idx + '" min="0" max="100" value="' + overlayOpacity + '" style="width:100%" onchange="TB.updateOverlay(' + idx + ')" oninput="document.getElementById(\'opacity-val-' + idx + '\').textContent=this.value+\'%\'">';
            html += '</div></div>';
            html += '<div style="display:flex;gap:4px">';
            html += '<button class="tb-btn tb-btn-sm" onclick="TB.setOverlayPreset(' + idx + ',\'light\')" style="flex:1;font-size:10px">Light</button>';
            html += '<button class="tb-btn tb-btn-sm" onclick="TB.setOverlayPreset(' + idx + ',\'medium\')" style="flex:1;font-size:10px">Medium</button>';
            html += '<button class="tb-btn tb-btn-sm" onclick="TB.setOverlayPreset(' + idx + ',\'dark\')" style="flex:1;font-size:10px">Dark</button>';
            html += '<button class="tb-btn tb-btn-sm" onclick="TB.setOverlayPreset(' + idx + ',\'none\')" style="flex:1;font-size:10px">None</button>';
            html += '</div></div>';
            
            // MIN HEIGHT with Presets
            html += '<div class="tb-setting-group">';
            html += '<div class="tb-setting-label">Min Height</div>';
            html += '<div style="display:flex;gap:4px;margin-bottom:8px">';
            const heights = ['auto', '50vh', '75vh', '100vh'];
            heights.forEach(h => {
                const isActive = design.min_height === h;
                html += '<button class="tb-btn tb-btn-sm' + (isActive ? ' active' : '') + '" onclick="TB.updateSectionDesign(' + idx + ',\'min_height\',\'' + h + '\')" style="flex:1;font-size:11px;' + (isActive ? 'background:var(--tb-accent);color:#fff' : '') + '">' + h + '</button>';
            });
            html += '</div>';
            html += '<input type="text" class="tb-setting-input" value="' + (design.min_height || '') + '" placeholder="Custom: 400px, 80vh..." onchange="TB.updateSectionDesign(' + idx + ',\'min_height\',this.value)">';
            html += '</div>';
            
            // PADDING with 4 fields
            const pad = this.parsePadding(design.padding || '60px 20px');
            html += '<div class="tb-setting-group">';
            html += '<div class="tb-setting-label">Padding</div>';
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">';
            html += '<div><label style="font-size:10px;color:var(--tb-text-muted)">Top</label><input type="text" class="tb-setting-input" value="' + pad.top + '" onchange="TB.updatePadding(' + idx + ',\'top\',this.value)"></div>';
            html += '<div><label style="font-size:10px;color:var(--tb-text-muted)">Bottom</label><input type="text" class="tb-setting-input" value="' + pad.bottom + '" onchange="TB.updatePadding(' + idx + ',\'bottom\',this.value)"></div>';
            html += '<div><label style="font-size:10px;color:var(--tb-text-muted)">Left</label><input type="text" class="tb-setting-input" value="' + pad.left + '" onchange="TB.updatePadding(' + idx + ',\'left\',this.value)"></div>';
            html += '<div><label style="font-size:10px;color:var(--tb-text-muted)">Right</label><input type="text" class="tb-setting-input" value="' + pad.right + '" onchange="TB.updatePadding(' + idx + ',\'right\',this.value)"></div>';
            html += '</div>';
            html += '<div style="display:flex;gap:4px;margin-top:6px">';
            html += '<button class="tb-btn tb-btn-sm" onclick="TB.setPaddingPreset(' + idx + ',\'none\')" style="flex:1;font-size:10px">None</button>';
            html += '<button class="tb-btn tb-btn-sm" onclick="TB.setPaddingPreset(' + idx + ',\'small\')" style="flex:1;font-size:10px">S</button>';
            html += '<button class="tb-btn tb-btn-sm" onclick="TB.setPaddingPreset(' + idx + ',\'medium\')" style="flex:1;font-size:10px">M</button>';
            html += '<button class="tb-btn tb-btn-sm" onclick="TB.setPaddingPreset(' + idx + ',\'large\')" style="flex:1;font-size:10px">L</button>';
            html += '<button class="tb-btn tb-btn-sm" onclick="TB.setPaddingPreset(' + idx + ',\'xlarge\')" style="flex:1;font-size:10px">XL</button>';
            html += '</div></div>';
            
            // TEXT ALIGN with Visual Buttons
            html += '<div class="tb-setting-group">';
            html += '<div class="tb-setting-label">Text Align</div>';
            html += '<div style="display:flex;gap:0;border-radius:6px;overflow:hidden;border:1px solid var(--tb-border)">';
            const aligns = [{v:'left',i:'◀'},{v:'center',i:'●'},{v:'right',i:'▶'},{v:'justify',i:'☰'}];
            aligns.forEach(a => {
                const isActive = design.text_align === a.v;
                html += '<button class="tb-btn" onclick="TB.updateSectionDesign(' + idx + ',\'text_align\',\'' + a.v + '\')" style="flex:1;border-radius:0;border:none;' + (isActive ? 'background:var(--tb-accent);color:#fff' : '') + '" title="' + a.v + '">' + a.i + '</button>';
            });
            html += '</div></div>';
            
            // CSS CLASS
            html += '<div class="tb-setting-group">';
            html += '<div class="tb-setting-label">CSS Class</div>';
            html += '<input type="text" class="tb-setting-input" value="' + (design.css_class || '') + '" placeholder="custom-class" onchange="TB.updateSectionDesign(' + idx + ',\'css_class\',this.value)">';
            html += '</div>';
            
            // SECTION ACTIONS
            html += '<div class="tb-setting-group" style="margin-top:20px;padding-top:16px;border-top:1px solid var(--tb-border)">';
            html += '<div style="display:flex;gap:8px">';
            html += '<button class="tb-btn" style="flex:1;justify-content:center" onclick="TB.duplicateSection(' + idx + ')">⧉ Duplicate</button>';
            html += '<button class="tb-btn" style="flex:1;justify-content:center;background:var(--tb-danger);color:#fff" onclick="TB.removeSection(' + idx + ')">× Delete</button>';
            html += '</div></div>';
            
            document.getElementById('settings-panel').innerHTML = html;
        },

        updateSectionSetting(idx, key, value) {
            if (!this.content.sections[idx].settings) this.content.sections[idx].settings = {};
            this.content.sections[idx].settings[key] = value;
            this.renderCanvas();
        },

        updateSectionDesign(idx, key, value) {
            if (!this.content.sections[idx].design) this.content.sections[idx].design = {};
            this.content.sections[idx].design[key] = value;
            this.renderCanvas();
            this.renderSectionSettings(idx);
        },

        // Helper: Parse padding string to object
        parsePadding(paddingStr) {
            const parts = (paddingStr || '').trim().split(/\s+/);
            if (parts.length === 1) return { top: parts[0], right: parts[0], bottom: parts[0], left: parts[0] };
            if (parts.length === 2) return { top: parts[0], right: parts[1], bottom: parts[0], left: parts[1] };
            if (parts.length === 3) return { top: parts[0], right: parts[1], bottom: parts[2], left: parts[1] };
            return { top: parts[0] || '0', right: parts[1] || '0', bottom: parts[2] || '0', left: parts[3] || '0' };
        },

        // Helper: Update overlay from color picker + slider
        updateOverlay(idx) {
            const colorEl = document.getElementById('overlay-color-' + idx);
            const opacityEl = document.getElementById('overlay-opacity-' + idx);
            if (!colorEl || !opacityEl) return;
            const hex = colorEl.value;
            const opacity = parseInt(opacityEl.value) / 100;
            const r = parseInt(hex.substr(1,2), 16);
            const g = parseInt(hex.substr(3,2), 16);
            const b = parseInt(hex.substr(5,2), 16);
            const rgba = 'rgba(' + r + ',' + g + ',' + b + ',' + opacity.toFixed(2) + ')';
            this.updateSectionDesign(idx, 'background_overlay', rgba);
        },

        // Helper: Overlay presets
        setOverlayPreset(idx, preset) {
            const presets = {
                'light': 'rgba(255,255,255,0.3)',
                'medium': 'rgba(0,0,0,0.5)',
                'dark': 'rgba(0,0,0,0.7)',
                'none': ''
            };
            this.updateSectionDesign(idx, 'background_overlay', presets[preset] || '');
        },

        // Helper: Update single padding value
        updatePadding(idx, side, value) {
            const design = this.content.sections[idx].design || {};
            const pad = this.parsePadding(design.padding || '60px 20px');
            pad[side] = value;
            const newPadding = pad.top + ' ' + pad.right + ' ' + pad.bottom + ' ' + pad.left;
            this.updateSectionDesign(idx, 'padding', newPadding);
        },

        // Helper: Padding presets
        setPaddingPreset(idx, preset) {
            const presets = {
                'none': '0',
                'small': '20px 15px',
                'medium': '60px 20px',
                'large': '100px 40px',
                'xlarge': '140px 60px'
            };
            this.updateSectionDesign(idx, 'padding', presets[preset] || '60px 20px');
        },

        selectModule(sIdx, rIdx, cIdx, mIdx, event) {
            if (event) event.stopPropagation();
            this.selectedElement = { type: 'module', sIdx, rIdx, cIdx, mIdx };
            document.querySelectorAll('.tb-module').forEach(m => m.classList.remove('selected'));
            document.querySelectorAll('.tb-section').forEach(s => s.classList.remove('selected'));
            const mod = document.querySelector('[data-path="' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + '"]');
            if (mod) mod.classList.add('selected');
            this.renderSettings();
        },

        renderSettings(tab = null) {
            if (tab === null) tab = this.currentTab || 'content';
            const panel = document.getElementById('settings-panel');
            if (!this.selectedElement || this.selectedElement.type !== 'module') {
                panel.innerHTML = '<div class="tb-no-selection"><div class="tb-no-selection-icon">👆</div><div>Select an element to edit its settings</div></div>';
                return;
            }
            const { sIdx, rIdx, cIdx, mIdx } = this.selectedElement;
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            const icon = this.getModuleIcon(mod.type);
            let html = '<div class="tb-setting-group"><div class="tb-setting-label">' + icon + ' ' + mod.type.toUpperCase() + ' MODULE</div></div>';
            if (tab === 'content') html += this.renderContentSettings(mod);
            else if (tab === 'design') html += this.renderDesignSettings(mod, sIdx, rIdx, cIdx, mIdx);
            else if (tab === 'advanced') html += this.renderAdvancedSettings(mod, sIdx, rIdx, cIdx, mIdx);
            html += '<div class="tb-setting-group" style="margin-top:24px;display:flex;gap:8px;"><button class="tb-btn" style="flex:1;justify-content:center" onclick="TB.duplicateModule(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">⧉ Duplicate</button><button class="tb-btn" style="flex:1;justify-content:center;background:var(--tb-danger);color:#fff" onclick="TB.removeModule(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">× Delete</button></div>';
            panel.innerHTML = html;
        },

        renderContentSettings(mod) {
            const content = mod.content || {};
            const design = mod.design || {};
            const { sIdx, rIdx, cIdx, mIdx } = this.selectedElement;
            let html = '';
            switch (mod.type) {
                case 'text':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Text Content</div><textarea class="tb-setting-input" rows="6" placeholder="Enter your text..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text\',this.value)">' + this.escapeHtml(content.text || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'text\', \'text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    break;
                case 'heading':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Heading Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.text || '') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'heading\', \'text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Heading Level</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'tag\',this.value)"><option value="h1"' + (content.tag === 'h1' ? ' selected' : '') + '>H1</option><option value="h2"' + (content.tag === 'h2' || !content.tag ? ' selected' : '') + '>H2</option><option value="h3"' + (content.tag === 'h3' ? ' selected' : '') + '>H3</option><option value="h4"' + (content.tag === 'h4' ? ' selected' : '') + '>H4</option></select></div>';
                    break;
                case 'image':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Image URL</div><div style="display:flex;gap:8px;flex-wrap:wrap"><input type="text" class="tb-setting-input tb-img-url" style="flex:1;min-width:150px" value="' + this.escapeHtml(content.src || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'src\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'src\',url))">📁</button>' + ((content.src && content.src.startsWith && content.src.startsWith('http')) ? '<button type="button" class="tb-btn-save" style="background:#10b981;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:11px;white-space:nowrap" onclick="TB.downloadToServer(this.parentElement.querySelector(\'input\').value,' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'src\',this)" title="Download to server">⬇️ Save</button>' : '') + '</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Alt Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.alt || '') + '" placeholder="Describe the image" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'alt\',this.value)"></div>';
                    break;
                case 'button':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.text || '') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'button\', \'text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Link URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.url || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'url\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="primary"' + (content.style === 'primary' || !content.style ? ' selected' : '') + '>Primary</option><option value="secondary"' + (content.style === 'secondary' ? ' selected' : '') + '>Secondary</option><option value="outline"' + (content.style === 'outline' ? ' selected' : '') + '>Outline</option></select></div>';
                    break;
                case 'divider':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Line Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="solid"' + (content.style === 'solid' || !content.style ? ' selected' : '') + '>Solid</option><option value="dashed"' + (content.style === 'dashed' ? ' selected' : '') + '>Dashed</option><option value="dotted"' + (content.style === 'dotted' ? ' selected' : '') + '>Dotted</option></select></div>';
                    break;
                case 'spacer':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Height</div><input type="text" class="tb-setting-input" value="' + (content.height || '40px') + '" placeholder="e.g., 40px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'height\',this.value)"></div>';
                    break;
                case 'video':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Video URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.url || '') + '" placeholder="YouTube or Vimeo URL" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'url\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'autoplay\',this.value===\'true\')"><option value="false"' + (!content.autoplay ? ' selected' : '') + '>No</option><option value="true"' + (content.autoplay ? ' selected' : '') + '>Yes</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Controls</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'controls\',this.value===\'true\')"><option value="true"' + (content.controls !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.controls === false ? ' selected' : '') + '>No</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Loop</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'loop\',this.value===\'true\')"><option value="false"' + (!content.loop ? ' selected' : '') + '>No</option><option value="true"' + (content.loop ? ' selected' : '') + '>Yes</option></select></div>';
                    break;
                case 'audio':
                    // Audio URL input
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Audio URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.audio_url || '') + '" placeholder="https://example.com/audio.mp3" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'audio_url\',this.value)"></div>';
                    html += '<div class="tb-setting-group" style="font-size:11px;color:var(--tb-text-muted);margin-top:-8px;margin-bottom:12px">Supported formats: MP3, WAV, OGG</div>';
                    // Track info
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Track Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || '') + '" placeholder="Song title" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Artist</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.artist || '') + '" placeholder="Artist name" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'artist\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Album</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.album || '') + '" placeholder="Album name (optional)" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'album\',this.value)"></div>';
                    // Cover image
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Cover Image URL</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(content.cover_image || '') + '" placeholder="https://example.com/cover.jpg" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'cover_image\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'cover_image\',url))">📁</button></div></div>';
                    if (content.cover_image) {
                        html += '<div class="tb-setting-group" style="margin-top:-4px"><img src="' + this.escapeHtml(content.cover_image) + '" style="width:80px;height:80px;object-fit:cover;border-radius:6px;border:1px solid var(--tb-border)"></div>';
                    }
                    // Design settings in content tab for audio
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600;color:var(--tb-accent)">🎨 Player Style</div></div>';
                    // Style selector
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="default"' + (content.style === 'default' || !content.style ? ' selected' : '') + '>Default (Horizontal)</option><option value="minimal"' + (content.style === 'minimal' ? ' selected' : '') + '>Minimal</option><option value="card"' + (content.style === 'card' ? ' selected' : '') + '>Card (Vertical)</option></select></div>';
                    // Show cover toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Cover</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_cover\',this.value===\'true\')"><option value="true"' + (content.show_cover !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.show_cover === false ? ' selected' : '') + '>No</option></select></div>';
                    // Cover size
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Cover Size</div><input type="text" class="tb-setting-input" value="' + (content.cover_size || '120px') + '" placeholder="120px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'cover_size\',this.value)"></div>';
                    // Colors with Theme Colors support
                    html += this.renderColorPicker('Background Color', content.background_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_color\',VALUE)', '#1e1e2e');
                    html += this.renderColorPicker('Text Color', content.text_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_color\',VALUE)', '#ffffff');
                    html += this.renderColorPicker('Accent Color', content.accent_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'accent_color\',VALUE)', '#0073e6');
                    // Playback options
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600;color:var(--tb-accent)">▶️ Playback Options</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'autoplay\',this.value===\'true\')"><option value="false"' + (!content.autoplay ? ' selected' : '') + '>No</option><option value="true"' + (content.autoplay ? ' selected' : '') + '>Yes</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Loop</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'loop\',this.value===\'true\')"><option value="false"' + (!content.loop ? ' selected' : '') + '>No</option><option value="true"' + (content.loop ? ' selected' : '') + '>Yes</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Download Button</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_download\',this.value===\'true\')"><option value="false"' + (!content.show_download ? ' selected' : '') + '>No</option><option value="true"' + (content.show_download ? ' selected' : '') + '>Yes</option></select></div>';
                    break;
                case 'code':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Language</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'language\',this.value)"><option value="javascript"' + (content.language === 'javascript' || !content.language ? ' selected' : '') + '>JavaScript</option><option value="php"' + (content.language === 'php' ? ' selected' : '') + '>PHP</option><option value="python"' + (content.language === 'python' ? ' selected' : '') + '>Python</option><option value="html"' + (content.language === 'html' ? ' selected' : '') + '>HTML</option><option value="css"' + (content.language === 'css' ? ' selected' : '') + '>CSS</option><option value="sql"' + (content.language === 'sql' ? ' selected' : '') + '>SQL</option><option value="bash"' + (content.language === 'bash' ? ' selected' : '') + '>Bash</option><option value="json"' + (content.language === 'json' ? ' selected' : '') + '>JSON</option><option value="xml"' + (content.language === 'xml' ? ' selected' : '') + '>XML</option><option value="plaintext"' + (content.language === 'plaintext' ? ' selected' : '') + '>Plain Text</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Code</div><textarea class="tb-setting-input" rows="8" style="font-family:monospace;font-size:12px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'code\',this.value)">' + this.escapeHtml(content.code || '') + '</textarea></div>';
                    break;
                case 'html':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Custom HTML</div><textarea class="tb-setting-input" rows="8" style="font-family:monospace;font-size:12px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'html\',this.value)">' + this.escapeHtml(content.html || '') + '</textarea></div>';
                    break;
                case 'quote':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Quote Text</div><textarea class="tb-setting-input" rows="4" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text\',this.value)">' + this.escapeHtml(content.text || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'quote\', \'text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Author</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.author || '') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'author\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Source</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.source || '') + '" placeholder="Book, article, etc." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'source\',this.value)"></div>';
                    break;
                case 'list':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">List Type</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'type\',this.value)"><option value="unordered"' + (content.type === 'unordered' || !content.type ? ' selected' : '') + '>Unordered (Bullets)</option><option value="ordered"' + (content.type === 'ordered' ? ' selected' : '') + '>Ordered (Numbers)</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Icon Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon\',this.value)"><option value="bullet"' + (content.icon === 'bullet' || !content.icon ? ' selected' : '') + '>Bullet</option><option value="check"' + (content.icon === 'check' ? ' selected' : '') + '>Checkmark</option><option value="arrow"' + (content.icon === 'arrow' ? ' selected' : '') + '>Arrow</option><option value="star"' + (content.icon === 'star' ? ' selected' : '') + '>Star</option><option value="none"' + (content.icon === 'none' ? ' selected' : '') + '>None</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">List Items</div></div>';
                    const listItems = content.items || [];
                    listItems.forEach((item, i) => {
                        html += '<div class="tb-setting-group" style="display:flex;gap:4px;margin-bottom:8px;"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(item) + '" onchange="TB.updateListItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',this.value)"><button class="tb-btn" style="padding:8px;flex:0 0 auto" onclick="TB.moveListItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',-1)" title="Move Up">↑</button><button class="tb-btn" style="padding:8px;flex:0 0 auto" onclick="TB.moveListItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',1)" title="Move Down">↓</button><button class="tb-btn" style="padding:8px;flex:0 0 auto;background:var(--tb-danger)" onclick="TB.removeListItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ')" title="Remove">×</button></div>';
                    });
                    html += '<button class="tb-btn" style="width:100%" onclick="TB.addListItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Item</button>';
                    break;
                case 'icon':
                    // Icon with Icon Picker
                    const iconValue = content.icon || '⭐';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Icon</div>';
                    html += '<div style="display:flex;gap:8px;align-items:center">';
                    html += '<div style="width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:var(--tb-surface);border:1px solid var(--tb-border);border-radius:8px;font-size:24px" id="icon-preview-' + mIdx + '">' + this.renderIconFromFormat(iconValue) + '</div>';
                    html += '<input type="text" class="tb-setting-input" style="flex:1" id="icon-input-' + mIdx + '" value="' + this.escapeHtml(iconValue) + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon\',this.value);document.getElementById(\'icon-preview-' + mIdx + '\').innerHTML=TB.renderIconFromFormat(this.value)">';
                    html += '<button class="tb-btn tb-btn-primary" onclick="TB.openIconPicker(function(icon){TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon\',icon);document.getElementById(\'icon-input-' + mIdx + '\').value=icon;document.getElementById(\'icon-preview-' + mIdx + '\').innerHTML=TB.renderIconFromFormat(icon)})">Browse</button>';
                    html += '</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Size</div><input type="text" class="tb-setting-input" value="' + (content.size || '48px') + '" placeholder="e.g., 48px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'size\',this.value)"></div>';
                    html += this.renderColorPicker('Color', content.color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'color\',VALUE)', '#333333');
                    break;
                case 'map':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Address</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.address || '') + '" placeholder="123 Main St, City, Country" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'address\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Latitude</div><input type="number" step="any" class="tb-setting-input" value="' + (content.lat || 0) + '" placeholder="e.g., 40.7128" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'lat\',parseFloat(this.value)||0)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Longitude</div><input type="number" step="any" class="tb-setting-input" value="' + (content.lng || 0) + '" placeholder="e.g., -74.0060" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'lng\',parseFloat(this.value)||0)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Zoom Level (1-18)</div><input type="range" class="tb-setting-input" min="1" max="18" value="' + (content.zoom || 14) + '" oninput="this.nextElementSibling.textContent=this.value" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'zoom\',parseInt(this.value))"><span style="display:block;text-align:center;margin-top:4px;color:var(--tb-text-muted)">' + (content.zoom || 14) + '</span></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Height</div><input type="text" class="tb-setting-input" value="' + (content.height || '300px') + '" placeholder="e.g., 300px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'height\',this.value)"></div>';
                    break;
                case 'accordion':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="default"' + (content.style === 'default' || !content.style ? ' selected' : '') + '>Default</option><option value="bordered"' + (content.style === 'bordered' ? ' selected' : '') + '>Bordered</option><option value="separated"' + (content.style === 'separated' ? ' selected' : '') + '>Separated</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Accordion Items</div></div>';
                    const accordionItems = content.items || [];
                    accordionItems.forEach((item, i) => {
                        html += '<div style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:6px;padding:12px;margin-bottom:8px;">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><span style="font-weight:500;font-size:12px;">Item ' + (i + 1) + '</span><div style="display:flex;gap:4px;"><button class="tb-btn" style="padding:4px 6px;font-size:10px" onclick="TB.moveAccordionItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',-1)">↑</button><button class="tb-btn" style="padding:4px 6px;font-size:10px" onclick="TB.moveAccordionItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',1)">↓</button><button class="tb-btn" style="padding:4px 6px;font-size:10px;background:var(--tb-danger)" onclick="TB.removeAccordionItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ')">×</button></div></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(item.title || '') + '" onchange="TB.updateAccordionItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'title\',this.value)"></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:0"><div class="tb-setting-label">Content</div><textarea class="tb-setting-input" rows="3" onchange="TB.updateAccordionItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'content\',this.value)">' + this.escapeHtml(item.content || '') + '</textarea></div>';
                        html += '</div>';
                    });
                    html += '<button class="tb-btn" style="width:100%" onclick="TB.addAccordionItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Item</button>';
                    break;
                case 'toggle':
                    // Title input with AI generate
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Toggle Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || '') + '" placeholder="Click to expand" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'toggle_title\', \'title\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    // Content textarea with AI generate
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Content</div><textarea class="tb-setting-input" rows="4" placeholder="Hidden content goes here..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'content\',this.value)">' + this.escapeHtml(content.content || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'toggle_content\', \'content\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    // Open by default toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Open by Default</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'open_by_default\',this.value===\'true\')"><option value="false"' + (!content.open_by_default ? ' selected' : '') + '>Closed</option><option value="true"' + (content.open_by_default ? ' selected' : '') + '>Open</option></select></div>';
                    // Icon position
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Icon Position</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon_position\',this.value)"><option value="right"' + (content.icon_position === 'right' || !content.icon_position ? ' selected' : '') + '>Right</option><option value="left"' + (content.icon_position === 'left' ? ' selected' : '') + '>Left</option></select></div>';
                    // Custom icons
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Open Icon</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.icon_open || '+') + '" placeholder="+" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon_open\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Close Icon</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.icon_close || '−') + '" placeholder="−" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon_close\',this.value)"></div>';
                    // Title background color
                    html += this.renderColorPicker('Title Background', content.title_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_background\',VALUE)', '#f8fafc');
                    // Title text color
                    html += this.renderColorPicker('Title Color', content.title_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_color\',VALUE)', '#1e293b');
                    // Content background color
                    html += this.renderColorPicker('Content Background', content.content_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'content_background\',VALUE)', '#ffffff');
                    // Border color
                    html += this.renderColorPicker('Border Color', content.border_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_color\',VALUE)', '#e2e8f0');
                    // Border radius
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Border Radius</div><input type="text" class="tb-setting-input" value="' + (content.border_radius || '8px') + '" placeholder="8px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_radius\',this.value)"></div>';
                    break;
                case 'tabs':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="default"' + (content.style === 'default' || !content.style ? ' selected' : '') + '>Default</option><option value="pills"' + (content.style === 'pills' ? ' selected' : '') + '>Pills</option><option value="underline"' + (content.style === 'underline' ? ' selected' : '') + '>Underline</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Tabs</div></div>';
                    const tabItems = content.tabs || [];
                    tabItems.forEach((tab, i) => {
                        html += '<div style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:6px;padding:12px;margin-bottom:8px;">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><span style="font-weight:500;font-size:12px;">Tab ' + (i + 1) + '</span><div style="display:flex;gap:4px;"><button class="tb-btn" style="padding:4px 6px;font-size:10px" onclick="TB.moveTab(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',-1)">↑</button><button class="tb-btn" style="padding:4px 6px;font-size:10px" onclick="TB.moveTab(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',1)">↓</button><button class="tb-btn" style="padding:4px 6px;font-size:10px;background:var(--tb-danger)" onclick="TB.removeTab(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ')">×</button></div></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(tab.title || '') + '" onchange="TB.updateTab(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'title\',this.value)"></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:0"><div class="tb-setting-label">Content</div><textarea class="tb-setting-input" rows="3" onchange="TB.updateTab(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'content\',this.value)">' + this.escapeHtml(tab.content || '') + '</textarea></div>';
                        html += '</div>';
                    });
                    html += '<button class="tb-btn" style="width:100%" onclick="TB.addTab(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Tab</button>';
                    break;
                case 'gallery':
                    const galleryContent = mod.content || {};
                    const galleryImages = galleryContent.images || [];

                    // === RESPONSIVE COLUMNS SECTION ===
                    html += '<div style="background:linear-gradient(135deg,rgba(139,92,246,0.1),rgba(59,130,246,0.1));border:1px solid rgba(139,92,246,0.3);border-radius:10px;padding:14px;margin-bottom:16px">';
                    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;font-weight:600;color:#a78bfa"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg> Responsive Columns</div>';
                    html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">';
                    
                    // Desktop
                    html += '<div style="text-align:center"><div style="font-size:10px;color:var(--tb-text-muted);margin-bottom:4px;display:flex;align-items:center;justify-content:center;gap:4px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>Desktop</div>';
                    html += '<select class="tb-setting-input" style="text-align:center;padding:6px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'columns\',parseInt(this.value))">';
                    for (let c = 2; c <= 6; c++) html += '<option value="' + c + '"' + ((galleryContent.columns || 3) == c ? ' selected' : '') + '>' + c + '</option>';
                    html += '</select></div>';
                    
                    // Tablet
                    html += '<div style="text-align:center"><div style="font-size:10px;color:var(--tb-text-muted);margin-bottom:4px;display:flex;align-items:center;justify-content:center;gap:4px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>Tablet</div>';
                    html += '<select class="tb-setting-input" style="text-align:center;padding:6px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'columns_tablet\',parseInt(this.value))">';
                    for (let c = 1; c <= 4; c++) html += '<option value="' + c + '"' + ((galleryContent.columns_tablet || 2) == c ? ' selected' : '') + '>' + c + '</option>';
                    html += '</select></div>';
                    
                    // Mobile
                    html += '<div style="text-align:center"><div style="font-size:10px;color:var(--tb-text-muted);margin-bottom:4px;display:flex;align-items:center;justify-content:center;gap:4px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>Mobile</div>';
                    html += '<select class="tb-setting-input" style="text-align:center;padding:6px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'columns_mobile\',parseInt(this.value))">';
                    for (let c = 1; c <= 3; c++) html += '<option value="' + c + '"' + ((galleryContent.columns_mobile || 1) == c ? ' selected' : '') + '>' + c + '</option>';
                    html += '</select></div>';
                    
                    html += '</div></div>';

                    // === GALLERY IMAGES SECTION ===
                    html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">';
                    html += '<div style="display:flex;align-items:center;gap:8px;font-weight:600;color:var(--tb-text)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg> Images <span style="background:var(--tb-accent);color:#fff;font-size:10px;padding:2px 6px;border-radius:10px">' + galleryImages.length + '</span></div>';
                    html += '<button class="tb-btn" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;padding:6px 12px;font-size:11px;display:flex;align-items:center;gap:4px" onclick="TB.openMediaGallery(function(url){TB.addGalleryImageWithUrl(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',url)})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add</button>';
                    html += '</div>';

                    // Image cards
                    if (galleryImages.length === 0) {
                        html += '<div style="border:2px dashed var(--tb-border);border-radius:10px;padding:30px;text-align:center;color:var(--tb-text-muted)">';
                        html += '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 10px;opacity:0.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>';
                        html += '<div style="font-size:13px;margin-bottom:8px">No images yet</div>';
                        html += '<button class="tb-btn" style="background:var(--tb-accent);color:#fff;border:none" onclick="TB.openMediaGallery(function(url){TB.addGalleryImageWithUrl(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',url)})">📁 Browse Media Library</button>';
                        html += '</div>';
                    } else {
                        galleryImages.forEach((img, imgIdx) => {
                            const imgUrl = img.url || img.src || '';
                            const imgAlt = img.alt || '';
                            const imgCaption = img.caption || '';

                            html += '<div style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:10px;padding:12px;margin-bottom:10px;position:relative">';
                            
                            // Image number badge
                            html += '<div style="position:absolute;top:-8px;left:10px;background:var(--tb-accent);color:#fff;font-size:10px;font-weight:600;padding:2px 8px;border-radius:10px">#' + (imgIdx + 1) + '</div>';
                            
                            // Top row: Preview + Actions
                            html += '<div style="display:flex;gap:12px;margin-bottom:10px;margin-top:4px">';
                            
                            // Image preview (larger)
                            html += '<div style="width:80px;height:80px;border-radius:8px;overflow:hidden;background:var(--tb-bg-secondary);flex-shrink:0;border:2px solid var(--tb-border)">';
                            if (imgUrl) {
                                html += '<img src="' + imgUrl + '" style="width:100%;height:100%;object-fit:cover;cursor:pointer" onclick="TB.openMediaGallery(function(url){TB.updateGalleryImage(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + imgIdx + ',\'url\',url)})" title="Click to change">';
                            } else {
                                html += '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;cursor:pointer" onclick="TB.openMediaGallery(function(url){TB.updateGalleryImage(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + imgIdx + ',\'url\',url)})"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></div>';
                            }
                            html += '</div>';
                            
                            // Right side: inputs
                            html += '<div style="flex:1;display:flex;flex-direction:column;gap:6px">';
                            html += '<input type="text" class="tb-setting-input" style="font-size:11px;padding:6px 8px" placeholder="Alt text (for SEO)" value="' + this.escapeHtml(imgAlt) + '" onchange="TB.updateGalleryImage(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + imgIdx + ',\'alt\',this.value)">';
                            html += '<input type="text" class="tb-setting-input" style="font-size:11px;padding:6px 8px" placeholder="Caption (optional)" value="' + this.escapeHtml(imgCaption) + '" onchange="TB.updateGalleryImage(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + imgIdx + ',\'caption\',this.value)">';
                            
                            // Action buttons
                            html += '<div style="display:flex;gap:4px;margin-top:2px">';
                            html += '<button class="tb-btn" style="flex:1;padding:4px;font-size:10px;background:var(--tb-surface-3)" onclick="TB.moveGalleryImage(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + imgIdx + ',-1)" ' + (imgIdx === 0 ? 'disabled style="opacity:0.4;flex:1;padding:4px;font-size:10px;background:var(--tb-surface-3)"' : '') + '>▲</button>';
                            html += '<button class="tb-btn" style="flex:1;padding:4px;font-size:10px;background:var(--tb-surface-3)" onclick="TB.moveGalleryImage(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + imgIdx + ',1)" ' + (imgIdx === galleryImages.length - 1 ? 'disabled style="opacity:0.4;flex:1;padding:4px;font-size:10px;background:var(--tb-surface-3)"' : '') + '>▼</button>';
                            html += '<button class="tb-btn" style="flex:2;padding:4px;font-size:10px;background:#ef4444;color:#fff" onclick="TB.removeGalleryImage(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + imgIdx + ')">🗑️ Remove</button>';
                            html += '</div>';
                            
                            html += '</div></div></div>';
                        });
                    }

                    // Bottom: Add more button (if has images)
                    if (galleryImages.length > 0) {
                        html += '<button class="tb-btn" style="width:100%;background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:#fff;border:none;padding:10px;display:flex;align-items:center;justify-content:center;gap:6px" onclick="TB.openMediaGallery(function(url){TB.addGalleryImageWithUrl(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',url)})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add More Images</button>';
                    }
                    break;
                case 'testimonial':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Quote Text</div><textarea class="tb-setting-input" rows="4" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text\',this.value)">' + this.escapeHtml(content.text || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'testimonial\', \'text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate Testimonial</button></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Author Name</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.author || '') + '" placeholder="John Doe" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'author\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Author Role/Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.role || '') + '" placeholder="CEO, Company" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'role\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Avatar URL</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(content.avatar || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'avatar\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'avatar\',url))">📁</button></div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="card"' + (content.style === 'card' || !content.style ? ' selected' : '') + '>Card</option><option value="minimal"' + (content.style === 'minimal' ? ' selected' : '') + '>Minimal</option><option value="centered"' + (content.style === 'centered' ? ' selected' : '') + '>Centered</option></select></div>';
                    break;
                case 'cta':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || '') + '" placeholder="Call to Action Title" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'cta_title\', \'title\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Subtitle</div><textarea class="tb-setting-input" rows="2" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'subtitle\',this.value)">' + this.escapeHtml(content.subtitle || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'cta_subtitle\', \'subtitle\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.button_text || 'Get Started') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'cta_button\', \'button_text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.button_url || '#') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_url\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Layout Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="centered"' + (content.style === 'centered' || !content.style ? ' selected' : '') + '>Centered</option><option value="left"' + (content.style === 'left' ? ' selected' : '') + '>Left Aligned</option><option value="split"' + (content.style === 'split' ? ' selected' : '') + '>Split (Text Left, Button Right)</option></select></div>';
                    break;
                case 'pricing':
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Plan Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || '') + '" placeholder="Basic, Pro, Enterprise..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Price</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.price || '') + '" placeholder="$29" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'price\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Period</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.period || '/month') + '" placeholder="/month, /year" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'period\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Highlighted</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'highlighted\',this.value===\'true\')"><option value="false"' + (!content.highlighted ? ' selected' : '') + '>No</option><option value="true"' + (content.highlighted ? ' selected' : '') + '>Yes (Featured)</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Features</div><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'pricing_features\', \'features\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate Features</button></div>';
                    const pricingFeatures = content.features || [];
                    pricingFeatures.forEach((feature, i) => {
                        html += '<div style="display:flex;gap:4px;margin-bottom:8px;"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(feature) + '" onchange="TB.updatePricingFeature(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',this.value)"><button class="tb-btn" style="padding:8px;flex:0 0 auto" onclick="TB.movePricingFeature(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',-1)">↑</button><button class="tb-btn" style="padding:8px;flex:0 0 auto" onclick="TB.movePricingFeature(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',1)">↓</button><button class="tb-btn" style="padding:8px;flex:0 0 auto;background:var(--tb-danger)" onclick="TB.removePricingFeature(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ')">×</button></div>';
                    });
                    html += '<button class="tb-btn" style="width:100%;margin-bottom:16px" onclick="TB.addPricingFeature(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Feature</button>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.button_text || 'Choose Plan') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.button_url || '#') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_url\',this.value)"></div>';
                    break;
                case 'blurb':
                    // Media type selector
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Media Type</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'use_image\',this.value===\'true\')">';
                    html += '<option value="false"' + (!content.use_image ? ' selected' : '') + '>Icon</option>';
                    html += '<option value="true"' + (content.use_image ? ' selected' : '') + '>Image</option></select></div>';
                    // Icon picker with full Icon Picker modal (shown if not using image)
                    if (!content.use_image) {
                        const blurbIconValue = content.icon || 'fa:star';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Icon</div>';
                        html += '<div style="display:flex;gap:8px;align-items:center">';
                        html += '<div style="width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:var(--tb-surface);border:1px solid var(--tb-border);border-radius:8px;font-size:24px;color:' + (content.icon_color || '#0073e6') + '" id="blurb-icon-preview-' + mIdx + '">' + this.renderIconFromFormat(blurbIconValue) + '</div>';
                        html += '<input type="text" class="tb-setting-input" style="flex:1" id="blurb-icon-input-' + mIdx + '" value="' + this.escapeHtml(blurbIconValue) + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon\',this.value);document.getElementById(\'blurb-icon-preview-' + mIdx + '\').innerHTML=TB.renderIconFromFormat(this.value)">';
                        html += '<button class="tb-btn tb-btn-primary" onclick="TB.openIconPicker(function(icon){TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon\',icon);document.getElementById(\'blurb-icon-input-' + mIdx + '\').value=icon;document.getElementById(\'blurb-icon-preview-' + mIdx + '\').innerHTML=TB.renderIconFromFormat(icon)})">Browse</button>';
                        html += '</div></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Icon Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.icon_size || '64px') + '" placeholder="64px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon_size\',this.value)"></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Icon Color</div><div style="display:flex;gap:8px;align-items:center"><input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (content.icon_color || '#0073e6') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon_color\',this.value);document.getElementById(\'blurb-icon-preview-' + mIdx + '\').style.color=this.value"><input type="text" class="tb-setting-input" style="flex:1" value="' + (content.icon_color || '#0073e6') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon_color\',this.value);document.getElementById(\'blurb-icon-preview-' + mIdx + '\').style.color=this.value"></div></div>';
                    } else {
                        // Image upload
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Image URL</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(content.image || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'image\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'image\',url))">📁</button></div></div>';
                    }
                    // Title with AI button
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || '') + '" placeholder="Your Title Here" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)">';
                    html += '<button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'blurb_title\', \'title\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    // Text with AI button
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Description</div><textarea class="tb-setting-input" rows="3" placeholder="Your description text..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text\',this.value)">' + this.escapeHtml(content.text || '') + '</textarea>';
                    html += '<button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'blurb_text\', \'text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    // Optional URL
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Link URL (optional)</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.url || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'url\',this.value)"></div>';
                    // Layout selector
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Layout</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'layout\',this.value)">';
                    html += '<option value="top"' + (content.layout === 'top' || !content.layout ? ' selected' : '') + '>Icon Top</option>';
                    html += '<option value="left"' + (content.layout === 'left' ? ' selected' : '') + '>Icon Left</option>';
                    html += '<option value="right"' + (content.layout === 'right' ? ' selected' : '') + '>Icon Right</option></select></div>';
                    // Alignment (for top layout)
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Alignment</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'alignment\',this.value)">';
                    html += '<option value="left"' + (content.alignment === 'left' ? ' selected' : '') + '>Left</option>';
                    html += '<option value="center"' + (content.alignment === 'center' || !content.alignment ? ' selected' : '') + '>Center</option>';
                    html += '<option value="right"' + (content.alignment === 'right' ? ' selected' : '') + '>Right</option></select></div>';
                    break;
                case 'hero':
                    // Title with AI button
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || '') + '" placeholder="Welcome to Our Site" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)">';
                    html += '<button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'hero_title\', \'title\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    // Subtitle with AI button
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Subtitle</div><textarea class="tb-setting-input" rows="2" placeholder="We build amazing digital experiences" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'subtitle\',this.value)">' + this.escapeHtml(content.subtitle || '') + '</textarea>';
                    html += '<button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'hero_subtitle\', \'subtitle\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate</button></div>';
                    // Primary Button
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Primary Button</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.primary_button_text || 'Get Started') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'primary_button_text\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.primary_button_url || '#') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'primary_button_url\',this.value)"></div>';
                    // Secondary Button
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Secondary Button</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Secondary</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_secondary\',this.value===\'true\')">';
                    html += '<option value="true"' + (content.show_secondary !== false ? ' selected' : '') + '>Yes</option>';
                    html += '<option value="false"' + (content.show_secondary === false ? ' selected' : '') + '>No</option></select></div>';
                    if (content.show_secondary !== false) {
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.secondary_button_text || 'Learn More') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'secondary_button_text\',this.value)"></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Button URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.secondary_button_url || '#') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'secondary_button_url\',this.value)"></div>';
                    }
                    // Background Settings
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Background</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Background Type</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_type\',this.value)">';
                    html += '<option value="color"' + (content.background_type === 'color' || !content.background_type ? ' selected' : '') + '>Solid Color</option>';
                    html += '<option value="gradient"' + (content.background_type === 'gradient' ? ' selected' : '') + '>Gradient</option>';
                    html += '<option value="image"' + (content.background_type === 'image' ? ' selected' : '') + '>Image</option>';
                    html += '<option value="video"' + (content.background_type === 'video' ? ' selected' : '') + '>Video</option></select></div>';
                    if (content.background_type === 'color' || !content.background_type) {
                        html += this.renderColorPicker('Background Color', content.background_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_color\',VALUE)', '#1e1e2e');
                    } else if (content.background_type === 'gradient') {
                        html += this.renderColorPicker('Gradient Start', content.gradient_start, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gradient_start\',VALUE)', '#667eea');
                        html += this.renderColorPicker('Gradient End', content.gradient_end, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gradient_end\',VALUE)', '#764ba2');
                    } else if (content.background_type === 'image') {
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Background Image URL</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(content.background_image || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_image\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_image\',url))">📁</button></div></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Overlay Color</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.overlay_color || 'rgba(0,0,0,0.5)') + '" placeholder="rgba(0,0,0,0.5)" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'overlay_color\',this.value)"></div>';
                    } else if (content.background_type === 'video') {
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Background Video URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.background_video || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_video\',this.value)"></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Overlay Color</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.overlay_color || 'rgba(0,0,0,0.5)') + '" placeholder="rgba(0,0,0,0.5)" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'overlay_color\',this.value)"></div>';
                    }
                    // Layout Settings
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Layout</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Min Height</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.min_height || '600px') + '" placeholder="600px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'min_height\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Content Width</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.content_width || '800px') + '" placeholder="800px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'content_width\',this.value)"></div>';
                    html += this.renderColorPicker('Text Color', content.text_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_color\',VALUE)', '#ffffff');
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Alignment</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'alignment\',this.value)">';
                    html += '<option value="flex-start"' + (content.alignment === 'flex-start' || content.alignment === 'left' ? ' selected' : '') + '>Left</option>';
                    html += '<option value="center"' + (content.alignment === 'center' || !content.alignment ? ' selected' : '') + '>Center</option>';
                    html += '<option value="flex-end"' + (content.alignment === 'flex-end' || content.alignment === 'right' ? ' selected' : '') + '>Right</option></select></div>';
                    break;
                case 'slider':
                    const sliderSlides = content.slides || [{ title: 'Slide 1', text: 'Description for slide 1', image: '', button_text: 'Learn More', button_url: '#' }];
                    // Slides Management Header
                    html += '<div class="tb-setting-group" style="display:flex;justify-content:space-between;align-items:center"><div class="tb-setting-label" style="font-weight:600;margin:0">Slides (' + sliderSlides.length + ')</div>';
                    html += '<button type="button" class="tb-btn-small" onclick="TB.addSliderSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')" style="background:#10b981;color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:12px;cursor:pointer">+ Add Slide</button></div>';
                    // Individual Slides
                    sliderSlides.forEach((slide, slideIdx) => {
                        html += '<div class="tb-slide-item" style="background:var(--tb-bg-elevated);border:1px solid var(--tb-border);border-radius:6px;padding:12px;margin-bottom:12px">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><strong style="font-size:13px">Slide ' + (slideIdx + 1) + '</strong>';
                        html += '<div style="display:flex;gap:4px">';
                        if (slideIdx > 0) html += '<button type="button" onclick="TB.moveSliderSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',-1)" style="background:var(--tb-bg);border:1px solid var(--tb-border);padding:2px 6px;border-radius:3px;cursor:pointer" title="Move Up">↑</button>';
                        if (slideIdx < sliderSlides.length - 1) html += '<button type="button" onclick="TB.moveSliderSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',1)" style="background:var(--tb-bg);border:1px solid var(--tb-border);padding:2px 6px;border-radius:3px;cursor:pointer" title="Move Down">↓</button>';
                        html += '<button type="button" onclick="TB.removeSliderSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ')" style="background:#ef4444;color:#fff;border:none;padding:2px 6px;border-radius:3px;cursor:pointer" title="Remove">×</button>';
                        html += '</div></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(slide.title || '') + '" placeholder="Slide title" onchange="TB.updateSliderSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',\'title\',this.value)"></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Description</div><textarea class="tb-setting-input" rows="2" placeholder="Slide description" onchange="TB.updateSliderSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',\'text\',this.value)">' + this.escapeHtml(slide.text || '') + '</textarea></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Background Image URL</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(slide.image || '') + '" placeholder="https://..." onchange="TB.updateSliderSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',\'image\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updateSliderSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',\'image\',url))">📁</button></div></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(slide.button_text || '') + '" placeholder="Learn More" onchange="TB.updateSliderSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',\'button_text\',this.value)"></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Button URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(slide.button_url || '') + '" placeholder="#" onchange="TB.updateSliderSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',\'button_url\',this.value)"></div>';
                        html += '</div>';
                    });
                    // Slider Settings
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Slider Settings</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.autoplay !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'autoplay\',this.checked)"><span>Enable autoplay</span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay Speed (ms)</div><input type="number" class="tb-setting-input" value="' + (content.autoplay_speed || 5000) + '" min="1000" step="500" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'autoplay_speed\',parseInt(this.value))"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Arrows</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_arrows !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_arrows\',this.checked)"><span>Show navigation arrows</span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Dots</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_dots !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_dots\',this.checked)"><span>Show dot indicators</span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Animation</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animation\',this.value)">';
                    html += '<option value="slide"' + (content.animation === 'slide' || !content.animation ? ' selected' : '') + '>Slide</option>';
                    html += '<option value="fade"' + (content.animation === 'fade' ? ' selected' : '') + '>Fade</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Min Height</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.min_height || '400px') + '" placeholder="400px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'min_height\',this.value)"></div>';
                    break;
                case 'video_slider':
                    const vsVideosList = content.videos || [];
                    // Videos Management Header
                    html += '<div class="tb-setting-group" style="display:flex;justify-content:space-between;align-items:center"><div class="tb-setting-label" style="font-weight:600;margin:0">Videos (' + vsVideosList.length + ')</div>';
                    html += '<button type="button" class="tb-btn-small" onclick="TB.addVideoSliderVideo(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')" style="background:#10b981;color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:12px;cursor:pointer">+ Add Video</button></div>';
                    // Helper text for URL formats
                    html += '<div class="tb-setting-group" style="font-size:11px;color:var(--tb-text-muted);margin-top:-8px;margin-bottom:12px">Supports YouTube, Vimeo, and direct video URLs (MP4)</div>';
                    // Individual Videos
                    vsVideosList.forEach((video, videoIdx) => {
                        const videoThumb = video.thumbnail || this.getVideoThumbnail(video.url);
                        html += '<div class="tb-video-item" style="background:var(--tb-bg-elevated);border:1px solid var(--tb-border);border-radius:6px;padding:12px;margin-bottom:12px">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><strong style="font-size:13px">Video ' + (videoIdx + 1) + '</strong>';
                        html += '<div style="display:flex;gap:4px">';
                        if (videoIdx > 0) html += '<button type="button" onclick="TB.moveVideoSliderVideo(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + videoIdx + ',-1)" style="background:var(--tb-bg);border:1px solid var(--tb-border);padding:2px 6px;border-radius:3px;cursor:pointer" title="Move Up">↑</button>';
                        if (videoIdx < vsVideosList.length - 1) html += '<button type="button" onclick="TB.moveVideoSliderVideo(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + videoIdx + ',1)" style="background:var(--tb-bg);border:1px solid var(--tb-border);padding:2px 6px;border-radius:3px;cursor:pointer" title="Move Down">↓</button>';
                        html += '<button type="button" onclick="TB.removeVideoSliderVideo(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + videoIdx + ')" style="background:#ef4444;color:#fff;border:none;padding:2px 6px;border-radius:3px;cursor:pointer" title="Remove">×</button>';
                        html += '</div></div>';
                        // Thumbnail preview
                        if (videoThumb) {
                            html += '<div style="margin-bottom:10px;border-radius:4px;overflow:hidden;position:relative;padding-bottom:56.25%;background:#1e293b">';
                            html += '<img src="' + this.escapeHtml(videoThumb) + '" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover">';
                            html += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;background:rgba(0,0,0,0.6);border-radius:50%;display:flex;align-items:center;justify-content:center">';
                            html += '<span style="color:#fff;font-size:16px;margin-left:2px">▶</span></div></div>';
                        }
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(video.title || '') + '" placeholder="Video title" onchange="TB.updateVideoSliderVideo(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + videoIdx + ',\'title\',this.value)"></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Video URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(video.url || '') + '" placeholder="YouTube, Vimeo, or MP4 URL" onchange="TB.updateVideoSliderVideo(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + videoIdx + ',\'url\',this.value)"></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Custom Thumbnail URL</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(video.thumbnail || '') + '" placeholder="Leave empty to auto-detect from YouTube/Vimeo" onchange="TB.updateVideoSliderVideo(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + videoIdx + ',\'thumbnail\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updateVideoSliderVideo(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + videoIdx + ',\'thumbnail\',url))">📁</button></div></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Description</div><textarea class="tb-setting-input" rows="2" placeholder="Video description (optional)" onchange="TB.updateVideoSliderVideo(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + videoIdx + ',\'description\',this.value)">' + this.escapeHtml(video.description || '') + '</textarea></div>';
                        html += '</div>';
                    });
                    // Layout Settings
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Layout Settings</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Layout</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'layout\',this.value)">';
                    html += '<option value="slider"' + (content.layout === 'slider' || !content.layout ? ' selected' : '') + '>Slider</option>';
                    html += '<option value="grid"' + (content.layout === 'grid' ? ' selected' : '') + '>Grid</option>';
                    html += '<option value="list"' + (content.layout === 'list' ? ' selected' : '') + '>List</option></select></div>';
                    // Grid columns (only shown for grid layout)
                    if (content.layout === 'grid') {
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Columns</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'columns\',parseInt(this.value))">';
                        for (let c = 1; c <= 4; c++) {
                            html += '<option value="' + c + '"' + ((parseInt(content.columns) || 3) === c ? ' selected' : '') + '>' + c + '</option>';
                        }
                        html += '</select></div>';
                    }
                    // Thumbnail settings
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Thumbnails</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_thumbnails !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_thumbnails\',this.checked)"><span>Display thumbnail strip</span></label></div>';
                    if (content.show_thumbnails !== false && content.layout === 'slider') {
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Thumbnail Position</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'thumbnail_position\',this.value)">';
                        html += '<option value="bottom"' + (content.thumbnail_position === 'bottom' || !content.thumbnail_position ? ' selected' : '') + '>Bottom</option>';
                        html += '<option value="left"' + (content.thumbnail_position === 'left' ? ' selected' : '') + '>Left</option>';
                        html += '<option value="right"' + (content.thumbnail_position === 'right' ? ' selected' : '') + '>Right</option>';
                        html += '<option value="none"' + (content.thumbnail_position === 'none' ? ' selected' : '') + '>None</option></select></div>';
                    }
                    // Display options
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Title</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_title !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_title\',this.checked)"><span>Display video title</span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Description</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_description ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_description\',this.checked)"><span>Display video description</span></label></div>';
                    // Slider controls (only for slider layout)
                    if (content.layout === 'slider' || !content.layout) {
                        html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Slider Controls</div></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.autoplay_slider ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'autoplay_slider\',this.checked)"><span>Auto-advance slides</span></label></div>';
                        if (content.autoplay_slider) {
                            html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay Speed (ms)</div><input type="number" class="tb-setting-input" value="' + (content.slider_speed || 5000) + '" min="1000" step="500" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'slider_speed\',parseInt(this.value))"></div>';
                        }
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Arrows</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_arrows !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_arrows\',this.checked)"><span>Show navigation arrows</span></label></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Dots</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_dots !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_dots\',this.checked)"><span>Show dot indicators</span></label></div>';
                    }
                    // Style settings
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Style Settings</div></div>';
                    html += this.renderColorPicker('Play Icon Color', content.play_icon_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'play_icon_color\',VALUE)', '#ffffff');
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Play Icon Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.play_icon_size || '64px') + '" placeholder="64px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'play_icon_size\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Overlay Color</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.overlay_color || 'rgba(0,0,0,0.3)') + '" placeholder="rgba(0,0,0,0.3)" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'overlay_color\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Aspect Ratio</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'aspect_ratio\',this.value)">';
                    html += '<option value="16:9"' + (content.aspect_ratio === '16:9' || !content.aspect_ratio ? ' selected' : '') + '>16:9 (Widescreen)</option>';
                    html += '<option value="4:3"' + (content.aspect_ratio === '4:3' ? ' selected' : '') + '>4:3 (Standard)</option>';
                    html += '<option value="1:1"' + (content.aspect_ratio === '1:1' ? ' selected' : '') + '>1:1 (Square)</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Border Radius</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.border_radius || '8px') + '" placeholder="8px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_radius\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Gap</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.gap || '16px') + '" placeholder="16px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap\',this.value)"></div>';
                    break;
                case 'blog':
                    // Post Settings
                    html += '<div class="tb-setting-group"><div class="tb-setting-label" style="font-weight:600">Post Settings</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Number of Posts</div><input type="number" class="tb-setting-input" value="' + (parseInt(content.posts_count) || 6) + '" min="1" max="24" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'posts_count\',parseInt(this.value))"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Category Filter</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'category\',this.value)">';
                    html += '<option value=""' + (!content.category ? ' selected' : '') + '>All Categories</option>';
                    html += '<option value="news"' + (content.category === 'news' ? ' selected' : '') + '>News</option>';
                    html += '<option value="blog"' + (content.category === 'blog' ? ' selected' : '') + '>Blog</option>';
                    html += '<option value="tutorials"' + (content.category === 'tutorials' ? ' selected' : '') + '>Tutorials</option>';
                    html += '<option value="updates"' + (content.category === 'updates' ? ' selected' : '') + '>Updates</option></select>';
                    html += '<div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Categories are populated from your CMS at render time</div></div>';
                    // Display Options
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Display Options</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Featured Image</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_image !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_image\',this.checked)"><span>Display post thumbnail</span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Excerpt</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_excerpt !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_excerpt\',this.checked)"><span>Display post excerpt</span></label></div>';
                    if (content.show_excerpt !== false) {
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Excerpt Length</div><input type="number" class="tb-setting-input" value="' + (parseInt(content.excerpt_length) || 150) + '" min="50" max="500" step="10" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'excerpt_length\',parseInt(this.value))"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Characters to show</div></div>';
                    }
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Date</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_date !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_date\',this.checked)"><span>Display publish date</span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Author</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_author !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_author\',this.checked)"><span>Display author name</span></label></div>';
                    // Layout Options
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Layout</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Columns</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'columns\',parseInt(this.value))">';
                    for (let c = 1; c <= 4; c++) {
                        html += '<option value="' + c + '"' + ((parseInt(content.columns) || 3) === c ? ' selected' : '') + '>' + c + ' Column' + (c > 1 ? 's' : '') + '</option>';
                    }
                    html += '</select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Gap</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.gap || '30px') + '" placeholder="30px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Card Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'card_style\',this.value)">';
                    html += '<option value="card"' + (content.card_style === 'card' || !content.card_style ? ' selected' : '') + '>Card (with shadow)</option>';
                    html += '<option value="minimal"' + (content.card_style === 'minimal' ? ' selected' : '') + '>Minimal (no border)</option>';
                    html += '<option value="overlay"' + (content.card_style === 'overlay' ? ' selected' : '') + '>Overlay (text on image)</option></select></div>';
                    break;
                case 'post_slider':
                    // Post Slider Content Settings
                    html += '<div class="tb-setting-group"><div class="tb-setting-label" style="font-weight:600">📰 Post Query Settings</div></div>';
                    html += '<div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:6px;padding:10px;margin-bottom:16px;font-size:11px;color:var(--tb-text-muted)">⚡ Posts will be loaded dynamically from your CMS database at render time.</div>';

                    // Post Count
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Number of Posts</div><input type="number" class="tb-setting-input" value="' + (parseInt(content.post_count) || 5) + '" min="1" max="20" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'post_count\',parseInt(this.value))"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Max 20 posts per slider</div></div>';

                    // Category Filter
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Category Filter</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'category\',this.value)">';
                    html += '<option value=""' + (!content.category ? ' selected' : '') + '>All Categories</option>';
                    html += '<option value="news"' + (content.category === 'news' ? ' selected' : '') + '>News</option>';
                    html += '<option value="blog"' + (content.category === 'blog' ? ' selected' : '') + '>Blog</option>';
                    html += '<option value="tutorials"' + (content.category === 'tutorials' ? ' selected' : '') + '>Tutorials</option>';
                    html += '<option value="updates"' + (content.category === 'updates' ? ' selected' : '') + '>Updates</option>';
                    html += '<option value="featured"' + (content.category === 'featured' ? ' selected' : '') + '>Featured</option></select>';
                    html += '<div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Categories populated from CMS at render time</div></div>';

                    // Order By
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Order By</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'order_by\',this.value)">';
                    html += '<option value="date"' + (content.order_by === 'date' || !content.order_by ? ' selected' : '') + '>Date Published</option>';
                    html += '<option value="title"' + (content.order_by === 'title' ? ' selected' : '') + '>Title</option>';
                    html += '<option value="random"' + (content.order_by === 'random' ? ' selected' : '') + '>Random</option>';
                    html += '<option value="views"' + (content.order_by === 'views' ? ' selected' : '') + '>Views/Popularity</option></select></div>';

                    // Order Direction
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Order</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'order\',this.value)">';
                    html += '<option value="desc"' + (content.order === 'desc' || !content.order ? ' selected' : '') + '>Descending (Newest First)</option>';
                    html += '<option value="asc"' + (content.order === 'asc' ? ' selected' : '') + '>Ascending (Oldest First)</option></select></div>';

                    // Include/Exclude IDs Section
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Advanced Filtering</div></div>';

                    // Include Specific IDs
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Include Specific Post IDs</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.include_ids || '') + '" placeholder="e.g., 1, 5, 12, 23" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'include_ids\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Comma-separated post IDs. Leave empty to use category filter.</div></div>';

                    // Exclude IDs
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Exclude Post IDs</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.exclude_ids || '') + '" placeholder="e.g., 3, 7" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'exclude_ids\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Comma-separated post IDs to exclude from results.</div></div>';

                    // Display Options Section
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Display Options</div></div>';

                    // Show Image Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Featured Image</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_image !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_image\',this.checked)"><span>Use featured image as slide background</span></label></div>';

                    // Show Title Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Title</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_title !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_title\',this.checked)"><span>Display post title</span></label></div>';

                    // Show Meta Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Meta Info</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_meta !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_meta\',this.checked)"><span>Display date, author, and category</span></label></div>';

                    // Show Excerpt Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Excerpt</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_excerpt !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_excerpt\',this.checked)"><span>Display post excerpt</span></label></div>';

                    // Excerpt Length (conditional)
                    if (content.show_excerpt !== false) {
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Excerpt Length</div><input type="number" class="tb-setting-input" value="' + (parseInt(content.excerpt_length) || 150) + '" min="50" max="500" step="10" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'excerpt_length\',parseInt(this.value))"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Characters to show</div></div>';
                    }

                    // Show Read More Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Read More Button</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_read_more !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_read_more\',this.checked)"><span>Display read more button</span></label></div>';

                    // Read More Text (conditional)
                    if (content.show_read_more !== false) {
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Read More Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.read_more_text || 'Read More') + '" placeholder="Read More" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'read_more_text\',this.value)"></div>';
                    }

                    // Slider Settings Section
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Slider Settings</div></div>';

                    // Autoplay Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.autoplay !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'autoplay\',this.checked)"><span>Enable autoplay</span></label></div>';

                    // Autoplay Speed (conditional)
                    if (content.autoplay !== false) {
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay Speed (ms)</div><input type="number" class="tb-setting-input" value="' + (parseInt(content.autoplay_speed) || 5000) + '" min="1000" max="15000" step="500" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'autoplay_speed\',parseInt(this.value))"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Time between slides (1000-15000ms)</div></div>';
                    }

                    // Show Arrows Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Navigation Arrows</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_arrows !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_arrows\',this.checked)"><span>Display prev/next arrows</span></label></div>';

                    // Show Dots Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Dot Indicators</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_dots !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_dots\',this.checked)"><span>Display navigation dots</span></label></div>';

                    // Parallax Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Parallax Effect</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.parallax ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'parallax\',this.checked)"><span>Enable parallax scrolling effect</span></label></div>';

                    // Use Background Image Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Use Featured Image as Background</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.use_bg_image !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'use_bg_image\',this.checked)"><span>Use post featured image as slide background</span></label></div>';

                    // Visual Style Section
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Visual Style</div></div>';

                    // Min Height
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Minimum Height</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.min_height || '500px') + '" placeholder="500px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'min_height\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">e.g., 500px, 80vh</div></div>';

                    // Background Overlay Color
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Background Overlay</div><div style="display:flex;gap:8px;align-items:center">';
                    html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (content.background_overlay ? content.background_overlay.replace(/rgba?\([^)]+\)/, '#000000') : '#000000') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_overlay\',\'rgba(0,0,0,\' + (parseFloat(document.querySelector(\'[data-overlay-opacity-\' + ' + sIdx + ' + \'-\' + ' + rIdx + ' + \'-\' + ' + cIdx + ' + \'-\' + ' + mIdx + '+ \']\')?.value || 0.4) + \')\')">';
                    html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(content.background_overlay || 'rgba(0,0,0,0.4)') + '" placeholder="rgba(0,0,0,0.4)" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_overlay\',this.value)">';
                    html += '</div><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Use rgba() for transparency, e.g., rgba(0,0,0,0.4)</div></div>';

                    // Text Color
                    html += this.renderColorPicker('Text Color', content.text_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_color\',VALUE)', '#ffffff');

                    // Title Size
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title Font Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title_size || '36px') + '" placeholder="36px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_size\',this.value)"></div>';

                    // Content Width
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Content Max Width</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.content_width || '800px') + '" placeholder="800px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'content_width\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Controls how wide the text content area is</div></div>';

                    // Text Alignment
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Text Alignment</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_alignment\',this.value)">';
                    html += '<option value="left"' + (content.text_alignment === 'left' ? ' selected' : '') + '>Left</option>';
                    html += '<option value="center"' + (content.text_alignment === 'center' || !content.text_alignment ? ' selected' : '') + '>Center</option>';
                    html += '<option value="right"' + (content.text_alignment === 'right' ? ' selected' : '') + '>Right</option></select></div>';
                    break;
                case 'post_title':
                    // Post Title - Dynamic post/page title with meta information
                    html += '<div class="tb-setting-group"><div class="tb-setting-label" style="font-weight:600">📝 Post Title Settings</div></div>';
                    html += '<div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:6px;padding:10px;margin-bottom:16px;font-size:11px;color:var(--tb-text-muted)">⚡ Content pulled dynamically from the current post/page when rendered.</div>';

                    // Display Options Section
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Display Options</div></div>';

                    // Show Title Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Title</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_title !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_title\',this.checked)"><span>Display post/page title</span></label></div>';

                    // Show Meta Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Meta Info</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_meta !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_meta\',this.checked)"><span>Display meta information below title</span></label></div>';

                    // Meta Items (conditional on show_meta)
                    if (content.show_meta !== false) {
                        html += '<div style="margin-left:16px;padding-left:12px;border-left:2px solid var(--tb-border)">';

                        // Show Author Toggle
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Author</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_author !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_author\',this.checked)"><span>Display author name</span></label></div>';

                        // Show Date Toggle
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Date</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_date !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_date\',this.checked)"><span>Display publish date</span></label></div>';

                        // Show Categories Toggle
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Categories</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_categories !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_categories\',this.checked)"><span>Display post categories</span></label></div>';

                        // Show Comments Count Toggle
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Comments Count</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_comments_count !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_comments_count\',this.checked)"><span>Display comment count</span></label></div>';

                        html += '</div>';
                    }

                    // Featured Image Section
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Featured Image</div></div>';

                    // Show Featured Image Toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Featured Image</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_featured_image !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_featured_image\',this.checked)"><span>Display featured image</span></label></div>';

                    // Featured Image Placement (conditional)
                    if (content.show_featured_image !== false) {
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Image Placement</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'featured_image_placement\',this.value)">';
                        html += '<option value="background"' + (content.featured_image_placement === 'background' || !content.featured_image_placement ? ' selected' : '') + '>Background (fullwidth with overlay)</option>';
                        html += '<option value="above"' + (content.featured_image_placement === 'above' ? ' selected' : '') + '>Above Title</option>';
                        html += '<option value="below"' + (content.featured_image_placement === 'below' ? ' selected' : '') + '>Below Title</option>';
                        html += '<option value="none"' + (content.featured_image_placement === 'none' ? ' selected' : '') + '>Hidden (use settings only)</option></select></div>';
                    }

                    // Format Section
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Formatting</div></div>';

                    // Date Format
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Date Format</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.date_format || 'M d, Y') + '" placeholder="M d, Y" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'date_format\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">PHP date format: M d, Y = Jan 15, 2025 | F j, Y = January 15, 2025</div></div>';

                    // Meta Separator
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Meta Separator</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.meta_separator || '|') + '" placeholder="|" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'meta_separator\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Character between meta items (e.g., | • /)</div></div>';

                    // Title Heading Level
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title Heading Level</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_level\',this.value)">';
                    html += '<option value="h1"' + (content.title_level === 'h1' || !content.title_level ? ' selected' : '') + '>H1 (Recommended for single posts)</option>';
                    html += '<option value="h2"' + (content.title_level === 'h2' ? ' selected' : '') + '>H2</option>';
                    html += '<option value="h3"' + (content.title_level === 'h3' ? ' selected' : '') + '>H3</option>';
                    html += '<option value="h4"' + (content.title_level === 'h4' ? ' selected' : '') + '>H4</option>';
                    html += '<option value="h5"' + (content.title_level === 'h5' ? ' selected' : '') + '>H5</option>';
                    html += '<option value="h6"' + (content.title_level === 'h6' ? ' selected' : '') + '>H6</option></select></div>';

                    // Visual Style Section
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Visual Style</div></div>';

                    // Title Size
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title Font Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title_size || '42px') + '" placeholder="42px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_size\',this.value)"></div>';

                    // Title Color
                    html += this.renderColorPicker('Title Color', content.title_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_color\',VALUE)', '#1e293b');

                    // Meta Size
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Meta Font Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.meta_size || '14px') + '" placeholder="14px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'meta_size\',this.value)"></div>';

                    // Meta Color
                    html += this.renderColorPicker('Meta Color', content.meta_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'meta_color\',VALUE)', '#64748b');

                    // Text Alignment
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Text Alignment</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_alignment\',this.value)">';
                    html += '<option value="left"' + (content.text_alignment === 'left' || !content.text_alignment ? ' selected' : '') + '>Left</option>';
                    html += '<option value="center"' + (content.text_alignment === 'center' ? ' selected' : '') + '>Center</option>';
                    html += '<option value="right"' + (content.text_alignment === 'right' ? ' selected' : '') + '>Right</option></select></div>';

                    // Background Image Settings (conditional on background placement)
                    if (content.show_featured_image !== false && content.featured_image_placement === 'background') {
                        html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Background Image Settings</div></div>';

                        // Background Overlay
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Background Overlay</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.background_overlay || 'rgba(0,0,0,0.5)') + '" placeholder="rgba(0,0,0,0.5)" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_overlay\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Use rgba() for transparency</div></div>';

                        // Text Color on Image
                        html += this.renderColorPicker('Text Color on Image', content.text_on_image_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_on_image_color\',VALUE)', '#ffffff');

                        // Min Height
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Minimum Height</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.min_height || '400px') + '" placeholder="400px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'min_height\',this.value)"></div>';

                        // Content Width
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Content Width</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.content_width || '100%') + '" placeholder="100% or 800px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'content_width\',this.value)"></div>';

                        // Padding Top
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Padding Top</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.padding_top || '60px') + '" placeholder="60px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'padding_top\',this.value)"></div>';

                        // Padding Bottom
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Padding Bottom</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.padding_bottom || '60px') + '" placeholder="60px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'padding_bottom\',this.value)"></div>';
                    }
                    break;
                case 'post_content':
                    // Post Content - Dynamic post/page body content
                    html += '<div class="tb-setting-group"><div class="tb-setting-label" style="font-weight:600">📄 Post Content Settings</div></div>';
                    html += '<div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:6px;padding:10px;margin-bottom:16px;font-size:11px;color:var(--tb-text-muted)">⚡ This module displays the content of the current post or page dynamically.</div>';

                    html += '<div style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:6px;padding:12px;margin-bottom:16px">';
                    html += '<div style="font-weight:600;margin-bottom:8px;font-size:12px">📝 How It Works</div>';
                    html += '<ul style="font-size:11px;color:var(--tb-text-muted);margin:0;padding-left:16px">';
                    html += '<li style="margin-bottom:4px">Content is pulled dynamically from the current post/page</li>';
                    html += '<li style="margin-bottom:4px">Style the content using the <strong>Design</strong> tab</li>';
                    html += '<li style="margin-bottom:4px">Preview shows sample content for visual reference</li>';
                    html += '<li>Supports headings, paragraphs, lists, quotes, code blocks, and images</li>';
                    html += '</ul></div>';

                    html += '<div style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:6px;padding:12px">';
                    html += '<div style="font-weight:600;margin-bottom:8px;font-size:12px">🎨 Styling Tips</div>';
                    html += '<ul style="font-size:11px;color:var(--tb-text-muted);margin:0;padding-left:16px">';
                    html += '<li style="margin-bottom:4px">Use the Design tab to customize typography and colors</li>';
                    html += '<li style="margin-bottom:4px">Adjust max width to control content readability</li>';
                    html += '<li style="margin-bottom:4px">Choose blockquote styles: border, background, or italic</li>';
                    html += '<li style="margin-bottom:4px">Enable dropcap for an elegant first letter style</li>';
                    html += '<li>Customize list markers: disc, circle, square, check, or arrow</li>';
                    html += '</ul></div>';
                    break;
                case 'portfolio':
                    // Portfolio Items Management
                    const portfolioItemsList = content.items || [];
                    html += '<div class="tb-setting-group" style="display:flex;justify-content:space-between;align-items:center"><div class="tb-setting-label" style="font-weight:600;margin:0">Portfolio Items (' + portfolioItemsList.length + ')</div>';
                    html += '<button type="button" class="tb-btn-small" onclick="TB.addPortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')" style="background:#10b981;color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:12px;cursor:pointer">+ Add Item</button></div>';
                    // Individual Items
                    portfolioItemsList.forEach((item, itemIdx) => {
                        html += '<div class="tb-portfolio-item" style="background:var(--tb-bg-elevated);border:1px solid var(--tb-border);border-radius:6px;padding:12px;margin-bottom:12px">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><strong style="font-size:13px">Item ' + (itemIdx + 1) + '</strong>';
                        html += '<div style="display:flex;gap:4px">';
                        if (itemIdx > 0) html += '<button type="button" onclick="TB.movePortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',-1)" style="background:var(--tb-bg);border:1px solid var(--tb-border);padding:2px 6px;border-radius:3px;cursor:pointer" title="Move Up">↑</button>';
                        if (itemIdx < portfolioItemsList.length - 1) html += '<button type="button" onclick="TB.movePortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',1)" style="background:var(--tb-bg);border:1px solid var(--tb-border);padding:2px 6px;border-radius:3px;cursor:pointer" title="Move Down">↓</button>';
                        html += '<button type="button" onclick="TB.removePortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ')" style="background:#ef4444;color:#fff;border:none;padding:2px 6px;border-radius:3px;cursor:pointer" title="Remove">×</button>';
                        html += '</div></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(item.title || '') + '" placeholder="Project title" onchange="TB.updatePortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'title\',this.value)"></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Category</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(item.category || '') + '" placeholder="Web Design, Branding, etc." onchange="TB.updatePortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'category\',this.value)"></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Image URL</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(item.image || '') + '" placeholder="https://..." onchange="TB.updatePortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'image\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updatePortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'image\',url))">📁</button></div></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Link URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(item.link || '#') + '" placeholder="https://..." onchange="TB.updatePortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'link\',this.value)"></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Description</div><textarea class="tb-setting-input" rows="2" placeholder="Project description..." onchange="TB.updatePortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'description\',this.value)">' + this.escapeHtml(item.description || '') + '</textarea></div>';
                        html += '</div>';
                    });
                    // Filter Settings
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Filter Settings</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Filters</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_filters !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_filters\',this.checked)"><span>Display category filter buttons</span></label></div>';
                    if (content.show_filters !== false) {
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">"All" Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.filter_all_text || 'All') + '" placeholder="All" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_all_text\',this.value)"></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Filter Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_style\',this.value)">';
                        html += '<option value="buttons"' + (content.filter_style === 'buttons' || !content.filter_style ? ' selected' : '') + '>Buttons</option>';
                        html += '<option value="dropdown"' + (content.filter_style === 'dropdown' ? ' selected' : '') + '>Dropdown</option>';
                        html += '<option value="tabs"' + (content.filter_style === 'tabs' ? ' selected' : '') + '>Tabs</option></select></div>';
                        html += this.renderColorPicker('Filter Active Color', content.filter_active_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_active_color\',VALUE)', '#0073e6');
                    }
                    // Layout Settings
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Layout</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Layout Type</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'layout\',this.value)">';
                    html += '<option value="grid"' + (content.layout === 'grid' || !content.layout ? ' selected' : '') + '>Grid</option>';
                    html += '<option value="masonry"' + (content.layout === 'masonry' ? ' selected' : '') + '>Masonry</option>';
                    html += '<option value="carousel"' + (content.layout === 'carousel' ? ' selected' : '') + '>Carousel</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Columns (Desktop)</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'columns\',parseInt(this.value))">';
                    for (let c = 1; c <= 6; c++) {
                        html += '<option value="' + c + '"' + ((parseInt(content.columns) || 3) === c ? ' selected' : '') + '>' + c + '</option>';
                    }
                    html += '</select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Columns (Tablet)</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'columns_tablet\',parseInt(this.value))">';
                    for (let c = 1; c <= 4; c++) {
                        html += '<option value="' + c + '"' + ((parseInt(content.columns_tablet) || 2) === c ? ' selected' : '') + '>' + c + '</option>';
                    }
                    html += '</select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Columns (Mobile)</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'columns_mobile\',parseInt(this.value))">';
                    for (let c = 1; c <= 2; c++) {
                        html += '<option value="' + c + '"' + ((parseInt(content.columns_mobile) || 1) === c ? ' selected' : '') + '>' + c + '</option>';
                    }
                    html += '</select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Gap</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.gap || '20px') + '" placeholder="20px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Aspect Ratio</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'aspect_ratio\',this.value)">';
                    html += '<option value="1:1"' + (content.aspect_ratio === '1:1' ? ' selected' : '') + '>1:1 (Square)</option>';
                    html += '<option value="4:3"' + (content.aspect_ratio === '4:3' || !content.aspect_ratio ? ' selected' : '') + '>4:3</option>';
                    html += '<option value="16:9"' + (content.aspect_ratio === '16:9' ? ' selected' : '') + '>16:9 (Widescreen)</option>';
                    html += '<option value="3:2"' + (content.aspect_ratio === '3:2' ? ' selected' : '') + '>3:2</option>';
                    html += '<option value="auto"' + (content.aspect_ratio === 'auto' ? ' selected' : '') + '>Auto</option></select></div>';
                    // Display Options
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Display Options</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Hover Effect</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'hover_effect\',this.value)">';
                    html += '<option value="fade"' + (content.hover_effect === 'fade' || !content.hover_effect ? ' selected' : '') + '>Fade</option>';
                    html += '<option value="slide"' + (content.hover_effect === 'slide' ? ' selected' : '') + '>Slide Up</option>';
                    html += '<option value="zoom"' + (content.hover_effect === 'zoom' ? ' selected' : '') + '>Zoom</option>';
                    html += '<option value="none"' + (content.hover_effect === 'none' ? ' selected' : '') + '>None</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Title</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_title !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_title\',this.checked)"><span>Display project title</span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Category</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_category !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_category\',this.checked)"><span>Display project category</span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Description</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_description ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_description\',this.checked)"><span>Display project description</span></label></div>';
                    // Style Options
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Style</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Overlay Color</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.overlay_color || 'rgba(0, 0, 0, 0.7)') + '" placeholder="rgba(0, 0, 0, 0.7)" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'overlay_color\',this.value)"></div>';
                    html += this.renderColorPicker('Title Color', content.title_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_color\',VALUE)', '#ffffff');
                    html += this.renderColorPicker('Category Color', content.category_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'category_color\',VALUE)', '#94a3b8');
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Border Radius</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.border_radius || '8px') + '" placeholder="8px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_radius\',this.value)"></div>';
                    break;
                case 'team':
                    // Member Info
                    html += '<div class="tb-setting-group"><div class="tb-setting-label" style="font-weight:600">Member Info</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Photo</div><div style="display:flex;gap:8px;align-items:center">';
                    if (content.image) {
                        html += '<img src="' + this.escapeHtml(content.image) + '" style="width:48px;height:48px;border-radius:50%;object-fit:cover">';
                    } else {
                        html += '<div style="width:48px;height:48px;border-radius:50%;background:#e2e8f0;display:flex;align-items:center;justify-content:center">👤</div>';
                    }
                    html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(content.image || '') + '" placeholder="Image URL" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'image\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'image\',url))">📁</button>';
                    html += '</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Name</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.name || '') + '" placeholder="John Doe" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'name\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Role / Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.role || '') + '" placeholder="CEO & Founder" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'role\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Bio</div><textarea class="tb-setting-input" rows="3" placeholder="A short biography..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'bio\',this.value)">' + this.escapeHtml(content.bio || '') + '</textarea></div>';
                    // Social Links
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600;display:flex;justify-content:space-between;align-items:center">Social Links<button type="button" class="tb-btn tb-btn-sm" onclick="TB.addTeamSocialLink(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add</button></div></div>';
                    const socialLinks = content.social || [];
                    socialLinks.forEach((link, linkIdx) => {
                        html += '<div class="tb-setting-group" style="background:#f8fafc;padding:12px;border-radius:8px;margin-bottom:8px">';
                        html += '<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">';
                        html += '<select class="tb-setting-input" style="flex:0 0 120px" onchange="TB.updateTeamSocialLink(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + linkIdx + ',\'platform\',this.value)">';
                        const platforms = ['linkedin', 'twitter', 'facebook', 'instagram', 'github', 'youtube', 'email', 'website'];
                        platforms.forEach(p => {
                            html += '<option value="' + p + '"' + (link.platform === p ? ' selected' : '') + '>' + p.charAt(0).toUpperCase() + p.slice(1) + '</option>';
                        });
                        html += '</select>';
                        html += '<button type="button" class="tb-btn tb-btn-sm" style="background:#ef4444;color:#fff" onclick="TB.removeTeamSocialLink(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + linkIdx + ')">×</button>';
                        html += '</div>';
                        html += '<input type="text" class="tb-setting-input" value="' + this.escapeHtml(link.url || '') + '" placeholder="https://..." onchange="TB.updateTeamSocialLink(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + linkIdx + ',\'url\',this.value)">';
                        html += '</div>';
                    });
                    if (socialLinks.length === 0) {
                        html += '<div style="font-size:11px;color:var(--tb-text-muted)">No social links added yet</div>';
                    }
                    // Style Options
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600">Style</div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Card Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)">';
                    html += '<option value="card"' + (content.style === 'card' || !content.style ? ' selected' : '') + '>Card</option>';
                    html += '<option value="minimal"' + (content.style === 'minimal' ? ' selected' : '') + '>Minimal</option>';
                    html += '<option value="circular"' + (content.style === 'circular' ? ' selected' : '') + '>Circular Photo</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Image Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.image_size || '200px') + '" placeholder="200px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'image_size\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Alignment</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'alignment\',this.value)">';
                    html += '<option value="left"' + (content.alignment === 'left' ? ' selected' : '') + '>Left</option>';
                    html += '<option value="center"' + (content.alignment === 'center' || !content.alignment ? ' selected' : '') + '>Center</option>';
                    html += '<option value="right"' + (content.alignment === 'right' ? ' selected' : '') + '>Right</option></select></div>';
                    break;
                case 'countdown':
                    // Timer Settings
                    html += '<div class="tb-settings-section-title">Timer Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Target Date/Time</div><input type="datetime-local" class="tb-setting-input" value="' + this.escapeHtml(content.target_date || '') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'target_date\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || 'Event Starts In') + '" placeholder="Event Starts In" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Expired Message</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.expired_message || 'Event has started!') + '" placeholder="Event has started!" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'expired_message\',this.value)"></div>';

                    // Display Options
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Display Options</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Days</div><label class="tb-checkbox-label"><input type="checkbox" ' + (content.show_days !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_days\',this.checked)"> Display days unit</label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Hours</div><label class="tb-checkbox-label"><input type="checkbox" ' + (content.show_hours !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_hours\',this.checked)"> Display hours unit</label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Minutes</div><label class="tb-checkbox-label"><input type="checkbox" ' + (content.show_minutes !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_minutes\',this.checked)"> Display minutes unit</label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Seconds</div><label class="tb-checkbox-label"><input type="checkbox" ' + (content.show_seconds !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_seconds\',this.checked)"> Display seconds unit</label></div>';

                    // Style Options
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Style Options</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Display Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)">';
                    html += '<option value="boxes"' + (content.style === 'boxes' || !content.style ? ' selected' : '') + '>Boxes</option>';
                    html += '<option value="circles"' + (content.style === 'circles' ? ' selected' : '') + '>Circles</option>';
                    html += '<option value="minimal"' + (content.style === 'minimal' ? ' selected' : '') + '>Minimal</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Number Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.number_size || '48px') + '" placeholder="48px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'number_size\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Label Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.label_size || '14px') + '" placeholder="14px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'label_size\',this.value)"></div>';
                    break;
                case 'counter':
                    // Counter Settings
                    html += '<div class="tb-settings-section-title">Counter Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Number</div><input type="number" class="tb-setting-input" value="' + (content.number || 100) + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'number\',parseInt(this.value)||0)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Prefix</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.prefix || '') + '" placeholder="e.g. $" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'prefix\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Suffix</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.suffix || '+') + '" placeholder="e.g. +" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'suffix\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title/Label</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || 'Happy Clients') + '" placeholder="Happy Clients" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';

                    // Style Options
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Style Options</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Number Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.number_size || '64px') + '" placeholder="64px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'number_size\',this.value)"></div>';
                    html += this.renderColorPicker('Number Color', content.number_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'number_color\',VALUE)', '#0073e6');
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title_size || '18px') + '" placeholder="18px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_size\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Animation Duration (ms)</div><input type="number" class="tb-setting-input" value="' + (content.animation_duration || 2000) + '" placeholder="2000" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animation_duration\',parseInt(this.value)||2000)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Alignment</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'alignment\',this.value)">';
                    html += '<option value="left"' + (content.alignment === 'left' ? ' selected' : '') + '>Left</option>';
                    html += '<option value="center"' + (content.alignment === 'center' || !content.alignment ? ' selected' : '') + '>Center</option>';
                    html += '<option value="right"' + (content.alignment === 'right' ? ' selected' : '') + '>Right</option></select></div>';
                    break;
                case 'form':
                    // Form Settings
                    html += '<div class="tb-settings-section-title">Form Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Form Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || 'Get In Touch') + '" placeholder="Get In Touch" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Submit Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.submit_text || 'Send Message') + '" placeholder="Send Message" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'submit_text\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Success Message</div><textarea class="tb-setting-input" rows="2" placeholder="Thank you! Your message has been sent." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'success_message\',this.value)">' + this.escapeHtml(content.success_message || 'Thank you! Your message has been sent.') + '</textarea></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Recipient Email</div><input type="email" class="tb-setting-input" value="' + this.escapeHtml(content.recipient_email || '') + '" placeholder="your@email.com" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'recipient_email\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Form submissions will be sent here</div></div>';

                    // Form Fields Section
                    html += '<div class="tb-settings-section-title" style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">Form Fields (' + (content.fields || []).length + ')<button type="button" class="tb-btn tb-btn-sm" style="background:#10b981;color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:12px;cursor:pointer" onclick="TB.addFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Field</button></div>';

                    const formFieldsList = content.fields || [];
                    formFieldsList.forEach((field, fieldIdx) => {
                        const fieldType = field.type || 'text';
                        const fieldLabel = field.label || 'Field ' + (fieldIdx + 1);
                        const fieldPlaceholder = field.placeholder || '';
                        const fieldRequired = field.required || false;

                        html += '<div class="tb-form-field-item" style="background:var(--tb-bg);border:1px solid var(--tb-border);border-radius:8px;padding:12px;margin-bottom:10px">';

                        // Field header with controls
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
                        html += '<strong style="font-size:12px;color:var(--tb-text)">' + this.escapeHtml(fieldLabel) + '</strong>';
                        html += '<div style="display:flex;gap:4px">';
                        if (fieldIdx > 0) html += '<button type="button" onclick="TB.moveFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + fieldIdx + ',-1)" style="background:var(--tb-surface-2);border:1px solid var(--tb-border);padding:2px 6px;border-radius:3px;cursor:pointer;color:var(--tb-text)" title="Move Up">↑</button>';
                        if (fieldIdx < formFieldsList.length - 1) html += '<button type="button" onclick="TB.moveFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + fieldIdx + ',1)" style="background:var(--tb-surface-2);border:1px solid var(--tb-border);padding:2px 6px;border-radius:3px;cursor:pointer;color:var(--tb-text)" title="Move Down">↓</button>';
                        html += '<button type="button" onclick="TB.removeFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + fieldIdx + ')" style="background:#ef4444;color:#fff;border:none;padding:2px 6px;border-radius:3px;cursor:pointer" title="Remove">×</button>';
                        html += '</div></div>';

                        // Field type selector
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label" style="font-size:11px">Field Type</div>';
                        html += '<select class="tb-setting-input" style="font-size:12px" onchange="TB.updateFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + fieldIdx + ',\'type\',this.value)">';
                        const fieldTypes = [
                            { value: 'text', label: 'Text' },
                            { value: 'email', label: 'Email' },
                            { value: 'tel', label: 'Phone' },
                            { value: 'number', label: 'Number' },
                            { value: 'textarea', label: 'Textarea' },
                            { value: 'select', label: 'Dropdown' },
                            { value: 'checkbox', label: 'Checkbox' },
                            { value: 'date', label: 'Date' },
                            { value: 'url', label: 'URL' }
                        ];
                        fieldTypes.forEach(ft => {
                            html += '<option value="' + ft.value + '"' + (fieldType === ft.value ? ' selected' : '') + '>' + ft.label + '</option>';
                        });
                        html += '</select></div>';

                        // Field label
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label" style="font-size:11px">Label</div>';
                        html += '<input type="text" class="tb-setting-input" style="font-size:12px" value="' + this.escapeHtml(fieldLabel) + '" placeholder="Field label" onchange="TB.updateFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + fieldIdx + ',\'label\',this.value)"></div>';

                        // Field placeholder
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label" style="font-size:11px">Placeholder</div>';
                        html += '<input type="text" class="tb-setting-input" style="font-size:12px" value="' + this.escapeHtml(fieldPlaceholder) + '" placeholder="Placeholder text" onchange="TB.updateFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + fieldIdx + ',\'placeholder\',this.value)"></div>';

                        // Options for select field type
                        if (fieldType === 'select') {
                            const fieldOptions = field.options || ['Option 1', 'Option 2', 'Option 3'];
                            html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label" style="font-size:11px">Options (one per line)</div>';
                            html += '<textarea class="tb-setting-input" style="font-size:12px" rows="3" placeholder="Option 1&#10;Option 2&#10;Option 3" onchange="TB.updateFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + fieldIdx + ',\'options\',this.value.split(\'\\n\').filter(o=>o.trim()))">' + this.escapeHtml(fieldOptions.join('\n')) + '</textarea></div>';
                        }

                        // Required checkbox
                        html += '<div class="tb-setting-group" style="margin-bottom:0"><label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px"><input type="checkbox" ' + (fieldRequired ? 'checked' : '') + ' onchange="TB.updateFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + fieldIdx + ',\'required\',this.checked)"><span style="color:var(--tb-text-muted)">Required field</span></label></div>';

                        html += '</div>';
                    });

                    if (formFieldsList.length === 0) {
                        html += '<div style="text-align:center;padding:20px;color:var(--tb-text-muted);font-size:12px;background:var(--tb-bg);border-radius:8px;border:1px dashed var(--tb-border)">No fields added yet. Click "Add Field" to start.</div>';
                    }

                    // Design Options
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Design Options</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Form Layout</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)">';
                    html += '<option value="stacked"' + (content.style === 'stacked' || !content.style ? ' selected' : '') + '>Stacked (Vertical)</option>';
                    html += '<option value="inline"' + (content.style === 'inline' ? ' selected' : '') + '>Inline (Horizontal)</option></select></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_style\',this.value)">';
                    html += '<option value="primary"' + (content.button_style === 'primary' || !content.button_style ? ' selected' : '') + '>Primary (Blue)</option>';
                    html += '<option value="secondary"' + (content.button_style === 'secondary' ? ' selected' : '') + '>Secondary (Gray)</option>';
                    html += '<option value="success"' + (content.button_style === 'success' ? ' selected' : '') + '>Success (Green)</option>';
                    html += '<option value="outline"' + (content.button_style === 'outline' ? ' selected' : '') + '>Outline</option></select></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Full Width</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.button_full_width ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_full_width\',this.checked)"><span style="color:var(--tb-text-muted);font-size:12px">Make button full width</span></label></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Label Position</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'label_position\',this.value)">';
                    html += '<option value="top"' + (content.label_position === 'top' || !content.label_position ? ' selected' : '') + '>Above Field</option>';
                    html += '<option value="floating"' + (content.label_position === 'floating' ? ' selected' : '') + '>Floating Label</option>';
                    html += '<option value="hidden"' + (content.label_position === 'hidden' ? ' selected' : '') + '>Hidden (Placeholder Only)</option></select></div>';
                    break;
                case 'login':
                    // Login Form Settings
                    html += '<div class="tb-settings-section-title">Form Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Form Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || 'Login') + '" placeholder="Login" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';

                    // Username field settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Username/Email Field</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Label</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.username_label || 'Username or Email') + '" placeholder="Username or Email" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'username_label\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Placeholder</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.username_placeholder || 'Enter your username or email') + '" placeholder="Enter your username or email" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'username_placeholder\',this.value)"></div>';

                    // Password field settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Password Field</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Label</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.password_label || 'Password') + '" placeholder="Password" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'password_label\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Placeholder</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.password_placeholder || 'Enter your password') + '" placeholder="Enter your password" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'password_placeholder\',this.value)"></div>';

                    // Submit button
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Submit Button</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.submit_text || 'Log In') + '" placeholder="Log In" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'submit_text\',this.value)"></div>';

                    // Remember me
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Remember Me</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Remember Me</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_remember\',this.value===\'true\')"><option value="true"' + (content.show_remember !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.show_remember === false ? ' selected' : '') + '>No</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Label</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.remember_label || 'Remember Me') + '" placeholder="Remember Me" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'remember_label\',this.value)"></div>';

                    // Forgot password
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Forgot Password Link</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Forgot Password</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_forgot\',this.value===\'true\')"><option value="true"' + (content.show_forgot !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.show_forgot === false ? ' selected' : '') + '>No</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Link Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.forgot_text || 'Forgot Password?') + '" placeholder="Forgot Password?" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'forgot_text\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Link URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.forgot_url || '/forgot-password') + '" placeholder="/forgot-password" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'forgot_url\',this.value)"></div>';

                    // Register link
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Register Link</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Register Link</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_register\',this.value===\'true\')"><option value="true"' + (content.show_register !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.show_register === false ? ' selected' : '') + '>No</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Link Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.register_text || 'Create an Account') + '" placeholder="Create an Account" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'register_text\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Link URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.register_url || '/register') + '" placeholder="/register" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'register_url\',this.value)"></div>';

                    // Redirect URL
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">After Login</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Redirect URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.redirect_url || '/dashboard') + '" placeholder="/dashboard" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'redirect_url\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Where to redirect after successful login</div></div>';

                    // Design Settings (in content tab for convenience like audio module)
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600;color:var(--tb-accent)">🎨 Design Settings</div></div>';

                    // Style selector
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Form Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="default"' + (content.style === 'default' || !content.style ? ' selected' : '') + '>Default</option><option value="card"' + (content.style === 'card' ? ' selected' : '') + '>Card (with shadow)</option><option value="minimal"' + (content.style === 'minimal' ? ' selected' : '') + '>Minimal (no border)</option><option value="split"' + (content.style === 'split' ? ' selected' : '') + '>Split (accent bar)</option></select></div>';

                    // Background color
                    html += this.renderColorPicker('Background Color', content.background_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_color\',VALUE)', '#ffffff');

                    // Input colors
                    html += this.renderColorPicker('Input Background', content.input_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'input_background\',VALUE)', '#f8fafc');

                    html += this.renderColorPicker('Input Border Color', content.input_border_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'input_border_color\',VALUE)', '#e2e8f0');

                    html += this.renderColorPicker('Input Text Color', content.input_text_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'input_text_color\',VALUE)', '#1e293b');

                    // Button colors
                    html += this.renderColorPicker('Button Background', content.button_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_background\',VALUE)', '#0073e6');

                    html += this.renderColorPicker('Button Text Color', content.button_text_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text_color\',VALUE)', '#ffffff');

                    // Label and link colors
                    html += this.renderColorPicker('Label Color', content.label_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'label_color\',VALUE)', '#374151');

                    html += this.renderColorPicker('Link Color', content.link_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'link_color\',VALUE)', '#0073e6');

                    // Border radius
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Border Radius</div><input type="text" class="tb-setting-input" value="' + (content.border_radius || '8px') + '" placeholder="8px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_radius\',this.value)"></div>';
                case 'signup':
                    html += '<div class="tb-settings-section-title">Newsletter Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || 'Subscribe to Newsletter') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Description</div><textarea class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'description\',this.value)">' + this.escapeHtml(content.description || '') + '</textarea></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Email Placeholder</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.email_placeholder || 'Enter your email') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'email_placeholder\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.button_text || 'Subscribe') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Name Field</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_name_field\',this.value===\'true\')"><option value="false"' + (!content.show_name_field ? ' selected' : '') + '>No</option><option value="true"' + (content.show_name_field ? ' selected' : '') + '>Yes</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Success Message</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.success_message || 'Thank you for subscribing!') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'success_message\',this.value)"></div>';
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Design</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Layout Style</div><select class="tb-setting-input" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="inline"' + (design.style === 'inline' || !design.style ? ' selected' : '') + '>Inline</option><option value="stacked"' + (design.style === 'stacked' ? ' selected' : '') + '>Stacked</option><option value="card"' + (design.style === 'card' ? ' selected' : '') + '>Card</option></select></div>';
                    html += this.renderColorPicker('Background Color', design.background_color, 'TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_color\',VALUE)', '#f8fafc');
                    html += this.renderColorPicker('Button Background', design.button_background, 'TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_background\',VALUE)', '#0073e6');
                    break;
                    break;
                case 'fullwidth_code':
                    html += '<div class="tb-settings-section-title">Code Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Language</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'language\',this.value)"><option value="javascript"' + (content.language === 'javascript' || !content.language ? ' selected' : '') + '>JavaScript</option><option value="php"' + (content.language === 'php' ? ' selected' : '') + '>PHP</option><option value="html"' + (content.language === 'html' ? ' selected' : '') + '>HTML/CSS</option><option value="python"' + (content.language === 'python' ? ' selected' : '') + '>Python</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Code</div><textarea class="tb-setting-input" style="height:200px;font-family:monospace;font-size:12px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'code\',this.value)">' + this.escapeHtml(content.code || '') + '</textarea></div>';
                    break;
                case 'fullwidth_image':
                    html += '<div class="tb-settings-section-title">Image Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Image URL</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(content.src || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'src\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'src\',url))">📁</button></div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Alt Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.alt || '') + '" placeholder="Image description" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'alt\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Link URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.link || '') + '" placeholder="Optional link" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'link\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Height</div><input type="text" class="tb-setting-input" value="' + (design.height || '400px') + '" placeholder="400px" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'height\',this.value)"></div>';
                    break;
                case 'fullwidth_map':
                    html += '<div class="tb-settings-section-title">Map Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Address</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.address || '') + '" placeholder="Enter address" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'address\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Zoom Level</div><input type="number" class="tb-setting-input" value="' + (content.zoom || 14) + '" min="1" max="20" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'zoom\',parseInt(this.value))"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Height</div><input type="text" class="tb-setting-input" value="' + (design.height || '400px') + '" placeholder="400px" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'height\',this.value)"></div>';
                    break;
                case 'fullwidth_menu':
                    html += '<div class="tb-settings-section-title">Menu Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Logo URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.logo || '') + '" placeholder="Logo image URL" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'logo\',this.value)"></div>';
                    html += this.renderColorPicker('Background Color', design.background_color, 'TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_color\',VALUE)', '#1e1e2e');
                    html += this.renderColorPicker('Text Color', design.text_color, 'TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_color\',VALUE)', '#ffffff');
                    break;
                case 'fullwidth_slider':
                    // Slides Management
                    html += '<div class="tb-settings-section-title">Slides</div>';
                    html += '<div class="tb-setting-group" style="display:flex;justify-content:space-between;align-items:center"><div class="tb-setting-label" style="font-weight:600;margin:0">Slides (' + (content.slides || []).length + ')</div>';
                    html += '<button type="button" class="tb-btn-small" onclick="TB.addFullwidthSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')" style="background:#10b981;color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:12px;cursor:pointer">+ Add Slide</button></div>';
                    
                    const fwSlidesList = content.slides || [];
                    fwSlidesList.forEach((slide, slideIdx) => {
                        html += '<div class="tb-slide-item" style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:8px;padding:12px;margin-bottom:10px">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
                        html += '<strong style="font-size:12px;color:var(--tb-text)">Slide ' + (slideIdx + 1) + '</strong>';
                        html += '<div style="display:flex;gap:4px">';
                        if (slideIdx > 0) html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.moveFullwidthSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',-1)" title="Move Up">↑</button>';
                        if (slideIdx < fwSlidesList.length - 1) html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.moveFullwidthSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',1)" title="Move Down">↓</button>';
                        html += '<button type="button" class="tb-btn tb-btn-sm" style="background:#ef4444;color:#fff" onclick="TB.removeFullwidthSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ')" title="Remove">×</button>';
                        html += '</div></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(slide.title || '') + '" placeholder="Slide title" onchange="TB.updateFullwidthSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',\'title\',this.value)"></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Text</div><textarea class="tb-setting-input" rows="2" placeholder="Slide description" onchange="TB.updateFullwidthSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',\'text\',this.value)">' + this.escapeHtml(slide.text || '') + '</textarea></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Image URL</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(slide.image || '') + '" placeholder="https://..." onchange="TB.updateFullwidthSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',\'image\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updateFullwidthSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',\'image\',url))">📁</button></div></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(slide.button_text || '') + '" placeholder="Learn More" onchange="TB.updateFullwidthSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',\'button_text\',this.value)"></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:0"><div class="tb-setting-label">Button URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(slide.button_url || '#') + '" placeholder="#" onchange="TB.updateFullwidthSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + slideIdx + ',\'button_url\',this.value)"></div>';
                        html += '</div>';
                    });
                    
                    if (fwSlidesList.length === 0) {
                        html += '<div style="font-size:11px;color:var(--tb-text-muted);padding:16px;text-align:center;background:var(--tb-surface-2);border-radius:8px;border:1px dashed var(--tb-border)">No slides added. Click "+ Add Slide" to create one.</div>';
                    }
                    
                    // Design Settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--tb-border)">Slider Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Min Height</div><input type="text" class="tb-setting-input" value="' + (design.min_height || '600px') + '" placeholder="600px" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'min_height\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Overlay Color</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + (design.overlay_color || 'rgba(0,0,0,0.4)') + '" placeholder="rgba(0,0,0,0.4)" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'overlay_color\',this.value)"></div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay</div><select class="tb-setting-input" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'autoplay\',this.value===\'true\')"><option value="true"' + (design.autoplay !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (design.autoplay === false ? ' selected' : '') + '>No</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay Speed (ms)</div><input type="number" class="tb-setting-input" value="' + (design.autoplay_speed || 5000) + '" placeholder="5000" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'autoplay_speed\',parseInt(this.value))"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Arrows</div><select class="tb-setting-input" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_arrows\',this.value===\'true\')"><option value="true"' + (design.show_arrows !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (design.show_arrows === false ? ' selected' : '') + '>No</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Dots</div><select class="tb-setting-input" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_dots\',this.value===\'true\')"><option value="true"' + (design.show_dots !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (design.show_dots === false ? ' selected' : '') + '>No</option></select></div>';
                    break;
                case 'fullwidth_header':
                    html += '<div class="tb-settings-section-title">Header Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || '') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Subtitle</div><textarea class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'subtitle\',this.value)">' + this.escapeHtml(content.subtitle || '') + '</textarea></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.button_text || '') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.button_url || '#') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_url\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Background Image</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(content.background_image || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_image\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_image\',url))">📁</button></div></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Min Height</div><input type="text" class="tb-setting-input" value="' + (design.min_height || '500px') + '" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'min_height\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Text Align</div><select class="tb-setting-input" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_align\',this.value)"><option value="left"' + (design.text_align === 'left' ? ' selected' : '') + '>Left</option><option value="center"' + (design.text_align === 'center' || !design.text_align ? ' selected' : '') + '>Center</option><option value="right"' + (design.text_align === 'right' ? ' selected' : '') + '>Right</option></select></div>';
                    break;
                case 'fullwidth_portfolio':
                    // Portfolio Items Management
                    html += '<div class="tb-settings-section-title">Portfolio Items</div>';
                    html += '<div class="tb-setting-group" style="display:flex;justify-content:space-between;align-items:center"><div class="tb-setting-label" style="font-weight:600;margin:0">Items (' + (content.items || []).length + ')</div>';
                    html += '<button type="button" class="tb-btn-small" onclick="TB.addFullwidthPortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')" style="background:#10b981;color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:12px;cursor:pointer">+ Add Item</button></div>';
                    
                    const fwPortfolioItems = content.items || [];
                    fwPortfolioItems.forEach((item, itemIdx) => {
                        html += '<div class="tb-portfolio-item" style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:8px;padding:12px;margin-bottom:10px">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
                        html += '<strong style="font-size:12px;color:var(--tb-text)">Item ' + (itemIdx + 1) + '</strong>';
                        html += '<div style="display:flex;gap:4px">';
                        if (itemIdx > 0) html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.moveFullwidthPortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',-1)" title="Move Up">↑</button>';
                        if (itemIdx < fwPortfolioItems.length - 1) html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.moveFullwidthPortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',1)" title="Move Down">↓</button>';
                        html += '<button type="button" class="tb-btn tb-btn-sm" style="background:#ef4444;color:#fff" onclick="TB.removeFullwidthPortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ')" title="Remove">×</button>';
                        html += '</div></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(item.title || '') + '" placeholder="Project title" onchange="TB.updateFullwidthPortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'title\',this.value)"></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Category</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(item.category || '') + '" placeholder="Web, Design, etc." onchange="TB.updateFullwidthPortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'category\',this.value)"></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Image URL</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escapeHtml(item.image || '') + '" placeholder="https://..." onchange="TB.updateFullwidthPortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'image\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(url => TB.updateFullwidthPortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'image\',url))">📁</button></div></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:0"><div class="tb-setting-label">Link URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(item.link || '#') + '" placeholder="#" onchange="TB.updateFullwidthPortfolioItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'link\',this.value)"></div>';
                        html += '</div>';
                    });
                    
                    if (fwPortfolioItems.length === 0) {
                        html += '<div style="font-size:11px;color:var(--tb-text-muted);padding:16px;text-align:center;background:var(--tb-surface-2);border-radius:8px;border:1px dashed var(--tb-border)">No items added. Click "+ Add Item" to create one.</div>';
                    }
                    
                    // Design Settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--tb-border)">Portfolio Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Columns</div><select class="tb-setting-input" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'columns\',parseInt(this.value))"><option value="2"' + (design.columns === 2 ? ' selected' : '') + '>2</option><option value="3"' + (design.columns === 3 || !design.columns ? ' selected' : '') + '>3</option><option value="4"' + (design.columns === 4 ? ' selected' : '') + '>4</option><option value="5"' + (design.columns === 5 ? ' selected' : '') + '>5</option><option value="6"' + (design.columns === 6 ? ' selected' : '') + '>6</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Filter</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_filter\',this.value===\'true\')"><option value="true"' + (content.show_filter !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.show_filter === false ? ' selected' : '') + '>No</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Gap</div><input type="text" class="tb-setting-input" value="' + (design.gap || '0') + '" placeholder="0 or 8px" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Hover Effect</div><select class="tb-setting-input" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'hover_effect\',this.value)"><option value="overlay"' + (design.hover_effect === 'overlay' || !design.hover_effect ? ' selected' : '') + '>Overlay</option><option value="zoom"' + (design.hover_effect === 'zoom' ? ' selected' : '') + '>Zoom</option><option value="none"' + (design.hover_effect === 'none' ? ' selected' : '') + '>None</option></select></div>';
                    break;
                case 'fullwidth_post_slider':
                    html += '<div class="tb-settings-section-title">Post Slider Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Posts Count</div><input type="number" class="tb-setting-input" value="' + (content.posts_count || 5) + '" min="1" max="20" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'posts_count\',parseInt(this.value))"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Excerpt</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_excerpt\',this.value===\'true\')"><option value="true"' + (content.show_excerpt !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.show_excerpt === false ? ' selected' : '') + '>No</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Date</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_date\',this.value===\'true\')"><option value="true"' + (content.show_date !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.show_date === false ? ' selected' : '') + '>No</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Author</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_author\',this.value===\'true\')"><option value="true"' + (content.show_author !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.show_author === false ? ' selected' : '') + '>No</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Min Height</div><input type="text" class="tb-setting-input" value="' + (design.min_height || '500px') + '" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'min_height\',this.value)"></div>';
                    break;
                case 'search':
                    // Search Module Content Settings
                    html += '<div class="tb-settings-section-title">Search Settings</div>';

                    // Placeholder text
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Placeholder Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.placeholder || 'Search...') + '" placeholder="Search..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'placeholder\',this.value)"></div>';

                    // Button settings section
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Button Settings</div>';

                    // Show button toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Button</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_button\',this.value===\'true\')"><option value="true"' + (content.show_button !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.show_button === false ? ' selected' : '') + '>No</option></select></div>';

                    // Button text
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.button_text || 'Search') + '" placeholder="Search" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text\',this.value)"></div>';

                    // Button icon only
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Icon Only</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_icon_only\',this.value===\'true\')"><option value="false"' + (content.button_icon_only !== true ? ' selected' : '') + '>No (Text)</option><option value="true"' + (content.button_icon_only === true ? ' selected' : '') + '>Yes (🔍 Only)</option></select><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Display only the search icon instead of text</div></div>';

                    // Search configuration section
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Search Configuration</div>';

                    // Search scope
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Search Scope</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'search_scope\',this.value)"><option value="all"' + ((content.search_scope || 'all') === 'all' ? ' selected' : '') + '>All Content</option><option value="pages"' + (content.search_scope === 'pages' ? ' selected' : '') + '>Pages Only</option><option value="posts"' + (content.search_scope === 'posts' ? ' selected' : '') + '>Blog Posts Only</option><option value="products"' + (content.search_scope === 'products' ? ' selected' : '') + '>Products Only</option></select><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Limit search to specific content types</div></div>';

                    // Results page URL
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Results Page URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.results_page || '/search') + '" placeholder="/search" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'results_page\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">The page where search results will be displayed</div></div>';

                    // Design Settings (in content tab for convenience like login module)
                    html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600;color:var(--tb-accent)">🎨 Design Settings</div></div>';

                    // Style selector
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="default"' + ((content.style || 'default') === 'default' ? ' selected' : '') + '>Default</option><option value="minimal"' + (content.style === 'minimal' ? ' selected' : '') + '>Minimal (no border)</option><option value="rounded"' + (content.style === 'rounded' ? ' selected' : '') + '>Rounded</option><option value="pill"' + (content.style === 'pill' ? ' selected' : '') + '>Pill (full round)</option></select></div>';

                    // Layout
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Layout</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'layout\',this.value)"><option value="inline"' + ((content.layout || 'inline') === 'inline' ? ' selected' : '') + '>Inline (side by side)</option><option value="stacked"' + (content.layout === 'stacked' ? ' selected' : '') + '>Stacked (button below)</option></select></div>';

                    // Button position (only visible when layout is inline and button is shown)
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Position</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_position\',this.value)"><option value="right"' + ((content.button_position || 'right') === 'right' ? ' selected' : '') + '>Outside Right</option><option value="inside"' + (content.button_position === 'inside' ? ' selected' : '') + '>Inside Input</option><option value="below"' + (content.button_position === 'below' ? ' selected' : '') + '>Below Input</option></select></div>';

                    // Show icon toggle
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Search Icon</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_icon\',this.value===\'true\')"><option value="true"' + (content.show_icon !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.show_icon === false ? ' selected' : '') + '>No</option></select><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Show magnifying glass icon inside input</div></div>';

                    // Height
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Height</div><input type="text" class="tb-setting-input" value="' + (content.height || '48px') + '" placeholder="48px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'height\',this.value)"></div>';

                    // Border radius
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Border Radius</div><input type="text" class="tb-setting-input" value="' + (content.border_radius || '8px') + '" placeholder="8px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_radius\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Ignored when style is pill or rounded</div></div>';

                    // Color Settings Section
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Colors</div>';

                    // Input background
                    html += this.renderColorPicker('Input Background', content.input_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'input_background\',VALUE)', '#ffffff');

                    // Input border color
                    html += this.renderColorPicker('Input Border Color', content.input_border_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'input_border_color\',VALUE)', '#e2e8f0');

                    // Input text color
                    html += this.renderColorPicker('Input Text Color', content.input_text_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'input_text_color\',VALUE)', '#1e293b');

                    // Input icon color
                    html += this.renderColorPicker('Search Icon Color', content.input_icon_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'input_icon_color\',VALUE)', '#94a3b8');

                    // Button background
                    html += this.renderColorPicker('Button Background', content.button_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_background\',VALUE)', '#0073e6');

                    // Button text color
                    html += this.renderColorPicker('Button Text Color', content.button_text_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text_color\',VALUE)', '#ffffff');
                    break;
                case 'menu':
                    // Menu Source
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Menu Source</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'menu_source\',this.value)">';
                    html += '<option value="custom"' + (content.menu_source === 'custom' || !content.menu_source ? ' selected' : '') + '>Custom Links</option>';
                    html += '<option value="cms_menu"' + (content.menu_source === 'cms_menu' ? ' selected' : '') + '>CMS Menu</option></select></div>';

                    if (content.menu_source === 'cms_menu') {
                        // CMS Menu selector
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Select CMS Menu</div>';
                        html += '<input type="number" class="tb-setting-input" value="' + (content.cms_menu_id || '') + '" placeholder="Enter Menu ID" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'cms_menu_id\',parseInt(this.value)||null)">';
                        html += '<div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Enter the ID of the CMS navigation menu to display</div></div>';
                    } else {
                        // Custom Links Manager
                        html += '<div class="tb-setting-group" style="display:flex;justify-content:space-between;align-items:center"><div class="tb-setting-label" style="font-weight:600;margin:0">Menu Items</div><button type="button" class="tb-btn tb-btn-sm" style="background:#10b981;color:#fff" onclick="TB.addMenuItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Item</button></div>';

                        const menuItemsList = content.items || [];
                        menuItemsList.forEach((item, itemIdx) => {
                            html += '<div class="tb-setting-group" style="background:var(--tb-surface-2);padding:12px;border-radius:8px;margin-bottom:8px;border:1px solid var(--tb-border)">';
                            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
                            html += '<span style="font-weight:500;font-size:12px;color:var(--tb-text-muted)">Item ' + (itemIdx + 1) + '</span>';
                            html += '<div style="display:flex;gap:4px">';
                            if (itemIdx > 0) html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.moveMenuItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',-1)" title="Move Up">↑</button>';
                            if (itemIdx < menuItemsList.length - 1) html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.moveMenuItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',1)" title="Move Down">↓</button>';
                            html += '<button type="button" class="tb-btn tb-btn-sm" style="background:#ef4444;color:#fff" onclick="TB.removeMenuItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ')" title="Remove">×</button>';
                            html += '</div></div>';
                            html += '<div style="margin-bottom:8px"><div class="tb-setting-label">Label</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(item.label || '') + '" placeholder="Menu item text" onchange="TB.updateMenuItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'label\',this.value)"></div>';
                            html += '<div><div class="tb-setting-label">URL</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(item.url || '') + '" placeholder="/" onchange="TB.updateMenuItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + itemIdx + ',\'url\',this.value)"></div>';
                            html += '</div>';
                        });

                        if (menuItemsList.length === 0) {
                            html += '<div style="font-size:11px;color:var(--tb-text-muted);padding:16px;text-align:center;background:var(--tb-surface-2);border-radius:8px;border:1px dashed var(--tb-border)">No menu items added yet. Click "+ Add Item" to add a link.</div>';
                        }
                    }

                    // Design Settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--tb-border)">Design Options</div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Orientation</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'orientation\',this.value)">';
                    html += '<option value="horizontal"' + (content.orientation === 'horizontal' || !content.orientation ? ' selected' : '') + '>Horizontal</option>';
                    html += '<option value="vertical"' + (content.orientation === 'vertical' ? ' selected' : '') + '>Vertical</option></select></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Alignment</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'alignment\',this.value)">';
                    html += '<option value="left"' + (content.alignment === 'left' ? ' selected' : '') + '>Left</option>';
                    html += '<option value="center"' + (content.alignment === 'center' || !content.alignment ? ' selected' : '') + '>Center</option>';
                    html += '<option value="right"' + (content.alignment === 'right' ? ' selected' : '') + '>Right</option></select></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Gap Between Items</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.gap || '24px') + '" placeholder="24px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap\',this.value)"></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Font Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.font_size || '16px') + '" placeholder="16px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'font_size\',this.value)"></div>';

                    html += this.renderColorPicker('Text Color', content.text_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_color\',VALUE)', '#333333');

                    html += this.renderColorPicker('Hover Color', content.hover_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'hover_color\',VALUE)', '#0073e6');
                    break;
                case 'sidebar':
                    // Sidebar - Widget Area settings
                    html += '<div class="tb-setting-group"><div class="tb-setting-label" style="font-weight:600">📋 Widget Area Configuration</div></div>';
                    html += '<div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:6px;padding:10px;margin-bottom:16px;font-size:11px;color:var(--tb-text-muted)">⚡ Select a CMS widget area to display dynamic widgets. Widgets will be loaded from the CMS widget system.</div>';

                    // Widget Area ID selector
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Widget Area ID</div>';
                    html += '<input type="number" class="tb-setting-input" value="' + (content.widget_area_id || '') + '" placeholder="Enter Widget Area ID" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'widget_area_id\',parseInt(this.value)||null)">';
                    html += '<div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Enter the ID of the CMS widget area to display</div></div>';

                    // Title Settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--tb-border)">Title Settings</div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Title</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_title !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_title\',this.checked)"><span>Display sidebar title</span></label></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || 'Sidebar') + '" placeholder="Sidebar" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';

                    // Design Settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--tb-border)">Design Options</div>';

                    html += this.renderColorPicker('Background Color', content.background_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_color\',VALUE)', '#ffffff');

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Padding</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.padding || '20px') + '" placeholder="20px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'padding\',this.value)"></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Border</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.border || '1px solid #e2e8f0') + '" placeholder="1px solid #e2e8f0" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border\',this.value)"></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Width</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.width || '100%') + '" placeholder="100% or 300px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'width\',this.value)"></div>';
                    break;
                case 'bar_counters':
                    // Bar Counters content settings
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Progress Bars</div></div>';
                    const barItems = content.bars || [];
                    barItems.forEach((bar, i) => {
                        const barLabel = bar.label || 'Skill ' + (i + 1);
                        const barPercent = bar.percent || 0;
                        const barColor = bar.color || '#0073e6';
                        html += '<div style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:6px;padding:12px;margin-bottom:8px;">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><span style="font-weight:500;font-size:12px;">Bar ' + (i + 1) + '</span><div style="display:flex;gap:4px;"><button class="tb-btn" style="padding:4px 6px;font-size:10px" onclick="TB.moveBar(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',-1)">↑</button><button class="tb-btn" style="padding:4px 6px;font-size:10px" onclick="TB.moveBar(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',1)">↓</button><button class="tb-btn" style="padding:4px 6px;font-size:10px;background:var(--tb-danger)" onclick="TB.removeBar(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ')">×</button></div></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Label</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(barLabel) + '" placeholder="Skill name" onchange="TB.updateBar(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'label\',this.value)"></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Percentage (' + barPercent + '%)</div><input type="range" class="tb-setting-input" min="0" max="100" value="' + barPercent + '" oninput="this.previousElementSibling.textContent=\'Percentage (\'+this.value+\'%)\';" onchange="TB.updateBar(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'percent\',parseInt(this.value))"></div>';
                        html += '<div class="tb-setting-group" style="margin-bottom:0"><div class="tb-setting-label">Bar Color</div><div style="display:flex;gap:8px;align-items:center"><input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + barColor + '" onchange="TB.updateBar(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'color\',this.value)"><input type="text" class="tb-setting-input" style="flex:1" value="' + barColor + '" onchange="TB.updateBar(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'color\',this.value)"></div></div>';
                        html += '</div>';
                    });
                    html += '<button class="tb-btn" style="width:100%;margin-bottom:16px" onclick="TB.addBar(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Bar</button>';
                    html += '<button class="tb-btn-ai" style="width:100%" onclick="TB.handleAIGenerate(\'bar_counters\', \'bars\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">✨ AI Generate Skills</button>';

                    // Design settings (in content tab for convenience)
                    html += '<div style="border-top:1px solid var(--tb-border);margin-top:16px;padding-top:16px">';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label" style="font-weight:600;color:var(--tb-accent)">Bar Style</div></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Bar Height</div><input type="text" class="tb-setting-input" value="' + (content.bar_height || '20px') + '" placeholder="20px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'bar_height\',this.value)"></div>';

                    html += this.renderColorPicker('Background Color', content.bar_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'bar_background\',VALUE)', '#e2e8f0');

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Border Radius</div><input type="text" class="tb-setting-input" value="' + (content.bar_border_radius || '10px') + '" placeholder="10px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'bar_border_radius\',this.value)"></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Gap Between Bars</div><input type="text" class="tb-setting-input" value="' + (content.gap || '16px') + '" placeholder="16px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap\',this.value)"></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Percentage</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_percent\',this.value===\'true\')"><option value="true"' + (content.show_percent !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.show_percent === false ? ' selected' : '') + '>No</option></select></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Percentage Position</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'percent_position\',this.value)"><option value="inside"' + ((content.percent_position || 'inside') === 'inside' ? ' selected' : '') + '>Inside Bar</option><option value="outside"' + (content.percent_position === 'outside' ? ' selected' : '') + '>Outside (Right)</option><option value="above"' + (content.percent_position === 'above' ? ' selected' : '') + '>Above (With Label)</option></select></div>';

                    html += this.renderColorPicker('Label Color', content.label_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'label_color\',VALUE)', '#1e293b');

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Label Font Size</div><input type="text" class="tb-setting-input" value="' + (content.label_size || '14px') + '" placeholder="14px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'label_size\',this.value)"></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Animate on Load</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animate\',this.value===\'true\')"><option value="true"' + (content.animate !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.animate === false ? ' selected' : '') + '>No</option></select></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Animation Duration</div><input type="text" class="tb-setting-input" value="' + (content.animation_duration || '1.5s') + '" placeholder="1.5s" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animation_duration\',this.value)"></div>';

                    html += '</div>';
                    break;
                case 'circle_counter':
                    // Circle Counter Settings
                    html += '<div class="tb-settings-section-title">Circle Counter Settings</div>';

                    // Percentage slider
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Percentage (' + (content.percent || 75) + '%)</div><input type="range" class="tb-setting-input" min="0" max="100" value="' + (content.percent || 75) + '" oninput="this.previousElementSibling.textContent=\'Percentage (\'+this.value+\'%)\';" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'percent\',parseInt(this.value))"></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title/Label</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || 'Completed') + '" placeholder="Completed" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Number Prefix</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.number_prefix || '') + '" placeholder="e.g. $" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'number_prefix\',this.value)"></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Number Suffix</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.number_suffix || '%') + '" placeholder="e.g. %" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'number_suffix\',this.value)"></div>';

                    // Circle Style Section
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Circle Style</div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Circle Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.circle_size || '200px') + '" placeholder="200px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'circle_size\',this.value)"></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Bar Width</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.bar_width || '10px') + '" placeholder="10px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'bar_width\',this.value)"></div>';

                    html += this.renderColorPicker('Bar Color', content.bar_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'bar_color\',VALUE)', '#0073e6');

                    html += this.renderColorPicker('Track Color', content.track_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'track_color\',VALUE)', '#e2e8f0');

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Line Cap</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'line_cap\',this.value)"><option value="round"' + ((content.line_cap || 'round') === 'round' ? ' selected' : '') + '>Round</option><option value="square"' + (content.line_cap === 'square' ? ' selected' : '') + '>Square</option></select></div>';

                    // Text Style Section
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Text Style</div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Number Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.number_size || '48px') + '" placeholder="48px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'number_size\',this.value)"></div>';

                    html += this.renderColorPicker('Number Color', content.number_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'number_color\',VALUE)', '#1e293b');

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title_size || '16px') + '" placeholder="16px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_size\',this.value)"></div>';

                    html += this.renderColorPicker('Title Color', content.title_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_color\',VALUE)', '#64748b');

                    // Animation Section
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Animation</div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Animate on Load</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animate\',this.value===\'true\')"><option value="true"' + (content.animate !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.animate === false ? ' selected' : '') + '>No</option></select></div>';

                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Animation Duration</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.animation_duration || '1.5s') + '" placeholder="1.5s" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animation_duration\',this.value)"></div>';
                    break;
                case 'posts_navigation':
                    // Posts Navigation - Previous/Next post links settings
                    html += '<div class="tb-setting-group"><div class="tb-setting-label" style="font-weight:600">↔️ Posts Navigation Settings</div></div>';
                    html += '<div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:6px;padding:10px;margin-bottom:16px;font-size:11px;color:var(--tb-text-muted)">⚡ Links to adjacent posts generated dynamically based on publish date.</div>';

                    // Labels Section
                    html += '<div class="tb-settings-section-title">Navigation Labels</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Previous Post Label</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.prev_label || 'Previous Post') + '" placeholder="Previous Post" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'prev_label\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Next Post Label</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.next_label || 'Next Post') + '" placeholder="Next Post" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'next_label\',this.value)"></div>';

                    // Display Options
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Display Options</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Post Title</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_title !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_title\',this.checked)"><span>Display adjacent post titles</span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Thumbnail</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_thumbnail !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_thumbnail\',this.checked)"><span>Display post featured images</span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Arrows</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.show_arrows !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_arrows\',this.checked)"><span>Display navigation arrows (← →)</span></label></div>';

                    // Filtering
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Post Selection</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Same Category Only</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.same_category ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'same_category\',this.checked)"><span>Only show posts from the same category</span></label></div>';
                    html += '<div style="font-size:11px;color:var(--tb-text-muted);margin-top:8px;padding:8px;background:var(--tb-surface-2);border-radius:4px">💡 When enabled, navigation will only show previous/next posts that share at least one category with the current post.</div>';

                    // Style Settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Style & Layout</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Style Variant</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)">';
                    html += '<option value="default"' + (content.style === 'default' || !content.style ? ' selected' : '') + '>Default (Border)</option>';
                    html += '<option value="card"' + (content.style === 'card' ? ' selected' : '') + '>Card (Elevated)</option>';
                    html += '<option value="minimal"' + (content.style === 'minimal' ? ' selected' : '') + '>Minimal (Text Only)</option>';
                    html += '<option value="fullwidth"' + (content.style === 'fullwidth' ? ' selected' : '') + '>Fullwidth (Stacked)</option></select></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Layout</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'layout\',this.value)">';
                    html += '<option value="split"' + (content.layout === 'split' || !content.layout ? ' selected' : '') + '>Split (Side by Side)</option>';
                    html += '<option value="stacked"' + (content.layout === 'stacked' ? ' selected' : '') + '>Stacked (One Below Other)</option></select></div>';

                    // Thumbnail Settings (conditional)
                    if (content.show_thumbnail !== false) {
                        html += '<div class="tb-settings-section-title" style="margin-top:16px">Thumbnail Settings</div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Thumbnail Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.thumbnail_size || '80px') + '" placeholder="80px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'thumbnail_size\',this.value)"></div>';
                        html += '<div class="tb-setting-group"><div class="tb-setting-label">Thumbnail Border Radius</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.thumbnail_radius || '8px') + '" placeholder="8px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'thumbnail_radius\',this.value)"></div>';
                    }

                    // Color Settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Colors</div>';
                    html += this.renderColorPicker('Background Color', content.background_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_color\',VALUE)', '#f8fafc');
                    html += this.renderColorPicker('Hover Background', content.hover_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'hover_background\',VALUE)', '#f1f5f9');
                    html += this.renderColorPicker('Label Color', content.label_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'label_color\',VALUE)', '#64748b');
                    html += this.renderColorPicker('Title Color', content.title_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_color\',VALUE)', '#1e293b');
                    html += this.renderColorPicker('Title Hover Color', content.title_hover_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_hover_color\',VALUE)', '#0073e6');
                    html += this.renderColorPicker('Arrow Color', content.arrow_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'arrow_color\',VALUE)', '#94a3b8');
                    html += this.renderColorPicker('Border Color', content.border_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_color\',VALUE)', '#e2e8f0');

                    // Typography Settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Typography</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Label Font Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.label_size || '12px') + '" placeholder="12px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'label_size\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Title Font Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title_size || '16px') + '" placeholder="16px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title_size\',this.value)"></div>';

                    // Spacing
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Spacing</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Padding</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.padding || '20px') + '" placeholder="20px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'padding\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Gap Between Prev/Next</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.gap || '24px') + '" placeholder="24px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap\',this.value)"></div>';
                    break;
                case 'comments':
                    // Comments Header Settings
                    html += '<div class="tb-settings-section-title">Header Settings</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Section Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.title || 'Comments') + '" placeholder="Comments" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Title</div><label class="tb-toggle"><input type="checkbox" ' + (content.show_title !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_title\',this.checked)"><span class="tb-toggle-slider"></span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Count in Title</div><label class="tb-toggle"><input type="checkbox" ' + (content.show_count_in_title !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_count_in_title\',this.checked)"><span class="tb-toggle-slider"></span></label></div>';

                    // Comment Display Settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Comment Display</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Avatars</div><label class="tb-toggle"><input type="checkbox" ' + (content.show_avatars !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_avatars\',this.checked)"><span class="tb-toggle-slider"></span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Avatar Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.avatar_size || '48px') + '" placeholder="48px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'avatar_size\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Reply Button</div><label class="tb-toggle"><input type="checkbox" ' + (content.show_reply_button !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_reply_button\',this.checked)"><span class="tb-toggle-slider"></span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Date</div><label class="tb-toggle"><input type="checkbox" ' + (content.show_date !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_date\',this.checked)"><span class="tb-toggle-slider"></span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Date Format</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.date_format || 'M d, Y') + '" placeholder="M d, Y" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'date_format\',this.value)"></div>';

                    // Comment Form Settings
                    html += '<div class="tb-settings-section-title" style="margin-top:16px">Comment Form</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Form</div><label class="tb-toggle"><input type="checkbox" ' + (content.show_form !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_form\',this.checked)"><span class="tb-toggle-slider"></span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Form Title</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.form_title || 'Leave a Comment') + '" placeholder="Leave a Comment" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'form_title\',this.value)"></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Require Name & Email</div><label class="tb-toggle"><input type="checkbox" ' + (content.require_name_email !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'require_name_email\',this.checked)"><span class="tb-toggle-slider"></span></label></div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Submit Button Text</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.submit_text || 'Post Comment') + '" placeholder="Post Comment" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'submit_text\',this.value)"></div>';
                    break;
                case 'social':
                    // Social Follow module settings - Complete Divi-style implementation
                    html += '<div class="tb-settings-section-title">Social Networks</div>';
                    
                    // Add Network button
                    html += '<div class="tb-setting-group" style="display:flex;justify-content:space-between;align-items:center"><div class="tb-setting-label" style="font-weight:600;margin:0">Networks (' + (content.networks || []).length + ')</div>';
                    html += '<button type="button" class="tb-btn-small" onclick="TB.addSocialNetwork(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')" style="background:#10b981;color:#fff;border:none;padding:4px 10px;border-radius:4px;font-size:12px;cursor:pointer">+ Add Network</button></div>';
                    
                    // Network list
                    const socialNetworksList = content.networks || [];
                    socialNetworksList.forEach((network, netIdx) => {
                        const netName = network.network || 'facebook';
                        const netUrl = network.url || '';
                        const netEnabled = network.enabled !== false;
                        const displayName = netName.charAt(0).toUpperCase() + netName.slice(1);
                        
                        html += '<div class="tb-social-network-item" style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:8px;padding:12px;margin-bottom:8px;opacity:' + (netEnabled ? '1' : '0.6') + '">';
                        
                        // Header with controls
                        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
                        html += '<div style="display:flex;align-items:center;gap:8px">';
                        html += '<label style="display:flex;align-items:center;cursor:pointer"><input type="checkbox" ' + (netEnabled ? 'checked' : '') + ' onchange="TB.updateSocialNetwork(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + netIdx + ',\'enabled\',this.checked)" style="margin-right:6px"><strong style="font-size:12px">' + this.escapeHtml(displayName) + '</strong></label>';
                        html += '</div>';
                        html += '<div style="display:flex;gap:4px">';
                        if (netIdx > 0) html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.moveSocialNetwork(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + netIdx + ',-1)" title="Move Up">↑</button>';
                        if (netIdx < socialNetworksList.length - 1) html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.moveSocialNetwork(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + netIdx + ',1)" title="Move Down">↓</button>';
                        html += '<button type="button" class="tb-btn tb-btn-sm" style="background:#ef4444;color:#fff" onclick="TB.removeSocialNetwork(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + netIdx + ')" title="Remove">×</button>';
                        html += '</div></div>';
                        
                        // Network selector
                        html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Network</div>';
                        html += '<select class="tb-setting-input" onchange="TB.updateSocialNetwork(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + netIdx + ',\'network\',this.value)">';
                        const availableNetworks = ['facebook','twitter','x','instagram','linkedin','youtube','pinterest','tiktok','github','dribbble','behance','vimeo','whatsapp','telegram','reddit','discord','twitch','spotify','soundcloud','snapchat'];
                        availableNetworks.forEach(net => {
                            html += '<option value="' + net + '"' + (netName === net ? ' selected' : '') + '>' + net.charAt(0).toUpperCase() + net.slice(1) + '</option>';
                        });
                        html += '</select></div>';
                        
                        // URL input
                        html += '<div class="tb-setting-group" style="margin-bottom:0"><div class="tb-setting-label">Profile URL</div>';
                        html += '<input type="text" class="tb-setting-input" value="' + this.escapeHtml(netUrl) + '" placeholder="https://facebook.com/yourpage" onchange="TB.updateSocialNetwork(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + netIdx + ',\'url\',this.value)"></div>';
                        
                        html += '</div>';
                    });
                    
                    if (socialNetworksList.length === 0) {
                        html += '<div style="font-size:11px;color:var(--tb-text-muted);padding:16px;text-align:center;background:var(--tb-surface-2);border-radius:8px;border:1px dashed var(--tb-border)">No networks added. Click "+ Add Network" to add a social link.</div>';
                    }
                    
                    // Link Options
                    html += '<div class="tb-settings-section-title" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--tb-border)">Link Options</div>';
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Open in New Window</div><label class="tb-toggle"><input type="checkbox" ' + (content.url_new_window !== false ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'url_new_window\',this.checked)"><span class="tb-toggle-slider"></span></label></div>';
                    
                    // Design Options
                    html += '<div class="tb-settings-section-title" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--tb-border)">Design Options</div>';
                    
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Icon Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.icon_size || '40px') + '" placeholder="40px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon_size\',this.value)"></div>';
                    
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Icon Shape</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon_shape\',this.value)">';
                    html += '<option value="circle"' + (content.icon_shape === 'circle' || !content.icon_shape ? ' selected' : '') + '>Circle</option>';
                    html += '<option value="rounded"' + (content.icon_shape === 'rounded' ? ' selected' : '') + '>Rounded Square</option>';
                    html += '<option value="square"' + (content.icon_shape === 'square' ? ' selected' : '') + '>Square</option></select></div>';
                    
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Background Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_style\',this.value)">';
                    html += '<option value="filled"' + (content.background_style === 'filled' || !content.background_style ? ' selected' : '') + '>Filled (Brand Colors)</option>';
                    html += '<option value="outline"' + (content.background_style === 'outline' ? ' selected' : '') + '>Outline</option>';
                    html += '<option value="none"' + (content.background_style === 'none' ? ' selected' : '') + '>None (Icon Only)</option></select></div>';
                    
                    html += this.renderColorPicker('Custom Icon Color', content.icon_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon_color\',VALUE)', '#333333');
                    html += '<div style="font-size:10px;color:var(--tb-text-muted);margin-top:-8px;margin-bottom:12px">Leave empty to use brand colors (Facebook blue, Twitter blue, etc.)</div>';
                    
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Gap Between Icons</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.gap || '12px') + '" placeholder="12px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap\',this.value)"></div>';
                    
                    html += '<div class="tb-setting-group"><div class="tb-setting-label">Alignment</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'alignment\',this.value)">';
                    html += '<option value="left"' + (content.alignment === 'left' ? ' selected' : '') + '>Left</option>';
                    html += '<option value="center"' + (content.alignment === 'center' || !content.alignment ? ' selected' : '') + '>Center</option>';
                    html += '<option value="right"' + (content.alignment === 'right' ? ' selected' : '') + '>Right</option></select></div>';
                    break;
                default:
                    html += '<div class="tb-setting-group"><div style="color:var(--tb-text-muted);font-size:12px;">Settings for "' + mod.type + '" module coming soon...</div></div>';
            }
            return html;
        },

        // Form field management functions
        addFormField(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'form') return;
            if (!mod.content) mod.content = {};
            if (!mod.content.fields) mod.content.fields = [];
            const newFieldNum = mod.content.fields.length + 1;
            mod.content.fields.push({ type: 'text', label: 'Field ' + newFieldNum, placeholder: '', required: false });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Added field ' + newFieldNum, 'success');
        },

        removeFormField(sIdx, rIdx, cIdx, mIdx, fieldIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'form' || !mod.content?.fields) return;
            if (mod.content.fields.length <= 1) {
                this.showToast('Cannot remove the last field', 'error');
                return;
            }
            mod.content.fields.splice(fieldIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Field removed', 'success');
        },

        moveFormField(sIdx, rIdx, cIdx, mIdx, fieldIdx, direction) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'form' || !mod.content?.fields) return;
            const newIdx = fieldIdx + direction;
            if (newIdx < 0 || newIdx >= mod.content.fields.length) return;
            const temp = mod.content.fields[fieldIdx];
            mod.content.fields[fieldIdx] = mod.content.fields[newIdx];
            mod.content.fields[newIdx] = temp;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateFormField(sIdx, rIdx, cIdx, mIdx, fieldIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'form' || !mod.content?.fields?.[fieldIdx]) return;
            mod.content.fields[fieldIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Team social link management
        addTeamSocialLink(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.content.social) mod.content.social = [];
            mod.content.social.push({ platform: 'linkedin', url: '' });
            this.saveToHistory();
            this.renderCanvas();
            this.renderSettings();
        },

        updateTeamSocialLink(sIdx, rIdx, cIdx, mIdx, linkIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.social || !mod.content.social[linkIdx]) return;
            mod.content.social[linkIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.renderSettings();
        },

        removeTeamSocialLink(sIdx, rIdx, cIdx, mIdx, linkIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.social) return;
            mod.content.social.splice(linkIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.renderSettings();
        },

        // Social network management functions
        addSocialNetwork(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'social') return;
            if (!mod.content) mod.content = {};
            if (!mod.content.networks) mod.content.networks = [];
            mod.content.networks.push({ platform: 'website', url: '' });
            this.saveToHistory();
            this.renderCanvas();
            this.renderSettings();
        },

        updateSocialNetwork(sIdx, rIdx, cIdx, mIdx, netIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'social' || !mod.content?.networks?.[netIdx]) return;
            mod.content.networks[netIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.renderSettings();
        },

        removeSocialNetwork(sIdx, rIdx, cIdx, mIdx, netIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'social' || !mod.content?.networks) return;
            mod.content.networks.splice(netIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.renderSettings();
        },

        renderDesignSettings(mod, sIdx, rIdx, cIdx, mIdx) {
            const settings = mod.settings || {};
            const type = mod.type || 'text';

            // Text-based modules that support typography (for section visibility)
            const textModules = ['text', 'heading', 'button', 'quote', 'cta', 'pricing', 'blurb', 'hero', 'testimonial', 'team', 'countdown', 'counter', 'list', 'menu', 'slider', 'toggle', 'bar_counters', 'video_slider', 'post_slider', 'post_title', 'circle_counter', 'search', 'comments'];
            const hasTypography = textModules.includes(type);

            // Check if module has any hover properties set
            const hasHoverValues = settings.hover_enabled || settings.text_color_hover ||
                settings.background_color_hover || settings.border_color_hover ||
                settings.transform_scale_hover || settings.transform_translate_y_hover ||
                settings.opacity_hover || settings.box_shadow_hover_enabled ||
                settings.filter_hover_enabled;

            let html = '';

            // State Toggle UI (Normal / Hover)
            html += '<div class="tb-state-toggle">';
            html += '<button type="button" class="tb-state-btn' + (this.currentState === 'normal' ? ' active' : '') + '" onclick="TB.setState(\'normal\')">';
            html += '<span class="tb-state-indicator">●</span> Normal';
            html += '</button>';
            html += '<button type="button" class="tb-state-btn' + (this.currentState === 'hover' ? ' active hover-state' : '') + '" onclick="TB.setState(\'hover\')">';
            html += '<span class="tb-state-indicator">👆</span> Hover';
            if (hasHoverValues) html += '<span class="tb-hover-badge">✓</span>';
            html += '</button>';
            html += '</div>';

            // Typography Section Header (for text-based modules)
            if (hasTypography) {
                html += '<div class="tb-setting-group" style="border-bottom:1px solid var(--tb-border);padding-bottom:16px;margin-bottom:16px"><div class="tb-setting-label" style="font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:0.05em;color:var(--tb-accent)">Typography</div></div>';

                // Module-specific typography sections
                switch (type) {
                    case 'heading':
                        // Heading: single title typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Heading');
                        break;
                    case 'text':
                        // Text: body typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'body', 'Body Text');
                        break;
                    case 'button':
                        // Button: button text typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'button', 'Button');
                        break;
                    case 'quote':
                        // Quote: quote text and author typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'quote', 'Quote');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'author', 'Author');
                        break;
                    case 'cta':
                        // CTA: title, subtitle, and button typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'subtitle', 'Subtitle');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'button', 'Button');
                        break;
                    case 'blurb':
                        // Blurb: title and description typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'text', 'Description');
                        break;
                    case 'hero':
                        // Hero: title, subtitle, and buttons typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'subtitle', 'Subtitle');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'button', 'Buttons');
                        break;
                    case 'testimonial':
                        // Testimonial: quote and author typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'quote', 'Quote');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'author', 'Author');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'role', 'Role/Title');
                        break;
                    case 'pricing':
                        // Pricing: title, price, and features typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Plan Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'price', 'Price');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'features', 'Features');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'button', 'Button');
                        break;
                    case 'team':
                        // Team: name and role typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'name', 'Name');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'role', 'Role');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'bio', 'Bio');
                        break;
                    case 'counter':
                        // Counter: number and title typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'number', 'Number');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Title');
                        break;
                    case 'countdown':
                        // Countdown: number and label typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'number', 'Numbers');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'label', 'Labels');
                        break;
                    case 'list':
                        // List: item typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'item', 'List Items');
                        break;
                    case 'menu':
                        // Menu: link typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'link', 'Menu Links');
                        break;
                    case 'sidebar':
                        // Sidebar: title and widget typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Sidebar Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'widget_title', 'Widget Titles');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'widget_content', 'Widget Content');
                        break;
                    case 'slider':
                        // Slider: title, text, and button typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Slide Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'text', 'Slide Text');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'button', 'Slide Button');
                        break;
                    case 'post_slider':
                        // Post Slider: title, meta, excerpt, and button typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Post Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'meta', 'Meta (Date/Author/Category)');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'excerpt', 'Excerpt');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'button', 'Read More Button');
                        break;
                    case 'post_title':
                        // Post Title: title and meta typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'meta', 'Meta (Date/Author/Categories/Comments)');
                        break;
                    case 'post_content':
                        // Post Content: body, heading, blockquote, code typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'body', 'Body Text');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'heading', 'Headings (h2-h6)');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'blockquote', 'Blockquotes');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'code', 'Code Blocks');
                        break;
                    case 'posts_navigation':
                        // Posts Navigation: label and title typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'label', 'Navigation Label');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Post Title');
                        break;
                    case 'video_slider':
                        // Video Slider: title and description typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Video Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'description', 'Description');
                        break;
                    case 'toggle':
                        // Toggle: title and content typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Toggle Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'content', 'Toggle Content');
                        break;
                    case 'bar_counters':
                        // Bar Counters: label and percent typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'label', 'Labels');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'percent', 'Percentages');
                        break;
                    case 'circle_counter':
                        // Circle Counter: number and title typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'number', 'Number');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Title');
                        break;
                    case 'search':
                        // Search: input and button typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'input', 'Input Text');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'button', 'Button');
                        break;
                    case 'comments':
                        // Comments: author, date, text, and form typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'title', 'Section Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'author', 'Author Name');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'date', 'Date');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'text', 'Comment Text');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'form_title', 'Form Title');
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'button', 'Submit Button');
                        break;
                    default:
                        // Fallback: single general typography
                        html += this.renderTypographySettings(sIdx, rIdx, cIdx, mIdx, 'default', 'Text');
                }
            }

            // Module-specific design settings (before common settings)
            if (type === 'post_content') {
                html += '<div class="tb-setting-group" style="border-bottom:1px solid var(--tb-border);padding-bottom:16px;margin-bottom:16px;margin-top:' + (hasTypography ? '16px' : '0') + '"><div class="tb-setting-label" style="font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:0.05em;color:var(--tb-accent)">📄 Content Styling</div></div>';

                // Max Width
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Max Width</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.max_width || '800px') + '" placeholder="800px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'max_width\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Controls content width for readability</div></div>';

                // Text Color
                html += this.renderColorPicker('Text Color', content.text_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_color\',VALUE)', '#1e293b');

                // Font Size
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Font Size</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.font_size || '18px') + '" placeholder="18px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'font_size\',this.value)"></div>';

                // Line Height
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Line Height</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.line_height || '1.8') + '" placeholder="1.8" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'line_height\',this.value)"></div>';

                // Paragraph Spacing
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Paragraph Spacing</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.paragraph_spacing || '1.5em') + '" placeholder="1.5em" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'paragraph_spacing\',this.value)"></div>';

                // Heading Color
                html += this.renderColorPicker('Heading Color (h2-h6)', content.heading_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'heading_color\',VALUE)', '#0f172a');

                // Link Colors Section
                html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Link Colors</div></div>';

                // Link Color
                html += this.renderColorPicker('Link Color', content.link_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'link_color\',VALUE)', '#0073e6');

                // Link Hover Color
                html += this.renderColorPicker('Link Hover Color', content.link_hover_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'link_hover_color\',VALUE)', '#0056b3');

                // Images Section
                html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Images</div></div>';

                // Image Border Radius
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Image Border Radius</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.image_border_radius || '8px') + '" placeholder="8px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'image_border_radius\',this.value)"></div>';

                // Blockquote Section
                html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Blockquotes</div></div>';

                // Blockquote Style
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Blockquote Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'blockquote_style\',this.value)">';
                html += '<option value="border"' + (content.blockquote_style === 'border' || !content.blockquote_style ? ' selected' : '') + '>Border (left line)</option>';
                html += '<option value="background"' + (content.blockquote_style === 'background' ? ' selected' : '') + '>Background</option>';
                html += '<option value="italic"' + (content.blockquote_style === 'italic' ? ' selected' : '') + '>Italic (minimal)</option></select></div>';

                // Blockquote Border/Background Color
                html += this.renderColorPicker('Blockquote Accent Color', content.blockquote_border_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'blockquote_border_color\',VALUE)', '#0073e6');

                // Code Section
                html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Code Blocks</div></div>';

                // Code Background
                html += this.renderColorPicker('Code Background', content.code_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'code_background\',VALUE)', '#f1f5f9');

                // Code Text Color
                html += this.renderColorPicker('Code Text Color', content.code_text_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'code_text_color\',VALUE)', '#e11d48');

                // Lists Section
                html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Lists</div></div>';

                // List Style
                html += '<div class="tb-setting-group"><div class="tb-setting-label">List Marker Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'list_style\',this.value)">';
                html += '<option value="disc"' + (content.list_style === 'disc' || !content.list_style ? ' selected' : '') + '>Disc (•)</option>';
                html += '<option value="circle"' + (content.list_style === 'circle' ? ' selected' : '') + '>Circle (○)</option>';
                html += '<option value="square"' + (content.list_style === 'square' ? ' selected' : '') + '>Square (▪)</option>';
                html += '<option value="check"' + (content.list_style === 'check' ? ' selected' : '') + '>Checkmark (✓)</option>';
                html += '<option value="arrow"' + (content.list_style === 'arrow' ? ' selected' : '') + '>Arrow (→)</option></select></div>';

                // Dropcap Section
                html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Dropcap</div></div>';

                // Dropcap Toggle
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Enable Dropcap</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (content.dropcap ? 'checked' : '') + ' onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'dropcap\',this.checked)"><span>Large decorative first letter</span></label></div>';

                // Dropcap Color (conditional)
                if (content.dropcap) {
                    html += this.renderColorPicker('Dropcap Color', content.dropcap_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'dropcap_color\',VALUE)', '#0073e6');
                }
            }

            // Comments Module - Design Settings
            if (type === 'comments') {
                const content = mod.content || {};
                html += '<div class="tb-setting-group" style="border-bottom:1px solid var(--tb-border);padding-bottom:16px;margin-bottom:16px;margin-top:' + (hasTypography ? '16px' : '0') + '"><div class="tb-setting-label" style="font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:0.05em;color:var(--tb-accent)">💬 Comments Styling</div></div>';

                // Style Preset
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)">';
                html += '<option value="default"' + (content.style === 'default' || !content.style ? ' selected' : '') + '>Default</option>';
                html += '<option value="card"' + (content.style === 'card' ? ' selected' : '') + '>Card</option>';
                html += '<option value="minimal"' + (content.style === 'minimal' ? ' selected' : '') + '>Minimal</option>';
                html += '<option value="threaded"' + (content.style === 'threaded' ? ' selected' : '') + '>Threaded</option></select></div>';

                // Comment Colors Section
                html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Comment Colors</div></div>';

                // Comment Background
                html += this.renderColorPicker('Comment Background', content.comment_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'comment_background\',VALUE)', '#f8fafc');

                // Comment Border Color
                html += this.renderColorPicker('Comment Border Color', content.comment_border_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'comment_border_color\',VALUE)', '#e2e8f0');

                // Author Color
                html += this.renderColorPicker('Author Name Color', content.author_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'author_color\',VALUE)', '#1e293b');

                // Date Color
                html += this.renderColorPicker('Date Color', content.date_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'date_color\',VALUE)', '#64748b');

                // Text Color
                html += this.renderColorPicker('Comment Text Color', content.text_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_color\',VALUE)', '#374151');

                // Avatar Section
                html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Avatar</div></div>';

                // Avatar Border Radius
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Avatar Border Radius</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.avatar_radius || '50%') + '" placeholder="50%" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'avatar_radius\',this.value)"></div>';

                // Form Section
                html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Comment Form</div></div>';

                // Form Background
                html += this.renderColorPicker('Form Background', content.form_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'form_background\',VALUE)', '#f8fafc');

                // Input Background
                html += this.renderColorPicker('Input Background', content.input_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'input_background\',VALUE)', '#ffffff');

                // Input Border Color
                html += this.renderColorPicker('Input Border Color', content.input_border_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'input_border_color\',VALUE)', '#e2e8f0');

                // Button Background
                html += this.renderColorPicker('Button Background', content.button_background, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_background\',VALUE)', '#0073e6');

                // Button Text Color
                html += this.renderColorPicker('Button Text Color', content.button_text_color, 'TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text_color\',VALUE)', '#ffffff');

                // Spacing Section
                html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Spacing</div></div>';

                // Reply Indent
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Reply Indent</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.reply_indent || '40px') + '" placeholder="40px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'reply_indent\',this.value)"></div>';

                // Gap
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Gap Between Comments</div><input type="text" class="tb-setting-input" value="' + this.escapeHtml(content.gap || '20px') + '" placeholder="20px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap\',this.value)"></div>';
            }

            // Gallery Module - Professional Design Settings
            if (type === 'gallery') {
                const gDesign = mod.design || {};
                
                // Professional UI styles (injected once)
                if (!window.tbGalleryStylesInjected) {
                    window.tbGalleryStylesInjected = true;
                    const styleEl = document.createElement('style');
                    styleEl.textContent = `
                        .tb-gallery-panel .tb-section {
                            background: var(--tb-bg-tertiary);
                            border-radius: 8px;
                            margin-bottom: 8px;
                            border: 1px solid var(--tb-border);
                        }
                        .tb-gallery-panel .tb-section-header {
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            padding: 10px 12px;
                            cursor: pointer;
                            user-select: none;
                            border-radius: 8px;
                            transition: background 0.15s;
                        }
                        .tb-gallery-panel .tb-section-header:hover {
                            background: rgba(255,255,255,0.03);
                        }
                        .tb-gallery-panel .tb-section-title {
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            font-weight: 600;
                            font-size: 12px;
                            color: var(--tb-text-primary);
                        }
                        .tb-gallery-panel .tb-section-icon { font-size: 14px; }
                        .tb-gallery-panel .tb-section-chevron {
                            font-size: 10px;
                            transition: transform 0.2s;
                            color: var(--tb-text-muted);
                        }
                        .tb-gallery-panel .tb-section.collapsed .tb-section-chevron {
                            transform: rotate(-90deg);
                        }
                        .tb-gallery-panel .tb-section-body {
                            padding: 0 12px 12px;
                        }
                        .tb-gallery-panel .tb-section.collapsed .tb-section-body {
                            display: none;
                        }
                        .tb-gallery-panel .tb-row {
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            padding: 8px 0;
                            border-bottom: 1px solid rgba(255,255,255,0.05);
                        }
                        .tb-gallery-panel .tb-row:last-child { border-bottom: none; }
                        .tb-gallery-panel .tb-row-label {
                            font-size: 11px;
                            color: var(--tb-text-secondary);
                        }
                        .tb-gallery-panel .tb-row-control {
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        }
                        .tb-gallery-panel .tb-mini-select {
                            background: var(--tb-bg-secondary);
                            border: 1px solid var(--tb-border);
                            border-radius: 4px;
                            padding: 4px 8px;
                            font-size: 11px;
                            color: var(--tb-text-primary);
                            min-width: 90px;
                        }
                        .tb-gallery-panel .tb-mini-input {
                            background: var(--tb-bg-secondary);
                            border: 1px solid var(--tb-border);
                            border-radius: 4px;
                            padding: 4px 8px;
                            font-size: 11px;
                            color: var(--tb-text-primary);
                            width: 70px;
                            text-align: center;
                        }
                        .tb-gallery-panel .tb-toggle {
                            position: relative;
                            width: 36px;
                            height: 20px;
                            background: var(--tb-bg-secondary);
                            border-radius: 10px;
                            cursor: pointer;
                            transition: background 0.2s;
                        }
                        .tb-gallery-panel .tb-toggle.on { background: #10b981; }
                        .tb-gallery-panel .tb-toggle-knob {
                            position: absolute;
                            top: 2px;
                            left: 2px;
                            width: 16px;
                            height: 16px;
                            background: white;
                            border-radius: 50%;
                            transition: transform 0.2s;
                            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
                        }
                        .tb-gallery-panel .tb-toggle.on .tb-toggle-knob {
                            transform: translateX(16px);
                        }
                        .tb-gallery-panel .tb-color-wrap {
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        }
                        .tb-gallery-panel .tb-color-swatch {
                            width: 24px;
                            height: 24px;
                            border-radius: 4px;
                            border: 2px solid var(--tb-border);
                            cursor: pointer;
                        }
                        .tb-gallery-panel .tb-color-text {
                            width: 100px;
                            font-size: 10px;
                            font-family: monospace;
                        }
                        .tb-gallery-panel .tb-btn-group {
                            display: flex;
                            gap: 2px;
                            background: var(--tb-bg-secondary);
                            border-radius: 4px;
                            padding: 2px;
                        }
                        .tb-gallery-panel .tb-btn-opt {
                            padding: 4px 8px;
                            font-size: 10px;
                            border: none;
                            background: transparent;
                            color: var(--tb-text-muted);
                            border-radius: 3px;
                            cursor: pointer;
                            transition: all 0.15s;
                        }
                        .tb-gallery-panel .tb-btn-opt:hover { color: var(--tb-text-primary); }
                        .tb-gallery-panel .tb-btn-opt.active {
                            background: var(--tb-accent);
                            color: white;
                        }
                        .tb-gallery-panel .tb-responsive-row {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 6px;
                            margin-top: 6px;
                        }
                        .tb-gallery-panel .tb-resp-item {
                            display: flex;
                            flex-direction: column;
                            gap: 2px;
                        }
                        .tb-gallery-panel .tb-resp-label {
                            font-size: 9px;
                            color: var(--tb-text-muted);
                            text-align: center;
                        }
                    `;
                    document.head.appendChild(styleEl);
                }
                
                html += '<div class="tb-gallery-panel">';
                
                // Helper: Toggle switch
                const mkToggle = (prop, val) => {
                    const isOn = val !== false;
                    return '<div class="tb-toggle ' + (isOn ? 'on' : '') + '" onclick="this.classList.toggle(\'on\');TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + prop + '\',this.classList.contains(\'on\'))"><div class="tb-toggle-knob"></div></div>';
                };
                
                // Helper: Color field
                const mkColor = (prop, val, placeholder) => {
                    const v = val || placeholder;
                    const hex = v.startsWith('#') ? v : '#888888';
                    return '<div class="tb-color-wrap"><input type="color" class="tb-color-swatch" value="' + hex + '" onchange="this.nextElementSibling.value=this.value;TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + prop + '\',this.value)"><input type="text" class="tb-setting-input tb-color-text" value="' + v + '" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + prop + '\',this.value)"></div>';
                };
                
                // Helper: Button group
                const mkBtnGroup = (prop, options, current) => {
                    let h = '<div class="tb-btn-group">';
                    options.forEach(function(o) {
                        const val = Array.isArray(o) ? o[0] : o;
                        const label = Array.isArray(o) ? o[1] : o;
                        h += '<button class="tb-btn-opt ' + (current === val ? 'active' : '') + '" onclick="this.parentElement.querySelectorAll(\'.tb-btn-opt\').forEach(b=>b.classList.remove(\'active\'));this.classList.add(\'active\');TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + prop + '\',\'' + val + '\')">' + label + '</button>';
                    });
                    h += '</div>';
                    return h;
                };
                
                // ══════════════════════════════════════════════════════════════
                // SECTION: Layout
                // ══════════════════════════════════════════════════════════════
                html += '<div class="tb-section">';
                html += '<div class="tb-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')">';
                html += '<div class="tb-section-title"><span class="tb-section-icon">📐</span> Layout</div>';
                html += '<span class="tb-section-chevron">▼</span>';
                html += '</div>';
                html += '<div class="tb-section-body">';
                
                // Layout type
                html += '<div class="tb-row"><span class="tb-row-label">Type</span><div class="tb-row-control">';
                html += mkBtnGroup('layout', ['grid', 'masonry', 'justified'], gDesign.layout || 'grid');
                html += '</div></div>';
                
                // Gaps - responsive
                html += '<div class="tb-row" style="flex-direction:column;align-items:stretch"><span class="tb-row-label">Gap</span>';
                html += '<div class="tb-responsive-row">';
                html += '<div class="tb-resp-item"><span class="tb-resp-label">🖥 Desktop</span><input type="text" class="tb-setting-input tb-mini-input" value="' + (gDesign.gap || '16px') + '" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap\',this.value)"></div>';
                html += '<div class="tb-resp-item"><span class="tb-resp-label">📱 Tablet</span><input type="text" class="tb-setting-input tb-mini-input" value="' + (gDesign.gap_tablet || '12px') + '" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap_tablet\',this.value)"></div>';
                html += '<div class="tb-resp-item"><span class="tb-resp-label">📱 Mobile</span><input type="text" class="tb-setting-input tb-mini-input" value="' + (gDesign.gap_mobile || '8px') + '" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap_mobile\',this.value)"></div>';
                html += '</div></div>';
                
                html += '</div></div>';
                
                // ══════════════════════════════════════════════════════════════
                // SECTION: Image Style
                // ══════════════════════════════════════════════════════════════
                html += '<div class="tb-section">';
                html += '<div class="tb-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')">';
                html += '<div class="tb-section-title"><span class="tb-section-icon">🎨</span> Image Style</div>';
                html += '<span class="tb-section-chevron">▼</span>';
                html += '</div>';
                html += '<div class="tb-section-body">';
                
                // Aspect ratio
                html += '<div class="tb-row"><span class="tb-row-label">Aspect Ratio</span><div class="tb-row-control">';
                html += '<select class="tb-mini-select" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'aspect_ratio\',this.value)">';
                ['auto', '1:1', '4:3', '16:9', '3:2', '2:3'].forEach(function(opt) {
                    html += '<option value="' + opt + '"' + ((gDesign.aspect_ratio || 'auto') === opt ? ' selected' : '') + '>' + opt + '</option>';
                });
                html += '</select></div></div>';
                
                // Object fit
                html += '<div class="tb-row"><span class="tb-row-label">Object Fit</span><div class="tb-row-control">';
                html += mkBtnGroup('object_fit', ['cover', 'contain'], gDesign.object_fit || 'cover');
                html += '</div></div>';
                
                // Border radius
                html += '<div class="tb-row"><span class="tb-row-label">Border Radius</span><div class="tb-row-control">';
                html += '<input type="text" class="tb-setting-input tb-mini-input" value="' + (gDesign.border_radius || '8px') + '" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_radius\',this.value)">';
                html += '</div></div>';
                
                // Shadow
                html += '<div class="tb-row"><span class="tb-row-label">Shadow</span><div class="tb-row-control">';
                html += mkBtnGroup('image_shadow', [['none','None'],['small','S'],['medium','M'],['large','L']], gDesign.image_shadow || 'none');
                html += '</div></div>';
                
                html += '</div></div>';
                
                // ══════════════════════════════════════════════════════════════
                // SECTION: Hover Effects
                // ══════════════════════════════════════════════════════════════
                html += '<div class="tb-section">';
                html += '<div class="tb-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')">';
                html += '<div class="tb-section-title"><span class="tb-section-icon">✨</span> Hover Effects</div>';
                html += '<span class="tb-section-chevron">▼</span>';
                html += '</div>';
                html += '<div class="tb-section-body">';
                
                // Effect type
                html += '<div class="tb-row"><span class="tb-row-label">Effect</span><div class="tb-row-control">';
                html += '<select class="tb-mini-select" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'hover_effect\',this.value)">';
                [['none','None'],['zoom','Zoom'],['lift','Lift'],['overlay','Overlay'],['grayscale','Grayscale'],['blur','Blur']].forEach(function(o) {
                    html += '<option value="' + o[0] + '"' + ((gDesign.hover_effect || 'zoom') === o[0] ? ' selected' : '') + '>' + o[1] + '</option>';
                });
                html += '</select></div></div>';
                
                // Zoom scale
                html += '<div class="tb-row"><span class="tb-row-label">Zoom Scale</span><div class="tb-row-control">';
                html += '<input type="text" class="tb-setting-input tb-mini-input" value="' + (gDesign.hover_zoom_scale || '1.05') + '" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'hover_zoom_scale\',this.value)">';
                html += '</div></div>';
                
                // Overlay color
                html += '<div class="tb-row"><span class="tb-row-label">Overlay</span><div class="tb-row-control">';
                html += mkColor('hover_overlay_color', gDesign.hover_overlay_color, 'rgba(0,0,0,0.4)');
                html += '</div></div>';
                
                // Icon
                html += '<div class="tb-row"><span class="tb-row-label">Icon</span><div class="tb-row-control">';
                html += mkBtnGroup('hover_icon', [['none','—'],['search','🔍'],['expand','⤢'],['plus','+'],['eye','👁']], gDesign.hover_icon || 'search');
                html += '</div></div>';
                
                // Icon color
                html += '<div class="tb-row"><span class="tb-row-label">Icon Color</span><div class="tb-row-control">';
                html += mkColor('hover_icon_color', gDesign.hover_icon_color, '#ffffff');
                html += '</div></div>';
                
                html += '</div></div>';
                
                // ══════════════════════════════════════════════════════════════
                // SECTION: Captions
                // ══════════════════════════════════════════════════════════════
                html += '<div class="tb-section">';
                html += '<div class="tb-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')">';
                html += '<div class="tb-section-title"><span class="tb-section-icon">💬</span> Captions</div>';
                html += '<span class="tb-section-chevron">▼</span>';
                html += '</div>';
                html += '<div class="tb-section-body">';
                
                // Show captions
                html += '<div class="tb-row"><span class="tb-row-label">Display</span><div class="tb-row-control">';
                html += mkBtnGroup('show_captions', [['never','Never'],['hover','Hover'],['always','Always']], gDesign.show_captions || 'hover');
                html += '</div></div>';
                
                // Position
                html += '<div class="tb-row"><span class="tb-row-label">Position</span><div class="tb-row-control">';
                html += '<select class="tb-mini-select" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'caption_position\',this.value)">';
                [['bottom','Below'],['overlay-bottom','Over Bottom'],['overlay-center','Over Center']].forEach(function(o) {
                    html += '<option value="' + o[0] + '"' + ((gDesign.caption_position || 'bottom') === o[0] ? ' selected' : '') + '>' + o[1] + '</option>';
                });
                html += '</select></div></div>';
                
                // Background
                html += '<div class="tb-row"><span class="tb-row-label">Background</span><div class="tb-row-control">';
                html += mkColor('caption_bg', gDesign.caption_bg, 'rgba(0,0,0,0.7)');
                html += '</div></div>';
                
                // Text color
                html += '<div class="tb-row"><span class="tb-row-label">Text Color</span><div class="tb-row-control">';
                html += mkColor('caption_color', gDesign.caption_color, '#ffffff');
                html += '</div></div>';
                
                // Font size
                html += '<div class="tb-row"><span class="tb-row-label">Font Size</span><div class="tb-row-control">';
                html += '<input type="text" class="tb-setting-input tb-mini-input" value="' + (gDesign.caption_font_size || '14px') + '" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'caption_font_size\',this.value)">';
                html += '</div></div>';
                
                html += '</div></div>';
                
                // ══════════════════════════════════════════════════════════════
                // SECTION: Animation
                // ══════════════════════════════════════════════════════════════
                html += '<div class="tb-section">';
                html += '<div class="tb-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')">';
                html += '<div class="tb-section-title"><span class="tb-section-icon">🎬</span> Animation</div>';
                html += '<span class="tb-section-chevron">▼</span>';
                html += '</div>';
                html += '<div class="tb-section-body">';
                
                // Animation type
                html += '<div class="tb-row"><span class="tb-row-label">Load Effect</span><div class="tb-row-control">';
                html += mkBtnGroup('load_animation', [['none','None'],['fade','Fade'],['slide-up','Slide'],['zoom-in','Zoom']], gDesign.load_animation || 'fade');
                html += '</div></div>';
                
                // Duration
                html += '<div class="tb-row"><span class="tb-row-label">Duration</span><div class="tb-row-control">';
                html += '<input type="text" class="tb-setting-input tb-mini-input" value="' + (gDesign.animation_duration || '0.4s') + '" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animation_duration\',this.value)">';
                html += '</div></div>';
                
                // Stagger
                html += '<div class="tb-row"><span class="tb-row-label">Stagger</span><div class="tb-row-control">';
                html += mkToggle('animation_stagger', gDesign.animation_stagger);
                html += '</div></div>';
                
                // Stagger delay
                html += '<div class="tb-row"><span class="tb-row-label">Stagger Delay</span><div class="tb-row-control">';
                html += '<input type="text" class="tb-setting-input tb-mini-input" value="' + (gDesign.stagger_delay || '0.1s') + '" onchange="TB.updateModuleDesign(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'stagger_delay\',this.value)">';
                html += '</div></div>';
                
                html += '</div></div>';
                
                // ══════════════════════════════════════════════════════════════
                // SECTION: Lightbox
                // ══════════════════════════════════════════════════════════════
                html += '<div class="tb-section">';
                html += '<div class="tb-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')">';
                html += '<div class="tb-section-title"><span class="tb-section-icon">🔍</span> Lightbox</div>';
                html += '<span class="tb-section-chevron">▼</span>';
                html += '</div>';
                html += '<div class="tb-section-body">';
                
                // Enable
                html += '<div class="tb-row"><span class="tb-row-label">Enable</span><div class="tb-row-control">';
                html += mkToggle('lightbox', gDesign.lightbox);
                html += '</div></div>';
                
                // Background
                html += '<div class="tb-row"><span class="tb-row-label">Background</span><div class="tb-row-control">';
                html += mkColor('lightbox_bg', gDesign.lightbox_bg, 'rgba(0,0,0,0.95)');
                html += '</div></div>';
                
                // Counter
                html += '<div class="tb-row"><span class="tb-row-label">Counter</span><div class="tb-row-control">';
                html += mkToggle('lightbox_counter', gDesign.lightbox_counter);
                html += '</div></div>';
                
                // Arrows
                html += '<div class="tb-row"><span class="tb-row-label">Arrows</span><div class="tb-row-control">';
                html += mkToggle('lightbox_arrows', gDesign.lightbox_arrows);
                html += '</div></div>';
                
                // Captions
                html += '<div class="tb-row"><span class="tb-row-label">Captions</span><div class="tb-row-control">';
                html += mkToggle('lightbox_captions', gDesign.lightbox_captions);
                html += '</div></div>';
                
                // Keyboard
                html += '<div class="tb-row"><span class="tb-row-label">Keyboard Nav</span><div class="tb-row-control">';
                html += mkToggle('lightbox_keyboard', gDesign.lightbox_keyboard);
                html += '</div></div>';
                
                html += '</div></div>';
                
                html += '</div>'; // .tb-gallery-panel
            }

            // Spacing Section (📐 Divi-style per-side control)
            html += '<div class="tb-setting-group" style="border-bottom:1px solid var(--tb-border);padding-bottom:16px;margin-bottom:16px;margin-top:' + (hasTypography ? '16px' : '0') + '"><div class="tb-setting-label" style="font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:0.05em;color:var(--tb-accent)">📐 Spacing</div></div>';

            // Visual combined spacing box (margin outer, padding inner)
            html += this.renderCombinedSpacingBox(sIdx, rIdx, cIdx, mIdx);

            // Background Section
            html += '<div class="tb-setting-group" style="border-bottom:1px solid var(--tb-border);padding-bottom:16px;margin-bottom:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:0.05em;color:var(--tb-accent)">Background</div></div>';

            html += this.renderColorPicker('Background Color', settings.backgroundColor, 'TB.updateModuleSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'backgroundColor\',VALUE)', '#ffffff');

            // Layout Section
            html += '<div class="tb-setting-group" style="border-bottom:1px solid var(--tb-border);padding-bottom:16px;margin-bottom:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:0.05em;color:var(--tb-accent)">Layout</div></div>';

            html += '<div class="tb-setting-group"><div class="tb-setting-label">Text Alignment</div><select class="tb-setting-input" onchange="TB.updateModuleSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'textAlign\',this.value)"><option value="">Default</option><option value="left"' + (settings.textAlign === 'left' ? ' selected' : '') + '>Left</option><option value="center"' + (settings.textAlign === 'center' ? ' selected' : '') + '>Center</option><option value="right"' + (settings.textAlign === 'right' ? ' selected' : '') + '>Right</option><option value="justify"' + (settings.textAlign === 'justify' ? ' selected' : '') + '>Justify</option></select></div>';

            // Border Section (🔲 Divi-style per-side control)
            html += '<div class="tb-setting-group" style="border-bottom:1px solid var(--tb-border);padding-bottom:16px;margin-bottom:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:0.05em;color:var(--tb-accent)">🔲 Border</div></div>';

            // Visual border settings (width per side, style, color, radius per corner)
            html += this.renderBorderSettings(sIdx, rIdx, cIdx, mIdx);

            // Box Shadow Section (🌫️ Divi-style shadow controls)
            html += '<div class="tb-setting-group" style="border-bottom:1px solid var(--tb-border);padding-bottom:16px;margin-bottom:16px;margin-top:16px"><div class="tb-setting-label" style="font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:0.05em;color:var(--tb-accent)">🌫️ Box Shadow</div></div>';

            // Visual box shadow settings (horizontal, vertical, blur, spread, color, inset)
            html += this.renderBoxShadowSettings(sIdx, rIdx, cIdx, mIdx);

            // Hover Effects Section (👆 Divi-style hover editing)
            html += this.renderHoverEffectsSettings(sIdx, rIdx, cIdx, mIdx);

            // Transform Section (🔄 Divi-style transform controls)
            html += this.renderTransformSettings(sIdx, rIdx, cIdx, mIdx);

            // Filter Section (🎨 CSS Filters - Divi-style)
            html += this.renderFilterSettings(sIdx, rIdx, cIdx, mIdx);

            // Position Section (📍 Divi-style positioning)
            html += this.renderPositionSettings(sIdx, rIdx, cIdx, mIdx);

            // Animation Section (✨ Divi-style entrance animations)
            html += this.renderAnimationSettings(sIdx, rIdx, cIdx, mIdx);

            return html;
        },

        // ═══════════════════════════════════════════════════════════
        // HOVER EFFECTS SETTINGS (Divi-style hover editing)
        // ═══════════════════════════════════════════════════════════
        renderHoverEffectsSettings(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            const settings = mod?.settings || {};

            // Hover settings with defaults
            const hoverEnabled = settings.hover_enabled || false;
            const transitionDuration = settings.hover_transition_duration || '0.3';
            const transitionEasing = settings.hover_transition_easing || 'ease';

            // Hover color values
            const textColorHover = settings.text_color_hover || '';
            const bgColorHover = settings.background_color_hover || '';
            const borderColorHover = settings.border_color_hover || '';

            // Hover transform values
            const scaleHover = settings.transform_scale_hover || '1';
            const scaleXHover = settings.transform_scale_x_hover || '100';
            const scaleYHover = settings.transform_scale_y_hover || '100';
            const rotateZHover = settings.transform_rotate_z_hover || '0';
            const rotateXHover = settings.transform_rotate_x_hover || '0';
            const rotateYHover = settings.transform_rotate_y_hover || '0';
            const translateXHover = settings.transform_translate_x_hover || '0';
            const translateYHover = settings.transform_translate_y_hover || '0';
            const skewXHover = settings.transform_skew_x_hover || '0';
            const skewYHover = settings.transform_skew_y_hover || '0';

            // Hover opacity
            const opacityHover = settings.opacity_hover || '1';

            // Hover box shadow
            const boxShadowHoverEnabled = settings.box_shadow_hover_enabled || false;
            const boxShadowHoverH = parseInt(settings.box_shadow_hover_horizontal) || 0;
            const boxShadowHoverV = parseInt(settings.box_shadow_hover_vertical) || 8;
            const boxShadowHoverBlur = parseInt(settings.box_shadow_hover_blur) || 20;
            const boxShadowHoverSpread = parseInt(settings.box_shadow_hover_spread) || 0;
            const boxShadowHoverColor = settings.box_shadow_hover_color || 'rgba(0,0,0,0.15)';

            let html = '';

            // Section Header
            html += '<div class="tb-hover-section" id="hover-effects-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-hover-section-header" onclick="TB.toggleHoverSection(this)">';
            html += '<div class="tb-hover-section-title">👆 Hover Effects</div>';
            html += '<span class="tb-hover-section-toggle">▼</span>';
            html += '</div>';
            html += '<div class="tb-hover-section-body">';

            // Enable Hover Effects toggle
            html += '<div class="tb-hover-enable-row">';
            html += '<label><input type="checkbox" ' + (hoverEnabled ? 'checked' : '') + ' onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'hover_enabled\',this.checked)"> Enable Hover Effects</label>';
            html += '</div>';

            // Hover controls container (disabled when hover is off)
            html += '<div class="tb-hover-controls' + (hoverEnabled ? '' : ' tb-hover-disabled') + '" id="hover-controls-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';

            // Transition Settings
            html += '<div style="font-size:11px;font-weight:600;color:var(--tb-text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.03em">Transition</div>';

            // Duration
            html += '<div class="tb-hover-control-row">';
            html += '<label>Duration</label>';
            html += '<input type="range" min="0" max="2" step="0.1" value="' + transitionDuration + '" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'hover_transition_duration\',this.value)">';
            html += '<input type="number" min="0" max="2" step="0.1" value="' + transitionDuration + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'hover_transition_duration\',this.value)">s';
            html += '</div>';

            // Easing
            html += '<div class="tb-hover-control-row">';
            html += '<label>Easing</label>';
            html += '<select onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'hover_transition_easing\',this.value)">';
            html += '<option value="ease"' + (transitionEasing === 'ease' ? ' selected' : '') + '>Ease</option>';
            html += '<option value="ease-in"' + (transitionEasing === 'ease-in' ? ' selected' : '') + '>Ease In</option>';
            html += '<option value="ease-out"' + (transitionEasing === 'ease-out' ? ' selected' : '') + '>Ease Out</option>';
            html += '<option value="ease-in-out"' + (transitionEasing === 'ease-in-out' ? ' selected' : '') + '>Ease In-Out</option>';
            html += '<option value="linear"' + (transitionEasing === 'linear' ? ' selected' : '') + '>Linear</option>';
            html += '<option value="cubic-bezier(0.4, 0, 0.2, 1)"' + (transitionEasing === 'cubic-bezier(0.4, 0, 0.2, 1)' ? ' selected' : '') + '>Material</option>';
            html += '</select>';
            html += '</div>';

            // Hover Colors Section
            html += '<div style="font-size:11px;font-weight:600;color:var(--tb-text-muted);margin:16px 0 8px;text-transform:uppercase;letter-spacing:0.03em;border-top:1px solid var(--tb-border);padding-top:12px">Hover Colors</div>';

            html += '<div class="tb-hover-colors-grid">';

            // Text Color Hover
            html += '<div class="tb-hover-color-item">';
            html += '<label>Text Color</label>';
            html += '<div class="tb-hover-color-input">';
            html += '<input type="color" value="' + (textColorHover || '#333333') + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_color_hover\',this.value)">';
            html += '<input type="text" value="' + textColorHover + '" placeholder="inherit" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text_color_hover\',this.value)">';
            html += '</div></div>';

            // Background Color Hover
            html += '<div class="tb-hover-color-item">';
            html += '<label>Background</label>';
            html += '<div class="tb-hover-color-input">';
            html += '<input type="color" value="' + (bgColorHover || '#ffffff') + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_color_hover\',this.value)">';
            html += '<input type="text" value="' + bgColorHover + '" placeholder="inherit" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background_color_hover\',this.value)">';
            html += '</div></div>';

            // Border Color Hover
            html += '<div class="tb-hover-color-item">';
            html += '<label>Border</label>';
            html += '<div class="tb-hover-color-input">';
            html += '<input type="color" value="' + (borderColorHover || '#e2e8f0') + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_color_hover\',this.value)">';
            html += '<input type="text" value="' + borderColorHover + '" placeholder="inherit" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_color_hover\',this.value)">';
            html += '</div></div>';

            // Opacity Hover
            html += '<div class="tb-hover-color-item">';
            html += '<label>Opacity</label>';
            html += '<div class="tb-hover-color-input">';
            html += '<input type="range" min="0" max="1" step="0.05" value="' + opacityHover + '" style="flex:1" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'opacity_hover\',this.value)">';
            html += '<input type="number" min="0" max="1" step="0.05" value="' + opacityHover + '" style="width:50px" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'opacity_hover\',this.value)">';
            html += '</div></div>';

            html += '</div>'; // colors grid

            // Transform Section (Expanded with all transform properties)
            html += '<div style="font-size:11px;font-weight:600;color:var(--tb-text-muted);margin:16px 0 8px;text-transform:uppercase;letter-spacing:0.03em;border-top:1px solid var(--tb-border);padding-top:12px">Hover Transform</div>';

            // Scale X
            html += '<div class="tb-hover-transform-row">';
            html += '<label>Scale X</label>';
            html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(scaleXHover) + '" style="flex:1" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_scale_x_hover\',this.value)">';
            html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(scaleXHover) + '" style="width:60px;padding:4px;background:var(--tb-surface);border:1px solid var(--tb-border);border-radius:4px;color:var(--tb-text);font-size:11px" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_scale_x_hover\',this.value)">%';
            html += '</div>';

            // Scale Y
            html += '<div class="tb-hover-transform-row">';
            html += '<label>Scale Y</label>';
            html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(scaleYHover) + '" style="flex:1" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_scale_y_hover\',this.value)">';
            html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(scaleYHover) + '" style="width:60px;padding:4px;background:var(--tb-surface);border:1px solid var(--tb-border);border-radius:4px;color:var(--tb-text);font-size:11px" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_scale_y_hover\',this.value)">%';
            html += '</div>';

            // Rotate Z
            html += '<div class="tb-hover-transform-row">';
            html += '<label>Rotate Z</label>';
            html += '<input type="range" min="-180" max="180" step="1" value="' + parseFloat(rotateZHover) + '" style="flex:1" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_rotate_z_hover\',this.value)">';
            html += '<input type="number" min="-180" max="180" step="1" value="' + parseFloat(rotateZHover) + '" style="width:60px;padding:4px;background:var(--tb-surface);border:1px solid var(--tb-border);border-radius:4px;color:var(--tb-text);font-size:11px" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_rotate_z_hover\',this.value)">°';
            html += '</div>';

            // Translate X
            html += '<div class="tb-hover-transform-row">';
            html += '<label>Move X</label>';
            html += '<input type="range" min="-100" max="100" step="1" value="' + parseFloat(translateXHover) + '" style="flex:1" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_translate_x_hover\',this.value)">';
            html += '<input type="number" min="-100" max="100" step="1" value="' + parseFloat(translateXHover) + '" style="width:60px;padding:4px;background:var(--tb-surface);border:1px solid var(--tb-border);border-radius:4px;color:var(--tb-text);font-size:11px" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_translate_x_hover\',this.value)">px';
            html += '</div>';

            // Translate Y
            html += '<div class="tb-hover-transform-row">';
            html += '<label>Move Y</label>';
            html += '<input type="range" min="-100" max="100" step="1" value="' + parseFloat(translateYHover) + '" style="flex:1" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_translate_y_hover\',this.value)">';
            html += '<input type="number" min="-100" max="100" step="1" value="' + parseFloat(translateYHover) + '" style="width:60px;padding:4px;background:var(--tb-surface);border:1px solid var(--tb-border);border-radius:4px;color:var(--tb-text);font-size:11px" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_translate_y_hover\',this.value)">px';
            html += '</div>';

            // Box Shadow Hover Section
            html += '<div style="font-size:11px;font-weight:600;color:var(--tb-text-muted);margin:16px 0 8px;text-transform:uppercase;letter-spacing:0.03em;border-top:1px solid var(--tb-border);padding-top:12px">Hover Shadow</div>';

            // Enable hover shadow
            html += '<div class="tb-hover-enable-row" style="border-bottom:none;margin-bottom:8px">';
            html += '<label><input type="checkbox" ' + (boxShadowHoverEnabled ? 'checked' : '') + ' onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_hover_enabled\',this.checked)"> Different shadow on hover</label>';
            html += '</div>';

            // Hover shadow controls
            html += '<div class="' + (boxShadowHoverEnabled ? '' : 'tb-hover-disabled') + '" id="hover-shadow-controls-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';

            // Horizontal
            html += '<div class="tb-hover-control-row">';
            html += '<label>Horizontal</label>';
            html += '<input type="range" min="-50" max="50" value="' + boxShadowHoverH + '" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_hover_horizontal\',this.value)">';
            html += '<input type="number" min="-50" max="50" value="' + boxShadowHoverH + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_hover_horizontal\',this.value)">px';
            html += '</div>';

            // Vertical
            html += '<div class="tb-hover-control-row">';
            html += '<label>Vertical</label>';
            html += '<input type="range" min="-50" max="50" value="' + boxShadowHoverV + '" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_hover_vertical\',this.value)">';
            html += '<input type="number" min="-50" max="50" value="' + boxShadowHoverV + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_hover_vertical\',this.value)">px';
            html += '</div>';

            // Blur
            html += '<div class="tb-hover-control-row">';
            html += '<label>Blur</label>';
            html += '<input type="range" min="0" max="100" value="' + boxShadowHoverBlur + '" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_hover_blur\',this.value)">';
            html += '<input type="number" min="0" max="100" value="' + boxShadowHoverBlur + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_hover_blur\',this.value)">px';
            html += '</div>';

            // Spread
            html += '<div class="tb-hover-control-row">';
            html += '<label>Spread</label>';
            html += '<input type="range" min="-50" max="50" value="' + boxShadowHoverSpread + '" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_hover_spread\',this.value)">';
            html += '<input type="number" min="-50" max="50" value="' + boxShadowHoverSpread + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_hover_spread\',this.value)">px';
            html += '</div>';

            // Color
            html += '<div class="tb-hover-control-row">';
            html += '<label>Color</label>';
            html += '<input type="color" value="' + this.rgbaToHex(boxShadowHoverColor) + '" onchange="TB.updateHoverShadowColor(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',this.value)">';
            html += '<input type="text" value="' + boxShadowHoverColor + '" placeholder="rgba(0,0,0,0.15)" style="flex:1" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_hover_color\',this.value)">';
            html += '</div>';

            html += '</div>'; // hover shadow controls

            // Hover Filters Section
            html += '<div style="font-size:11px;font-weight:600;color:var(--tb-text-muted);margin:16px 0 8px;text-transform:uppercase;letter-spacing:0.03em;border-top:1px solid var(--tb-border);padding-top:12px">Hover Filters</div>';

            // Get hover filter values
            const filterBlurHover = settings.filter_blur_hover || settings.filter_blur || '0';
            const filterBrightnessHover = settings.filter_brightness_hover || settings.filter_brightness || '100';
            const filterContrastHover = settings.filter_contrast_hover || settings.filter_contrast || '100';
            const filterSaturationHover = settings.filter_saturation_hover || settings.filter_saturation || '100';
            const filterGrayscaleHover = settings.filter_grayscale_hover || settings.filter_grayscale || '0';
            const filterHoverEnabled = settings.filter_hover_enabled || false;

            // Enable hover filters
            html += '<div class="tb-hover-enable-row" style="border-bottom:none;margin-bottom:8px">';
            html += '<label><input type="checkbox" ' + (filterHoverEnabled ? 'checked' : '') + ' onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_hover_enabled\',this.checked)"> Different filters on hover</label>';
            html += '</div>';

            // Hover filter controls
            html += '<div class="' + (filterHoverEnabled ? '' : 'tb-hover-disabled') + '" id="hover-filter-controls-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';

            // Blur
            html += '<div class="tb-hover-control-row">';
            html += '<label>Blur</label>';
            html += '<input type="range" min="0" max="20" step="0.5" value="' + parseFloat(filterBlurHover) + '" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_blur_hover\',this.value)">';
            html += '<input type="number" min="0" max="20" step="0.5" value="' + parseFloat(filterBlurHover) + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_blur_hover\',this.value)">px';
            html += '</div>';

            // Brightness
            html += '<div class="tb-hover-control-row">';
            html += '<label>Brightness</label>';
            html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(filterBrightnessHover) + '" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_brightness_hover\',this.value)">';
            html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(filterBrightnessHover) + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_brightness_hover\',this.value)">%';
            html += '</div>';

            // Contrast
            html += '<div class="tb-hover-control-row">';
            html += '<label>Contrast</label>';
            html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(filterContrastHover) + '" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_contrast_hover\',this.value)">';
            html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(filterContrastHover) + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_contrast_hover\',this.value)">%';
            html += '</div>';

            // Saturation
            html += '<div class="tb-hover-control-row">';
            html += '<label>Saturation</label>';
            html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(filterSaturationHover) + '" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_saturation_hover\',this.value)">';
            html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(filterSaturationHover) + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_saturation_hover\',this.value)">%';
            html += '</div>';

            // Grayscale (common hover effect)
            html += '<div class="tb-hover-control-row">';
            html += '<label>Grayscale</label>';
            html += '<input type="range" min="0" max="100" step="1" value="' + parseFloat(filterGrayscaleHover) + '" oninput="TB.updateHoverSettingSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_grayscale_hover\',this.value)">';
            html += '<input type="number" min="0" max="100" step="1" value="' + parseFloat(filterGrayscaleHover) + '" onchange="TB.updateHoverSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_grayscale_hover\',this.value)">%';
            html += '</div>';

            html += '</div>'; // hover filter controls

            // Hover Preview Button
            html += '<button type="button" class="tb-hover-preview-btn' + (this.hoverPreviewActive ? ' active' : '') + '" onclick="TB.toggleHoverPreview(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">';
            html += '<span>👆</span> ' + (this.hoverPreviewActive ? 'Exit Hover Preview' : 'Preview Hover State');
            html += '</button>';

            html += '</div>'; // controls
            html += '</div>'; // body
            html += '</div>'; // section

            return html;
        },

        // Toggle hover effects section collapse
        toggleHoverSection(element) {
            const section = element.closest('.tb-hover-section');
            if (section) {
                section.classList.toggle('collapsed');
            }
        },

        // ═══════════════════════════════════════════════════════════
        // TRANSFORM SETTINGS (Divi-style transform controls)
        // ═══════════════════════════════════════════════════════════
        renderTransformSettings(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            const settings = mod?.settings || {};

            // Transform settings with defaults
            const scaleX = settings.transform_scale_x || '100';
            const scaleY = settings.transform_scale_y || '100';
            const scaleLinked = settings.transform_scale_linked !== false; // default true
            const rotateZ = settings.transform_rotate_z || '0';
            const rotateX = settings.transform_rotate_x || '0';
            const rotateY = settings.transform_rotate_y || '0';
            const translateX = settings.transform_translate_x || '0';
            const translateY = settings.transform_translate_y || '0';
            const skewX = settings.transform_skew_x || '0';
            const skewY = settings.transform_skew_y || '0';
            const transformOrigin = settings.transform_origin || 'center center';

            // Parse origin for grid selection
            const originParts = transformOrigin.split(' ');
            const originX = originParts[0] || 'center';
            const originY = originParts[1] || 'center';

            let html = '';

            // Section Header
            html += '<div class="tb-transform-section" id="transform-section-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-transform-section-header" onclick="TB.toggleTransformSection(this)">';
            html += '<div class="tb-transform-section-title">🔄 Transform</div>';
            html += '<span class="tb-transform-section-toggle">▼</span>';
            html += '</div>';
            html += '<div class="tb-transform-section-body">';

            // ═══════════════════════════════════════════════════════════
            // SCALE SECTION
            // ═══════════════════════════════════════════════════════════
            html += '<div class="tb-transform-subsection">';
            html += '<div class="tb-transform-subsection-title">📐 Scale</div>';

            // Link toggle
            html += '<label class="tb-scale-link-toggle' + (scaleLinked ? ' linked' : '') + '">';
            html += '<input type="checkbox" ' + (scaleLinked ? 'checked' : '') + ' onchange="TB.toggleScaleLink(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',this.checked)">';
            html += '<span>🔗 Link X & Y</span>';
            html += '</label>';

            // Scale X
            html += '<div class="tb-transform-control-row">';
            html += '<label>Scale X</label>';
            html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(scaleX) + '" id="transform-scale-x-range-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" oninput="TB.updateTransformSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_scale_x\',this.value)">';
            html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(scaleX) + '" id="transform-scale-x-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" onchange="TB.updateTransformSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_scale_x\',this.value)">';
            html += '<span class="tb-unit-label">%</span>';
            html += '</div>';

            // Scale Y
            html += '<div class="tb-transform-control-row">';
            html += '<label>Scale Y</label>';
            html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(scaleY) + '" id="transform-scale-y-range-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" oninput="TB.updateTransformSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_scale_y\',this.value)">';
            html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(scaleY) + '" id="transform-scale-y-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" onchange="TB.updateTransformSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_scale_y\',this.value)">';
            html += '<span class="tb-unit-label">%</span>';
            html += '</div>';

            html += '</div>'; // scale subsection

            // ═══════════════════════════════════════════════════════════
            // ROTATE SECTION
            // ═══════════════════════════════════════════════════════════
            html += '<div class="tb-transform-subsection">';
            html += '<div class="tb-transform-subsection-title">🔃 Rotate</div>';

            // Rotate Z (main rotation)
            html += '<div class="tb-transform-control-row">';
            html += '<label>Rotate Z</label>';
            html += '<input type="range" min="-180" max="180" step="1" value="' + parseFloat(rotateZ) + '" oninput="TB.updateTransformSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_rotate_z\',this.value)">';
            html += '<input type="number" min="-180" max="180" step="1" value="' + parseFloat(rotateZ) + '" onchange="TB.updateTransformSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_rotate_z\',this.value)">';
            html += '<span class="tb-unit-label">°</span>';
            html += '</div>';

            // Rotate X (3D)
            html += '<div class="tb-transform-control-row">';
            html += '<label>Rotate X <small style="color:var(--tb-text-muted)">(3D)</small></label>';
            html += '<input type="range" min="-180" max="180" step="1" value="' + parseFloat(rotateX) + '" oninput="TB.updateTransformSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_rotate_x\',this.value)">';
            html += '<input type="number" min="-180" max="180" step="1" value="' + parseFloat(rotateX) + '" onchange="TB.updateTransformSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_rotate_x\',this.value)">';
            html += '<span class="tb-unit-label">°</span>';
            html += '</div>';

            // Rotate Y (3D)
            html += '<div class="tb-transform-control-row">';
            html += '<label>Rotate Y <small style="color:var(--tb-text-muted)">(3D)</small></label>';
            html += '<input type="range" min="-180" max="180" step="1" value="' + parseFloat(rotateY) + '" oninput="TB.updateTransformSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_rotate_y\',this.value)">';
            html += '<input type="number" min="-180" max="180" step="1" value="' + parseFloat(rotateY) + '" onchange="TB.updateTransformSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_rotate_y\',this.value)">';
            html += '<span class="tb-unit-label">°</span>';
            html += '</div>';

            html += '</div>'; // rotate subsection

            // ═══════════════════════════════════════════════════════════
            // TRANSLATE SECTION
            // ═══════════════════════════════════════════════════════════
            html += '<div class="tb-transform-subsection">';
            html += '<div class="tb-transform-subsection-title">↔️ Translate</div>';

            // Translate X
            html += '<div class="tb-transform-control-row">';
            html += '<label>Move X</label>';
            html += '<input type="range" min="-200" max="200" step="1" value="' + parseFloat(translateX) + '" oninput="TB.updateTransformSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_translate_x\',this.value)">';
            html += '<input type="number" min="-200" max="200" step="1" value="' + parseFloat(translateX) + '" onchange="TB.updateTransformSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_translate_x\',this.value)">';
            html += '<span class="tb-unit-label">px</span>';
            html += '</div>';

            // Translate Y
            html += '<div class="tb-transform-control-row">';
            html += '<label>Move Y</label>';
            html += '<input type="range" min="-200" max="200" step="1" value="' + parseFloat(translateY) + '" oninput="TB.updateTransformSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_translate_y\',this.value)">';
            html += '<input type="number" min="-200" max="200" step="1" value="' + parseFloat(translateY) + '" onchange="TB.updateTransformSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_translate_y\',this.value)">';
            html += '<span class="tb-unit-label">px</span>';
            html += '</div>';

            html += '</div>'; // translate subsection

            // ═══════════════════════════════════════════════════════════
            // SKEW SECTION
            // ═══════════════════════════════════════════════════════════
            html += '<div class="tb-transform-subsection">';
            html += '<div class="tb-transform-subsection-title">◇ Skew</div>';

            // Skew X
            html += '<div class="tb-transform-control-row">';
            html += '<label>Skew X</label>';
            html += '<input type="range" min="-60" max="60" step="1" value="' + parseFloat(skewX) + '" oninput="TB.updateTransformSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_skew_x\',this.value)">';
            html += '<input type="number" min="-60" max="60" step="1" value="' + parseFloat(skewX) + '" onchange="TB.updateTransformSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_skew_x\',this.value)">';
            html += '<span class="tb-unit-label">°</span>';
            html += '</div>';

            // Skew Y
            html += '<div class="tb-transform-control-row">';
            html += '<label>Skew Y</label>';
            html += '<input type="range" min="-60" max="60" step="1" value="' + parseFloat(skewY) + '" oninput="TB.updateTransformSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_skew_y\',this.value)">';
            html += '<input type="number" min="-60" max="60" step="1" value="' + parseFloat(skewY) + '" onchange="TB.updateTransformSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transform_skew_y\',this.value)">';
            html += '<span class="tb-unit-label">°</span>';
            html += '</div>';

            html += '</div>'; // skew subsection

            // ═══════════════════════════════════════════════════════════
            // TRANSFORM ORIGIN SECTION
            // ═══════════════════════════════════════════════════════════
            html += '<div class="tb-transform-subsection">';
            html += '<div class="tb-transform-subsection-title">⊕ Transform Origin</div>';

            html += '<div class="tb-transform-origin-wrapper">';

            // 9-point grid
            html += '<div class="tb-transform-origin-grid">';
            const originPoints = [
                { x: 'left', y: 'top', label: 'TL' },
                { x: 'center', y: 'top', label: 'TC' },
                { x: 'right', y: 'top', label: 'TR' },
                { x: 'left', y: 'center', label: 'CL' },
                { x: 'center', y: 'center', label: 'C' },
                { x: 'right', y: 'center', label: 'CR' },
                { x: 'left', y: 'bottom', label: 'BL' },
                { x: 'center', y: 'bottom', label: 'BC' },
                { x: 'right', y: 'bottom', label: 'BR' }
            ];

            originPoints.forEach(point => {
                const isActive = (originX === point.x && originY === point.y) ||
                               (transformOrigin === point.x + ' ' + point.y);
                html += '<div class="tb-transform-origin-point' + (isActive ? ' active' : '') + '" ';
                html += 'data-origin="' + point.x + ' ' + point.y + '" ';
                html += 'title="' + point.label + '" ';
                html += 'onclick="TB.setTransformOrigin(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + point.x + '\',\'' + point.y + '\')">';
                html += '</div>';
            });

            html += '</div>'; // grid

            // Current value display
            html += '<div class="tb-transform-origin-value">' + transformOrigin + '</div>';

            // Custom input
            html += '<div class="tb-transform-origin-custom">';
            html += '<label><input type="text" value="' + originX + '" placeholder="50%" onchange="TB.setTransformOriginCustom(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',this.value,null)">X</label>';
            html += '<label><input type="text" value="' + originY + '" placeholder="50%" onchange="TB.setTransformOriginCustom(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',null,this.value)">Y</label>';
            html += '</div>';

            html += '</div>'; // origin wrapper
            html += '</div>'; // origin subsection

            // Reset Button
            html += '<button type="button" class="tb-transform-reset-btn" onclick="TB.resetTransforms(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">';
            html += '<span>↺</span> Reset All Transforms';
            html += '</button>';

            html += '</div>'; // body
            html += '</div>'; // section

            return html;
        },

        // Toggle transform section collapse
        toggleTransformSection(element) {
            const section = element.closest('.tb-transform-section');
            if (section) {
                section.classList.toggle('collapsed');
            }
        },

        // ═══════════════════════════════════════════════════════════
        // TRANSFORM HELPER FUNCTIONS
        // ═══════════════════════════════════════════════════════════

        // Update transform setting
        updateTransformSetting(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            mod.settings[property] = value;

            // Handle linked scale
            if ((property === 'transform_scale_x' || property === 'transform_scale_y') && mod.settings.transform_scale_linked !== false) {
                const otherProp = property === 'transform_scale_x' ? 'transform_scale_y' : 'transform_scale_x';
                mod.settings[otherProp] = value;
            }

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Update transform setting from slider (real-time)
        updateTransformSlider(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            mod.settings[property] = value;

            // Handle linked scale
            if ((property === 'transform_scale_x' || property === 'transform_scale_y') && mod.settings.transform_scale_linked !== false) {
                const otherProp = property === 'transform_scale_x' ? 'transform_scale_y' : 'transform_scale_x';
                mod.settings[otherProp] = value;

                // Update the other slider and number input
                const otherId = otherProp.replace('transform_', 'transform-').replace('_', '-');
                const otherRange = document.getElementById(otherId + '-range-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx);
                const otherNum = document.getElementById(otherId + '-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx);
                if (otherRange) otherRange.value = value;
                if (otherNum) otherNum.value = value;
            }

            // Update the corresponding number input
            const sectionEl = document.getElementById('transform-section-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx);
            if (sectionEl) {
                const rows = sectionEl.querySelectorAll('.tb-transform-control-row');
                rows.forEach(row => {
                    const range = row.querySelector('input[type="range"]');
                    const number = row.querySelector('input[type="number"]');
                    if (range && number && range === event.target) {
                        number.value = value;
                    }
                });
            }

            // Debounced save and render
            clearTimeout(this.transformUpdateTimer);
            this.transformUpdateTimer = setTimeout(() => {
                this.saveToHistory();
                this.renderCanvas();
            }, 100);
        },

        // Toggle scale link
        toggleScaleLink(sIdx, rIdx, cIdx, mIdx, linked) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            mod.settings.transform_scale_linked = linked;

            // If linking, sync Y to X
            if (linked) {
                mod.settings.transform_scale_y = mod.settings.transform_scale_x || '100';
            }

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Set transform origin from grid
        setTransformOrigin(sIdx, rIdx, cIdx, mIdx, x, y) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            mod.settings.transform_origin = x + ' ' + y;

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Set transform origin from custom inputs
        setTransformOriginCustom(sIdx, rIdx, cIdx, mIdx, x, y) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            const currentOrigin = (mod.settings.transform_origin || 'center center').split(' ');
            const newX = x !== null ? x : currentOrigin[0];
            const newY = y !== null ? y : currentOrigin[1];

            mod.settings.transform_origin = newX + ' ' + newY;

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Reset all transforms to defaults
        resetTransforms(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            // Reset all transform properties
            mod.settings.transform_scale_x = '100';
            mod.settings.transform_scale_y = '100';
            mod.settings.transform_scale_linked = true;
            mod.settings.transform_rotate_z = '0';
            mod.settings.transform_rotate_x = '0';
            mod.settings.transform_rotate_y = '0';
            mod.settings.transform_translate_x = '0';
            mod.settings.transform_translate_y = '0';
            mod.settings.transform_skew_x = '0';
            mod.settings.transform_skew_y = '0';
            mod.settings.transform_origin = 'center center';

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Build transform CSS string from settings
        getTransformCSS(settings) {
            const parts = [];

            // Translate (applied first)
            const translateX = settings.transform_translate_x || '0';
            const translateY = settings.transform_translate_y || '0';
            if (translateX !== '0' && translateX !== '0px') {
                parts.push('translateX(' + (translateX.includes('px') ? translateX : translateX + 'px') + ')');
            }
            if (translateY !== '0' && translateY !== '0px') {
                parts.push('translateY(' + (translateY.includes('px') ? translateY : translateY + 'px') + ')');
            }

            // Rotate
            const rotateZ = settings.transform_rotate_z || '0';
            const rotateX = settings.transform_rotate_x || '0';
            const rotateY = settings.transform_rotate_y || '0';
            if (rotateZ !== '0' && rotateZ !== '0deg') {
                parts.push('rotateZ(' + (rotateZ.includes('deg') ? rotateZ : rotateZ + 'deg') + ')');
            }
            if (rotateX !== '0' && rotateX !== '0deg') {
                parts.push('rotateX(' + (rotateX.includes('deg') ? rotateX : rotateX + 'deg') + ')');
            }
            if (rotateY !== '0' && rotateY !== '0deg') {
                parts.push('rotateY(' + (rotateY.includes('deg') ? rotateY : rotateY + 'deg') + ')');
            }

            // Scale
            const scaleX = settings.transform_scale_x || '100';
            const scaleY = settings.transform_scale_y || '100';
            const scaleXVal = parseFloat(scaleX.toString().replace('%', '')) / 100;
            const scaleYVal = parseFloat(scaleY.toString().replace('%', '')) / 100;
            if (scaleXVal !== 1 || scaleYVal !== 1) {
                if (scaleXVal === scaleYVal) {
                    parts.push('scale(' + scaleXVal + ')');
                } else {
                    parts.push('scale(' + scaleXVal + ',' + scaleYVal + ')');
                }
            }

            // Skew
            const skewX = settings.transform_skew_x || '0';
            const skewY = settings.transform_skew_y || '0';
            if (skewX !== '0' && skewX !== '0deg') {
                parts.push('skewX(' + (skewX.includes('deg') ? skewX : skewX + 'deg') + ')');
            }
            if (skewY !== '0' && skewY !== '0deg') {
                parts.push('skewY(' + (skewY.includes('deg') ? skewY : skewY + 'deg') + ')');
            }

            return parts.length > 0 ? parts.join(' ') : 'none';
        },

        // ═══════════════════════════════════════════════════════════
        // FILTER SETTINGS (Divi-style CSS filters)
        // ═══════════════════════════════════════════════════════════
        renderFilterSettings(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            const settings = mod?.settings || {};

            // Filter settings with defaults
            const filterBlur = settings.filter_blur || '0';
            const filterBrightness = settings.filter_brightness || '100';
            const filterContrast = settings.filter_contrast || '100';
            const filterSaturation = settings.filter_saturation || '100';
            const filterHueRotate = settings.filter_hue_rotate || '0';
            const filterGrayscale = settings.filter_grayscale || '0';
            const filterSepia = settings.filter_sepia || '0';
            const filterInvert = settings.filter_invert || '0';
            const filterOpacity = settings.filter_opacity || '100';
            const filterPreset = settings.filter_preset || 'none';

            let html = '';

            // Section Header
            html += '<div class="tb-filter-section" id="filter-section-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-filter-section-header" onclick="TB.toggleFilterSection(this)">';
            html += '<div class="tb-filter-section-title">🎨 Filters</div>';
            html += '<span class="tb-filter-section-toggle">▼</span>';
            html += '</div>';
            html += '<div class="tb-filter-section-body">';

            // Live Preview Thumbnail
            const previewFilter = this.getFilterCSS(settings);
            html += '<div class="tb-filter-preview" id="filter-preview-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" style="filter:' + previewFilter + '">';
            html += '<div class="tb-filter-preview-content">';
            html += '<span class="tb-filter-preview-icon">🖼️</span>';
            html += '<span>Preview</span>';
            html += '</div>';
            html += '<span class="tb-filter-preview-label">Live Preview</span>';
            html += '</div>';

            // ═══════════════════════════════════════════════════════════
            // PRESET DROPDOWN
            // ═══════════════════════════════════════════════════════════
            html += '<div class="tb-filter-preset-row">';
            html += '<label>Preset</label>';
            html += '<select onchange="TB.applyFilterPreset(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',this.value)">';
            html += '<option value="none"' + (filterPreset === 'none' ? ' selected' : '') + '>None (Default)</option>';
            html += '<option value="vivid"' + (filterPreset === 'vivid' ? ' selected' : '') + '>Vivid</option>';
            html += '<option value="muted"' + (filterPreset === 'muted' ? ' selected' : '') + '>Muted</option>';
            html += '<option value="vintage"' + (filterPreset === 'vintage' ? ' selected' : '') + '>Vintage</option>';
            html += '<option value="blackwhite"' + (filterPreset === 'blackwhite' ? ' selected' : '') + '>Black & White</option>';
            html += '<option value="dramatic"' + (filterPreset === 'dramatic' ? ' selected' : '') + '>Dramatic</option>';
            html += '<option value="warm"' + (filterPreset === 'warm' ? ' selected' : '') + '>Warm</option>';
            html += '<option value="cool"' + (filterPreset === 'cool' ? ' selected' : '') + '>Cool</option>';
            html += '</select>';
            html += '</div>';

            // ═══════════════════════════════════════════════════════════
            // BLUR SECTION
            // ═══════════════════════════════════════════════════════════
            html += '<div class="tb-filter-subsection">';
            html += '<div class="tb-filter-subsection-title">🌫️ Blur</div>';
            html += '<div class="tb-filter-control-row">';
            html += '<label>Blur</label>';
            html += '<input type="range" min="0" max="20" step="0.5" value="' + parseFloat(filterBlur) + '" id="filter-blur-range-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" oninput="TB.updateFilterSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_blur\',this.value)">';
            html += '<input type="number" min="0" max="20" step="0.5" value="' + parseFloat(filterBlur) + '" id="filter-blur-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" onchange="TB.updateFilter(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_blur\',this.value)">';
            html += '<span class="tb-unit-label">px</span>';
            html += '</div>';
            html += '</div>';

            // ═══════════════════════════════════════════════════════════
            // BRIGHTNESS & CONTRAST SECTION
            // ═══════════════════════════════════════════════════════════
            html += '<div class="tb-filter-subsection">';
            html += '<div class="tb-filter-subsection-title">☀️ Brightness & Contrast</div>';

            // Brightness
            html += '<div class="tb-filter-control-row">';
            html += '<label>Brightness</label>';
            html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(filterBrightness) + '" id="filter-brightness-range-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" oninput="TB.updateFilterSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_brightness\',this.value)">';
            html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(filterBrightness) + '" id="filter-brightness-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" onchange="TB.updateFilter(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_brightness\',this.value)">';
            html += '<span class="tb-unit-label">%</span>';
            html += '</div>';

            // Contrast
            html += '<div class="tb-filter-control-row">';
            html += '<label>Contrast</label>';
            html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(filterContrast) + '" id="filter-contrast-range-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" oninput="TB.updateFilterSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_contrast\',this.value)">';
            html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(filterContrast) + '" id="filter-contrast-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" onchange="TB.updateFilter(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_contrast\',this.value)">';
            html += '<span class="tb-unit-label">%</span>';
            html += '</div>';

            html += '</div>';

            // ═══════════════════════════════════════════════════════════
            // COLOR ADJUSTMENTS SECTION
            // ═══════════════════════════════════════════════════════════
            html += '<div class="tb-filter-subsection">';
            html += '<div class="tb-filter-subsection-title">🎨 Color Adjustments</div>';

            // Saturation
            html += '<div class="tb-filter-control-row">';
            html += '<label>Saturation</label>';
            html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(filterSaturation) + '" id="filter-saturation-range-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" oninput="TB.updateFilterSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_saturation\',this.value)">';
            html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(filterSaturation) + '" id="filter-saturation-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" onchange="TB.updateFilter(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_saturation\',this.value)">';
            html += '<span class="tb-unit-label">%</span>';
            html += '</div>';

            // Hue Rotate with color wheel
            html += '<div class="tb-filter-control-row">';
            html += '<label>Hue Rotate</label>';
            html += '<div class="tb-hue-wheel-wrapper">';
            html += '<div class="tb-hue-wheel" id="hue-wheel-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-hue-indicator" style="transform:rotate(' + parseFloat(filterHueRotate) + 'deg)"></div>';
            html += '</div>';
            html += '<input type="range" min="0" max="360" step="1" value="' + parseFloat(filterHueRotate) + '" id="filter-hue-rotate-range-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" oninput="TB.updateFilterSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_hue_rotate\',this.value); TB.updateHueWheel(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',this.value)">';
            html += '</div>';
            html += '<input type="number" min="0" max="360" step="1" value="' + parseFloat(filterHueRotate) + '" id="filter-hue-rotate-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" onchange="TB.updateFilter(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_hue_rotate\',this.value); TB.updateHueWheel(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',this.value)">';
            html += '<span class="tb-unit-label">°</span>';
            html += '</div>';

            html += '</div>';

            // ═══════════════════════════════════════════════════════════
            // EFFECTS SECTION
            // ═══════════════════════════════════════════════════════════
            html += '<div class="tb-filter-subsection">';
            html += '<div class="tb-filter-subsection-title">✨ Effects</div>';

            // Grayscale
            html += '<div class="tb-filter-control-row">';
            html += '<label>Grayscale</label>';
            html += '<input type="range" min="0" max="100" step="1" value="' + parseFloat(filterGrayscale) + '" id="filter-grayscale-range-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" oninput="TB.updateFilterSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_grayscale\',this.value)">';
            html += '<input type="number" min="0" max="100" step="1" value="' + parseFloat(filterGrayscale) + '" id="filter-grayscale-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" onchange="TB.updateFilter(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_grayscale\',this.value)">';
            html += '<span class="tb-unit-label">%</span>';
            html += '</div>';

            // Sepia
            html += '<div class="tb-filter-control-row">';
            html += '<label>Sepia</label>';
            html += '<input type="range" min="0" max="100" step="1" value="' + parseFloat(filterSepia) + '" id="filter-sepia-range-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" oninput="TB.updateFilterSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_sepia\',this.value)">';
            html += '<input type="number" min="0" max="100" step="1" value="' + parseFloat(filterSepia) + '" id="filter-sepia-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" onchange="TB.updateFilter(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_sepia\',this.value)">';
            html += '<span class="tb-unit-label">%</span>';
            html += '</div>';

            // Invert
            html += '<div class="tb-filter-control-row">';
            html += '<label>Invert</label>';
            html += '<input type="range" min="0" max="100" step="1" value="' + parseFloat(filterInvert) + '" id="filter-invert-range-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" oninput="TB.updateFilterSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_invert\',this.value)">';
            html += '<input type="number" min="0" max="100" step="1" value="' + parseFloat(filterInvert) + '" id="filter-invert-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" onchange="TB.updateFilter(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_invert\',this.value)">';
            html += '<span class="tb-unit-label">%</span>';
            html += '</div>';

            html += '</div>';

            // ═══════════════════════════════════════════════════════════
            // OPACITY SECTION
            // ═══════════════════════════════════════════════════════════
            html += '<div class="tb-filter-subsection">';
            html += '<div class="tb-filter-subsection-title">👁️ Opacity</div>';

            // Opacity
            html += '<div class="tb-filter-control-row">';
            html += '<label>Opacity</label>';
            html += '<input type="range" min="0" max="100" step="1" value="' + parseFloat(filterOpacity) + '" id="filter-opacity-range-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" oninput="TB.updateFilterSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_opacity\',this.value)">';
            html += '<input type="number" min="0" max="100" step="1" value="' + parseFloat(filterOpacity) + '" id="filter-opacity-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" onchange="TB.updateFilter(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'filter_opacity\',this.value)">';
            html += '<span class="tb-unit-label">%</span>';
            html += '</div>';

            html += '</div>';

            // Reset Button
            html += '<button type="button" class="tb-filter-reset-btn" onclick="TB.resetFilters(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">';
            html += '<span>↺</span> Reset All Filters';
            html += '</button>';

            html += '</div>'; // body
            html += '</div>'; // section

            return html;
        },

        // Toggle filter section collapse
        toggleFilterSection(element) {
            const section = element.closest('.tb-filter-section');
            if (section) {
                section.classList.toggle('collapsed');
            }
        },

        // ═══════════════════════════════════════════════════════════
        // POSITION SETTINGS (Divi-style positioning controls)
        // ═══════════════════════════════════════════════════════════
        renderPositionSettings(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            const settings = mod?.settings || {};

            // Position settings with defaults
            const positionType = settings.position || 'static';
            const positionTop = settings.position_top || '';
            const positionRight = settings.position_right || '';
            const positionBottom = settings.position_bottom || '';
            const positionLeft = settings.position_left || '';
            const positionTopUnit = settings.position_top_unit || 'px';
            const positionRightUnit = settings.position_right_unit || 'px';
            const positionBottomUnit = settings.position_bottom_unit || 'px';
            const positionLeftUnit = settings.position_left_unit || 'px';
            const zIndex = settings.z_index || 'auto';
            const stickyTopOffset = settings.sticky_top_offset || '0';
            const stickyBottomLimit = settings.sticky_bottom_limit || '';

            // Check if position offsets are applicable
            const showOffsets = ['relative', 'absolute', 'fixed', 'sticky'].includes(positionType);

            let html = '';

            // Section Header
            html += '<div class="tb-position-section" id="position-section-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-position-section-header" onclick="TB.togglePositionSection(this)">';
            html += '<div class="tb-position-section-title">📍 Position</div>';
            html += '<span class="tb-position-section-toggle">▼</span>';
            html += '</div>';
            html += '<div class="tb-position-section-body">';

            // Position Type Dropdown
            html += '<div class="tb-position-type-row">';
            html += '<label>Position Type</label>';
            html += '<select onchange="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'position\',this.value)">';
            html += '<option value="static"' + (positionType === 'static' ? ' selected' : '') + '>Static (Default)</option>';
            html += '<option value="relative"' + (positionType === 'relative' ? ' selected' : '') + '>Relative</option>';
            html += '<option value="absolute"' + (positionType === 'absolute' ? ' selected' : '') + '>Absolute</option>';
            html += '<option value="fixed"' + (positionType === 'fixed' ? ' selected' : '') + '>Fixed</option>';
            html += '<option value="sticky"' + (positionType === 'sticky' ? ' selected' : '') + '>Sticky</option>';
            html += '</select>';

            // Position info text
            html += '<div class="tb-position-info">';
            switch(positionType) {
                case 'static':
                    html += '<strong>Static:</strong> Default positioning. Elements flow normally in the document.';
                    break;
                case 'relative':
                    html += '<strong>Relative:</strong> Positioned relative to its normal position. Use offsets to nudge the element.';
                    break;
                case 'absolute':
                    html += '<strong>Absolute:</strong> Removed from document flow. Positioned relative to nearest positioned ancestor.';
                    break;
                case 'fixed':
                    html += '<strong>Fixed:</strong> Positioned relative to the viewport. Stays in place during scrolling.';
                    break;
                case 'sticky':
                    html += '<strong>Sticky:</strong> Toggles between relative and fixed based on scroll position.';
                    break;
            }
            html += '</div>';
            html += '</div>';

            // Warning for absolute/fixed
            if (positionType === 'absolute' || positionType === 'fixed') {
                html += '<div class="tb-position-warning">';
                html += '<span class="tb-position-warning-icon">⚠️</span>';
                html += '<div>';
                html += '<strong>Layout Warning:</strong> ';
                if (positionType === 'absolute') {
                    html += 'Absolute positioning removes the element from normal flow. Ensure a parent has <code>position: relative</code> for proper containment.';
                } else {
                    html += 'Fixed elements may overlap other content and behave differently on mobile devices.';
                }
                html += '</div>';
                html += '</div>';
            }

            // Position Offsets (visual box)
            if (showOffsets) {
                html += '<div class="tb-position-offset-box">';
                html += '<div class="tb-position-offset-title">↔️ Position Offsets</div>';
                html += '<div class="tb-position-offset-visual">';

                // Top offset
                html += '<div class="tb-position-offset-input top">';
                html += '<span class="tb-position-offset-label">Top</span>';
                html += '<div style="display:flex;gap:2px">';
                html += '<input type="text" value="' + this.escapeHtml(positionTop) + '" placeholder="auto" class="' + (positionTop ? 'has-value' : '') + '" onchange="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'position_top\',this.value)">';
                html += '<select onchange="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'position_top_unit\',this.value)">';
                html += '<option value="px"' + (positionTopUnit === 'px' ? ' selected' : '') + '>px</option>';
                html += '<option value="%"' + (positionTopUnit === '%' ? ' selected' : '') + '>%</option>';
                html += '</select>';
                html += '</div></div>';

                // Right offset
                html += '<div class="tb-position-offset-input right">';
                html += '<span class="tb-position-offset-label">Right</span>';
                html += '<div style="display:flex;gap:2px">';
                html += '<input type="text" value="' + this.escapeHtml(positionRight) + '" placeholder="auto" class="' + (positionRight ? 'has-value' : '') + '" onchange="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'position_right\',this.value)">';
                html += '<select onchange="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'position_right_unit\',this.value)">';
                html += '<option value="px"' + (positionRightUnit === 'px' ? ' selected' : '') + '>px</option>';
                html += '<option value="%"' + (positionRightUnit === '%' ? ' selected' : '') + '>%</option>';
                html += '</select>';
                html += '</div></div>';

                // Bottom offset
                html += '<div class="tb-position-offset-input bottom">';
                html += '<span class="tb-position-offset-label">Bottom</span>';
                html += '<div style="display:flex;gap:2px">';
                html += '<input type="text" value="' + this.escapeHtml(positionBottom) + '" placeholder="auto" class="' + (positionBottom ? 'has-value' : '') + '" onchange="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'position_bottom\',this.value)">';
                html += '<select onchange="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'position_bottom_unit\',this.value)">';
                html += '<option value="px"' + (positionBottomUnit === 'px' ? ' selected' : '') + '>px</option>';
                html += '<option value="%"' + (positionBottomUnit === '%' ? ' selected' : '') + '>%</option>';
                html += '</select>';
                html += '</div></div>';

                // Left offset
                html += '<div class="tb-position-offset-input left">';
                html += '<span class="tb-position-offset-label">Left</span>';
                html += '<div style="display:flex;gap:2px">';
                html += '<input type="text" value="' + this.escapeHtml(positionLeft) + '" placeholder="auto" class="' + (positionLeft ? 'has-value' : '') + '" onchange="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'position_left\',this.value)">';
                html += '<select onchange="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'position_left_unit\',this.value)">';
                html += '<option value="px"' + (positionLeftUnit === 'px' ? ' selected' : '') + '>px</option>';
                html += '<option value="%"' + (positionLeftUnit === '%' ? ' selected' : '') + '>%</option>';
                html += '</select>';
                html += '</div></div>';

                // Center element indicator
                html += '<div class="tb-position-offset-center">Module</div>';

                html += '</div>'; // visual

                // Quick actions
                html += '<div class="tb-position-quick-actions" style="margin-top:10px">';
                html += '<button type="button" class="tb-position-quick-btn" onclick="TB.applyPositionPreset(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'center-h\')" title="Center horizontally">';
                html += '↔️ Center H';
                html += '</button>';
                html += '<button type="button" class="tb-position-quick-btn" onclick="TB.applyPositionPreset(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'center-v\')" title="Center vertically">';
                html += '↕️ Center V';
                html += '</button>';
                html += '<button type="button" class="tb-position-quick-btn" onclick="TB.applyPositionPreset(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'fill\')" title="Fill container">';
                html += '⬜ Fill';
                html += '</button>';
                html += '<button type="button" class="tb-position-quick-btn" onclick="TB.applyPositionPreset(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'reset\')" title="Reset offsets">';
                html += '↺ Reset';
                html += '</button>';
                html += '</div>';

                html += '</div>'; // offset box
            }

            // Z-Index Section
            html += '<div class="tb-zindex-section">';
            html += '<div class="tb-zindex-title">📊 Z-Index (Stacking Order)</div>';
            html += '<div class="tb-zindex-input-row">';
            html += '<input type="text" value="' + this.escapeHtml(zIndex) + '" placeholder="auto" onchange="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'z_index\',this.value)">';
            html += '</div>';
            html += '<div class="tb-zindex-presets">';
            const zPresets = ['-1', '0', '1', '10', '100', '999', 'auto'];
            zPresets.forEach(z => {
                const isActive = zIndex === z || (z === 'auto' && zIndex === 'auto');
                html += '<button type="button" class="tb-zindex-preset' + (isActive ? ' active' : '') + '" onclick="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'z_index\',\'' + z + '\')">' + z + '</button>';
            });
            html += '</div>';
            html += '</div>';

            // Sticky Options (only shown when position is sticky)
            if (positionType === 'sticky') {
                html += '<div class="tb-sticky-section">';
                html += '<div class="tb-sticky-title">📌 Sticky Options</div>';

                html += '<div class="tb-sticky-control-row">';
                html += '<label>Stick at top offset</label>';
                html += '<input type="text" value="' + this.escapeHtml(stickyTopOffset) + '" placeholder="0px" onchange="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'sticky_top_offset\',this.value)">';
                html += '</div>';

                html += '<div class="tb-sticky-control-row">';
                html += '<label>Bottom limit (optional)</label>';
                html += '<input type="text" value="' + this.escapeHtml(stickyBottomLimit) + '" placeholder="none" onchange="TB.updatePosition(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'sticky_bottom_limit\',this.value)">';
                html += '</div>';

                html += '<div class="tb-position-info" style="margin-top:8px">';
                html += 'The element will become fixed when scrolling past the top offset, and return to relative before reaching the bottom limit.';
                html += '</div>';

                html += '</div>';
            }

            html += '</div>'; // body
            html += '</div>'; // section

            return html;
        },

        // Toggle position section collapse
        togglePositionSection(element) {
            const section = element.closest('.tb-position-section');
            if (section) {
                section.classList.toggle('collapsed');
            }
        },

        // ═══════════════════════════════════════════════════════════
        // POSITION HELPER FUNCTIONS
        // ═══════════════════════════════════════════════════════════

        // Update position setting
        updatePosition(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            mod.settings[property] = value;

            // If changing position type to static, clear offsets
            if (property === 'position' && value === 'static') {
                mod.settings.position_top = '';
                mod.settings.position_right = '';
                mod.settings.position_bottom = '';
                mod.settings.position_left = '';
            }

            this.saveToHistory();
            this.renderCanvas();
            this.renderSettings();
        },

        // Apply position preset
        applyPositionPreset(sIdx, rIdx, cIdx, mIdx, preset) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            switch(preset) {
                case 'center-h':
                    // Center horizontally using left: 50% and transform
                    mod.settings.position_left = '50';
                    mod.settings.position_left_unit = '%';
                    mod.settings.position_right = '';
                    mod.settings.transform_translate_x = '-50';
                    mod.settings.transform_translate_x_unit = '%';
                    break;
                case 'center-v':
                    // Center vertically using top: 50% and transform
                    mod.settings.position_top = '50';
                    mod.settings.position_top_unit = '%';
                    mod.settings.position_bottom = '';
                    mod.settings.transform_translate_y = '-50';
                    mod.settings.transform_translate_y_unit = '%';
                    break;
                case 'fill':
                    // Fill container
                    mod.settings.position_top = '0';
                    mod.settings.position_right = '0';
                    mod.settings.position_bottom = '0';
                    mod.settings.position_left = '0';
                    mod.settings.position_top_unit = 'px';
                    mod.settings.position_right_unit = 'px';
                    mod.settings.position_bottom_unit = 'px';
                    mod.settings.position_left_unit = 'px';
                    break;
                case 'reset':
                    // Reset all offsets
                    mod.settings.position_top = '';
                    mod.settings.position_right = '';
                    mod.settings.position_bottom = '';
                    mod.settings.position_left = '';
                    break;
            }

            this.saveToHistory();
            this.renderCanvas();
            this.renderSettings();
        },

        // Build position CSS string from settings
        getPositionCSS(settings) {
            let css = '';
            const positionType = settings.position || 'static';

            if (positionType !== 'static') {
                css += 'position:' + positionType + ';';

                // Position offsets
                if (settings.position_top !== '' && settings.position_top !== undefined) {
                    const unit = settings.position_top_unit || 'px';
                    css += 'top:' + settings.position_top + unit + ';';
                }
                if (settings.position_right !== '' && settings.position_right !== undefined) {
                    const unit = settings.position_right_unit || 'px';
                    css += 'right:' + settings.position_right + unit + ';';
                }
                if (settings.position_bottom !== '' && settings.position_bottom !== undefined) {
                    const unit = settings.position_bottom_unit || 'px';
                    css += 'bottom:' + settings.position_bottom + unit + ';';
                }
                if (settings.position_left !== '' && settings.position_left !== undefined) {
                    const unit = settings.position_left_unit || 'px';
                    css += 'left:' + settings.position_left + unit + ';';
                }
            }

            // Z-index (can be set regardless of position type)
            if (settings.z_index && settings.z_index !== 'auto') {
                css += 'z-index:' + settings.z_index + ';';
            }

            return css;
        },

        // Check if module has non-static position
        hasNonStaticPosition(settings) {
            const positionType = settings?.position || 'static';
            return positionType !== 'static';
        },

        // ═══════════════════════════════════════════════════════════
        // ANIMATION SETTINGS (Divi-style entrance animations)
        // ═══════════════════════════════════════════════════════════
        renderAnimationSettings(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            const settings = mod?.settings || {};

            // Animation settings with defaults
            const animEnabled = settings.animation_enabled || false;
            const animType = settings.animation_type || 'fadeIn';
            const animDuration = settings.animation_duration || '0.6';
            const animDelay = settings.animation_delay || '0';
            const animEasing = settings.animation_easing || 'ease-out';
            const animIntensity = settings.animation_intensity || '100';

            // Scroll trigger settings
            const scrollEnabled = settings.scroll_trigger_enabled || false;
            const scrollTriggerPoint = settings.scroll_trigger_point || '80';
            const scrollAnimateOnce = settings.scroll_animate_once !== false; // default true
            const scrollOffset = settings.scroll_offset || '0';

            // Transition settings
            const transitionDuration = settings.transition_duration || '0.3';
            const transitionEasing = settings.transition_easing || 'ease';
            const transitionProperties = settings.transition_properties || 'all';

            let html = '';

            // Section Header with Animation Badge
            html += '<div class="tb-animation-section" id="animation-section-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-animation-section-header" onclick="TB.toggleAnimationSection(this)">';
            html += '<div class="tb-animation-section-title">';
            html += '✨ Animation';
            if (animEnabled) {
                html += ' <span class="tb-animation-active-badge">ON</span>';
            }
            html += '</div>';
            html += '<span class="tb-animation-section-toggle">▼</span>';
            html += '</div>';
            html += '<div class="tb-animation-section-body">';

            // ─────────────────────────────────────────────────────────
            // A) ENTRANCE ANIMATION SUBSECTION
            // ─────────────────────────────────────────────────────────
            html += '<div class="tb-animation-subsection">';
            html += '<div class="tb-animation-subsection-title">🎬 Entrance Animation</div>';

            // Enable Toggle
            html += '<div class="tb-animation-control-row">';
            html += '<label>Enable Animation</label>';
            html += '<label class="tb-toggle-switch">';
            html += '<input type="checkbox" ' + (animEnabled ? 'checked' : '') + ' onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animation_enabled\',this.checked)">';
            html += '<span class="tb-toggle-slider"></span>';
            html += '</label>';
            html += '</div>';

            // Animation Type Dropdown (only show if enabled)
            if (animEnabled) {
                html += '<div class="tb-animation-control-row">';
                html += '<label>Animation Type</label>';
                html += '<select onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animation_type\',this.value)">';

                // Fade animations
                html += '<optgroup label="Fade">';
                html += '<option value="fadeIn"' + (animType === 'fadeIn' ? ' selected' : '') + '>Fade In</option>';
                html += '<option value="fadeInUp"' + (animType === 'fadeInUp' ? ' selected' : '') + '>Fade In Up</option>';
                html += '<option value="fadeInDown"' + (animType === 'fadeInDown' ? ' selected' : '') + '>Fade In Down</option>';
                html += '<option value="fadeInLeft"' + (animType === 'fadeInLeft' ? ' selected' : '') + '>Fade In Left</option>';
                html += '<option value="fadeInRight"' + (animType === 'fadeInRight' ? ' selected' : '') + '>Fade In Right</option>';
                html += '</optgroup>';

                // Slide animations
                html += '<optgroup label="Slide">';
                html += '<option value="slideInUp"' + (animType === 'slideInUp' ? ' selected' : '') + '>Slide In Up</option>';
                html += '<option value="slideInDown"' + (animType === 'slideInDown' ? ' selected' : '') + '>Slide In Down</option>';
                html += '<option value="slideInLeft"' + (animType === 'slideInLeft' ? ' selected' : '') + '>Slide In Left</option>';
                html += '<option value="slideInRight"' + (animType === 'slideInRight' ? ' selected' : '') + '>Slide In Right</option>';
                html += '</optgroup>';

                // Zoom animations
                html += '<optgroup label="Zoom">';
                html += '<option value="zoomIn"' + (animType === 'zoomIn' ? ' selected' : '') + '>Zoom In</option>';
                html += '<option value="zoomInUp"' + (animType === 'zoomInUp' ? ' selected' : '') + '>Zoom In Up</option>';
                html += '<option value="zoomInDown"' + (animType === 'zoomInDown' ? ' selected' : '') + '>Zoom In Down</option>';
                html += '</optgroup>';

                // Bounce animations
                html += '<optgroup label="Bounce">';
                html += '<option value="bounceIn"' + (animType === 'bounceIn' ? ' selected' : '') + '>Bounce In</option>';
                html += '<option value="bounceInUp"' + (animType === 'bounceInUp' ? ' selected' : '') + '>Bounce In Up</option>';
                html += '<option value="bounceInDown"' + (animType === 'bounceInDown' ? ' selected' : '') + '>Bounce In Down</option>';
                html += '</optgroup>';

                // Flip animations
                html += '<optgroup label="Flip">';
                html += '<option value="flipInX"' + (animType === 'flipInX' ? ' selected' : '') + '>Flip In X</option>';
                html += '<option value="flipInY"' + (animType === 'flipInY' ? ' selected' : '') + '>Flip In Y</option>';
                html += '</optgroup>';

                // Special animations
                html += '<optgroup label="Special">';
                html += '<option value="rollIn"' + (animType === 'rollIn' ? ' selected' : '') + '>Roll In</option>';
                html += '<option value="lightSpeedIn"' + (animType === 'lightSpeedIn' ? ' selected' : '') + '>Light Speed In</option>';
                html += '<option value="jackInTheBox"' + (animType === 'jackInTheBox' ? ' selected' : '') + '>Jack In The Box</option>';
                html += '</optgroup>';

                html += '</select>';
                html += '</div>';

                // Duration Slider
                html += '<div class="tb-animation-control-row">';
                html += '<label>Duration: <span class="tb-animation-value">' + animDuration + 's</span></label>';
                html += '<input type="range" min="0.1" max="3" step="0.1" value="' + animDuration + '" oninput="this.previousElementSibling.querySelector(\'.tb-animation-value\').textContent=this.value+\'s\'" onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animation_duration\',this.value)">';
                html += '</div>';

                // Delay Slider
                html += '<div class="tb-animation-control-row">';
                html += '<label>Delay: <span class="tb-animation-value">' + animDelay + 's</span></label>';
                html += '<input type="range" min="0" max="3" step="0.1" value="' + animDelay + '" oninput="this.previousElementSibling.querySelector(\'.tb-animation-value\').textContent=this.value+\'s\'" onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animation_delay\',this.value)">';
                html += '</div>';

                // Easing Dropdown
                html += '<div class="tb-animation-control-row">';
                html += '<label>Easing</label>';
                html += '<select onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animation_easing\',this.value)">';
                html += '<option value="ease"' + (animEasing === 'ease' ? ' selected' : '') + '>Ease</option>';
                html += '<option value="ease-in"' + (animEasing === 'ease-in' ? ' selected' : '') + '>Ease In</option>';
                html += '<option value="ease-out"' + (animEasing === 'ease-out' ? ' selected' : '') + '>Ease Out</option>';
                html += '<option value="ease-in-out"' + (animEasing === 'ease-in-out' ? ' selected' : '') + '>Ease In Out</option>';
                html += '<option value="linear"' + (animEasing === 'linear' ? ' selected' : '') + '>Linear</option>';
                html += '<option value="cubic-bezier(0.68,-0.55,0.265,1.55)"' + (animEasing === 'cubic-bezier(0.68,-0.55,0.265,1.55)' ? ' selected' : '') + '>Bounce</option>';
                html += '<option value="cubic-bezier(0.175,0.885,0.32,1.275)"' + (animEasing === 'cubic-bezier(0.175,0.885,0.32,1.275)' ? ' selected' : '') + '>Back</option>';
                html += '<option value="cubic-bezier(0.86,0,0.07,1)"' + (animEasing === 'cubic-bezier(0.86,0,0.07,1)' ? ' selected' : '') + '>Quint</option>';
                html += '</select>';
                html += '</div>';

                // Intensity Slider
                html += '<div class="tb-animation-control-row">';
                html += '<label>Intensity: <span class="tb-animation-value">' + animIntensity + '%</span></label>';
                html += '<input type="range" min="25" max="200" step="5" value="' + animIntensity + '" oninput="this.previousElementSibling.querySelector(\'.tb-animation-value\').textContent=this.value+\'%\'" onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'animation_intensity\',this.value)">';
                html += '</div>';

                // Preview Button
                html += '<div class="tb-animation-preview-row">';
                html += '<button type="button" class="tb-animation-preview-btn" onclick="TB.previewAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">';
                html += '▶️ Preview Animation';
                html += '</button>';
                html += '</div>';
            }

            html += '</div>'; // subsection

            // ─────────────────────────────────────────────────────────
            // B) SCROLL TRIGGER SUBSECTION
            // ─────────────────────────────────────────────────────────
            html += '<div class="tb-animation-subsection">';
            html += '<div class="tb-animation-subsection-title">📜 Scroll Trigger</div>';

            // Enable Scroll Trigger
            html += '<div class="tb-animation-control-row">';
            html += '<label>Trigger on Scroll</label>';
            html += '<label class="tb-toggle-switch">';
            html += '<input type="checkbox" ' + (scrollEnabled ? 'checked' : '') + ' onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'scroll_trigger_enabled\',this.checked)">';
            html += '<span class="tb-toggle-slider"></span>';
            html += '</label>';
            html += '</div>';

            if (scrollEnabled) {
                // Trigger Point
                html += '<div class="tb-animation-control-row">';
                html += '<label>Trigger Point: <span class="tb-animation-value">' + scrollTriggerPoint + '%</span></label>';
                html += '<input type="range" min="0" max="100" step="5" value="' + scrollTriggerPoint + '" oninput="this.previousElementSibling.querySelector(\'.tb-animation-value\').textContent=this.value+\'%\'" onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'scroll_trigger_point\',this.value)">';
                html += '<small class="tb-animation-hint">Percentage from top of viewport where animation triggers</small>';
                html += '</div>';

                // Animate Once Toggle
                html += '<div class="tb-animation-control-row">';
                html += '<label>Animate Once</label>';
                html += '<label class="tb-toggle-switch">';
                html += '<input type="checkbox" ' + (scrollAnimateOnce ? 'checked' : '') + ' onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'scroll_animate_once\',this.checked)">';
                html += '<span class="tb-toggle-slider"></span>';
                html += '</label>';
                html += '<small class="tb-animation-hint">If off, animation replays each time element scrolls into view</small>';
                html += '</div>';

                // Offset
                html += '<div class="tb-animation-control-row">';
                html += '<label>Offset: <span class="tb-animation-value">' + scrollOffset + 'px</span></label>';
                html += '<input type="range" min="-200" max="200" step="10" value="' + scrollOffset + '" oninput="this.previousElementSibling.querySelector(\'.tb-animation-value\').textContent=this.value+\'px\'" onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'scroll_offset\',this.value)">';
                html += '<small class="tb-animation-hint">Offset from trigger point (positive = trigger earlier)</small>';
                html += '</div>';
            }

            html += '</div>'; // subsection

            // ─────────────────────────────────────────────────────────
            // C) TRANSITION SETTINGS SUBSECTION
            // ─────────────────────────────────────────────────────────
            html += '<div class="tb-animation-subsection">';
            html += '<div class="tb-animation-subsection-title">⏱️ Transition Settings</div>';
            html += '<small class="tb-animation-hint" style="margin-bottom:10px;display:block">Controls how style changes animate (hover, state changes)</small>';

            // Transition Duration
            html += '<div class="tb-animation-control-row">';
            html += '<label>Duration: <span class="tb-animation-value">' + transitionDuration + 's</span></label>';
            html += '<input type="range" min="0" max="2" step="0.1" value="' + transitionDuration + '" oninput="this.previousElementSibling.querySelector(\'.tb-animation-value\').textContent=this.value+\'s\'" onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transition_duration\',this.value)">';
            html += '</div>';

            // Transition Easing
            html += '<div class="tb-animation-control-row">';
            html += '<label>Easing</label>';
            html += '<select onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transition_easing\',this.value)">';
            html += '<option value="ease"' + (transitionEasing === 'ease' ? ' selected' : '') + '>Ease</option>';
            html += '<option value="ease-in"' + (transitionEasing === 'ease-in' ? ' selected' : '') + '>Ease In</option>';
            html += '<option value="ease-out"' + (transitionEasing === 'ease-out' ? ' selected' : '') + '>Ease Out</option>';
            html += '<option value="ease-in-out"' + (transitionEasing === 'ease-in-out' ? ' selected' : '') + '>Ease In Out</option>';
            html += '<option value="linear"' + (transitionEasing === 'linear' ? ' selected' : '') + '>Linear</option>';
            html += '</select>';
            html += '</div>';

            // Transition Properties
            html += '<div class="tb-animation-control-row">';
            html += '<label>Properties</label>';
            html += '<select onchange="TB.updateAnimation(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'transition_properties\',this.value)">';
            html += '<option value="all"' + (transitionProperties === 'all' ? ' selected' : '') + '>All Properties</option>';
            html += '<option value="transform"' + (transitionProperties === 'transform' ? ' selected' : '') + '>Transform Only</option>';
            html += '<option value="opacity"' + (transitionProperties === 'opacity' ? ' selected' : '') + '>Opacity Only</option>';
            html += '<option value="color, background-color"' + (transitionProperties === 'color, background-color' ? ' selected' : '') + '>Colors</option>';
            html += '<option value="background"' + (transitionProperties === 'background' ? ' selected' : '') + '>Background Only</option>';
            html += '<option value="transform, opacity"' + (transitionProperties === 'transform, opacity' ? ' selected' : '') + '>Transform + Opacity</option>';
            html += '</select>';
            html += '</div>';

            html += '</div>'; // subsection

            html += '</div>'; // body
            html += '</div>'; // section

            return html;
        },

        // Toggle animation section collapse
        toggleAnimationSection(element) {
            const section = element.closest('.tb-animation-section');
            if (section) {
                section.classList.toggle('collapsed');
            }
        },

        // ═══════════════════════════════════════════════════════════
        // ANIMATION HELPER FUNCTIONS
        // ═══════════════════════════════════════════════════════════

        // Update animation setting
        updateAnimation(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            mod.settings[property] = value;

            // If disabling animation, reset related settings
            if (property === 'animation_enabled' && !value) {
                mod.settings.scroll_trigger_enabled = false;
            }

            this.saveToHistory();
            this.renderCanvas();
            this.renderSettings();
            this.updateAnimationStylesheet();
        },

        // Preview animation in canvas
        previewAnimation(sIdx, rIdx, cIdx, mIdx) {
            const moduleEl = document.querySelector('[data-module-coords="' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '"]');
            if (!moduleEl) return;

            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod?.settings?.animation_enabled) return;

            const settings = mod.settings;
            const animType = settings.animation_type || 'fadeIn';
            const animDuration = settings.animation_duration || '0.6';
            const animDelay = settings.animation_delay || '0';
            const animEasing = settings.animation_easing || 'ease-out';
            const intensity = parseFloat(settings.animation_intensity || '100') / 100;

            // Remove any existing animation classes
            moduleEl.classList.remove('tb-animate-active', 'tb-animate-preview');

            // Apply the animation
            moduleEl.style.animation = 'none';
            moduleEl.offsetHeight; // Force reflow

            // Calculate intensity-adjusted duration
            const adjustedDuration = parseFloat(animDuration);

            moduleEl.style.animation = 'tb-' + animType + ' ' + adjustedDuration + 's ' + animEasing + ' ' + animDelay + 's both';
            moduleEl.classList.add('tb-animate-active', 'tb-animate-preview');

            // Remove animation after it completes
            setTimeout(() => {
                moduleEl.classList.remove('tb-animate-preview');
                moduleEl.style.animation = '';
            }, (parseFloat(animDuration) + parseFloat(animDelay)) * 1000 + 100);
        },

        // Build animation CSS string from settings (for frontend rendering)
        getAnimationCSS(settings) {
            if (!settings?.animation_enabled) return '';

            const animType = settings.animation_type || 'fadeIn';
            const animDuration = settings.animation_duration || '0.6';
            const animDelay = settings.animation_delay || '0';
            const animEasing = settings.animation_easing || 'ease-out';

            return 'animation:tb-' + animType + ' ' + animDuration + 's ' + animEasing + ' ' + animDelay + 's both;';
        },

        // Build transition CSS string from settings
        getTransitionCSS(settings) {
            const duration = settings?.transition_duration || '0.3';
            const easing = settings?.transition_easing || 'ease';
            const properties = settings?.transition_properties || 'all';

            return 'transition:' + properties + ' ' + duration + 's ' + easing + ';';
        },

        // Get animation data attributes for frontend
        getAnimationDataAttributes(settings) {
            if (!settings?.animation_enabled) return '';

            let attrs = ' data-tb-animate="true"';
            attrs += ' data-tb-animation="' + (settings.animation_type || 'fadeIn') + '"';
            attrs += ' data-tb-duration="' + (settings.animation_duration || '0.6') + '"';
            attrs += ' data-tb-delay="' + (settings.animation_delay || '0') + '"';
            attrs += ' data-tb-easing="' + (settings.animation_easing || 'ease-out') + '"';

            if (settings.scroll_trigger_enabled) {
                attrs += ' data-tb-scroll="true"';
                attrs += ' data-tb-trigger="' + (settings.scroll_trigger_point || '80') + '"';
                attrs += ' data-tb-once="' + (settings.scroll_animate_once !== false ? 'true' : 'false') + '"';
                attrs += ' data-tb-offset="' + (settings.scroll_offset || '0') + '"';
            }

            return attrs;
        },

        // Update dynamic animation stylesheet
        updateAnimationStylesheet() {
            let css = '';

            // Iterate through all modules and generate animation CSS
            if (this.content?.sections) {
                this.content.sections.forEach((section, sIdx) => {
                    if (section.rows) {
                        section.rows.forEach((row, rIdx) => {
                            if (row.columns) {
                                row.columns.forEach((col, cIdx) => {
                                    if (col.modules) {
                                        col.modules.forEach((mod, mIdx) => {
                                            const settings = mod.settings;
                                            if (settings) {
                                                const selector = '[data-module-coords="' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '"]';

                                                // Add transition CSS
                                                const transitionDuration = settings.transition_duration || '0.3';
                                                const transitionEasing = settings.transition_easing || 'ease';
                                                const transitionProperties = settings.transition_properties || 'all';
                                                css += selector + '{transition:' + transitionProperties + ' ' + transitionDuration + 's ' + transitionEasing + ';}';
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
            }

            // Update the stylesheet
            const styleEl = document.getElementById('tb-animation-styles');
            if (styleEl) {
                styleEl.textContent = css;
            }
        },

        // Initialize scroll-triggered animations (for frontend use)
        initScrollAnimations() {
            const animatedElements = document.querySelectorAll('[data-tb-scroll="true"]');

            if (!animatedElements.length) return;

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const el = entry.target;
                        const animType = el.dataset.tbAnimation;
                        const duration = el.dataset.tbDuration || '0.6';
                        const delay = el.dataset.tbDelay || '0';
                        const easing = el.dataset.tbEasing || 'ease-out';
                        const animateOnce = el.dataset.tbOnce === 'true';

                        // Apply animation
                        el.style.animation = 'tb-' + animType + ' ' + duration + 's ' + easing + ' ' + delay + 's both';
                        el.classList.add('tb-animate-active');

                        // Unobserve if animate-once
                        if (animateOnce) {
                            observer.unobserve(el);
                        }
                    } else {
                        const el = entry.target;
                        const animateOnce = el.dataset.tbOnce === 'true';

                        // If not animate-once, reset for re-entry
                        if (!animateOnce) {
                            el.style.animation = '';
                            el.classList.remove('tb-animate-active');
                        }
                    }
                });
            }, {
                threshold: 0,
                rootMargin: '-20% 0px -20% 0px' // Trigger when 20% from top/bottom
            });

            animatedElements.forEach(el => {
                // Calculate custom root margin based on trigger point
                const triggerPoint = parseInt(el.dataset.tbTrigger || '80');
                const offset = parseInt(el.dataset.tbOffset || '0');

                // Start with element hidden if scroll-triggered
                el.style.opacity = '0';

                observer.observe(el);
            });
        },

        // Check if module has animation enabled
        hasAnimationEnabled(settings) {
            return settings?.animation_enabled === true;
        },

        // ═══════════════════════════════════════════════════════════
        // FILTER HELPER FUNCTIONS
        // ═══════════════════════════════════════════════════════════

        // Update filter setting
        updateFilter(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            mod.settings[property] = value;
            mod.settings.filter_preset = 'none'; // Clear preset when manually adjusting

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Update filter setting from slider (real-time)
        updateFilterSlider(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            mod.settings[property] = value;
            mod.settings.filter_preset = 'none'; // Clear preset when manually adjusting

            // Update the number input in real-time
            const propId = property.replace('filter_', 'filter-').replace('_', '-');
            const numInput = document.getElementById(propId + '-num-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx);
            if (numInput) numInput.value = value;

            // Update preview thumbnail in real-time
            this.updateFilterPreview(sIdx, rIdx, cIdx, mIdx);

            // Debounced save and render
            clearTimeout(this.filterUpdateTimer);
            this.filterUpdateTimer = setTimeout(() => {
                this.saveToHistory();
                this.renderCanvas();
            }, 100);
        },

        // Timer for debouncing filter updates
        filterUpdateTimer: null,

        // Update filter preview thumbnail
        updateFilterPreview(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            const filterCSS = this.getFilterCSS(mod.settings || {});
            const preview = document.getElementById('filter-preview-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx);
            if (preview) {
                preview.style.filter = filterCSS;
            }
        },

        // Update hue wheel indicator
        updateHueWheel(sIdx, rIdx, cIdx, mIdx, value) {
            const wheel = document.getElementById('hue-wheel-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx);
            if (wheel) {
                const indicator = wheel.querySelector('.tb-hue-indicator');
                if (indicator) {
                    indicator.style.transform = 'rotate(' + value + 'deg)';
                }
            }
        },

        // Build filter CSS string from settings
        getFilterCSS(settings) {
            const parts = [];

            // Blur
            const blur = parseFloat(settings.filter_blur || '0');
            if (blur > 0) {
                parts.push('blur(' + blur + 'px)');
            }

            // Brightness
            const brightness = parseFloat(settings.filter_brightness || '100');
            if (brightness !== 100) {
                parts.push('brightness(' + (brightness / 100) + ')');
            }

            // Contrast
            const contrast = parseFloat(settings.filter_contrast || '100');
            if (contrast !== 100) {
                parts.push('contrast(' + (contrast / 100) + ')');
            }

            // Saturation
            const saturation = parseFloat(settings.filter_saturation || '100');
            if (saturation !== 100) {
                parts.push('saturate(' + (saturation / 100) + ')');
            }

            // Hue Rotate
            const hueRotate = parseFloat(settings.filter_hue_rotate || '0');
            if (hueRotate !== 0) {
                parts.push('hue-rotate(' + hueRotate + 'deg)');
            }

            // Grayscale
            const grayscale = parseFloat(settings.filter_grayscale || '0');
            if (grayscale > 0) {
                parts.push('grayscale(' + (grayscale / 100) + ')');
            }

            // Sepia
            const sepia = parseFloat(settings.filter_sepia || '0');
            if (sepia > 0) {
                parts.push('sepia(' + (sepia / 100) + ')');
            }

            // Invert
            const invert = parseFloat(settings.filter_invert || '0');
            if (invert > 0) {
                parts.push('invert(' + (invert / 100) + ')');
            }

            // Opacity (as filter for consistency)
            const opacity = parseFloat(settings.filter_opacity || '100');
            if (opacity !== 100) {
                parts.push('opacity(' + (opacity / 100) + ')');
            }

            return parts.length > 0 ? parts.join(' ') : 'none';
        },

        // Apply filter preset
        applyFilterPreset(sIdx, rIdx, cIdx, mIdx, preset) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            // Define presets
            const presets = {
                none: {
                    filter_blur: '0',
                    filter_brightness: '100',
                    filter_contrast: '100',
                    filter_saturation: '100',
                    filter_hue_rotate: '0',
                    filter_grayscale: '0',
                    filter_sepia: '0',
                    filter_invert: '0',
                    filter_opacity: '100'
                },
                vivid: {
                    filter_blur: '0',
                    filter_brightness: '110',
                    filter_contrast: '110',
                    filter_saturation: '120',
                    filter_hue_rotate: '0',
                    filter_grayscale: '0',
                    filter_sepia: '0',
                    filter_invert: '0',
                    filter_opacity: '100'
                },
                muted: {
                    filter_blur: '0',
                    filter_brightness: '95',
                    filter_contrast: '100',
                    filter_saturation: '70',
                    filter_hue_rotate: '0',
                    filter_grayscale: '0',
                    filter_sepia: '0',
                    filter_invert: '0',
                    filter_opacity: '100'
                },
                vintage: {
                    filter_blur: '0',
                    filter_brightness: '95',
                    filter_contrast: '90',
                    filter_saturation: '100',
                    filter_hue_rotate: '0',
                    filter_grayscale: '0',
                    filter_sepia: '30',
                    filter_invert: '0',
                    filter_opacity: '100'
                },
                blackwhite: {
                    filter_blur: '0',
                    filter_brightness: '100',
                    filter_contrast: '100',
                    filter_saturation: '0',
                    filter_hue_rotate: '0',
                    filter_grayscale: '100',
                    filter_sepia: '0',
                    filter_invert: '0',
                    filter_opacity: '100'
                },
                dramatic: {
                    filter_blur: '0',
                    filter_brightness: '90',
                    filter_contrast: '130',
                    filter_saturation: '100',
                    filter_hue_rotate: '0',
                    filter_grayscale: '0',
                    filter_sepia: '0',
                    filter_invert: '0',
                    filter_opacity: '100'
                },
                warm: {
                    filter_blur: '0',
                    filter_brightness: '100',
                    filter_contrast: '100',
                    filter_saturation: '100',
                    filter_hue_rotate: '10',
                    filter_grayscale: '0',
                    filter_sepia: '15',
                    filter_invert: '0',
                    filter_opacity: '100'
                },
                cool: {
                    filter_blur: '0',
                    filter_brightness: '100',
                    filter_contrast: '100',
                    filter_saturation: '80',
                    filter_hue_rotate: '180',
                    filter_grayscale: '0',
                    filter_sepia: '0',
                    filter_invert: '0',
                    filter_opacity: '100'
                }
            };

            const presetValues = presets[preset] || presets.none;

            // Apply preset values
            Object.keys(presetValues).forEach(key => {
                mod.settings[key] = presetValues[key];
            });
            mod.settings.filter_preset = preset;

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Reset all filters to defaults
        resetFilters(sIdx, rIdx, cIdx, mIdx) {
            this.applyFilterPreset(sIdx, rIdx, cIdx, mIdx, 'none');
        },

        // Check if module has any active (non-default) filters
        hasActiveFilters(settings) {
            if (!settings) return false;
            const blur = parseFloat(settings.filter_blur || '0');
            const brightness = parseFloat(settings.filter_brightness || '100');
            const contrast = parseFloat(settings.filter_contrast || '100');
            const saturation = parseFloat(settings.filter_saturation || '100');
            const hueRotate = parseFloat(settings.filter_hue_rotate || '0');
            const grayscale = parseFloat(settings.filter_grayscale || '0');
            const sepia = parseFloat(settings.filter_sepia || '0');
            const invert = parseFloat(settings.filter_invert || '0');
            const opacity = parseFloat(settings.filter_opacity || '100');

            return blur > 0 || brightness !== 100 || contrast !== 100 ||
                   saturation !== 100 || hueRotate !== 0 || grayscale > 0 ||
                   sepia > 0 || invert > 0 || opacity !== 100;
        },

        // ═══════════════════════════════════════════════════════════
        // HOVER STATE HELPER FUNCTIONS
        // ═══════════════════════════════════════════════════════════

        // Switch between normal and hover state editing
        setState(state) {
            this.currentState = state;
            const canvas = document.getElementById('tb-canvas');
            if (canvas) {
                if (state === 'hover') {
                    canvas.classList.add('hover-editing');
                } else {
                    canvas.classList.remove('hover-editing');
                }
            }
            // Re-render settings panel to update state toggle UI
            this.renderSettings();
        },

        // Get value for current state (normal or hover)
        getStateValue(settings, property) {
            if (this.currentState === 'hover') {
                const hoverKey = property + '_hover';
                return settings[hoverKey] !== undefined ? settings[hoverKey] : settings[property];
            }
            return settings[property];
        },

        // Update hover setting
        updateHoverSetting(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            // Handle boolean values
            if (property === 'hover_enabled' || property === 'box_shadow_hover_enabled') {
                mod.settings[property] = value === true || value === 'true';
            } else {
                mod.settings[property] = value;
            }

            this.saveToHistory();
            this.renderCanvas();
            this.updateHoverStylesheet();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Update hover setting from slider (real-time without full re-render)
        updateHoverSettingSlider(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            mod.settings[property] = value;

            // Update the number input in real-time
            const controlsContainer = document.getElementById('hover-controls-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx);
            if (controlsContainer) {
                const rows = controlsContainer.querySelectorAll('.tb-hover-control-row, .tb-hover-transform-row');
                rows.forEach(row => {
                    const range = row.querySelector('input[type="range"]');
                    const number = row.querySelector('input[type="number"]');
                    if (range && number && range.value === value) {
                        number.value = value;
                    }
                });
            }

            // Update hover stylesheet in real-time
            this.updateHoverStylesheet();

            // Debounced save and render
            clearTimeout(this.hoverUpdateTimer);
            this.hoverUpdateTimer = setTimeout(() => {
                this.saveToHistory();
                this.renderCanvas();
            }, 150);
        },

        // Timer for debouncing hover updates
        hoverUpdateTimer: null,

        // Update hover shadow color from color picker
        updateHoverShadowColor(sIdx, rIdx, cIdx, mIdx, hexColor) {
            const rgba = this.hexToRgba(hexColor, 0.15);
            this.updateHoverSetting(sIdx, rIdx, cIdx, mIdx, 'box_shadow_hover_color', rgba);
        },

        // Toggle hover preview mode
        toggleHoverPreview(sIdx, rIdx, cIdx, mIdx) {
            this.hoverPreviewActive = !this.hoverPreviewActive;

            const moduleId = 'tb-mod-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx;
            const moduleEl = document.querySelector('[data-module-id="' + moduleId + '"]');

            if (this.hoverPreviewActive) {
                // Add class to simulate hover state
                if (moduleEl) {
                    moduleEl.classList.add('tb-hover-preview-active');
                }
                // Also apply hover styles directly to preview
                this.applyHoverPreviewStyles(sIdx, rIdx, cIdx, mIdx);
            } else {
                // Remove preview class
                if (moduleEl) {
                    moduleEl.classList.remove('tb-hover-preview-active');
                }
                // Remove preview styles
                this.removeHoverPreviewStyles(sIdx, rIdx, cIdx, mIdx);
            }

            // Re-render settings to update button state
            this.renderSettings();
        },

        // Apply hover preview styles directly to module
        applyHoverPreviewStyles(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.settings?.hover_enabled) return;

            const settings = mod.settings;
            const moduleId = 'tb-mod-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx;
            const previewEl = document.querySelector('[data-module-id="' + moduleId + '"] .tb-module-preview');

            if (previewEl) {
                // Store original styles
                previewEl.dataset.originalStyles = previewEl.getAttribute('style') || '';

                // Apply hover styles
                let hoverStyles = previewEl.dataset.originalStyles;

                if (settings.text_color_hover) hoverStyles += 'color:' + settings.text_color_hover + '!important;';
                if (settings.background_color_hover) hoverStyles += 'background-color:' + settings.background_color_hover + '!important;';
                if (settings.border_color_hover) hoverStyles += 'border-color:' + settings.border_color_hover + '!important;';
                if (settings.opacity_hover && settings.opacity_hover !== '1') hoverStyles += 'opacity:' + settings.opacity_hover + '!important;';

                // Transform
                const scale = settings.transform_scale_hover || '1';
                const translateY = settings.transform_translate_y_hover || '0';
                if (scale !== '1' || translateY !== '0') {
                    hoverStyles += 'transform:scale(' + scale + ') translateY(' + translateY + 'px)!important;';
                }

                // Box shadow hover
                if (settings.box_shadow_hover_enabled) {
                    const h = parseInt(settings.box_shadow_hover_horizontal) || 0;
                    const v = parseInt(settings.box_shadow_hover_vertical) || 8;
                    const blur = parseInt(settings.box_shadow_hover_blur) || 20;
                    const spread = parseInt(settings.box_shadow_hover_spread) || 0;
                    const color = settings.box_shadow_hover_color || 'rgba(0,0,0,0.15)';
                    hoverStyles += 'box-shadow:' + h + 'px ' + v + 'px ' + blur + 'px ' + spread + 'px ' + color + '!important;';
                }

                previewEl.setAttribute('style', hoverStyles);
            }
        },

        // Remove hover preview styles
        removeHoverPreviewStyles(sIdx, rIdx, cIdx, mIdx) {
            const moduleId = 'tb-mod-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx;
            const previewEl = document.querySelector('[data-module-id="' + moduleId + '"] .tb-module-preview');

            if (previewEl && previewEl.dataset.originalStyles !== undefined) {
                previewEl.setAttribute('style', previewEl.dataset.originalStyles);
                delete previewEl.dataset.originalStyles;
            }
        },

        // Generate hover CSS for a specific module
        generateHoverCSS(moduleId, settings) {
            if (!settings || !settings.hover_enabled) return '';

            const duration = settings.hover_transition_duration || '0.3';
            const easing = settings.hover_transition_easing || 'ease';

            let css = '';

            // Base transition (applied to normal state)
            css += '.' + moduleId + ' .tb-module-preview {';
            css += 'transition: all ' + duration + 's ' + easing + ';';
            css += '}\n';

            // Hover state
            css += '.' + moduleId + ':hover .tb-module-preview {';

            if (settings.text_color_hover) css += 'color:' + settings.text_color_hover + ';';
            if (settings.background_color_hover) css += 'background-color:' + settings.background_color_hover + ';';
            if (settings.border_color_hover) css += 'border-color:' + settings.border_color_hover + ';';
            if (settings.opacity_hover && settings.opacity_hover !== '1') css += 'opacity:' + settings.opacity_hover + ';';

            // Transform (comprehensive Divi-style hover transforms)
            const transformParts = [];

            // Translate hover
            const translateXHover = settings.transform_translate_x_hover || '0';
            const translateYHover = settings.transform_translate_y_hover || '0';
            if (translateXHover !== '0' && translateXHover !== '0px') {
                transformParts.push('translateX(' + (translateXHover.toString().includes('px') ? translateXHover : translateXHover + 'px') + ')');
            }
            if (translateYHover !== '0' && translateYHover !== '0px') {
                transformParts.push('translateY(' + (translateYHover.toString().includes('px') ? translateYHover : translateYHover + 'px') + ')');
            }

            // Rotate hover
            const rotateZHover = settings.transform_rotate_z_hover || '0';
            const rotateXHover = settings.transform_rotate_x_hover || '0';
            const rotateYHover = settings.transform_rotate_y_hover || '0';
            if (rotateZHover !== '0' && rotateZHover !== '0deg') {
                transformParts.push('rotateZ(' + (rotateZHover.toString().includes('deg') ? rotateZHover : rotateZHover + 'deg') + ')');
            }
            if (rotateXHover !== '0' && rotateXHover !== '0deg') {
                transformParts.push('rotateX(' + (rotateXHover.toString().includes('deg') ? rotateXHover : rotateXHover + 'deg') + ')');
            }
            if (rotateYHover !== '0' && rotateYHover !== '0deg') {
                transformParts.push('rotateY(' + (rotateYHover.toString().includes('deg') ? rotateYHover : rotateYHover + 'deg') + ')');
            }

            // Scale hover (supports both old single scale and new X/Y scale)
            const scaleHover = settings.transform_scale_hover; // Old single scale for backwards compatibility
            const scaleXHover = settings.transform_scale_x_hover || (scaleHover ? String(parseFloat(scaleHover) * 100) : null) || '100';
            const scaleYHover = settings.transform_scale_y_hover || (scaleHover ? String(parseFloat(scaleHover) * 100) : null) || '100';
            const scaleXVal = parseFloat(scaleXHover.toString().replace('%', '')) / 100;
            const scaleYVal = parseFloat(scaleYHover.toString().replace('%', '')) / 100;
            if (scaleXVal !== 1 || scaleYVal !== 1) {
                if (scaleXVal === scaleYVal) {
                    transformParts.push('scale(' + scaleXVal + ')');
                } else {
                    transformParts.push('scale(' + scaleXVal + ',' + scaleYVal + ')');
                }
            }

            // Skew hover
            const skewXHover = settings.transform_skew_x_hover || '0';
            const skewYHover = settings.transform_skew_y_hover || '0';
            if (skewXHover !== '0' && skewXHover !== '0deg') {
                transformParts.push('skewX(' + (skewXHover.toString().includes('deg') ? skewXHover : skewXHover + 'deg') + ')');
            }
            if (skewYHover !== '0' && skewYHover !== '0deg') {
                transformParts.push('skewY(' + (skewYHover.toString().includes('deg') ? skewYHover : skewYHover + 'deg') + ')');
            }

            // Apply transform if any parts exist
            if (transformParts.length > 0) {
                css += 'transform:' + transformParts.join(' ') + ';';
            }

            // Transform origin hover
            const transformOriginHover = settings.transform_origin_hover;
            if (transformOriginHover && transformOriginHover !== 'center center') {
                css += 'transform-origin:' + transformOriginHover + ';';
            }

            // Box shadow hover
            if (settings.box_shadow_hover_enabled) {
                const h = parseInt(settings.box_shadow_hover_horizontal) || 0;
                const v = parseInt(settings.box_shadow_hover_vertical) || 8;
                const blur = parseInt(settings.box_shadow_hover_blur) || 20;
                const spread = parseInt(settings.box_shadow_hover_spread) || 0;
                const color = settings.box_shadow_hover_color || 'rgba(0,0,0,0.15)';
                css += 'box-shadow:' + h + 'px ' + v + 'px ' + blur + 'px ' + spread + 'px ' + color + ';';
            }

            // Filter hover
            if (settings.filter_hover_enabled) {
                const filterParts = [];

                // Blur hover
                const blurHover = parseFloat(settings.filter_blur_hover || settings.filter_blur || '0');
                if (blurHover > 0) {
                    filterParts.push('blur(' + blurHover + 'px)');
                }

                // Brightness hover
                const brightnessHover = parseFloat(settings.filter_brightness_hover || settings.filter_brightness || '100');
                if (brightnessHover !== 100) {
                    filterParts.push('brightness(' + (brightnessHover / 100) + ')');
                }

                // Contrast hover
                const contrastHover = parseFloat(settings.filter_contrast_hover || settings.filter_contrast || '100');
                if (contrastHover !== 100) {
                    filterParts.push('contrast(' + (contrastHover / 100) + ')');
                }

                // Saturation hover
                const saturationHover = parseFloat(settings.filter_saturation_hover || settings.filter_saturation || '100');
                if (saturationHover !== 100) {
                    filterParts.push('saturate(' + (saturationHover / 100) + ')');
                }

                // Hue rotate hover
                const hueRotateHover = parseFloat(settings.filter_hue_rotate_hover || settings.filter_hue_rotate || '0');
                if (hueRotateHover !== 0) {
                    filterParts.push('hue-rotate(' + hueRotateHover + 'deg)');
                }

                // Grayscale hover
                const grayscaleHover = parseFloat(settings.filter_grayscale_hover || settings.filter_grayscale || '0');
                if (grayscaleHover > 0) {
                    filterParts.push('grayscale(' + (grayscaleHover / 100) + ')');
                }

                // Sepia hover
                const sepiaHover = parseFloat(settings.filter_sepia_hover || settings.filter_sepia || '0');
                if (sepiaHover > 0) {
                    filterParts.push('sepia(' + (sepiaHover / 100) + ')');
                }

                // Invert hover
                const invertHover = parseFloat(settings.filter_invert_hover || settings.filter_invert || '0');
                if (invertHover > 0) {
                    filterParts.push('invert(' + (invertHover / 100) + ')');
                }

                // Opacity hover (filter)
                const opacityHover = parseFloat(settings.filter_opacity_hover || settings.filter_opacity || '100');
                if (opacityHover !== 100) {
                    filterParts.push('opacity(' + (opacityHover / 100) + ')');
                }

                if (filterParts.length > 0) {
                    css += 'filter:' + filterParts.join(' ') + ';';
                } else {
                    // Reset to none if all hover filters are at default
                    css += 'filter:none;';
                }
            }

            css += '}\n';

            return css;
        },

        // Update the hover stylesheet with all module hover styles
        updateHoverStylesheet() {
            const styleEl = document.getElementById('tb-hover-styles');
            if (!styleEl) return;

            let css = '/* Auto-generated hover styles */\n';

            // Iterate through all modules and generate hover CSS
            const sections = this.content.sections || [];
            sections.forEach((section, sIdx) => {
                const rows = section.rows || [];
                rows.forEach((row, rIdx) => {
                    const columns = row.columns || [];
                    columns.forEach((col, cIdx) => {
                        const modules = col.modules || [];
                        modules.forEach((mod, mIdx) => {
                            if (mod.settings?.hover_enabled) {
                                const moduleId = 'tb-mod-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx;
                                css += this.generateHoverCSS(moduleId, mod.settings);
                            }
                        });
                    });
                });
            });

            styleEl.textContent = css;
        },

        renderAdvancedSettings(mod, sIdx, rIdx, cIdx, mIdx) {
            const settings = mod.settings || {};
            return '<div class="tb-setting-group"><div class="tb-setting-label">CSS Class</div><input type="text" class="tb-setting-input" value="' + (settings.cssClass || '') + '" placeholder="custom-class" onchange="TB.updateModuleSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'cssClass\',this.value)"></div><div class="tb-setting-group"><div class="tb-setting-label">Custom ID</div><input type="text" class="tb-setting-input" value="' + (settings.customId || '') + '" placeholder="element-id" onchange="TB.updateModuleSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'customId\',this.value)"></div><div class="tb-setting-group"><div class="tb-setting-label">Custom CSS</div><textarea class="tb-setting-input" rows="4" style="font-family:monospace;font-size:11px" placeholder="color: red;" onchange="TB.updateModuleSetting(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'customCss\',this.value)">' + (settings.customCss || '') + '</textarea></div>';
        },

        updateModuleContent(sIdx, rIdx, cIdx, mIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.content) mod.content = {};
            mod.content[key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateModuleSetting(sIdx, rIdx, cIdx, mIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};
            mod.settings[key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateModuleDesign(sIdx, rIdx, cIdx, mIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.design) mod.design = {};
            mod.design[key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Typography update functions
        updateTypography(sIdx, rIdx, cIdx, mIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};
            if (!mod.settings.typography) mod.settings.typography = {};
            mod.settings.typography[key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateTypographyWithUnit(sIdx, rIdx, cIdx, mIdx, key, value, unit) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};
            if (!mod.settings.typography) mod.settings.typography = {};
            if (value === '' || value === null || value === undefined) {
                mod.settings.typography[key] = '';
            } else {
                mod.settings.typography[key] = value + (unit || '');
            }
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Helper function to build typography style string
        getTypographyStyles(settings) {
            const typography = settings?.typography || {};
            let styles = '';
            if (typography.font_family) styles += 'font-family:' + typography.font_family + ';';
            if (typography.font_size) styles += 'font-size:' + typography.font_size + ';';
            if (typography.font_weight) styles += 'font-weight:' + typography.font_weight + ';';
            if (typography.line_height) styles += 'line-height:' + typography.line_height + ';';
            if (typography.letter_spacing) styles += 'letter-spacing:' + typography.letter_spacing + ';';
            if (typography.text_transform) styles += 'text-transform:' + typography.text_transform + ';';
            if (typography.color) styles += 'color:' + typography.color + ';';
            return styles;
        },

        // Helper function to build typography style string for a specific element
        getElementTypographyStyles(settings, element) {
            const key = 'typography_' + element;
            const typography = settings?.[key] || {};
            let styles = '';
            if (typography.font_family) styles += 'font-family:' + typography.font_family + ';';
            if (typography.font_size) styles += 'font-size:' + typography.font_size + ';';
            if (typography.font_weight) styles += 'font-weight:' + typography.font_weight + ';';
            if (typography.line_height) styles += 'line-height:' + typography.line_height + ';';
            if (typography.letter_spacing) styles += 'letter-spacing:' + typography.letter_spacing + ';';
            if (typography.text_transform) styles += 'text-transform:' + typography.text_transform + ';';
            if (typography.color) styles += 'color:' + typography.color + ';';
            return styles;
        },

        // Update typography for a specific element (e.g., typography_title, typography_subtitle)
        updateTypographyElement(sIdx, rIdx, cIdx, mIdx, element, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};
            const typoKey = 'typography_' + element;
            if (!mod.settings[typoKey]) mod.settings[typoKey] = {};
            mod.settings[typoKey][key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateTypographyElementWithUnit(sIdx, rIdx, cIdx, mIdx, element, key, value, unit) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};
            const typoKey = 'typography_' + element;
            if (!mod.settings[typoKey]) mod.settings[typoKey] = {};
            if (value === '' || value === null || value === undefined) {
                mod.settings[typoKey][key] = '';
            } else {
                mod.settings[typoKey][key] = value + (unit || '');
            }
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // ═══════════════════════════════════════════════════════════
        // SPACING SYSTEM (Divi-style per-side control)
        // ═══════════════════════════════════════════════════════════

        // Update spacing value (margin or padding) for a specific side
        updateSpacing(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            // Ensure value has px unit if numeric
            if (value !== '' && value !== null && value !== undefined) {
                const numVal = parseFloat(value);
                if (!isNaN(numVal) && !String(value).includes('px')) {
                    value = numVal + 'px';
                }
            }

            mod.settings[property] = value || '0px';
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Toggle linked spacing (sync all 4 sides)
        toggleSpacingLink(sIdx, rIdx, cIdx, mIdx, type) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            const linkKey = type + '_linked';
            mod.settings[linkKey] = !mod.settings[linkKey];

            // If linking, sync all values to the top value
            if (mod.settings[linkKey]) {
                const topValue = mod.settings[type + '_top'] || '0px';
                mod.settings[type + '_right'] = topValue;
                mod.settings[type + '_bottom'] = topValue;
                mod.settings[type + '_left'] = topValue;
            }

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Handle spacing input change with link support
        handleSpacingChange(sIdx, rIdx, cIdx, mIdx, type, side, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            const linkKey = type + '_linked';
            const isLinked = mod.settings[linkKey];

            // Ensure value has px unit if numeric
            if (value !== '' && value !== null && value !== undefined) {
                const numVal = parseFloat(value);
                if (!isNaN(numVal) && !String(value).includes('px')) {
                    value = numVal + 'px';
                }
            } else {
                value = '0px';
            }

            if (isLinked) {
                // Update all 4 sides
                mod.settings[type + '_top'] = value;
                mod.settings[type + '_right'] = value;
                mod.settings[type + '_bottom'] = value;
                mod.settings[type + '_left'] = value;
            } else {
                // Update only the specified side
                mod.settings[type + '_' + side] = value;
            }

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Toggle spacing section collapse
        toggleSpacingSection(element) {
            const section = element.closest('.tb-spacing-section');
            if (section) {
                section.classList.toggle('collapsed');
            }
        },

        // Render visual spacing box for margin or padding
        renderSpacingSettings(sIdx, rIdx, cIdx, mIdx, type, label) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            const settings = mod?.settings || {};

            const topVal = parseInt(settings[type + '_top']) || 0;
            const rightVal = parseInt(settings[type + '_right']) || 0;
            const bottomVal = parseInt(settings[type + '_bottom']) || 0;
            const leftVal = parseInt(settings[type + '_left']) || 0;
            const isLinked = settings[type + '_linked'] || false;

            const colorClass = type === 'margin' ? 'margin' : 'padding';
            const bgColor = type === 'margin' ? 'rgba(249, 226, 175, 0.15)' : 'rgba(166, 227, 161, 0.15)';
            const borderColor = type === 'margin' ? 'rgba(249, 226, 175, 0.5)' : 'rgba(166, 227, 161, 0.5)';

            let html = '';

            html += '<div class="tb-spacing-box">';
            html += '<div style="position:relative;background:' + bgColor + ';border:2px dashed ' + borderColor + ';border-radius:8px;padding:24px 20px">';

            // Label
            html += '<span class="tb-spacing-label tb-spacing-label-' + colorClass + '">' + label + '</span>';

            // Top input
            html += '<div class="tb-spacing-input-wrap tb-spacing-' + colorClass + '-top">';
            html += '<input type="number" value="' + topVal + '" min="0" max="500" placeholder="0" onchange="TB.handleSpacingChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + type + '\',\'top\',this.value)">';
            html += '</div>';

            // Right input
            html += '<div class="tb-spacing-input-wrap tb-spacing-' + colorClass + '-right">';
            html += '<input type="number" value="' + rightVal + '" min="0" max="500" placeholder="0" onchange="TB.handleSpacingChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + type + '\',\'right\',this.value)">';
            html += '</div>';

            // Bottom input
            html += '<div class="tb-spacing-input-wrap tb-spacing-' + colorClass + '-bottom">';
            html += '<input type="number" value="' + bottomVal + '" min="0" max="500" placeholder="0" onchange="TB.handleSpacingChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + type + '\',\'bottom\',this.value)">';
            html += '</div>';

            // Left input
            html += '<div class="tb-spacing-input-wrap tb-spacing-' + colorClass + '-left">';
            html += '<input type="number" value="' + leftVal + '" min="0" max="500" placeholder="0" onchange="TB.handleSpacingChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + type + '\',\'left\',this.value)">';
            html += '</div>';

            // Link button (center)
            html += '<button type="button" class="tb-spacing-link-btn tb-spacing-link-' + colorClass + (isLinked ? ' linked' : '') + '" onclick="TB.toggleSpacingLink(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + type + '\')" title="' + (isLinked ? 'Unlink values' : 'Link all values') + '">';
            html += isLinked ? '🔗' : '⛓️';
            html += '</button>';

            html += '</div>';
            html += '</div>';

            return html;
        },

        // Helper to render full spacing section (both margin and padding)
        renderFullSpacingSection(sIdx, rIdx, cIdx, mIdx) {
            let html = '';

            // Margin subsection
            html += '<div class="tb-spacing-section" id="spacing-margin-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-spacing-section-header" onclick="TB.toggleSpacingSection(this)">';
            html += '<div class="tb-spacing-section-title"><span style="color:#c9a227">◼</span> Margin</div>';
            html += '<span class="tb-spacing-section-toggle">▼</span>';
            html += '</div>';
            html += '<div class="tb-spacing-section-body">';
            html += this.renderSpacingSettings(sIdx, rIdx, cIdx, mIdx, 'margin', 'MARGIN');
            html += '</div></div>';

            // Padding subsection
            html += '<div class="tb-spacing-section" id="spacing-padding-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-spacing-section-header" onclick="TB.toggleSpacingSection(this)">';
            html += '<div class="tb-spacing-section-title"><span style="color:#40a02b">◼</span> Padding</div>';
            html += '<span class="tb-spacing-section-toggle">▼</span>';
            html += '</div>';
            html += '<div class="tb-spacing-section-body">';
            html += this.renderSpacingSettings(sIdx, rIdx, cIdx, mIdx, 'padding', 'PADDING');
            html += '</div></div>';

            return html;
        },

        // Helper to render combined spacing box (margin outer, padding inner) - RESPONSIVE
        renderCombinedSpacingBox(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            const settings = mod?.settings || {};

            // Device indicator
            const deviceIcon = this.getDeviceIcon(this.currentDevice);
            const deviceClass = this.currentDevice;

            // Use responsive helper functions to get values
            const mTop = this.getResponsiveSpacingValue(settings, 'margin', 'top');
            const mRight = this.getResponsiveSpacingValue(settings, 'margin', 'right');
            const mBottom = this.getResponsiveSpacingValue(settings, 'margin', 'bottom');
            const mLeft = this.getResponsiveSpacingValue(settings, 'margin', 'left');
            const marginLinked = this.isResponsiveSpacingLinked(settings, 'margin');

            const pTop = this.getResponsiveSpacingValue(settings, 'padding', 'top');
            const pRight = this.getResponsiveSpacingValue(settings, 'padding', 'right');
            const pBottom = this.getResponsiveSpacingValue(settings, 'padding', 'bottom');
            const pLeft = this.getResponsiveSpacingValue(settings, 'padding', 'left');
            const paddingLinked = this.isResponsiveSpacingLinked(settings, 'padding');

            // Check if any spacing property has responsive values
            const hasResponsiveMargin = ['top', 'right', 'bottom', 'left'].some(side =>
                (settings['margin_' + side + '_tablet'] !== undefined && settings['margin_' + side + '_tablet'] !== '') ||
                (settings['margin_' + side + '_mobile'] !== undefined && settings['margin_' + side + '_mobile'] !== '')
            );
            const hasResponsivePadding = ['top', 'right', 'bottom', 'left'].some(side =>
                (settings['padding_' + side + '_tablet'] !== undefined && settings['padding_' + side + '_tablet'] !== '') ||
                (settings['padding_' + side + '_mobile'] !== undefined && settings['padding_' + side + '_mobile'] !== '')
            );

            let html = '<div class="tb-spacing-box">';

            // Device indicator header
            html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;font-size:11px;color:var(--tb-text-muted)">';
            html += '<span class="tb-device-icon ' + deviceClass + '">' + deviceIcon + '</span>';
            html += '<span>Editing for ' + this.currentDevice.charAt(0).toUpperCase() + this.currentDevice.slice(1) + '</span>';
            html += '</div>';

            // Outer margin box
            html += '<div class="tb-spacing-box-outer">';
            html += '<span class="tb-spacing-label tb-spacing-label-margin">MARGIN';
            if (hasResponsiveMargin) html += ' <span class="tb-responsive-badge has-responsive" style="font-size:8px">R</span>';
            html += '</span>';

            // Margin inputs (using responsive handlers)
            html += '<div class="tb-spacing-input-wrap tb-spacing-margin-top"><input type="number" value="' + mTop + '" min="0" max="500" placeholder="0" onchange="TB.handleResponsiveSpacingChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'margin\',\'top\',this.value)"></div>';
            html += '<div class="tb-spacing-input-wrap tb-spacing-margin-right"><input type="number" value="' + mRight + '" min="0" max="500" placeholder="0" onchange="TB.handleResponsiveSpacingChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'margin\',\'right\',this.value)"></div>';
            html += '<div class="tb-spacing-input-wrap tb-spacing-margin-bottom"><input type="number" value="' + mBottom + '" min="0" max="500" placeholder="0" onchange="TB.handleResponsiveSpacingChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'margin\',\'bottom\',this.value)"></div>';
            html += '<div class="tb-spacing-input-wrap tb-spacing-margin-left"><input type="number" value="' + mLeft + '" min="0" max="500" placeholder="0" onchange="TB.handleResponsiveSpacingChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'margin\',\'left\',this.value)"></div>';

            // Margin link button (using responsive handler)
            html += '<button type="button" class="tb-spacing-link-btn tb-spacing-link-margin' + (marginLinked ? ' linked' : '') + '" onclick="TB.toggleResponsiveSpacingLink(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'margin\')" title="' + (marginLinked ? 'Unlink margin values' : 'Link all margin values') + '">' + (marginLinked ? '🔗' : '⛓️') + '</button>';

            // Inner padding box
            html += '<div class="tb-spacing-box-inner">';
            html += '<span class="tb-spacing-label tb-spacing-label-padding">PADDING';
            if (hasResponsivePadding) html += ' <span class="tb-responsive-badge has-responsive" style="font-size:8px">R</span>';
            html += '</span>';

            // Padding inputs (using responsive handlers)
            html += '<div class="tb-spacing-input-wrap tb-spacing-padding-top"><input type="number" value="' + pTop + '" min="0" max="500" placeholder="0" onchange="TB.handleResponsiveSpacingChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'padding\',\'top\',this.value)"></div>';
            html += '<div class="tb-spacing-input-wrap tb-spacing-padding-right"><input type="number" value="' + pRight + '" min="0" max="500" placeholder="0" onchange="TB.handleResponsiveSpacingChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'padding\',\'right\',this.value)"></div>';
            html += '<div class="tb-spacing-input-wrap tb-spacing-padding-bottom"><input type="number" value="' + pBottom + '" min="0" max="500" placeholder="0" onchange="TB.handleResponsiveSpacingChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'padding\',\'bottom\',this.value)"></div>';
            html += '<div class="tb-spacing-input-wrap tb-spacing-padding-left"><input type="number" value="' + pLeft + '" min="0" max="500" placeholder="0" onchange="TB.handleResponsiveSpacingChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'padding\',\'left\',this.value)"></div>';

            // Padding link button (using responsive handler)
            html += '<button type="button" class="tb-spacing-link-btn tb-spacing-link-padding' + (paddingLinked ? ' linked' : '') + '" onclick="TB.toggleResponsiveSpacingLink(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'padding\')" title="' + (paddingLinked ? 'Unlink padding values' : 'Link all padding values') + '">' + (paddingLinked ? '🔗' : '⛓️') + '</button>';

            // Center content placeholder
            html += '<div class="tb-spacing-box-content">Content</div>';

            html += '</div>'; // inner
            html += '</div>'; // outer
            html += '</div>'; // box

            return html;
        },

        // ═══════════════════════════════════════════════════════════
        // BORDER SETTINGS FUNCTIONS (Divi-style per-side control)
        // ═══════════════════════════════════════════════════════════

        // Render complete border settings panel
        renderBorderSettings(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            const settings = mod?.settings || {};

            // Border width values
            const bwTop = parseInt(settings.border_width_top) || 0;
            const bwRight = parseInt(settings.border_width_right) || 0;
            const bwBottom = parseInt(settings.border_width_bottom) || 0;
            const bwLeft = parseInt(settings.border_width_left) || 0;
            const borderWidthLinked = settings.border_width_linked || false;

            // Border style and color
            const borderStyle = settings.border_style || 'none';
            const borderColor = settings.border_color || '#e2e8f0';

            // Border radius values
            const brTL = parseInt(settings.border_radius_tl) || 0;
            const brTR = parseInt(settings.border_radius_tr) || 0;
            const brBR = parseInt(settings.border_radius_br) || 0;
            const brBL = parseInt(settings.border_radius_bl) || 0;
            const borderRadiusLinked = settings.border_radius_linked || false;

            let html = '';

            // Border Width Section
            html += '<div class="tb-border-section" id="border-width-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-border-section-header" onclick="TB.toggleBorderSection(this)">';
            html += '<div class="tb-border-section-title"><span style="color:#7c7fea">◼</span> Border Width</div>';
            html += '<span class="tb-border-section-toggle">▼</span>';
            html += '</div>';
            html += '<div class="tb-border-section-body">';
            html += this.renderBorderWidthBox(sIdx, rIdx, cIdx, mIdx, bwTop, bwRight, bwBottom, bwLeft, borderWidthLinked);
            html += '</div></div>';

            // Border Style Section
            html += '<div class="tb-border-section" id="border-style-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-border-section-header" onclick="TB.toggleBorderSection(this)">';
            html += '<div class="tb-border-section-title"><span style="color:#89b4fa">◼</span> Border Style</div>';
            html += '<span class="tb-border-section-toggle">▼</span>';
            html += '</div>';
            html += '<div class="tb-border-section-body">';
            html += '<div class="tb-border-style-row">';
            html += '<label>Style</label>';
            html += '<select onchange="TB.updateBorder(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_style\',this.value)">';
            const styles = ['none', 'solid', 'dashed', 'dotted', 'double', 'groove', 'ridge', 'inset', 'outset'];
            styles.forEach(s => {
                html += '<option value="' + s + '"' + (borderStyle === s ? ' selected' : '') + '>' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>';
            });
            html += '</select>';
            html += '</div>';
            html += '</div></div>';

            // Border Color Section
            html += '<div class="tb-border-section" id="border-color-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-border-section-header" onclick="TB.toggleBorderSection(this)">';
            html += '<div class="tb-border-section-title"><span style="color:#a6e3a1">◼</span> Border Color</div>';
            html += '<span class="tb-border-section-toggle">▼</span>';
            html += '</div>';
            html += '<div class="tb-border-section-body">';
            html += '<div class="tb-border-color-row">';
            html += '<label>Color</label>';
            html += '<input type="color" value="' + borderColor + '" onchange="TB.updateBorder(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_color\',this.value)">';
            html += '<input type="text" value="' + borderColor + '" placeholder="#e2e8f0" onchange="TB.updateBorder(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'border_color\',this.value)">';
            html += '</div>';
            html += '</div></div>';

            // Border Radius Section
            html += '<div class="tb-border-section" id="border-radius-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-border-section-header" onclick="TB.toggleBorderSection(this)">';
            html += '<div class="tb-border-section-title"><span style="color:#f5c2e7">◼</span> Border Radius</div>';
            html += '<span class="tb-border-section-toggle">▼</span>';
            html += '</div>';
            html += '<div class="tb-border-section-body">';
            html += this.renderBorderRadiusBox(sIdx, rIdx, cIdx, mIdx, brTL, brTR, brBR, brBL, borderRadiusLinked);
            html += '</div></div>';

            return html;
        },

        // Render visual border width box with per-side inputs
        renderBorderWidthBox(sIdx, rIdx, cIdx, mIdx, top, right, bottom, left, linked) {
            let html = '<div class="tb-border-box">';
            html += '<div class="tb-border-box-outer">';
            html += '<span class="tb-border-label">WIDTH</span>';
            html += '<div class="tb-border-box-inner">';

            // Top input
            html += '<div class="tb-border-input-wrap tb-border-width-top">';
            html += '<input type="number" value="' + top + '" min="0" max="50" placeholder="0" onchange="TB.handleBorderWidthChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'top\',this.value)">';
            html += '</div>';

            // Right input
            html += '<div class="tb-border-input-wrap tb-border-width-right">';
            html += '<input type="number" value="' + right + '" min="0" max="50" placeholder="0" onchange="TB.handleBorderWidthChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'right\',this.value)">';
            html += '</div>';

            // Bottom input
            html += '<div class="tb-border-input-wrap tb-border-width-bottom">';
            html += '<input type="number" value="' + bottom + '" min="0" max="50" placeholder="0" onchange="TB.handleBorderWidthChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'bottom\',this.value)">';
            html += '</div>';

            // Left input
            html += '<div class="tb-border-input-wrap tb-border-width-left">';
            html += '<input type="number" value="' + left + '" min="0" max="50" placeholder="0" onchange="TB.handleBorderWidthChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'left\',this.value)">';
            html += '</div>';

            // Link button
            html += '<button type="button" class="tb-border-link-btn' + (linked ? ' linked' : '') + '" onclick="TB.toggleBorderLink(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'width\')" title="' + (linked ? 'Unlink values' : 'Link all values') + '">';
            html += linked ? '🔗' : '⛓️';
            html += '</button>';

            html += '<div class="tb-border-box-content">Element</div>';

            html += '</div>'; // inner
            html += '</div>'; // outer
            html += '</div>'; // box

            return html;
        },

        // Render visual border radius box with corner inputs
        renderBorderRadiusBox(sIdx, rIdx, cIdx, mIdx, tl, tr, br, bl, linked) {
            // Calculate preview border radius
            const previewRadius = tl + 'px ' + tr + 'px ' + br + 'px ' + bl + 'px';

            let html = '<div class="tb-radius-box">';
            html += '<span class="tb-radius-label">CORNERS</span>';
            html += '<div class="tb-radius-box-visual" style="border-radius:' + previewRadius + '">';

            // Top-left corner
            html += '<div class="tb-radius-corner tb-radius-tl">';
            html += '<input type="number" value="' + tl + '" min="0" max="200" placeholder="0" onchange="TB.handleBorderRadiusChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'tl\',this.value)" title="Top Left">';
            html += '</div>';

            // Top-right corner
            html += '<div class="tb-radius-corner tb-radius-tr">';
            html += '<input type="number" value="' + tr + '" min="0" max="200" placeholder="0" onchange="TB.handleBorderRadiusChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'tr\',this.value)" title="Top Right">';
            html += '</div>';

            // Bottom-right corner
            html += '<div class="tb-radius-corner tb-radius-br">';
            html += '<input type="number" value="' + br + '" min="0" max="200" placeholder="0" onchange="TB.handleBorderRadiusChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'br\',this.value)" title="Bottom Right">';
            html += '</div>';

            // Bottom-left corner
            html += '<div class="tb-radius-corner tb-radius-bl">';
            html += '<input type="number" value="' + bl + '" min="0" max="200" placeholder="0" onchange="TB.handleBorderRadiusChange(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'bl\',this.value)" title="Bottom Left">';
            html += '</div>';

            // Link button
            html += '<button type="button" class="tb-radius-link-btn' + (linked ? ' linked' : '') + '" onclick="TB.toggleBorderLink(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'radius\')" title="' + (linked ? 'Unlink corners' : 'Link all corners') + '">';
            html += linked ? '🔗' : '⛓️';
            html += '</button>';

            html += '</div>'; // visual
            html += '</div>'; // box

            return html;
        },

        // Toggle border section collapse
        toggleBorderSection(element) {
            const section = element.closest('.tb-border-section');
            if (section) {
                section.classList.toggle('collapsed');
            }
        },

        // Update border property
        updateBorder(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};
            mod.settings[property] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Handle border width input change with link support
        handleBorderWidthChange(sIdx, rIdx, cIdx, mIdx, side, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            const numValue = parseInt(value) || 0;
            const pxValue = numValue + 'px';

            if (mod.settings.border_width_linked) {
                // If linked, update all sides
                mod.settings.border_width_top = pxValue;
                mod.settings.border_width_right = pxValue;
                mod.settings.border_width_bottom = pxValue;
                mod.settings.border_width_left = pxValue;
            } else {
                // Update only the specified side
                mod.settings['border_width_' + side] = pxValue;
            }

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Handle border radius input change with link support
        handleBorderRadiusChange(sIdx, rIdx, cIdx, mIdx, corner, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            const numValue = parseInt(value) || 0;
            const pxValue = numValue + 'px';

            if (mod.settings.border_radius_linked) {
                // If linked, update all corners
                mod.settings.border_radius_tl = pxValue;
                mod.settings.border_radius_tr = pxValue;
                mod.settings.border_radius_br = pxValue;
                mod.settings.border_radius_bl = pxValue;
            } else {
                // Update only the specified corner
                mod.settings['border_radius_' + corner] = pxValue;
            }

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Toggle linked border values (width or radius)
        toggleBorderLink(sIdx, rIdx, cIdx, mIdx, type) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            const linkKey = type === 'width' ? 'border_width_linked' : 'border_radius_linked';
            const isLinked = !mod.settings[linkKey];
            mod.settings[linkKey] = isLinked;

            // If linking, sync all values to the first non-zero value
            if (isLinked) {
                if (type === 'width') {
                    const values = [
                        parseInt(mod.settings.border_width_top) || 0,
                        parseInt(mod.settings.border_width_right) || 0,
                        parseInt(mod.settings.border_width_bottom) || 0,
                        parseInt(mod.settings.border_width_left) || 0
                    ];
                    const syncValue = values.find(v => v > 0) || 0;
                    const pxValue = syncValue + 'px';
                    mod.settings.border_width_top = pxValue;
                    mod.settings.border_width_right = pxValue;
                    mod.settings.border_width_bottom = pxValue;
                    mod.settings.border_width_left = pxValue;
                } else {
                    const values = [
                        parseInt(mod.settings.border_radius_tl) || 0,
                        parseInt(mod.settings.border_radius_tr) || 0,
                        parseInt(mod.settings.border_radius_br) || 0,
                        parseInt(mod.settings.border_radius_bl) || 0
                    ];
                    const syncValue = values.find(v => v > 0) || 0;
                    const pxValue = syncValue + 'px';
                    mod.settings.border_radius_tl = pxValue;
                    mod.settings.border_radius_tr = pxValue;
                    mod.settings.border_radius_br = pxValue;
                    mod.settings.border_radius_bl = pxValue;
                }
            }

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // ═══════════════════════════════════════════════════════════
        // BOX SHADOW SETTINGS FUNCTIONS (Divi-style controls)
        // ═══════════════════════════════════════════════════════════

        // Render complete box shadow settings panel
        renderBoxShadowSettings(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            const settings = mod?.settings || {};

            // Box shadow values with defaults
            const shadowEnabled = settings.box_shadow_enabled || false;
            const shadowHorizontal = parseInt(settings.box_shadow_horizontal) || 0;
            const shadowVertical = parseInt(settings.box_shadow_vertical) || 4;
            const shadowBlur = parseInt(settings.box_shadow_blur) || 10;
            const shadowSpread = parseInt(settings.box_shadow_spread) || 0;
            const shadowColor = settings.box_shadow_color || 'rgba(0,0,0,0.1)';
            const shadowInset = settings.box_shadow_inset || false;

            // Generate current shadow CSS for preview
            const currentShadowCSS = this.getBoxShadowCSS(settings);

            let html = '';

            // Main shadow section
            html += '<div class="tb-shadow-section" id="box-shadow-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';
            html += '<div class="tb-shadow-section-header" onclick="TB.toggleShadowSection(this)">';
            html += '<div class="tb-shadow-section-title"><span style="color:#94a3b8">◼</span> Shadow Settings</div>';
            html += '<span class="tb-shadow-section-toggle">▼</span>';
            html += '</div>';
            html += '<div class="tb-shadow-section-body">';

            // Enable toggle
            html += '<div class="tb-shadow-enable-row">';
            html += '<label><input type="checkbox" ' + (shadowEnabled ? 'checked' : '') + ' onchange="TB.updateBoxShadow(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_enabled\',this.checked)"> Enable Box Shadow</label>';
            html += '</div>';

            // Shadow controls container (disabled when shadow is off)
            html += '<div class="tb-shadow-controls' + (shadowEnabled ? '' : ' tb-shadow-disabled') + '" id="shadow-controls-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '">';

            // Live preview box
            html += '<div class="tb-shadow-preview-box" style="box-shadow:' + (shadowEnabled ? currentShadowCSS : 'none') + '" id="shadow-preview-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '"></div>';

            // Presets dropdown
            html += '<div class="tb-shadow-preset-row">';
            html += '<label>Preset</label>';
            html += '<select onchange="TB.applyBoxShadowPreset(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',this.value)">';
            html += '<option value="">Custom</option>';
            html += '<option value="none">None</option>';
            html += '<option value="subtle">Subtle</option>';
            html += '<option value="medium">Medium</option>';
            html += '<option value="large">Large</option>';
            html += '<option value="sharp">Sharp</option>';
            html += '<option value="soft">Soft</option>';
            html += '<option value="inset_subtle">Inset Subtle</option>';
            html += '</select>';
            html += '</div>';

            // Horizontal offset
            html += '<div class="tb-shadow-control-row">';
            html += '<label>Horizontal</label>';
            html += '<input type="range" min="-50" max="50" value="' + shadowHorizontal + '" oninput="TB.updateBoxShadowSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_horizontal\',this.value)">';
            html += '<input type="number" min="-50" max="50" value="' + shadowHorizontal + '" onchange="TB.updateBoxShadow(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_horizontal\',this.value)">px';
            html += '</div>';

            // Vertical offset
            html += '<div class="tb-shadow-control-row">';
            html += '<label>Vertical</label>';
            html += '<input type="range" min="-50" max="50" value="' + shadowVertical + '" oninput="TB.updateBoxShadowSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_vertical\',this.value)">';
            html += '<input type="number" min="-50" max="50" value="' + shadowVertical + '" onchange="TB.updateBoxShadow(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_vertical\',this.value)">px';
            html += '</div>';

            // Blur radius
            html += '<div class="tb-shadow-control-row">';
            html += '<label>Blur</label>';
            html += '<input type="range" min="0" max="100" value="' + shadowBlur + '" oninput="TB.updateBoxShadowSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_blur\',this.value)">';
            html += '<input type="number" min="0" max="100" value="' + shadowBlur + '" onchange="TB.updateBoxShadow(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_blur\',this.value)">px';
            html += '</div>';

            // Spread radius
            html += '<div class="tb-shadow-control-row">';
            html += '<label>Spread</label>';
            html += '<input type="range" min="-50" max="50" value="' + shadowSpread + '" oninput="TB.updateBoxShadowSlider(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_spread\',this.value)">';
            html += '<input type="number" min="-50" max="50" value="' + shadowSpread + '" onchange="TB.updateBoxShadow(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_spread\',this.value)">px';
            html += '</div>';

            // Shadow color
            html += '<div class="tb-shadow-control-row">';
            html += '<label>Color</label>';
            html += '<input type="color" value="' + this.rgbaToHex(shadowColor) + '" onchange="TB.updateBoxShadowColor(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',this.value)">';
            html += '<input type="text" value="' + shadowColor + '" placeholder="rgba(0,0,0,0.1)" onchange="TB.updateBoxShadow(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_color\',this.value)">';
            html += '</div>';

            // Inset toggle
            html += '<div class="tb-shadow-inset-row">';
            html += '<label><input type="checkbox" ' + (shadowInset ? 'checked' : '') + ' onchange="TB.updateBoxShadow(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'box_shadow_inset\',this.checked)"> Inset (inner shadow)</label>';
            html += '</div>';

            html += '</div>'; // controls
            html += '</div>'; // body
            html += '</div>'; // section

            return html;
        },

        // Toggle shadow section collapse
        toggleShadowSection(element) {
            const section = element.closest('.tb-shadow-section');
            if (section) {
                section.classList.toggle('collapsed');
            }
        },

        // Update box shadow property
        updateBoxShadow(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            // Handle boolean values
            if (property === 'box_shadow_enabled' || property === 'box_shadow_inset') {
                mod.settings[property] = value === true || value === 'true';
            } else if (property === 'box_shadow_color') {
                mod.settings[property] = value;
            } else {
                // Numeric values - store with px unit
                const numValue = parseInt(value) || 0;
                mod.settings[property] = numValue + 'px';
            }

            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Update shadow from slider (real-time preview without full re-render)
        updateBoxShadowSlider(sIdx, rIdx, cIdx, mIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            const numValue = parseInt(value) || 0;
            mod.settings[property] = numValue + 'px';

            // Update the number input and preview in real-time
            const controlsContainer = document.getElementById('shadow-controls-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx);
            if (controlsContainer) {
                // Find matching number input in the same row and update it
                const rows = controlsContainer.querySelectorAll('.tb-shadow-control-row');
                rows.forEach(row => {
                    const range = row.querySelector('input[type="range"]');
                    const number = row.querySelector('input[type="number"]');
                    if (range && number && parseInt(range.value) === numValue) {
                        number.value = numValue;
                    }
                });

                // Update preview box
                const previewBox = document.getElementById('shadow-preview-' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx);
                if (previewBox) {
                    previewBox.style.boxShadow = this.getBoxShadowCSS(mod.settings);
                }
            }

            // Debounced save and render
            clearTimeout(this.shadowUpdateTimer);
            this.shadowUpdateTimer = setTimeout(() => {
                this.saveToHistory();
                this.renderCanvas();
            }, 150);
        },

        // Update shadow color from color picker
        updateBoxShadowColor(sIdx, rIdx, cIdx, mIdx, hexColor) {
            // Convert hex to rgba with default opacity
            const rgba = this.hexToRgba(hexColor, 0.1);
            this.updateBoxShadow(sIdx, rIdx, cIdx, mIdx, 'box_shadow_color', rgba);
        },

        // Apply box shadow preset
        applyBoxShadowPreset(sIdx, rIdx, cIdx, mIdx, preset) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.settings) mod.settings = {};

            const presets = {
                'none': { h: 0, v: 0, blur: 0, spread: 0, color: 'rgba(0,0,0,0)', inset: false },
                'subtle': { h: 0, v: 2, blur: 4, spread: 0, color: 'rgba(0,0,0,0.1)', inset: false },
                'medium': { h: 0, v: 4, blur: 12, spread: 0, color: 'rgba(0,0,0,0.15)', inset: false },
                'large': { h: 0, v: 10, blur: 30, spread: 0, color: 'rgba(0,0,0,0.2)', inset: false },
                'sharp': { h: 0, v: 2, blur: 8, spread: 0, color: 'rgba(0,0,0,0.25)', inset: false },
                'soft': { h: 0, v: 20, blur: 50, spread: 0, color: 'rgba(0,0,0,0.1)', inset: false },
                'inset_subtle': { h: 0, v: 2, blur: 4, spread: 0, color: 'rgba(0,0,0,0.1)', inset: true }
            };

            if (preset && presets[preset]) {
                const p = presets[preset];
                mod.settings.box_shadow_horizontal = p.h + 'px';
                mod.settings.box_shadow_vertical = p.v + 'px';
                mod.settings.box_shadow_blur = p.blur + 'px';
                mod.settings.box_shadow_spread = p.spread + 'px';
                mod.settings.box_shadow_color = p.color;
                mod.settings.box_shadow_inset = p.inset;

                // Enable shadow when applying a preset (except 'none')
                if (preset !== 'none') {
                    mod.settings.box_shadow_enabled = true;
                }

                this.saveToHistory();
                this.renderCanvas();
                this.selectModule(sIdx, rIdx, cIdx, mIdx);
            }
        },

        // Get box shadow CSS string from settings
        getBoxShadowCSS(settings) {
            if (!settings || !settings.box_shadow_enabled) {
                return 'none';
            }

            const h = parseInt(settings.box_shadow_horizontal) || 0;
            const v = parseInt(settings.box_shadow_vertical) || 4;
            const blur = parseInt(settings.box_shadow_blur) || 10;
            const spread = parseInt(settings.box_shadow_spread) || 0;
            const color = settings.box_shadow_color || 'rgba(0,0,0,0.1)';
            const inset = settings.box_shadow_inset ? 'inset ' : '';

            return inset + h + 'px ' + v + 'px ' + blur + 'px ' + spread + 'px ' + color;
        },

        // Helper: Convert rgba to hex (for color picker)
        rgbaToHex(rgba) {
            if (!rgba || rgba.startsWith('#')) return rgba || '#000000';
            const match = rgba.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
            if (!match) return '#000000';
            const r = parseInt(match[1]).toString(16).padStart(2, '0');
            const g = parseInt(match[2]).toString(16).padStart(2, '0');
            const b = parseInt(match[3]).toString(16).padStart(2, '0');
            return '#' + r + g + b;
        },

        // Helper: Convert hex to rgba
        hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
        },

        // Timer for debouncing shadow updates
        shadowUpdateTimer: null,

        // Helper to render typography settings panel for a specific element (RESPONSIVE)
        renderTypographySettings(sIdx, rIdx, cIdx, mIdx, element, label) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            const settings = mod?.settings || {};
            const typoKey = 'typography_' + element;
            const typography = settings[typoKey] || {};

            // Get responsive values based on current device
            const getTypoValue = (prop) => {
                if (this.currentDevice === 'desktop') {
                    return typography[prop] || '';
                }
                const deviceKey = prop + '_' + this.currentDevice;
                const deviceValue = typography[deviceKey];
                if (deviceValue !== undefined && deviceValue !== '') {
                    return deviceValue;
                }
                // Inherit from desktop
                return typography[prop] || '';
            };

            // Check if property has responsive values
            const hasResponsive = (prop) => {
                const tabletKey = prop + '_tablet';
                const mobileKey = prop + '_mobile';
                return (typography[tabletKey] !== undefined && typography[tabletKey] !== '') ||
                       (typography[mobileKey] !== undefined && typography[mobileKey] !== '');
            };

            // Device indicator for responsive properties
            const deviceIcon = this.getDeviceIcon(this.currentDevice);
            const deviceClass = this.currentDevice;

            let html = '';

            // Section header with collapsible toggle
            html += '<div class="tb-typography-section" data-element="' + element + '">';
            html += '<div class="tb-setting-group" style="border-bottom:1px solid var(--tb-border);padding-bottom:8px;margin-bottom:12px;cursor:pointer" onclick="TB.toggleTypographySection(this)">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center">';
            html += '<div class="tb-setting-label" style="font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.05em;color:var(--tb-text-muted);margin:0">' + this.escapeHtml(label) + ' Typography</div>';
            html += '<span class="tb-typography-toggle" style="font-size:10px;color:var(--tb-text-muted)">▼</span>';
            html += '</div></div>';

            html += '<div class="tb-typography-content">';

            // Font Family (not responsive)
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Font Family</div><select class="tb-setting-input" onchange="TB.updateTypographyElement(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + element + '\',\'font_family\',this.value)">';
            const fonts = [
                { value: '', label: 'Default' },
                { value: 'system-ui, -apple-system, sans-serif', label: 'System UI' },
                { value: 'Arial, Helvetica, sans-serif', label: 'Arial' },
                { value: 'Helvetica Neue, Helvetica, sans-serif', label: 'Helvetica Neue' },
                { value: 'Georgia, serif', label: 'Georgia' },
                { value: 'Times New Roman, Times, serif', label: 'Times New Roman' },
                { value: 'Verdana, Geneva, sans-serif', label: 'Verdana' },
                { value: 'Trebuchet MS, sans-serif', label: 'Trebuchet MS' },
                { value: 'Tahoma, Geneva, sans-serif', label: 'Tahoma' },
                { value: 'Palatino Linotype, Palatino, serif', label: 'Palatino' },
                { value: 'Courier New, monospace', label: 'Courier New' },
                { value: 'Lucida Console, Monaco, monospace', label: 'Lucida Console' },
                { value: 'Inter, sans-serif', label: 'Inter' },
                { value: 'Roboto, sans-serif', label: 'Roboto' },
                { value: 'Open Sans, sans-serif', label: 'Open Sans' },
                { value: 'Lato, sans-serif', label: 'Lato' },
                { value: 'Montserrat, sans-serif', label: 'Montserrat' },
                { value: 'Poppins, sans-serif', label: 'Poppins' },
                { value: 'Playfair Display, serif', label: 'Playfair Display' },
                { value: 'Merriweather, serif', label: 'Merriweather' }
            ];
            fonts.forEach(f => {
                html += '<option value="' + f.value + '"' + (typography.font_family === f.value ? ' selected' : '') + '>' + f.label + '</option>';
            });
            html += '</select></div>';

            // Font Size with Unit (RESPONSIVE)
            const fontSize = getTypoValue('font_size');
            const fontSizeHasResponsive = hasResponsive('font_size');
            html += '<div class="tb-setting-group"><div class="tb-setting-label">';
            html += '<span class="tb-device-icon ' + deviceClass + '" title="Editing for ' + this.currentDevice + '">' + deviceIcon + '</span> Font Size';
            if (fontSizeHasResponsive) html += '<span class="tb-responsive-badge has-responsive">R</span>';
            html += '</div><div style="display:flex;gap:8px">';
            html += '<input type="number" class="tb-setting-input" style="flex:1" value="' + (parseInt(fontSize) || '') + '" placeholder="16" min="8" max="200" onchange="TB.updateResponsiveTypographyWithUnit(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + element + '\',\'font_size\',this.value,this.nextElementSibling.value)">';
            const sizeUnit = fontSize ? fontSize.replace(/[0-9.]/g, '') || 'px' : 'px';
            html += '<select class="tb-setting-input" style="width:70px" onchange="TB.updateResponsiveTypographyWithUnit(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + element + '\',\'font_size\',this.previousElementSibling.value,this.value)">';
            html += '<option value="px"' + (sizeUnit === 'px' ? ' selected' : '') + '>px</option>';
            html += '<option value="em"' + (sizeUnit === 'em' ? ' selected' : '') + '>em</option>';
            html += '<option value="rem"' + (sizeUnit === 'rem' ? ' selected' : '') + '>rem</option>';
            html += '<option value="%"' + (sizeUnit === '%' ? ' selected' : '') + '>%</option>';
            html += '</select></div></div>';

            // Font Weight (not responsive)
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Font Weight</div><select class="tb-setting-input" onchange="TB.updateTypographyElement(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + element + '\',\'font_weight\',this.value)">';
            const weights = [
                { value: '', label: 'Default' },
                { value: '100', label: '100 - Thin' },
                { value: '200', label: '200 - Extra Light' },
                { value: '300', label: '300 - Light' },
                { value: '400', label: '400 - Normal' },
                { value: '500', label: '500 - Medium' },
                { value: '600', label: '600 - Semi Bold' },
                { value: '700', label: '700 - Bold' },
                { value: '800', label: '800 - Extra Bold' },
                { value: '900', label: '900 - Black' }
            ];
            weights.forEach(w => {
                html += '<option value="' + w.value + '"' + (typography.font_weight === w.value ? ' selected' : '') + '>' + w.label + '</option>';
            });
            html += '</select></div>';

            // Line Height with Unit (RESPONSIVE)
            const lineHeight = getTypoValue('line_height');
            const lineHeightHasResponsive = hasResponsive('line_height');
            const lhValue = lineHeight ? parseFloat(lineHeight) : '';
            const lhUnit = lineHeight ? lineHeight.replace(/[0-9.]/g, '') || '' : '';
            html += '<div class="tb-setting-group"><div class="tb-setting-label">';
            html += '<span class="tb-device-icon ' + deviceClass + '" title="Editing for ' + this.currentDevice + '">' + deviceIcon + '</span> Line Height';
            if (lineHeightHasResponsive) html += '<span class="tb-responsive-badge has-responsive">R</span>';
            html += '</div><div style="display:flex;gap:8px">';
            html += '<input type="number" class="tb-setting-input" style="flex:1" value="' + lhValue + '" placeholder="1.6" min="0.5" max="5" step="0.1" onchange="TB.updateResponsiveTypographyWithUnit(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + element + '\',\'line_height\',this.value,this.nextElementSibling.value)">';
            html += '<select class="tb-setting-input" style="width:70px" onchange="TB.updateResponsiveTypographyWithUnit(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + element + '\',\'line_height\',this.previousElementSibling.value,this.value)">';
            html += '<option value=""' + (lhUnit === '' ? ' selected' : '') + '>-</option>';
            html += '<option value="px"' + (lhUnit === 'px' ? ' selected' : '') + '>px</option>';
            html += '<option value="em"' + (lhUnit === 'em' ? ' selected' : '') + '>em</option>';
            html += '<option value="%"' + (lhUnit === '%' ? ' selected' : '') + '>%</option>';
            html += '</select></div></div>';

            // Letter Spacing (not responsive for now)
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Letter Spacing</div><div style="display:flex;gap:8px">';
            const lsValue = typography.letter_spacing ? parseFloat(typography.letter_spacing) : '';
            const lsUnit = typography.letter_spacing ? typography.letter_spacing.replace(/[0-9.-]/g, '') || 'px' : 'px';
            html += '<input type="number" class="tb-setting-input" style="flex:1" value="' + lsValue + '" placeholder="0" step="0.5" min="-5" max="20" onchange="TB.updateTypographyElementWithUnit(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + element + '\',\'letter_spacing\',this.value,this.nextElementSibling.value)">';
            html += '<select class="tb-setting-input" style="width:70px" onchange="TB.updateTypographyElementWithUnit(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + element + '\',\'letter_spacing\',this.previousElementSibling.value,this.value)">';
            html += '<option value="px"' + (lsUnit === 'px' ? ' selected' : '') + '>px</option>';
            html += '<option value="em"' + (lsUnit === 'em' ? ' selected' : '') + '>em</option>';
            html += '</select></div></div>';

            // Text Transform (not responsive)
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Text Transform</div><select class="tb-setting-input" onchange="TB.updateTypographyElement(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + element + '\',\'text_transform\',this.value)">';
            html += '<option value=""' + (!typography.text_transform ? ' selected' : '') + '>None</option>';
            html += '<option value="uppercase"' + (typography.text_transform === 'uppercase' ? ' selected' : '') + '>UPPERCASE</option>';
            html += '<option value="lowercase"' + (typography.text_transform === 'lowercase' ? ' selected' : '') + '>lowercase</option>';
            html += '<option value="capitalize"' + (typography.text_transform === 'capitalize' ? ' selected' : '') + '>Capitalize</option>';
            html += '</select></div>';

            // Text Color with Theme Colors support (not responsive)
            html += this.renderColorPicker('Text Color', typography.color, 'TB.updateTypographyElement(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'' + element + '\',\'color\',VALUE)', '#333333');

            html += '</div></div>'; // Close tb-typography-content and tb-typography-section

            return html;
        },

        // Toggle typography section visibility
        toggleTypographySection(headerEl) {
            const section = headerEl.closest('.tb-typography-section');
            const content = section.querySelector('.tb-typography-content');
            const toggle = section.querySelector('.tb-typography-toggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '▼';
            } else {
                content.style.display = 'none';
                toggle.textContent = '▶';
            }
        },

        // Slider slide management functions
        addSliderSlide(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'slider') return;
            if (!mod.content) mod.content = {};
            if (!mod.content.slides) mod.content.slides = [];
            const newSlideNum = mod.content.slides.length + 1;
            mod.content.slides.push({ title: 'Slide ' + newSlideNum, text: 'Description for slide ' + newSlideNum, image: '', button_text: 'Learn More', button_url: '#' });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Added slide ' + newSlideNum, 'success');
        },

        removeSliderSlide(sIdx, rIdx, cIdx, mIdx, slideIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'slider' || !mod.content?.slides) return;
            if (mod.content.slides.length <= 1) {
                this.showToast('Cannot remove the last slide', 'error');
                return;
            }
            mod.content.slides.splice(slideIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Slide removed', 'success');
        },

        moveSliderSlide(sIdx, rIdx, cIdx, mIdx, slideIdx, direction) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'slider' || !mod.content?.slides) return;
            const newIdx = slideIdx + direction;
            if (newIdx < 0 || newIdx >= mod.content.slides.length) return;
            const temp = mod.content.slides[slideIdx];
            mod.content.slides[slideIdx] = mod.content.slides[newIdx];
            mod.content.slides[newIdx] = temp;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateSliderSlide(sIdx, rIdx, cIdx, mIdx, slideIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'slider' || !mod.content?.slides?.[slideIdx]) return;
            mod.content.slides[slideIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Video Slider video management functions
        addVideoSliderVideo(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'video_slider') return;
            if (!mod.content) mod.content = {};
            if (!mod.content.videos) mod.content.videos = [];
            const newVideoNum = mod.content.videos.length + 1;
            mod.content.videos.push({ title: 'Video ' + newVideoNum, url: '', thumbnail: '', description: '' });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Added video ' + newVideoNum, 'success');
        },

        removeVideoSliderVideo(sIdx, rIdx, cIdx, mIdx, videoIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'video_slider' || !mod.content?.videos) return;
            if (mod.content.videos.length <= 1) {
                this.showToast('Cannot remove the last video', 'error');
                return;
            }
            mod.content.videos.splice(videoIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Video removed', 'success');
        },

        moveVideoSliderVideo(sIdx, rIdx, cIdx, mIdx, videoIdx, direction) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'video_slider' || !mod.content?.videos) return;
            const newIdx = videoIdx + direction;
            if (newIdx < 0 || newIdx >= mod.content.videos.length) return;
            const temp = mod.content.videos[videoIdx];
            mod.content.videos[videoIdx] = mod.content.videos[newIdx];
            mod.content.videos[newIdx] = temp;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateVideoSliderVideo(sIdx, rIdx, cIdx, mIdx, videoIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'video_slider' || !mod.content?.videos?.[videoIdx]) return;
            mod.content.videos[videoIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Video URL helper functions
        getVideoThumbnail(url) {
            if (!url) return '';
            // YouTube patterns
            const ytMatch = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            if (ytMatch) return 'https://img.youtube.com/vi/' + ytMatch[1] + '/maxresdefault.jpg';
            // Vimeo patterns - would need API call for actual thumbnail, return placeholder
            const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
            if (vimeoMatch) return ''; // Vimeo requires API for thumbnails
            // For MP4/direct video URLs, no auto-thumbnail available
            return '';
        },

        getVideoEmbedUrl(url) {
            if (!url) return '';
            // YouTube
            const ytMatch = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            if (ytMatch) return 'https://www.youtube.com/embed/' + ytMatch[1];
            // Vimeo
            const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
            if (vimeoMatch) return 'https://player.vimeo.com/video/' + vimeoMatch[1];
            // Direct video URL (MP4, etc.) - return as is
            if (url.match(/\.(mp4|webm|ogg)(\?.*)?$/i)) return url;
            return url;
        },

        // Menu item management functions
        addMenuItem(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'menu') return;
            if (!mod.content) mod.content = {};
            if (!mod.content.items) mod.content.items = [];
            const newItemNum = mod.content.items.length + 1;
            mod.content.items.push({ label: 'Link ' + newItemNum, url: '#' });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Added menu item ' + newItemNum, 'success');
        },

        removeMenuItem(sIdx, rIdx, cIdx, mIdx, itemIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'menu' || !mod.content?.items) return;
            if (mod.content.items.length <= 1) {
                this.showToast('Cannot remove the last menu item', 'error');
                return;
            }
            mod.content.items.splice(itemIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Menu item removed', 'success');
        },

        moveMenuItem(sIdx, rIdx, cIdx, mIdx, itemIdx, direction) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'menu' || !mod.content?.items) return;
            const newIdx = itemIdx + direction;
            if (newIdx < 0 || newIdx >= mod.content.items.length) return;
            const temp = mod.content.items[itemIdx];
            mod.content.items[itemIdx] = mod.content.items[newIdx];
            mod.content.items[newIdx] = temp;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateMenuItem(sIdx, rIdx, cIdx, mIdx, itemIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'menu' || !mod.content?.items?.[itemIdx]) return;
            mod.content.items[itemIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },


        // Fullwidth Menu Item Functions
        addFullwidthMenuItem(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'fullwidth_menu') return;
            if (!mod.content) mod.content = {};
            if (!mod.content.items) mod.content.items = [];
            const newItemNum = mod.content.items.length + 1;
            mod.content.items.push({ label: 'Link ' + newItemNum, url: '#' });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Added menu item ' + newItemNum, 'success');
        },

        removeFullwidthMenuItem(sIdx, rIdx, cIdx, mIdx, itemIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'fullwidth_menu' || !mod.content?.items) return;
            if (mod.content.items.length <= 1) {
                this.showToast('Cannot remove the last menu item', 'error');
                return;
            }
            mod.content.items.splice(itemIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Menu item removed', 'success');
        },

        moveFullwidthMenuItem(sIdx, rIdx, cIdx, mIdx, itemIdx, direction) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'fullwidth_menu' || !mod.content?.items) return;
            const newIdx = itemIdx + direction;
            if (newIdx < 0 || newIdx >= mod.content.items.length) return;
            const temp = mod.content.items[itemIdx];
            mod.content.items[itemIdx] = mod.content.items[newIdx];
            mod.content.items[newIdx] = temp;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateFullwidthMenuItem(sIdx, rIdx, cIdx, mIdx, itemIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'fullwidth_menu' || !mod.content?.items?.[itemIdx]) return;
            mod.content.items[itemIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Fullwidth Slider Slide Functions
        addFullwidthSlide(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'fullwidth_slider') return;
            if (!mod.content) mod.content = {};
            if (!mod.content.slides) mod.content.slides = [];
            const newNum = mod.content.slides.length + 1;
            mod.content.slides.push({ title: 'Slide ' + newNum, text: 'Description', image: '', button_text: 'Learn More', button_url: '#' });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Added slide ' + newNum, 'success');
        },

        removeFullwidthSlide(sIdx, rIdx, cIdx, mIdx, slideIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'fullwidth_slider' || !mod.content?.slides) return;
            if (mod.content.slides.length <= 1) {
                this.showToast('Cannot remove the last slide', 'error');
                return;
            }
            mod.content.slides.splice(slideIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Slide removed', 'success');
        },

        moveFullwidthSlide(sIdx, rIdx, cIdx, mIdx, slideIdx, direction) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'fullwidth_slider' || !mod.content?.slides) return;
            const newIdx = slideIdx + direction;
            if (newIdx < 0 || newIdx >= mod.content.slides.length) return;
            const temp = mod.content.slides[slideIdx];
            mod.content.slides[slideIdx] = mod.content.slides[newIdx];
            mod.content.slides[newIdx] = temp;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateFullwidthSlide(sIdx, rIdx, cIdx, mIdx, slideIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'fullwidth_slider' || !mod.content?.slides?.[slideIdx]) return;
            mod.content.slides[slideIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Fullwidth Portfolio Item Functions
        addFullwidthPortfolioItem(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'fullwidth_portfolio') return;
            if (!mod.content) mod.content = {};
            if (!mod.content.items) mod.content.items = [];
            const newNum = mod.content.items.length + 1;
            mod.content.items.push({ title: 'Project ' + newNum, image: '', category: 'Web', link: '#' });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Added portfolio item ' + newNum, 'success');
        },

        removeFullwidthPortfolioItem(sIdx, rIdx, cIdx, mIdx, itemIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'fullwidth_portfolio' || !mod.content?.items) return;
            mod.content.items.splice(itemIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Portfolio item removed', 'success');
        },

        moveFullwidthPortfolioItem(sIdx, rIdx, cIdx, mIdx, itemIdx, direction) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'fullwidth_portfolio' || !mod.content?.items) return;
            const newIdx = itemIdx + direction;
            if (newIdx < 0 || newIdx >= mod.content.items.length) return;
            const temp = mod.content.items[itemIdx];
            mod.content.items[itemIdx] = mod.content.items[newIdx];
            mod.content.items[newIdx] = temp;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateFullwidthPortfolioItem(sIdx, rIdx, cIdx, mIdx, itemIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'fullwidth_portfolio' || !mod.content?.items?.[itemIdx]) return;
            mod.content.items[itemIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // Social Networks management functions
        addSocialNetwork(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'social') return;
            if (!mod.content) mod.content = {};
            if (!mod.content.networks) mod.content.networks = [];
            mod.content.networks.push({ network: 'facebook', url: '', enabled: true });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Network added', 'success');
        },

        removeSocialNetwork(sIdx, rIdx, cIdx, mIdx, netIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'social' || !mod.content?.networks) return;
            mod.content.networks.splice(netIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Network removed', 'success');
        },

        moveSocialNetwork(sIdx, rIdx, cIdx, mIdx, netIdx, direction) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'social' || !mod.content?.networks) return;
            const newIdx = netIdx + direction;
            if (newIdx < 0 || newIdx >= mod.content.networks.length) return;
            const temp = mod.content.networks[netIdx];
            mod.content.networks[netIdx] = mod.content.networks[newIdx];
            mod.content.networks[newIdx] = temp;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateSocialNetwork(sIdx, rIdx, cIdx, mIdx, netIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'social' || !mod.content?.networks?.[netIdx]) return;
            mod.content.networks[netIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },


        deleteModule(sIdx, rIdx, cIdx, mIdx) { this.removeModule(sIdx, rIdx, cIdx, mIdx); },

        saveToHistory() {
            this.history = this.history.slice(0, this.historyIndex + 1);
            this.history.push(JSON.stringify(this.content));
            if (this.history.length > 50) this.history.shift();
            this.historyIndex = this.history.length - 1;
            this.updateHistoryButtons();
        },

        undo() {
            if (this.historyIndex > 0) {
                this.historyIndex--;
                this.content = JSON.parse(this.history[this.historyIndex]);
                this.selectedElement = null;
                this.renderCanvas();
                this.renderSettings();
                this.updateHistoryButtons();
            }
        },

        redo() {
            if (this.historyIndex < this.history.length - 1) {
                this.historyIndex++;
                this.content = JSON.parse(this.history[this.historyIndex]);
                this.selectedElement = null;
                this.renderCanvas();
                this.renderSettings();
                this.updateHistoryButtons();
            }
        },

        updateHistoryButtons() {
            document.getElementById('btn-undo').disabled = this.historyIndex <= 0;
            document.getElementById('btn-redo').disabled = this.historyIndex >= this.history.length - 1;
        },

        async save() {
            const loading = document.getElementById('tb-loading');
            loading.classList.remove('hidden');
            try {
                const response = await fetch('/admin/theme-builder/save', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': this.csrfToken },
                    body: JSON.stringify({ page_id: this.pageId, title: document.getElementById('page-title').value, slug: document.getElementById('page-slug').value, status: document.getElementById('page-status').value, content: this.content, csrf_token: this.csrfToken, _token: this.csrfToken })
                });
                // Check for redirect (auth failure)
                if (response.redirected || response.status === 302) {
                    throw new Error('Session expired. Please refresh the page.');
                }
                // Check for empty response
                const text = await response.text();
                if (!text || text.length === 0) {
                    throw new Error('Empty response from server');
                }
                let result;
                try {
                    result = JSON.parse(text);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError, 'Response:', text.substring(0, 500));
                    throw new Error('Invalid JSON response: ' + text.substring(0, 100));
                }
                if (result.success) {
                    if (result.page_id && this.pageId === 0) {
                        this.pageId = result.page_id;
                        document.getElementById('page-id').value = result.page_id;
                        history.replaceState(null, '', '/admin/theme-builder/' + result.page_id + '/edit');
                    }
                    this.showToast('Page saved successfully', 'success');
                } else {
                    this.showToast(result.error || 'Save failed', 'error');
                }
            } catch (err) {
                this.showToast('Network error: ' + err.message, 'error');
            } finally {
                loading.classList.add('hidden');
            }
        },

        async preview() {
            const loading = document.getElementById('tb-loading');
            loading.classList.remove('hidden');
            try {
                // Save content to session for unsaved changes preview
                const response = await fetch('/admin/theme-builder/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': this.csrfToken },
                    body: JSON.stringify({ content: this.content, page_id: this.pageId, csrf_token: this.csrfToken })
                });
                const result = await response.json();
                
                if (result.success) {
                    // Open central preview system with session data
                    const previewUrl = '/preview/tb/' + this.pageId + '?session=1';
                    const previewWindow = window.open(previewUrl, '_blank');
                    if (!previewWindow) {
                        this.showToast('Popup blocked! Please allow popups for this site.', 'error');
                    }
                } else {
                    this.showToast(result.error || 'Preview failed', 'error');
                }
            } catch (err) {
                this.showToast('Preview error: ' + err.message, 'error');
            } finally {
                loading.classList.add('hidden');
            }
        },

        escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        },

        /**
         * Render color picker with Theme Colors support
         * @param {string} label - Label for the color picker
         * @param {string} currentValue - Current color value (hex or var(--...))
         * @param {string} updateCallback - JS code to call on change (use VALUE placeholder)
         * @param {string} defaultValue - Default color value
         * @returns {string} HTML for the color picker
         */
        renderColorPicker(label, currentValue, updateCallback, defaultValue = '#1e1e2e') {
            const value = currentValue || defaultValue;
            const isThemeColor = value.startsWith('var(--');
            
            // Find theme color key if it's a CSS variable
            let selectedThemeColor = '';
            let displayHex = defaultValue;
            
            if (isThemeColor) {
                // Extract color name from var(--color-name)
                const match = value.match(/var\(--color-([^)]+)\)/);
                if (match) {
                    selectedThemeColor = match[1];
                    // Get hex value for preview
                    if (this.themeColors[selectedThemeColor]) {
                        displayHex = this.themeColors[selectedThemeColor].value;
                    }
                }
            } else {
                displayHex = value;
            }
            
            // Build theme colors dropdown options
            let themeOptions = '<option value="">Custom Color</option>';
            for (const [key, colorData] of Object.entries(this.themeColors)) {
                const selected = selectedThemeColor === key ? ' selected' : '';
                themeOptions += '<option value="' + colorData.var + '" data-hex="' + colorData.value + '"' + selected + '>' + colorData.label + ' (' + colorData.value + ')</option>';
            }
            
            const pickerId = 'cp_' + Math.random().toString(36).substr(2, 9);
            
            let html = '<div class="tb-setting-group">';
            html += '<div class="tb-setting-label">' + label + '</div>';
            html += '<div class="tb-color-picker-wrapper" style="display:flex;flex-direction:column;gap:6px">';
            
            // Theme Colors dropdown
            html += '<select class="tb-setting-input tb-theme-color-select" id="sel_' + pickerId + '" style="padding:6px 8px" onchange="TB.handleThemeColorSelect(this, \'' + pickerId + '\', function(v){' + updateCallback.replace(/VALUE/g, 'v') + '})">';
            html += themeOptions;
            html += '</select>';
            
            // Custom color row (hex input + color picker)
            html += '<div class="tb-custom-color-row" id="custom_' + pickerId + '" style="display:' + (isThemeColor ? 'none' : 'flex') + ';gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + displayHex + '" id="hex_' + pickerId + '" onchange="TB.handleCustomColorChange(this, \'' + pickerId + '\', function(v){' + updateCallback.replace(/VALUE/g, 'v') + '})">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + displayHex + '" id="txt_' + pickerId + '" placeholder="' + defaultValue + '" onchange="TB.handleCustomColorChange(this, \'' + pickerId + '\', function(v){' + updateCallback.replace(/VALUE/g, 'v') + '})">';
            html += '</div>';
            
            html += '</div></div>';
            return html;
        },

        /**
         * Handle theme color selection from dropdown
         */
        handleThemeColorSelect(select, pickerId, callback) {
            const value = select.value;
            const customRow = document.getElementById('custom_' + pickerId);
            
            if (value === '') {
                // Show custom color inputs
                customRow.style.display = 'flex';
                // Use current hex value
                const hexInput = document.getElementById('hex_' + pickerId);
                callback(hexInput.value);
            } else {
                // Hide custom color inputs
                customRow.style.display = 'none';
                // Get hex from data attribute for preview, but save var() for content
                const option = select.options[select.selectedIndex];
                const hex = option.dataset.hex;
                document.getElementById('hex_' + pickerId).value = hex;
                document.getElementById('txt_' + pickerId).value = hex;
                callback(value);
            }
            this.renderCanvas();
        },

        /**
         * Handle custom color input change
         */
        handleCustomColorChange(input, pickerId, callback) {
            const value = input.value;
            // Sync both inputs
            document.getElementById('hex_' + pickerId).value = value;
            document.getElementById('txt_' + pickerId).value = value;
            // Reset dropdown to "Custom Color"
            document.getElementById('sel_' + pickerId).value = '';
            callback(value);
            this.renderCanvas();
        },

        // Download external image to server
        downloadToServer(url, sIdx, rIdx, cIdx, mIdx, field, btn) {
            if (!url || !url.startsWith('http')) {
                alert('No external URL to download');
                return;
            }
            
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳';
            btn.disabled = true;
            
            fetch('/admin/api/tb-download-image.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('input[name="csrf_token"]')?.value || document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify({ url: url })
            })
            .then(r => r.json())
            .then(data => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                if (data.success && data.local_url) {
                    TB.updateModuleContent(sIdx, rIdx, cIdx, mIdx, field, data.local_url);
                    const input = btn.parentElement.querySelector('input');
                    if (input) input.value = data.local_url;
                    btn.style.display = 'none';
                    alert('✅ Image saved to server!');
                } else {
                    alert('❌ Error: ' + (data.error || 'Failed to download'));
                }
            })
            .catch(err => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('❌ Network error: ' + err.message);
            });
        },

        getBlurbIconEmoji(iconName) {
            const iconMap = {
                star: '⭐', heart: '❤️', check: '✓', arrow: '→', info: '💡',
                gear: '⚙️', user: '👤', users: '👥', home: '🏠', mail: '✉️',
                phone: '📞', globe: '🌐', lock: '🔒', unlock: '🔓', search: '🔍',
                cart: '🛒', tag: '🏷️', calendar: '📅', clock: '🕐', pin: '📍',
                flag: '🚩', bookmark: '🔖', bell: '🔔', camera: '📷', video: '🎬',
                music: '🎵', file: '📄', folder: '📁', download: '⬇️', upload: '⬆️',
                cloud: '☁️', sun: '☀️', moon: '🌙', bolt: '⚡', fire: '🔥',
                leaf: '🍃', coffee: '☕', gift: '🎁', trophy: '🏆', medal: '🏅',
                rocket: '🚀', target: '🎯', chart: '📊', bulb: '💡', wrench: '🔧',
                shield: '🛡️', key: '🔑', link: '🔗', quote: '💬', code: '💻'
            };
            return iconMap[iconName] || '⭐';
        },

        showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'tb-toast ' + type;
            const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';
            toast.innerHTML = '<span>' + icon + '</span><span>' + this.escapeHtml(message) + '</span>';
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(20px)'; setTimeout(() => toast.remove(), 300); }, 3000);
        },

        // ═══════════════════════════════════════════════════════════
        // AI CONTENT GENERATION
        // ═══════════════════════════════════════════════════════════
        async generateAI(type, context) {
            const pageTitle = document.querySelector('.tb-page-title')?.value || '';
            try {
                const response = await fetch('/admin/theme-builder/ai/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        csrf_token: this.csrfToken,
                        type: type,
                        context: context,
                        page_title: pageTitle
                    })
                });
                const result = await response.json();
                if (result.success) {
                    return result.content;
                } else {
                    this.showToast(result.error || 'AI generation failed', 'error');
                    return null;
                }
            } catch (err) {
                this.showToast('Network error: ' + err.message, 'error');
                return null;
            }
        },

        async handleAIGenerate(type, field, sIdx, rIdx, cIdx, mIdx, button) {
            const defaultContexts = {
                heading: 'a compelling website section',
                text: 'engaging website content',
                button: 'a call-to-action button',
                cta_title: 'getting users to take action',
                cta_subtitle: 'supporting the main call-to-action',
                cta_button: 'encouraging sign-ups or purchases',
                testimonial: 'customer satisfaction with our service',
                pricing_features: 'features included in this plan',
                quote: 'inspiration and motivation'
            };
            const context = prompt('What should this ' + type.replace('_', ' ') + ' be about?', defaultContexts[type] || 'your topic');
            if (!context) return;

            // Set loading state
            button.disabled = true;
            button.classList.add('loading');
            const originalText = button.innerHTML;
            button.innerHTML = '✨ Generating...';

            const content = await this.generateAI(type, context);

            // Reset button state
            button.disabled = false;
            button.classList.remove('loading');
            button.innerHTML = originalText;

            if (content) {
                if (type === 'pricing_features' && Array.isArray(content)) {
                    // Handle array content for pricing features
                    const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
                    if (mod) {
                        mod.content.features = content;
                        this.saveToHistory();
                        this.renderCanvas();
                        this.selectModule(sIdx, rIdx, cIdx, mIdx);
                    }
                } else {
                    this.updateModuleContent(sIdx, rIdx, cIdx, mIdx, field, content);
                }
                this.showToast('AI content generated!', 'success');
            }
        },

        // ═══════════════════════════════════════════════════════════
        // LIST ITEM MANAGEMENT
        // ═══════════════════════════════════════════════════════════
        addListItem(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.content.items) mod.content.items = [];
            mod.content.items.push('New Item');
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        removeListItem(sIdx, rIdx, cIdx, mIdx, itemIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.items) return;
            mod.content.items.splice(itemIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        moveListItem(sIdx, rIdx, cIdx, mIdx, itemIdx, dir) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.items) return;
            const newIdx = itemIdx + dir;
            if (newIdx < 0 || newIdx >= mod.content.items.length) return;
            [mod.content.items[itemIdx], mod.content.items[newIdx]] = [mod.content.items[newIdx], mod.content.items[itemIdx]];
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateListItem(sIdx, rIdx, cIdx, mIdx, itemIdx, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.items) return;
            mod.content.items[itemIdx] = value;
            this.saveToHistory();
            this.renderCanvas();
        },

        // ═══════════════════════════════════════════════════════════
        // ACCORDION ITEM MANAGEMENT
        // ═══════════════════════════════════════════════════════════
        addAccordionItem(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.content.items) mod.content.items = [];
            mod.content.items.push({ title: 'New Item', content: '' });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        removeAccordionItem(sIdx, rIdx, cIdx, mIdx, itemIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.items || mod.content.items.length <= 1) {
                this.showToast('Accordion must have at least one item', 'error');
                return;
            }
            mod.content.items.splice(itemIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        moveAccordionItem(sIdx, rIdx, cIdx, mIdx, itemIdx, dir) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.items) return;
            const newIdx = itemIdx + dir;
            if (newIdx < 0 || newIdx >= mod.content.items.length) return;
            [mod.content.items[itemIdx], mod.content.items[newIdx]] = [mod.content.items[newIdx], mod.content.items[itemIdx]];
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateAccordionItem(sIdx, rIdx, cIdx, mIdx, itemIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.items || !mod.content.items[itemIdx]) return;
            mod.content.items[itemIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
        },

        // ═══════════════════════════════════════════════════════════
        // BAR COUNTERS MANAGEMENT
        // ═══════════════════════════════════════════════════════════
        addBar(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.content.bars) mod.content.bars = [];
            // Generate a random color from a nice palette
            const colors = ['#0073e6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4', '#ec4899', '#84cc16'];
            const randomColor = colors[mod.content.bars.length % colors.length];
            mod.content.bars.push({ label: 'New Skill', percent: 75, color: randomColor });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        removeBar(sIdx, rIdx, cIdx, mIdx, barIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.bars || mod.content.bars.length <= 1) {
                this.showToast('Bar Counters must have at least one bar', 'error');
                return;
            }
            mod.content.bars.splice(barIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        moveBar(sIdx, rIdx, cIdx, mIdx, barIdx, dir) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.bars) return;
            const newIdx = barIdx + dir;
            if (newIdx < 0 || newIdx >= mod.content.bars.length) return;
            [mod.content.bars[barIdx], mod.content.bars[newIdx]] = [mod.content.bars[newIdx], mod.content.bars[barIdx]];
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateBar(sIdx, rIdx, cIdx, mIdx, barIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.bars || !mod.content.bars[barIdx]) return;
            mod.content.bars[barIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
        },

        // ═══════════════════════════════════════════════════════════
        // TAB MANAGEMENT
        // ═══════════════════════════════════════════════════════════
        addTab(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.content.tabs) mod.content.tabs = [];
            mod.content.tabs.push({ title: 'New Tab', content: '' });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        removeTab(sIdx, rIdx, cIdx, mIdx, tabIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.tabs || mod.content.tabs.length <= 1) {
                this.showToast('Tabs must have at least one tab', 'error');
                return;
            }
            mod.content.tabs.splice(tabIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        moveTab(sIdx, rIdx, cIdx, mIdx, tabIdx, dir) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.tabs) return;
            const newIdx = tabIdx + dir;
            if (newIdx < 0 || newIdx >= mod.content.tabs.length) return;
            [mod.content.tabs[tabIdx], mod.content.tabs[newIdx]] = [mod.content.tabs[newIdx], mod.content.tabs[tabIdx]];
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateTab(sIdx, rIdx, cIdx, mIdx, tabIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.tabs || !mod.content.tabs[tabIdx]) return;
            mod.content.tabs[tabIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
        },

        // ═══════════════════════════════════════════════════════════
        // GALLERY IMAGE MANAGEMENT
        // ═══════════════════════════════════════════════════════════
        addGalleryImage(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.content.images) mod.content.images = [];
            mod.content.images.push({ url: '', src: '', alt: '', caption: '' });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        addGalleryImageWithUrl(sIdx, rIdx, cIdx, mIdx, url) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.content.images) mod.content.images = [];
            mod.content.images.push({ url: url, src: url, alt: '', caption: '' });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        removeGalleryImage(sIdx, rIdx, cIdx, mIdx, imgIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.images) return;
            mod.content.images.splice(imgIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        moveGalleryImage(sIdx, rIdx, cIdx, mIdx, imgIdx, dir) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.images) return;
            const newIdx = imgIdx + dir;
            if (newIdx < 0 || newIdx >= mod.content.images.length) return;
            [mod.content.images[imgIdx], mod.content.images[newIdx]] = [mod.content.images[newIdx], mod.content.images[imgIdx]];
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updateGalleryImage(sIdx, rIdx, cIdx, mIdx, imgIdx, key, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.images || !mod.content.images[imgIdx]) return;
            mod.content.images[imgIdx][key] = value;
            this.saveToHistory();
            this.renderCanvas();
        },

        // ═══════════════════════════════════════════════════════════
        // PRICING FEATURE MANAGEMENT
        // ═══════════════════════════════════════════════════════════
        addPricingFeature(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod) return;
            if (!mod.content.features) mod.content.features = [];
            mod.content.features.push('New Feature');
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        removePricingFeature(sIdx, rIdx, cIdx, mIdx, featureIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.features) return;
            mod.content.features.splice(featureIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        movePricingFeature(sIdx, rIdx, cIdx, mIdx, featureIdx, dir) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.features) return;
            const newIdx = featureIdx + dir;
            if (newIdx < 0 || newIdx >= mod.content.features.length) return;
            [mod.content.features[featureIdx], mod.content.features[newIdx]] = [mod.content.features[newIdx], mod.content.features[featureIdx]];
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        updatePricingFeature(sIdx, rIdx, cIdx, mIdx, featureIdx, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.features) return;
            mod.content.features[featureIdx] = value;
            this.saveToHistory();
            this.renderCanvas();
        },

        // ═══════════════════════════════════════════════════════════
        // PORTFOLIO ITEM MANAGEMENT
        // ═══════════════════════════════════════════════════════════
        addPortfolioItem(sIdx, rIdx, cIdx, mIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || mod.type !== 'portfolio') return;
            if (!mod.content) mod.content = {};
            if (!mod.content.items) mod.content.items = [];
            const newItemNum = mod.content.items.length + 1;
            mod.content.items.push({
                title: 'Project ' + newItemNum,
                category: 'Category',
                image: '',
                link: '#',
                description: 'Project description...'
            });
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Added portfolio item ' + newItemNum, 'success');
        },

        removePortfolioItem(sIdx, rIdx, cIdx, mIdx, itemIdx) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.items || mod.content.items.length <= 1) {
                this.showToast('Portfolio must have at least one item', 'error');
                return;
            }
            mod.content.items.splice(itemIdx, 1);
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
            this.showToast('Removed portfolio item', 'success');
        },

        updatePortfolioItem(sIdx, rIdx, cIdx, mIdx, itemIdx, property, value) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.items || !mod.content.items[itemIdx]) return;
            mod.content.items[itemIdx][property] = value;
            this.saveToHistory();
            this.renderCanvas();
        },

        movePortfolioItem(sIdx, rIdx, cIdx, mIdx, itemIdx, direction) {
            const mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
            if (!mod || !mod.content.items) return;
            const newIdx = itemIdx + direction;
            if (newIdx < 0 || newIdx >= mod.content.items.length) return;
            [mod.content.items[itemIdx], mod.content.items[newIdx]] = [mod.content.items[newIdx], mod.content.items[itemIdx]];
            this.saveToHistory();
            this.renderCanvas();
            this.selectModule(sIdx, rIdx, cIdx, mIdx);
        },

        // ═══════════════════════════════════════════════════════════
                // ═══════════════════════════════════════════════════════════
        // CENTRALIZED ICON PICKER - Inline SVG (no CDN required)
        // ═══════════════════════════════════════════════════════════
        
        iconPickerCallback: null,
        iconPickerIndex: null,
        currentIconStyle: 'fontawesome',
        fontawesomeIcons: [],  // Will be loaded
        currentIconCategory: 'all',
        
        // Lucide Icons (line style, modern) - inline SVG paths
        lucideIcons: {
            arrows: [
                { name: 'arrow-up', svg: '<path d="M12 19V5M5 12l7-7 7 7"/>' },
                { name: 'arrow-down', svg: '<path d="M12 5v14M5 12l7 7 7-7"/>' },
                { name: 'arrow-left', svg: '<path d="M19 12H5M12 5l-7 7 7 7"/>' },
                { name: 'arrow-right', svg: '<path d="M5 12h14M12 5l7 7-7 7"/>' },
                { name: 'chevron-up', svg: '<path d="M18 15l-6-6-6 6"/>' },
                { name: 'chevron-down', svg: '<path d="M6 9l6 6 6-6"/>' },
                { name: 'chevron-left', svg: '<path d="M15 18l-6-6 6-6"/>' },
                { name: 'chevron-right', svg: '<path d="M9 18l6-6-6-6"/>' },
                { name: 'chevrons-up', svg: '<path d="M17 11l-5-5-5 5M17 18l-5-5-5 5"/>' },
                { name: 'chevrons-down', svg: '<path d="M7 13l5 5 5-5M7 6l5 5 5-5"/>' },
                { name: 'move', svg: '<path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/>' }
            ],
            general: [
                { name: 'home', svg: '<path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><path d="M9 22V12h6v10"/>' },
                { name: 'settings', svg: '<circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>' },
                { name: 'search', svg: '<circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>' },
                { name: 'menu', svg: '<path d="M4 12h16M4 6h16M4 18h16"/>' },
                { name: 'x', svg: '<path d="M18 6L6 18M6 6l12 12"/>' },
                { name: 'check', svg: '<path d="M20 6L9 17l-5-5"/>' },
                { name: 'plus', svg: '<path d="M12 5v14M5 12h14"/>' },
                { name: 'minus', svg: '<path d="M5 12h14"/>' },
                { name: 'more-horizontal', svg: '<circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/>' },
                { name: 'more-vertical', svg: '<circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>' },
                { name: 'filter', svg: '<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>' },
                { name: 'refresh-cw', svg: '<path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>' }
            ],
            business: [
                { name: 'briefcase', svg: '<rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v3"/>' },
                { name: 'building', svg: '<rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4M8 6h.01M16 6h.01M12 6h.01M12 10h.01M12 14h.01M16 10h.01M16 14h.01M8 10h.01M8 14h.01"/>' },
                { name: 'chart-bar', svg: '<path d="M12 20V10M18 20V4M6 20v-4"/>' },
                { name: 'trending-up', svg: '<path d="M23 6l-9.5 9.5-5-5L1 18"/><path d="M17 6h6v6"/>' },
                { name: 'trending-down', svg: '<path d="M23 18l-9.5-9.5-5 5L1 6"/><path d="M17 18h6v-6"/>' },
                { name: 'pie-chart', svg: '<path d="M21.21 15.89A10 10 0 118 2.83"/><path d="M22 12A10 10 0 0012 2v10z"/>' },
                { name: 'dollar-sign', svg: '<path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>' },
                { name: 'credit-card', svg: '<rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/>' },
                { name: 'wallet', svg: '<path d="M20 12V8H6a2 2 0 01-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12a2 2 0 002 2h14v-4"/><path d="M18 12a2 2 0 00-2 2c0 1.1.9 2 2 2h4v-4h-4z"/>' },
                { name: 'receipt', svg: '<path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1z"/><path d="M16 8h-6a2 2 0 100 4h4a2 2 0 110 4H8"/><path d="M12 17V7"/>' },
                { name: 'target', svg: '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>' }
            ],
            communication: [
                { name: 'mail', svg: '<rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/>' },
                { name: 'message-circle', svg: '<path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/>' },
                { name: 'message-square', svg: '<path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>' },
                { name: 'phone', svg: '<path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/>' },
                { name: 'video', svg: '<polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/>' },
                { name: 'bell', svg: '<path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/>' },
                { name: 'at-sign', svg: '<circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 006 0v-1a10 10 0 10-3.92 7.94"/>' },
                { name: 'send', svg: '<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>' },
                { name: 'share', svg: '<circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"/>' }
            ],
            tech: [
                { name: 'monitor', svg: '<rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/>' },
                { name: 'smartphone', svg: '<rect x="5" y="2" width="14" height="20" rx="2"/><path d="M12 18h.01"/>' },
                { name: 'tablet', svg: '<rect x="4" y="2" width="16" height="20" rx="2"/><path d="M12 18h.01"/>' },
                { name: 'laptop', svg: '<path d="M20 16V7a2 2 0 00-2-2H6a2 2 0 00-2 2v9m16 0H4m16 0l1.28 2.55a1 1 0 01-.9 1.45H3.62a1 1 0 01-.9-1.45L4 16"/>' },
                { name: 'server', svg: '<rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><path d="M6 6h.01M6 18h.01"/>' },
                { name: 'database', svg: '<ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>' },
                { name: 'cloud', svg: '<path d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 000-10z"/>' },
                { name: 'cpu', svg: '<rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M9 1v3M15 1v3M9 20v3M15 20v3M20 9h3M20 14h3M1 9h3M1 14h3"/>' },
                { name: 'wifi', svg: '<path d="M5 12.55a11 11 0 0114.08 0M1.42 9a16 16 0 0121.16 0M8.53 16.11a6 6 0 016.95 0M12 20h.01"/>' },
                { name: 'code', svg: '<path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/>' },
                { name: 'terminal', svg: '<path d="M4 17l6-6-6-6M12 19h8"/>' }
            ],
            media: [
                { name: 'image', svg: '<rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/>' },
                { name: 'camera', svg: '<path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/>' },
                { name: 'film', svg: '<rect x="2" y="2" width="20" height="20" rx="2.18"/><path d="M7 2v20M17 2v20M2 12h20M2 7h5M2 17h5M17 17h5M17 7h5"/>' },
                { name: 'music', svg: '<path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>' },
                { name: 'headphones', svg: '<path d="M3 18v-6a9 9 0 0118 0v6"/><path d="M21 19a2 2 0 01-2 2h-1a2 2 0 01-2-2v-3a2 2 0 012-2h3zM3 19a2 2 0 002 2h1a2 2 0 002-2v-3a2 2 0 00-2-2H3z"/>' },
                { name: 'mic', svg: '<path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8"/>' },
                { name: 'play', svg: '<polygon points="5 3 19 12 5 21 5 3"/>' },
                { name: 'pause', svg: '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>' },
                { name: 'volume-2', svg: '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07"/>' }
            ],
            security: [
                { name: 'lock', svg: '<rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/>' },
                { name: 'unlock', svg: '<rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 019.9-1"/>' },
                { name: 'shield', svg: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>' },
                { name: 'shield-check', svg: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/>' },
                { name: 'key', svg: '<path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 11-7.778 7.778 5.5 5.5 0 017.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>' },
                { name: 'eye', svg: '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>' },
                { name: 'eye-off', svg: '<path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24M1 1l22 22"/>' }
            ],
            files: [
                { name: 'file', svg: '<path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>' },
                { name: 'folder', svg: '<path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/>' },
                { name: 'folder-open', svg: '<path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2v1"/><path d="M5 10v10.5a.5.5 0 00.5.5H19l2.71-8.14a1 1 0 00-.96-1.36H5z"/>' },
                { name: 'download', svg: '<path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>' },
                { name: 'upload', svg: '<path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>' },
                { name: 'clipboard', svg: '<path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/>' },
                { name: 'archive', svg: '<path d="M21 8v13H3V8M23 3H1v5h22zM10 12h4"/>' },
                { name: 'trash', svg: '<path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>' }
            ],
            social: [
                { name: 'users', svg: '<path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>' },
                { name: 'user', svg: '<path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>' },
                { name: 'user-plus', svg: '<path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6M23 11h-6"/>' },
                { name: 'heart', svg: '<path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>' },
                { name: 'thumbs-up', svg: '<path d="M14 9V5a3 3 0 00-3-3l-4 9v11h11.28a2 2 0 002-1.7l1.38-9a2 2 0 00-2-2.3zM7 22H4a2 2 0 01-2-2v-7a2 2 0 012-2h3"/>' },
                { name: 'thumbs-down', svg: '<path d="M10 15v4a3 3 0 003 3l4-9V2H5.72a2 2 0 00-2 1.7l-1.38 9a2 2 0 002 2.3zm7-13h2.67A2.31 2.31 0 0122 4v7a2.31 2.31 0 01-2.33 2H17"/>' },
                { name: 'star', svg: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>' },
                { name: 'award', svg: '<circle cx="12" cy="8" r="7"/><path d="M8.21 13.89L7 23l5-3 5 3-1.21-9.12"/>' },
                { name: 'gift', svg: '<path d="M20 12v10H4V12M2 7h20v5H2zM12 22V7M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7zM12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z"/>' }
            ],
            misc: [
                { name: 'zap', svg: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>' },
                { name: 'activity', svg: '<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>' },
                { name: 'globe', svg: '<circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/>' },
                { name: 'map-pin', svg: '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/>' },
                { name: 'compass', svg: '<circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>' },
                { name: 'sun', svg: '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>' },
                { name: 'moon', svg: '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>' },
                { name: 'clock', svg: '<circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>' },
                { name: 'calendar', svg: '<rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/>' },
                { name: 'flag', svg: '<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1zM4 22v-7"/>' },
                { name: 'bookmark', svg: '<path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/>' },
                { name: 'tag', svg: '<path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><path d="M7 7h.01"/>' },
                { name: 'layers', svg: '<polygon points="12 2 2 7 12 12 22 7 12 2"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>' },
                { name: 'box', svg: '<path d="M21 8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/>' },
                { name: 'rocket', svg: '<path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 00-2.91-.09z"/><path d="M12 15l-3-3a22 22 0 012-3.95A12.88 12.88 0 0122 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 01-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/>' },
                { name: 'sparkles', svg: '<path d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3z"/><path d="M5 19l.5 1.5L7 21l-1.5.5L5 23l-.5-1.5L3 21l1.5-.5L5 19z"/><path d="M19 13l.5 1.5L21 15l-1.5.5L19 17l-.5-1.5L17 15l1.5-.5L19 13z"/>' }
            ]
        },
        
        // Emoji icons
        emojiIcons: {
            business: ['💼', '📊', '📈', '📉', '💹', '💰', '💵', '💳', '🏦', '🏢', '🏭', '🏗️', '👔', '📋', '📁', '📂'],
            tech: ['💻', '🖥️', '⌨️', '🖱️', '📱', '📲', '☎️', '📞', '🔌', '🔋', '💾', '💿', '📀', '🎮', '🕹️', '🎧'],
            communication: ['✉️', '📧', '📨', '📩', '📤', '📥', '📫', '📬', '💬', '💭', '🗨️', '📢', '📣', '🔔'],
            success: ['⭐', '🌟', '✨', '💫', '🎯', '🏆', '🥇', '🥈', '🥉', '🏅', '🎖️', '👑', '💎', '🔥', '⚡', '💯', '✅'],
            security: ['🔒', '🔓', '🔐', '🔑', '🗝️', '🛡️', '⚔️', '🔰', '🚨', '👮', '🔏', '🔎', '🔍', '👁️'],
            nature: ['🌍', '🌎', '🌏', '🌐', '🗺️', '🌲', '🌳', '🌴', '🌵', '🌾', '🌿', '☘️', '🍀', '🌺', '🌸', '🌷', '🌹'],
            weather: ['☀️', '🌤️', '⛅', '🌥️', '☁️', '🌦️', '🌧️', '⛈️', '🌩️', '❄️', '🌊', '💧', '💦', '🌈', '🌙'],
            people: ['👤', '👥', '👫', '🤝', '👍', '👎', '👏', '🙌', '💪', '✌️', '🤞', '👋', '🖐️', '✋', '👐', '🙏'],
            health: ['❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '💔', '❣️', '💕', '💞', '💓', '💗', '💖', '💝', '🏥', '💊'],
            food: ['🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🍒', '🍑', '🥭', '🍍', '☕', '🍵', '🧃', '🥤'],
            transport: ['🚀', '✈️', '🛫', '🚁', '🛸', '🚂', '🚗', '🚕', '🚙', '🏎️', '🚌', '🚐', '🛴', '🚲', '🛵'],
            tools: ['🔧', '🔨', '⚒️', '🛠️', '⚙️', '🔩', '⛏️', '🪓', '🔪', '🛡️', '🔮', '🧰', '🧲', '🪜', '🧪'],
            art: ['🎨', '🖼️', '🎭', '🎪', '🎬', '🎤', '🎧', '🎼', '🎵', '🎶', '🎹', '🥁', '🎷', '🎺', '🎸', '🎻'],
            shapes: ['⬛', '⬜', '◼️', '◻️', '🔶', '🔷', '🔸', '🔹', '🔺', '🔻', '💠', '🔘', '⭕', '❌', '❓', '❗'],
            arrows: ['⬆️', '↗️', '➡️', '↘️', '⬇️', '↙️', '⬅️', '↖️', '↕️', '↔️', '↩️', '↪️', '🔄', '🔃', '▶️', '◀️']
        },

        // Icon Picker functions
        switchIconStyle(style) {
            this.currentIconStyle = style;
            document.querySelectorAll('.tb-icon-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('iconSearchInput').value = '';
            this.renderIconGrid();
        },
        
        renderIconCategories() {
            const container = document.getElementById('iconCategories');
            let categories = [];
            
            if (this.currentIconStyle === 'lucide') {
                categories = Object.keys(this.lucideIcons);
            } else {
                categories = Object.keys(this.emojiIcons);
            }
            
            container.innerHTML = '<span class="tb-icon-category ' + (this.currentIconCategory === 'all' ? 'active' : '') + '" onclick="TB.filterByCategory(\'all\')">All</span>' +
                categories.map(cat => '<span class="tb-icon-category ' + (this.currentIconCategory === cat ? 'active' : '') + '" onclick="TB.filterByCategory(\'' + cat + '\')">' + cat.charAt(0).toUpperCase() + cat.slice(1) + '</span>').join(' ');
        },
        
        filterByCategory(category) {
            this.currentIconCategory = category;
            document.querySelectorAll('.tb-icon-category').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            this.renderIconGrid();
        },
        
        renderIconGrid(searchQuery = '') {
            const grid = document.getElementById('iconGrid');
            const q = (searchQuery || '').toLowerCase();
            
            if (this.currentIconStyle === 'fontawesome') {
                // Font Awesome icons - simple grid
                const filtered = this.fontawesomeIcons.filter(icon => !q || icon.n.includes(q));
                const limited = filtered.slice(0, 200); // Limit for performance
                grid.innerHTML = limited.map(icon => {
                    const style = icon.s.includes('solid') ? 'solid' : (icon.s.includes('regular') ? 'regular' : 'brands');
                    const faClass = style === 'solid' ? 'fa-solid' : (style === 'regular' ? 'fa-regular' : 'fa-brands');
                    return '<div class="tb-icon-option" onclick="TB.selectIcon(\'fa:' + style + ':' + icon.n + '\')" title="' + icon.n + '">' +
                        '<i class="' + faClass + ' fa-' + icon.n + '"></i>' +
                        '</div>';
                }).join('');
                if (filtered.length > 200) {
                    grid.innerHTML += '<div class="tb-icon-picker-empty">Showing 200 of ' + filtered.length + ' icons. Use search to find more.</div>';
                }
            } else if (this.currentIconStyle === 'lucide') {
                // Lucide icons
                let icons = [];
                Object.values(this.lucideIcons).forEach(cat => {
                    cat.forEach(icon => {
                        if (!q || icon.name.includes(q)) icons.push(icon);
                    });
                });
                grid.innerHTML = icons.map(icon => 
                    '<div class="tb-icon-option" onclick="TB.selectIcon(\'lucide:' + icon.name + '\')" title="' + icon.name + '">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">' + icon.svg + '</svg>' +
                    '</div>'
                ).join('');
            } else {
                // Emoji
                let icons = [];
                Object.values(this.emojiIcons).forEach(cat => cat.forEach(e => icons.push(e)));
                const filtered = icons.filter(e => !q || true); // Emoji can't really be searched by name
                grid.innerHTML = filtered.map(icon => 
                    '<div class="tb-icon-option emoji" onclick="TB.selectIcon(\'' + icon + '\')">' + icon + '</div>'
                ).join('');
            }
            
            if (grid.innerHTML === '') {
                grid.innerHTML = '<div class="tb-icon-picker-empty">No icons found</div>';
            }
        },
        
        openIconPicker(callback) {
            this.iconPickerCallback = callback;
            this.currentIconStyle = 'fontawesome';
            
            const modal = document.getElementById('tb-icon-picker-overlay');
            document.querySelectorAll('.tb-icon-tab').forEach((t, i) => t.classList.toggle('active', i === 0));
            document.getElementById('iconSearchInput').value = '';
            
            this.renderIconGrid();
            modal.classList.add('active');
        },
        
        closeIconPicker() {
            document.getElementById('tb-icon-picker-overlay').classList.remove('active');
            this.iconPickerCallback = null;
        },
        
        selectIcon(iconValue) {
            if (this.iconPickerCallback) {
                this.iconPickerCallback(iconValue);
            }
            this.closeIconPicker();
            this.showToast('Icon selected: ' + iconValue, 'success');
        },
        
        filterIcons(query) {
            this.renderIconGrid(query);
        },
        
        // Helper to render icon from format string (fa:solid:home, lucide:home, emoji, etc.)
        renderIcon(iconValue, size = 24) {
            if (!iconValue) return '<span style="font-size:' + size + 'px">⭐</span>';
            
            // Font Awesome NEW format: fa:solid:name, fa:regular:name, fa:brands:name
            if (iconValue.startsWith('fa:')) {
                const parts = iconValue.split(':');
                if (parts.length >= 3) {
                    const style = parts[1];
                    const name = parts[2];
                    const faClass = style === 'solid' ? 'fa-solid' : (style === 'regular' ? 'fa-regular' : 'fa-brands');
                    return '<i class="' + faClass + ' fa-' + name + '" style="font-size:' + size + 'px"></i>';
                }
            }
            
            // Font Awesome LEGACY format: fas fa-name, far fa-name, fab fa-name
            if (iconValue.startsWith('fas ') || iconValue.startsWith('far ') || iconValue.startsWith('fab ') || iconValue.startsWith('fa ')) {
                // Already a complete FA class, render directly
                return '<i class="' + iconValue + '" style="font-size:' + size + 'px"></i>';
            }
            
            // Font Awesome class without prefix (e.g., fa-star, fa-home)
            if (iconValue.startsWith('fa-')) {
                return '<i class="fas ' + iconValue + '" style="font-size:' + size + 'px"></i>';
            }
            
            if (iconValue.startsWith('lucide:')) {
                const name = iconValue.replace('lucide:', '');
                for (const cat of Object.values(this.lucideIcons)) {
                    const icon = cat.find(i => i.name === name);
                    if (icon) {
                        return '<svg width="' + size + '" height="' + size + '" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">' + icon.svg + '</svg>';
                    }
                }
            }
            
            // Emoji or legacy format fallback
            return '<span style="font-size:' + size + 'px">' + iconValue + '</span>';
        },
        
        // Backwards compatibility alias
        renderIconFromFormat(format) {
            return this.renderIcon(format, 24);
        },


        

        getPortfolioCategories(items) {
            if (!items || !Array.isArray(items)) return [];
            return [...new Set(items.map(item => item.category).filter(c => c && c.trim()))];
        },

        // ═══════════════════════════════════════════════════════════
        // MEDIA PICKER INTEGRATION
        // ═══════════════════════════════════════════════════════════
        // ═══════════════════════════════════════════════════════════
        // MEDIA GALLERY (Full Implementation)
        // ═══════════════════════════════════════════════════════════
        mediaGalleryCallback: null,
        selectedMediaUrl: null,

        openMediaGallery(callback) {
            this.mediaGalleryCallback = callback;
            this.selectedMediaUrl = null;
            document.getElementById('tb-media-select-btn').disabled = true;
            document.querySelectorAll('.tb-media-item').forEach(item => item.classList.remove('selected'));
            document.querySelectorAll('.tb-stock-item').forEach(item => item.classList.remove('selected'));
            document.getElementById('tb-media-modal').classList.add('active');
            // Reset to upload tab
            document.querySelectorAll('.tb-media-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tb-media-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tb-media-tab[data-tab="upload"]').classList.add('active');
            document.getElementById('tb-media-tab-upload').classList.add('active');
        },

        closeMediaGallery() {
            document.getElementById('tb-media-modal').classList.remove('active');
        },

        selectMediaFromGallery() {
            if (!this.selectedMediaUrl) return;
            if (this.mediaGalleryCallback) {
                this.mediaGalleryCallback(this.selectedMediaUrl);
            }
            this.closeMediaGallery();
        },

        initMediaGalleryEvents() {
            // Tab switching
            document.querySelectorAll('.tb-media-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tb-media-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tb-media-tab-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('tb-media-tab-' + this.dataset.tab).classList.add('active');
                });
            });

            // Media item click
            document.querySelectorAll('.tb-media-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.tb-media-item').forEach(i => i.classList.remove('selected'));
                    document.querySelectorAll('.tb-stock-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    TB.selectedMediaUrl = this.dataset.url;
                    document.getElementById('tb-media-select-btn').disabled = false;
                });
            });

            // Upload drag & drop
            const uploadArea = document.getElementById('tb-upload-area');
            const uploadInput = document.getElementById('tb-media-upload');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
                uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length) TB.uploadMediaFile(e.dataTransfer.files[0]);
                });
            }
            if (uploadInput) {
                uploadInput.addEventListener('change', () => { if (uploadInput.files.length) TB.uploadMediaFile(uploadInput.files[0]); });
            }

            // Stock search enter key
            const stockInput = document.getElementById('tb-stock-search-input');
            if (stockInput) {
                stockInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); TB.searchStockPhotos(); }
                });
            }
        },

        uploadMediaFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('csrf_token', document.getElementById('csrf-token')?.value || '');

            document.getElementById('tb-upload-progress').style.display = 'block';

            fetch('/admin/api/tb-upload.php', { method: 'POST', credentials: 'same-origin', body: formData })
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json();
            })
            .then(data => {
                document.getElementById('tb-upload-progress').style.display = 'none';
                const success = data.success || data.ok;
                const url = data.url || (data.file && data.file.url);
                const filename = data.filename || (data.file && data.file.name) || 'image';

                if (success && url) {
                    const grid = document.getElementById('tb-media-grid');
                    const item = document.createElement('div');
                    item.className = 'tb-media-item selected';
                    item.dataset.url = url;
                    item.innerHTML = '<img src="' + url + '" alt=""><div class="tb-media-filename">' + filename + '</div>';
                    item.addEventListener('click', function() {
                        document.querySelectorAll('.tb-media-item').forEach(i => i.classList.remove('selected'));
                        document.querySelectorAll('.tb-stock-item').forEach(i => i.classList.remove('selected'));
                        this.classList.add('selected');
                        TB.selectedMediaUrl = this.dataset.url;
                        document.getElementById('tb-media-select-btn').disabled = false;
                    });
                    grid.insertBefore(item, grid.firstChild);
                    TB.selectedMediaUrl = url;
                    document.getElementById('tb-media-select-btn').disabled = false;
                    document.querySelector('.tb-media-tab[data-tab="library"]').click();
                    TB.showToast('Image uploaded!', 'success');
                } else {
                    TB.showToast(data.error || 'Upload failed', 'error');
                }
            })
            .catch(() => {
                document.getElementById('tb-upload-progress').style.display = 'none';
                TB.showToast('Upload failed', 'error');
            });
        },

        searchStockPhotos() {
            const query = document.getElementById('tb-stock-search-input').value.trim();
            if (!query) { TB.showToast('Please enter a search term', 'error'); return; }

            const results = document.getElementById('tb-stock-results');
            results.innerHTML = '<div class="tb-stock-loading">🔍 Searching Pexels...</div>';

            fetch('/api/stock-images.php?q=' + encodeURIComponent(query), {
                method: 'GET',
                credentials: 'same-origin',
                headers: { 'Accept': 'application/json' }
            })
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json();
            })
            .then(data => {
                if (data.error) { results.innerHTML = '<div class="tb-stock-loading">❌ ' + data.error + '</div>'; return; }
                if (!data.images || data.images.length === 0) { results.innerHTML = '<div class="tb-stock-loading">No photos found.</div>'; return; }

                let html = '<div class="tb-stock-grid">';
                data.images.forEach(img => {
                    html += '<div class="tb-stock-item" data-url="' + img.url + '"><img src="' + img.preview + '" alt=""><div class="tb-stock-credit">📷 ' + (img.photographer || 'Pexels') + '</div></div>';
                });
                html += '</div>';
                results.innerHTML = html;

                document.querySelectorAll('.tb-stock-item').forEach(item => {
                    item.addEventListener('click', function() {
                        document.querySelectorAll('.tb-media-item').forEach(i => i.classList.remove('selected'));
                        document.querySelectorAll('.tb-stock-item').forEach(i => i.classList.remove('selected'));
                        this.classList.add('selected');
                        TB.selectedMediaUrl = this.dataset.url;
                        document.getElementById('tb-media-select-btn').disabled = false;
                    });
                });
            })
            .catch(err => { results.innerHTML = '<div class="tb-stock-loading">❌ ' + err.message + '</div>'; });
        },

        generateAiImage() {
            const prompt = document.getElementById('tb-ai-image-prompt').value.trim();
            if (!prompt) { TB.showToast('Please describe the image', 'error'); return; }

            const style = document.getElementById('tb-ai-image-style').value;
            const size = document.getElementById('tb-ai-image-size').value;
            const preview = document.getElementById('tb-ai-gen-preview');

            preview.innerHTML = '<div class="tb-ai-gen-status"><div class="tb-spinner"></div><p>🎨 Generating image...</p></div>';

            fetch('/admin/api/ai-image-generate.php', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ csrf_token: document.getElementById('csrf-token')?.value || '', prompt, style, size })
            })
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json();
            })
            .then(data => {
                if (data.ok && data.url) {
                    preview.innerHTML = '<div style="text-align:center"><img src="' + data.url + '" style="max-height:300px;border-radius:8px;border:2px solid var(--tb-accent)"><p style="color:var(--tb-success);margin-top:1rem">✅ Image generated!</p></div>';
                    TB.selectedMediaUrl = data.url;
                    document.getElementById('tb-media-select-btn').disabled = false;

                    const grid = document.getElementById('tb-media-grid');
                    const item = document.createElement('div');
                    item.className = 'tb-media-item';
                    item.dataset.url = data.url;
                    item.innerHTML = '<img src="' + data.url + '" alt=""><div class="tb-media-filename">ai-generated.png</div>';
                    item.addEventListener('click', function() {
                        document.querySelectorAll('.tb-media-item').forEach(i => i.classList.remove('selected'));
                        this.classList.add('selected');
                        TB.selectedMediaUrl = this.dataset.url;
                        document.getElementById('tb-media-select-btn').disabled = false;
                    });
                    grid.insertBefore(item, grid.firstChild);
                    TB.showToast('Image generated!', 'success');
                } else {
                    preview.innerHTML = '<div class="tb-ai-gen-status">❌ ' + (data.error || 'Generation failed') + '</div>';
                }
            })
            .catch(err => { preview.innerHTML = '<div class="tb-ai-gen-status">❌ ' + err.message + '</div>'; });
        },

        // ═══════════════════════════════════════════════════════════
        // LAYOUT LIBRARY SYSTEM (Divi-style integration)
        // ═══════════════════════════════════════════════════════════

        libraryLayouts: [],
        selectedLayout: null,
        selectedPageIndex: 0,

        openLibrary() {
            document.getElementById('tb-library-modal').classList.add('active');
            this.loadLibraryLayouts();
        },

        closeLibrary() {
            document.getElementById('tb-library-modal').classList.remove('active');
            this.selectedLayout = null;
            this.selectedPageIndex = 0;
            document.getElementById('tb-library-pages').style.display = 'none';
            document.getElementById('tb-library-insert-btn').disabled = true;
        },

        loadLibraryLayouts() {
            const body = document.getElementById('tb-library-body');
            const search = document.getElementById('tb-library-search').value;
            const category = document.getElementById('tb-library-category').value;

            body.innerHTML = '<div class="tb-library-loading"><div class="tb-spinner"></div><p>Loading layouts...</p></div>';

            let url = '/admin/layout-library/list?';
            if (search) url += 'search=' + encodeURIComponent(search) + '&';
            if (category) url += 'category=' + encodeURIComponent(category);

            fetch(url)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.layouts) {
                        this.libraryLayouts = data.layouts;
                        this.renderLibraryGrid(data.layouts);
                    } else {
                        body.innerHTML = '<div class="tb-library-empty"><p style="font-size:2rem;margin-bottom:0.5rem;">📭</p><p>' + (data.error || 'No layouts found') + '</p></div>';
                    }
                })
                .catch(err => {
                    body.innerHTML = '<div class="tb-library-empty"><p style="font-size:2rem;margin-bottom:0.5rem;">⚠️</p><p>Failed to load layouts: ' + err.message + '</p></div>';
                });
        },

        renderLibraryGrid(layouts) {
            const body = document.getElementById('tb-library-body');

            if (!layouts || layouts.length === 0) {
                body.innerHTML = '<div class="tb-library-empty"><p style="font-size:2rem;margin-bottom:0.5rem;">📭</p><p>No layouts found. Create layouts using the AI Theme Builder.</p><a href="/admin/ai-theme-builder" class="tb-btn tb-btn-primary" style="margin-top:1rem;display:inline-flex;">✨ Open AI Theme Builder</a></div>';
                return;
            }

            let html = '<div class="tb-library-grid">';
            layouts.forEach(layout => {
                const thumbnail = layout.thumbnail
                    ? '<img src="' + this.escapeHtml(layout.thumbnail) + '" alt="">'
                    : '📄';
                const badge = layout.is_ai_generated ? '<span class="tb-library-badge">✨ AI</span>' : '';

                html += '<div class="tb-library-card" data-id="' + layout.id + '" data-pages="' + (layout.page_count || 1) + '" onclick="TB.selectLayout(this)">';
                html += '<div class="tb-library-thumbnail">' + thumbnail + '</div>';
                html += '<div class="tb-library-info">';
                html += '<div class="tb-library-name">' + this.escapeHtml(layout.name) + '</div>';
                html += '<div class="tb-library-meta">';
                html += '<span>📄 ' + (layout.page_count || 1) + ' pages</span>';
                if (layout.category) html += '<span>📁 ' + this.escapeHtml(layout.category) + '</span>';
                html += badge;
                html += '</div></div></div>';
            });
            html += '</div>';

            body.innerHTML = html;
        },

        selectLayout(card) {
            // Deselect all cards
            document.querySelectorAll('.tb-library-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');

            const layoutId = parseInt(card.dataset.id);
            const pageCount = parseInt(card.dataset.pages) || 1;

            this.selectedLayout = this.libraryLayouts.find(l => l.id == layoutId);
            this.selectedPageIndex = 0;

            // Show page selector if layout has multiple pages
            const pagesDiv = document.getElementById('tb-library-pages');
            const pagesList = document.getElementById('tb-library-pages-list');

            if (pageCount > 1) {
                pagesList.innerHTML = '';
                for (let i = 0; i < pageCount; i++) {
                    const pageNames = ['Home', 'About', 'Services', 'Contact', 'Gallery', 'Blog', 'FAQ', 'Pricing', 'Team', 'Portfolio'];
                    const pageName = i < pageNames.length ? pageNames[i] : 'Page ' + (i + 1);
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'tb-library-page-btn' + (i === 0 ? ' active' : '');
                    btn.textContent = pageName;
                    btn.onclick = () => this.selectPage(i);
                    pagesList.appendChild(btn);
                }
                pagesDiv.style.display = 'block';
            } else {
                pagesDiv.style.display = 'none';
            }

            document.getElementById('tb-library-insert-btn').disabled = false;
        },

        selectPage(index) {
            this.selectedPageIndex = index;
            document.querySelectorAll('.tb-library-page-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
        },

        insertFromLibrary() {
            if (!this.selectedLayout) {
                this.showToast('Please select a layout first', 'warning');
                return;
            }

            const insertBtn = document.getElementById('tb-library-insert-btn');
            insertBtn.disabled = true;
            insertBtn.textContent = 'Loading...';

            const insertMode = document.querySelector('input[name="insert-mode"]:checked').value;

            fetch('/admin/layout-library/get-sections?id=' + this.selectedLayout.id + '&page_index=' + this.selectedPageIndex)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.sections) {
                        if (insertMode === 'replace') {
                            this.content.sections = data.sections;
                        } else {
                            if (!this.content.sections) this.content.sections = [];
                            this.content.sections.push(...data.sections);
                        }

                        this.renderCanvas();
                        this.saveToHistory();
                        this.closeLibrary();
                        this.showToast(data.section_count + ' sections inserted from "' + data.page_title + '"', 'success');
                    } else {
                        this.showToast(data.error || 'Failed to load sections', 'error');
                        insertBtn.disabled = false;
                        insertBtn.textContent = 'Insert Sections';
                    }
                })
                .catch(err => {
                    this.showToast('Error: ' + err.message, 'error');
                    insertBtn.disabled = false;
                    insertBtn.textContent = 'Insert Sections';
                });
        }
    };

    document.addEventListener('DOMContentLoaded', () => { TB.init(); TB.initMediaGalleryEvents(); });
    </script>

    <!-- Media Gallery Modal -->
    <div class="tb-media-modal" id="tb-media-modal">
        <div class="tb-media-dialog">
            <div class="tb-media-header">
                <h3>📁 Media Library</h3>
                <button type="button" class="tb-media-close" onclick="TB.closeMediaGallery()">×</button>
            </div>
            <div class="tb-media-body">
                <div class="tb-media-tabs">
                    <button type="button" class="tb-media-tab active" data-tab="upload">📤 Upload</button>
                    <button type="button" class="tb-media-tab" data-tab="library">🖼️ Library</button>
                    <button type="button" class="tb-media-tab" data-tab="stock">📷 Stock Photos</button>
                    <button type="button" class="tb-media-tab" data-tab="ai">✨ AI Generate</button>
                </div>

                <div class="tb-media-tab-content active" id="tb-media-tab-upload">
                    <div class="tb-upload-area" id="tb-upload-area">
                        <input type="file" id="tb-media-upload" accept="image/*">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">📤</div>
                        <div>Drop image here or <label for="tb-media-upload" style="color: var(--tb-accent); cursor: pointer;">browse</label></div>
                    </div>
                    <div id="tb-upload-progress" style="display: none;">
                        <div style="background: var(--tb-border); border-radius: 4px; overflow: hidden;">
                            <div id="tb-upload-bar" style="height: 4px; background: var(--tb-accent); width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--tb-text-muted); margin-top: 0.5rem;">Uploading...</p>
                    </div>
                </div>

                <div class="tb-media-tab-content" id="tb-media-tab-library">
                    <div class="tb-media-grid" id="tb-media-grid">
                        <?php
                        $mediaDir = dirname(CMS_APP) . '/uploads/media/';
                        if (is_dir($mediaDir)) {
                            $files = scandir($mediaDir, SCANDIR_SORT_DESCENDING);
                            $count = 0;
                            foreach ($files as $file) {
                                if ($file === '.' || $file === '..' || $file === 'thumbs' || is_dir($mediaDir . $file)) continue;
                                $ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));
                                if (!in_array($ext, ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'])) continue;
                                echo '<div class="tb-media-item" data-url="/uploads/media/' . htmlspecialchars($file) . '"><img src="/uploads/media/' . htmlspecialchars($file) . '" alt=""><div class="tb-media-filename">' . htmlspecialchars($file) . '</div></div>';
                                if (++$count >= 100) break;
                            }
                        }
                        ?>
                    </div>
                </div>

                <div class="tb-media-tab-content" id="tb-media-tab-stock">
                    <div class="tb-stock-search">
                        <input type="text" id="tb-stock-search-input" placeholder="Search free stock photos (Pexels)...">
                        <button type="button" class="tb-btn tb-btn-primary" onclick="TB.searchStockPhotos()">🔍 Search</button>
                    </div>
                    <div id="tb-stock-results">
                        <div class="tb-stock-loading">
                            <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">📷</p>
                            <p>Search for beautiful free photos from Pexels</p>
                        </div>
                    </div>
                </div>

                <div class="tb-media-tab-content" id="tb-media-tab-ai">
                    <div class="tb-ai-gen-form">
                        <label style="font-weight: 500;">Describe the image you want to create:</label>
                        <textarea class="tb-ai-gen-prompt" id="tb-ai-image-prompt" placeholder="A futuristic cityscape at sunset with flying cars..."></textarea>
                        <div class="tb-ai-gen-options">
                            <select id="tb-ai-image-style">
                                <option value="photorealistic">📸 Photorealistic</option>
                                <option value="digital-art">🎨 Digital Art</option>
                                <option value="illustration">✏️ Illustration</option>
                                <option value="3d-render">🧊 3D Render</option>
                            </select>
                            <select id="tb-ai-image-size">
                                <option value="1024x1024">Square (1024×1024)</option>
                                <option value="1792x1024">Landscape (1792×1024)</option>
                                <option value="1024x1792">Portrait (1024×1792)</option>
                            </select>
                            <button type="button" class="tb-btn tb-btn-ai" onclick="TB.generateAiImage()">✨ Generate</button>
                        </div>
                    </div>
                    <div class="tb-ai-gen-preview" id="tb-ai-gen-preview">
                        <div class="tb-ai-gen-status">
                            <p style="font-size: 2rem; margin-bottom: 0.5rem;">🎨</p>
                            <p>Describe your image and click Generate</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tb-media-footer">
                <button type="button" class="tb-btn" onclick="TB.closeMediaGallery()">Cancel</button>
                <button type="button" class="tb-btn tb-btn-primary" onclick="TB.selectMediaFromGallery()" id="tb-media-select-btn" disabled>Select Image</button>
            </div>
        </div>
    </div>

    <!-- Layout Library Modal (Divi-style) -->
    <div class="tb-library-modal" id="tb-library-modal">
        <div class="tb-library-dialog">
            <div class="tb-library-header">
                <h3>📚 Load from Layout Library</h3>
                <button type="button" class="tb-library-close" onclick="TB.closeLibrary()">×</button>
            </div>
            <div class="tb-library-toolbar">
                <input type="text" class="tb-library-search" id="tb-library-search" placeholder="Search layouts...">
                <select class="tb-library-filter" id="tb-library-category">
                    <option value="">All Categories</option>
                    <option value="business">Business</option>
                    <option value="portfolio">Portfolio</option>
                    <option value="ecommerce">E-Commerce</option>
                    <option value="blog">Blog</option>
                    <option value="landing">Landing Page</option>
                    <option value="agency">Agency</option>
                    <option value="restaurant">Restaurant</option>
                    <option value="healthcare">Healthcare</option>
                    <option value="education">Education</option>
                </select>
                <button type="button" class="tb-btn" onclick="TB.loadLibraryLayouts()">🔄 Refresh</button>
            </div>
            <div class="tb-library-body" id="tb-library-body">
                <div class="tb-library-loading">
                    <div class="tb-spinner"></div>
                    <p>Loading layouts...</p>
                </div>
            </div>
            <div class="tb-library-pages" id="tb-library-pages" style="display: none;">
                <div class="tb-library-pages-label">Select page from this layout:</div>
                <div class="tb-library-pages-list" id="tb-library-pages-list"></div>
            </div>
            <div class="tb-library-footer">
                <div class="tb-insert-mode">
                    <label>
                        <input type="radio" name="insert-mode" value="append" checked>
                        <span>➕ Append sections</span>
                    </label>
                    <label>
                        <input type="radio" name="insert-mode" value="replace">
                        <span>🔄 Replace all sections</span>
                    </label>
                </div>
                <div class="tb-library-actions">
                    <button type="button" class="tb-btn" onclick="TB.closeLibrary()">Cancel</button>
                    <button type="button" class="tb-btn tb-btn-primary" id="tb-library-insert-btn" onclick="TB.insertFromLibrary()" disabled>
                        Insert Sections
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Icon Picker Modal -->
    <div class="tb-icon-picker-overlay" id="tb-icon-picker-overlay" onclick="if(event.target === this) TB.closeIconPicker()">
        <div class="tb-icon-picker-modal">
            <div class="tb-icon-picker-header">
                <h3>Select Icon</h3>
                <button class="tb-icon-picker-close" onclick="TB.closeIconPicker()">&times;</button>
            </div>
            <div class="tb-icon-picker-tabs">
                <button class="tb-icon-tab active" onclick="TB.switchIconStyle('fontawesome')">Font Awesome</button>
                <button class="tb-icon-tab" onclick="TB.switchIconStyle('lucide')">Lucide</button>
                <button class="tb-icon-tab" onclick="TB.switchIconStyle('emoji')">Emoji</button>
            </div>
            <div class="tb-icon-picker-search">
                <input type="text" id="iconSearchInput" placeholder="Search icons..." oninput="TB.filterIcons(this.value)">
            </div>
            <div class="tb-icon-picker-grid" id="iconGrid"></div>
            <div class="tb-icon-picker-preview" id="icon-picker-preview" style="display:none">
                <div class="tb-icon-picker-preview-icon" id="icon-preview-display"></div>
                <div class="tb-icon-picker-preview-info">
                    <div class="tb-icon-picker-preview-name" id="icon-preview-name"></div>
                    <div class="tb-icon-picker-preview-code" id="icon-preview-code"></div>
                </div>
                <button class="tb-btn tb-btn-primary" onclick="TB.confirmIconSelection()">Select</button>
            </div>
        </div>
    </div>



</body>
</html>
