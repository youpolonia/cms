<?php
/**
 * Theme Builder 3.0 - Template Editor (Clean Build)
 * For global templates: Header, Footer, Sidebar, Single, Archive, 404, etc.
 */
if (!defined('CMS_ROOT')) { define('CMS_ROOT', dirname(__DIR__, 5)); }

// Theme Builder Shared Components
if (!defined("CMS_CORE")) { define("CMS_CORE", CMS_ROOT . "/core"); }
require_once CMS_CORE . "/theme-builder/components/media-gallery.php";

// Template variables from controller
$templateName = esc(is_array($tplRecord) ? ($tplRecord['name'] ?? 'New Template') : 'New Template');
$templateId = (int)(is_array($tplRecord) ? ($tplRecord['id'] ?? 0) : 0);
$templateType = esc($templateType ?? 'header');
$typeLabel = esc(is_array($typeInfo) ? ($typeInfo['label'] ?? ucfirst($templateType)) : ucfirst($templateType));
$typeIcon = is_array($typeInfo) ? ($typeInfo['icon'] ?? 'ğŸ“„') : 'ğŸ“„';
$priority = (int)(is_array($tplRecord) ? ($tplRecord['priority'] ?? 0) : 0);
$isActive = (int)(is_array($tplRecord) ? ($tplRecord['is_active'] ?? 1) : 1);

// JSON data from controller
$contentJson = $contentJson ?? '{"sections":[]}';
$modulesJson = $modulesJson ?? '{}';
$categoriesJson = $categoriesJson ?? '{}';
$csrfToken = csrf_token();
?>
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= $typeLabel ?> Template - <?= $templateName ?></title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/core/theme-builder/css/components.css">
    <style>
        :root {
            --tb-bg: #1e1e2e;
            --tb-bg-secondary: #181825;
            --tb-bg-tertiary: #313244;
            --tb-surface: #45475a;
            --tb-text: #cdd6f4;
            --tb-text-dim: #a6adc8;
            --tb-accent: #89b4fa;
            --tb-success: #a6e3a1;
            --tb-warning: #f9e2af;
            --tb-danger: #f38ba8;
            --tb-border: #45475a;
            --tb-surface-2: #313244;
            --tb-text-muted: #6c7086;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--tb-bg); color: var(--tb-text); overflow: hidden; }
        
        /* Layout */
        .tb-container { display: flex; flex-direction: column; height: 100vh; }
        .tb-toolbar { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: var(--tb-bg-secondary); border-bottom: 1px solid var(--tb-border); }
        .tb-toolbar-left, .tb-toolbar-right { display: flex; align-items: center; gap: 12px; }
        .tb-main { display: flex; flex: 1; overflow: hidden; }
        
        /* Panels */
        .tb-panel { background: var(--tb-bg-secondary); border-right: 1px solid var(--tb-border); }
        .tb-panel-left { width: 280px; display: flex; flex-direction: column; }
        .tb-panel-right { width: 320px; border-right: none; border-left: 1px solid var(--tb-border); overflow-y: auto; }
        .tb-panel-header { padding: 16px; border-bottom: 1px solid var(--tb-border); font-weight: 600; }
        .tb-panel-content { padding: 16px; overflow-y: auto; flex: 1; }
        #moduleSettingsPanel { padding: 16px 0 0 0; }
        
        /* Canvas */
        .tb-canvas { flex: 1; background: var(--tb-bg); overflow: auto; padding: 20px; }
        .tb-canvas-inner { min-height: 400px; background: var(--tb-bg-tertiary); border: 2px dashed var(--tb-border); border-radius: 8px; padding: 20px; }
        
        /* Modules list */
        .tb-category { margin-bottom: 20px; }
        .tb-category-title { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--tb-text-dim); margin-bottom: 10px; letter-spacing: 0.5px; }
        .tb-modules-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .tb-module-item { display: flex; flex-direction: column; align-items: center; padding: 12px 8px; background: var(--tb-bg-tertiary); border-radius: 6px; cursor: grab; transition: all 0.2s; }
        .tb-module-item:hover { background: var(--tb-surface); transform: translateY(-2px); }
        .tb-module-item.dragging { opacity: 0.5; }
        .tb-module-icon { font-size: 24px; margin-bottom: 6px; }
        .tb-module-name { font-size: 11px; color: var(--tb-text-dim); text-align: center; }
        
        /* Buttons */
        .tb-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: var(--tb-bg-tertiary); color: var(--tb-text); border: 1px solid var(--tb-border); border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .tb-btn:hover { background: var(--tb-surface); }
        .tb-btn-primary { background: var(--tb-accent); color: #1e1e2e; border-color: var(--tb-accent); }
        .tb-btn-primary:hover { filter: brightness(1.1); }
        .tb-btn-icon { padding: 8px; }
        
        /* Form elements */
        .tb-input { width: 100%; padding: 10px 12px; background: var(--tb-bg-tertiary); border: 1px solid var(--tb-border); border-radius: 6px; color: var(--tb-text); font-size: 14px; }
        .tb-input:focus { outline: none; border-color: var(--tb-accent); }
        .tb-label { display: block; font-size: 12px; color: var(--tb-text-dim); margin-bottom: 6px; }
        .tb-field { margin-bottom: 16px; }
        
        /* Section/Row/Column */
        .tb-section { background: var(--tb-bg-secondary); border: 1px solid var(--tb-border); border-radius: 8px; margin-bottom: 16px; }
        .tb-section-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; background: var(--tb-bg-tertiary); border-radius: 8px 8px 0 0; }
        .tb-section-content { padding: 16px; }
        .tb-row { display: flex; gap: 16px; min-height: 80px; }
        .tb-column { flex: 1; background: var(--tb-bg-tertiary); border: 2px dashed var(--tb-border); border-radius: 6px; padding: 12px; min-height: 60px; transition: all 0.2s; }
        .tb-column.drag-over { border-color: var(--tb-accent); background: rgba(137, 180, 250, 0.1); }
        
        /* Module in canvas */
        .tb-module { background: var(--tb-surface); border-radius: 6px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .tb-module:hover { box-shadow: 0 0 0 2px var(--tb-accent); }
        .tb-module.selected { box-shadow: 0 0 0 2px var(--tb-accent); }
        .tb-module-type { font-size: 11px; color: var(--tb-accent); font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
        .tb-module-preview { font-size: 13px; color: var(--tb-text-dim); }
        
        /* Empty state */
        .tb-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; color: var(--tb-text-dim); }
        .tb-empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        
        /* Search */
        .tb-search { padding: 12px 16px; border-bottom: 1px solid var(--tb-border); }
        .tb-search input { width: 100%; padding: 8px 12px; background: var(--tb-bg-tertiary); border: 1px solid var(--tb-border); border-radius: 6px; color: var(--tb-text); }
        
        /* Toggle */
        .tb-toggle { position: relative; width: 44px; height: 24px; }
        .tb-toggle input { opacity: 0; width: 0; height: 0; }
        .tb-toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--tb-bg-tertiary); border-radius: 24px; transition: 0.3s; }
        .tb-toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: var(--tb-text); border-radius: 50%; transition: 0.3s; }
        .tb-toggle input:checked + .tb-toggle-slider { background: var(--tb-accent); }
        .tb-toggle input:checked + .tb-toggle-slider:before { transform: translateX(20px); }

        /* Toggle Switch (for animation) */
        .tb-toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .tb-toggle-switch input { opacity: 0; width: 0; height: 0; }
        .tb-toggle-switch .tb-toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--tb-bg-tertiary); transition: .4s; border-radius: 24px; }
        .tb-toggle-switch .tb-toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: var(--tb-text); transition: .4s; border-radius: 50%; }
        .tb-toggle-switch input:checked + .tb-toggle-slider { background-color: var(--tb-accent); }
        .tb-toggle-switch input:checked + .tb-toggle-slider:before { transform: translateX(20px); background-color: var(--tb-bg); }

        /* Small buttons */
        .tb-btn-sm { padding: 4px 10px; font-size: 11px; }

        /* Typography section */
        .tb-typography-section { margin-bottom: 16px; }
        .tb-typography-content { padding-left: 4px; }
        
        /* Tabs */
        .tb-tabs { display: flex; border-bottom: 1px solid var(--tb-border); }
        .tb-tab { padding: 12px 20px; cursor: pointer; border-bottom: 2px solid transparent; color: var(--tb-text-dim); transition: all 0.2s; }
        .tb-tab:hover { color: var(--tb-text); }
        .tb-tab.active { color: var(--tb-accent); border-bottom-color: var(--tb-accent); }
        
        /* Toast */
        .tb-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); padding: 12px 24px; background: var(--tb-surface); border-radius: 8px; opacity: 0; transition: all 0.3s; z-index: 1000; }
        .tb-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .tb-toast.success { background: var(--tb-success); color: #1e1e2e; }
        .tb-toast.error { background: var(--tb-danger); color: #1e1e2e; }
        
        /* Module actions */
        .tb-module-actions { position: absolute; top: 4px; right: 4px; display: none; gap: 4px; }
        .tb-module:hover .tb-module-actions { display: flex; }
        .tb-module-action { width: 24px; height: 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        .tb-module-action.delete { background: var(--tb-danger); color: #fff; }
        .tb-module-action.duplicate { background: var(--tb-accent); color: #1e1e2e; }
        .tb-module { position: relative; }
        
        /* Row header with layout picker */
        .tb-row-wrapper { margin-bottom: 16px; }
        .tb-row-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding: 6px 10px; background: var(--tb-bg); border-radius: 4px; }
        .tb-row-label { font-size: 11px; color: var(--tb-text-dim); }
        .tb-row-actions { display: flex; gap: 8px; align-items: center; }
        .tb-row-layout { display: flex; gap: 4px; }
        .tb-row-layout-btn { width: 36px; height: 24px; border: 1px solid var(--tb-border); background: var(--tb-bg-tertiary); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 2px; padding: 4px; }
        .tb-row-layout-btn:hover, .tb-row-layout-btn.active { border-color: var(--tb-accent); background: rgba(137,180,250,0.2); }
        .tb-row-layout-btn .col { background: var(--tb-accent); height: 100%; border-radius: 2px; }
        
        /* Layout picker modal options */
        .tb-layout-option { padding: 16px; background: var(--tb-bg-tertiary); border: 2px solid var(--tb-border); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .tb-layout-option:hover { border-color: var(--tb-accent); background: rgba(137,180,250,0.1); transform: translateY(-2px); }
        .tb-layout-preview { display: flex; gap: 4px; height: 40px; margin-bottom: 10px; }
        .tb-layout-preview .col { background: var(--tb-accent); border-radius: 4px; opacity: 0.7; height: 100%; min-width: 20px; }
        .tb-layout-label { font-size: 12px; color: var(--tb-text); font-weight: 500; }
        
        /* Modal */
        .tb-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .tb-modal.show { display: flex; }
        .tb-modal-content { background: var(--tb-bg-secondary); border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
        .tb-modal-header { padding: 16px 20px; border-bottom: 1px solid var(--tb-border); display: flex; justify-content: space-between; align-items: center; }
        .tb-modal-header h3 { font-size: 16px; font-weight: 600; }
        .tb-modal-close { background: none; border: none; color: var(--tb-text); font-size: 24px; cursor: pointer; }
        .tb-modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .tb-modal-footer { padding: 16px 20px; border-top: 1px solid var(--tb-border); display: flex; justify-content: flex-end; gap: 12px; }
        
        /* Media Gallery */
        .tb-media-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .tb-media-item { aspect-ratio: 1; background: var(--tb-bg-tertiary); border-radius: 8px; overflow: hidden; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .tb-media-item:hover { border-color: var(--tb-accent); }
        .tb-media-item.selected { border-color: var(--tb-accent); box-shadow: 0 0 0 2px var(--tb-accent); }
        .tb-media-item img { width: 100%; height: 100%; object-fit: cover; }
        .tb-media-upload { display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px dashed var(--tb-border); color: var(--tb-text-dim); gap: 8px; }
        .tb-media-upload:hover { border-color: var(--tb-accent); color: var(--tb-accent); }
        
        /* Image field with picker button */
        .tb-image-field { display: flex; gap: 8px; }
        .tb-image-field input { flex: 1; }
        .tb-image-picker-btn { padding: 0 12px; background: var(--tb-accent); color: #1e1e2e; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ICON PICKER MODAL
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tb-icon-picker-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }
        .tb-icon-picker-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .tb-icon-picker-modal {
            background: var(--tb-bg-secondary);
            border: 1px solid var(--tb-border);
            border-radius: 12px;
            width: 600px;
            max-width: 95vw;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.2s ease;
            overflow: hidden;
        }
        .tb-icon-picker-overlay.active .tb-icon-picker-modal {
            transform: scale(1);
        }
        .tb-icon-picker-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--tb-border);
        }
        .tb-icon-picker-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--tb-text);
        }
        .tb-icon-picker-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--tb-text-dim);
            font-size: 20px;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tb-icon-picker-close:hover {
            background: var(--tb-surface);
            color: var(--tb-text);
        }
        .tb-icon-picker-tabs {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            border-bottom: 1px solid var(--tb-border);
            background: var(--tb-bg);
        }
        .tb-icon-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--tb-text-dim);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .tb-icon-tab:hover {
            background: var(--tb-surface);
            color: var(--tb-text);
        }
        .tb-icon-tab.active {
            background: var(--tb-accent);
            color: #1e1e2e;
        }
        .tb-icon-picker-search {
            padding: 12px 20px;
            border-bottom: 1px solid var(--tb-border);
        }
        .tb-icon-picker-search input {
            width: 100%;
            padding: 10px 14px;
            background: var(--tb-bg);
            border: 1px solid var(--tb-border);
            border-radius: 8px;
            color: var(--tb-text);
            font-size: 14px;
        }
        .tb-icon-picker-search input:focus {
            outline: none;
            border-color: var(--tb-accent);
        }
        .tb-icon-picker-grid {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
            gap: 8px;
            align-content: start;
            max-height: 400px;
        }
        .tb-icon-option {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--tb-bg);
            border: 1px solid var(--tb-border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            color: var(--tb-text);
            transition: all 0.15s;
        }
        .tb-icon-option:hover {
            background: var(--tb-accent);
            border-color: var(--tb-accent);
            color: #1e1e2e;
            transform: scale(1.1);
        }
        .tb-icon-option i {
            font-size: 20px;
        }
        .tb-icon-option svg {
            width: 24px;
            height: 24px;
        }
        .tb-icon-option.emoji {
            font-size: 24px;
        }
        .tb-icon-picker-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px 20px;
            color: var(--tb-text-dim);
        }
        /* Icon field with preview and browse button */
        .tb-icon-field {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .tb-icon-field input {
            flex: 1;
        }
        .tb-icon-preview {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--tb-bg);
            border: 1px solid var(--tb-border);
            border-radius: 6px;
            font-size: 20px;
        }
        .tb-icon-browse-btn {
            padding: 0 12px;
            height: 40px;
            background: var(--tb-accent);
            color: #1e1e2e;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MODULE SUB-TABS (Content / Design / Advanced)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tb-module-tabs {
            display: flex;
            border-bottom: 1px solid var(--tb-border);
            background: var(--tb-bg-secondary);
            padding: 0 8px;
        }
        .tb-module-tab {
            padding: 10px 16px;
            cursor: pointer;
            border: none;
            background: transparent;
            border-bottom: 2px solid transparent;
            color: var(--tb-text-dim);
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .tb-module-tab:hover { color: var(--tb-text); }
        .tb-module-tab.active {
            color: var(--tb-accent);
            border-bottom-color: var(--tb-accent);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DEVICE TOGGLE (Desktop / Tablet / Mobile)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tb-device-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background: var(--tb-bg);
            border-bottom: 1px solid var(--tb-border);
        }
        .tb-device-toggle-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--tb-text-dim);
            margin-right: 8px;
        }
        .tb-device-btn {
            padding: 5px 8px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 4px;
            color: var(--tb-text-dim);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s;
        }
        .tb-device-btn:hover {
            background: var(--tb-bg-tertiary);
            color: var(--tb-text);
        }
        .tb-device-btn.active {
            background: var(--tb-accent);
            color: var(--tb-bg);
            border-color: var(--tb-accent);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SPACING BOX (Divi-style margin/padding visual editor)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tb-spacing-box {
            position: relative;
            width: 100%;
            padding: 8px;
            margin-bottom: 12px;
        }
        .tb-spacing-box-outer {
            position: relative;
            background: rgba(249, 226, 175, 0.15);
            border: 2px dashed rgba(249, 226, 175, 0.5);
            border-radius: 8px;
            padding: 24px;
        }
        .tb-spacing-box-inner {
            position: relative;
            background: rgba(166, 227, 161, 0.15);
            border: 2px dashed rgba(166, 227, 161, 0.5);
            border-radius: 6px;
            padding: 20px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tb-spacing-box-content {
            background: var(--tb-bg-tertiary);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 11px;
            color: var(--tb-text-dim);
        }
        .tb-spacing-label {
            position: absolute;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .tb-spacing-label-margin {
            top: 4px;
            left: 8px;
            background: rgba(249, 226, 175, 0.3);
            color: #c9a227;
        }
        .tb-spacing-label-padding {
            top: 4px;
            left: 8px;
            background: rgba(166, 227, 161, 0.3);
            color: #40a02b;
        }
        .tb-spacing-input-wrap { position: absolute; }
        .tb-spacing-input-wrap input {
            width: 44px;
            padding: 4px;
            background: var(--tb-bg-secondary);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 11px;
            text-align: center;
        }
        .tb-spacing-input-wrap input:focus { outline: none; border-color: var(--tb-accent); }
        .tb-spacing-margin-top { top: -12px; left: 50%; transform: translateX(-50%); }
        .tb-spacing-margin-right { right: -12px; top: 50%; transform: translateY(-50%); }
        .tb-spacing-margin-bottom { bottom: -12px; left: 50%; transform: translateX(-50%); }
        .tb-spacing-margin-left { left: -12px; top: 50%; transform: translateY(-50%); }
        .tb-spacing-padding-top { top: 4px; left: 50%; transform: translateX(-50%); }
        .tb-spacing-padding-right { right: 4px; top: 50%; transform: translateY(-50%); }
        .tb-spacing-padding-bottom { bottom: 4px; left: 50%; transform: translateX(-50%); }
        .tb-spacing-padding-left { left: 4px; top: 50%; transform: translateY(-50%); }
        .tb-spacing-link-btn {
            position: absolute;
            width: 20px; height: 20px;
            border: none; border-radius: 50%;
            background: var(--tb-bg-tertiary);
            cursor: pointer; font-size: 10px;
            display: flex; align-items: center; justify-content: center;
        }
        .tb-spacing-link-btn.linked { background: var(--tb-accent); color: var(--tb-bg); }
        .tb-spacing-link-margin { top: 50%; right: 4px; transform: translateY(-50%); }
        .tb-spacing-link-padding { top: 50%; right: 4px; transform: translateY(-50%); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DESIGN SETTINGS SECTIONS (collapsible)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tb-design-section { border-bottom: 1px solid var(--tb-border); margin-bottom: 12px; }
        .tb-design-section-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 0; cursor: pointer;
            font-size: 12px; font-weight: 600; color: var(--tb-text);
        }
        .tb-design-section-header:hover { color: var(--tb-accent); }
        .tb-design-section-toggle { font-size: 10px; transition: transform 0.2s; }
        .tb-design-section.collapsed .tb-design-section-toggle { transform: rotate(-90deg); }
        .tb-design-section.collapsed .tb-design-section-body { display: none; }
        .tb-design-section-body { padding-bottom: 12px; }

        /* Setting groups */
        .tb-setting-group { margin-bottom: 16px; }
        .tb-setting-label { font-size: 12px; font-weight: 500; color: var(--tb-text-dim); margin-bottom: 6px; display: block; }
        .tb-setting-input {
            width: 100%; padding: 8px 10px;
            background: var(--tb-bg-tertiary); border: 1px solid var(--tb-border);
            border-radius: 6px; color: var(--tb-text); font-size: 13px;
        }
        .tb-setting-input:focus { outline: none; border-color: var(--tb-accent); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BORDER UI (Divi-style visual border controls)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tb-border-section {
            border: 1px solid var(--tb-border);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .tb-border-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--tb-surface-2);
            cursor: pointer;
            user-select: none;
        }
        .tb-border-section-header:hover { background: var(--tb-border); }
        .tb-border-section-title {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tb-border-section-toggle {
            font-size: 10px;
            color: var(--tb-text-muted);
            transition: transform 0.2s;
        }
        .tb-border-section.collapsed .tb-border-section-toggle { transform: rotate(-90deg); }
        .tb-border-section-body { padding: 12px; display: block; }
        .tb-border-section.collapsed .tb-border-section-body { display: none; }

        .tb-border-box {
            position: relative;
            width: 100%;
            padding: 8px;
            margin-bottom: 12px;
        }
        .tb-border-box-outer {
            position: relative;
            background: rgba(180, 190, 254, 0.1);
            border: 2px dashed rgba(180, 190, 254, 0.4);
            border-radius: 8px;
            padding: 28px;
        }
        .tb-border-box-inner {
            position: relative;
            background: var(--tb-surface);
            border: 2px solid rgba(180, 190, 254, 0.6);
            border-radius: 6px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tb-border-box-content {
            font-size: 11px;
            color: var(--tb-text-muted);
            text-align: center;
            padding: 8px;
        }
        .tb-border-label {
            position: absolute;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 2px 6px;
            border-radius: 3px;
            top: 4px;
            left: 8px;
            background: rgba(180, 190, 254, 0.3);
            color: #7c7fea;
        }
        .tb-border-input-wrap {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .tb-border-input-wrap input {
            width: 44px;
            padding: 4px 6px;
            background: var(--tb-surface);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 11px;
            text-align: center;
        }
        .tb-border-input-wrap input:focus {
            outline: none;
            border-color: var(--tb-accent);
        }
        .tb-border-width-top { top: -12px; left: 50%; transform: translateX(-50%); }
        .tb-border-width-right { right: -12px; top: 50%; transform: translateY(-50%); }
        .tb-border-width-bottom { bottom: -12px; left: 50%; transform: translateX(-50%); }
        .tb-border-width-left { left: -12px; top: 50%; transform: translateY(-50%); }

        .tb-border-link-btn {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--tb-surface-2);
            border: 1px solid var(--tb-border);
            color: var(--tb-text-muted);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .tb-border-link-btn:hover {
            background: var(--tb-accent);
            color: #1e1e2e;
            border-color: var(--tb-accent);
        }
        .tb-border-link-btn.linked {
            background: var(--tb-accent);
            color: #1e1e2e;
            border-color: var(--tb-accent);
        }

        .tb-radius-box {
            position: relative;
            width: 100%;
            padding: 8px;
            margin-bottom: 12px;
        }
        .tb-radius-box-visual {
            position: relative;
            width: 100%;
            height: 100px;
            background: var(--tb-surface);
            border: 2px solid rgba(245, 194, 231, 0.6);
            border-radius: 8px;
            transition: border-radius 0.2s;
        }
        .tb-radius-corner {
            position: absolute;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tb-radius-corner input {
            width: 36px;
            padding: 4px;
            background: var(--tb-surface);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 10px;
            text-align: center;
        }
        .tb-radius-corner input:focus {
            outline: none;
            border-color: var(--tb-accent);
        }
        .tb-radius-tl { top: -18px; left: -18px; }
        .tb-radius-tr { top: -18px; right: -18px; }
        .tb-radius-br { bottom: -18px; right: -18px; }
        .tb-radius-bl { bottom: -18px; left: -18px; }

        .tb-radius-link-btn {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--tb-surface-2);
            border: 1px solid var(--tb-border);
            color: var(--tb-text-muted);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .tb-radius-link-btn:hover,
        .tb-radius-link-btn.linked {
            background: var(--tb-accent);
            color: #1e1e2e;
            border-color: var(--tb-accent);
        }
        .tb-radius-label {
            position: absolute;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 2px 6px;
            border-radius: 3px;
            top: 4px;
            left: 8px;
            background: rgba(245, 194, 231, 0.3);
            color: #d5679d;
        }

        .tb-border-style-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
        }
        .tb-border-style-row label {
            font-size: 11px;
            color: var(--tb-text-muted);
            min-width: 50px;
        }
        .tb-border-style-row select {
            flex: 1;
            padding: 6px 8px;
            background: var(--tb-surface);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 11px;
        }
        .tb-border-color-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
        }
        .tb-border-color-row label {
            font-size: 11px;
            color: var(--tb-text-muted);
            min-width: 50px;
        }
        .tb-border-color-row input[type="color"] {
            width: 36px;
            height: 28px;
            padding: 2px;
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            cursor: pointer;
        }
        .tb-border-color-row input[type="text"] {
            flex: 1;
            padding: 6px 8px;
            background: var(--tb-surface);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 11px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BOX SHADOW UI (Divi-style controls)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tb-shadow-section {
            border: 1px solid var(--tb-border);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .tb-shadow-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--tb-surface-2);
            cursor: pointer;
            user-select: none;
        }
        .tb-shadow-section-header:hover { background: var(--tb-border); }
        .tb-shadow-section-title {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tb-shadow-section-toggle {
            font-size: 10px;
            color: var(--tb-text-muted);
            transition: transform 0.2s;
        }
        .tb-shadow-section.collapsed .tb-shadow-section-toggle { transform: rotate(-90deg); }
        .tb-shadow-section-body { padding: 12px; display: block; }
        .tb-shadow-section.collapsed .tb-shadow-section-body { display: none; }

        .tb-shadow-preview-box {
            width: 60px;
            height: 60px;
            background: #ffffff;
            border-radius: 8px;
            margin: 0 auto 16px;
            transition: box-shadow 0.2s ease;
        }
        .tb-shadow-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .tb-shadow-control-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tb-shadow-control-row label {
            font-size: 11px;
            color: var(--tb-text-muted);
            min-width: 80px;
            flex-shrink: 0;
        }
        .tb-shadow-control-row input[type="range"] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--tb-border);
            border-radius: 2px;
            outline: none;
        }
        .tb-shadow-control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--tb-accent);
            border-radius: 50%;
            cursor: pointer;
        }
        .tb-shadow-control-row input[type="number"] {
            width: 54px;
            padding: 4px 6px;
            background: var(--tb-surface);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 11px;
            text-align: center;
        }
        .tb-shadow-control-row input[type="color"] {
            width: 36px;
            height: 28px;
            padding: 2px;
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            cursor: pointer;
        }
        .tb-shadow-control-row input[type="text"] {
            flex: 1;
            padding: 6px 8px;
            background: var(--tb-surface);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 11px;
        }
        .tb-shadow-enable-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid var(--tb-border);
            margin-bottom: 12px;
        }
        .tb-shadow-enable-row label {
            font-size: 12px;
            color: var(--tb-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tb-shadow-enable-row input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .tb-shadow-inset-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--tb-border);
            margin-top: 12px;
        }
        .tb-shadow-inset-row label {
            font-size: 11px;
            color: var(--tb-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tb-shadow-preset-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--tb-border);
            margin-bottom: 12px;
        }
        .tb-shadow-preset-row label {
            font-size: 11px;
            color: var(--tb-text-muted);
            min-width: 50px;
        }
        .tb-shadow-preset-row select {
            flex: 1;
            padding: 6px 8px;
            background: var(--tb-surface);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 11px;
        }
        .tb-shadow-disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TRANSFORM SECTION STYLES (Divi-style controls)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tb-transform-section {
            border: 1px solid var(--tb-border);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .tb-transform-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: linear-gradient(135deg, rgba(137, 180, 250, 0.15), rgba(137, 180, 250, 0.08));
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid var(--tb-border);
        }
        .tb-transform-section-header:hover {
            background: linear-gradient(135deg, rgba(137, 180, 250, 0.25), rgba(137, 180, 250, 0.12));
        }
        .tb-transform-section-title {
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #89b4fa;
        }
        .tb-transform-section-toggle {
            font-size: 10px;
            color: var(--tb-text-muted);
            transition: transform 0.2s;
        }
        .tb-transform-section.collapsed .tb-transform-section-toggle { transform: rotate(-90deg); }
        .tb-transform-section-body { padding: 12px; display: block; }
        .tb-transform-section.collapsed .tb-transform-section-body { display: none; }

        .tb-transform-subsection {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(137, 180, 250, 0.15);
        }
        .tb-transform-subsection:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .tb-transform-subsection-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--tb-text-muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .tb-transform-control-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .tb-transform-control-row:last-child { margin-bottom: 0; }
        .tb-transform-control-row label {
            font-size: 11px;
            color: var(--tb-text-muted);
            min-width: 80px;
            flex-shrink: 0;
        }
        .tb-transform-control-row input[type="range"] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--tb-border);
            border-radius: 2px;
            outline: none;
        }
        .tb-transform-control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: #89b4fa;
            border-radius: 50%;
            cursor: pointer;
        }
        .tb-transform-control-row input[type="number"] {
            width: 60px;
            padding: 4px 6px;
            background: var(--tb-surface);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 11px;
            text-align: center;
        }
        .tb-transform-control-row .tb-unit-label {
            font-size: 11px;
            color: var(--tb-text-muted);
            min-width: 20px;
        }

        .tb-scale-link-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
            padding: 6px 8px;
            background: rgba(137, 180, 250, 0.1);
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
            font-size: 11px;
            color: var(--tb-text-muted);
        }
        .tb-scale-link-toggle:hover { background: rgba(137, 180, 250, 0.15); }
        .tb-scale-link-toggle input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #89b4fa;
        }
        .tb-scale-link-toggle.linked {
            background: rgba(137, 180, 250, 0.2);
            color: #89b4fa;
        }

        .tb-transform-origin-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .tb-transform-origin-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            width: 90px;
            height: 90px;
            background: var(--tb-surface);
            border: 1px solid var(--tb-border);
            border-radius: 6px;
            padding: 6px;
        }
        .tb-transform-origin-point {
            width: 100%;
            aspect-ratio: 1;
            background: var(--tb-border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tb-transform-origin-point:hover { background: rgba(137, 180, 250, 0.4); }
        .tb-transform-origin-point.active {
            background: #89b4fa;
            box-shadow: 0 0 8px rgba(137, 180, 250, 0.5);
        }
        .tb-transform-origin-point::after {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--tb-text-muted);
            border-radius: 50%;
            opacity: 0.5;
        }
        .tb-transform-origin-point.active::after {
            background: #1e1e2e;
            opacity: 1;
        }
        .tb-transform-origin-value {
            font-size: 11px;
            color: var(--tb-text-muted);
            text-align: center;
            padding: 4px 8px;
            background: var(--tb-surface);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
        }
        .tb-transform-origin-custom {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .tb-transform-origin-custom input {
            width: 60px;
            padding: 4px 6px;
            background: var(--tb-surface);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 11px;
            text-align: center;
        }
        .tb-transform-origin-custom label {
            font-size: 10px;
            color: var(--tb-text-muted);
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: center;
        }
        .tb-transform-reset-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 8px 12px;
            background: rgba(137, 180, 250, 0.1);
            border: 1px solid rgba(137, 180, 250, 0.2);
            border-radius: 6px;
            color: #89b4fa;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.15s;
        }
        .tb-transform-reset-btn:hover { background: rgba(137, 180, 250, 0.2); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           AI BUTTON STYLING
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tb-btn-ai {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.25);
        }
        .tb-btn-ai:hover {
            background: linear-gradient(135deg, #7c4ddb, #5558e3);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
        }
        .tb-btn-ai:disabled {
            opacity: 0.6;
            cursor: wait;
            transform: none;
        }
        .tb-btn-ai.loading::after {
            content: '';
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: tb-ai-spin 0.8s linear infinite;
            margin-left: 6px;
        }
        @keyframes tb-ai-spin {
            to { transform: rotate(360deg); }
        }

        /* Media Gallery Button */
        .tb-btn-media {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--tb-surface);
            border: 1px solid var(--tb-border);
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }
        .tb-btn-media:hover {
            background: var(--tb-surface-hover);
            border-color: var(--tb-accent);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TYPOGRAPHY PANEL STYLING
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .tb-typography-section {
            margin-bottom: 16px;
            border: 1px solid var(--tb-border);
            border-radius: 8px;
            overflow: hidden;
        }
        .tb-typography-section > .tb-setting-group:first-child {
            background: var(--tb-surface-2);
            margin: 0;
            padding: 10px 12px;
        }
        .tb-typography-toggle {
            transition: transform 0.2s;
        }
        .tb-typography-content {
            padding: 12px;
        }
        .tb-typography-content[style*="display: none"] + .tb-typography-toggle,
        .tb-typography-section.collapsed .tb-typography-toggle {
            transform: rotate(-90deg);
        }
        .tb-device-icon {
            display: inline-flex;
            width: 16px;
            height: 16px;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            border-radius: 3px;
            margin-right: 4px;
        }
        .tb-device-icon.desktop { background: rgba(139, 180, 250, 0.2); color: #89b4fa; }
        .tb-device-icon.tablet { background: rgba(166, 227, 161, 0.2); color: #a6e3a1; }
        .tb-device-icon.mobile { background: rgba(249, 226, 175, 0.2); color: #f9e2af; }
        .tb-responsive-badge {
            display: inline-block;
            padding: 1px 4px;
            font-size: 9px;
            font-weight: 600;
            background: rgba(139, 180, 250, 0.15);
            color: #89b4fa;
            border-radius: 3px;
            margin-left: 6px;
        }
        .tb-responsive-badge.has-responsive {
            background: rgba(249, 226, 175, 0.2);
            color: #f9e2af;
        }

        /* Content Panel AI Field Styling */
        .tb-field-with-ai {
            position: relative;
        }
        .tb-field-with-ai .tb-btn-ai {
            position: absolute;
            right: 8px;
            bottom: 8px;
        }
        .tb-ai-field-row {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        .tb-ai-field-row .tb-input,
        .tb-ai-field-row textarea {
            flex: 1;
        }
        /* State Toggle (Normal/Hover) */
        .tb-state-toggle {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            padding: 4px;
            background: var(--tb-bg-tertiary);
            border-radius: 8px;
        }
        .tb-state-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--tb-text-dim);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .tb-state-btn:hover {
            background: var(--tb-bg-secondary);
            color: var(--tb-text);
        }
        .tb-state-btn.active {
            background: var(--tb-accent);
            color: #fff;
        }
        .tb-state-btn.hover-state.active {
            background: #f59e0b;
        }
        .tb-state-indicator {
            font-size: 8px;
        }
        .tb-hover-badge {
            background: #10b981;
            color: #fff;
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 4px;
            margin-left: 4px;
        }
        
        /* Hover Controls */
        .tb-hover-controls {
            transition: opacity 0.2s;
        }
        .tb-hover-controls.tb-hover-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .tb-hover-enable-row {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--tb-border);
        }
        .tb-hover-enable-row label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 13px;
        }
        .tb-hover-control-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tb-hover-control-row label {
            min-width: 80px;
            font-size: 11px;
            color: var(--tb-text-dim);
        }
        .tb-hover-control-row input[type="range"] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: var(--tb-bg-tertiary);
            border-radius: 2px;
        }
        .tb-hover-control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--tb-accent);
            border-radius: 50%;
            cursor: pointer;
        }
        .tb-hover-control-row input[type="number"],
        .tb-hover-control-row input[type="text"] {
            width: 60px;
            padding: 4px 8px;
            background: var(--tb-bg-secondary);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 11px;
        }
        .tb-hover-control-row select {
            flex: 1;
            padding: 4px 8px;
            background: var(--tb-bg-secondary);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 11px;
        }
        
        /* Badge for active features */
        .tb-badge-active {
            background: #10b981;
            color: #fff;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        /* Typography section collapsible */
        .tb-typography-section {
            border: 1px solid var(--tb-border);
            border-radius: 6px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .tb-typography-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--tb-bg-tertiary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        .tb-typography-header:hover {
            background: var(--tb-bg-secondary);
        }
        .tb-typography-body {
            padding: 12px;
            border-top: 1px solid var(--tb-border);
        }
        .tb-typography-section.collapsed .tb-typography-body {
            display: none;
        }
        .tb-typography-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .tb-typography-row:last-child {
            margin-bottom: 0;
        }
        .tb-typography-row label {
            min-width: 90px;
            font-size: 11px;
            color: var(--tb-text-dim);
        }
        .tb-typography-row select,
        .tb-typography-row input {
            flex: 1;
            padding: 6px 8px;
            background: var(--tb-bg-secondary);
            border: 1px solid var(--tb-border);
            border-radius: 4px;
            color: var(--tb-text);
            font-size: 11px;
        }
        .tb-typography-row .unit-select {
            width: 50px;
            flex: none;
        }
        
        /* Filter preview */
        .tb-filter-preview {
            width: 100%;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .tb-filter-preview-icon {
            font-size: 32px;
        }

    </style>
    <!-- Font Awesome (local) -->
    <link rel="stylesheet" href="/assets/css/fontawesome.min.css">
</head>
<body>
<div class="tb-container">
    <!-- Toolbar -->
    <header class="tb-toolbar">
        <div class="tb-toolbar-left">
            <a href="/admin/theme-builder/templates" class="tb-btn tb-btn-icon" title="Back to Templates">â†</a>
            <span style="font-size:20px"><?= $typeIcon ?></span>
            <input type="text" id="templateName" class="tb-input" style="width:200px" value="<?= $templateName ?>" placeholder="Template Name">
            <span style="background:var(--tb-accent);color:#1e1e2e;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600"><?= $typeLabel ?></span>
        </div>
        <div class="tb-toolbar-right">
            <button class="tb-btn" onclick="TB.openLibrary()" title="Preset Library">ğŸ“š Library</button>
            <button class="tb-btn" onclick="TB.preview()" title="Preview">ğŸ‘ Preview</button>
            <button class="tb-btn tb-btn-primary" id="saveBtn" onclick="TB.save()">ğŸ’¾ Save</button>
        </div>
    </header>
    
    <!-- Main Layout -->
    <div class="tb-main">
        <!-- Left Panel - Modules -->
        <aside class="tb-panel tb-panel-left">
            <div class="tb-search">
                <input type="text" id="moduleSearch" placeholder="Search modules..." oninput="TB.filterModules(this.value)">
            </div>
            <div class="tb-panel-content" id="modulesList"></div>
        </aside>
        
        <!-- Canvas -->
        <main class="tb-canvas">
            <div class="tb-canvas-inner" id="canvas"></div>
        </main>
        
        <!-- Right Panel - Settings -->
        <aside class="tb-panel tb-panel-right">
            <div class="tb-tabs">
                <div class="tb-tab active" data-tab="template">Template</div>
                <div class="tb-tab" data-tab="element">Element</div>
            </div>
            <div class="tb-panel-content">
                <div id="templateSettings">
                    <div class="tb-field">
                        <label class="tb-label">Priority</label>
                        <input type="number" id="templatePriority" class="tb-input" value="<?= $priority ?>">
                        <small style="color:var(--tb-text-dim);font-size:11px;margin-top:4px;display:block">Higher priority templates override lower ones</small>
                    </div>
                    <div class="tb-field">
                        <label class="tb-label">Active</label>
                        <label class="tb-toggle">
                            <input type="checkbox" id="templateActive" <?= $isActive ? 'checked' : '' ?>>
                            <span class="tb-toggle-slider"></span>
                        </label>
                        <small style="color:var(--tb-text-dim);font-size:11px;margin-top:4px;display:block">Only active templates are applied to the site</small>
                    </div>
                    <div class="tb-field">
                        <label class="tb-label">Display Conditions</label>
                        <select id="conditionType" class="tb-input">
                            <option value="all">All Pages</option>
                            <option value="specific">Specific Pages</option>
                            <option value="category">By Category</option>
                        </select>
                        <small style="color:var(--tb-text-dim);font-size:11px;margin-top:4px;display:block">Where this <?= strtolower($typeLabel) ?> template should appear</small>
                    </div>
                </div>
                <div id="elementSettings" style="display:none">
                    <!-- Module Sub-Tabs: Content / Design / Advanced -->
                    <div class="tb-module-tabs" id="moduleTabs" style="display:none">
                        <button class="tb-module-tab active" data-mtab="content" onclick="TB.setModuleTab('content')">Content</button>
                        <button class="tb-module-tab" data-mtab="design" onclick="TB.setModuleTab('design')">Design</button>
                        <button class="tb-module-tab" data-mtab="advanced" onclick="TB.setModuleTab('advanced')">Advanced</button>
                    </div>
                    <!-- Device Toggle -->
                    <div class="tb-device-toggle" id="deviceToggle" style="display:none">
                        <span class="tb-device-toggle-label">DEVICE</span>
                        <button class="tb-device-btn active" data-device="desktop" onclick="TB.setDevice('desktop')">ğŸ–¥ï¸</button>
                        <button class="tb-device-btn" data-device="tablet" onclick="TB.setDevice('tablet')">ğŸ“±</button>
                        <button class="tb-device-btn" data-device="mobile" onclick="TB.setDevice('mobile')">ğŸ“²</button>
                    </div>
                    <!-- Module Settings Content -->
                    <div id="moduleSettingsPanel">
                        <div class="tb-empty">
                            <div class="tb-empty-icon">ğŸ‘†</div>
                            <p>Select an element to edit its settings</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>

<div class="tb-toast" id="toast"></div>

<!-- Media Gallery Modal -->
<div class="tb-modal" id="mediaModal">
    <div class="tb-modal-content">
        <div class="tb-modal-header">
            <h3>ğŸ“· Media Gallery</h3>
            <button class="tb-modal-close" onclick="TB.closeMediaModal()">&times;</button>
        </div>
        <div class="tb-modal-body">
            <div class="tb-media-grid" id="mediaGrid">
                <div class="tb-media-item tb-media-upload" onclick="TB.uploadMedia()">
                    <span style="font-size:32px">ğŸ“¤</span>
                    <span>Upload Image</span>
                </div>
            </div>
        </div>
        <div class="tb-modal-footer">
            <button class="tb-btn" onclick="TB.closeMediaModal()">Cancel</button>
            <button class="tb-btn tb-btn-primary" onclick="TB.selectMedia()">Select</button>
        </div>
    </div>
</div>

<!-- Layout Picker Modal -->
<div class="tb-modal" id="layoutModal">
    <div class="tb-modal-content" style="max-width:600px">
        <div class="tb-modal-header">
            <h3>ğŸ“ Choose Row Layout</h3>
            <button class="tb-modal-close" onclick="TB.closeLayoutModal()">&times;</button>
        </div>
        <div class="tb-modal-body">
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px" id="layoutOptions"></div>
        </div>
    </div>
</div>

<!-- Preset Library Modal -->
<div class="tb-modal" id="libraryModal">
    <div class="tb-modal-content" style="max-width:900px">
        <div class="tb-modal-header">
            <h3>ğŸ“š Preset Library</h3>
            <button class="tb-modal-close" onclick="TB.closeLibrary()">&times;</button>
        </div>
        <div class="tb-modal-body" style="padding:0">
            <div class="tb-library-search" style="padding:16px;border-bottom:1px solid var(--tb-border)">
                <input type="text" class="tb-input" id="librarySearch" placeholder="Search presets..." oninput="TB.filterPresets(this.value)">
            </div>
            <div class="tb-library-grid" id="libraryGrid" style="padding:20px;display:grid;grid-template-columns:repeat(3,1fr);gap:16px;max-height:60vh;overflow-y:auto">
                <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--tb-text-dim)">
                    <span style="font-size:32px;display:block;margin-bottom:8px">â³</span>
                    Loading presets...
                </div>
            </div>
        </div>
        <div class="tb-modal-footer">
            <button class="tb-btn" onclick="TB.closeLibrary()">Cancel</button>
            <button class="tb-btn tb-btn-primary" id="usePresetBtn" onclick="TB.usePreset()" disabled>Use This Preset</button>
        </div>
    </div>
</div>

<style>
.tb-preset-card {
    background: var(--tb-bg-tertiary);
    border: 2px solid var(--tb-border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    overflow: hidden;
}
.tb-preset-card:hover {
    border-color: var(--tb-accent);
    transform: translateY(-2px);
}
.tb-preset-card.selected {
    border-color: var(--tb-accent);
    box-shadow: 0 0 0 3px rgba(137,180,250,0.3);
}
.tb-preset-thumb {
    height: 120px;
    background: var(--tb-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    color: var(--tb-text-dim);
}
.tb-preset-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.tb-preset-info {
    padding: 12px;
}
.tb-preset-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}
.tb-preset-desc {
    font-size: 12px;
    color: var(--tb-text-dim);
    line-height: 1.4;
}
.tb-preset-tags {
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}
.tb-preset-tag {
    font-size: 10px;
    padding: 2px 6px;
    background: var(--tb-surface);
    border-radius: 4px;
    color: var(--tb-text-dim);
}
.tb-preset-premium {
    background: linear-gradient(135deg, #f9e2af, #fab387);
    color: #1e1e2e;
}
.tb-library-empty {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
    color: var(--tb-text-dim);
}
.tb-library-empty-icon {
    font-size: 48px;
    display: block;
    margin-bottom: 12px;
    opacity: 0.5;
}
</style>

<script>
console.log('[TEMPLATE-EDIT v8] Fixed AI: correct templateName selector + added debug logging');
const TB = {
    templateId: <?= $templateId ?>,
    templateType: '<?= $templateType ?>',
    csrfToken: '<?= $csrfToken ?>',
    content: <?= $contentJson ?>,
    modules: <?= $modulesJson ?>,
    categories: <?= $categoriesJson ?>,
    selectedModule: null,
    isDirty: false,
    currentModuleTab: 'content',
    currentDevice: 'desktop',

    init: function() {
        console.log('TB.init - modules:', Object.keys(this.modules).length, 'modules loaded');
        console.log('TB.init - content:', this.content);

        if (!this.modules || Object.keys(this.modules).length === 0) {
            console.error('No modules loaded! Check if tb_init() was called.');
        }

        this.renderModulesList();
        this.renderCanvas();
        this.saveCollapsedState();
        this.bindEvents();
        console.log('Theme Builder Template Editor initialized');
    },

    renderModulesList: function() {
        var container = document.getElementById('modulesList');
        var html = '';
        var grouped = {};
        var self = this;
        
        // Group modules by category
        Object.keys(this.modules).forEach(function(type) {
            var mod = self.modules[type];
            var cat = mod.category || 'general';
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push({ type: type, name: mod.name, icon: mod.icon || 'ğŸ“¦' });
        });
        
        // Render by category
        Object.keys(grouped).forEach(function(cat) {
            var label = self.categories[cat] || cat;
            html += '<div class="tb-category" data-category="' + cat + '">';
            html += '<div class="tb-category-title">' + label + '</div>';
            html += '<div class="tb-modules-grid">';
            grouped[cat].forEach(function(mod) {
                html += '<div class="tb-module-item" draggable="true" data-type="' + mod.type + '">';
                html += '<div class="tb-module-icon">' + self.getModuleIcon(mod.type) + '</div>';
                html += '<div class="tb-module-name">' + mod.name + '</div>';
                html += '</div>';
            });
            html += '</div></div>';
        });
        
        container.innerHTML = html;
    },

    getModuleIcon: function(type) {
        var icons = {
            'text': 'ğŸ“', 'heading': 'ğŸ”¤', 'image': 'ğŸ–¼ï¸', 'button': 'ğŸ”˜', 'video': 'ğŸ¬',
            'logo': 'ğŸ·ï¸', 'menu': 'â˜°', 'search': 'ğŸ”', 'social': 'ğŸ“±', 'divider': 'â–',
            'spacer': 'â†•ï¸', 'icon': 'â­', 'cta': 'ğŸ“¢', 'hero': 'ğŸ¦¸', 'testimonial': 'ğŸ’¬',
            'gallery': 'ğŸ–¼ï¸', 'accordion': 'ğŸ“‹', 'tabs': 'ğŸ“‘', 'counter': 'ğŸ”¢', 'pricing': 'ğŸ’°',
            'map': 'ğŸ—ºï¸', 'audio': 'ğŸµ', 'html': 'ğŸ§©', 'sidebar': 'ğŸ“', 'post_title': 'ğŸ“°',
            'post_content': 'ğŸ“„', 'post_excerpt': 'âœ‚ï¸', 'post_meta': 'â„¹ï¸', 'post_featured_image': 'ğŸ–¼ï¸',
            'comments': 'ğŸ’¬', 'breadcrumbs': 'ğŸ', 'pagination': 'ğŸ“–', 'login': 'ğŸ”'
        };
        return icons[type] || 'ğŸ“¦';
    },

    renderCanvas: function() {
        var canvas = document.getElementById('canvas');
        var self = this;
        
        if (!this.content.sections || this.content.sections.length === 0) {
            canvas.innerHTML = '<div class="tb-empty"><div class="tb-empty-icon">ğŸ“¦</div><p>Drag modules here or click "Add Section" to start building</p><button class="tb-btn tb-btn-primary" onclick="TB.addSection()" style="margin-top:16px">+ Add Section</button></div>';
            return;
        }
        
        var html = '';
        this.content.sections.forEach(function(section, sIdx) {
            html += '<div class="tb-section" data-section="' + sIdx + '">';
            html += '<div class="tb-section-header"><span>Section ' + (sIdx + 1) + '</span><div style="display:flex;gap:4px"><button class="tb-btn tb-btn-icon" onclick="TB.moveSection(' + sIdx + ',-1)" title="Move Up">â†‘</button><button class="tb-btn tb-btn-icon" onclick="TB.moveSection(' + sIdx + ',1)" title="Move Down">â†“</button><button class="tb-btn tb-btn-icon" onclick="TB.editSection(' + sIdx + ')" title="Settings">âš™</button><button class="tb-btn tb-btn-icon" onclick="TB.addRow(' + sIdx + ')" title="Add Row">+</button><button class="tb-btn tb-btn-icon" onclick="TB.duplicateSection(' + sIdx + ')" title="Duplicate">â§‰</button><button class="tb-btn tb-btn-icon" onclick="TB.removeSection(' + sIdx + ')" title="Delete" style="color:var(--tb-danger)">Ã—</button></div></div>';
            html += '<div class="tb-section-content">';
            
            if (section.rows && section.rows.length > 0) {
                section.rows.forEach(function(row, rIdx) {
                    html += '<div class="tb-row-wrapper">';
                    html += '<div class="tb-row-header"><span class="tb-row-label">Row ' + (rIdx + 1) + '</span><div class="tb-row-actions">';
                    html += '<div class="tb-row-layout">' + self.renderLayoutButtons(sIdx, rIdx, row.columns.length) + '</div>';
                    html += '<button class="tb-btn tb-btn-icon" onclick="TB.moveRow(' + sIdx + ',' + rIdx + ',-1)" title="Move Up" style="padding:4px 8px">â†‘</button>';
                    html += '<button class="tb-btn tb-btn-icon" onclick="TB.moveRow(' + sIdx + ',' + rIdx + ',1)" title="Move Down" style="padding:4px 8px">â†“</button>';
                    html += '<button class="tb-btn tb-btn-icon" onclick="TB.duplicateRow(' + sIdx + ',' + rIdx + ')" title="Duplicate" style="padding:4px 8px">â§‰</button>';
                    html += '<button class="tb-btn tb-btn-icon" onclick="TB.deleteRow(' + sIdx + ',' + rIdx + ')" title="Delete Row" style="padding:4px 8px;color:var(--tb-danger)">Ã—</button>';
                    html += '</div></div>';
                    html += '<div class="tb-row" data-row="' + rIdx + '">';
                    row.columns.forEach(function(col, cIdx) {
                        var flex = col.flex || 1;
                        html += '<div class="tb-column" data-col="' + cIdx + '" style="flex:' + flex + '" ondragover="TB.handleDragOver(event)" ondrop="TB.handleDrop(event, ' + sIdx + ',' + rIdx + ',' + cIdx + ')" ondragleave="TB.handleDragLeave(event)">';
                        if (col.modules && col.modules.length > 0) {
                            col.modules.forEach(function(mod, mIdx) {
                                html += self.renderModule(mod, sIdx, rIdx, cIdx, mIdx);
                            });
                        }
                        html += '</div>';
                    });
                    html += '</div></div>';
                });
            }
            
            html += '</div></div>';
        });
        
        html += '<button class="tb-btn" onclick="TB.addSection()" style="margin-top:16px">+ Add Section</button>';
        canvas.innerHTML = html;
    },

    renderModule: function(mod, sIdx, rIdx, cIdx, mIdx) {
        var preview = this.getModulePreview(mod);
        var selected = this.selectedModule && this.selectedModule.path === sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx ? ' selected' : '';
        return '<div class="tb-module' + selected + '" data-path="' + sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx + '" onclick="TB.selectModule(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">' +
               '<div class="tb-module-actions">' +
               '<button class="tb-module-action" onclick="event.stopPropagation();TB.moveModule(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',-1)" title="Move Up">â†‘</button>' +
               '<button class="tb-module-action" onclick="event.stopPropagation();TB.moveModule(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',1)" title="Move Down">â†“</button>' +
               '<button class="tb-module-action duplicate" onclick="event.stopPropagation();TB.duplicateModule(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')" title="Duplicate">â§‰</button>' +
               '<button class="tb-module-action delete" onclick="event.stopPropagation();TB.deleteModule(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')" title="Delete">Ã—</button>' +
               '</div>' +
               '<div class="tb-module-type">' + this.getModuleIcon(mod.type) + ' ' + mod.type + '</div>' +
               '<div class="tb-module-preview">' + preview + '</div>' +
               '</div>';
    },

    getModulePreview: function(mod) {
        var c = mod.content || {};
        var d = mod.design || {};
        var typoStyles = this.getTypographyStyles(d);
        var bgStyles = this.getBackgroundStyles(d);
        var borderStyles = this.getBorderStyles(d);
        var shadowStyles = this.getBoxShadowStyles(d);
        var spacingStyles = this.getSpacingStyles(d);
        var allStyles = typoStyles + bgStyles + borderStyles + shadowStyles + spacingStyles;

        switch(mod.type) {
            case 'text':
                var textContent = (c.text || 'Text content...').substring(0, 100);
                return '<p style="margin:0;color:#333;' + typoStyles + spacingStyles + '">' + this.escHtml(textContent) + (c.text && c.text.length > 100 ? '...' : '') + '</p>';
            case 'heading':
                var tag = c.tag || 'h2';
                var headingTypo = this.getElementTypographyStyles(d, 'title') || typoStyles;
                return '<' + tag + ' style="margin:0;color:#333;' + headingTypo + spacingStyles + '">' + this.escHtml(c.text || 'Heading') + '</' + tag + '>';
            case 'image':
                var imgStyles = borderStyles + shadowStyles + spacingStyles;
                return c.src ? '<img src="' + this.escHtml(c.src) + '" alt="' + this.escHtml(c.alt || '') + '" style="max-width:100%;height:auto;' + imgStyles + '">' : '<div style="background:#e2e8f0;height:80px;display:flex;align-items:center;justify-content:center;border-radius:4px;color:#64748b;' + spacingStyles + '">ğŸ–¼ No image set</div>';
            case 'button':
                // Get button style preset for fallback colors
                var btnStyle = c.style || 'primary';
                var presets = {
                    primary: {bg:'#0073e6', text:'#fff', border:'none'},
                    secondary: {bg:'#6c757d', text:'#fff', border:'none'},
                    outline: {bg:'transparent', text:'#0073e6', border:'2px solid #0073e6'},
                    ghost: {bg:'transparent', text:'#333', border:'none'}
                };
                var preset = presets[btnStyle] || presets.primary;

                // Get typography for button element
                var buttonTypo = this.getElementTypographyStyles(d, 'button');

                // Build button-specific styles
                var btnBg = d.backgroundColor || d.background_color || preset.bg;
                var btnTextColor = '';
                if (d.typography_button && d.typography_button.color) {
                    btnTextColor = d.typography_button.color;
                } else if (d.typography_button && d.typography_button.text_color) {
                    btnTextColor = d.typography_button.text_color;
                } else if (d.text_color) {
                    btnTextColor = d.text_color;
                } else {
                    btnTextColor = preset.text;
                }

                // Border handling - use design border or preset
                var btnBorder = preset.border;
                if (d.border_style && d.border_style !== 'none') {
                    var bColor = d.border_color || '#0073e6';
                    var bWidth = d.border_width_top || d.border_width || '1';
                    if (!/[a-z%]$/i.test(String(bWidth))) bWidth = bWidth + 'px';
                    btnBorder = bWidth + ' ' + d.border_style + ' ' + bColor;
                } else if (btnStyle === 'outline') {
                    btnBorder = '2px solid ' + (d.border_color || '#0073e6');
                }

                // Border radius - use all corners or fallback
                var btnRadius = '';
                if (d.border_radius_tl || d.border_radius_tr || d.border_radius_br || d.border_radius_bl) {
                    var rTL = d.border_radius_tl || '0';
                    var rTR = d.border_radius_tr || '0';
                    var rBR = d.border_radius_br || '0';
                    var rBL = d.border_radius_bl || '0';
                    if (!/[a-z%]$/i.test(String(rTL))) rTL = rTL + 'px';
                    if (!/[a-z%]$/i.test(String(rTR))) rTR = rTR + 'px';
                    if (!/[a-z%]$/i.test(String(rBR))) rBR = rBR + 'px';
                    if (!/[a-z%]$/i.test(String(rBL))) rBL = rBL + 'px';
                    btnRadius = rTL + ' ' + rTR + ' ' + rBR + ' ' + rBL;
                } else {
                    btnRadius = '4px';
                }

                // Build complete button style - helper for unit normalization
                var normUnit = function(val, fallback) {
                    if (!val && val !== 0) return fallback;
                    var s = String(val);
                    return /[a-z%]$/i.test(s) ? s : s + 'px';
                };

                var btnStyles = 'display:inline-block;';
                var pT = normUnit(d.padding_top, '10px');
                var pR = normUnit(d.padding_right, '20px');
                var pB = normUnit(d.padding_bottom, '10px');
                var pL = normUnit(d.padding_left, '20px');
                btnStyles += 'padding:' + pT + ' ' + pR + ' ' + pB + ' ' + pL + ';';
                btnStyles += 'background:' + btnBg + ';';
                btnStyles += 'color:' + btnTextColor + ';';
                btnStyles += 'border:' + btnBorder + ';';
                btnStyles += 'border-radius:' + btnRadius + ';';
                btnStyles += 'font-weight:500;cursor:pointer;';
                btnStyles += buttonTypo;
                btnStyles += shadowStyles;

                // Add margin if specified
                if (d.margin_top || d.margin_right || d.margin_bottom || d.margin_left) {
                    var mT = normUnit(d.margin_top, '0');
                    var mR = normUnit(d.margin_right, '0');
                    var mB = normUnit(d.margin_bottom, '0');
                    var mL = normUnit(d.margin_left, '0');
                    btnStyles += 'margin:' + mT + ' ' + mR + ' ' + mB + ' ' + mL + ';';
                }

                return '<button style="' + btnStyles + '">' + this.escHtml(c.text || 'Button') + '</button>';
            case 'divider':
                var dividerStyle = c.style || 'solid';
                var dividerColor = d.border_color || '#e2e8f0';
                // Handle divider width that may or may not include units
                var dividerWidthVal = d.border_width_top || '2';
                var dividerWidth = /[a-z%]$/i.test(String(dividerWidthVal)) ? dividerWidthVal : dividerWidthVal + 'px';
                return '<hr style="border:none;border-top:' + dividerWidth + ' ' + dividerStyle + ' ' + dividerColor + ';' + spacingStyles + '">';
            case 'spacer':
                var height = c.height || '40px';
                return '<div style="height:' + height + ';background:repeating-linear-gradient(45deg,#f8fafc,#f8fafc 10px,#f1f5f9 10px,#f1f5f9 20px);border-radius:4px;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:11px">' + height + ' spacer</div>';
            case 'quote':
                var quoteTypo = this.getTypographyStyles(d);
                return '<blockquote style="margin:0;padding:12px 20px;border-left:4px solid #6366f1;font-style:italic;color:#64748b;' + quoteTypo + spacingStyles + '">"' + this.escHtml((c.text || 'Quote text...').substring(0, 80)) + '"</blockquote>';
            case 'blurb':
                var blurbTitleTypo = this.getElementTypographyStyles(d, 'title') || '';
                var blurbTextTypo = this.getElementTypographyStyles(d, 'body') || typoStyles;
                return '<div style="' + bgStyles + borderStyles + spacingStyles + shadowStyles + '"><strong style="' + blurbTitleTypo + '">' + this.escHtml(c.title || 'Blurb Title') + '</strong><p style="margin:8px 0 0;font-size:13px;color:#64748b;' + blurbTextTypo + '">' + this.escHtml((c.text || '').substring(0, 60)) + '</p></div>';
            case 'cta':
                var ctaTitleTypo = this.getElementTypographyStyles(d, 'title') || '';
                return '<div style="text-align:center;' + bgStyles + spacingStyles + borderStyles + shadowStyles + '"><strong style="font-size:18px;' + ctaTitleTypo + '">' + this.escHtml(c.title || 'Call to Action') + '</strong></div>';
            case 'hero':
                var heroTitleTypo = this.getElementTypographyStyles(d, 'title') || '';
                var heroSubTypo = this.getElementTypographyStyles(d, 'subtitle') || '';
                return '<div style="text-align:center;padding:24px;' + bgStyles + borderStyles + shadowStyles + '"><h2 style="margin:0 0 8px;' + heroTitleTypo + '">' + this.escHtml(c.title || 'Hero Title') + '</h2><p style="margin:0;color:#64748b;' + heroSubTypo + '">' + this.escHtml(c.subtitle || 'Subtitle text') + '</p></div>';
            case 'testimonial':
                var testiTypo = this.getTypographyStyles(d);
                return '<div style="padding:16px;' + bgStyles + borderStyles + shadowStyles + spacingStyles + '"><p style="font-style:italic;margin:0 0 8px;' + testiTypo + '">"' + this.escHtml((c.text || 'Testimonial quote...').substring(0, 60)) + '"</p><div style="font-size:12px;color:#64748b">â€” ' + this.escHtml(c.author || 'Author') + '</div></div>';
            case 'pricing':
                var priceTitleTypo = this.getElementTypographyStyles(d, 'title') || '';
                var pricePriceTypo = this.getElementTypographyStyles(d, 'price') || '';
                return '<div style="text-align:center;padding:16px;' + bgStyles + borderStyles + shadowStyles + spacingStyles + '"><div style="font-weight:600;' + priceTitleTypo + '">' + this.escHtml(c.title || 'Plan Name') + '</div><div style="font-size:24px;font-weight:700;color:#6366f1;margin:8px 0;' + pricePriceTypo + '">' + this.escHtml(c.currency || '$') + this.escHtml(c.price || '99') + '</div></div>';
            case 'counter':
                var counterTypo = this.getTypographyStyles(d);
                return '<div style="text-align:center;' + spacingStyles + '"><div style="font-size:32px;font-weight:700;color:#6366f1;' + counterTypo + '">' + this.escHtml(c.prefix || '') + this.escHtml(c.number || '100') + this.escHtml(c.suffix || '+') + '</div><div style="font-size:13px;color:#64748b">' + this.escHtml(c.title || 'Counter') + '</div></div>';
            case 'logo': return '<div style="' + spacingStyles + '">ğŸ·ï¸ Logo</div>';
            case 'menu': return '<div style="' + spacingStyles + '">â˜° Navigation Menu</div>';
            case 'search': return '<div style="' + spacingStyles + '">ğŸ” Search Form</div>';
            case 'social': return '<div style="' + spacingStyles + '">ğŸ“± Social Icons</div>';
            case 'blog': return '<div style="' + spacingStyles + '">ğŸ“° Blog Posts</div>';
            case 'post_slider': return '<div style="' + spacingStyles + '">ğŸ  Post Slider</div>';
            case 'posts_navigation': return '<div style="' + spacingStyles + '">â—€ï¸ Posts Navigation â–¶ï¸</div>';
            case 'form': return '<div style="' + spacingStyles + bgStyles + borderStyles + '">ğŸ“ ' + this.escHtml(c.title || 'Contact Form') + '</div>';
            case 'team': return '<div style="' + spacingStyles + '">ğŸ‘¥ Team Members</div>';
            case 'portfolio': return '<div style="' + spacingStyles + '">ğŸ–¼ï¸ Portfolio Gallery</div>';
            case 'countdown': return '<div style="' + spacingStyles + '">â±ï¸ Countdown Timer</div>';
            case 'signup': return '<div style="' + spacingStyles + '">âœ‰ï¸ Newsletter Signup</div>';
            case 'bar_counters': return '<div style="' + spacingStyles + '">ğŸ“Š Bar Counters</div>';
            case 'circle_counter': return '<div style="' + spacingStyles + '">â­• ' + (c.value || '75') + '%</div>';
            case 'fullwidth_image': return '<div style="' + spacingStyles + '">ğŸ–¼ï¸ Fullwidth Image</div>';
            case 'fullwidth_header': return '<div style="' + spacingStyles + '">ğŸ“„ ' + this.escHtml(c.title || 'Page Header') + '</div>';
            case 'fullwidth_map': return '<div style="' + spacingStyles + '">ğŸ—ºï¸ Fullwidth Map</div>';
            case 'fullwidth_code': return '<div style="' + spacingStyles + '">ğŸ’» Code Block</div>';
            case 'fullwidth_menu': return '<div style="' + spacingStyles + '">â˜° Fullwidth Menu</div>';
            case 'fullwidth_slider': return '<div style="' + spacingStyles + '">ğŸ  Fullwidth Slider</div>';
            case 'fullwidth_portfolio': return '<div style="' + spacingStyles + '">ğŸ–¼ï¸ Fullwidth Portfolio</div>';
            case 'fullwidth_post_slider': return '<div style="' + spacingStyles + '">ğŸ“° Fullwidth Post Slider</div>';
            case 'video': return '<div style="background:#1e293b;height:80px;display:flex;align-items:center;justify-content:center;border-radius:4px;color:#fff;' + spacingStyles + '">ğŸ¬ Video</div>';
            case 'audio': return '<div style="background:#1e293b;padding:16px;border-radius:8px;color:#fff;' + spacingStyles + '">ğŸ”Š Audio Player</div>';
            case 'icon':
                var iconColor = d.text_color || c.color || '#333';
                var iconSize = c.size || '48px';
                return '<div style="text-align:center;font-size:' + iconSize + ';color:' + iconColor + ';' + spacingStyles + '">' + (c.icon || 'â­') + '</div>';
            case 'gallery': return '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;' + spacingStyles + '">' + (c.images || []).slice(0,3).map(function(img){ return '<div style="background:#e2e8f0;aspect-ratio:1;border-radius:4px"></div>'; }).join('') + '</div>';
            case 'accordion': return '<div style="' + spacingStyles + borderStyles + '">ğŸ“‹ Accordion (' + ((c.items || []).length || 0) + ' items)</div>';
            case 'tabs': return '<div style="' + spacingStyles + '">ğŸ“‘ Tabs (' + ((c.tabs || []).length || 0) + ' tabs)</div>';
            case 'map': return '<div style="background:#e2e8f0;height:120px;display:flex;align-items:center;justify-content:center;border-radius:4px;' + spacingStyles + '">ğŸ“ Map</div>';
            case 'code': return '<pre style="background:#1e1e2e;color:#cdd6f4;padding:12px;border-radius:6px;font-size:11px;overflow:hidden;' + spacingStyles + '">' + this.escHtml((c.code || '// Code...').substring(0, 60)) + '</pre>';
            case 'slider': return '<div style="background:#f1f5f9;height:100px;display:flex;align-items:center;justify-content:center;border-radius:4px;' + spacingStyles + '">ğŸ  Slider (' + ((c.slides || []).length || 0) + ' slides)</div>';
            default: return '<div style="' + spacingStyles + '">' + mod.type + ' module</div>';
        }
    },

    addSection: function() {
        if (!this.content.sections) this.content.sections = [];
        this.content.sections.push({
            rows: [{ columns: [{ modules: [] }] }]
        });
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
    },

    removeSection: function(sIdx) {
        if (confirm('Remove this section?')) {
            this.content.sections.splice(sIdx, 1);
            this.isDirty = true;
            this.renderCanvas();
        this.saveCollapsedState();
        }
    },

    addRow: function(sIdx) {
        // Store which section to add row to, then show layout picker
        this.addRowTarget = sIdx;
        this.showAddRowLayoutModal();
    },
    
    addRowTarget: null,
    
    showAddRowLayoutModal: function() {
        var container = document.getElementById('layoutOptions');
        var self = this;
        var html = '';
        
        this.layouts.forEach(function(layout, idx) {
            html += '<div class="tb-layout-option" onclick="TB.addRowWithLayout(' + idx + ')">';
            html += '<div class="tb-layout-preview">';
            layout.widths.forEach(function(w) {
                html += '<div class="col" style="flex:' + w + '"></div>';
            });
            html += '</div>';
            html += '<div class="tb-layout-label">' + layout.label + '</div>';
            html += '</div>';
        });
        
        container.innerHTML = html;
        document.getElementById('layoutModal').classList.add('show');
    },
    
    addRowWithLayout: function(layoutIdx) {
        var layout = this.layouts[layoutIdx];
        var columns = [];
        for (var i = 0; i < layout.cols; i++) {
            columns.push({ modules: [], flex: layout.widths[i] });
        }
        this.content.sections[this.addRowTarget].rows.push({ columns: columns });
        this.isDirty = true;
        this.closeLayoutModal();
        this.renderCanvas();
        this.saveCollapsedState();
        this.toast('Row added', 'success');
    },

    selectModule: function(sIdx, rIdx, cIdx, mIdx) {
        console.log('selectModule called:', sIdx, rIdx, cIdx, mIdx);

        // Validate indices exist
        if (!this.content.sections[sIdx]) {
            console.error('Section not found:', sIdx);
            return;
        }
        if (!this.content.sections[sIdx].rows[rIdx]) {
            console.error('Row not found:', rIdx);
            return;
        }
        if (!this.content.sections[sIdx].rows[rIdx].columns[cIdx]) {
            console.error('Column not found:', cIdx);
            return;
        }
        if (!this.content.sections[sIdx].rows[rIdx].columns[cIdx].modules[mIdx]) {
            console.error('Module not found:', mIdx);
            return;
        }

        this.selectedModule = {
            path: sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx,
            module: this.content.sections[sIdx].rows[rIdx].columns[cIdx].modules[mIdx]
        };

        console.log('Module selected:', this.selectedModule);
        // Auto-switch to Element tab
        document.querySelectorAll('.tb-tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelector('.tb-tab[data-tab="element"]').classList.add('active');
        document.getElementById('templateSettings').style.display = 'none';
        document.getElementById('elementSettings').style.display = '';
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderElementSettings();
    },

    renderElementSettings: function() {
        console.log('renderElementSettings called, selectedModule:', this.selectedModule);

        var container = document.getElementById('moduleSettingsPanel');
        var tabsEl = document.getElementById('moduleTabs');
        var deviceEl = document.getElementById('deviceToggle');

        if (!container) {
            console.error('moduleSettingsPanel not found!');
            return;
        }

        if (!this.selectedModule) {
            console.log('No module selected, showing empty state');
            tabsEl.style.display = 'none';
            deviceEl.style.display = 'none';
            container.innerHTML = '<div class="tb-empty"><div class="tb-empty-icon">ğŸ‘†</div><p>Select an element to edit its settings</p></div>';
            return;
        }
        
        // Show tabs and device toggle
        tabsEl.style.display = 'flex';
        deviceEl.style.display = 'flex';
        
        // Render based on current tab
        if (this.currentModuleTab === 'design') {
            this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
            return;
        } else if (this.currentModuleTab === 'advanced') {
            this.renderAdvancedSettings();
            return;
        }
        
        // Content tab (default) - Using edit.php pattern
        var mod = this.selectedModule.module;
        var content = mod.content || {};
        var path = this.selectedModule.path.split('-');
        var sIdx = parseInt(path[0]), rIdx = parseInt(path[1]), cIdx = parseInt(path[2]), mIdx = parseInt(path[3]);

        var html = '<div class="tb-setting-group"><div class="tb-setting-label">' + this.getModuleIcon(mod.type) + ' ' + mod.type.toUpperCase() + ' MODULE</div></div>';
        html += this.renderContentSettings(mod, sIdx, rIdx, cIdx, mIdx);
        html += '<div class="tb-setting-group" style="margin-top:24px;display:flex;gap:8px;"><button class="tb-btn" style="flex:1;justify-content:center" onclick="TB.duplicateModule(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">â§‰ Duplicate</button><button class="tb-btn" style="flex:1;justify-content:center;background:var(--tb-danger);color:#fff" onclick="TB.removeSelectedModule()">Ã— Delete</button></div>';
        container.innerHTML = html;
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONTENT SETTINGS (Matching edit.php exactly)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    renderContentSettings: function(mod, sIdx, rIdx, cIdx, mIdx) {
        var content = mod.content || {};
        var self = this;
        var html = '';

        switch (mod.type) {
            case 'text':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Text Content</div><textarea class="tb-setting-input" rows="6" placeholder="Enter your text..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text\',this.value)">' + this.escHtml(content.text || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'text\', \'text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                break;
            case 'heading':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Heading Text</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.text || '') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'heading\', \'text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Heading Level</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'tag\',this.value)"><option value="h1"' + (content.tag === 'h1' ? ' selected' : '') + '>H1</option><option value="h2"' + (content.tag === 'h2' || !content.tag ? ' selected' : '') + '>H2</option><option value="h3"' + (content.tag === 'h3' ? ' selected' : '') + '>H3</option><option value="h4"' + (content.tag === 'h4' ? ' selected' : '') + '>H4</option><option value="h5"' + (content.tag === 'h5' ? ' selected' : '') + '>H5</option><option value="h6"' + (content.tag === 'h6' ? ' selected' : '') + '>H6</option></select></div>';
                break;
            case 'image':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Image URL</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(content.src || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'src\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(function(url){TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'src\',url)})">ğŸ“</button></div></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Alt Text</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.alt || '') + '" placeholder="Describe the image" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'alt\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Link URL</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.link_url || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'link_url\',this.value)"></div>';
                break;
            case 'button':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.text || '') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'button\', \'text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Link URL</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.url || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'url\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="primary"' + (content.style === 'primary' || !content.style ? ' selected' : '') + '>Primary</option><option value="secondary"' + (content.style === 'secondary' ? ' selected' : '') + '>Secondary</option><option value="outline"' + (content.style === 'outline' ? ' selected' : '') + '>Outline</option><option value="ghost"' + (content.style === 'ghost' ? ' selected' : '') + '>Ghost</option></select></div>';
                break;
            case 'divider':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Line Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="solid"' + (content.style === 'solid' || !content.style ? ' selected' : '') + '>Solid</option><option value="dashed"' + (content.style === 'dashed' ? ' selected' : '') + '>Dashed</option><option value="dotted"' + (content.style === 'dotted' ? ' selected' : '') + '>Dotted</option></select></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Color</div><div style="display:flex;gap:8px;align-items:center"><input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (content.color || '#cccccc') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'color\',this.value)"><input type="text" class="tb-setting-input" style="flex:1" value="' + (content.color || '#cccccc') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'color\',this.value)"></div></div>';
                break;
            case 'spacer':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Height</div><input type="text" class="tb-setting-input" value="' + (content.height || '40px') + '" placeholder="e.g., 40px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'height\',this.value)"></div>';
                break;
            case 'video':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Video URL</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.url || '') + '" placeholder="YouTube or Vimeo URL" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'url\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'autoplay\',this.value===\'true\')"><option value="false"' + (!content.autoplay ? ' selected' : '') + '>No</option><option value="true"' + (content.autoplay ? ' selected' : '') + '>Yes</option></select></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Loop</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'loop\',this.value===\'true\')"><option value="false"' + (!content.loop ? ' selected' : '') + '>No</option><option value="true"' + (content.loop ? ' selected' : '') + '>Yes</option></select></div>';
                break;
            case 'cta':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.title || '') + '" placeholder="Call to Action Title" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'cta_title\', \'title\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Subtitle</div><textarea class="tb-setting-input" rows="2" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'subtitle\',this.value)">' + this.escHtml(content.subtitle || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'cta_subtitle\', \'subtitle\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.button_text || 'Get Started') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'cta_button\', \'button_text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Button URL</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.button_url || '#') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_url\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Background Image</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(content.background || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(function(url){TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background\',url)})">ğŸ“</button></div></div>';
                break;
            case 'hero':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.title || '') + '" placeholder="Welcome to Our Site" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'hero_title\', \'title\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Subtitle</div><textarea class="tb-setting-input" rows="2" placeholder="We build amazing experiences" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'subtitle\',this.value)">' + this.escHtml(content.subtitle || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'hero_subtitle\', \'subtitle\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.button_text || '') + '" placeholder="Get Started" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Button URL</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.button_url || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_url\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Background Image</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(content.background || '') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(function(url){TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'background\',url)})">ğŸ“</button></div></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Alignment</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'alignment\',this.value)"><option value="left"' + (content.alignment === 'left' ? ' selected' : '') + '>Left</option><option value="center"' + (content.alignment === 'center' || !content.alignment ? ' selected' : '') + '>Center</option><option value="right"' + (content.alignment === 'right' ? ' selected' : '') + '>Right</option></select></div>';
                break;
            case 'testimonial':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Quote Text</div><textarea class="tb-setting-input" rows="4" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text\',this.value)">' + this.escHtml(content.text || content.quote || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'testimonial\', \'text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate Testimonial</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Author Name</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.author || '') + '" placeholder="John Doe" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'author\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Author Role/Title</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.role || content.position || '') + '" placeholder="CEO, Company" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'role\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Avatar URL</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(content.avatar || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'avatar\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(function(url){TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'avatar\',url)})">ğŸ“</button></div></div>';
                break;
            case 'quote':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Quote Text</div><textarea class="tb-setting-input" rows="4" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'text\',this.value)">' + this.escHtml(content.text || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'quote\', \'text\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Author</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.author || '') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'author\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Source</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.source || '') + '" placeholder="Book, article, etc." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'source\',this.value)"></div>';
                break;
            case 'toggle':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Toggle Title</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.title || '') + '" placeholder="Click to expand" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'toggle_title\', \'title\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Content</div><textarea class="tb-setting-input" rows="4" placeholder="Hidden content goes here..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'content\',this.value)">' + this.escHtml(content.content || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'toggle_content\', \'content\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Open by Default</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'open\',this.value===\'true\')"><option value="false"' + (!content.open ? ' selected' : '') + '>Closed</option><option value="true"' + (content.open ? ' selected' : '') + '>Open</option></select></div>';
                break;
            case 'blurb':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.title || '') + '" placeholder="Your Title Here" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'blurb_title\', \'title\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Description</div><textarea class="tb-setting-input" rows="3" placeholder="Your description text..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'description\',this.value)">' + this.escHtml(content.description || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'blurb_text\', \'description\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Link URL (optional)</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.link_url || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'link_url\',this.value)"></div>';
                break;
            case 'pricing':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Plan Title</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.title || '') + '" placeholder="Basic, Pro, Enterprise..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Price</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.price || '') + '" placeholder="$29" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'price\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Period</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.period || '/month') + '" placeholder="/month, /year" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'period\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Highlighted</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'featured\',this.value===\'true\')"><option value="false"' + (!content.featured ? ' selected' : '') + '>No</option><option value="true"' + (content.featured ? ' selected' : '') + '>Yes (Featured)</option></select></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Features (one per line)</div><textarea class="tb-setting-input" rows="5" placeholder="Feature 1\nFeature 2\nFeature 3" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'features\',this.value)">' + this.escHtml(content.features || '') + '</textarea><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'pricing_features\', \'features\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate Features</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.button_text || 'Choose Plan') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Button URL</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.button_url || '#') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_url\',this.value)"></div>';
                break;
            case 'counter':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Number</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.number || '100') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'number\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Prefix</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.prefix || '') + '" placeholder="$, â‚¬, etc." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'prefix\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Suffix</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.suffix || '+') + '" placeholder="+, %, etc." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'suffix\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.title || '') + '" placeholder="Happy Clients" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"><button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'counter_title\', \'title\', ' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ', this)">âœ¨ AI Generate</button></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Animation Duration (ms)</div><input type="number" class="tb-setting-input" value="' + (content.duration || '2000') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'duration\',this.value)"></div>';
                break;
            case 'icon':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Icon</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.icon || 'fa:star') + '" placeholder="fa:star or emoji" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'icon\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Size</div><input type="text" class="tb-setting-input" value="' + (content.size || '48px') + '" placeholder="e.g., 48px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'size\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Color</div><div style="display:flex;gap:8px;align-items:center"><input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (content.color || '#333333') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'color\',this.value)"><input type="text" class="tb-setting-input" style="flex:1" value="' + (content.color || '#333333') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'color\',this.value)"></div></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Link URL</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.link_url || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'link_url\',this.value)"></div>';
                break;
            case 'html':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Custom HTML</div><textarea class="tb-setting-input" rows="8" style="font-family:monospace;font-size:12px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'code\',this.value)">' + this.escHtml(content.code || content.html || '') + '</textarea></div>';
                break;
            case 'code':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Language</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'language\',this.value)"><option value="javascript"' + (content.language === 'javascript' || !content.language ? ' selected' : '') + '>JavaScript</option><option value="php"' + (content.language === 'php' ? ' selected' : '') + '>PHP</option><option value="python"' + (content.language === 'python' ? ' selected' : '') + '>Python</option><option value="html"' + (content.language === 'html' ? ' selected' : '') + '>HTML</option><option value="css"' + (content.language === 'css' ? ' selected' : '') + '>CSS</option><option value="sql"' + (content.language === 'sql' ? ' selected' : '') + '>SQL</option><option value="bash"' + (content.language === 'bash' ? ' selected' : '') + '>Bash</option></select></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Code</div><textarea class="tb-setting-input" rows="8" style="font-family:monospace;font-size:12px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'code\',this.value)">' + this.escHtml(content.code || '') + '</textarea></div>';
                break;
            case 'map':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Address</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.address || '') + '" placeholder="123 Main St, City, Country" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'address\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Latitude</div><input type="number" step="any" class="tb-setting-input" value="' + (content.lat || 0) + '" placeholder="e.g., 40.7128" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'lat\',parseFloat(this.value)||0)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Longitude</div><input type="number" step="any" class="tb-setting-input" value="' + (content.lng || 0) + '" placeholder="e.g., -74.0060" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'lng\',parseFloat(this.value)||0)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Zoom Level</div><input type="range" class="tb-setting-input" min="1" max="18" value="' + (content.zoom || 14) + '" oninput="this.nextElementSibling.textContent=this.value" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'zoom\',parseInt(this.value))"><span style="display:block;text-align:center;margin-top:4px">' + (content.zoom || 14) + '</span></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Height</div><input type="text" class="tb-setting-input" value="' + (content.height || '300px') + '" placeholder="e.g., 300px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'height\',this.value)"></div>';
                break;
            case 'logo':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Logo Image</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(content.image || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'image\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(function(url){TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'image\',url)})">ğŸ“</button></div></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Alt Text</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.image_alt || 'Logo') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'image_alt\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Link URL</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.link_url || '/') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'link_url\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Max Height</div><input type="text" class="tb-setting-input" value="' + (content.max_height || '60px') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'max_height\',this.value)"></div>';
                break;
            case 'menu':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Menu Logo</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(content.logo || '') + '" placeholder="https://..." onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'logo\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(function(url){TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'logo\',url)})">ğŸ“</button></div></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Menu Source</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'menu_source\',this.value)"><option value="custom"' + (content.menu_source === 'custom' || !content.menu_source ? ' selected' : '') + '>Custom</option><option value="cms"' + (content.menu_source === 'cms' ? ' selected' : '') + '>CMS Menu</option></select></div>';
                break;
            case 'social':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="icons"' + (content.style === 'icons' || !content.style ? ' selected' : '') + '>Icons Only</option><option value="icons-text"' + (content.style === 'icons-text' ? ' selected' : '') + '>Icons + Text</option><option value="text"' + (content.style === 'text' ? ' selected' : '') + '>Text Only</option></select></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Size</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'size\',this.value)"><option value="small"' + (content.size === 'small' ? ' selected' : '') + '>Small</option><option value="medium"' + (content.size === 'medium' || !content.size ? ' selected' : '') + '>Medium</option><option value="large"' + (content.size === 'large' ? ' selected' : '') + '>Large</option></select></div>';
                break;
            case 'search':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Placeholder</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.placeholder || 'Search...') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'placeholder\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.button_text || 'Search') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Show Button</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'show_button\',this.value===\'true\')"><option value="true"' + (content.show_button !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.show_button === false ? ' selected' : '') + '>No</option></select></div>';
                break;
            case 'accordion':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Allow Multiple Open</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'multiple\',this.value===\'true\')"><option value="false"' + (!content.multiple ? ' selected' : '') + '>Single</option><option value="true"' + (content.multiple ? ' selected' : '') + '>Multiple</option></select></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Accordion Items</div></div>';
                var accordionItems = content.items || [];
                for (var i = 0; i < accordionItems.length; i++) {
                    html += '<div style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:6px;padding:12px;margin-bottom:8px;">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:500">Item ' + (i + 1) + '</span><button class="tb-btn" style="padding:4px 8px;background:var(--tb-danger);color:#fff" onclick="TB.removeAccordionItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ')">Ã—</button></div>';
                    html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escHtml(accordionItems[i].title || '') + '" onchange="TB.updateAccordionItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'title\',this.value)"></div>';
                    html += '<div class="tb-setting-group" style="margin-bottom:0"><div class="tb-setting-label">Content</div><textarea class="tb-setting-input" rows="3" onchange="TB.updateAccordionItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'content\',this.value)">' + this.escHtml(accordionItems[i].content || '') + '</textarea></div>';
                    html += '</div>';
                }
                html += '<button class="tb-btn" style="width:100%" onclick="TB.addAccordionItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Item</button>';
                html += '<div class="tb-setting-group" style="margin-top:16px"><div class="tb-setting-label">Open by Default</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'open_by_default\',this.value===\'true\')"><option value="false"' + (!content.open_by_default ? ' selected' : '') + '>Closed</option><option value="true"' + (content.open_by_default ? ' selected' : '') + '>Open</option></select></div>';
                break;
            case 'tabs':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Tab Style</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'style\',this.value)"><option value="horizontal"' + (content.style === 'horizontal' || !content.style ? ' selected' : '') + '>Horizontal</option><option value="vertical"' + (content.style === 'vertical' ? ' selected' : '') + '>Vertical</option></select></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Tabs</div></div>';
                var tabItems = content.tabs || [];
                for (var i = 0; i < tabItems.length; i++) {
                    html += '<div style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:6px;padding:12px;margin-bottom:8px;">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:500">Tab ' + (i + 1) + '</span><button class="tb-btn" style="padding:4px 8px;background:var(--tb-danger);color:#fff" onclick="TB.removeTab(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ')">Ã—</button></div>';
                    html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escHtml(tabItems[i].title || '') + '" onchange="TB.updateTab(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'title\',this.value)"></div>';
                    html += '<div class="tb-setting-group" style="margin-bottom:0"><div class="tb-setting-label">Content</div><textarea class="tb-setting-input" rows="3" onchange="TB.updateTab(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'content\',this.value)">' + this.escHtml(tabItems[i].content || '') + '</textarea></div>';
                    html += '</div>';
                }
                html += '<button class="tb-btn" style="width:100%" onclick="TB.addTab(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Tab</button>';
                break;
            case 'gallery':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Columns</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'columns\',parseInt(this.value))">';
                for (var c = 2; c <= 6; c++) {
                    html += '<option value="' + c + '"' + (content.columns === c ? ' selected' : '') + '>' + c + ' Columns</option>';
                }
                html += '</select></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Gap</div><input type="text" class="tb-setting-input" value="' + (content.gap || '10px') + '" placeholder="e.g., 10px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'gap\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Lightbox</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'lightbox\',this.value===\'true\')"><option value="true"' + (content.lightbox !== false ? ' selected' : '') + '>Enabled</option><option value="false"' + (content.lightbox === false ? ' selected' : '') + '>Disabled</option></select></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Gallery Images</div></div>';
                var galleryImages = content.images || [];
                for (var i = 0; i < galleryImages.length; i++) {
                    html += '<div style="display:flex;gap:4px;margin-bottom:8px;align-items:center;">';
                    if (galleryImages[i].src) html += '<img src="' + this.escHtml(galleryImages[i].src) + '" style="width:40px;height:40px;object-fit:cover;border-radius:4px;flex:0 0 40px">';
                    html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(galleryImages[i].src || '') + '" placeholder="Image URL" onchange="TB.updateGalleryImage(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'src\',this.value)">';
                    html += '<button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(function(url){TB.updateGalleryImage(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'src\',url)})">ğŸ“</button>';
                    html += '<button class="tb-btn" style="padding:4px 8px;background:var(--tb-danger);color:#fff" onclick="TB.removeGalleryImage(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ')">Ã—</button>';
                    html += '</div>';
                }
                html += '<button class="tb-btn" style="width:100%" onclick="TB.addGalleryImage(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Image</button>';
                break;
            case 'slider':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Min Height</div><input type="text" class="tb-setting-input" value="' + (content.min_height || '400px') + '" placeholder="e.g., 400px" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'min_height\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'autoplay\',this.value===\'true\')"><option value="true"' + (content.autoplay !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (content.autoplay === false ? ' selected' : '') + '>No</option></select></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Autoplay Speed (ms)</div><input type="number" class="tb-setting-input" value="' + (content.autoplay_speed || 5000) + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'autoplay_speed\',parseInt(this.value))"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Slides</div></div>';
                var slides = content.slides || [];
                for (var i = 0; i < slides.length; i++) {
                    html += '<div style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:6px;padding:12px;margin-bottom:8px;">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:500">Slide ' + (i + 1) + '</span><button class="tb-btn" style="padding:4px 8px;background:var(--tb-danger);color:#fff" onclick="TB.removeSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ')">Ã—</button></div>';
                    html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Title</div><input type="text" class="tb-setting-input" value="' + this.escHtml(slides[i].title || '') + '" onchange="TB.updateSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'title\',this.value)"></div>';
                    html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Text</div><textarea class="tb-setting-input" rows="2" onchange="TB.updateSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'text\',this.value)">' + this.escHtml(slides[i].text || '') + '</textarea></div>';
                    html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Image</div><div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(slides[i].image || '') + '" onchange="TB.updateSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'image\',this.value)"><button type="button" class="tb-btn-media" onclick="TB.openMediaGallery(function(url){TB.updateSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'image\',url)})">ğŸ“</button></div></div>';
                    html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Button Text</div><input type="text" class="tb-setting-input" value="' + this.escHtml(slides[i].button_text || '') + '" onchange="TB.updateSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'button_text\',this.value)"></div>';
                    html += '<div class="tb-setting-group" style="margin-bottom:0"><div class="tb-setting-label">Button URL</div><input type="text" class="tb-setting-input" value="' + this.escHtml(slides[i].button_url || '') + '" onchange="TB.updateSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'button_url\',this.value)"></div>';
                    html += '</div>';
                }
                html += '<button class="tb-btn" style="width:100%" onclick="TB.addSlide(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Slide</button>';
                break;
            case 'form':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Form Title</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.title || 'Get In Touch') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'title\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Submit Button Text</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.button_text || 'Submit') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'button_text\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Success Message</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.success_message || 'Thank you for your submission!') + '" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'success_message\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Form Action URL</div><input type="text" class="tb-setting-input" value="' + this.escHtml(content.action_url || '') + '" placeholder="Leave empty for AJAX" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'action_url\',this.value)"></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Form Fields</div></div>';
                var formFields = content.fields || [];
                for (var i = 0; i < formFields.length; i++) {
                    html += '<div style="background:var(--tb-surface-2);border:1px solid var(--tb-border);border-radius:6px;padding:12px;margin-bottom:8px;">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:500">' + this.escHtml(formFields[i].label || 'Field ' + (i + 1)) + '</span><button class="tb-btn" style="padding:4px 8px;background:var(--tb-danger);color:#fff" onclick="TB.removeFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ')">Ã—</button></div>';
                    html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Label</div><input type="text" class="tb-setting-input" value="' + this.escHtml(formFields[i].label || '') + '" onchange="TB.updateFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'label\',this.value)"></div>';
                    html += '<div class="tb-setting-group" style="margin-bottom:8px"><div class="tb-setting-label">Type</div><select class="tb-setting-input" onchange="TB.updateFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'type\',this.value)"><option value="text"' + (formFields[i].type === 'text' || !formFields[i].type ? ' selected' : '') + '>Text</option><option value="email"' + (formFields[i].type === 'email' ? ' selected' : '') + '>Email</option><option value="tel"' + (formFields[i].type === 'tel' ? ' selected' : '') + '>Phone</option><option value="textarea"' + (formFields[i].type === 'textarea' ? ' selected' : '') + '>Textarea</option><option value="select"' + (formFields[i].type === 'select' ? ' selected' : '') + '>Select</option></select></div>';
                    html += '<div class="tb-setting-group" style="margin-bottom:0"><div class="tb-setting-label">Required</div><select class="tb-setting-input" onchange="TB.updateFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',\'required\',this.value===\'true\')"><option value="false"' + (!formFields[i].required ? ' selected' : '') + '>No</option><option value="true"' + (formFields[i].required ? ' selected' : '') + '>Yes</option></select></div>';
                    html += '</div>';
                }
                html += '<button class="tb-btn" style="width:100%" onclick="TB.addFormField(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Field</button>';
                break;
            case 'list':
                html += '<div class="tb-setting-group"><div class="tb-setting-label">List Type</div><select class="tb-setting-input" onchange="TB.updateModuleContent(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',\'type\',this.value)"><option value="unordered"' + (content.type === 'unordered' || !content.type ? ' selected' : '') + '>Unordered (Bullets)</option><option value="ordered"' + (content.type === 'ordered' ? ' selected' : '') + '>Ordered (Numbers)</option><option value="icon"' + (content.type === 'icon' ? ' selected' : '') + '>Icon List</option></select></div>';
                html += '<div class="tb-setting-group"><div class="tb-setting-label">List Items</div></div>';
                var listItems = content.items || [];
                for (var i = 0; i < listItems.length; i++) {
                    html += '<div style="display:flex;gap:4px;margin-bottom:8px;align-items:center;">';
                    html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(listItems[i]) + '" onchange="TB.updateListItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',this.value)">';
                    html += '<button class="tb-btn" style="padding:4px 8px" onclick="TB.moveListItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',-1)">â†‘</button>';
                    html += '<button class="tb-btn" style="padding:4px 8px" onclick="TB.moveListItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ',1)">â†“</button>';
                    html += '<button class="tb-btn" style="padding:4px 8px;background:var(--tb-danger);color:#fff" onclick="TB.removeListItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ',' + i + ')">Ã—</button>';
                    html += '</div>';
                }
                html += '<button class="tb-btn" style="width:100%" onclick="TB.addListItem(' + sIdx + ',' + rIdx + ',' + cIdx + ',' + mIdx + ')">+ Add Item</button>';
                break;
            default:
                html += '<div class="tb-setting-group"><div class="tb-setting-label" style="color:var(--tb-text-muted)">Configure ' + mod.type + ' module settings in Design tab</div></div>';
        }

        return html;
    },

    // Update module content with full path (like edit.php)
    updateModuleContent: function(sIdx, rIdx, cIdx, mIdx, field, value) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod) return;
        if (!mod.content) mod.content = {};
        mod.content[field] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderElementSettings();
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LIST ITEM MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    addListItem: function(sIdx, rIdx, cIdx, mIdx) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod) return;
        if (!mod.content.items) mod.content.items = [];
        mod.content.items.push('New Item');
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    removeListItem: function(sIdx, rIdx, cIdx, mIdx, itemIdx) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.items) return;
        mod.content.items.splice(itemIdx, 1);
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    updateListItem: function(sIdx, rIdx, cIdx, mIdx, itemIdx, value) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.items) return;
        mod.content.items[itemIdx] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
    },

    moveListItem: function(sIdx, rIdx, cIdx, mIdx, itemIdx, dir) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.items) return;
        var newIdx = itemIdx + dir;
        if (newIdx < 0 || newIdx >= mod.content.items.length) return;
        var temp = mod.content.items[itemIdx];
        mod.content.items[itemIdx] = mod.content.items[newIdx];
        mod.content.items[newIdx] = temp;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ACCORDION ITEM MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    addAccordionItem: function(sIdx, rIdx, cIdx, mIdx) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod) return;
        if (!mod.content.items) mod.content.items = [];
        mod.content.items.push({ title: 'New Item', content: '' });
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    removeAccordionItem: function(sIdx, rIdx, cIdx, mIdx, itemIdx) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.items || mod.content.items.length <= 1) {
            this.toast('Accordion must have at least one item', 'error');
            return;
        }
        mod.content.items.splice(itemIdx, 1);
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    updateAccordionItem: function(sIdx, rIdx, cIdx, mIdx, itemIdx, field, value) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.items) return;
        mod.content.items[itemIdx][field] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    addTab: function(sIdx, rIdx, cIdx, mIdx) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod) return;
        if (!mod.content.tabs) mod.content.tabs = [];
        mod.content.tabs.push({ title: 'New Tab', content: '' });
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    removeTab: function(sIdx, rIdx, cIdx, mIdx, tabIdx) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.tabs || mod.content.tabs.length <= 1) {
            this.toast('Tabs must have at least one tab', 'error');
            return;
        }
        mod.content.tabs.splice(tabIdx, 1);
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    updateTab: function(sIdx, rIdx, cIdx, mIdx, tabIdx, field, value) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.tabs) return;
        mod.content.tabs[tabIdx][field] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GALLERY IMAGE MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    addGalleryImage: function(sIdx, rIdx, cIdx, mIdx) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod) return;
        if (!mod.content.images) mod.content.images = [];
        mod.content.images.push({ src: '', alt: '' });
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    removeGalleryImage: function(sIdx, rIdx, cIdx, mIdx, imgIdx) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.images) return;
        mod.content.images.splice(imgIdx, 1);
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    updateGalleryImage: function(sIdx, rIdx, cIdx, mIdx, imgIdx, field, value) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.images) return;
        mod.content.images[imgIdx][field] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SLIDER SLIDE MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    addSlide: function(sIdx, rIdx, cIdx, mIdx) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod) return;
        if (!mod.content.slides) mod.content.slides = [];
        mod.content.slides.push({ title: 'New Slide', text: '', image: '', button_text: '', button_url: '' });
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    removeSlide: function(sIdx, rIdx, cIdx, mIdx, slideIdx) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.slides || mod.content.slides.length <= 1) {
            this.toast('Slider must have at least one slide', 'error');
            return;
        }
        mod.content.slides.splice(slideIdx, 1);
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    updateSlide: function(sIdx, rIdx, cIdx, mIdx, slideIdx, field, value) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.slides) return;
        mod.content.slides[slideIdx][field] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FORM FIELD MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    addFormField: function(sIdx, rIdx, cIdx, mIdx) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod) return;
        if (!mod.content.fields) mod.content.fields = [];
        mod.content.fields.push({ label: 'New Field', type: 'text', required: false });
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    removeFormField: function(sIdx, rIdx, cIdx, mIdx, fieldIdx) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.fields) return;
        mod.content.fields.splice(fieldIdx, 1);
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.selectModule(sIdx, rIdx, cIdx, mIdx);
    },

    updateFormField: function(sIdx, rIdx, cIdx, mIdx, fieldIdx, field, value) {
        var mod = this.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
        if (!mod || !mod.content.fields) return;
        mod.content.fields[fieldIdx][field] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MODULE TAB & DEVICE SWITCHING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    setModuleTab: function(tab) {
        this.currentModuleTab = tab;
        document.querySelectorAll('.tb-module-tab').forEach(function(el) {
            el.classList.toggle('active', el.dataset.mtab === tab);
        });
        this.renderElementSettings();
    },

    setDevice: function(device) {
        this.currentDevice = device;
        document.querySelectorAll('.tb-device-btn').forEach(function(el) {
            el.classList.toggle('active', el.dataset.device === device);
        });
        // Could trigger canvas resize preview here
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DESIGN SETTINGS (Full Design Panel with State Toggle, Hover, Filters)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Current editing state (normal or hover)
    currentState: 'normal',
    collapsedSections: {}, // Track which sections are collapsed

    saveCollapsedState: function() {
        var sections = document.querySelectorAll('.tb-design-section');
        var self = this;
        self.collapsedSections = {};
        sections.forEach(function(section, idx) {
            var header = section.querySelector('.tb-design-section-header span');
            var key = header ? header.textContent.trim() : 'section_' + idx;
            self.collapsedSections[key] = section.classList.contains('collapsed');
        });
    },

    restoreCollapsedState: function() {
        var sections = document.querySelectorAll('.tb-design-section');
        var self = this;
        sections.forEach(function(section, idx) {
            var header = section.querySelector('.tb-design-section-header span');
            var key = header ? header.textContent.trim() : 'section_' + idx;
            if (self.collapsedSections[key] === true) {
                section.classList.add('collapsed');
            } else if (self.collapsedSections[key] === false) {
                section.classList.remove('collapsed');
            }
        });
    },
    hoverPreviewActive: false,
    hoverUpdateTimer: null,

    renderDesignSettings: function() {
        console.log('[TB] renderDesignSettings() called - Full Design Panel with Hover & Filters');
        var container = document.getElementById('moduleSettingsPanel');
        var mod = this.selectedModule.module;
        var d = mod.design || {};
        var type = mod.type || 'text';
        var self = this;

        // Text-based modules that support typography
        var textModules = ['text', 'heading', 'button', 'quote', 'cta', 'pricing', 'blurb', 'hero', 'testimonial', 'team', 'countdown', 'counter', 'list', 'menu', 'slider', 'toggle', 'bar_counters', 'video_slider', 'post_slider', 'post_title', 'circle_counter', 'search', 'comments'];
        var hasTypography = textModules.indexOf(type) !== -1;

        // Check if module has any hover properties set
        var hasHoverValues = d.hover_enabled || d.text_color_hover ||
            d.background_color_hover || d.border_color_hover ||
            d.transform_scale_hover || d.transform_translate_y_hover ||
            d.opacity_hover || d.box_shadow_hover_enabled ||
            d.filter_hover_enabled;

        var html = '<h3 style="margin-bottom:16px">ğŸ¨ Design Settings</h3>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATE TOGGLE UI (Normal / Hover) - CRITICAL FEATURE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-state-toggle">';
        html += '<button type="button" class="tb-state-btn' + (this.currentState === 'normal' ? ' active' : '') + '" onclick="TB.setState(\'normal\')">';
        html += '<span class="tb-state-indicator">â—</span> Normal';
        html += '</button>';
        html += '<button type="button" class="tb-state-btn' + (this.currentState === 'hover' ? ' active hover-state' : '') + '" onclick="TB.setState(\'hover\')">';
        html += '<span class="tb-state-indicator">ğŸ‘†</span> Hover';
        if (hasHoverValues) html += '<span class="tb-hover-badge">âœ“</span>';
        html += '</button>';
        html += '</div>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TYPOGRAPHY SECTION (Module-specific)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (hasTypography) {
            html += '<div class="tb-design-section">';
            html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ”¤ Typography</span><span class="tb-design-section-toggle">â–¼</span></div>';
            html += '<div class="tb-design-section-body">';

            // Module-specific typography sections
            switch (type) {
                case 'heading':
                    html += this.renderTypographySettings('title', 'Heading');
                    break;
                case 'text':
                    html += this.renderTypographySettings('body', 'Body Text');
                    break;
                case 'button':
                    html += this.renderTypographySettings('button', 'Button');
                    break;
                case 'quote':
                    html += this.renderTypographySettings('quote', 'Quote');
                    html += this.renderTypographySettings('author', 'Author');
                    break;
                case 'cta':
                    html += this.renderTypographySettings('title', 'Title');
                    html += this.renderTypographySettings('subtitle', 'Subtitle');
                    html += this.renderTypographySettings('button', 'Button');
                    break;
                case 'blurb':
                    html += this.renderTypographySettings('title', 'Title');
                    html += this.renderTypographySettings('text', 'Description');
                    break;
                case 'hero':
                    html += this.renderTypographySettings('title', 'Title');
                    html += this.renderTypographySettings('subtitle', 'Subtitle');
                    html += this.renderTypographySettings('button', 'Buttons');
                    break;
                case 'testimonial':
                    html += this.renderTypographySettings('quote', 'Quote');
                    html += this.renderTypographySettings('author', 'Author');
                    html += this.renderTypographySettings('role', 'Role/Title');
                    break;
                case 'pricing':
                    html += this.renderTypographySettings('title', 'Plan Title');
                    html += this.renderTypographySettings('price', 'Price');
                    html += this.renderTypographySettings('features', 'Features');
                    html += this.renderTypographySettings('button', 'Button');
                    break;
                case 'team':
                    html += this.renderTypographySettings('name', 'Name');
                    html += this.renderTypographySettings('role', 'Role');
                    html += this.renderTypographySettings('bio', 'Bio');
                    break;
                case 'counter':
                    html += this.renderTypographySettings('number', 'Number');
                    html += this.renderTypographySettings('title', 'Title');
                    break;
                case 'countdown':
                    html += this.renderTypographySettings('title', 'Title');
                    html += this.renderTypographySettings('number', 'Numbers');
                    html += this.renderTypographySettings('label', 'Labels');
                    break;
                case 'list':
                    html += this.renderTypographySettings('item', 'List Items');
                    break;
                case 'menu':
                    html += this.renderTypographySettings('link', 'Menu Links');
                    break;
                case 'slider':
                    html += this.renderTypographySettings('title', 'Slide Title');
                    html += this.renderTypographySettings('text', 'Slide Text');
                    html += this.renderTypographySettings('button', 'Slide Button');
                    break;
                case 'post_slider':
                    html += this.renderTypographySettings('title', 'Post Title');
                    html += this.renderTypographySettings('meta', 'Meta (Date/Author)');
                    html += this.renderTypographySettings('excerpt', 'Excerpt');
                    html += this.renderTypographySettings('button', 'Read More');
                    break;
                case 'post_title':
                    html += this.renderTypographySettings('title', 'Title');
                    html += this.renderTypographySettings('meta', 'Meta');
                    break;
                case 'toggle':
                    html += this.renderTypographySettings('title', 'Toggle Title');
                    html += this.renderTypographySettings('content', 'Toggle Content');
                    break;
                case 'bar_counters':
                    html += this.renderTypographySettings('label', 'Labels');
                    html += this.renderTypographySettings('percent', 'Percentages');
                    break;
                case 'circle_counter':
                    html += this.renderTypographySettings('number', 'Number');
                    html += this.renderTypographySettings('title', 'Title');
                    break;
                case 'search':
                    html += this.renderTypographySettings('input', 'Input Text');
                    html += this.renderTypographySettings('button', 'Button');
                    break;
                case 'comments':
                    html += this.renderTypographySettings('title', 'Section Title');
                    html += this.renderTypographySettings('author', 'Author Name');
                    html += this.renderTypographySettings('text', 'Comment Text');
                    html += this.renderTypographySettings('button', 'Submit Button');
                    break;
                default:
                    html += this.renderTypographySettings('default', 'Text');
            }

            html += '</div></div>';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // POST_CONTENT MODULE - Content Styling Settings
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (type === 'post_content') {
            var c = mod.content || {};
            html += '<div class="tb-design-section">';
            html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ“„ Content Styling</span><span class="tb-design-section-toggle">â–¼</span></div>';
            html += '<div class="tb-design-section-body">';

            // Max Width
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Max Width</div><input type="text" class="tb-setting-input" value="' + this.escHtml(c.max_width || '800px') + '" placeholder="800px" onchange="TB.updateContent(\'max_width\',this.value)"><div style="font-size:11px;color:var(--tb-text-muted);margin-top:4px">Controls content width for readability</div></div>';

            // Text Color
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Text Color</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.text_color || '#1e293b') + '" onchange="TB.updateContent(\'text_color\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.text_color || '#1e293b') + '" placeholder="#1e293b" onchange="TB.updateContent(\'text_color\',this.value)">';
            html += '</div></div>';

            // Font Size
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Font Size</div><input type="text" class="tb-setting-input" value="' + this.escHtml(c.font_size || '18px') + '" placeholder="18px" onchange="TB.updateContent(\'font_size\',this.value)"></div>';

            // Line Height
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Line Height</div><input type="text" class="tb-setting-input" value="' + this.escHtml(c.line_height || '1.8') + '" placeholder="1.8" onchange="TB.updateContent(\'line_height\',this.value)"></div>';

            // Paragraph Spacing
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Paragraph Spacing</div><input type="text" class="tb-setting-input" value="' + this.escHtml(c.paragraph_spacing || '1.5em') + '" placeholder="1.5em" onchange="TB.updateContent(\'paragraph_spacing\',this.value)"></div>';

            // Heading Color
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Heading Color (h2-h6)</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.heading_color || '#0f172a') + '" onchange="TB.updateContent(\'heading_color\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.heading_color || '#0f172a') + '" placeholder="#0f172a" onchange="TB.updateContent(\'heading_color\',this.value)">';
            html += '</div></div>';

            // Link Colors Section
            html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Link Colors</div></div>';

            // Link Color
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Link Color</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.link_color || '#0073e6') + '" onchange="TB.updateContent(\'link_color\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.link_color || '#0073e6') + '" placeholder="#0073e6" onchange="TB.updateContent(\'link_color\',this.value)">';
            html += '</div></div>';

            // Link Hover Color
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Link Hover Color</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.link_hover_color || '#0056b3') + '" onchange="TB.updateContent(\'link_hover_color\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.link_hover_color || '#0056b3') + '" placeholder="#0056b3" onchange="TB.updateContent(\'link_hover_color\',this.value)">';
            html += '</div></div>';

            // Images Section
            html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Images</div></div>';

            // Image Border Radius
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Image Border Radius</div><input type="text" class="tb-setting-input" value="' + this.escHtml(c.image_border_radius || '8px') + '" placeholder="8px" onchange="TB.updateContent(\'image_border_radius\',this.value)"></div>';

            // Blockquote Section
            html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Blockquotes</div></div>';

            // Blockquote Style
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Blockquote Style</div><select class="tb-setting-input" onchange="TB.updateContent(\'blockquote_style\',this.value)">';
            html += '<option value="border"' + (c.blockquote_style === 'border' || !c.blockquote_style ? ' selected' : '') + '>Border (left line)</option>';
            html += '<option value="background"' + (c.blockquote_style === 'background' ? ' selected' : '') + '>Background</option>';
            html += '<option value="italic"' + (c.blockquote_style === 'italic' ? ' selected' : '') + '>Italic (minimal)</option></select></div>';

            // Blockquote Border/Background Color
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Blockquote Accent Color</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.blockquote_border_color || '#0073e6') + '" onchange="TB.updateContent(\'blockquote_border_color\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.blockquote_border_color || '#0073e6') + '" placeholder="#0073e6" onchange="TB.updateContent(\'blockquote_border_color\',this.value)">';
            html += '</div></div>';

            // Code Section
            html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Code Blocks</div></div>';

            // Code Background
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Code Background</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.code_background || '#f1f5f9') + '" onchange="TB.updateContent(\'code_background\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.code_background || '#f1f5f9') + '" placeholder="#f1f5f9" onchange="TB.updateContent(\'code_background\',this.value)">';
            html += '</div></div>';

            // Code Text Color
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Code Text Color</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.code_text_color || '#e11d48') + '" onchange="TB.updateContent(\'code_text_color\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.code_text_color || '#e11d48') + '" placeholder="#e11d48" onchange="TB.updateContent(\'code_text_color\',this.value)">';
            html += '</div></div>';

            // Lists Section
            html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Lists</div></div>';

            // List Style
            html += '<div class="tb-setting-group"><div class="tb-setting-label">List Marker Style</div><select class="tb-setting-input" onchange="TB.updateContent(\'list_style\',this.value)">';
            html += '<option value="disc"' + (c.list_style === 'disc' || !c.list_style ? ' selected' : '') + '>Disc (â€¢)</option>';
            html += '<option value="circle"' + (c.list_style === 'circle' ? ' selected' : '') + '>Circle (â—‹)</option>';
            html += '<option value="square"' + (c.list_style === 'square' ? ' selected' : '') + '>Square (â–ª)</option>';
            html += '<option value="check"' + (c.list_style === 'check' ? ' selected' : '') + '>Checkmark (âœ“)</option>';
            html += '<option value="arrow"' + (c.list_style === 'arrow' ? ' selected' : '') + '>Arrow (â†’)</option></select></div>';

            // Dropcap Section
            html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Dropcap</div></div>';

            // Dropcap Toggle
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Enable Dropcap</div><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ' + (c.dropcap ? 'checked' : '') + ' onchange="TB.updateContent(\'dropcap\',this.checked)"><span>Large decorative first letter</span></label></div>';

            // Dropcap Color (conditional)
            if (c.dropcap) {
                html += '<div class="tb-setting-group"><div class="tb-setting-label">Dropcap Color</div><div style="display:flex;gap:8px;align-items:center">';
                html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.dropcap_color || '#0073e6') + '" onchange="TB.updateContent(\'dropcap_color\',this.value)">';
                html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.dropcap_color || '#0073e6') + '" placeholder="#0073e6" onchange="TB.updateContent(\'dropcap_color\',this.value)">';
                html += '</div></div>';
            }

            html += '</div></div>';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // COMMENTS MODULE - Comments Styling Settings
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (type === 'comments') {
            var c = mod.content || {};
            html += '<div class="tb-design-section">';
            html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ’¬ Comments Styling</span><span class="tb-design-section-toggle">â–¼</span></div>';
            html += '<div class="tb-design-section-body">';

            // Style Preset
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Style</div><select class="tb-setting-input" onchange="TB.updateContent(\'style\',this.value)">';
            html += '<option value="default"' + (c.style === 'default' || !c.style ? ' selected' : '') + '>Default</option>';
            html += '<option value="card"' + (c.style === 'card' ? ' selected' : '') + '>Card</option>';
            html += '<option value="minimal"' + (c.style === 'minimal' ? ' selected' : '') + '>Minimal</option>';
            html += '<option value="threaded"' + (c.style === 'threaded' ? ' selected' : '') + '>Threaded</option></select></div>';

            // Comment Colors Section
            html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Comment Colors</div></div>';

            // Comment Background
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Comment Background</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.comment_background || '#f8fafc') + '" onchange="TB.updateContent(\'comment_background\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.comment_background || '#f8fafc') + '" placeholder="#f8fafc" onchange="TB.updateContent(\'comment_background\',this.value)">';
            html += '</div></div>';

            // Comment Border Color
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Comment Border Color</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.comment_border_color || '#e2e8f0') + '" onchange="TB.updateContent(\'comment_border_color\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.comment_border_color || '#e2e8f0') + '" placeholder="#e2e8f0" onchange="TB.updateContent(\'comment_border_color\',this.value)">';
            html += '</div></div>';

            // Author Color
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Author Name Color</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.author_color || '#1e293b') + '" onchange="TB.updateContent(\'author_color\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.author_color || '#1e293b') + '" placeholder="#1e293b" onchange="TB.updateContent(\'author_color\',this.value)">';
            html += '</div></div>';

            // Date Color
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Date Color</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.date_color || '#64748b') + '" onchange="TB.updateContent(\'date_color\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.date_color || '#64748b') + '" placeholder="#64748b" onchange="TB.updateContent(\'date_color\',this.value)">';
            html += '</div></div>';

            // Text Color
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Comment Text Color</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.text_color || '#374151') + '" onchange="TB.updateContent(\'text_color\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.text_color || '#374151') + '" placeholder="#374151" onchange="TB.updateContent(\'text_color\',this.value)">';
            html += '</div></div>';

            // Avatar Section
            html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Avatar</div></div>';

            // Avatar Border Radius
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Avatar Border Radius</div><input type="text" class="tb-setting-input" value="' + this.escHtml(c.avatar_radius || '50%') + '" placeholder="50%" onchange="TB.updateContent(\'avatar_radius\',this.value)"></div>';

            // Form Section
            html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Comment Form</div></div>';

            // Form Background
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Form Background</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.form_background || '#f8fafc') + '" onchange="TB.updateContent(\'form_background\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.form_background || '#f8fafc') + '" placeholder="#f8fafc" onchange="TB.updateContent(\'form_background\',this.value)">';
            html += '</div></div>';

            // Input Background
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Input Background</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.input_background || '#ffffff') + '" onchange="TB.updateContent(\'input_background\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.input_background || '#ffffff') + '" placeholder="#ffffff" onchange="TB.updateContent(\'input_background\',this.value)">';
            html += '</div></div>';

            // Input Border Color
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Input Border Color</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.input_border_color || '#e2e8f0') + '" onchange="TB.updateContent(\'input_border_color\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.input_border_color || '#e2e8f0') + '" placeholder="#e2e8f0" onchange="TB.updateContent(\'input_border_color\',this.value)">';
            html += '</div></div>';

            // Button Background
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Background</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.button_background || '#0073e6') + '" onchange="TB.updateContent(\'button_background\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.button_background || '#0073e6') + '" placeholder="#0073e6" onchange="TB.updateContent(\'button_background\',this.value)">';
            html += '</div></div>';

            // Button Text Color
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Button Text Color</div><div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (c.button_text_color || '#ffffff') + '" onchange="TB.updateContent(\'button_text_color\',this.value)">';
            html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + this.escHtml(c.button_text_color || '#ffffff') + '" placeholder="#ffffff" onchange="TB.updateContent(\'button_text_color\',this.value)">';
            html += '</div></div>';

            // Spacing Section
            html += '<div class="tb-setting-group" style="border-top:1px solid var(--tb-border);padding-top:12px;margin-top:12px"><div class="tb-setting-label" style="font-weight:600">Spacing</div></div>';

            // Reply Indent
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Reply Indent</div><input type="text" class="tb-setting-input" value="' + this.escHtml(c.reply_indent || '40px') + '" placeholder="40px" onchange="TB.updateContent(\'reply_indent\',this.value)"></div>';

            // Gap
            html += '<div class="tb-setting-group"><div class="tb-setting-label">Gap Between Comments</div><input type="text" class="tb-setting-input" value="' + this.escHtml(c.gap || '20px') + '" placeholder="20px" onchange="TB.updateContent(\'gap\',this.value)"></div>';

            html += '</div></div>';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SPACING SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-design-section">';
        html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ“ Spacing</span><span class="tb-design-section-toggle">â–¼</span></div>';
        html += '<div class="tb-design-section-body">' + this.renderCombinedSpacingBox() + '</div>';
        html += '</div>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BACKGROUND SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-design-section">';
        html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ¨ Background</span><span class="tb-design-section-toggle">â–¼</span></div>';
        html += '<div class="tb-design-section-body">';
        html += '<div class="tb-setting-group"><label class="tb-setting-label">Background Color</label>';
        html += '<div style="display:flex;gap:8px;align-items:center">';
        html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (d.backgroundColor || '#ffffff') + '" onchange="TB.updateDesign(\'backgroundColor\',this.value)">';
        html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + (d.backgroundColor || '') + '" placeholder="#ffffff or transparent" onchange="TB.updateDesign(\'backgroundColor\',this.value)">';
        html += '</div></div>';
        html += '</div></div>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LAYOUT SECTION (Text Alignment) - NEW
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-design-section collapsed">';
        html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ“ Layout</span><span class="tb-design-section-toggle">â–¼</span></div>';
        html += '<div class="tb-design-section-body">';
        html += '<div class="tb-setting-group"><div class="tb-setting-label">Text Alignment</div>';
        html += '<select class="tb-setting-input" onchange="TB.updateDesign(\'textAlign\',this.value)">';
        html += '<option value="">Default</option>';
        html += '<option value="left"' + (d.textAlign === 'left' ? ' selected' : '') + '>Left</option>';
        html += '<option value="center"' + (d.textAlign === 'center' ? ' selected' : '') + '>Center</option>';
        html += '<option value="right"' + (d.textAlign === 'right' ? ' selected' : '') + '>Right</option>';
        html += '<option value="justify"' + (d.textAlign === 'justify' ? ' selected' : '') + '>Justify</option>';
        html += '</select></div>';
        html += '</div></div>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BORDER SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-design-section collapsed">';
        html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ”² Border</span><span class="tb-design-section-toggle">â–¼</span></div>';
        html += '<div class="tb-design-section-body">';
        html += this.renderBorderSettings();
        html += '</div></div>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BOX SHADOW SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-design-section collapsed">';
        html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸŒ“ Box Shadow</span><span class="tb-design-section-toggle">â–¼</span></div>';
        html += '<div class="tb-design-section-body">';
        html += this.renderBoxShadowSettings();
        html += '</div></div>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HOVER EFFECTS SECTION - NEW
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-design-section collapsed">';
        html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ‘† Hover Effects</span>' + (hasHoverValues ? '<span class="tb-badge-active">Active</span>' : '') + '<span class="tb-design-section-toggle">â–¼</span></div>';
        html += '<div class="tb-design-section-body">';
        html += this.renderHoverEffectsSettings();
        html += '</div></div>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BACKGROUND IMAGE SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-design-section collapsed">';
        html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ–¼ï¸ Background Image</span><span class="tb-design-section-toggle">â–¼</span></div>';
        html += '<div class="tb-design-section-body">';
        html += '<div class="tb-setting-group"><label class="tb-setting-label">Image URL</label>';
        html += '<div style="display:flex;gap:8px"><input type="text" class="tb-setting-input" id="design_bg_image" style="flex:1" value="' + (d.background_image || '') + '" onchange="TB.updateDesign(\'background_image\',this.value)">';
        html += '<button type="button" class="tb-btn" onclick="TB.openMediaGallery(function(url){document.getElementById(\'design_bg_image\').value=url;TB.updateDesign(\'background_image\',url)})">ğŸ“·</button></div></div>';
        html += '<div class="tb-setting-group"><label class="tb-setting-label">Position</label>';
        html += '<select class="tb-setting-input" onchange="TB.updateDesign(\'background_position\',this.value)">';
        ['center center','top left','top center','top right','center left','center right','bottom left','bottom center','bottom right'].forEach(function(p) {
            html += '<option value="' + p + '"' + (d.background_position === p ? ' selected' : '') + '>' + p + '</option>';
        });
        html += '</select></div>';
        html += '<div class="tb-setting-group"><label class="tb-setting-label">Size</label>';
        html += '<select class="tb-setting-input" onchange="TB.updateDesign(\'background_size\',this.value)">';
        ['cover','contain','auto','100% 100%'].forEach(function(s) {
            html += '<option value="' + s + '"' + (d.background_size === s ? ' selected' : '') + '>' + s + '</option>';
        });
        html += '</select></div>';
        html += '<div class="tb-setting-group"><label class="tb-setting-label">Repeat</label>';
        html += '<select class="tb-setting-input" onchange="TB.updateDesign(\'background_repeat\',this.value)">';
        ['no-repeat','repeat','repeat-x','repeat-y'].forEach(function(r) {
            html += '<option value="' + r + '"' + (d.background_repeat === r ? ' selected' : '') + '>' + r + '</option>';
        });
        html += '</select></div>';
        html += '</div></div>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TRANSFORM SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-design-section collapsed">';
        html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ”„ Transform</span><span class="tb-design-section-toggle">â–¼</span></div>';
        html += '<div class="tb-design-section-body">';
        html += this.renderTransformSettings();
        html += '</div></div>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FILTERS SECTION - NEW
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-design-section collapsed">';
        html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ¨ Filters</span>' + (this.hasActiveFilters() ? '<span class="tb-badge-active">Active</span>' : '') + '<span class="tb-design-section-toggle">â–¼</span></div>';
        html += '<div class="tb-design-section-body">';
        html += this.renderFilterSettings();
        html += '</div></div>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ANIMATION SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-design-section collapsed">';
        html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>âœ¨ Animation</span><span class="tb-design-section-toggle">â–¼</span></div>';
        html += '<div class="tb-design-section-body">';
        html += this.renderAnimationSettings();
        html += '</div></div>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // POSITION SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-design-section collapsed">';
        html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ“ Position</span><span class="tb-design-section-toggle">â–¼</span></div>';
        html += '<div class="tb-design-section-body">';
        html += this.renderPositionSettings();
        html += '</div></div>';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VISIBILITY SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        html += '<div class="tb-design-section collapsed">';
        html += '<div class="tb-design-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')"><span>ğŸ‘ï¸ Visibility</span><span class="tb-design-section-toggle">â–¼</span></div>';
        html += '<div class="tb-design-section-body">';
        html += '<div class="tb-setting-group" style="display:flex;gap:16px">';
        html += '<label style="display:flex;align-items:center;gap:6px"><input type="checkbox"' + (d.hide_desktop ? ' checked' : '') + ' onchange="TB.updateDesign(\'hide_desktop\',this.checked)"> Hide Desktop</label>';
        html += '<label style="display:flex;align-items:center;gap:6px"><input type="checkbox"' + (d.hide_tablet ? ' checked' : '') + ' onchange="TB.updateDesign(\'hide_tablet\',this.checked)"> Hide Tablet</label>';
        html += '<label style="display:flex;align-items:center;gap:6px"><input type="checkbox"' + (d.hide_mobile ? ' checked' : '') + ' onchange="TB.updateDesign(\'hide_mobile\',this.checked)"> Hide Mobile</label>';
        html += '</div></div></div>';

        container.innerHTML = html;
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATE TOGGLE FUNCTIONS (Normal / Hover)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    setState: function(state) {
        this.currentState = state;
        var canvas = document.getElementById('tb-canvas');
        if (canvas) {
            if (state === 'hover') {
                canvas.classList.add('hover-editing');
            } else {
                canvas.classList.remove('hover-editing');
            }
        }
        // Save collapsed state, re-render, then restore
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    getStateValue: function(d, property) {
        if (this.currentState === 'hover') {
            var hoverKey = property + '_hover';
            return d[hoverKey] !== undefined ? d[hoverKey] : d[property];
        }
        return d[property];
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HOVER EFFECTS SETTINGS (Full Panel)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    renderHoverEffectsSettings: function() {
        var mod = this.selectedModule.module;
        var d = mod.design || {};
        var self = this;

        var hoverEnabled = d.hover_enabled || false;
        var transitionDuration = d.hover_transition_duration || '0.3';
        var transitionEasing = d.hover_transition_easing || 'ease';

        var textColorHover = d.text_color_hover || '';
        var bgColorHover = d.background_color_hover || '';
        var borderColorHover = d.border_color_hover || '';
        var opacityHover = d.opacity_hover || '1';

        var scaleXHover = d.transform_scale_x_hover || '100';
        var scaleYHover = d.transform_scale_y_hover || '100';
        var translateXHover = d.transform_translate_x_hover || '0';
        var translateYHover = d.transform_translate_y_hover || '0';
        var rotateZHover = d.transform_rotate_z_hover || '0';

        var boxShadowHoverEnabled = d.box_shadow_hover_enabled || false;
        var boxShadowHoverH = parseInt(d.box_shadow_hover_horizontal) || 0;
        var boxShadowHoverV = parseInt(d.box_shadow_hover_vertical) || 8;
        var boxShadowHoverBlur = parseInt(d.box_shadow_hover_blur) || 20;
        var boxShadowHoverSpread = parseInt(d.box_shadow_hover_spread) || 0;
        var boxShadowHoverColor = d.box_shadow_hover_color || 'rgba(0,0,0,0.15)';

        var filterHoverEnabled = d.filter_hover_enabled || false;
        var filterBlurHover = d.filter_blur_hover || d.filter_blur || '0';
        var filterBrightnessHover = d.filter_brightness_hover || d.filter_brightness || '100';
        var filterContrastHover = d.filter_contrast_hover || d.filter_contrast || '100';
        var filterSaturationHover = d.filter_saturation_hover || d.filter_saturation || '100';
        var filterGrayscaleHover = d.filter_grayscale_hover || d.filter_grayscale || '0';

        var html = '';

        // Enable Hover Effects toggle
        html += '<div class="tb-hover-enable-row">';
        html += '<label><input type="checkbox" ' + (hoverEnabled ? 'checked' : '') + ' onchange="TB.updateHoverSetting(\'hover_enabled\',this.checked)"> Enable Hover Effects</label>';
        html += '</div>';

        // Hover controls container
        html += '<div class="tb-hover-controls' + (hoverEnabled ? '' : ' tb-hover-disabled') + '" id="hover-controls">';

        // Transition Settings
        html += '<div style="font-size:11px;font-weight:600;color:var(--tb-text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.03em">Transition</div>';

        // Duration
        html += '<div class="tb-hover-control-row">';
        html += '<label>Duration</label>';
        html += '<input type="range" min="0" max="2" step="0.1" value="' + transitionDuration + '" oninput="TB.updateHoverSettingSlider(\'hover_transition_duration\',this.value)">';
        html += '<input type="number" min="0" max="2" step="0.1" value="' + transitionDuration + '" onchange="TB.updateHoverSetting(\'hover_transition_duration\',this.value)">s';
        html += '</div>';

        // Easing
        html += '<div class="tb-hover-control-row">';
        html += '<label>Easing</label>';
        html += '<select onchange="TB.updateHoverSetting(\'hover_transition_easing\',this.value)">';
        html += '<option value="ease"' + (transitionEasing === 'ease' ? ' selected' : '') + '>Ease</option>';
        html += '<option value="ease-in"' + (transitionEasing === 'ease-in' ? ' selected' : '') + '>Ease In</option>';
        html += '<option value="ease-out"' + (transitionEasing === 'ease-out' ? ' selected' : '') + '>Ease Out</option>';
        html += '<option value="ease-in-out"' + (transitionEasing === 'ease-in-out' ? ' selected' : '') + '>Ease In-Out</option>';
        html += '<option value="linear"' + (transitionEasing === 'linear' ? ' selected' : '') + '>Linear</option>';
        html += '<option value="cubic-bezier(0.4, 0, 0.2, 1)"' + (transitionEasing === 'cubic-bezier(0.4, 0, 0.2, 1)' ? ' selected' : '') + '>Material</option>';
        html += '</select>';
        html += '</div>';

        // Hover Colors Section
        html += '<div style="font-size:11px;font-weight:600;color:var(--tb-text-muted);margin:16px 0 8px;text-transform:uppercase;letter-spacing:0.03em;border-top:1px solid var(--tb-border);padding-top:12px">Hover Colors</div>';

        html += '<div class="tb-hover-colors-grid">';

        // Text Color Hover
        html += '<div class="tb-hover-color-item">';
        html += '<label>Text Color</label>';
        html += '<div class="tb-hover-color-input">';
        html += '<input type="color" value="' + (textColorHover || '#333333') + '" onchange="TB.updateHoverSetting(\'text_color_hover\',this.value)">';
        html += '<input type="text" value="' + textColorHover + '" placeholder="inherit" onchange="TB.updateHoverSetting(\'text_color_hover\',this.value)">';
        html += '</div></div>';

        // Background Color Hover
        html += '<div class="tb-hover-color-item">';
        html += '<label>Background</label>';
        html += '<div class="tb-hover-color-input">';
        html += '<input type="color" value="' + (bgColorHover || '#ffffff') + '" onchange="TB.updateHoverSetting(\'background_color_hover\',this.value)">';
        html += '<input type="text" value="' + bgColorHover + '" placeholder="inherit" onchange="TB.updateHoverSetting(\'background_color_hover\',this.value)">';
        html += '</div></div>';

        // Border Color Hover
        html += '<div class="tb-hover-color-item">';
        html += '<label>Border</label>';
        html += '<div class="tb-hover-color-input">';
        html += '<input type="color" value="' + (borderColorHover || '#e2e8f0') + '" onchange="TB.updateHoverSetting(\'border_color_hover\',this.value)">';
        html += '<input type="text" value="' + borderColorHover + '" placeholder="inherit" onchange="TB.updateHoverSetting(\'border_color_hover\',this.value)">';
        html += '</div></div>';

        // Opacity Hover
        html += '<div class="tb-hover-color-item">';
        html += '<label>Opacity</label>';
        html += '<div class="tb-hover-color-input">';
        html += '<input type="range" min="0" max="1" step="0.05" value="' + opacityHover + '" style="flex:1" oninput="TB.updateHoverSettingSlider(\'opacity_hover\',this.value)">';
        html += '<input type="number" min="0" max="1" step="0.05" value="' + opacityHover + '" style="width:50px" onchange="TB.updateHoverSetting(\'opacity_hover\',this.value)">';
        html += '</div></div>';

        html += '</div>'; // colors grid

        // Transform Section
        html += '<div style="font-size:11px;font-weight:600;color:var(--tb-text-muted);margin:16px 0 8px;text-transform:uppercase;letter-spacing:0.03em;border-top:1px solid var(--tb-border);padding-top:12px">Hover Transform</div>';

        // Scale X
        html += '<div class="tb-hover-transform-row">';
        html += '<label>Scale X</label>';
        html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(scaleXHover) + '" style="flex:1" oninput="TB.updateHoverSettingSlider(\'transform_scale_x_hover\',this.value)">';
        html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(scaleXHover) + '" style="width:60px;padding:4px;background:var(--tb-surface);border:1px solid var(--tb-border);border-radius:4px;color:var(--tb-text);font-size:11px" onchange="TB.updateHoverSetting(\'transform_scale_x_hover\',this.value)">%';
        html += '</div>';

        // Scale Y
        html += '<div class="tb-hover-transform-row">';
        html += '<label>Scale Y</label>';
        html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(scaleYHover) + '" style="flex:1" oninput="TB.updateHoverSettingSlider(\'transform_scale_y_hover\',this.value)">';
        html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(scaleYHover) + '" style="width:60px;padding:4px;background:var(--tb-surface);border:1px solid var(--tb-border);border-radius:4px;color:var(--tb-text);font-size:11px" onchange="TB.updateHoverSetting(\'transform_scale_y_hover\',this.value)">%';
        html += '</div>';

        // Rotate Z
        html += '<div class="tb-hover-transform-row">';
        html += '<label>Rotate</label>';
        html += '<input type="range" min="-180" max="180" step="1" value="' + parseFloat(rotateZHover) + '" style="flex:1" oninput="TB.updateHoverSettingSlider(\'transform_rotate_z_hover\',this.value)">';
        html += '<input type="number" min="-180" max="180" step="1" value="' + parseFloat(rotateZHover) + '" style="width:60px;padding:4px;background:var(--tb-surface);border:1px solid var(--tb-border);border-radius:4px;color:var(--tb-text);font-size:11px" onchange="TB.updateHoverSetting(\'transform_rotate_z_hover\',this.value)">Â°';
        html += '</div>';

        // Translate X
        html += '<div class="tb-hover-transform-row">';
        html += '<label>Move X</label>';
        html += '<input type="range" min="-100" max="100" step="1" value="' + parseFloat(translateXHover) + '" style="flex:1" oninput="TB.updateHoverSettingSlider(\'transform_translate_x_hover\',this.value)">';
        html += '<input type="number" min="-100" max="100" step="1" value="' + parseFloat(translateXHover) + '" style="width:60px;padding:4px;background:var(--tb-surface);border:1px solid var(--tb-border);border-radius:4px;color:var(--tb-text);font-size:11px" onchange="TB.updateHoverSetting(\'transform_translate_x_hover\',this.value)">px';
        html += '</div>';

        // Translate Y
        html += '<div class="tb-hover-transform-row">';
        html += '<label>Move Y</label>';
        html += '<input type="range" min="-100" max="100" step="1" value="' + parseFloat(translateYHover) + '" style="flex:1" oninput="TB.updateHoverSettingSlider(\'transform_translate_y_hover\',this.value)">';
        html += '<input type="number" min="-100" max="100" step="1" value="' + parseFloat(translateYHover) + '" style="width:60px;padding:4px;background:var(--tb-surface);border:1px solid var(--tb-border);border-radius:4px;color:var(--tb-text);font-size:11px" onchange="TB.updateHoverSetting(\'transform_translate_y_hover\',this.value)">px';
        html += '</div>';

        // Box Shadow Hover Section
        html += '<div style="font-size:11px;font-weight:600;color:var(--tb-text-muted);margin:16px 0 8px;text-transform:uppercase;letter-spacing:0.03em;border-top:1px solid var(--tb-border);padding-top:12px">Hover Shadow</div>';

        html += '<div class="tb-hover-enable-row" style="border-bottom:none;margin-bottom:8px">';
        html += '<label><input type="checkbox" ' + (boxShadowHoverEnabled ? 'checked' : '') + ' onchange="TB.updateHoverSetting(\'box_shadow_hover_enabled\',this.checked)"> Different shadow on hover</label>';
        html += '</div>';

        html += '<div class="' + (boxShadowHoverEnabled ? '' : 'tb-hover-disabled') + '" id="hover-shadow-controls">';

        html += '<div class="tb-hover-control-row">';
        html += '<label>Horizontal</label>';
        html += '<input type="range" min="-50" max="50" value="' + boxShadowHoverH + '" oninput="TB.updateHoverSettingSlider(\'box_shadow_hover_horizontal\',this.value)">';
        html += '<input type="number" min="-50" max="50" value="' + boxShadowHoverH + '" onchange="TB.updateHoverSetting(\'box_shadow_hover_horizontal\',this.value)">px';
        html += '</div>';

        html += '<div class="tb-hover-control-row">';
        html += '<label>Vertical</label>';
        html += '<input type="range" min="-50" max="50" value="' + boxShadowHoverV + '" oninput="TB.updateHoverSettingSlider(\'box_shadow_hover_vertical\',this.value)">';
        html += '<input type="number" min="-50" max="50" value="' + boxShadowHoverV + '" onchange="TB.updateHoverSetting(\'box_shadow_hover_vertical\',this.value)">px';
        html += '</div>';

        html += '<div class="tb-hover-control-row">';
        html += '<label>Blur</label>';
        html += '<input type="range" min="0" max="100" value="' + boxShadowHoverBlur + '" oninput="TB.updateHoverSettingSlider(\'box_shadow_hover_blur\',this.value)">';
        html += '<input type="number" min="0" max="100" value="' + boxShadowHoverBlur + '" onchange="TB.updateHoverSetting(\'box_shadow_hover_blur\',this.value)">px';
        html += '</div>';

        html += '<div class="tb-hover-control-row">';
        html += '<label>Spread</label>';
        html += '<input type="range" min="-50" max="50" value="' + boxShadowHoverSpread + '" oninput="TB.updateHoverSettingSlider(\'box_shadow_hover_spread\',this.value)">';
        html += '<input type="number" min="-50" max="50" value="' + boxShadowHoverSpread + '" onchange="TB.updateHoverSetting(\'box_shadow_hover_spread\',this.value)">px';
        html += '</div>';

        html += '<div class="tb-hover-control-row">';
        html += '<label>Color</label>';
        html += '<input type="color" value="' + this.rgbaToHex(boxShadowHoverColor) + '" onchange="TB.updateHoverShadowColor(this.value)">';
        html += '<input type="text" value="' + boxShadowHoverColor + '" placeholder="rgba(0,0,0,0.15)" style="flex:1" onchange="TB.updateHoverSetting(\'box_shadow_hover_color\',this.value)">';
        html += '</div>';

        html += '</div>'; // hover shadow controls

        // Hover Filters Section
        html += '<div style="font-size:11px;font-weight:600;color:var(--tb-text-muted);margin:16px 0 8px;text-transform:uppercase;letter-spacing:0.03em;border-top:1px solid var(--tb-border);padding-top:12px">Hover Filters</div>';

        html += '<div class="tb-hover-enable-row" style="border-bottom:none;margin-bottom:8px">';
        html += '<label><input type="checkbox" ' + (filterHoverEnabled ? 'checked' : '') + ' onchange="TB.updateHoverSetting(\'filter_hover_enabled\',this.checked)"> Different filters on hover</label>';
        html += '</div>';

        html += '<div class="' + (filterHoverEnabled ? '' : 'tb-hover-disabled') + '" id="hover-filter-controls">';

        html += '<div class="tb-hover-control-row">';
        html += '<label>Blur</label>';
        html += '<input type="range" min="0" max="20" step="0.5" value="' + parseFloat(filterBlurHover) + '" oninput="TB.updateHoverSettingSlider(\'filter_blur_hover\',this.value)">';
        html += '<input type="number" min="0" max="20" step="0.5" value="' + parseFloat(filterBlurHover) + '" onchange="TB.updateHoverSetting(\'filter_blur_hover\',this.value)">px';
        html += '</div>';

        html += '<div class="tb-hover-control-row">';
        html += '<label>Brightness</label>';
        html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(filterBrightnessHover) + '" oninput="TB.updateHoverSettingSlider(\'filter_brightness_hover\',this.value)">';
        html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(filterBrightnessHover) + '" onchange="TB.updateHoverSetting(\'filter_brightness_hover\',this.value)">%';
        html += '</div>';

        html += '<div class="tb-hover-control-row">';
        html += '<label>Contrast</label>';
        html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(filterContrastHover) + '" oninput="TB.updateHoverSettingSlider(\'filter_contrast_hover\',this.value)">';
        html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(filterContrastHover) + '" onchange="TB.updateHoverSetting(\'filter_contrast_hover\',this.value)">%';
        html += '</div>';

        html += '<div class="tb-hover-control-row">';
        html += '<label>Saturation</label>';
        html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(filterSaturationHover) + '" oninput="TB.updateHoverSettingSlider(\'filter_saturation_hover\',this.value)">';
        html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(filterSaturationHover) + '" onchange="TB.updateHoverSetting(\'filter_saturation_hover\',this.value)">%';
        html += '</div>';

        html += '<div class="tb-hover-control-row">';
        html += '<label>Grayscale</label>';
        html += '<input type="range" min="0" max="100" step="1" value="' + parseFloat(filterGrayscaleHover) + '" oninput="TB.updateHoverSettingSlider(\'filter_grayscale_hover\',this.value)">';
        html += '<input type="number" min="0" max="100" step="1" value="' + parseFloat(filterGrayscaleHover) + '" onchange="TB.updateHoverSetting(\'filter_grayscale_hover\',this.value)">%';
        html += '</div>';

        html += '</div>'; // hover filter controls

        // Hover Preview Button
        html += '<button type="button" class="tb-hover-preview-btn' + (this.hoverPreviewActive ? ' active' : '') + '" onclick="TB.toggleHoverPreview()">';
        html += '<span>ğŸ‘†</span> ' + (this.hoverPreviewActive ? 'Exit Hover Preview' : 'Preview Hover State');
        html += '</button>';

        html += '</div>'; // controls

        return html;
    },

    // Hover Setting Update Functions
    updateHoverSetting: function(property, value) {
        var mod = this.selectedModule.module;
        if (!mod) return;
        if (!mod.design) mod.design = {};

        if (property === 'hover_enabled' || property === 'box_shadow_hover_enabled' || property === 'filter_hover_enabled') {
            mod.design[property] = value === true || value === 'true';
        } else {
            mod.design[property] = value;
        }

        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    updateHoverSettingSlider: function(property, value) {
        var mod = this.selectedModule.module;
        if (!mod) return;
        if (!mod.design) mod.design = {};

        mod.design[property] = value;

        // Debounced save and render
        var self = this;
        clearTimeout(this.hoverUpdateTimer);
        this.hoverUpdateTimer = setTimeout(function() {
            self.isDirty = true;
            self.renderCanvas();
        }, 150);
    },

    updateHoverShadowColor: function(hexColor) {
        var rgba = this.hexToRgba(hexColor, 0.15);
        this.updateHoverSetting('box_shadow_hover_color', rgba);
    },

    toggleHoverPreview: function() {
        this.hoverPreviewActive = !this.hoverPreviewActive;
        var canvas = document.getElementById('tb-canvas');
        if (canvas) {
            if (this.hoverPreviewActive) {
                canvas.classList.add('hover-preview-active');
            } else {
                canvas.classList.remove('hover-preview-active');
            }
        }
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FILTER SETTINGS (Full Panel with Live Preview)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    renderFilterSettings: function() {
        var mod = this.selectedModule.module;
        var d = mod.design || {};
        var self = this;

        var filterBlur = d.filter_blur || '0';
        var filterBrightness = d.filter_brightness || '100';
        var filterContrast = d.filter_contrast || '100';
        var filterSaturation = d.filter_saturation || '100';
        var filterHueRotate = d.filter_hue_rotate || '0';
        var filterGrayscale = d.filter_grayscale || '0';
        var filterSepia = d.filter_sepia || '0';
        var filterInvert = d.filter_invert || '0';
        var filterOpacity = d.filter_opacity || '100';
        var filterPreset = d.filter_preset || 'none';

        var html = '';

        // Live Preview Thumbnail
        var previewFilter = this.getFilterCSS(d);
        html += '<div class="tb-filter-preview" id="filter-preview" style="filter:' + previewFilter + '">';
        html += '<div class="tb-filter-preview-content">';
        html += '<span class="tb-filter-preview-icon">ğŸ–¼ï¸</span>';
        html += '<span>Preview</span>';
        html += '</div>';
        html += '<span class="tb-filter-preview-label">Live Preview</span>';
        html += '</div>';

        // Preset Dropdown
        html += '<div class="tb-filter-preset-row">';
        html += '<label>Preset</label>';
        html += '<select onchange="TB.applyFilterPreset(this.value)">';
        html += '<option value="none"' + (filterPreset === 'none' ? ' selected' : '') + '>None (Default)</option>';
        html += '<option value="vivid"' + (filterPreset === 'vivid' ? ' selected' : '') + '>Vivid</option>';
        html += '<option value="muted"' + (filterPreset === 'muted' ? ' selected' : '') + '>Muted</option>';
        html += '<option value="vintage"' + (filterPreset === 'vintage' ? ' selected' : '') + '>Vintage</option>';
        html += '<option value="blackwhite"' + (filterPreset === 'blackwhite' ? ' selected' : '') + '>Black & White</option>';
        html += '<option value="dramatic"' + (filterPreset === 'dramatic' ? ' selected' : '') + '>Dramatic</option>';
        html += '<option value="warm"' + (filterPreset === 'warm' ? ' selected' : '') + '>Warm</option>';
        html += '<option value="cool"' + (filterPreset === 'cool' ? ' selected' : '') + '>Cool</option>';
        html += '</select>';
        html += '</div>';

        // Blur Section
        html += '<div class="tb-filter-subsection">';
        html += '<div class="tb-filter-subsection-title">ğŸŒ«ï¸ Blur</div>';
        html += '<div class="tb-filter-control-row">';
        html += '<label>Blur</label>';
        html += '<input type="range" min="0" max="20" step="0.5" value="' + parseFloat(filterBlur) + '" oninput="TB.updateFilterSlider(\'filter_blur\',this.value)">';
        html += '<input type="number" min="0" max="20" step="0.5" value="' + parseFloat(filterBlur) + '" onchange="TB.updateFilter(\'filter_blur\',this.value)">';
        html += '<span class="tb-unit-label">px</span>';
        html += '</div>';
        html += '</div>';

        // Brightness & Contrast Section
        html += '<div class="tb-filter-subsection">';
        html += '<div class="tb-filter-subsection-title">â˜€ï¸ Brightness & Contrast</div>';

        html += '<div class="tb-filter-control-row">';
        html += '<label>Brightness</label>';
        html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(filterBrightness) + '" oninput="TB.updateFilterSlider(\'filter_brightness\',this.value)">';
        html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(filterBrightness) + '" onchange="TB.updateFilter(\'filter_brightness\',this.value)">';
        html += '<span class="tb-unit-label">%</span>';
        html += '</div>';

        html += '<div class="tb-filter-control-row">';
        html += '<label>Contrast</label>';
        html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(filterContrast) + '" oninput="TB.updateFilterSlider(\'filter_contrast\',this.value)">';
        html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(filterContrast) + '" onchange="TB.updateFilter(\'filter_contrast\',this.value)">';
        html += '<span class="tb-unit-label">%</span>';
        html += '</div>';

        html += '</div>';

        // Color Adjustments Section
        html += '<div class="tb-filter-subsection">';
        html += '<div class="tb-filter-subsection-title">ğŸ¨ Color Adjustments</div>';

        html += '<div class="tb-filter-control-row">';
        html += '<label>Saturation</label>';
        html += '<input type="range" min="0" max="200" step="1" value="' + parseFloat(filterSaturation) + '" oninput="TB.updateFilterSlider(\'filter_saturation\',this.value)">';
        html += '<input type="number" min="0" max="200" step="1" value="' + parseFloat(filterSaturation) + '" onchange="TB.updateFilter(\'filter_saturation\',this.value)">';
        html += '<span class="tb-unit-label">%</span>';
        html += '</div>';

        html += '<div class="tb-filter-control-row">';
        html += '<label>Hue Rotate</label>';
        html += '<input type="range" min="0" max="360" step="1" value="' + parseFloat(filterHueRotate) + '" oninput="TB.updateFilterSlider(\'filter_hue_rotate\',this.value)">';
        html += '<input type="number" min="0" max="360" step="1" value="' + parseFloat(filterHueRotate) + '" onchange="TB.updateFilter(\'filter_hue_rotate\',this.value)">';
        html += '<span class="tb-unit-label">Â°</span>';
        html += '</div>';

        html += '</div>';

        // Effects Section
        html += '<div class="tb-filter-subsection">';
        html += '<div class="tb-filter-subsection-title">âœ¨ Effects</div>';

        html += '<div class="tb-filter-control-row">';
        html += '<label>Grayscale</label>';
        html += '<input type="range" min="0" max="100" step="1" value="' + parseFloat(filterGrayscale) + '" oninput="TB.updateFilterSlider(\'filter_grayscale\',this.value)">';
        html += '<input type="number" min="0" max="100" step="1" value="' + parseFloat(filterGrayscale) + '" onchange="TB.updateFilter(\'filter_grayscale\',this.value)">';
        html += '<span class="tb-unit-label">%</span>';
        html += '</div>';

        html += '<div class="tb-filter-control-row">';
        html += '<label>Sepia</label>';
        html += '<input type="range" min="0" max="100" step="1" value="' + parseFloat(filterSepia) + '" oninput="TB.updateFilterSlider(\'filter_sepia\',this.value)">';
        html += '<input type="number" min="0" max="100" step="1" value="' + parseFloat(filterSepia) + '" onchange="TB.updateFilter(\'filter_sepia\',this.value)">';
        html += '<span class="tb-unit-label">%</span>';
        html += '</div>';

        html += '<div class="tb-filter-control-row">';
        html += '<label>Invert</label>';
        html += '<input type="range" min="0" max="100" step="1" value="' + parseFloat(filterInvert) + '" oninput="TB.updateFilterSlider(\'filter_invert\',this.value)">';
        html += '<input type="number" min="0" max="100" step="1" value="' + parseFloat(filterInvert) + '" onchange="TB.updateFilter(\'filter_invert\',this.value)">';
        html += '<span class="tb-unit-label">%</span>';
        html += '</div>';

        html += '</div>';

        // Opacity Section
        html += '<div class="tb-filter-subsection">';
        html += '<div class="tb-filter-subsection-title">ğŸ‘ï¸ Opacity</div>';

        html += '<div class="tb-filter-control-row">';
        html += '<label>Opacity</label>';
        html += '<input type="range" min="0" max="100" step="1" value="' + parseFloat(filterOpacity) + '" oninput="TB.updateFilterSlider(\'filter_opacity\',this.value)">';
        html += '<input type="number" min="0" max="100" step="1" value="' + parseFloat(filterOpacity) + '" onchange="TB.updateFilter(\'filter_opacity\',this.value)">';
        html += '<span class="tb-unit-label">%</span>';
        html += '</div>';

        html += '</div>';

        // Reset Button
        html += '<button type="button" class="tb-filter-reset-btn" onclick="TB.resetFilters()">';
        html += '<span>â†º</span> Reset All Filters';
        html += '</button>';

        return html;
    },

    // Filter Update Functions
    updateFilter: function(property, value) {
        var mod = this.selectedModule.module;
        if (!mod) return;
        if (!mod.design) mod.design = {};
        mod.design[property] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    updateFilterSlider: function(property, value) {
        var mod = this.selectedModule.module;
        if (!mod) return;
        if (!mod.design) mod.design = {};
        mod.design[property] = value;

        // Update preview immediately
        var preview = document.getElementById('filter-preview');
        if (preview) {
            preview.style.filter = this.getFilterCSS(mod.design);
        }

        // Debounced save
        var self = this;
        clearTimeout(this.filterUpdateTimer);
        this.filterUpdateTimer = setTimeout(function() {
            self.isDirty = true;
            self.renderCanvas();
        }, 150);
    },

    filterUpdateTimer: null,

    applyFilterPreset: function(preset) {
        var mod = this.selectedModule.module;
        if (!mod) return;
        if (!mod.design) mod.design = {};

        var presets = {
            'none': { blur: 0, brightness: 100, contrast: 100, saturation: 100, hueRotate: 0, grayscale: 0, sepia: 0, invert: 0 },
            'vivid': { blur: 0, brightness: 110, contrast: 115, saturation: 130, hueRotate: 0, grayscale: 0, sepia: 0, invert: 0 },
            'muted': { blur: 0, brightness: 100, contrast: 95, saturation: 70, hueRotate: 0, grayscale: 0, sepia: 0, invert: 0 },
            'vintage': { blur: 0, brightness: 105, contrast: 90, saturation: 85, hueRotate: 0, grayscale: 0, sepia: 30, invert: 0 },
            'blackwhite': { blur: 0, brightness: 100, contrast: 110, saturation: 0, hueRotate: 0, grayscale: 100, sepia: 0, invert: 0 },
            'dramatic': { blur: 0, brightness: 95, contrast: 130, saturation: 110, hueRotate: 0, grayscale: 0, sepia: 0, invert: 0 },
            'warm': { blur: 0, brightness: 105, contrast: 100, saturation: 110, hueRotate: 15, grayscale: 0, sepia: 15, invert: 0 },
            'cool': { blur: 0, brightness: 100, contrast: 105, saturation: 100, hueRotate: 200, grayscale: 0, sepia: 0, invert: 0 }
        };

        var p = presets[preset] || presets['none'];
        mod.design.filter_preset = preset;
        mod.design.filter_blur = p.blur.toString();
        mod.design.filter_brightness = p.brightness.toString();
        mod.design.filter_contrast = p.contrast.toString();
        mod.design.filter_saturation = p.saturation.toString();
        mod.design.filter_hue_rotate = p.hueRotate.toString();
        mod.design.filter_grayscale = p.grayscale.toString();
        mod.design.filter_sepia = p.sepia.toString();
        mod.design.filter_invert = p.invert.toString();

        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    resetFilters: function() {
        var mod = this.selectedModule.module;
        if (!mod) return;
        if (!mod.design) mod.design = {};

        mod.design.filter_preset = 'none';
        mod.design.filter_blur = '0';
        mod.design.filter_brightness = '100';
        mod.design.filter_contrast = '100';
        mod.design.filter_saturation = '100';
        mod.design.filter_hue_rotate = '0';
        mod.design.filter_grayscale = '0';
        mod.design.filter_sepia = '0';
        mod.design.filter_invert = '0';
        mod.design.filter_opacity = '100';

        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    getFilterCSS: function(d) {
        var parts = [];

        var blur = parseFloat(d.filter_blur || 0);
        var brightness = parseFloat(d.filter_brightness || 100);
        var contrast = parseFloat(d.filter_contrast || 100);
        var saturation = parseFloat(d.filter_saturation || 100);
        var hueRotate = parseFloat(d.filter_hue_rotate || 0);
        var grayscale = parseFloat(d.filter_grayscale || 0);
        var sepia = parseFloat(d.filter_sepia || 0);
        var invert = parseFloat(d.filter_invert || 0);
        var opacity = parseFloat(d.filter_opacity || 100);

        if (blur > 0) parts.push('blur(' + blur + 'px)');
        if (brightness !== 100) parts.push('brightness(' + brightness + '%)');
        if (contrast !== 100) parts.push('contrast(' + contrast + '%)');
        if (saturation !== 100) parts.push('saturate(' + saturation + '%)');
        if (hueRotate !== 0) parts.push('hue-rotate(' + hueRotate + 'deg)');
        if (grayscale > 0) parts.push('grayscale(' + grayscale + '%)');
        if (sepia > 0) parts.push('sepia(' + sepia + '%)');
        if (invert > 0) parts.push('invert(' + invert + '%)');
        if (opacity !== 100) parts.push('opacity(' + opacity + '%)');

        return parts.length > 0 ? parts.join(' ') : 'none';
    },

    hasActiveFilters: function() {
        if (!this.selectedModule) return false;
        var d = this.selectedModule.module.design || {};

        var blur = parseFloat(d.filter_blur || 0);
        var brightness = parseFloat(d.filter_brightness || 100);
        var contrast = parseFloat(d.filter_contrast || 100);
        var saturation = parseFloat(d.filter_saturation || 100);
        var hueRotate = parseFloat(d.filter_hue_rotate || 0);
        var grayscale = parseFloat(d.filter_grayscale || 0);
        var sepia = parseFloat(d.filter_sepia || 0);
        var invert = parseFloat(d.filter_invert || 0);
        var opacity = parseFloat(d.filter_opacity || 100);

        return blur > 0 || brightness !== 100 || contrast !== 100 ||
               saturation !== 100 || hueRotate !== 0 || grayscale > 0 ||
               sepia > 0 || invert > 0 || opacity !== 100;
    },

    // Helper functions for color conversion
    rgbaToHex: function(rgba) {
        if (!rgba || rgba.indexOf('rgba') === -1) return rgba || '#000000';
        var match = rgba.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
        if (!match) return '#000000';
        return '#' + [match[1], match[2], match[3]].map(function(x) {
            var hex = parseInt(x).toString(16);
            return hex.length === 1 ? '0' + hex : hex;
        }).join('');
    },

    hexToRgba: function(hex, alpha) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        if (!result) return 'rgba(0,0,0,' + alpha + ')';
        return 'rgba(' + parseInt(result[1], 16) + ',' + parseInt(result[2], 16) + ',' + parseInt(result[3], 16) + ',' + alpha + ')';
    },

    renderSpacingBox: function() {
        var mod = this.selectedModule.module;
        var d = mod.design || {};
        var html = '<div class="tb-spacing-box">';
        html += '<div class="tb-spacing-box-outer">';
        html += '<span class="tb-spacing-label tb-spacing-label-margin">MARGIN</span>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-margin-top"><input type="text" value="' + (d.margin_top || '0') + '" onchange="TB.updateDesign(\'margin_top\',this.value)" placeholder="0"></div>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-margin-right"><input type="text" value="' + (d.margin_right || '0') + '" onchange="TB.updateDesign(\'margin_right\',this.value)" placeholder="0"></div>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-margin-bottom"><input type="text" value="' + (d.margin_bottom || '0') + '" onchange="TB.updateDesign(\'margin_bottom\',this.value)" placeholder="0"></div>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-margin-left"><input type="text" value="' + (d.margin_left || '0') + '" onchange="TB.updateDesign(\'margin_left\',this.value)" placeholder="0"></div>';
        html += '<div class="tb-spacing-box-inner">';
        html += '<span class="tb-spacing-label tb-spacing-label-padding">PADDING</span>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-padding-top"><input type="text" value="' + (d.padding_top || '0') + '" onchange="TB.updateDesign(\'padding_top\',this.value)" placeholder="0"></div>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-padding-right"><input type="text" value="' + (d.padding_right || '0') + '" onchange="TB.updateDesign(\'padding_right\',this.value)" placeholder="0"></div>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-padding-bottom"><input type="text" value="' + (d.padding_bottom || '0') + '" onchange="TB.updateDesign(\'padding_bottom\',this.value)" placeholder="0"></div>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-padding-left"><input type="text" value="' + (d.padding_left || '0') + '" onchange="TB.updateDesign(\'padding_left\',this.value)" placeholder="0"></div>';
        html += '<div class="tb-spacing-box-content">CONTENT</div>';
        html += '</div></div></div>';
        return html;
    },

    // Combined Spacing Box with Link Buttons (from TB Pages)
    renderCombinedSpacingBox: function() {
        var mod = this.selectedModule.module;
        var d = mod.design || {};

        var mTop = parseInt(d.margin_top) || 0;
        var mRight = parseInt(d.margin_right) || 0;
        var mBottom = parseInt(d.margin_bottom) || 0;
        var mLeft = parseInt(d.margin_left) || 0;
        var marginLinked = d.margin_linked || false;

        var pTop = parseInt(d.padding_top) || 0;
        var pRight = parseInt(d.padding_right) || 0;
        var pBottom = parseInt(d.padding_bottom) || 0;
        var pLeft = parseInt(d.padding_left) || 0;
        var paddingLinked = d.padding_linked || false;

        var html = '<div class="tb-spacing-box">';

        // Outer margin box
        html += '<div class="tb-spacing-box-outer">';
        html += '<span class="tb-spacing-label tb-spacing-label-margin">MARGIN</span>';

        // Margin inputs
        html += '<div class="tb-spacing-input-wrap tb-spacing-margin-top"><input type="number" value="' + mTop + '" min="0" max="500" placeholder="0" onchange="TB.handleSpacingChange(\'margin\',\'top\',this.value)"></div>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-margin-right"><input type="number" value="' + mRight + '" min="0" max="500" placeholder="0" onchange="TB.handleSpacingChange(\'margin\',\'right\',this.value)"></div>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-margin-bottom"><input type="number" value="' + mBottom + '" min="0" max="500" placeholder="0" onchange="TB.handleSpacingChange(\'margin\',\'bottom\',this.value)"></div>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-margin-left"><input type="number" value="' + mLeft + '" min="0" max="500" placeholder="0" onchange="TB.handleSpacingChange(\'margin\',\'left\',this.value)"></div>';

        // Margin link button
        html += '<button type="button" class="tb-spacing-link-btn tb-spacing-link-margin' + (marginLinked ? ' linked' : '') + '" onclick="TB.toggleSpacingLink(\'margin\')" title="' + (marginLinked ? 'Unlink margin values' : 'Link all margin values') + '">' + (marginLinked ? 'ğŸ”—' : 'â›“ï¸') + '</button>';

        // Inner padding box
        html += '<div class="tb-spacing-box-inner">';
        html += '<span class="tb-spacing-label tb-spacing-label-padding">PADDING</span>';

        // Padding inputs
        html += '<div class="tb-spacing-input-wrap tb-spacing-padding-top"><input type="number" value="' + pTop + '" min="0" max="500" placeholder="0" onchange="TB.handleSpacingChange(\'padding\',\'top\',this.value)"></div>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-padding-right"><input type="number" value="' + pRight + '" min="0" max="500" placeholder="0" onchange="TB.handleSpacingChange(\'padding\',\'right\',this.value)"></div>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-padding-bottom"><input type="number" value="' + pBottom + '" min="0" max="500" placeholder="0" onchange="TB.handleSpacingChange(\'padding\',\'bottom\',this.value)"></div>';
        html += '<div class="tb-spacing-input-wrap tb-spacing-padding-left"><input type="number" value="' + pLeft + '" min="0" max="500" placeholder="0" onchange="TB.handleSpacingChange(\'padding\',\'left\',this.value)"></div>';

        // Padding link button
        html += '<button type="button" class="tb-spacing-link-btn tb-spacing-link-padding' + (paddingLinked ? ' linked' : '') + '" onclick="TB.toggleSpacingLink(\'padding\')" title="' + (paddingLinked ? 'Unlink padding values' : 'Link all padding values') + '">' + (paddingLinked ? 'ğŸ”—' : 'â›“ï¸') + '</button>';

        // Center content placeholder
        html += '<div class="tb-spacing-box-content">Content</div>';

        html += '</div>'; // inner
        html += '</div>'; // outer
        html += '</div>'; // box

        return html;
    },

    // Handle spacing input change with link support
    handleSpacingChange: function(type, side, value) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};

        var numValue = parseInt(value) || 0;
        var pxValue = numValue + 'px';

        if (d[type + '_linked']) {
            // If linked, update all sides
            d[type + '_top'] = pxValue;
            d[type + '_right'] = pxValue;
            d[type + '_bottom'] = pxValue;
            d[type + '_left'] = pxValue;
        } else {
            // Update only the specified side
            d[type + '_' + side] = pxValue;
        }

        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    // Toggle linked spacing values
    toggleSpacingLink: function(type) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};

        var linkKey = type + '_linked';
        var isLinked = !d[linkKey];
        d[linkKey] = isLinked;

        // If linking, sync all values to the first non-zero value
        if (isLinked) {
            var values = [
                parseInt(d[type + '_top']) || 0,
                parseInt(d[type + '_right']) || 0,
                parseInt(d[type + '_bottom']) || 0,
                parseInt(d[type + '_left']) || 0
            ];
            var syncValue = values.find(function(v) { return v > 0; }) || 0;
            var pxValue = syncValue + 'px';
            d[type + '_top'] = pxValue;
            d[type + '_right'] = pxValue;
            d[type + '_bottom'] = pxValue;
            d[type + '_left'] = pxValue;
        }

        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    // Typography Settings Panel (from TB Pages)
    renderTypographySettings: function(element, label) {
        var mod = this.selectedModule.module;
        var d = mod.design || {};
        var typoKey = 'typography_' + element;
        var typography = d[typoKey] || {};

        var html = '';

        // Section header with collapsible toggle
        html += '<div class="tb-typography-section" data-element="' + element + '">';
        html += '<div class="tb-setting-group" style="border-bottom:1px solid var(--tb-border);padding-bottom:8px;margin-bottom:12px;cursor:pointer" onclick="TB.toggleTypographySection(this)">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center">';
        html += '<div class="tb-setting-label" style="font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.05em;color:var(--tb-text-muted);margin:0">' + this.escapeHtml(label) + ' Typography</div>';
        html += '<span class="tb-typography-toggle" style="font-size:10px;color:var(--tb-text-muted)">â–¼</span>';
        html += '</div></div>';

        html += '<div class="tb-typography-content">';

        // Font Family
        html += '<div class="tb-setting-group"><div class="tb-setting-label">Font Family</div><select class="tb-setting-input" onchange="TB.updateTypographyElement(\'' + element + '\',\'font_family\',this.value)">';
        var fonts = [
            { value: '', label: 'Default' },
            { value: 'system-ui, -apple-system, sans-serif', label: 'System UI' },
            { value: 'Arial, Helvetica, sans-serif', label: 'Arial' },
            { value: 'Helvetica Neue, Helvetica, sans-serif', label: 'Helvetica Neue' },
            { value: 'Georgia, serif', label: 'Georgia' },
            { value: 'Times New Roman, Times, serif', label: 'Times New Roman' },
            { value: 'Verdana, Geneva, sans-serif', label: 'Verdana' },
            { value: 'Trebuchet MS, sans-serif', label: 'Trebuchet MS' },
            { value: 'Tahoma, Geneva, sans-serif', label: 'Tahoma' },
            { value: 'Courier New, monospace', label: 'Courier New' },
            { value: 'Inter, sans-serif', label: 'Inter' },
            { value: 'Roboto, sans-serif', label: 'Roboto' },
            { value: 'Open Sans, sans-serif', label: 'Open Sans' },
            { value: 'Lato, sans-serif', label: 'Lato' },
            { value: 'Montserrat, sans-serif', label: 'Montserrat' },
            { value: 'Poppins, sans-serif', label: 'Poppins' }
        ];
        fonts.forEach(function(f) {
            html += '<option value="' + f.value + '"' + (typography.font_family === f.value ? ' selected' : '') + '>' + f.label + '</option>';
        });
        html += '</select></div>';

        // Font Size with Unit
        var fontSize = typography.font_size || '';
        html += '<div class="tb-setting-group"><div class="tb-setting-label">Font Size</div><div style="display:flex;gap:8px">';
        html += '<input type="number" class="tb-setting-input" style="flex:1" value="' + (parseInt(fontSize) || '') + '" placeholder="16" min="8" max="200" onchange="TB.updateTypographyWithUnit(\'' + element + '\',\'font_size\',this.value,this.nextElementSibling.value)">';
        var sizeUnit = fontSize ? fontSize.replace(/[0-9.]/g, '') || 'px' : 'px';
        html += '<select class="tb-setting-input" style="width:70px" onchange="TB.updateTypographyWithUnit(\'' + element + '\',\'font_size\',this.previousElementSibling.value,this.value)">';
        html += '<option value="px"' + (sizeUnit === 'px' ? ' selected' : '') + '>px</option>';
        html += '<option value="em"' + (sizeUnit === 'em' ? ' selected' : '') + '>em</option>';
        html += '<option value="rem"' + (sizeUnit === 'rem' ? ' selected' : '') + '>rem</option>';
        html += '<option value="%"' + (sizeUnit === '%' ? ' selected' : '') + '>%</option>';
        html += '</select></div></div>';

        // Font Weight
        html += '<div class="tb-setting-group"><div class="tb-setting-label">Font Weight</div><select class="tb-setting-input" onchange="TB.updateTypographyElement(\'' + element + '\',\'font_weight\',this.value)">';
        var weights = [
            { value: '', label: 'Default' },
            { value: '100', label: '100 - Thin' },
            { value: '200', label: '200 - Extra Light' },
            { value: '300', label: '300 - Light' },
            { value: '400', label: '400 - Normal' },
            { value: '500', label: '500 - Medium' },
            { value: '600', label: '600 - Semi Bold' },
            { value: '700', label: '700 - Bold' },
            { value: '800', label: '800 - Extra Bold' },
            { value: '900', label: '900 - Black' }
        ];
        weights.forEach(function(w) {
            html += '<option value="' + w.value + '"' + (typography.font_weight === w.value ? ' selected' : '') + '>' + w.label + '</option>';
        });
        html += '</select></div>';

        // Line Height with Unit
        var lineHeight = typography.line_height || '';
        var lhValue = lineHeight ? parseFloat(lineHeight) : '';
        var lhUnit = lineHeight ? lineHeight.replace(/[0-9.]/g, '') || '' : '';
        html += '<div class="tb-setting-group"><div class="tb-setting-label">Line Height</div><div style="display:flex;gap:8px">';
        html += '<input type="number" class="tb-setting-input" style="flex:1" value="' + lhValue + '" placeholder="1.6" min="0.5" max="5" step="0.1" onchange="TB.updateTypographyWithUnit(\'' + element + '\',\'line_height\',this.value,this.nextElementSibling.value)">';
        html += '<select class="tb-setting-input" style="width:70px" onchange="TB.updateTypographyWithUnit(\'' + element + '\',\'line_height\',this.previousElementSibling.value,this.value)">';
        html += '<option value=""' + (lhUnit === '' ? ' selected' : '') + '>-</option>';
        html += '<option value="px"' + (lhUnit === 'px' ? ' selected' : '') + '>px</option>';
        html += '<option value="em"' + (lhUnit === 'em' ? ' selected' : '') + '>em</option>';
        html += '<option value="%"' + (lhUnit === '%' ? ' selected' : '') + '>%</option>';
        html += '</select></div></div>';

        // Letter Spacing
        var lsValue = typography.letter_spacing ? parseFloat(typography.letter_spacing) : '';
        var lsUnit = typography.letter_spacing ? typography.letter_spacing.replace(/[0-9.-]/g, '') || 'px' : 'px';
        html += '<div class="tb-setting-group"><div class="tb-setting-label">Letter Spacing</div><div style="display:flex;gap:8px">';
        html += '<input type="number" class="tb-setting-input" style="flex:1" value="' + lsValue + '" placeholder="0" step="0.5" min="-5" max="20" onchange="TB.updateTypographyWithUnit(\'' + element + '\',\'letter_spacing\',this.value,this.nextElementSibling.value)">';
        html += '<select class="tb-setting-input" style="width:70px" onchange="TB.updateTypographyWithUnit(\'' + element + '\',\'letter_spacing\',this.previousElementSibling.value,this.value)">';
        html += '<option value="px"' + (lsUnit === 'px' ? ' selected' : '') + '>px</option>';
        html += '<option value="em"' + (lsUnit === 'em' ? ' selected' : '') + '>em</option>';
        html += '</select></div></div>';

        // Text Transform
        html += '<div class="tb-setting-group"><div class="tb-setting-label">Text Transform</div><select class="tb-setting-input" onchange="TB.updateTypographyElement(\'' + element + '\',\'text_transform\',this.value)">';
        html += '<option value=""' + (!typography.text_transform ? ' selected' : '') + '>None</option>';
        html += '<option value="uppercase"' + (typography.text_transform === 'uppercase' ? ' selected' : '') + '>UPPERCASE</option>';
        html += '<option value="lowercase"' + (typography.text_transform === 'lowercase' ? ' selected' : '') + '>lowercase</option>';
        html += '<option value="capitalize"' + (typography.text_transform === 'capitalize' ? ' selected' : '') + '>Capitalize</option>';
        html += '</select></div>';

        // Text Color
        html += '<div class="tb-setting-group"><div class="tb-setting-label">Text Color</div><div style="display:flex;gap:8px;align-items:center">';
        html += '<input type="color" class="tb-setting-input" style="width:50px;padding:2px" value="' + (typography.color || '#333333') + '" onchange="TB.updateTypographyElement(\'' + element + '\',\'color\',this.value)">';
        html += '<input type="text" class="tb-setting-input" style="flex:1" value="' + (typography.color || '') + '" placeholder="#333333" onchange="TB.updateTypographyElement(\'' + element + '\',\'color\',this.value)">';
        html += '</div></div>';

        html += '</div></div>'; // Close tb-typography-content and tb-typography-section

        return html;
    },

    // Toggle typography section visibility
    toggleTypographySection: function(headerEl) {
        var section = headerEl.closest('.tb-typography-section');
        var content = section.querySelector('.tb-typography-content');
        var toggle = section.querySelector('.tb-typography-toggle');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            toggle.textContent = 'â–¼';
        } else {
            content.style.display = 'none';
            toggle.textContent = 'â–¶';
        }
    },

    // Update typography element property
    updateTypographyElement: function(element, property, value) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};

        var typoKey = 'typography_' + element;
        if (!d[typoKey]) d[typoKey] = {};
        d[typoKey][property] = value;

        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
    },

    // Update typography element with unit
    updateTypographyWithUnit: function(element, property, value, unit) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};

        var typoKey = 'typography_' + element;
        if (!d[typoKey]) d[typoKey] = {};

        if (value === '' || value === null || value === undefined) {
            d[typoKey][property] = '';
        } else {
            d[typoKey][property] = value + (unit || '');
        }

        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
    },

    updateDesign: function(key, value) {
        if (!this.selectedModule) return;
        if (!this.selectedModule.module.design) this.selectedModule.module.design = {};
        this.selectedModule.module.design[key] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
    },

    // Update module content (for module-specific styling like post_content, comments)
    updateContent: function(key, value) {
        if (!this.selectedModule) return;
        if (!this.selectedModule.module.content) this.selectedModule.module.content = {};
        this.selectedModule.module.content[key] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BORDER SETTINGS (Advanced visual controls)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    renderBorderSettings: function() {
        var mod = this.selectedModule.module;
        var d = mod.design || {};
        var bwTop = parseInt(d.border_width_top) || 0;
        var bwRight = parseInt(d.border_width_right) || 0;
        var bwBottom = parseInt(d.border_width_bottom) || 0;
        var bwLeft = parseInt(d.border_width_left) || 0;
        var borderWidthLinked = d.border_width_linked || false;
        var borderStyle = d.border_style || 'none';
        var borderColor = d.border_color || '#e2e8f0';
        var brTL = parseInt(d.border_radius_tl) || 0;
        var brTR = parseInt(d.border_radius_tr) || 0;
        var brBR = parseInt(d.border_radius_br) || 0;
        var brBL = parseInt(d.border_radius_bl) || 0;
        var borderRadiusLinked = d.border_radius_linked || false;
        var html = '';

        // Border Width Section
        html += '<div class="tb-border-section">';
        html += '<div class="tb-border-section-header" onclick="TB.toggleBorderSection(this)">';
        html += '<div class="tb-border-section-title"><span style="color:#7c7fea">â—¼</span> Border Width</div>';
        html += '<span class="tb-border-section-toggle">â–¼</span>';
        html += '</div>';
        html += '<div class="tb-border-section-body">';
        html += this.renderBorderWidthBox(bwTop, bwRight, bwBottom, bwLeft, borderWidthLinked);
        html += '</div></div>';

        // Border Style Section
        html += '<div class="tb-border-section">';
        html += '<div class="tb-border-section-header" onclick="TB.toggleBorderSection(this)">';
        html += '<div class="tb-border-section-title"><span style="color:#89b4fa">â—¼</span> Border Style</div>';
        html += '<span class="tb-border-section-toggle">â–¼</span>';
        html += '</div>';
        html += '<div class="tb-border-section-body">';
        html += '<div class="tb-border-style-row">';
        html += '<label>Style</label>';
        html += '<select onchange="TB.updateDesign(\'border_style\',this.value)">';
        var styles = ['none', 'solid', 'dashed', 'dotted', 'double', 'groove', 'ridge', 'inset', 'outset'];
        styles.forEach(function(s) {
            html += '<option value="' + s + '"' + (borderStyle === s ? ' selected' : '') + '>' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>';
        });
        html += '</select>';
        html += '</div>';
        html += '</div></div>';

        // Border Color Section
        html += '<div class="tb-border-section">';
        html += '<div class="tb-border-section-header" onclick="TB.toggleBorderSection(this)">';
        html += '<div class="tb-border-section-title"><span style="color:#a6e3a1">â—¼</span> Border Color</div>';
        html += '<span class="tb-border-section-toggle">â–¼</span>';
        html += '</div>';
        html += '<div class="tb-border-section-body">';
        html += '<div class="tb-border-color-row">';
        html += '<label>Color</label>';
        html += '<input type="color" value="' + borderColor + '" onchange="TB.updateDesign(\'border_color\',this.value)">';
        html += '<input type="text" value="' + borderColor + '" placeholder="#e2e8f0" onchange="TB.updateDesign(\'border_color\',this.value)">';
        html += '</div>';
        html += '</div></div>';

        // Border Radius Section
        html += '<div class="tb-border-section">';
        html += '<div class="tb-border-section-header" onclick="TB.toggleBorderSection(this)">';
        html += '<div class="tb-border-section-title"><span style="color:#f5c2e7">â—¼</span> Border Radius</div>';
        html += '<span class="tb-border-section-toggle">â–¼</span>';
        html += '</div>';
        html += '<div class="tb-border-section-body">';
        html += this.renderBorderRadiusBox(brTL, brTR, brBR, brBL, borderRadiusLinked);
        html += '</div></div>';

        return html;
    },

    renderBorderWidthBox: function(top, right, bottom, left, linked) {
        var html = '<div class="tb-border-box">';
        html += '<div class="tb-border-box-outer">';
        html += '<span class="tb-border-label">WIDTH</span>';
        html += '<div class="tb-border-box-inner">';
        html += '<div class="tb-border-input-wrap tb-border-width-top">';
        html += '<input type="number" value="' + top + '" min="0" max="50" placeholder="0" onchange="TB.handleBorderWidthChange(\'top\',this.value)">';
        html += '</div>';
        html += '<div class="tb-border-input-wrap tb-border-width-right">';
        html += '<input type="number" value="' + right + '" min="0" max="50" placeholder="0" onchange="TB.handleBorderWidthChange(\'right\',this.value)">';
        html += '</div>';
        html += '<div class="tb-border-input-wrap tb-border-width-bottom">';
        html += '<input type="number" value="' + bottom + '" min="0" max="50" placeholder="0" onchange="TB.handleBorderWidthChange(\'bottom\',this.value)">';
        html += '</div>';
        html += '<div class="tb-border-input-wrap tb-border-width-left">';
        html += '<input type="number" value="' + left + '" min="0" max="50" placeholder="0" onchange="TB.handleBorderWidthChange(\'left\',this.value)">';
        html += '</div>';
        html += '<button type="button" class="tb-border-link-btn' + (linked ? ' linked' : '') + '" onclick="TB.toggleBorderLink(\'width\')" title="' + (linked ? 'Unlink values' : 'Link all values') + '">';
        html += linked ? 'ğŸ”—' : 'â›“ï¸';
        html += '</button>';
        html += '<div class="tb-border-box-content">Element</div>';
        html += '</div></div></div>';
        return html;
    },

    renderBorderRadiusBox: function(tl, tr, br, bl, linked) {
        var previewRadius = tl + 'px ' + tr + 'px ' + br + 'px ' + bl + 'px';
        var html = '<div class="tb-radius-box">';
        html += '<span class="tb-radius-label">CORNERS</span>';
        html += '<div class="tb-radius-box-visual" style="border-radius:' + previewRadius + '">';
        html += '<div class="tb-radius-corner tb-radius-tl">';
        html += '<input type="number" value="' + tl + '" min="0" max="200" placeholder="0" onchange="TB.handleBorderRadiusChange(\'tl\',this.value)" title="Top Left">';
        html += '</div>';
        html += '<div class="tb-radius-corner tb-radius-tr">';
        html += '<input type="number" value="' + tr + '" min="0" max="200" placeholder="0" onchange="TB.handleBorderRadiusChange(\'tr\',this.value)" title="Top Right">';
        html += '</div>';
        html += '<div class="tb-radius-corner tb-radius-br">';
        html += '<input type="number" value="' + br + '" min="0" max="200" placeholder="0" onchange="TB.handleBorderRadiusChange(\'br\',this.value)" title="Bottom Right">';
        html += '</div>';
        html += '<div class="tb-radius-corner tb-radius-bl">';
        html += '<input type="number" value="' + bl + '" min="0" max="200" placeholder="0" onchange="TB.handleBorderRadiusChange(\'bl\',this.value)" title="Bottom Left">';
        html += '</div>';
        html += '<button type="button" class="tb-radius-link-btn' + (linked ? ' linked' : '') + '" onclick="TB.toggleBorderLink(\'radius\')" title="' + (linked ? 'Unlink corners' : 'Link all corners') + '">';
        html += linked ? 'ğŸ”—' : 'â›“ï¸';
        html += '</button>';
        html += '</div></div>';
        return html;
    },

    toggleBorderSection: function(element) {
        var section = element.closest('.tb-border-section');
        if (section) section.classList.toggle('collapsed');
    },

    handleBorderWidthChange: function(side, value) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};
        var numValue = parseInt(value) || 0;
        var pxValue = numValue + 'px';
        if (d.border_width_linked) {
            d.border_width_top = pxValue;
            d.border_width_right = pxValue;
            d.border_width_bottom = pxValue;
            d.border_width_left = pxValue;
        } else {
            d['border_width_' + side] = pxValue;
        }
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    handleBorderRadiusChange: function(corner, value) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};
        var numValue = parseInt(value) || 0;
        var pxValue = numValue + 'px';
        if (d.border_radius_linked) {
            d.border_radius_tl = pxValue;
            d.border_radius_tr = pxValue;
            d.border_radius_br = pxValue;
            d.border_radius_bl = pxValue;
        } else {
            d['border_radius_' + corner] = pxValue;
        }
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    toggleBorderLink: function(type) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};
        var linkKey = type === 'width' ? 'border_width_linked' : 'border_radius_linked';
        var isLinked = !d[linkKey];
        d[linkKey] = isLinked;
        if (isLinked) {
            if (type === 'width') {
                var values = [parseInt(d.border_width_top) || 0, parseInt(d.border_width_right) || 0, parseInt(d.border_width_bottom) || 0, parseInt(d.border_width_left) || 0];
                var syncValue = values.find(function(v) { return v > 0; }) || 0;
                var pxValue = syncValue + 'px';
                d.border_width_top = pxValue;
                d.border_width_right = pxValue;
                d.border_width_bottom = pxValue;
                d.border_width_left = pxValue;
            } else {
                var values = [parseInt(d.border_radius_tl) || 0, parseInt(d.border_radius_tr) || 0, parseInt(d.border_radius_br) || 0, parseInt(d.border_radius_bl) || 0];
                var syncValue = values.find(function(v) { return v > 0; }) || 0;
                var pxValue = syncValue + 'px';
                d.border_radius_tl = pxValue;
                d.border_radius_tr = pxValue;
                d.border_radius_br = pxValue;
                d.border_radius_bl = pxValue;
            }
        }
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BOX SHADOW SETTINGS (Advanced visual controls)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    renderBoxShadowSettings: function() {
        var mod = this.selectedModule.module;
        var d = mod.design || {};
        var shadowEnabled = d.box_shadow_enabled || false;
        var shadowHorizontal = parseInt(d.box_shadow_horizontal) || 0;
        var shadowVertical = parseInt(d.box_shadow_vertical) || 4;
        var shadowBlur = parseInt(d.box_shadow_blur) || 10;
        var shadowSpread = parseInt(d.box_shadow_spread) || 0;
        var shadowColor = d.box_shadow_color || 'rgba(0,0,0,0.1)';
        var shadowInset = d.box_shadow_inset || false;
        var currentShadowCSS = this.getBoxShadowCSS(d);
        var html = '';

        html += '<div class="tb-shadow-section">';
        html += '<div class="tb-shadow-section-header" onclick="TB.toggleShadowSection(this)">';
        html += '<div class="tb-shadow-section-title"><span style="color:#94a3b8">â—¼</span> Shadow Settings</div>';
        html += '<span class="tb-shadow-section-toggle">â–¼</span>';
        html += '</div>';
        html += '<div class="tb-shadow-section-body">';
        html += '<div class="tb-shadow-enable-row">';
        html += '<label><input type="checkbox" ' + (shadowEnabled ? 'checked' : '') + ' onchange="TB.updateBoxShadow(\'box_shadow_enabled\',this.checked)"> Enable Box Shadow</label>';
        html += '</div>';
        html += '<div class="tb-shadow-controls' + (shadowEnabled ? '' : ' tb-shadow-disabled') + '" id="shadow-controls">';
        html += '<div class="tb-shadow-preview-box" style="box-shadow:' + (shadowEnabled ? currentShadowCSS : 'none') + '" id="shadow-preview"></div>';
        html += '<div class="tb-shadow-preset-row">';
        html += '<label>Preset</label>';
        html += '<select onchange="TB.applyBoxShadowPreset(this.value)">';
        html += '<option value="">Custom</option><option value="none">None</option><option value="subtle">Subtle</option><option value="medium">Medium</option><option value="large">Large</option><option value="sharp">Sharp</option><option value="soft">Soft</option><option value="inset_subtle">Inset Subtle</option>';
        html += '</select>';
        html += '</div>';
        html += '<div class="tb-shadow-control-row">';
        html += '<label>Horizontal</label>';
        html += '<input type="range" min="-50" max="50" value="' + shadowHorizontal + '" oninput="TB.updateBoxShadowSlider(\'box_shadow_horizontal\',this.value)">';
        html += '<input type="number" min="-50" max="50" value="' + shadowHorizontal + '" onchange="TB.updateBoxShadow(\'box_shadow_horizontal\',this.value)">px';
        html += '</div>';
        html += '<div class="tb-shadow-control-row">';
        html += '<label>Vertical</label>';
        html += '<input type="range" min="-50" max="50" value="' + shadowVertical + '" oninput="TB.updateBoxShadowSlider(\'box_shadow_vertical\',this.value)">';
        html += '<input type="number" min="-50" max="50" value="' + shadowVertical + '" onchange="TB.updateBoxShadow(\'box_shadow_vertical\',this.value)">px';
        html += '</div>';
        html += '<div class="tb-shadow-control-row">';
        html += '<label>Blur</label>';
        html += '<input type="range" min="0" max="100" value="' + shadowBlur + '" oninput="TB.updateBoxShadowSlider(\'box_shadow_blur\',this.value)">';
        html += '<input type="number" min="0" max="100" value="' + shadowBlur + '" onchange="TB.updateBoxShadow(\'box_shadow_blur\',this.value)">px';
        html += '</div>';
        html += '<div class="tb-shadow-control-row">';
        html += '<label>Spread</label>';
        html += '<input type="range" min="-50" max="50" value="' + shadowSpread + '" oninput="TB.updateBoxShadowSlider(\'box_shadow_spread\',this.value)">';
        html += '<input type="number" min="-50" max="50" value="' + shadowSpread + '" onchange="TB.updateBoxShadow(\'box_shadow_spread\',this.value)">px';
        html += '</div>';
        html += '<div class="tb-shadow-control-row">';
        html += '<label>Color</label>';
        html += '<input type="color" value="' + this.rgbaToHex(shadowColor) + '" onchange="TB.updateBoxShadowColor(this.value)">';
        html += '<input type="text" value="' + shadowColor + '" placeholder="rgba(0,0,0,0.1)" onchange="TB.updateBoxShadow(\'box_shadow_color\',this.value)">';
        html += '</div>';
        html += '<div class="tb-shadow-inset-row">';
        html += '<label><input type="checkbox" ' + (shadowInset ? 'checked' : '') + ' onchange="TB.updateBoxShadow(\'box_shadow_inset\',this.checked)"> Inset (inner shadow)</label>';
        html += '</div>';
        html += '</div></div></div>';
        return html;
    },

    toggleShadowSection: function(element) {
        var section = element.closest('.tb-shadow-section');
        if (section) section.classList.toggle('collapsed');
    },

    updateBoxShadow: function(property, value) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};
        if (property === 'box_shadow_enabled' || property === 'box_shadow_inset') {
            d[property] = value === true || value === 'true';
        } else if (property === 'box_shadow_color') {
            d[property] = value;
        } else {
            var numValue = parseInt(value) || 0;
            d[property] = numValue + 'px';
        }
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    updateBoxShadowSlider: function(property, value) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};
        var numValue = parseInt(value) || 0;
        d[property] = numValue + 'px';
        var controlsContainer = document.getElementById('shadow-controls');
        if (controlsContainer) {
            var rows = controlsContainer.querySelectorAll('.tb-shadow-control-row');
            rows.forEach(function(row) {
                var range = row.querySelector('input[type="range"]');
                var number = row.querySelector('input[type="number"]');
                if (range && number && parseInt(range.value) === numValue) {
                    number.value = numValue;
                }
            });
            var previewBox = document.getElementById('shadow-preview');
            if (previewBox) {
                previewBox.style.boxShadow = TB.getBoxShadowCSS(d);
            }
        }
        var self = this;
        clearTimeout(this.shadowUpdateTimer);
        this.shadowUpdateTimer = setTimeout(function() {
            self.isDirty = true;
            self.renderCanvas();
        }, 150);
    },

    updateBoxShadowColor: function(hexColor) {
        var rgba = this.hexToRgba(hexColor, 0.1);
        this.updateBoxShadow('box_shadow_color', rgba);
    },

    applyBoxShadowPreset: function(preset) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};
        var presets = {
            'none': { h: 0, v: 0, blur: 0, spread: 0, color: 'rgba(0,0,0,0)', inset: false },
            'subtle': { h: 0, v: 2, blur: 4, spread: 0, color: 'rgba(0,0,0,0.1)', inset: false },
            'medium': { h: 0, v: 4, blur: 12, spread: 0, color: 'rgba(0,0,0,0.15)', inset: false },
            'large': { h: 0, v: 10, blur: 30, spread: 0, color: 'rgba(0,0,0,0.2)', inset: false },
            'sharp': { h: 0, v: 2, blur: 8, spread: 0, color: 'rgba(0,0,0,0.25)', inset: false },
            'soft': { h: 0, v: 20, blur: 50, spread: 0, color: 'rgba(0,0,0,0.1)', inset: false },
            'inset_subtle': { h: 0, v: 2, blur: 4, spread: 0, color: 'rgba(0,0,0,0.1)', inset: true }
        };
        if (preset && presets[preset]) {
            var p = presets[preset];
            d.box_shadow_horizontal = p.h + 'px';
            d.box_shadow_vertical = p.v + 'px';
            d.box_shadow_blur = p.blur + 'px';
            d.box_shadow_spread = p.spread + 'px';
            d.box_shadow_color = p.color;
            d.box_shadow_inset = p.inset;
            if (preset !== 'none') d.box_shadow_enabled = true;
            this.isDirty = true;
            this.renderCanvas();
        this.saveCollapsedState();
            this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
        }
    },

    getBoxShadowCSS: function(d) {
        if (!d || !d.box_shadow_enabled) return 'none';
        var h = parseInt(d.box_shadow_horizontal) || 0;
        var v = parseInt(d.box_shadow_vertical) || 4;
        var blur = parseInt(d.box_shadow_blur) || 10;
        var spread = parseInt(d.box_shadow_spread) || 0;
        var color = d.box_shadow_color || 'rgba(0,0,0,0.1)';
        var inset = d.box_shadow_inset ? 'inset ' : '';
        return inset + h + 'px ' + v + 'px ' + blur + 'px ' + spread + 'px ' + color;
    },

    rgbaToHex: function(rgba) {
        if (!rgba || rgba.startsWith('#')) return rgba || '#000000';
        var match = rgba.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
        if (!match) return '#000000';
        var r = parseInt(match[1]).toString(16).padStart(2, '0');
        var g = parseInt(match[2]).toString(16).padStart(2, '0');
        var b = parseInt(match[3]).toString(16).padStart(2, '0');
        return '#' + r + g + b;
    },

    hexToRgba: function(hex, alpha) {
        var r = parseInt(hex.slice(1, 3), 16);
        var g = parseInt(hex.slice(3, 5), 16);
        var b = parseInt(hex.slice(5, 7), 16);
        return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
    },

    shadowUpdateTimer: null,

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRANSFORM SETTINGS (Advanced visual controls)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    renderTransformSettings: function() {
        var mod = this.selectedModule.module;
        var d = mod.design || {};
        var scaleX = parseFloat(d.transform_scale_x) || 1;
        var scaleY = parseFloat(d.transform_scale_y) || 1;
        var scaleLinked = d.transform_scale_linked !== false;
        var rotate = parseFloat(d.transform_rotate) || 0;
        var translateX = parseInt(d.transform_translate_x) || 0;
        var translateY = parseInt(d.transform_translate_y) || 0;
        var skewX = parseFloat(d.transform_skew_x) || 0;
        var skewY = parseFloat(d.transform_skew_y) || 0;
        var originX = d.transform_origin_x || '50%';
        var originY = d.transform_origin_y || '50%';
        var originValue = originX + ' ' + originY;
        var html = '';

        html += '<div class="tb-transform-section">';
        html += '<div class="tb-transform-section-header" onclick="TB.toggleTransformSection(this)">';
        html += '<div class="tb-transform-section-title"><span>ğŸ”„</span> Transform Controls</div>';
        html += '<span class="tb-transform-section-toggle">â–¼</span>';
        html += '</div>';
        html += '<div class="tb-transform-section-body">';

        // Scale subsection
        html += '<div class="tb-transform-subsection">';
        html += '<div class="tb-transform-subsection-title">ğŸ“ Scale</div>';
        html += '<label class="tb-scale-link-toggle' + (scaleLinked ? ' linked' : '') + '" onclick="TB.toggleScaleLink()">';
        html += '<input type="checkbox" ' + (scaleLinked ? 'checked' : '') + '> Link X/Y Scale';
        html += '</label>';
        html += '<div class="tb-transform-control-row">';
        html += '<label>Scale X</label>';
        html += '<input type="range" min="0" max="3" step="0.1" value="' + scaleX + '" oninput="TB.updateTransformSlider(\'transform_scale_x\',this.value)">';
        html += '<input type="number" min="0" max="3" step="0.1" value="' + scaleX + '" onchange="TB.updateTransformSetting(\'transform_scale_x\',this.value)">';
        html += '</div>';
        html += '<div class="tb-transform-control-row">';
        html += '<label>Scale Y</label>';
        html += '<input type="range" min="0" max="3" step="0.1" value="' + scaleY + '" oninput="TB.updateTransformSlider(\'transform_scale_y\',this.value)">';
        html += '<input type="number" min="0" max="3" step="0.1" value="' + scaleY + '" onchange="TB.updateTransformSetting(\'transform_scale_y\',this.value)">';
        html += '</div>';
        html += '</div>';

        // Rotate subsection
        html += '<div class="tb-transform-subsection">';
        html += '<div class="tb-transform-subsection-title">ğŸ”ƒ Rotate</div>';
        html += '<div class="tb-transform-control-row">';
        html += '<label>Angle</label>';
        html += '<input type="range" min="-180" max="180" step="1" value="' + rotate + '" oninput="TB.updateTransformSlider(\'transform_rotate\',this.value)">';
        html += '<input type="number" min="-360" max="360" step="1" value="' + rotate + '" onchange="TB.updateTransformSetting(\'transform_rotate\',this.value)">';
        html += '<span class="tb-unit-label">deg</span>';
        html += '</div>';
        html += '</div>';

        // Translate subsection
        html += '<div class="tb-transform-subsection">';
        html += '<div class="tb-transform-subsection-title">â†”ï¸ Translate</div>';
        html += '<div class="tb-transform-control-row">';
        html += '<label>Translate X</label>';
        html += '<input type="range" min="-200" max="200" step="1" value="' + translateX + '" oninput="TB.updateTransformSlider(\'transform_translate_x\',this.value)">';
        html += '<input type="number" min="-500" max="500" step="1" value="' + translateX + '" onchange="TB.updateTransformSetting(\'transform_translate_x\',this.value)">';
        html += '<span class="tb-unit-label">px</span>';
        html += '</div>';
        html += '<div class="tb-transform-control-row">';
        html += '<label>Translate Y</label>';
        html += '<input type="range" min="-200" max="200" step="1" value="' + translateY + '" oninput="TB.updateTransformSlider(\'transform_translate_y\',this.value)">';
        html += '<input type="number" min="-500" max="500" step="1" value="' + translateY + '" onchange="TB.updateTransformSetting(\'transform_translate_y\',this.value)">';
        html += '<span class="tb-unit-label">px</span>';
        html += '</div>';
        html += '</div>';

        // Skew subsection
        html += '<div class="tb-transform-subsection">';
        html += '<div class="tb-transform-subsection-title">â—‡ Skew</div>';
        html += '<div class="tb-transform-control-row">';
        html += '<label>Skew X</label>';
        html += '<input type="range" min="-45" max="45" step="1" value="' + skewX + '" oninput="TB.updateTransformSlider(\'transform_skew_x\',this.value)">';
        html += '<input type="number" min="-89" max="89" step="1" value="' + skewX + '" onchange="TB.updateTransformSetting(\'transform_skew_x\',this.value)">';
        html += '<span class="tb-unit-label">deg</span>';
        html += '</div>';
        html += '<div class="tb-transform-control-row">';
        html += '<label>Skew Y</label>';
        html += '<input type="range" min="-45" max="45" step="1" value="' + skewY + '" oninput="TB.updateTransformSlider(\'transform_skew_y\',this.value)">';
        html += '<input type="number" min="-89" max="89" step="1" value="' + skewY + '" onchange="TB.updateTransformSetting(\'transform_skew_y\',this.value)">';
        html += '<span class="tb-unit-label">deg</span>';
        html += '</div>';
        html += '</div>';

        // Transform Origin subsection
        html += '<div class="tb-transform-subsection">';
        html += '<div class="tb-transform-subsection-title">âŠ™ Transform Origin</div>';
        html += '<div class="tb-transform-origin-wrapper">';
        html += '<div class="tb-transform-origin-grid">';
        var origins = [
            {x: '0%', y: '0%'}, {x: '50%', y: '0%'}, {x: '100%', y: '0%'},
            {x: '0%', y: '50%'}, {x: '50%', y: '50%'}, {x: '100%', y: '50%'},
            {x: '0%', y: '100%'}, {x: '50%', y: '100%'}, {x: '100%', y: '100%'}
        ];
        origins.forEach(function(o) {
            var isActive = (originX === o.x && originY === o.y);
            html += '<div class="tb-transform-origin-point' + (isActive ? ' active' : '') + '" onclick="TB.setTransformOrigin(\'' + o.x + '\',\'' + o.y + '\')"></div>';
        });
        html += '</div>';
        html += '<div class="tb-transform-origin-value">' + originValue + '</div>';
        html += '<div class="tb-transform-origin-custom">';
        html += '<label>X<input type="text" value="' + originX + '" onchange="TB.setTransformOriginCustom(\'x\',this.value)"></label>';
        html += '<label>Y<input type="text" value="' + originY + '" onchange="TB.setTransformOriginCustom(\'y\',this.value)"></label>';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        // Reset button
        html += '<button type="button" class="tb-transform-reset-btn" onclick="TB.resetTransforms()">â†º Reset All Transforms</button>';
        html += '</div></div>';
        return html;
    },

    toggleTransformSection: function(element) {
        var section = element.closest('.tb-transform-section');
        if (section) section.classList.toggle('collapsed');
    },

    updateTransformSetting: function(property, value) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};
        if (property.indexOf('scale') > -1) {
            d[property] = parseFloat(value) || 1;
            if (d.transform_scale_linked !== false) {
                var otherProp = property === 'transform_scale_x' ? 'transform_scale_y' : 'transform_scale_x';
                d[otherProp] = d[property];
            }
        } else if (property.indexOf('rotate') > -1 || property.indexOf('skew') > -1) {
            d[property] = parseFloat(value) || 0;
        } else {
            d[property] = parseInt(value) || 0;
        }
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    updateTransformSlider: function(property, value) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};
        if (property.indexOf('scale') > -1) {
            d[property] = parseFloat(value) || 1;
            if (d.transform_scale_linked !== false) {
                var otherProp = property === 'transform_scale_x' ? 'transform_scale_y' : 'transform_scale_x';
                d[otherProp] = d[property];
            }
        } else if (property.indexOf('rotate') > -1 || property.indexOf('skew') > -1) {
            d[property] = parseFloat(value) || 0;
        } else {
            d[property] = parseInt(value) || 0;
        }
        var self = this;
        clearTimeout(this.transformUpdateTimer);
        this.transformUpdateTimer = setTimeout(function() {
            self.isDirty = true;
            self.renderCanvas();
            self.renderDesignSettings();
        }, 100);
    },

    toggleScaleLink: function() {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};
        d.transform_scale_linked = !d.transform_scale_linked;
        if (d.transform_scale_linked) {
            var scaleX = parseFloat(d.transform_scale_x) || 1;
            d.transform_scale_y = scaleX;
        }
        this.isDirty = true;
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    setTransformOrigin: function(x, y) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};
        d.transform_origin_x = x;
        d.transform_origin_y = y;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    setTransformOriginCustom: function(axis, value) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};
        d['transform_origin_' + axis] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    resetTransforms: function() {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};
        d.transform_scale_x = 1;
        d.transform_scale_y = 1;
        d.transform_scale_linked = true;
        d.transform_rotate = 0;
        d.transform_translate_x = 0;
        d.transform_translate_y = 0;
        d.transform_skew_x = 0;
        d.transform_skew_y = 0;
        d.transform_origin_x = '50%';
        d.transform_origin_y = '50%';
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    transformUpdateTimer: null,

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // POSITION SETTINGS (Full Offset Box from TB Pages)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    renderPositionSettings: function() {
        var mod = this.selectedModule.module;
        var d = mod.design || {};

        var positionType = d.position || 'relative';
        var positionTop = d.position_top || '';
        var positionRight = d.position_right || '';
        var positionBottom = d.position_bottom || '';
        var positionLeft = d.position_left || '';
        var zIndex = d.z_index || 'auto';

        var showOffsets = (positionType !== 'static');

        var html = '';

        // Position Type Dropdown
        html += '<div class="tb-setting-group">';
        html += '<div class="tb-setting-label">Position Type</div>';
        html += '<select class="tb-setting-input" onchange="TB.updateDesign(\'position\',this.value);TB.renderDesignSettings()">';
        html += '<option value="static"' + (positionType === 'static' ? ' selected' : '') + '>Static (Default)</option>';
        html += '<option value="relative"' + (positionType === 'relative' ? ' selected' : '') + '>Relative</option>';
        html += '<option value="absolute"' + (positionType === 'absolute' ? ' selected' : '') + '>Absolute</option>';
        html += '<option value="fixed"' + (positionType === 'fixed' ? ' selected' : '') + '>Fixed</option>';
        html += '<option value="sticky"' + (positionType === 'sticky' ? ' selected' : '') + '>Sticky</option>';
        html += '</select></div>';

        // Position info text
        html += '<div class="tb-position-info" style="font-size:11px;color:var(--tb-text-muted);padding:8px;background:var(--tb-bg-tertiary);border-radius:4px;margin-bottom:12px">';
        if (positionType === 'static') {
            html += '<strong>Static:</strong> Default positioning. Elements flow normally in the document.';
        } else if (positionType === 'relative') {
            html += '<strong>Relative:</strong> Positioned relative to its normal position. Use offsets to nudge the element.';
        } else if (positionType === 'absolute') {
            html += '<strong>Absolute:</strong> Removed from document flow. Positioned relative to nearest positioned ancestor.';
        } else if (positionType === 'fixed') {
            html += '<strong>Fixed:</strong> Positioned relative to the viewport. Stays in place during scrolling.';
        } else if (positionType === 'sticky') {
            html += '<strong>Sticky:</strong> Toggles between relative and fixed based on scroll position.';
        }
        html += '</div>';

        // Warning for absolute/fixed
        if (positionType === 'absolute' || positionType === 'fixed') {
            html += '<div class="tb-position-warning" style="display:flex;gap:8px;padding:10px;background:rgba(249,226,175,0.15);border:1px solid rgba(249,226,175,0.3);border-radius:6px;margin-bottom:12px">';
            html += '<span>âš ï¸</span>';
            html += '<div style="font-size:11px;color:var(--tb-text)">';
            if (positionType === 'absolute') {
                html += '<strong>Layout Warning:</strong> Absolute positioning removes the element from normal flow. Ensure a parent has <code style="background:var(--tb-bg-tertiary);padding:2px 4px;border-radius:2px">position: relative</code> for proper containment.';
            } else {
                html += '<strong>Layout Warning:</strong> Fixed elements may overlap other content and behave differently on mobile devices.';
            }
            html += '</div></div>';
        }

        // Position Offsets (visual box)
        if (showOffsets) {
            html += '<div class="tb-position-offset-box" style="margin-bottom:16px">';
            html += '<div class="tb-setting-label" style="margin-bottom:10px">â†”ï¸ Position Offsets</div>';
            html += '<div class="tb-position-offset-visual" style="position:relative;width:100%;padding:28px;background:var(--tb-bg-tertiary);border:1px dashed var(--tb-border);border-radius:8px">';

            // Top offset
            html += '<div class="tb-position-offset-input" style="position:absolute;top:-8px;left:50%;transform:translateX(-50%)">';
            html += '<div style="display:flex;flex-direction:column;align-items:center;gap:2px">';
            html += '<span style="font-size:9px;color:var(--tb-text-muted);text-transform:uppercase">Top</span>';
            html += '<input type="text" style="width:50px;text-align:center;padding:4px;background:var(--tb-bg-secondary);border:1px solid var(--tb-border);border-radius:4px;font-size:11px;color:var(--tb-text)" value="' + this.escHtml(positionTop) + '" placeholder="auto" onchange="TB.updateDesign(\'position_top\',this.value)">';
            html += '</div></div>';

            // Right offset
            html += '<div class="tb-position-offset-input" style="position:absolute;right:-8px;top:50%;transform:translateY(-50%)">';
            html += '<div style="display:flex;flex-direction:column;align-items:center;gap:2px">';
            html += '<span style="font-size:9px;color:var(--tb-text-muted);text-transform:uppercase">Right</span>';
            html += '<input type="text" style="width:50px;text-align:center;padding:4px;background:var(--tb-bg-secondary);border:1px solid var(--tb-border);border-radius:4px;font-size:11px;color:var(--tb-text)" value="' + this.escHtml(positionRight) + '" placeholder="auto" onchange="TB.updateDesign(\'position_right\',this.value)">';
            html += '</div></div>';

            // Bottom offset
            html += '<div class="tb-position-offset-input" style="position:absolute;bottom:-8px;left:50%;transform:translateX(-50%)">';
            html += '<div style="display:flex;flex-direction:column;align-items:center;gap:2px">';
            html += '<input type="text" style="width:50px;text-align:center;padding:4px;background:var(--tb-bg-secondary);border:1px solid var(--tb-border);border-radius:4px;font-size:11px;color:var(--tb-text)" value="' + this.escHtml(positionBottom) + '" placeholder="auto" onchange="TB.updateDesign(\'position_bottom\',this.value)">';
            html += '<span style="font-size:9px;color:var(--tb-text-muted);text-transform:uppercase">Bottom</span>';
            html += '</div></div>';

            // Left offset
            html += '<div class="tb-position-offset-input" style="position:absolute;left:-8px;top:50%;transform:translateY(-50%)">';
            html += '<div style="display:flex;flex-direction:column;align-items:center;gap:2px">';
            html += '<span style="font-size:9px;color:var(--tb-text-muted);text-transform:uppercase">Left</span>';
            html += '<input type="text" style="width:50px;text-align:center;padding:4px;background:var(--tb-bg-secondary);border:1px solid var(--tb-border);border-radius:4px;font-size:11px;color:var(--tb-text)" value="' + this.escHtml(positionLeft) + '" placeholder="auto" onchange="TB.updateDesign(\'position_left\',this.value)">';
            html += '</div></div>';

            // Center element indicator
            html += '<div style="text-align:center;font-size:11px;color:var(--tb-text-muted);padding:20px">Module</div>';

            html += '</div>'; // visual

            // Quick actions
            html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px">';
            html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.applyPositionPreset(\'center-h\')" title="Center horizontally">â†”ï¸ Center H</button>';
            html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.applyPositionPreset(\'center-v\')" title="Center vertically">â†•ï¸ Center V</button>';
            html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.applyPositionPreset(\'fill\')" title="Fill container">â¬œ Fill</button>';
            html += '<button type="button" class="tb-btn tb-btn-sm" onclick="TB.applyPositionPreset(\'reset\')" title="Reset offsets">â†º Reset</button>';
            html += '</div>';

            html += '</div>'; // offset box
        }

        // Z-Index Section
        html += '<div class="tb-setting-group">';
        html += '<div class="tb-setting-label">ğŸ“Š Z-Index (Stacking Order)</div>';
        html += '<input type="text" class="tb-setting-input" value="' + this.escHtml(zIndex) + '" placeholder="auto" onchange="TB.updateDesign(\'z_index\',this.value)">';
        html += '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:8px">';
        ['-1', '0', '1', '10', '100', '999', 'auto'].forEach(function(z) {
            var isActive = zIndex === z;
            html += '<button type="button" class="tb-btn tb-btn-sm' + (isActive ? ' active' : '') + '" style="' + (isActive ? 'background:var(--tb-accent);color:var(--tb-bg)' : '') + '" onclick="TB.updateDesign(\'z_index\',\'' + z + '\');TB.renderDesignSettings()">' + z + '</button>';
        });
        html += '</div></div>';

        return html;
    },

    // Apply position preset
    applyPositionPreset: function(preset) {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design;
        if (!d) d = this.selectedModule.module.design = {};

        switch(preset) {
            case 'center-h':
                d.position_left = '50%';
                d.position_right = '';
                d.transform_translate_x = '-50%';
                break;
            case 'center-v':
                d.position_top = '50%';
                d.position_bottom = '';
                d.transform_translate_y = '-50%';
                break;
            case 'fill':
                d.position_top = '0';
                d.position_right = '0';
                d.position_bottom = '0';
                d.position_left = '0';
                break;
            case 'reset':
                d.position_top = '';
                d.position_right = '';
                d.position_bottom = '';
                d.position_left = '';
                break;
        }

        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderDesignSettings();
        setTimeout(function() { TB.restoreCollapsedState(); }, 10);
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ANIMATION SETTINGS (Full Animation Panel from TB Pages)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    renderAnimationSettings: function() {
        var mod = this.selectedModule.module;
        var d = mod.design || {};

        var animEnabled = d.animation_enabled || false;
        var animType = d.animation_type || 'fadeIn';
        var animDuration = d.animation_duration || '600';
        var animDelay = d.animation_delay || '0';
        var animEasing = d.animation_easing || 'ease-out';
        var animIntensity = d.animation_intensity || '100';

        // Scroll trigger settings
        var scrollEnabled = d.scroll_trigger_enabled || false;
        var scrollTriggerPoint = d.scroll_trigger_point || '80';
        var scrollAnimateOnce = d.scroll_animate_once !== false;

        var html = '';

        // Enable Toggle
        html += '<div class="tb-setting-group">';
        html += '<div style="display:flex;align-items:center;gap:10px">';
        html += '<label class="tb-toggle-switch" style="position:relative;display:inline-block;width:44px;height:24px">';
        html += '<input type="checkbox" ' + (animEnabled ? 'checked' : '') + ' style="opacity:0;width:0;height:0" onchange="TB.updateDesign(\'animation_enabled\',this.checked);TB.renderDesignSettings()">';
        html += '<span class="tb-toggle-slider" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--tb-bg-tertiary);transition:.4s;border-radius:24px"></span>';
        html += '</label>';
        html += '<span class="tb-setting-label" style="margin:0">Enable Animation</span>';
        if (animEnabled) {
            html += '<span style="font-size:10px;padding:2px 8px;background:var(--tb-accent);color:var(--tb-bg);border-radius:10px;font-weight:600">ON</span>';
        }
        html += '</div></div>';

        // Animation options (only show if enabled)
        if (animEnabled) {
            // Animation Type
            html += '<div class="tb-setting-group">';
            html += '<div class="tb-setting-label">Animation Type</div>';
            html += '<select class="tb-setting-input" onchange="TB.updateDesign(\'animation_type\',this.value)">';
            html += '<optgroup label="Fade">';
            html += '<option value="fadeIn"' + (animType === 'fadeIn' ? ' selected' : '') + '>Fade In</option>';
            html += '<option value="fadeInUp"' + (animType === 'fadeInUp' ? ' selected' : '') + '>Fade In Up</option>';
            html += '<option value="fadeInDown"' + (animType === 'fadeInDown' ? ' selected' : '') + '>Fade In Down</option>';
            html += '<option value="fadeInLeft"' + (animType === 'fadeInLeft' ? ' selected' : '') + '>Fade In Left</option>';
            html += '<option value="fadeInRight"' + (animType === 'fadeInRight' ? ' selected' : '') + '>Fade In Right</option>';
            html += '</optgroup>';
            html += '<optgroup label="Slide">';
            html += '<option value="slideInUp"' + (animType === 'slideInUp' ? ' selected' : '') + '>Slide In Up</option>';
            html += '<option value="slideInDown"' + (animType === 'slideInDown' ? ' selected' : '') + '>Slide In Down</option>';
            html += '<option value="slideInLeft"' + (animType === 'slideInLeft' ? ' selected' : '') + '>Slide In Left</option>';
            html += '<option value="slideInRight"' + (animType === 'slideInRight' ? ' selected' : '') + '>Slide In Right</option>';
            html += '</optgroup>';
            html += '<optgroup label="Zoom">';
            html += '<option value="zoomIn"' + (animType === 'zoomIn' ? ' selected' : '') + '>Zoom In</option>';
            html += '<option value="zoomInUp"' + (animType === 'zoomInUp' ? ' selected' : '') + '>Zoom In Up</option>';
            html += '<option value="zoomInDown"' + (animType === 'zoomInDown' ? ' selected' : '') + '>Zoom In Down</option>';
            html += '<option value="zoomOut"' + (animType === 'zoomOut' ? ' selected' : '') + '>Zoom Out</option>';
            html += '</optgroup>';
            html += '<optgroup label="Bounce & Effects">';
            html += '<option value="bounce"' + (animType === 'bounce' ? ' selected' : '') + '>Bounce</option>';
            html += '<option value="bounceIn"' + (animType === 'bounceIn' ? ' selected' : '') + '>Bounce In</option>';
            html += '<option value="pulse"' + (animType === 'pulse' ? ' selected' : '') + '>Pulse</option>';
            html += '<option value="shake"' + (animType === 'shake' ? ' selected' : '') + '>Shake</option>';
            html += '<option value="flip"' + (animType === 'flip' ? ' selected' : '') + '>Flip</option>';
            html += '<option value="swing"' + (animType === 'swing' ? ' selected' : '') + '>Swing</option>';
            html += '</optgroup>';
            html += '</select></div>';

            // Duration slider
            html += '<div class="tb-setting-group">';
            html += '<div class="tb-setting-label">Duration: ' + animDuration + 'ms</div>';
            html += '<div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="range" style="flex:1" min="100" max="2000" step="100" value="' + parseInt(animDuration) + '" oninput="this.nextElementSibling.value=this.value;TB.updateDesign(\'animation_duration\',this.value)">';
            html += '<input type="number" style="width:70px" class="tb-setting-input" min="100" max="5000" step="100" value="' + parseInt(animDuration) + '" onchange="TB.updateDesign(\'animation_duration\',this.value)">';
            html += '<span style="font-size:11px;color:var(--tb-text-muted)">ms</span>';
            html += '</div></div>';

            // Delay slider
            html += '<div class="tb-setting-group">';
            html += '<div class="tb-setting-label">Delay: ' + animDelay + 'ms</div>';
            html += '<div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="range" style="flex:1" min="0" max="2000" step="100" value="' + parseInt(animDelay) + '" oninput="this.nextElementSibling.value=this.value;TB.updateDesign(\'animation_delay\',this.value)">';
            html += '<input type="number" style="width:70px" class="tb-setting-input" min="0" max="5000" step="100" value="' + parseInt(animDelay) + '" onchange="TB.updateDesign(\'animation_delay\',this.value)">';
            html += '<span style="font-size:11px;color:var(--tb-text-muted)">ms</span>';
            html += '</div></div>';

            // Easing dropdown
            html += '<div class="tb-setting-group">';
            html += '<div class="tb-setting-label">Easing</div>';
            html += '<select class="tb-setting-input" onchange="TB.updateDesign(\'animation_easing\',this.value)">';
            var easings = ['linear', 'ease', 'ease-in', 'ease-out', 'ease-in-out', 'cubic-bezier(0.4,0,0.2,1)', 'cubic-bezier(0.68,-0.55,0.27,1.55)'];
            var easingLabels = ['Linear', 'Ease', 'Ease In', 'Ease Out', 'Ease In Out', 'Material', 'Bounce'];
            easings.forEach(function(e, i) {
                html += '<option value="' + e + '"' + (animEasing === e ? ' selected' : '') + '>' + easingLabels[i] + '</option>';
            });
            html += '</select></div>';

            // Intensity slider
            html += '<div class="tb-setting-group">';
            html += '<div class="tb-setting-label">Intensity: ' + animIntensity + '%</div>';
            html += '<div style="display:flex;gap:8px;align-items:center">';
            html += '<input type="range" style="flex:1" min="25" max="200" step="25" value="' + parseInt(animIntensity) + '" oninput="this.nextElementSibling.value=this.value;TB.updateDesign(\'animation_intensity\',this.value)">';
            html += '<input type="number" style="width:70px" class="tb-setting-input" min="25" max="200" step="25" value="' + parseInt(animIntensity) + '" onchange="TB.updateDesign(\'animation_intensity\',this.value)">';
            html += '<span style="font-size:11px;color:var(--tb-text-muted)">%</span>';
            html += '</div></div>';

            // Scroll Trigger Subsection
            html += '<div style="border-top:1px solid var(--tb-border);margin-top:16px;padding-top:16px">';
            html += '<div class="tb-setting-label" style="font-weight:600;margin-bottom:12px">ğŸ“œ Scroll Trigger</div>';

            html += '<div class="tb-setting-group">';
            html += '<div style="display:flex;align-items:center;gap:10px">';
            html += '<label><input type="checkbox" ' + (scrollEnabled ? 'checked' : '') + ' onchange="TB.updateDesign(\'scroll_trigger_enabled\',this.checked);TB.renderDesignSettings()"> Enable scroll-triggered animation</label>';
            html += '</div></div>';

            if (scrollEnabled) {
                // Trigger point
                html += '<div class="tb-setting-group">';
                html += '<div class="tb-setting-label">Trigger Point: ' + scrollTriggerPoint + '%</div>';
                html += '<div style="display:flex;gap:8px;align-items:center">';
                html += '<input type="range" style="flex:1" min="0" max="100" step="5" value="' + parseInt(scrollTriggerPoint) + '" oninput="this.nextElementSibling.value=this.value;TB.updateDesign(\'scroll_trigger_point\',this.value)">';
                html += '<input type="number" style="width:60px" class="tb-setting-input" min="0" max="100" step="5" value="' + parseInt(scrollTriggerPoint) + '" onchange="TB.updateDesign(\'scroll_trigger_point\',this.value)">';
                html += '<span style="font-size:11px;color:var(--tb-text-muted)">%</span>';
                html += '</div>';
                html += '<div style="font-size:10px;color:var(--tb-text-muted);margin-top:4px">Distance from viewport top when animation triggers</div>';
                html += '</div>';

                // Animate once
                html += '<div class="tb-setting-group">';
                html += '<label style="display:flex;align-items:center;gap:8px">';
                html += '<input type="checkbox" ' + (scrollAnimateOnce ? 'checked' : '') + ' onchange="TB.updateDesign(\'scroll_animate_once\',this.checked)">';
                html += '<span>Animate only once (don\'t repeat on scroll)</span>';
                html += '</label></div>';
            }

            html += '</div>'; // scroll trigger section

            // Preview Button
            html += '<div style="margin-top:16px">';
            html += '<button type="button" class="tb-btn" style="width:100%" onclick="TB.previewAnimation()">â–¶ Preview Animation</button>';
            html += '</div>';
        }

        return html;
    },

    // Preview animation
    previewAnimation: function() {
        if (!this.selectedModule) return;
        var d = this.selectedModule.module.design || {};
        var animType = d.animation_type || 'fadeIn';
        var animDuration = parseInt(d.animation_duration) || 600;
        var animDelay = parseInt(d.animation_delay) || 0;

        // Find the module element in the canvas
        var moduleEl = document.querySelector('.tb-selected-module') || document.querySelector('[data-module-type]');
        if (moduleEl) {
            // Remove existing animation classes
            moduleEl.style.animation = 'none';
            moduleEl.offsetHeight; // Force reflow
            moduleEl.style.animation = animType + ' ' + animDuration + 'ms ease-out ' + animDelay + 'ms both';

            // Show toast
            this.showToast('Playing: ' + animType, 'info');
        }
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADVANCED SETTINGS (CSS Class, ID, Custom CSS)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    renderAdvancedSettings: function() {
        var container = document.getElementById('moduleSettingsPanel');
        var mod = this.selectedModule.module;
        var adv = mod.advanced || {};
        var html = '<h3 style="margin-bottom:16px">âš™ï¸ Advanced Settings</h3>';
        
        html += '<div class="tb-setting-group">';
        html += '<label class="tb-setting-label">CSS Class</label>';
        html += '<input type="text" class="tb-setting-input" placeholder="my-custom-class" value="' + this.escHtml(adv.css_class || '') + '" onchange="TB.updateAdvanced(\'css_class\',this.value)">';
        html += '</div>';
        
        html += '<div class="tb-setting-group">';
        html += '<label class="tb-setting-label">CSS ID</label>';
        html += '<input type="text" class="tb-setting-input" placeholder="my-element-id" value="' + this.escHtml(adv.css_id || '') + '" onchange="TB.updateAdvanced(\'css_id\',this.value)">';
        html += '</div>';
        
        html += '<div class="tb-setting-group">';
        html += '<label class="tb-setting-label">Custom CSS</label>';
        html += '<textarea class="tb-setting-input" rows="6" style="font-family:monospace;font-size:12px" placeholder=".my-class { color: red; }" onchange="TB.updateAdvanced(\'custom_css\',this.value)">' + this.escHtml(adv.custom_css || '') + '</textarea>';
        html += '</div>';
        
        container.innerHTML = html;
    },

    updateAdvanced: function(key, value) {
        if (!this.selectedModule) return;
        if (!this.selectedModule.module.advanced) this.selectedModule.module.advanced = {};
        this.selectedModule.module.advanced[key] = value;
        this.isDirty = true;
    },

    fieldInput: function(name, label, value, enableAI) {
        var aiBtn = enableAI ? '<button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'text\', \'' + name + '\')">âœ¨ AI Generate</button>' : '';
        return '<div class="tb-field"><label class="tb-label">' + label + '</label><input type="text" class="tb-input" id="field_' + name + '" value="' + this.escHtml(value) + '" onchange="TB.updateModuleField(\'' + name + '\', this.value)">' + aiBtn + '</div>';
    },

    fieldTextarea: function(name, label, value, enableAI) {
        var aiBtn = enableAI ? '<button type="button" class="tb-btn-ai" onclick="TB.handleAIGenerate(\'text\', \'' + name + '\')">âœ¨ AI Generate</button>' : '';
        return '<div class="tb-field"><label class="tb-label">' + label + '</label><textarea class="tb-input" id="field_' + name + '" rows="4" onchange="TB.updateModuleField(\'' + name + '\', this.value)">' + this.escHtml(value) + '</textarea>' + aiBtn + '</div>';
    },

    fieldSelect: function(name, label, value, options) {
        var opts = options.map(function(o) { return '<option value="' + o + '"' + (o === value ? ' selected' : '') + '>' + o + '</option>'; }).join('');
        return '<div class="tb-field"><label class="tb-label">' + label + '</label><select class="tb-input" onchange="TB.updateModuleField(\'' + name + '\', this.value)">' + opts + '</select></div>';
    },

    fieldCheckbox: function(name, label, checked) {
        var checkedAttr = checked ? ' checked' : '';
        return '<div class="tb-field" style="display:flex;align-items:center;gap:10px"><input type="checkbox" id="chk_' + name + '"' + checkedAttr + ' onchange="TB.updateModuleField(\'' + name + '\', this.checked)" style="width:18px;height:18px"><label for="chk_' + name + '" class="tb-label" style="margin:0">' + label + '</label></div>';
    },

    fieldItems: function(name, label, items, fields) {
        var self = this;
        var html = '<div class="tb-field"><label class="tb-label">' + label + '</label>';
        html += '<div id="items_' + name + '" style="margin-bottom:8px">';
        items.forEach(function(item, idx) {
            html += '<div style="display:flex;gap:4px;margin-bottom:6px;padding:8px;background:var(--tb-bg);border-radius:4px">';
            fields.forEach(function(f) {
                var isTextarea = f === 'content';
                if (isTextarea) {
                    html += '<textarea class="tb-input" style="flex:1;min-height:60px" placeholder="' + f + '" onchange="TB.updateItemField(\'' + name + '\',' + idx + ',\'' + f + '\',this.value)">' + self.escHtml(item[f] || '') + '</textarea>';
                } else {
                    html += '<input type="text" class="tb-input" style="flex:1" placeholder="' + f + '" value="' + self.escHtml(item[f] || '') + '" onchange="TB.updateItemField(\'' + name + '\',' + idx + ',\'' + f + '\',this.value)">';
                }
            });
            html += '<button type="button" onclick="TB.removeItem(\'' + name + '\',' + idx + ')" style="background:var(--tb-danger);color:#fff;border:none;border-radius:4px;padding:0 10px;cursor:pointer">Ã—</button>';
            html += '</div>';
        });
        html += '</div>';
        html += '<button type="button" onclick="TB.addItem(\'' + name + '\',\'' + fields.join(',') + '\')" class="tb-btn" style="width:100%">+ Add Item</button></div>';
        return html;
    },

    fieldSocial: function(name, label, networks) {
        var self = this;
        var socialOptions = ['facebook','twitter','instagram','linkedin','youtube','tiktok','pinterest','github','dribbble','behance'];
        var html = '<div class="tb-field"><label class="tb-label">' + label + '</label>';
        html += '<div id="social_' + name + '" style="margin-bottom:8px">';
        networks.forEach(function(net, idx) {
            html += '<div style="display:flex;gap:4px;margin-bottom:6px">';
            html += '<select class="tb-input" style="width:120px" onchange="TB.updateSocialField(\'' + name + '\',' + idx + ',\'network\',this.value)">';
            socialOptions.forEach(function(opt) {
                html += '<option value="' + opt + '"' + (opt === net.network ? ' selected' : '') + '>' + opt + '</option>';
            });
            html += '</select>';
            html += '<input type="text" class="tb-input" style="flex:1" placeholder="URL" value="' + self.escHtml(net.url || '') + '" onchange="TB.updateSocialField(\'' + name + '\',' + idx + ',\'url\',this.value)">';
            html += '<button type="button" onclick="TB.removeSocial(\'' + name + '\',' + idx + ')" style="background:var(--tb-danger);color:#fff;border:none;border-radius:4px;padding:0 10px;cursor:pointer">Ã—</button>';
            html += '</div>';
        });
        html += '</div>';
        html += '<button type="button" onclick="TB.addSocial(\'' + name + '\')" class="tb-btn" style="width:100%">+ Add Network</button></div>';
        return html;
    },

    fieldGallery: function(name, label, images) {
        var self = this;
        var html = '<div class="tb-field"><label class="tb-label">' + label + '</label>';
        html += '<div id="gallery_' + name + '" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px">';
        images.forEach(function(img, idx) {
            var src = typeof img === 'string' ? img : (img.src || img.url || '');
            html += '<div style="position:relative;aspect-ratio:1;background:var(--tb-bg);border-radius:6px;overflow:hidden">';
            if (src) {
                html += '<img src="' + src + '" style="width:100%;height:100%;object-fit:cover">';
            } else {
                html += '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--tb-text-dim)">ğŸ“·</div>';
            }
            html += '<button type="button" onclick="TB.removeGalleryImage(\'' + name + '\',' + idx + ')" style="position:absolute;top:4px;right:4px;background:var(--tb-danger);color:#fff;border:none;border-radius:4px;width:20px;height:20px;cursor:pointer;font-size:12px">Ã—</button>';
            html += '</div>';
        });
        html += '</div>';
        html += '<button type="button" onclick="TB.addGalleryImage(\'' + name + '\')" class="tb-btn" style="width:100%">+ Add Image</button></div>';
        return html;
    },

    // Item management functions
    updateItemField: function(name, idx, field, value) {
        if (!this.selectedModule) return;
        var c = this.selectedModule.module.content;
        if (!c[name]) c[name] = [];
        if (!c[name][idx]) c[name][idx] = {};
        c[name][idx][field] = value;
        this.isDirty = true;
    },

    addItem: function(name, fieldsStr) {
        if (!this.selectedModule) return;
        var c = this.selectedModule.module.content;
        if (!c[name]) c[name] = [];
        var fields = fieldsStr.split(',');
        var newItem = {};
        fields.forEach(function(f) { newItem[f] = ''; });
        c[name].push(newItem);
        this.isDirty = true;
        this.renderElementSettings();
    },

    removeItem: function(name, idx) {
        if (!this.selectedModule) return;
        var c = this.selectedModule.module.content;
        if (c[name]) {
            c[name].splice(idx, 1);
            this.isDirty = true;
            this.renderElementSettings();
            this.renderCanvas();
        this.saveCollapsedState();
        }
    },

    // Social network management
    updateSocialField: function(name, idx, field, value) {
        if (!this.selectedModule) return;
        var c = this.selectedModule.module.content;
        if (!c[name]) c[name] = [];
        if (!c[name][idx]) c[name][idx] = {};
        c[name][idx][field] = value;
        this.isDirty = true;
    },

    addSocial: function(name) {
        if (!this.selectedModule) return;
        var c = this.selectedModule.module.content;
        if (!c[name]) c[name] = [];
        c[name].push({network:'facebook',url:'#'});
        this.isDirty = true;
        this.renderElementSettings();
    },

    removeSocial: function(name, idx) {
        if (!this.selectedModule) return;
        var c = this.selectedModule.module.content;
        if (c[name]) {
            c[name].splice(idx, 1);
            this.isDirty = true;
            this.renderElementSettings();
        }
    },

    // Gallery image management
    addGalleryImage: function(name) {
        var self = this;
        this.openMediaGallery(function(url) {
            if (!self.selectedModule) return;
            var c = self.selectedModule.module.content;
            if (!c[name]) c[name] = [];
            c[name].push({src:url});
            self.isDirty = true;
            self.renderElementSettings();
            self.renderCanvas();
        });
    },

    removeGalleryImage: function(name, idx) {
        if (!this.selectedModule) return;
        var c = this.selectedModule.module.content;
        if (c[name]) {
            c[name].splice(idx, 1);
            this.isDirty = true;
            this.renderElementSettings();
            this.renderCanvas();
        this.saveCollapsedState();
        }
    },

    updateModuleField: function(field, value) {
        if (!this.selectedModule) return;
        if (!this.selectedModule.module.content) this.selectedModule.module.content = {};
        this.selectedModule.module.content[field] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
    },

    removeSelectedModule: function() {
        if (!this.selectedModule || !confirm('Remove this module?')) return;
        var path = this.selectedModule.path.split('-');
        this.content.sections[path[0]].rows[path[1]].columns[path[2]].modules.splice(path[3], 1);
        this.selectedModule = null;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.renderElementSettings();
    },

    escHtml: function(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    },

    // Alias for typography.js compatibility
    escapeHtml: function(str) {
        return this.escHtml(str);
    },

    // Helper function to build typography style string from design object
    getTypographyStyles: function(design) {
        if (!design) return '';
        var styles = '';
        if (design.font_family) styles += 'font-family:' + design.font_family + ';';
        if (design.font_size) styles += 'font-size:' + design.font_size + ';';
        if (design.font_weight) styles += 'font-weight:' + design.font_weight + ';';
        if (design.line_height) styles += 'line-height:' + design.line_height + ';';
        if (design.letter_spacing) styles += 'letter-spacing:' + design.letter_spacing + ';';
        if (design.text_transform) styles += 'text-transform:' + design.text_transform + ';';
        if (design.text_color) styles += 'color:' + design.text_color + ';';
        if (design.textAlign) styles += 'text-align:' + design.textAlign + ';';
        return styles;
    },

    // Helper function to build typography style string for a specific element
    // Reads from design.typography_[element] nested object (e.g., design.typography_button)
    getElementTypographyStyles: function(design, element) {
        if (!design) return '';

        // Typography is stored as nested object: design.typography_button = { font_family: '...', font_size: '...' }
        var typoKey = 'typography_' + element;
        var typo = design[typoKey] || {};
        var styles = '';

        if (typo.font_family) styles += 'font-family:' + typo.font_family + ';';
        if (typo.font_size) styles += 'font-size:' + typo.font_size + ';';
        if (typo.font_weight) styles += 'font-weight:' + typo.font_weight + ';';
        if (typo.line_height) styles += 'line-height:' + typo.line_height + ';';
        if (typo.letter_spacing) styles += 'letter-spacing:' + typo.letter_spacing + ';';
        if (typo.text_transform) styles += 'text-transform:' + typo.text_transform + ';';
        if (typo.text_color || typo.color) styles += 'color:' + (typo.text_color || typo.color) + ';';

        // Fallback to base typography if no element-specific styles
        if (!styles) {
            return this.getTypographyStyles(design);
        }
        return styles;
    },

    // Helper function to get spacing styles from design object
    // Handles values that may or may not include units (px, em, etc.)
    getSpacingStyles: function(design) {
        if (!design) return '';
        var self = this;
        var styles = '';

        // Helper to normalize spacing value - add px only if no unit present
        var normalizeSpacing = function(val) {
            if (!val || val === '0' || val === 0) return '';
            var strVal = String(val);
            // If already has a unit (px, em, rem, %), use as-is
            if (/[a-z%]$/i.test(strVal)) return strVal;
            // Otherwise add px
            return strVal + 'px';
        };

        var mTop = normalizeSpacing(design.margin_top);
        var mRight = normalizeSpacing(design.margin_right);
        var mBottom = normalizeSpacing(design.margin_bottom);
        var mLeft = normalizeSpacing(design.margin_left);
        var pTop = normalizeSpacing(design.padding_top);
        var pRight = normalizeSpacing(design.padding_right);
        var pBottom = normalizeSpacing(design.padding_bottom);
        var pLeft = normalizeSpacing(design.padding_left);

        if (mTop) styles += 'margin-top:' + mTop + ';';
        if (mRight) styles += 'margin-right:' + mRight + ';';
        if (mBottom) styles += 'margin-bottom:' + mBottom + ';';
        if (mLeft) styles += 'margin-left:' + mLeft + ';';
        if (pTop) styles += 'padding-top:' + pTop + ';';
        if (pRight) styles += 'padding-right:' + pRight + ';';
        if (pBottom) styles += 'padding-bottom:' + pBottom + ';';
        if (pLeft) styles += 'padding-left:' + pLeft + ';';
        return styles;
    },

    // Helper function to get border styles from design object
    // Handles values that may or may not include units
    getBorderStyles: function(design) {
        if (!design) return '';
        var styles = '';

        // Helper to normalize value - add px only if no unit present
        var normalizeValue = function(val) {
            if (!val || val === '0' || val === 0) return '0';
            var strVal = String(val);
            if (/[a-z%]$/i.test(strVal)) return strVal;
            return strVal + 'px';
        };

        var bStyle = design.border_style || 'none';
        if (bStyle !== 'none') {
            var bColor = design.border_color || '#e2e8f0';
            var bwTop = normalizeValue(design.border_width_top);
            var bwRight = normalizeValue(design.border_width_right);
            var bwBottom = normalizeValue(design.border_width_bottom);
            var bwLeft = normalizeValue(design.border_width_left);
            if (bwTop !== '0') styles += 'border-top:' + bwTop + ' ' + bStyle + ' ' + bColor + ';';
            if (bwRight !== '0') styles += 'border-right:' + bwRight + ' ' + bStyle + ' ' + bColor + ';';
            if (bwBottom !== '0') styles += 'border-bottom:' + bwBottom + ' ' + bStyle + ' ' + bColor + ';';
            if (bwLeft !== '0') styles += 'border-left:' + bwLeft + ' ' + bStyle + ' ' + bColor + ';';
        }
        // Border radius
        var brTL = normalizeValue(design.border_radius_tl);
        var brTR = normalizeValue(design.border_radius_tr);
        var brBR = normalizeValue(design.border_radius_br);
        var brBL = normalizeValue(design.border_radius_bl);
        if (brTL !== '0' || brTR !== '0' || brBR !== '0' || brBL !== '0') {
            styles += 'border-radius:' + brTL + ' ' + brTR + ' ' + brBR + ' ' + brBL + ';';
        }
        return styles;
    },

    // Helper function to get background styles from design object
    getBackgroundStyles: function(design) {
        if (!design) return '';
        var styles = '';
        if (design.backgroundColor) styles += 'background-color:' + design.backgroundColor + ';';
        if (design.background_image) {
            styles += 'background-image:url(' + design.background_image + ');';
            if (design.background_position) styles += 'background-position:' + design.background_position + ';';
            if (design.background_size) styles += 'background-size:' + design.background_size + ';';
            if (design.background_repeat) styles += 'background-repeat:' + design.background_repeat + ';';
        }
        return styles;
    },

    // Helper function to get box shadow styles from design object
    getBoxShadowStyles: function(design) {
        if (!design || !design.box_shadow_enabled) return '';
        var h = parseInt(design.box_shadow_horizontal) || 0;
        var v = parseInt(design.box_shadow_vertical) || 4;
        var blur = parseInt(design.box_shadow_blur) || 10;
        var spread = parseInt(design.box_shadow_spread) || 0;
        var color = design.box_shadow_color || 'rgba(0,0,0,0.1)';
        var inset = design.box_shadow_inset ? 'inset ' : '';
        return 'box-shadow:' + inset + h + 'px ' + v + 'px ' + blur + 'px ' + spread + 'px ' + color + ';';
    },

    // Combine all design styles for a module
    getModuleDesignStyles: function(design) {
        if (!design) return '';
        return this.getTypographyStyles(design) +
               this.getSpacingStyles(design) +
               this.getBorderStyles(design) +
               this.getBackgroundStyles(design) +
               this.getBoxShadowStyles(design);
    },

    filterModules: function(query) {
        var q = query.toLowerCase();
        document.querySelectorAll('.tb-module-item').forEach(function(el) {
            var name = el.querySelector('.tb-module-name').textContent.toLowerCase();
            el.style.display = name.includes(q) ? '' : 'none';
        });
    },

    bindEvents: function() {
        var self = this;
        
        // Drag from modules list
        document.querySelectorAll('.tb-module-item').forEach(function(el) {
            el.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('moduleType', el.dataset.type);
                el.classList.add('dragging');
            });
            el.addEventListener('dragend', function() {
                el.classList.remove('dragging');
            });
        });
        
        // Tabs
        document.querySelectorAll('.tb-tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tb-tab').forEach(function(t) { t.classList.remove('active'); });
                tab.classList.add('active');
                document.getElementById('templateSettings').style.display = tab.dataset.tab === 'template' ? '' : 'none';
                document.getElementById('elementSettings').style.display = tab.dataset.tab === 'element' ? '' : 'none';
            });
        });
    },

    handleDragOver: function(e) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    },

    handleDragLeave: function(e) {
        e.currentTarget.classList.remove('drag-over');
    },

    handleDrop: function(e, sIdx, rIdx, cIdx) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        
        var moduleType = e.dataTransfer.getData('moduleType');
        if (!moduleType) return;
        
        var modDef = this.modules[moduleType];
        if (!modDef) return;
        
        var newModule = {
            type: moduleType,
            content: JSON.parse(JSON.stringify(modDef.defaults ? modDef.defaults.content || {} : {})),
            design: JSON.parse(JSON.stringify(modDef.defaults ? modDef.defaults.design || {} : {}))
        };
        
        this.content.sections[sIdx].rows[rIdx].columns[cIdx].modules.push(newModule);
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.toast('Module added', 'success');
    },

    preview: async function() {
        try {
            // DEBUG: check button design data
            console.log("=== PREVIEW DEBUG ===");
            var btns = [];
            (this.content.sections||[]).forEach(function(s){(s.rows||[]).forEach(function(r){(r.columns||[]).forEach(function(c){(c.modules||[]).forEach(function(m){if(m.type==="button")btns.push(m);});});});});
            btns.forEach(function(b){console.log("Button design:",b.design);});
            const response = await fetch('/admin/theme-builder/preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': this.csrfToken },
                body: JSON.stringify({ 
                    content: this.content, 
                    template_id: this.templateId,
                    template_type: this.templateType,
                    csrf_token: this.csrfToken 
                })
            });
            const result = await response.json();

            if (result.success && result.preview_url) {
                const previewWindow = window.open(result.preview_url, '_blank');
                if (!previewWindow) {
                    this.toast('Popup blocked! Please allow popups for this site.', 'error');
                }
            } else {
                this.toast(result.error || 'Preview failed', 'error');
            }
        } catch (err) {
            this.toast('Preview error: ' + err.message, 'error');
        }
    },

    save: function() {
        var self = this;
        var btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        
        var data = {
            template_id: this.templateId,
            type: this.templateType,
            name: document.getElementById('templateName').value.trim() || 'Untitled',
            content: this.content,
            priority: parseInt(document.getElementById('templatePriority').value) || 0,
            is_active: document.getElementById('templateActive').checked ? 1 : 0,
            conditions: { type: document.getElementById('conditionType').value },
            csrf_token: this.csrfToken
        };
        
        fetch('/admin/theme-builder/templates/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(function(r) { return r.json(); })
        .then(function(result) {
            if (result.success) {
                if (result.template_id && self.templateId === 0) {
                    self.templateId = result.template_id;
                    history.replaceState(null, '', '/admin/theme-builder/templates/' + result.template_id + '/edit');
                }
                self.isDirty = false;
                self.toast('Template saved successfully', 'success');
            } else {
                self.toast(result.error || 'Save failed', 'error');
            }
        })
        .catch(function(err) {
            self.toast('Network error: ' + err.message, 'error');
        })
        .finally(function() {
            btn.disabled = false;
            btn.textContent = 'ğŸ’¾ Save';
        });
    },

    toast: function(message, type) {
        var t = document.getElementById('toast');
        t.textContent = message;
        t.className = 'tb-toast show ' + (type || 'info');
        setTimeout(function() { t.classList.remove('show'); }, 3000);
    },

    // Layout functions
    layouts: [
        { cols: 1, widths: [1], label: '1 Column' },
        { cols: 2, widths: [1,1], label: '2 Equal' },
        { cols: 2, widths: [1,2], label: '1/3 + 2/3' },
        { cols: 2, widths: [2,1], label: '2/3 + 1/3' },
        { cols: 3, widths: [1,1,1], label: '3 Equal' },
        { cols: 3, widths: [1,2,1], label: '1/4 + 1/2 + 1/4' },
        { cols: 4, widths: [1,1,1,1], label: '4 Equal' }
    ],

    renderLayoutButtons: function(sIdx, rIdx, currentCols) {
        var self = this;
        var html = '';
        this.layouts.slice(0, 4).forEach(function(layout, idx) {
            var active = layout.cols === currentCols ? ' active' : '';
            html += '<button class="tb-row-layout-btn' + active + '" onclick="event.stopPropagation();TB.setRowLayout(' + sIdx + ',' + rIdx + ',' + idx + ')" title="' + layout.label + '">';
            var total = layout.widths.reduce(function(a,b){return a+b;}, 0);
            layout.widths.forEach(function(w) {
                html += '<div class="col" style="flex:' + w + '"></div>';
            });
            html += '</button>';
        });
        html += '<button class="tb-row-layout-btn" onclick="event.stopPropagation();TB.showLayoutModal(' + sIdx + ',' + rIdx + ')" title="More layouts">â‹¯</button>';
        return html;
    },

    setRowLayout: function(sIdx, rIdx, layoutIdx) {
        var layout = this.layouts[layoutIdx];
        var row = this.content.sections[sIdx].rows[rIdx];
        var oldModules = [];
        row.columns.forEach(function(col) {
            if (col.modules) oldModules = oldModules.concat(col.modules);
        });
        
        row.columns = [];
        for (var i = 0; i < layout.cols; i++) {
            row.columns.push({ modules: i === 0 ? oldModules : [], flex: layout.widths[i] });
        }
        
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.toast('Layout changed', 'success');
    },

    showLayoutModal: function(sIdx, rIdx) {
        this.layoutModalTarget = { sIdx: sIdx, rIdx: rIdx };
        var container = document.getElementById('layoutOptions');
        var self = this;
        var html = '';
        
        this.layouts.forEach(function(layout, idx) {
            html += '<div class="tb-layout-option" onclick="TB.applyLayoutFromModal(' + idx + ')">';
            html += '<div class="tb-layout-preview">';
            var total = layout.widths.reduce(function(a,b){return a+b;}, 0);
            layout.widths.forEach(function(w) {
                html += '<div class="col" style="flex:' + w + '"></div>';
            });
            html += '</div>';
            html += '<div class="tb-layout-label">' + layout.label + '</div>';
            html += '</div>';
        });
        
        container.innerHTML = html;
        document.getElementById('layoutModal').classList.add('show');
    },

    applyLayoutFromModal: function(layoutIdx) {
        var t = this.layoutModalTarget;
        this.setRowLayout(t.sIdx, t.rIdx, layoutIdx);
        this.closeLayoutModal();
    },

    closeLayoutModal: function() {
        document.getElementById('layoutModal').classList.remove('show');
    },

    removeRow: function(sIdx, rIdx) {
        if (this.content.sections[sIdx].rows.length <= 1) {
            this.toast('Cannot remove the only row', 'error');
            return;
        }
        if (confirm('Remove this row?')) {
            this.content.sections[sIdx].rows.splice(rIdx, 1);
            this.isDirty = true;
            this.renderCanvas();
        this.saveCollapsedState();
        }
    },

    // Module actions
    duplicateModule: function(sIdx, rIdx, cIdx, mIdx) {
        var mod = this.content.sections[sIdx].rows[rIdx].columns[cIdx].modules[mIdx];
        var copy = JSON.parse(JSON.stringify(mod));
        this.content.sections[sIdx].rows[rIdx].columns[cIdx].modules.splice(mIdx + 1, 0, copy);
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.toast('Module duplicated', 'success');
    },

    deleteModule: function(sIdx, rIdx, cIdx, mIdx) {
        if (confirm('Delete this module?')) {
            this.content.sections[sIdx].rows[rIdx].columns[cIdx].modules.splice(mIdx, 1);
            if (this.selectedModule && this.selectedModule.path === sIdx + '-' + rIdx + '-' + cIdx + '-' + mIdx) {
                this.selectedModule = null;
                this.renderElementSettings();
            }
            this.isDirty = true;
            this.renderCanvas();
        this.saveCollapsedState();
            this.toast('Module deleted', 'success');
        }
    },

    // Media Gallery
    mediaCallback: null,
    
    openMediaModal: function(callback) {
        this.mediaCallback = callback;
        this.loadMediaLibrary();
        document.getElementById('mediaModal').classList.add('show');
    },

    closeMediaModal: function() {
        document.getElementById('mediaModal').classList.remove('show');
        this.mediaCallback = null;
    },

    loadMediaLibrary: function() {
        var grid = document.getElementById('mediaGrid');
        var self = this;
        
        // Keep upload button, add loading
        grid.innerHTML = '<div class="tb-media-item tb-media-upload" onclick="TB.uploadMedia()"><span style="font-size:32px">ğŸ“¤</span><span>Upload</span></div>';
        
        // Fetch media from server
        fetch('/admin/api/media/list')
            .then(function(r) { return r.json(); })
            .catch(function() { return { files: [] }; })
            .then(function(data) {
                var files = data.files || [];
                files.forEach(function(file) {
                    var item = document.createElement('div');
                    item.className = 'tb-media-item';
                    item.dataset.url = file.url;
                    item.innerHTML = '<img src="' + file.thumbnail + '" alt="">';
                    item.onclick = function() {
                        grid.querySelectorAll('.tb-media-item').forEach(function(el) { el.classList.remove('selected'); });
                        item.classList.add('selected');
                    };
                    grid.appendChild(item);
                });
            });
    },

    selectMedia: function() {
        var selected = document.querySelector('#mediaGrid .tb-media-item.selected');
        if (selected && selected.dataset.url && this.mediaCallback) {
            this.mediaCallback(selected.dataset.url);
        }
        this.closeMediaModal();
    },

    uploadMedia: function() {
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        var self = this;
        
        input.onchange = function(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            var formData = new FormData();
            formData.append('file', file);
            formData.append('csrf_token', self.csrfToken);
            
            fetch('/admin/api/media/upload', {
                method: 'POST',
                body: formData
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success && data.url) {
                    if (self.mediaCallback) {
                        self.mediaCallback(data.url);
                        self.closeMediaModal();
                    } else {
                        self.loadMediaLibrary();
                    }
                    self.toast('Image uploaded', 'success');
                } else {
                    self.toast(data.error || 'Upload failed', 'error');
                }
            })
            .catch(function(err) {
                self.toast('Upload error: ' + err.message, 'error');
            });
        };
        
        input.click();
    },

    // Updated field for images with gallery button
    fieldImage: function(name, label, value) {
        return '<div class="tb-field"><label class="tb-label">' + label + '</label><div class="tb-image-field"><input type="text" class="tb-input" id="field_' + name + '" value="' + this.escHtml(value) + '" onchange="TB.updateModuleField(\'' + name + '\', this.value)" placeholder="Image URL"><button type="button" class="tb-image-picker-btn" onclick="TB.openMediaGallery(function(url){ document.getElementById(\'field_' + name + '\').value = url; TB.updateModuleField(\'' + name + '\', url); })">ğŸ“·</button></div></div>';
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI GENERATE - Text Generation (matching edit.php)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    generateAI: function(type, context) {
        var self = this;
        var templateTitle = document.getElementById('templateName')?.value || '';

        console.log('[AI] Generating content - type:', type, 'context:', context);
        console.log('[AI] CSRF Token:', this.csrfToken ? this.csrfToken.substring(0, 10) + '...' : 'MISSING');

        return fetch('/admin/theme-builder/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                csrf_token: this.csrfToken,
                type: type,
                context: context,
                page_title: templateTitle
            })
        })
        .then(function(response) {
            console.log('[AI] Response status:', response.status);
            if (!response.ok) {
                return response.text().then(function(text) {
                    console.error('[AI] Error response:', text);
                    throw new Error('HTTP ' + response.status + ': ' + text);
                });
            }
            return response.json();
        })
        .then(function(result) {
            console.log('[AI] Result:', result);
            if (result.success) {
                return result.content;
            } else {
                self.toast(result.error || 'AI generation failed', 'error');
                return null;
            }
        })
        .catch(function(err) {
            console.error('[AI] Error:', err);
            self.toast('Error: ' + err.message, 'error');
            return null;
        });
    },

    handleAIGenerate: function(type, field, sIdx, rIdx, cIdx, mIdx, button) {
        var self = this;
        var defaultContexts = {
            heading: 'a compelling website section',
            text: 'engaging website content',
            button: 'a call-to-action button',
            cta_title: 'getting users to take action',
            cta_subtitle: 'supporting the main call-to-action',
            cta_button: 'encouraging sign-ups or purchases',
            hero_title: 'a hero section headline',
            hero_subtitle: 'supporting hero text',
            testimonial: 'customer satisfaction with our service',
            pricing_features: 'features included in this plan',
            quote: 'inspiration and motivation',
            blurb_title: 'a service or feature highlight',
            blurb_text: 'describing a key benefit',
            toggle_title: 'an expandable content section',
            toggle_content: 'hidden content that expands',
            counter_title: 'a statistic or metric'
        };

        var context = prompt('What should this ' + type.replace(/_/g, ' ') + ' be about?', defaultContexts[type] || 'your topic');
        if (!context) return;

        // Set loading state
        button.disabled = true;
        button.classList.add('loading');
        var originalText = button.innerHTML;
        button.innerHTML = 'âœ¨ Generating...';

        this.generateAI(type, context).then(function(content) {
            // Reset button state
            button.disabled = false;
            button.classList.remove('loading');
            button.innerHTML = originalText;

            if (content) {
                if (type === 'pricing_features' && Array.isArray(content)) {
                    // Handle array content for pricing features
                    var mod = self.content.sections[sIdx]?.rows[rIdx]?.columns[cIdx]?.modules[mIdx];
                    if (mod) {
                        mod.content.features = content;
                        self.isDirty = true;
                        self.renderCanvas();
                        self.selectModule(sIdx, rIdx, cIdx, mIdx);
                    }
                } else {
                    self.updateModuleContent(sIdx, rIdx, cIdx, mIdx, field, content);
                }
                self.renderElementSettings(); // Re-render to show new value
                self.toast('AI content generated!', 'success');
            }
        });
    },

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ICON PICKER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    iconPickerCallback: null,
    currentIconStyle: 'fontawesome',

    // Font Awesome icons
    fontawesomeIcons: [
        // Solid icons
        {n:'home',s:'solid'},{n:'user',s:'solid'},{n:'users',s:'solid'},{n:'cog',s:'solid'},{n:'cogs',s:'solid'},
        {n:'star',s:'solid'},{n:'heart',s:'solid'},{n:'check',s:'solid'},{n:'times',s:'solid'},{n:'plus',s:'solid'},
        {n:'minus',s:'solid'},{n:'search',s:'solid'},{n:'envelope',s:'solid'},{n:'phone',s:'solid'},{n:'map-marker-alt',s:'solid'},
        {n:'lock',s:'solid'},{n:'unlock',s:'solid'},{n:'key',s:'solid'},{n:'shield-alt',s:'solid'},{n:'bell',s:'solid'},
        {n:'shopping-cart',s:'solid'},{n:'shopping-bag',s:'solid'},{n:'credit-card',s:'solid'},{n:'dollar-sign',s:'solid'},{n:'euro-sign',s:'solid'},
        {n:'chart-bar',s:'solid'},{n:'chart-line',s:'solid'},{n:'chart-pie',s:'solid'},{n:'chart-area',s:'solid'},{n:'database',s:'solid'},
        {n:'server',s:'solid'},{n:'cloud',s:'solid'},{n:'cloud-upload-alt',s:'solid'},{n:'cloud-download-alt',s:'solid'},{n:'download',s:'solid'},
        {n:'upload',s:'solid'},{n:'file',s:'solid'},{n:'file-alt',s:'solid'},{n:'folder',s:'solid'},{n:'folder-open',s:'solid'},
        {n:'image',s:'solid'},{n:'camera',s:'solid'},{n:'video',s:'solid'},{n:'music',s:'solid'},{n:'headphones',s:'solid'},
        {n:'microphone',s:'solid'},{n:'play',s:'solid'},{n:'pause',s:'solid'},{n:'stop',s:'solid'},{n:'forward',s:'solid'},
        {n:'backward',s:'solid'},{n:'volume-up',s:'solid'},{n:'volume-down',s:'solid'},{n:'volume-mute',s:'solid'},{n:'expand',s:'solid'},
        {n:'compress',s:'solid'},{n:'arrows-alt',s:'solid'},{n:'arrow-up',s:'solid'},{n:'arrow-down',s:'solid'},{n:'arrow-left',s:'solid'},
        {n:'arrow-right',s:'solid'},{n:'chevron-up',s:'solid'},{n:'chevron-down',s:'solid'},{n:'chevron-left',s:'solid'},{n:'chevron-right',s:'solid'},
        {n:'angle-up',s:'solid'},{n:'angle-down',s:'solid'},{n:'angle-left',s:'solid'},{n:'angle-right',s:'solid'},{n:'sync',s:'solid'},
        {n:'redo',s:'solid'},{n:'undo',s:'solid'},{n:'edit',s:'solid'},{n:'trash',s:'solid'},{n:'trash-alt',s:'solid'},
        {n:'copy',s:'solid'},{n:'paste',s:'solid'},{n:'cut',s:'solid'},{n:'save',s:'solid'},{n:'print',s:'solid'},
        {n:'share',s:'solid'},{n:'share-alt',s:'solid'},{n:'link',s:'solid'},{n:'unlink',s:'solid'},{n:'external-link-alt',s:'solid'},
        {n:'bookmark',s:'solid'},{n:'tag',s:'solid'},{n:'tags',s:'solid'},{n:'comment',s:'solid'},{n:'comments',s:'solid'},
        {n:'quote-left',s:'solid'},{n:'quote-right',s:'solid'},{n:'info-circle',s:'solid'},{n:'question-circle',s:'solid'},{n:'exclamation-circle',s:'solid'},
        {n:'exclamation-triangle',s:'solid'},{n:'ban',s:'solid'},{n:'check-circle',s:'solid'},{n:'times-circle',s:'solid'},{n:'plus-circle',s:'solid'},
        {n:'minus-circle',s:'solid'},{n:'globe',s:'solid'},{n:'globe-americas',s:'solid'},{n:'globe-europe',s:'solid'},{n:'globe-asia',s:'solid'},
        {n:'map',s:'solid'},{n:'compass',s:'solid'},{n:'location-arrow',s:'solid'},{n:'route',s:'solid'},{n:'car',s:'solid'},
        {n:'truck',s:'solid'},{n:'plane',s:'solid'},{n:'ship',s:'solid'},{n:'rocket',s:'solid'},{n:'bicycle',s:'solid'},
        {n:'bus',s:'solid'},{n:'subway',s:'solid'},{n:'taxi',s:'solid'},{n:'helicopter',s:'solid'},{n:'anchor',s:'solid'},
        {n:'building',s:'solid'},{n:'hospital',s:'solid'},{n:'university',s:'solid'},{n:'store',s:'solid'},{n:'warehouse',s:'solid'},
        {n:'industry',s:'solid'},{n:'city',s:'solid'},{n:'briefcase',s:'solid'},{n:'calendar',s:'solid'},{n:'calendar-alt',s:'solid'},
        {n:'clock',s:'solid'},{n:'hourglass',s:'solid'},{n:'stopwatch',s:'solid'},{n:'history',s:'solid'},{n:'tasks',s:'solid'},
        {n:'list',s:'solid'},{n:'list-ul',s:'solid'},{n:'list-ol',s:'solid'},{n:'th',s:'solid'},{n:'th-large',s:'solid'},
        {n:'th-list',s:'solid'},{n:'table',s:'solid'},{n:'columns',s:'solid'},{n:'align-left',s:'solid'},{n:'align-center',s:'solid'},
        {n:'align-right',s:'solid'},{n:'align-justify',s:'solid'},{n:'bold',s:'solid'},{n:'italic',s:'solid'},{n:'underline',s:'solid'},
        {n:'strikethrough',s:'solid'},{n:'text-height',s:'solid'},{n:'text-width',s:'solid'},{n:'font',s:'solid'},{n:'heading',s:'solid'},
        {n:'paragraph',s:'solid'},{n:'indent',s:'solid'},{n:'outdent',s:'solid'},{n:'code',s:'solid'},{n:'terminal',s:'solid'},
        {n:'laptop',s:'solid'},{n:'desktop',s:'solid'},{n:'tablet-alt',s:'solid'},{n:'mobile-alt',s:'solid'},{n:'keyboard',s:'solid'},
        {n:'mouse',s:'solid'},{n:'hdd',s:'solid'},{n:'memory',s:'solid'},{n:'microchip',s:'solid'},{n:'wifi',s:'solid'},
        {n:'bluetooth',s:'solid'},{n:'signal',s:'solid'},{n:'broadcast-tower',s:'solid'},{n:'satellite',s:'solid'},{n:'satellite-dish',s:'solid'},
        {n:'bolt',s:'solid'},{n:'battery-full',s:'solid'},{n:'battery-half',s:'solid'},{n:'battery-empty',s:'solid'},{n:'plug',s:'solid'},
        {n:'lightbulb',s:'solid'},{n:'sun',s:'solid'},{n:'moon',s:'solid'},{n:'cloud-sun',s:'solid'},{n:'cloud-moon',s:'solid'},
        {n:'thermometer-half',s:'solid'},{n:'tint',s:'solid'},{n:'umbrella',s:'solid'},{n:'wind',s:'solid'},{n:'snowflake',s:'solid'},
        {n:'fire',s:'solid'},{n:'fire-alt',s:'solid'},{n:'leaf',s:'solid'},{n:'seedling',s:'solid'},{n:'tree',s:'solid'},
        {n:'apple-alt',s:'solid'},{n:'lemon',s:'solid'},{n:'carrot',s:'solid'},{n:'hamburger',s:'solid'},{n:'pizza-slice',s:'solid'},
        {n:'ice-cream',s:'solid'},{n:'coffee',s:'solid'},{n:'beer',s:'solid'},{n:'wine-glass',s:'solid'},{n:'cocktail',s:'solid'},
        {n:'utensils',s:'solid'},{n:'birthday-cake',s:'solid'},{n:'gift',s:'solid'},{n:'trophy',s:'solid'},{n:'medal',s:'solid'},
        {n:'award',s:'solid'},{n:'crown',s:'solid'},{n:'gem',s:'solid'},{n:'ring',s:'solid'},{n:'glasses',s:'solid'},
        {n:'graduation-cap',s:'solid'},{n:'book',s:'solid'},{n:'book-open',s:'solid'},{n:'bookmark',s:'solid'},{n:'newspaper',s:'solid'},
        {n:'pen',s:'solid'},{n:'pencil-alt',s:'solid'},{n:'highlighter',s:'solid'},{n:'marker',s:'solid'},{n:'eraser',s:'solid'},
        {n:'palette',s:'solid'},{n:'paint-brush',s:'solid'},{n:'paint-roller',s:'solid'},{n:'fill-drip',s:'solid'},{n:'swatchbook',s:'solid'},
        {n:'magic',s:'solid'},{n:'wand-magic-sparkles',s:'solid'},{n:'hat-wizard',s:'solid'},{n:'dice',s:'solid'},{n:'puzzle-piece',s:'solid'},
        {n:'gamepad',s:'solid'},{n:'chess',s:'solid'},{n:'dumbbell',s:'solid'},{n:'football-ball',s:'solid'},{n:'basketball-ball',s:'solid'},
        {n:'volleyball-ball',s:'solid'},{n:'baseball-ball',s:'solid'},{n:'golf-ball',s:'solid'},{n:'table-tennis',s:'solid'},{n:'bowling-ball',s:'solid'},
        {n:'swimmer',s:'solid'},{n:'running',s:'solid'},{n:'walking',s:'solid'},{n:'biking',s:'solid'},{n:'hiking',s:'solid'},
        {n:'skiing',s:'solid'},{n:'snowboarding',s:'solid'},{n:'skating',s:'solid'},{n:'horse',s:'solid'},{n:'dog',s:'solid'},
        {n:'cat',s:'solid'},{n:'fish',s:'solid'},{n:'spider',s:'solid'},{n:'bug',s:'solid'},{n:'virus',s:'solid'},
        {n:'bacteria',s:'solid'},{n:'dna',s:'solid'},{n:'atom',s:'solid'},{n:'flask',s:'solid'},{n:'vial',s:'solid'},
        {n:'syringe',s:'solid'},{n:'pills',s:'solid'},{n:'capsules',s:'solid'},{n:'first-aid',s:'solid'},{n:'heartbeat',s:'solid'},
        {n:'stethoscope',s:'solid'},{n:'thermometer',s:'solid'},{n:'ambulance',s:'solid'},{n:'clinic-medical',s:'solid'},{n:'tooth',s:'solid'},
        {n:'eye',s:'solid'},{n:'eye-slash',s:'solid'},{n:'hand-paper',s:'solid'},{n:'hand-point-up',s:'solid'},{n:'hand-point-down',s:'solid'},
        {n:'hand-point-left',s:'solid'},{n:'hand-point-right',s:'solid'},{n:'thumbs-up',s:'solid'},{n:'thumbs-down',s:'solid'},{n:'handshake',s:'solid'},
        {n:'praying-hands',s:'solid'},{n:'fist-raised',s:'solid'},{n:'hand-peace',s:'solid'},{n:'hand-rock',s:'solid'},{n:'hand-scissors',s:'solid'},
        {n:'smile',s:'solid'},{n:'smile-beam',s:'solid'},{n:'grin',s:'solid'},{n:'laugh',s:'solid'},{n:'meh',s:'solid'},
        {n:'frown',s:'solid'},{n:'sad-tear',s:'solid'},{n:'angry',s:'solid'},{n:'surprise',s:'solid'},{n:'dizzy',s:'solid'},
        // Brands
        {n:'facebook',s:'brands'},{n:'facebook-f',s:'brands'},{n:'twitter',s:'brands'},{n:'instagram',s:'brands'},{n:'linkedin',s:'brands'},
        {n:'linkedin-in',s:'brands'},{n:'youtube',s:'brands'},{n:'tiktok',s:'brands'},{n:'pinterest',s:'brands'},{n:'pinterest-p',s:'brands'},
        {n:'snapchat',s:'brands'},{n:'snapchat-ghost',s:'brands'},{n:'whatsapp',s:'brands'},{n:'telegram',s:'brands'},{n:'discord',s:'brands'},
        {n:'slack',s:'brands'},{n:'skype',s:'brands'},{n:'zoom',s:'brands'},{n:'google',s:'brands'},{n:'google-drive',s:'brands'},
        {n:'chrome',s:'brands'},{n:'firefox',s:'brands'},{n:'safari',s:'brands'},{n:'edge',s:'brands'},{n:'opera',s:'brands'},
        {n:'apple',s:'brands'},{n:'android',s:'brands'},{n:'windows',s:'brands'},{n:'linux',s:'brands'},{n:'ubuntu',s:'brands'},
        {n:'github',s:'brands'},{n:'gitlab',s:'brands'},{n:'bitbucket',s:'brands'},{n:'git-alt',s:'brands'},{n:'npm',s:'brands'},
        {n:'node-js',s:'brands'},{n:'js',s:'brands'},{n:'react',s:'brands'},{n:'vuejs',s:'brands'},{n:'angular',s:'brands'},
        {n:'php',s:'brands'},{n:'python',s:'brands'},{n:'java',s:'brands'},{n:'swift',s:'brands'},{n:'rust',s:'brands'},
        {n:'html5',s:'brands'},{n:'css3-alt',s:'brands'},{n:'sass',s:'brands'},{n:'less',s:'brands'},{n:'bootstrap',s:'brands'},
        {n:'wordpress',s:'brands'},{n:'drupal',s:'brands'},{n:'joomla',s:'brands'},{n:'magento',s:'brands'},{n:'shopify',s:'brands'},
        {n:'amazon',s:'brands'},{n:'aws',s:'brands'},{n:'docker',s:'brands'},{n:'digital-ocean',s:'brands'},{n:'cloudflare',s:'brands'},
        {n:'stripe',s:'brands'},{n:'paypal',s:'brands'},{n:'cc-visa',s:'brands'},{n:'cc-mastercard',s:'brands'},{n:'cc-amex',s:'brands'},
        {n:'bitcoin',s:'brands'},{n:'ethereum',s:'brands'},{n:'spotify',s:'brands'},{n:'soundcloud',s:'brands'},{n:'itunes-note',s:'brands'},
        {n:'twitch',s:'brands'},{n:'steam',s:'brands'},{n:'playstation',s:'brands'},{n:'xbox',s:'brands'},{n:'nintendo-switch',s:'brands'},
        {n:'dribbble',s:'brands'},{n:'behance',s:'brands'},{n:'figma',s:'brands'},{n:'sketch',s:'brands'},{n:'invision',s:'brands'},
        {n:'trello',s:'brands'},{n:'jira',s:'brands'},{n:'confluence',s:'brands'},{n:'dropbox',s:'brands'},{n:'google-drive',s:'brands'},
        {n:'reddit',s:'brands'},{n:'reddit-alien',s:'brands'},{n:'hacker-news',s:'brands'},{n:'stack-overflow',s:'brands'},{n:'medium',s:'brands'},
        {n:'dev',s:'brands'},{n:'codepen',s:'brands'},{n:'jsfiddle',s:'brands'},{n:'product-hunt',s:'brands'},{n:'airbnb',s:'brands'},
        {n:'uber',s:'brands'},{n:'lyft',s:'brands'},{n:'ebay',s:'brands'},{n:'etsy',s:'brands'},{n:'yelp',s:'brands'}
    ],

    // Lucide icons (SVG paths)
    lucideIcons: {
        arrows: [
            { name: 'arrow-up', svg: '<path d="M12 19V5M5 12l7-7 7 7"/>' },
            { name: 'arrow-down', svg: '<path d="M12 5v14M5 12l7 7 7-7"/>' },
            { name: 'arrow-left', svg: '<path d="M19 12H5M12 5l-7 7 7 7"/>' },
            { name: 'arrow-right', svg: '<path d="M5 12h14M12 5l7 7-7 7"/>' },
            { name: 'chevron-up', svg: '<path d="M18 15l-6-6-6 6"/>' },
            { name: 'chevron-down', svg: '<path d="M6 9l6 6 6-6"/>' },
            { name: 'chevron-left', svg: '<path d="M15 18l-6-6 6-6"/>' },
            { name: 'chevron-right', svg: '<path d="M9 18l6-6-6-6"/>' }
        ],
        general: [
            { name: 'home', svg: '<path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><path d="M9 22V12h6v10"/>' },
            { name: 'settings', svg: '<circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>' },
            { name: 'search', svg: '<circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>' },
            { name: 'menu', svg: '<path d="M4 12h16M4 6h16M4 18h16"/>' },
            { name: 'x', svg: '<path d="M18 6L6 18M6 6l12 12"/>' },
            { name: 'check', svg: '<path d="M20 6L9 17l-5-5"/>' },
            { name: 'plus', svg: '<path d="M12 5v14M5 12h14"/>' },
            { name: 'minus', svg: '<path d="M5 12h14"/>' },
            { name: 'star', svg: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>' },
            { name: 'heart', svg: '<path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>' },
            { name: 'user', svg: '<path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>' },
            { name: 'mail', svg: '<rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/>' },
            { name: 'phone', svg: '<path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/>' },
            { name: 'lock', svg: '<rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/>' },
            { name: 'globe', svg: '<circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/>' }
        ],
        media: [
            { name: 'image', svg: '<rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/>' },
            { name: 'camera', svg: '<path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/>' },
            { name: 'video', svg: '<polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/>' },
            { name: 'music', svg: '<path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>' },
            { name: 'play', svg: '<polygon points="5 3 19 12 5 21 5 3"/>' },
            { name: 'pause', svg: '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>' }
        ]
    },

    // Emoji icons
    emojiIcons: {
        faces: ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜Š', 'ğŸ™‚', 'ğŸ˜‰', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›'],
        hearts: ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’'],
        hands: ['ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘‹', 'ğŸ–ï¸', 'âœ‹', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤', 'ğŸ’ª'],
        tech: ['ğŸ’»', 'ğŸ–¥ï¸', 'âŒ¨ï¸', 'ğŸ–±ï¸', 'ğŸ“±', 'ğŸ“²', 'â˜ï¸', 'ğŸ“', 'ğŸ”Œ', 'ğŸ”‹', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ®', 'ğŸ•¹ï¸', 'ğŸ§'],
        business: ['ğŸ’¼', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ’¹', 'ğŸ’°', 'ğŸ’µ', 'ğŸ’³', 'ğŸ¦', 'ğŸ¢', 'ğŸ­', 'ğŸ—ï¸', 'ğŸ‘”', 'ğŸ“‹', 'ğŸ“', 'ğŸ“‚'],
        success: ['â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'ğŸ¯', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ…', 'ğŸ–ï¸', 'ğŸ‘‘', 'ğŸ’', 'ğŸ”¥', 'âš¡', 'ğŸ’¯'],
        arrows: ['â¬†ï¸', 'â†—ï¸', 'â¡ï¸', 'â†˜ï¸', 'â¬‡ï¸', 'â†™ï¸', 'â¬…ï¸', 'â†–ï¸', 'â†•ï¸', 'â†”ï¸', 'â†©ï¸', 'â†ªï¸', 'ğŸ”„', 'ğŸ”ƒ', 'â–¶ï¸', 'â—€ï¸'],
        symbols: ['âœ…', 'âŒ', 'â“', 'â—', 'ğŸ’¡', 'ğŸ””', 'ğŸ”•', 'ğŸ“¢', 'ğŸ“£', 'ğŸ’¬', 'ğŸ’­', 'ğŸ—¨ï¸', 'ğŸ”’', 'ğŸ”“', 'ğŸ”‘', 'ğŸ”—']
    },

    // Icon Picker field
    fieldIcon: function(name, label, value) {
        var preview = this.renderIcon(value);
        return '<div class="tb-field"><label class="tb-label">' + label + '</label>' +
            '<div class="tb-icon-field">' +
            '<div class="tb-icon-preview" id="icon-preview-' + name + '">' + preview + '</div>' +
            '<input type="text" class="tb-input" id="field_' + name + '" value="' + this.escHtml(value) + '" onchange="TB.updateModuleField(\'' + name + '\', this.value);TB.updateIconPreview(\'' + name + '\')" placeholder="Icon name">' +
            '<button type="button" class="tb-icon-browse-btn" onclick="TB.openIconPicker(function(icon){ document.getElementById(\'field_' + name + '\').value = icon; TB.updateModuleField(\'' + name + '\', icon); TB.updateIconPreview(\'' + name + '\'); })">Browse</button>' +
            '</div></div>';
    },

    updateIconPreview: function(name) {
        var input = document.getElementById('field_' + name);
        var preview = document.getElementById('icon-preview-' + name);
        if (input && preview) {
            preview.innerHTML = this.renderIcon(input.value);
        }
    },

    renderIcon: function(iconValue, size) {
        size = size || 24;
        if (!iconValue) return '<span style="font-size:' + size + 'px">â­</span>';
        
        // Font Awesome format: fa:solid:name, fa:regular:name, fa:brands:name
        if (iconValue.startsWith('fa:')) {
            var parts = iconValue.split(':');
            if (parts.length >= 3) {
                var style = parts[1];
                var name = parts[2];
                var faClass = style === 'solid' ? 'fa-solid' : (style === 'regular' ? 'fa-regular' : 'fa-brands');
                return '<i class="' + faClass + ' fa-' + name + '" style="font-size:' + size + 'px"></i>';
            }
        }
        
        // Lucide format: lucide:name
        if (iconValue.startsWith('lucide:')) {
            var name = iconValue.replace('lucide:', '');
            var cats = Object.values(this.lucideIcons);
            for (var i = 0; i < cats.length; i++) {
                for (var j = 0; j < cats[i].length; j++) {
                    if (cats[i][j].name === name) {
                        return '<svg width="' + size + '" height="' + size + '" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">' + cats[i][j].svg + '</svg>';
                    }
                }
            }
        }
        
        // Emoji or plain text
        return '<span style="font-size:' + size + 'px">' + iconValue + '</span>';
    },

    openIconPicker: function(callback) {
        this.iconPickerCallback = callback;
        this.currentIconStyle = 'fontawesome';
        
        var modal = document.getElementById('tb-icon-picker-overlay');
        document.querySelectorAll('.tb-icon-tab').forEach(function(t, i) { t.classList.toggle('active', i === 0); });
        document.getElementById('iconSearchInput').value = '';
        
        this.renderIconGrid();
        modal.classList.add('active');
    },

    closeIconPicker: function() {
        document.getElementById('tb-icon-picker-overlay').classList.remove('active');
        this.iconPickerCallback = null;
    },

    switchIconStyle: function(style, btn) {
        this.currentIconStyle = style;
        document.querySelectorAll('.tb-icon-tab').forEach(function(t) { t.classList.remove('active'); });
        btn.classList.add('active');
        document.getElementById('iconSearchInput').value = '';
        this.renderIconGrid();
    },

    filterIcons: function(query) {
        this.renderIconGrid(query);
    },

    selectIcon: function(iconValue) {
        if (this.iconPickerCallback) {
            this.iconPickerCallback(iconValue);
        }
        this.closeIconPicker();
        this.toast('Icon selected', 'success');
    },

    renderIconGrid: function(searchQuery) {
        var grid = document.getElementById('iconGrid');
        var q = (searchQuery || '').toLowerCase();
        var self = this;
        
        if (this.currentIconStyle === 'fontawesome') {
            var filtered = this.fontawesomeIcons.filter(function(icon) { return !q || icon.n.includes(q); });
            var limited = filtered.slice(0, 150);
            grid.innerHTML = limited.map(function(icon) {
                var style = icon.s === 'brands' ? 'brands' : 'solid';
                var faClass = style === 'solid' ? 'fa-solid' : 'fa-brands';
                return '<div class="tb-icon-option" onclick="TB.selectIcon(\'fa:' + style + ':' + icon.n + '\')" title="' + icon.n + '">' +
                    '<i class="' + faClass + ' fa-' + icon.n + '" style="font-size:20px"></i>' +
                    '</div>';
            }).join('');
            if (filtered.length > 150) {
                grid.innerHTML += '<div class="tb-icon-picker-empty">Showing 150 of ' + filtered.length + ' icons. Use search to find more.</div>';
            }
        } else if (this.currentIconStyle === 'lucide') {
            var icons = [];
            Object.values(this.lucideIcons).forEach(function(cat) {
                cat.forEach(function(icon) {
                    if (!q || icon.name.includes(q)) icons.push(icon);
                });
            });
            grid.innerHTML = icons.map(function(icon) {
                return '<div class="tb-icon-option" onclick="TB.selectIcon(\'lucide:' + icon.name + '\')" title="' + icon.name + '">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">' + icon.svg + '</svg>' +
                    '</div>';
            }).join('');
        } else {
            var icons = [];
            Object.values(this.emojiIcons).forEach(function(cat) { cat.forEach(function(e) { icons.push(e); }); });
            grid.innerHTML = icons.map(function(icon) {
                return '<div class="tb-icon-option emoji" onclick="TB.selectIcon(\'' + icon + '\')">' + icon + '</div>';
            }).join('');
        }
        
        if (grid.innerHTML === '') {
            grid.innerHTML = '<div class="tb-icon-picker-empty">No icons found</div>';
        }
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PRESET LIBRARY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    presets: [],
    selectedPreset: null,

    openLibrary: function() {
        var modal = document.getElementById('libraryModal');
        modal.classList.add('show');
        this.selectedPreset = null;
        document.getElementById('usePresetBtn').disabled = true;
        document.getElementById('librarySearch').value = '';
        this.loadPresets();
    },

    closeLibrary: function() {
        document.getElementById('libraryModal').classList.remove('show');
        this.selectedPreset = null;
    },

    loadPresets: function() {
        var self = this;
        var grid = document.getElementById('libraryGrid');

        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--tb-text-dim)">' +
            '<span style="font-size:32px;display:block;margin-bottom:8px">â³</span>Loading presets...</div>';

        fetch('/admin/api/theme-builder/presets.php?type=' + encodeURIComponent(this.templateType))
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success && data.presets) {
                    self.presets = data.presets;
                    self.renderPresets(data.presets);
                } else {
                    grid.innerHTML = '<div class="tb-library-empty">' +
                        '<span class="tb-library-empty-icon">ğŸ“­</span>' +
                        '<div>No presets available for this template type</div>' +
                        '<div style="font-size:12px;margin-top:8px">Run install-tb-presets.php to populate the library</div></div>';
                }
            })
            .catch(function(err) {
                console.error('Failed to load presets:', err);
                grid.innerHTML = '<div class="tb-library-empty">' +
                    '<span class="tb-library-empty-icon">âš ï¸</span>' +
                    '<div>Failed to load presets</div>' +
                    '<div style="font-size:12px;margin-top:8px">' + self.escHtml(err.message || 'Unknown error') + '</div></div>';
            });
    },

    renderPresets: function(presets) {
        var self = this;
        var grid = document.getElementById('libraryGrid');

        if (!presets || presets.length === 0) {
            grid.innerHTML = '<div class="tb-library-empty">' +
                '<span class="tb-library-empty-icon">ğŸ“­</span>' +
                '<div>No presets found</div></div>';
            return;
        }

        grid.innerHTML = presets.map(function(preset) {
            var thumbIcon = self.getPresetIcon(preset.type);
            var thumb = preset.thumbnail
                ? '<img src="' + self.escHtml(preset.thumbnail) + '" alt="' + self.escHtml(preset.name) + '">'
                : thumbIcon;

            var tags = '';
            if (preset.tags) {
                var tagList = preset.tags.split(',').slice(0, 3);
                tags = '<div class="tb-preset-tags">' + tagList.map(function(t) {
                    return '<span class="tb-preset-tag">' + self.escHtml(t.trim()) + '</span>';
                }).join('') + '</div>';
            }

            var premiumBadge = preset.is_premium == 1
                ? '<span class="tb-preset-tag tb-preset-premium">â­ Premium</span>'
                : '';

            return '<div class="tb-preset-card" data-preset-id="' + preset.id + '" onclick="TB.selectPreset(' + preset.id + ')">' +
                '<div class="tb-preset-thumb">' + thumb + '</div>' +
                '<div class="tb-preset-info">' +
                    '<div class="tb-preset-name">' + self.escHtml(preset.name) + ' ' + premiumBadge + '</div>' +
                    '<div class="tb-preset-desc">' + self.escHtml(preset.description || '') + '</div>' +
                    tags +
                '</div>' +
            '</div>';
        }).join('');
    },

    getPresetIcon: function(type) {
        var icons = {
            'header': 'ğŸ”',
            'footer': 'ğŸ”š',
            'sidebar': 'ğŸ“‘',
            '404': 'ğŸš«',
            'archive': 'ğŸ“š',
            'single': 'ğŸ“„'
        };
        return icons[type] || 'ğŸ“¦';
    },

    selectPreset: function(id) {
        this.selectedPreset = id;

        // Update UI
        var cards = document.querySelectorAll('.tb-preset-card');
        cards.forEach(function(card) {
            card.classList.remove('selected');
            if (card.dataset.presetId == id) {
                card.classList.add('selected');
            }
        });

        document.getElementById('usePresetBtn').disabled = false;
    },

    filterPresets: function(query) {
        var self = this;
        query = query.toLowerCase().trim();

        if (!query) {
            this.renderPresets(this.presets);
            return;
        }

        var filtered = this.presets.filter(function(preset) {
            return (preset.name && preset.name.toLowerCase().indexOf(query) > -1) ||
                   (preset.description && preset.description.toLowerCase().indexOf(query) > -1) ||
                   (preset.tags && preset.tags.toLowerCase().indexOf(query) > -1);
        });

        this.renderPresets(filtered);
    },

    usePreset: function() {
        if (!this.selectedPreset) {
            this.toast('Please select a preset first', 'error');
            return;
        }

        var self = this;
        var btn = document.getElementById('usePresetBtn');
        btn.disabled = true;
        btn.textContent = 'Loading...';

        fetch('/admin/api/theme-builder/presets.php?id=' + this.selectedPreset)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success && data.preset && data.preset.content) {
                    // Apply preset content to current template
                    self.content = data.preset.content;
                    self.renderCanvas();
                    self.closeLibrary();
                    self.isDirty = true;
                    self.toast('Preset loaded! Remember to save your changes.', 'success');
                } else {
                    throw new Error(data.error || 'Invalid preset data');
                }
            })
            .catch(function(err) {
                console.error('Failed to load preset:', err);
                self.toast('Failed to load preset: ' + err.message, 'error');
            })
            .finally(function() {
                btn.disabled = false;
                btn.textContent = 'Use This Preset';
            });
    },

    moveSection: function(sIdx, dir) { var s=this.content.sections,n=sIdx+dir; if(n<0||n>=s.length)return; var t=s[sIdx];s[sIdx]=s[n];s[n]=t; this.isDirty=true;this.renderCanvas();this.toast('Section moved','success'); },
    editSection: function(sIdx) {
        var section = this.content.sections[sIdx];
        if (!section) return;
        var design = section.design || {};
        var modal = document.createElement('div');
        modal.id = 'sectionSettingsModal';
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000';
        modal.onclick = function(e) { if(e.target===modal) TB.closeSectionSettings(); };
        var bg = design.background_color || '#1e1e2e';
        var pt = design.padding_top || '20px';
        var pb = design.padding_bottom || '20px';
        modal.innerHTML = '<div style="background:var(--tb-bg-secondary);border-radius:12px;max-width:500px;width:90%"><div style="padding:16px;border-bottom:1px solid var(--tb-border);display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">Section Settings</h3><button class="tb-btn tb-btn-icon" onclick="TB.closeSectionSettings()">Ã—</button></div><div style="padding:20px"><div style="margin-bottom:16px"><label class="tb-label">Background Color</label><input type="color" class="tb-input" style="height:40px" value="' + bg + '" onchange="TB.updateSectionDesign(' + sIdx + ',\'background_color\',this.value)"></div><div style="margin-bottom:16px"><label class="tb-label">Padding Top</label><input type="text" class="tb-input" value="' + pt + '" onchange="TB.updateSectionDesign(' + sIdx + ',\'padding_top\',this.value)"></div><div style="margin-bottom:16px"><label class="tb-label">Padding Bottom</label><input type="text" class="tb-input" value="' + pb + '" onchange="TB.updateSectionDesign(' + sIdx + ',\'padding_bottom\',this.value)"></div></div><div style="padding:16px;border-top:1px solid var(--tb-border);text-align:right"><button class="tb-btn tb-btn-primary" onclick="TB.closeSectionSettings()">Done</button></div></div>';
        document.body.appendChild(modal);
    },

    closeSectionSettings: function() {
        var modal = document.getElementById('sectionSettingsModal');
        if (modal) modal.remove();
    },

    updateSectionDesign: function(sIdx, key, value) {
        var section = this.content.sections[sIdx];
        if (!section) return;
        if (!section.design) section.design = {};
        section.design[key] = value;
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
    },

    duplicateSection: function(sIdx) { var s=this.content.sections[sIdx]; if(!s)return; this.content.sections.splice(sIdx+1,0,JSON.parse(JSON.stringify(s))); this.isDirty=true;this.renderCanvas();this.toast('Section duplicated','success'); },
    deleteRow: function(sIdx,rIdx) { var s=this.content.sections[sIdx]; if(!s||!s.rows)return; if(s.rows.length<=1&&!confirm('Delete?'))return; s.rows.splice(rIdx,1); if(!s.rows.length)s.rows.push({columns:[{flex:1,modules:[]}]}); this.isDirty=true;this.renderCanvas();this.toast('Row deleted','success'); },
    moveRow: function(sIdx,rIdx,dir) { var s=this.content.sections[sIdx]; if(!s||!s.rows)return; var n=rIdx+dir; if(n<0||n>=s.rows.length)return; var t=s.rows[rIdx];s.rows[rIdx]=s.rows[n];s.rows[n]=t; this.isDirty=true;this.renderCanvas();this.toast('Row moved','success'); },
    duplicateRow: function(sIdx,rIdx) { var s=this.content.sections[sIdx]; if(!s||!s.rows||!s.rows[rIdx])return; s.rows.splice(rIdx+1,0,JSON.parse(JSON.stringify(s.rows[rIdx]))); this.isDirty=true;this.renderCanvas();this.toast('Row duplicated','success'); },
    moveModule: function(sIdx,rIdx,cIdx,mIdx,dir) { var c=this.content.sections[sIdx]&&this.content.sections[sIdx].rows[rIdx]&&this.content.sections[sIdx].rows[rIdx].columns[cIdx]; if(!c||!c.modules)return; var n=mIdx+dir; if(n<0||n>=c.modules.length)return; var t=c.modules[mIdx];c.modules[mIdx]=c.modules[n];c.modules[n]=t; this.isDirty=true;this.renderCanvas();this.selectModule(sIdx,rIdx,cIdx,n); },

    setColumnLayout: function(sIdx, rIdx, layout) {
        var row = this.content.sections[sIdx] && this.content.sections[sIdx].rows[rIdx];
        if (!row) return;
        var layouts = {'1':[1],'1-1':[1,1],'1-1-1':[1,1,1],'1-1-1-1':[1,1,1,1],'2-1':[2,1],'1-2':[1,2],'3-1':[3,1],'1-3':[1,3],'1-2-1':[1,2,1]};
        var flexes = layouts[layout];
        if (!flexes) return;
        var existingModules = row.columns.map(function(c) { return c.modules || []; });
        row.columns = flexes.map(function(flex, idx) { return { flex: flex, modules: existingModules[idx] || [] }; });
        this.isDirty = true;
        this.renderCanvas();
        this.saveCollapsedState();
        this.toast('Layout: ' + layout, 'success');
    }
};

document.addEventListener('DOMContentLoaded', function() { TB.init(); });
</script>

    <!-- Icon Picker Modal -->
    <div class="tb-icon-picker-overlay" id="tb-icon-picker-overlay" onclick="if(event.target === this) TB.closeIconPicker()">
        <div class="tb-icon-picker-modal">
            <div class="tb-icon-picker-header">
                <h3>â­ Select Icon</h3>
                <button class="tb-icon-picker-close" onclick="TB.closeIconPicker()">&times;</button>
            </div>
            <div class="tb-icon-picker-tabs">
                <button class="tb-icon-tab active" onclick="TB.switchIconStyle('fontawesome', this)">Font Awesome</button>
                <button class="tb-icon-tab" onclick="TB.switchIconStyle('lucide', this)">Lucide</button>
                <button class="tb-icon-tab" onclick="TB.switchIconStyle('emoji', this)">Emoji</button>
            </div>
            <div class="tb-icon-picker-search">
                <input type="text" id="iconSearchInput" placeholder="Search icons..." oninput="TB.filterIcons(this.value)">
            </div>
            <div class="tb-icon-picker-grid" id="iconGrid"></div>
        </div>
    </div>

    <!-- Media Gallery Modal -->
    <?php tb_render_media_gallery_modal(); ?>

    <!-- Theme Builder Shared JS Modules -->
    <script src="/core/theme-builder/js/media-gallery.js"></script>
    <script src="/core/theme-builder/js/typography.js"></script>
    <script src="/core/theme-builder/js/ai-generate.js"></script>
    <!-- design-settings.js removed: template-edit.php has complete inline implementations -->
</body>
</html>
