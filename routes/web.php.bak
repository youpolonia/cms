<?php

use App\Http\Controllers\ProfileController;
use App\Http\Controllers\ContentController;
use App\Http\Controllers\CategoryController;
use App\Http\Controllers\AnalyticsExportController;
use App\Http\Controllers\UserController;
use App\Http\Controllers\ContentVersionController;
use Illuminate\Support\Facades\Route;
use App\Http\Middleware\TrackContentViews;

Route::get('/', function () {
    return view('welcome');
});

// Role Management Routes
Route::middleware(['auth', 'verified'])->group(function () {
    Route::resource('roles', \App\Http\Controllers\RoleController::class)
        ->middleware('can:manage users');
});

Route::get('/dashboard', function () {
    return view('dashboard');
})->middleware(['auth', 'verified'])->name('dashboard');

    Route::middleware('auth')->group(function () {
        Route::get('/profile', [ProfileController::class, 'edit'])->name('profile.edit');
        Route::patch('/profile', [ProfileController::class, 'update'])->name('profile.update');
        Route::delete('/profile', [ProfileController::class, 'destroy'])->name('profile.destroy');
        
        // User role management
        Route::post('/users/{user}/role', [UserController::class, 'updateRole'])
            ->name('users.role.update')
            ->middleware('can:manage users');
    
        Route::resource('content', ContentController::class)
            ->middleware(['web', TrackContentViews::class]);

        // Moderation routes
        Route::prefix('moderation')->middleware(['auth', 'can:moderate content'])->group(function () {
            Route::get('/', [\App\Http\Controllers\ModerationController::class, 'index'])->name('moderation.index');
            Route::get('/{moderation}', [\App\Http\Controllers\ModerationController::class, 'show'])->name('moderation.show');
            Route::post('/{moderation}/approve', [\App\Http\Controllers\ModerationController::class, 'approve'])->name('moderation.approve');
            Route::post('/{moderation}/reject', [\App\Http\Controllers\ModerationController::class, 'reject'])->name('moderation.reject');
        });

        Route::get('content/generator', [ContentController::class, 'generator'])
            ->name('content.generator');
        Route::post('content/{content}/autosave', [ContentController::class, 'autosave'])
            ->name('content.autosave');
        // Version comparison routes
        Route::get('content/{content}/compare/{version1}/{version2}', [ContentVersionController::class, 'compare'])
            ->name('content.compare');
        Route::get('content/analytics', [ContentController::class, 'analytics'])
            ->name('content.analytics')
            ->middleware('web');
        Route::post('content/export-analytics', [ContentController::class, 'exportAnalytics'])
            ->name('content.export-analytics')
            ->middleware('web');
        Route::post('content/{content}/versions/{version}/restore', [ContentVersionController::class, 'restore'])
            ->name('content.versions.restore');
        Route::get('content/{content}/versions', [ContentController::class, 'versions'])
            ->name('content.versions.index');
        Route::post('content/{content}/versions/{version}/tags', [ContentController::class, 'addTag'])
            ->name('content.versions.tags.add');
        Route::delete('content/{content}/versions/{version}/tags', [ContentController::class, 'removeTag'])
            ->name('content.versions.tags.remove');
            
        Route::prefix('exports')->group(function () {
            Route::get('/', [AnalyticsExportController::class, 'index'])->name('exports.index');
            Route::get('/create', [AnalyticsExportController::class, 'create'])->name('exports.create');
            Route::post('/', [AnalyticsExportController::class, 'store'])->name('exports.store');
            Route::get('/{export}/download', [AnalyticsExportController::class, 'download'])->name('exports.download');
        });
        Route::get('content/{content}/versions/{old}/compare/{new}', [ContentVersionController::class, 'compare'])
            ->name('content.versions.compare');
        Route::resource('categories', CategoryController::class)->except(['index']);
        Route::get('/categories/manage', [CategoryController::class, 'manage'])
            ->name('categories.manage')
            ->middleware('can:manage,category');
        Route::post('/categories/ai-organize', [CategoryController::class, 'aiOrganize'])
            ->name('categories.ai-organize')
            ->middleware('can:manage,category');
        Route::post('/categories/{category}/toggle', [CategoryController::class, 'toggle'])
            ->name('categories.toggle')
            ->middleware('can:manage,category');
        Route::post('/categories/reorder', [CategoryController::class, 'reorder'])
            ->name('categories.reorder')
            ->middleware('can:manage,category');
        Route::get('categories/{category}/export', [CategoryController::class, 'export'])
            ->name('categories.export')
            ->middleware('can:manage,category');
        Route::post('categories/{category}/ai-summary', [CategoryController::class, 'aiSummary'])
            ->name('categories.ai-summary')
            ->middleware('can:manage,category');
            
        Route::get('categories/{category}/dashboard', [CategoryController::class, 'dashboard'])
            ->name('categories.dashboard')
            ->middleware('can:manage,category');
    Route::prefix('moderation')->middleware(['auth', 'can:moderate content'])->group(function () {
        Route::get('/', [\App\Http\Controllers\ModerationController::class, 'index'])->name('moderation.index');
        Route::get('/{moderation}', [\App\Http\Controllers\ModerationController::class, 'show'])->name('moderation.show');
        Route::post('/{moderation}/approve', [\App\Http\Controllers\ModerationController::class, 'approve'])->name('moderation.approve');
        Route::post('/{moderation}/reject', [\App\Http\Controllers\ModerationController::class, 'reject'])->name('moderation.reject');
    });
    Route::get('content/generator', [ContentController::class, 'generator'])
        ->name('content.generator');
    Route::post('content/{content}/autosave', [ContentController::class, 'autosave'])
        ->name('content.autosave');
    // Version comparison routes
    Route::get('content/{content}/compare/{version1}/{version2}', [ContentVersionController::class, 'compare'])
        ->name('content.compare');
    Route::get('content/analytics', [ContentController::class, 'analytics'])
        ->name('content.analytics')
        ->middleware('web');
    Route::post('content/export-analytics', [ContentController::class, 'exportAnalytics'])
        ->name('content.export-analytics')
        ->middleware('web');
    Route::post('content/{content}/versions/{version}/restore', [ContentVersionController::class, 'restore'])
        ->name('content.versions.restore');
    Route::get('content/{content}/versions', [ContentController::class, 'versions'])
        ->name('content.versions.index');
    Route::post('content/{content}/versions/{version}/tags', [ContentController::class, 'addTag'])
        ->name('content.versions.tags.add');
    Route::delete('content/{content}/versions/{version}/tags', [ContentController::class, 'removeTag'])
        ->name('content.versions.tags.remove');
        

    Route::prefix('exports')->group(function () {
        Route::get('/', [AnalyticsExportController::class, 'index'])->name('exports.index');
        Route::get('/create', [AnalyticsExportController::class, 'create'])->name('exports.create');
        Route::post('/', [AnalyticsExportController::class, 'store'])->name('exports.store');
        Route::get('/{export}/download', [AnalyticsExportController::class, 'download'])->name('exports.download');
    });
    Route::get('content/{content}/versions/{old}/compare/{new}', [ContentVersionController::class, 'compare'])
        ->name('content.versions.compare');
    Route::resource('categories', CategoryController::class)->except(['index']);
    Route::get('/categories/manage', [CategoryController::class, 'manage'])
        ->name('categories.manage')
        ->middleware('can:manage,category');
    Route::post('/categories/ai-organize', [CategoryController::class, 'aiOrganize'])
        ->name('categories.ai-organize')
        ->middleware('can:manage,category');
    Route::post('/categories/{category}/toggle', [CategoryController::class, 'toggle'])
        ->name('categories.toggle')
        ->middleware('can:manage,category');
    Route::post('/categories/reorder', [CategoryController::class, 'reorder'])
        ->name('categories.reorder')
        ->middleware('can:manage,category');
    Route::get('categories/{category}/export', [CategoryController::class, 'export'])
        ->name('categories.export')
        ->middleware('can:manage,category');
    Route::post('categories/{category}/ai-summary', [CategoryController::class, 'aiSummary'])
        ->name('categories.ai-summary')
        ->middleware('can:manage,category');
        
    Route::get('categories/{category}/dashboard', [CategoryController::class, 'dashboard'])
        ->name('categories.dashboard')
        ->middleware('can:manage,category');
});

require __DIR__.'/auth.php';
