<?php

// Load Database class for modules that need DB access
if (!class_exists("\core\Database")) {
    require_once dirname(__DIR__) . "/database.php";
}

// Define esc() function if not already defined
if (!function_exists('esc')) {
    function esc(?string $str): string {
        return htmlspecialchars($str ?? '', ENT_QUOTES, 'UTF-8');
    }
}

/**
 * Render icon from format string (fa:home, material:settings, bi:house, fab:facebook, emoji)
 * 
 * @param string $format Icon format string
 * @param string $size Optional size (default: inherit)
 * @param string $color Optional color (default: inherit)
 * @return string HTML for icon
 */
function tb_render_icon_from_format(string $format, string $size = 'inherit', string $color = 'inherit'): string
{
    if (empty($format)) {
        return '';
    }

    $inlineStyle = '';
    if ($size !== 'inherit') {
        $inlineStyle .= 'font-size:' . esc($size) . ';';
    }
    if ($color !== 'inherit') {
        $inlineStyle .= 'color:' . esc($color) . ';';
    }
    $styleAttr = $inlineStyle ? ' style="' . $inlineStyle . '"' : '';

    // Handle FontAwesome space-separated format: "fas fa-utensils", "far fa-star", "fab fa-facebook"
    if (preg_match('/^(fas|far|fab|fal|fad)\s+fa-([a-z0-9-]+)$/i', $format, $m)) {
        $faPrefix = strtolower($m[1]);
        $iconName = $m[2];
        // Map old prefixes to new Font Awesome 6 classes
        $classMap = [
            'fas' => 'fa-solid',
            'far' => 'fa-regular',
            'fab' => 'fa-brands',
            'fal' => 'fa-light',
            'fad' => 'fa-duotone',
        ];
        $faClass = $classMap[$faPrefix] ?? 'fa-solid';
        return '<i class="' . $faClass . ' fa-' . esc($iconName) . '"' . $styleAttr . '></i>';
    }

    // Handle plain "fa-*" format (assume solid)
    if (preg_match('/^fa-([a-z0-9-]+)$/i', $format, $m)) {
        return '<i class="fa-solid fa-' . esc($m[1]) . '"' . $styleAttr . '></i>';
    }

    // Check if it's a formatted icon (prefix:name or prefix:style:name)
    if (strpos($format, ':') !== false) {
        $parts = explode(':', $format);
        $prefix = $parts[0];

        // Handle new fa:style:name format (fa:solid:home, fa:regular:star, fa:brands:facebook)
        if ($prefix === 'fa' && count($parts) === 3) {
            $iconStyle = $parts[1]; // solid, regular, brands
            $iconName = $parts[2];
            $faClass = $iconStyle === 'solid' ? 'fa-solid' : ($iconStyle === 'regular' ? 'fa-regular' : 'fa-brands');
            return '<i class="' . $faClass . ' fa-' . esc($iconName) . '"' . $styleAttr . '></i>';
        }

        $iconName = $parts[1] ?? '';

        switch ($prefix) {
            case 'fa':
                return '<i class="fa-solid fa-' . esc($iconName) . '"' . $styleAttr . '></i>';
            case 'far':
                return '<i class="fa-regular fa-' . esc($iconName) . '"' . $styleAttr . '></i>';
            case 'fab':
                return '<i class="fa-brands fa-' . esc($iconName) . '"' . $styleAttr . '></i>';
            case 'material':
                return '<span class="material-icons"' . $styleAttr . '>' . esc($iconName) . '</span>';
            case 'material-o':
                return '<span class="material-icons-outlined"' . $styleAttr . '>' . esc($iconName) . '</span>';
            case 'bi':
                return '<i class="bi bi-' . esc($iconName) . '"' . $styleAttr . '></i>';
            case 'lucide':
                return '<span' . $styleAttr . '>‚¨°</span>';
            default:
                return '<span' . $styleAttr . '>' . esc($format) . '</span>';
        }
    }

    // Emoji detection
    if (preg_match('/[\x{1F000}-\x{1F9FF}]|[\x{2600}-\x{26FF}]|[\x{2700}-\x{27BF}]/u', $format)) {
        return '<span' . $styleAttr . '>' . $format . '</span>';
    }

    // Legacy icon names
    $legacyMap = [
        'star' => '‚òÖ', 'heart' => '‚ô•', 'check' => '‚úì', 'arrow-right' => '‚Üí',
        'arrow-left' => '‚Üê', 'arrow-up' => '‚Üë', 'arrow-down' => '‚Üì',
        'plus' => '+', 'minus' => '‚àí', 'close' => '‚úï', 'menu' => '‚ò∞',
        'search' => 'üîç', 'user' => 'üë§', 'mail' => '‚úâ', 'phone' => '‚òé',
        'location' => 'üìç', 'calendar' => 'üìÖ', 'clock' => 'üïê',
        'settings' => '‚öô', 'home' => 'üè†'
    ];

    $symbol = $legacyMap[$format] ?? $format;
    return '<span' . $styleAttr . '>' . $symbol . '</span>';
}

/**
 * Theme Builder 3.0 - Renderer
 *
 * Renders Theme Builder content to HTML output.
 * Handles Section‚ÜíRow‚ÜíColumn‚ÜíModule hierarchy.
 *
 * @package ThemeBuilder
 * @version 3.0
 */

// ============================================
// HELPER FUNCTIONS
// ============================================

/**
 * Get element ID or generate one
 */
function tb_get_element_id(array $element): string
{
    return $element['id'] ?? 'tb-' . uniqid();
}

/**
 * Build CSS classes string
 */
function tb_build_classes(string $baseClass, array $element): string
{
    $classes = [$baseClass];

    if (!empty($element['css_class'])) {
        $classes[] = $element['css_class'];
    }

    if (!empty($element['advanced']['css_class'])) {
        $classes[] = $element['advanced']['css_class'];
    }

    return implode(' ', $classes);
}

/**
 * Build inline styles from design array
 */
function tb_build_inline_styles(array $design): string
{
    $styles = [];

    // Width
    if (!empty($design['width'])) {
        $styles[] = 'width:' . $design['width'];
    }

    // Background
    if (!empty($design['background_color'])) {
        $styles[] = 'background-color:' . $design['background_color'];
    }
    if (!empty($design['background_image'])) {
        $styles[] = 'background-image:url(' . $design['background_image'] . ')';
        $styles[] = 'background-size:cover';
        $styles[] = 'background-position:center';
    }

    // Text
    if (!empty($design['text_color'])) {
        $styles[] = 'color:' . $design['text_color'];
    }
    if (!empty($design['font_size'])) {
        $styles[] = 'font-size:' . $design['font_size'];
    }
    if (!empty($design['text_align'])) {
        $styles[] = 'text-align:' . $design['text_align'];
    }
    if (!empty($design['font_weight'])) {
        $styles[] = 'font-weight:' . $design['font_weight'];
    }
    if (!empty($design['line_height'])) {
        $styles[] = 'line-height:' . $design['line_height'];
    }
    if (!empty($design['max_width'])) {
        $styles[] = 'max-width:' . $design['max_width'];
    }
    if (!empty($design['text_shadow'])) {
        $styles[] = 'text-shadow:' . $design['text_shadow'];
    }

    // Padding
    if (!empty($design['padding'])) {
        $styles[] = 'padding:' . $design['padding'];
    }
    if (!empty($design['padding_top'])) {
        $styles[] = 'padding-top:' . $design['padding_top'];
    }
    if (!empty($design['padding_bottom'])) {
        $styles[] = 'padding-bottom:' . $design['padding_bottom'];
    }
    if (!empty($design['padding_left'])) {
        $styles[] = 'padding-left:' . $design['padding_left'];
    }
    if (!empty($design['padding_right'])) {
        $styles[] = 'padding-right:' . $design['padding_right'];
    }

    // Margin
    if (!empty($design['margin'])) {
        $styles[] = 'margin:' . $design['margin'];
    }
    if (!empty($design['margin_top'])) {
        $styles[] = 'margin-top:' . $design['margin_top'];
    }
    if (!empty($design['margin_bottom'])) {
        $styles[] = 'margin-bottom:' . $design['margin_bottom'];
    }

    // Border
    if (!empty($design['border_width']) && !empty($design['border_color'])) {
        $borderStyle = $design['border_style'] ?? 'solid';
        $styles[] = 'border:' . $design['border_width'] . ' ' . $borderStyle . ' ' . $design['border_color'];
    }
    if (!empty($design['border_radius'])) {
        $styles[] = 'border-radius:' . $design['border_radius'];
    }

    // Box shadow - support both single string and individual properties
    if (!empty($design['box_shadow'])) {
        $styles[] = 'box-shadow:' . $design['box_shadow'];
    } elseif (!empty($design['box_shadow_enabled'])) {
        $h = (int)($design['box_shadow_horizontal'] ?? 0);
        $v = (int)($design['box_shadow_vertical'] ?? 4);
        $b = (int)($design['box_shadow_blur'] ?? 10);
        $s = (int)($design['box_shadow_spread'] ?? 0);
        $c = $design['box_shadow_color'] ?? 'rgba(0,0,0,0.1)';
        $inset = !empty($design['box_shadow_inset']) ? 'inset ' : '';
        $styles[] = 'box-shadow:' . $inset . $h . 'px ' . $v . 'px ' . $b . 'px ' . $s . 'px ' . $c;
    }

    // Animation
    if (!empty($design['animation_type']) && $design['animation_type'] !== 'none') {
        $animName = $design['animation_type'];
        $animDuration = ($design['animation_duration'] ?? 500) . 'ms';
        $animDelay = ($design['animation_delay'] ?? 0) . 'ms';
        $styles[] = 'animation:' . $animName . ' ' . $animDuration . ' ease-in-out ' . $animDelay . ' both';
    }

    return implode(';', $styles);
}

/**
 * Build CSS filter styles from settings
 */
function tb_build_filter_styles(array $settings): string
{
    $filters = [];

    if (isset($settings['blur']) && $settings['blur'] > 0) {
        $filters[] = 'blur(' . $settings['blur'] . 'px)';
    }
    if (isset($settings['brightness']) && $settings['brightness'] != 100) {
        $filters[] = 'brightness(' . ($settings['brightness'] / 100) . ')';
    }
    if (isset($settings['contrast']) && $settings['contrast'] != 100) {
        $filters[] = 'contrast(' . ($settings['contrast'] / 100) . ')';
    }
    if (isset($settings['grayscale']) && $settings['grayscale'] > 0) {
        $filters[] = 'grayscale(' . $settings['grayscale'] . '%)';
    }
    if (isset($settings['saturate']) && $settings['saturate'] != 100) {
        $filters[] = 'saturate(' . ($settings['saturate'] / 100) . ')';
    }
    if (isset($settings['sepia']) && $settings['sepia'] > 0) {
        $filters[] = 'sepia(' . $settings['sepia'] . '%)';
    }
    if (isset($settings['opacity']) && $settings['opacity'] < 100) {
        $filters[] = 'opacity(' . ($settings['opacity'] / 100) . ')';
    }

    if (empty($filters)) {
        return '';
    }

    return 'filter:' . implode(' ', $filters);
}

/**
 * Render complete page builder content to HTML
 *
 * @param array $content The page content structure
 * @param array $options Rendering options
 * @return string Generated HTML
 */
function tb_render_page(array $content, array $options = []): string
{
    $html = '';
    $sections = $content['sections'] ?? [];

    foreach ($sections as $section) {
        $html .= tb_render_section($section, $options);
    }

    return $html;
}

/**
 * Render a section element
 *
 * @param array $section Section data
 * @param array $options Rendering options
 * @return string Generated HTML
 */
function tb_render_section(array $section, array $options = []): string
{
    $id = tb_get_element_id($section);
    $classes = tb_build_classes('tb-section', $section);
    $styles = tb_build_inline_styles($section['design'] ?? []);

    $html = '<section id="' . esc($id) . '" class="' . esc($classes) . '"';
    if ($styles) {
        $html .= ' style="' . esc($styles) . '"';
    }
    $html .= '>';

    $html .= '<div class="tb-section-inner">';

    $rows = $section['rows'] ?? [];
    foreach ($rows as $row) {
        $html .= tb_render_row($row, $options);
    }

    $html .= '</div>';
    $html .= '</section>';

    return $html;
}

/**
 * Render a row element
 *
 * @param array $row Row data
 * @param array $options Rendering options
 * @return string Generated HTML
 */
function tb_render_row(array $row, array $options = []): string
{
    $id = tb_get_element_id($row);
    $classes = tb_build_classes('tb-row', $row);
    $styles = tb_build_inline_styles($row['design'] ?? []);

    $html = '<div id="' . esc($id) . '" class="' . esc($classes) . '"';
    if ($styles) {
        $html .= ' style="' . esc($styles) . '"';
    }
    $html .= '>';

    $columns = $row['columns'] ?? [];
    $columnCount = count($columns);

    foreach ($columns as $index => $column) {
        $html .= tb_render_column($column, $columnCount, $index, $options);
    }

    $html .= '</div>';

    return $html;
}

/**
 * Render a column element
 *
 * @param array $column Column data
 * @param int $totalColumns Total columns in row
 * @param int $index Column index
 * @param array $options Rendering options
 * @return string Generated HTML
 */
function tb_render_column(array $column, int $totalColumns, int $index, array $options = []): string
{
    $id = tb_get_element_id($column);
    $width = $column['width'] ?? (100 / $totalColumns);

    // Convert to numeric if string with %
    if (is_string($width)) {
        $width = (float) str_replace('%', '', $width);
    }

    // Map width to CSS class for responsive grid
    $widthClass = '';
    if (abs($width - 100) < 1) $widthClass = 'tb-col-100';
    elseif (abs($width - 80) < 1) $widthClass = 'tb-col-80';
    elseif (abs($width - 75) < 1) $widthClass = 'tb-col-75';
    elseif (abs($width - 66.666) < 2) $widthClass = 'tb-col-66';
    elseif (abs($width - 60) < 1) $widthClass = 'tb-col-60';
    elseif (abs($width - 50) < 1) $widthClass = 'tb-col-50';
    elseif (abs($width - 40) < 1) $widthClass = 'tb-col-40';
    elseif (abs($width - 33.333) < 2) $widthClass = 'tb-col-33';
    elseif (abs($width - 25) < 1) $widthClass = 'tb-col-25';
    elseif (abs($width - 20) < 1) $widthClass = 'tb-col-20';

    $baseClasses = 'tb-column' . ($widthClass ? ' ' . $widthClass : '');
    $classes = tb_build_classes($baseClasses, $column);

    $design = $column['design'] ?? [];
    // Don't include width in inline styles - CSS classes handle it
    $styles = tb_build_inline_styles($design);

    $html = '<div id="' . esc($id) . '" class="' . esc($classes) . '"';
    if ($styles) {
        $html .= ' style="' . esc($styles) . '"';
    }
    $html .= '>';

    $modules = $column['modules'] ?? [];
    foreach ($modules as $module) {
        $html .= tb_render_module($module, $options);
    }

    $html .= '</div>';

    return $html;
}

/**
 * Render a module element
 *
 * @param array $module Module data
 * @param array $options Rendering options
 * @return string Generated HTML
 */
function tb_render_module(array $module, array $options = []): string
{
    $type = $module['type'] ?? 'text';
    $id = tb_get_element_id($module);
    $classes = tb_build_classes('tb-module tb-module-' . $type, $module);
    // Merge design and settings for inline styles (TB saves spacing to settings, not design)
    $designData = array_merge($module['design'] ?? [], $module['settings'] ?? []);
    $designStyles = tb_build_inline_styles($designData);
    $filterStyles = tb_build_filter_styles($module['settings'] ?? []);
    $styles = trim($designStyles . ($filterStyles ? '; ' . $filterStyles : ''), '; ');

    $html = '<div id="' . esc($id) . '" class="' . esc($classes) . '"';
    if ($styles) {
        $html .= ' style="' . esc($styles) . '"';
    }
    $html .= '>';

    // Render module-specific content
    $renderFn = 'tb_render_module_' . $type;
    if (function_exists($renderFn)) {
        $html .= $renderFn($module, $options);
    } else {
        $html .= tb_render_module_fallback($module, $options);
    }

    $html .= '</div>';

    return $html;
}

/**
 * Fallback renderer for unknown module types
 */
function tb_render_module_fallback(array $module, array $options = []): string
{
    $type = $module['type'] ?? 'unknown';
    $content = $module['content'] ?? [];
    
    // Try to render something sensible from content
    if (isset($content['text'])) {
        return '<div class="tb-fallback-content">' . ($content['text'] ?? '') . '</div>';
    }
    if (isset($content['title'])) {
        return '<div class="tb-fallback-content"><h3>' . esc($content['title'] ?? '') . '</h3></div>';
    }
    
    return '<div class="tb-fallback-content" style="padding:20px;background:#f5f5f5;border:1px dashed #ccc;text-align:center;color:#666">Module: ' . esc($type) . '</div>';
}

/**
 * Render text module content
 * Applies design properties: text_color, font_size, line_height, text_align, max_width, margin
 */
function tb_render_module_text(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $d = $module['design'] ?? [];
    $text = $c['text'] ?? '';

    // Build inline styles from design properties
    $styles = [];

    if (!empty($d['text_color'])) {
        $styles[] = 'color:' . esc($d['text_color']);
    }
    if (!empty($d['font_size'])) {
        $styles[] = 'font-size:' . esc($d['font_size']);
    }
    if (!empty($d['line_height'])) {
        $styles[] = 'line-height:' . esc($d['line_height']);
    }
    if (!empty($d['text_align'])) {
        $styles[] = 'text-align:' . esc($d['text_align']);
    }
    if (!empty($d['font_weight'])) {
        $styles[] = 'font-weight:' . esc($d['font_weight']);
    }
    if (!empty($d['max_width'])) {
        $styles[] = 'max-width:' . esc($d['max_width']);
    }

    // Margin (support both single value and individual sides)
    if (!empty($d['margin'])) {
        $styles[] = 'margin:' . esc($d['margin']);
    } else {
        if (!empty($d['margin_top'])) {
            $styles[] = 'margin-top:' . esc($d['margin_top']);
        }
        if (!empty($d['margin_bottom'])) {
            $styles[] = 'margin-bottom:' . esc($d['margin_bottom']);
        }
        if (!empty($d['margin_left'])) {
            $styles[] = 'margin-left:' . esc($d['margin_left']);
        }
        if (!empty($d['margin_right'])) {
            $styles[] = 'margin-right:' . esc($d['margin_right']);
        }
    }

    $styleAttr = !empty($styles) ? ' style="' . implode(';', $styles) . '"' : '';

    return '<div class="tb-text-content"' . $styleAttr . '>' . $text . '</div>';
}

/**
 * Render image module content
 * Applies design properties: border_radius, box_shadow, max_width
 */
function tb_render_module_image(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $d = $module['design'] ?? [];
    $src = $c['src'] ?? $c['url'] ?? '';
    $alt = $c['alt'] ?? '';
    $title = $c['title'] ?? '';
    $lazy = $module['advanced']['lazy_load'] ?? true;

    // Size and display settings - check both content and design
    $width = $c['width'] ?? $d['width'] ?? '100%';
    $maxWidth = $c['max_width'] ?? $d['max_width'] ?? '';
    $height = $c['height'] ?? $d['height'] ?? 'auto';
    $objectFit = $c['object_fit'] ?? $d['object_fit'] ?? '';
    $alignment = $c['alignment'] ?? $d['alignment'] ?? $d['text_align'] ?? 'center';
    $borderRadius = $c['border_radius'] ?? $d['border_radius'] ?? '0';

    if (empty($src)) {
        return '';
    }

    // Build style
    $styles = [];
    $styles[] = 'display:block';
    $styles[] = 'width:' . esc($width);
    $styles[] = 'height:' . esc($height);
    if ($maxWidth) $styles[] = 'max-width:' . esc($maxWidth);
    if ($objectFit) $styles[] = 'object-fit:' . esc($objectFit);
    if ($borderRadius && $borderRadius !== '0') $styles[] = 'border-radius:' . esc($borderRadius);

    // Box shadow from design
    if (!empty($d['box_shadow'])) {
        $styles[] = 'box-shadow:' . esc($d['box_shadow']);
    } elseif (!empty($d['box_shadow_blur'])) {
        $sh = $d['box_shadow_horizontal'] ?? '0';
        $sv = $d['box_shadow_vertical'] ?? '4';
        $sb = $d['box_shadow_blur'] ?? '10';
        $ss = $d['box_shadow_spread'] ?? '0';
        $sc = $d['box_shadow_color'] ?? 'rgba(0,0,0,0.1)';
        $styles[] = 'box-shadow:' . esc($sh) . 'px ' . esc($sv) . 'px ' . esc($sb) . 'px ' . esc($ss) . 'px ' . esc($sc);
    }

    // Alignment via margin
    if ($alignment === 'left') {
        $styles[] = 'margin-right:auto';
    } elseif ($alignment === 'right') {
        $styles[] = 'margin-left:auto';
    } else {
        $styles[] = 'margin:0 auto';
    }

    $html = '<img src="' . esc($src) . '" alt="' . esc($alt) . '" style="' . implode(';', $styles) . '"';
    if ($title) {
        $html .= ' title="' . esc($title) . '"';
    }
    if ($lazy) {
        $html .= ' loading="lazy"';
    }
    $html .= '>';

    return $html;
}

/**
 * Render button module content
 */
function tb_render_module_button(array $module, array $options = []): string
{
    $c = $module["content"] ?? [];
    $d = $module["design"] ?? [];
    
    $text = $c['text'] ?? 'Button';
    $url = $c['url'] ?? '#';
    $target = $c['target'] ?? '_self';
    $btnStyle = $c['style'] ?? 'primary';
    
    // Colors based on button style - apply style presets (use CSS variables for theme compatibility)
    $defaultColors = [
        'primary' => ['bg' => 'var(--primary, #8b5cf6)', 'text' => 'var(--text, #ffffff)', 'border' => 'var(--primary, #8b5cf6)'],
        'secondary' => ['bg' => 'var(--secondary, #6366f1)', 'text' => 'var(--text, #ffffff)', 'border' => 'var(--secondary, #6366f1)'],
        'outline' => ['bg' => 'transparent', 'text' => 'var(--primary, #8b5cf6)', 'border' => 'var(--primary, #8b5cf6)'],
        'ghost' => ['bg' => 'transparent', 'text' => 'inherit', 'border' => 'transparent'],
    ];
    $styleColors = $defaultColors[$btnStyle] ?? $defaultColors['primary'];
    $bgColor = $d['background_color'] ?? $styleColors['bg'];
    $textColor = $d['text_color'] ?? $styleColors['text'];
    if ($btnStyle === 'outline' && empty($d['border_width_top']) && empty($d['border_width'])) {
        $d['border_width'] = '2px';
        $d['border_color'] = $styleColors['border'];
    }
    
    // Border settings - use actual keys from Design Settings
    $borderWidth = $d['border_width_top'] ?? $d['border_width'] ?? '0px';
    $borderColor = $d['border_color'] ?? $bgColor;
    $borderStyle = $d['border_style'] ?? 'solid';
    
    // Border radius - check both naming conventions (tl/tr/br/bl and top_left etc)
    $brTL = $d['border_radius_tl'] ?? $d['border_radius_top_left'] ?? $d['border_radius'] ?? '4px';
    $brTR = $d['border_radius_tr'] ?? $d['border_radius_top_right'] ?? $d['border_radius'] ?? '4px';
    $brBR = $d['border_radius_br'] ?? $d['border_radius_bottom_right'] ?? $d['border_radius'] ?? '4px';
    $brBL = $d['border_radius_bl'] ?? $d['border_radius_bottom_left'] ?? $d['border_radius'] ?? '4px';
    $borderRadius = $brTL . ' ' . $brTR . ' ' . $brBR . ' ' . $brBL;
    
    // Padding
    $paddingT = $d['padding_top'] ?? '12px';
    $paddingR = $d['padding_right'] ?? '24px';
    $paddingB = $d['padding_bottom'] ?? '12px';
    $paddingL = $d['padding_left'] ?? '24px';
    
    // Margin (from spacing box)
    $marginT = $d['margin_top'] ?? '0';
    $marginR = $d['margin_right'] ?? '0';
    $marginB = $d['margin_bottom'] ?? '0';
    $marginL = $d['margin_left'] ?? '0';
    
    // Box shadow
    $shadow = '';
    if (!empty($d['box_shadow_offset_x']) || !empty($d['box_shadow_offset_y']) || !empty($d['box_shadow_blur'])) {
        $sx = $d['box_shadow_offset_x'] ?? '0px';
        $sy = $d['box_shadow_offset_y'] ?? '4px';
        $sb = $d['box_shadow_blur'] ?? '8px';
        $ss = $d['box_shadow_spread'] ?? '0px';
        $sc = $d['box_shadow_color'] ?? 'rgba(0,0,0,0.2)';
        $shadow = "box-shadow:{$sx} {$sy} {$sb} {$ss} {$sc};";
    }
    
    // Animation
    $anim = $d['animation_type'] ?? '';
    $animClass = $anim && $anim !== 'none' ? ' tb-anim-' . $anim : '';
    $animDuration = ($d['animation_duration'] ?? '') ? '--webkit-animation-duration:' . $d['animation_duration'] . 'ms;animation-duration:' . $d['animation_duration'] . 'ms;' : '';
    $animDelay = ($d['animation_delay'] ?? '') ? '--webkit-animation-delay:' . $d['animation_delay'] . 'ms;animation-delay:' . $d['animation_delay'] . 'ms;' : '';
    
    // Build margin string (handle various formats)
    $marginStr = "";
    if ($marginT !== "0" || $marginR !== "0" || $marginB !== "0" || $marginL !== "0") {
        $mT = (strpos($marginT, "px") === false && is_numeric($marginT)) ? $marginT . "px" : $marginT;
        $mR = (strpos($marginR, "px") === false && is_numeric($marginR)) ? $marginR . "px" : $marginR;
        $mB = (strpos($marginB, "px") === false && is_numeric($marginB)) ? $marginB . "px" : $marginB;
        $mL = (strpos($marginL, "px") === false && is_numeric($marginL)) ? $marginL . "px" : $marginL;
        $marginStr = "margin:" . esc($mT) . " " . esc($mR) . " " . esc($mB) . " " . esc($mL) . ";";
    }
    
    $style = "display:inline-block;background:" . esc($bgColor) . ";color:" . esc($textColor) . ";padding:" . esc($paddingT) . " " . esc($paddingR) . " " . esc($paddingB) . " " . esc($paddingL) . ";border-radius:" . esc($borderRadius) . ";border:" . esc($borderWidth) . " " . esc($borderStyle) . " " . esc($borderColor) . ";text-decoration:none;font-weight:500;transition:all 0.2s;" . $marginStr . $shadow . $animDuration . $animDelay;
    
    return '<a href="' . esc($url) . '" target="' . esc($target) . '" class="tb-button' . $animClass . '" style="' . $style . '">' . esc($text) . '</a>';
}

/**
 * Render heading module content
 * Applies design properties: text_color, font_size, font_weight, text_align, margin, text_shadow
 */
function tb_render_module_heading(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $d = $module['design'] ?? [];
    $text = $c['text'] ?? '';
    $level = $c['level'] ?? 'h2';

    // Validate heading level
    if (!in_array($level, ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'])) {
        $level = 'h2';
    }

    // Build inline styles from design properties
    $styles = [];

    if (!empty($d['text_color'])) {
        $styles[] = 'color:' . esc($d['text_color']);
    }
    if (!empty($d['font_size'])) {
        $styles[] = 'font-size:' . esc($d['font_size']);
    }
    if (!empty($d['font_weight'])) {
        $styles[] = 'font-weight:' . esc($d['font_weight']);
    }
    if (!empty($d['text_align'])) {
        $styles[] = 'text-align:' . esc($d['text_align']);
    }
    if (!empty($d['line_height'])) {
        $styles[] = 'line-height:' . esc($d['line_height']);
    }
    if (!empty($d['letter_spacing'])) {
        $styles[] = 'letter-spacing:' . esc($d['letter_spacing']);
    }
    if (!empty($d['text_transform'])) {
        $styles[] = 'text-transform:' . esc($d['text_transform']);
    }
    if (!empty($d['text_shadow'])) {
        $styles[] = 'text-shadow:' . esc($d['text_shadow']);
    }

    // Margin
    if (!empty($d['margin'])) {
        $styles[] = 'margin:' . esc($d['margin']);
    } else {
        if (!empty($d['margin_top'])) {
            $styles[] = 'margin-top:' . esc($d['margin_top']);
        }
        if (!empty($d['margin_bottom'])) {
            $styles[] = 'margin-bottom:' . esc($d['margin_bottom']);
        }
        if (!empty($d['margin_left'])) {
            $styles[] = 'margin-left:' . esc($d['margin_left']);
        }
        if (!empty($d['margin_right'])) {
            $styles[] = 'margin-right:' . esc($d['margin_right']);
        }
    }

    // Max width (for centered headings)
    if (!empty($d['max_width'])) {
        $styles[] = 'max-width:' . esc($d['max_width']);
    }

    $styleAttr = !empty($styles) ? ' style="' . implode(';', $styles) . '"' : '';

    return '<' . $level . ' class="tb-heading"' . $styleAttr . '>' . $text . '</' . $level . '>';
}

/**
 * Render divider module content
 */
function tb_render_module_divider(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $show = $c['show_divider'] ?? true;

    if (!$show) {
        return '';
    }

    return '<hr class="tb-divider">';
}

/**
 * Render spacer module content
 */
function tb_render_module_spacer(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    return '<div class="tb-spacer"></div>';
}


/**
 * Render video module content
 */
function tb_render_module_video(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $url = $c['url'] ?? '';
    $autoplay = $c['autoplay'] ?? false;
    $controls = $c['controls'] ?? true;
    $aspectRatio = $module['design']['aspect_ratio'] ?? '16:9';

    if (empty($url)) {
        return '';
    }

    // Calculate padding for aspect ratio
    $ratioParts = explode(':', $aspectRatio);
    $paddingPercent = (count($ratioParts) === 2 && (float)$ratioParts[0] > 0)
        ? ((float)$ratioParts[1] / (float)$ratioParts[0]) * 100
        : 56.25;

    $html = '<div class="tb-video-wrapper" style="position:relative;padding-bottom:' . $paddingPercent . '%;height:0;overflow:hidden;">';

    // Detect video type
    if (preg_match('/youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/', $url, $m) ||
        preg_match('/youtu\.be\/([a-zA-Z0-9_-]+)/', $url, $m)) {
        $videoId = $m[1];
        $params = [];
        if ($autoplay) $params[] = 'autoplay=1';
        if (!$controls) $params[] = 'controls=0';
        $paramStr = $params ? '?' . implode('&', $params) : '';
        $html .= '<iframe src="https://www.youtube.com/embed/' . esc($videoId) . $paramStr . '" ';
        $html .= 'style="position:absolute;top:0;left:0;width:100%;height:100%;" ';
        $html .= 'frameborder="0" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>';
    } elseif (preg_match('/vimeo\.com\/(\d+)/', $url, $m)) {
        $videoId = $m[1];
        $params = [];
        if ($autoplay) $params[] = 'autoplay=1';
        $paramStr = $params ? '?' . implode('&', $params) : '';
        $html .= '<iframe src="https://player.vimeo.com/video/' . esc($videoId) . $paramStr . '" ';
        $html .= 'style="position:absolute;top:0;left:0;width:100%;height:100%;" ';
        $html .= 'frameborder="0" allowfullscreen></iframe>';
    } else {
        // Self-hosted video
        $html .= '<video style="position:absolute;top:0;left:0;width:100%;height:100%;"';
        if ($controls) $html .= ' controls';
        if ($autoplay) $html .= ' autoplay muted';
        $html .= '><source src="' . esc($url) . '">Your browser does not support video.</video>';
    }

    $html .= '</div>';
    return $html;
}

/**
 * Render code module content
 */
function tb_render_module_code(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $code = $c['code'] ?? '';
    $language = $c['language'] ?? 'javascript';
    $theme = $module['design']['theme'] ?? 'dark';

    $themeClass = $theme === 'dark' ? 'tb-code-dark' : 'tb-code-light';

    $html = '<div class="tb-code-block ' . esc($themeClass) . '">';
    $html .= '<pre><code class="language-' . esc($language) . '">' . esc($code) . '</code></pre>';
    $html .= '</div>';

    return $html;
}

/**
 * Render quote module content
 */
function tb_render_module_quote(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $text = $c['text'] ?? '';
    $author = $c['author'] ?? '';
    $source = $c['source'] ?? '';
    $style = $module['design']['style'] ?? 'default';

    $html = '<blockquote class="tb-quote tb-quote-' . esc($style) . '">';
    $html .= '<p class="tb-quote-text">' . esc($text) . '</p>';

    if ($author || $source) {
        $html .= '<footer class="tb-quote-footer">';
        if ($author) {
            $html .= '<cite class="tb-quote-author">' . esc($author) . '</cite>';
        }
        if ($source) {
            $html .= '<span class="tb-quote-source">' . esc($source) . '</span>';
        }
        $html .= '</footer>';
    }

    $html .= '</blockquote>';
    return $html;
}

/**
 * Render list module content
 */
function tb_render_module_list(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $items = $c['items'] ?? [];
    $type = $c['type'] ?? 'unordered';
    $icon = $module['design']['icon'] ?? 'bullet';

    if (empty($items)) {
        return '';
    }

    $tag = $type === 'ordered' ? 'ol' : 'ul';
    $html = '<' . $tag . ' class="tb-list tb-list-' . esc($icon) . '">';

    foreach ($items as $item) {
        $itemText = is_array($item) ? ($item['text'] ?? '') : $item;
        $html .= '<li>' . esc($itemText) . '</li>';
    }

    $html .= '</' . $tag . '>';
    return $html;
}

/**
 * Render icon module content
 */
function tb_render_module_icon(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $icon = $c['icon'] ?? 'star';
    $size = $c['size'] ?? '48px';
    $color = $c['color'] ?? $module['settings']['color'] ?? $module['design']['color'] ?? 'inherit';

    return '<div class="tb-icon-wrapper" style="text-align:center;line-height:1">' . 
           tb_render_icon_from_format($icon, $size, $color) . 
           '</div>';
}

/**
 * Render map module content
 */
function tb_render_module_map(array $module, array $options = []): string
{
    $content = is_array($module['content'] ?? []) && !isset($module['content'][0]) ? $module['content'] : [];
    $address = $content['address'] ?? '';
    $lat = floatval($content['lat'] ?? 0);
    $lng = floatval($content['lng'] ?? 0);
    $zoom = intval($content['zoom'] ?? 14);
    $height = $module['design']['height'] ?? '300px';

    // Priority: 1) Address, 2) Lat/Lng, 3) Default
    if (!empty($address)) {
        $encodedAddress = urlencode($address);
        $embedUrl = 'https://maps.google.com/maps?q=' . $encodedAddress . '&z=' . $zoom . '&output=embed';
    } elseif ($lat != 0 || $lng != 0) {
        $embedUrl = 'https://maps.google.com/maps?q=' . $lat . ',' . $lng . '&z=' . $zoom . '&output=embed';
    } else {
        $embedUrl = 'https://maps.google.com/maps?q=London,UK&z=12&output=embed';
    }

    $html = '<div class="tb-map-wrapper" style="height:' . esc($height) . ';">';
    $html .= '<iframe src="' . esc($embedUrl) . '" style="width:100%;height:100%;border:0;" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>';
    $html .= '</div>';

    return $html;
}


/**
 * Render accordion module content
 */
function tb_render_module_accordion(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $items = $c['items'] ?? [];
    $style = $module['design']['style'] ?? 'default';

    if (empty($items)) {
        return '';
    }

    $accordionId = tb_generate_id('acc');
    $html = '<div class="tb-accordion tb-accordion-' . esc($style) . '" id="' . esc($accordionId) . '">';

    foreach ($items as $idx => $item) {
        $title = $item['title'] ?? 'Item ' . ($idx + 1);
        $content = $item['content'] ?? '';
        $itemId = $accordionId . '-item-' . $idx;
        $isFirst = $idx === 0;

        $html .= '<div class="tb-accordion-item">';
        $html .= '<button class="tb-accordion-header" onclick="this.classList.toggle(\'active\');this.nextElementSibling.classList.toggle(\'open\');">';
        $html .= '<span>' . esc($title) . '</span>';
        $html .= '<span class="tb-accordion-icon">‚ñº</span>';
        $html .= '</button>';
        $html .= '<div class="tb-accordion-content' . ($isFirst ? ' open' : '') . '">';
        $html .= '<div class="tb-accordion-content-inner">' . esc($content) . '</div>';
        $html .= '</div>';
        $html .= '</div>';
    }

    $html .= '</div>';
    return $html;
}

/**
 * Render tabs module content
 */
function tb_render_module_tabs(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $tabs = $c['tabs'] ?? [];
    $style = $module['design']['style'] ?? 'default';

    if (empty($tabs)) {
        return '';
    }

    $tabsId = tb_generate_id('tabs');
    $html = '<div class="tb-tabs tb-tabs-' . esc($style) . '" id="' . esc($tabsId) . '">';

    // Tab headers
    $html .= '<div class="tb-tabs-nav">';
    foreach ($tabs as $idx => $tab) {
        $title = $tab['title'] ?? 'Tab ' . ($idx + 1);
        $activeClass = $idx === 0 ? ' active' : '';
        $html .= '<button class="tb-tab-btn' . $activeClass . '" onclick="tbSwitchTab(this,' . $idx . ')">' . esc($title) . '</button>';
    }
    $html .= '</div>';

    // Tab content panels
    $html .= '<div class="tb-tabs-content">';
    foreach ($tabs as $idx => $tab) {
        $content = $tab['content'] ?? '';
        $activeClass = $idx === 0 ? ' active' : '';
        $html .= '<div class="tb-tab-panel' . $activeClass . '" data-tab="' . $idx . '">' . esc($content) . '</div>';
    }
    $html .= '</div>';

    $html .= '</div>';

    // Inline script for tab switching
    $html .= '<script>function tbSwitchTab(btn,idx){';
    $html .= 'var p=btn.parentElement.parentElement;';
    $html .= 'p.querySelectorAll(".tb-tab-btn").forEach(function(b){b.classList.remove("active");});';
    $html .= 'p.querySelectorAll(".tb-tab-panel").forEach(function(t){t.classList.remove("active");});';
    $html .= 'btn.classList.add("active");';
    $html .= 'p.querySelector(".tb-tab-panel[data-tab=\""+idx+"\"]").classList.add("active");';
    $html .= '}</script>';

    return $html;
}

/**
 * Render gallery module content
 */
function tb_render_module_gallery(array $module, array $options = []): string
{
    $content = is_array($module['content'] ?? []) && !isset($module['content'][0]) ? $module['content'] : [];
    $images = $content['images'] ?? [];
    $columns = $content['columns'] ?? 3;
    $gap = $module['design']['gap'] ?? $content['gap'] ?? '10px';

    if (empty($images)) {
        return '';
    }

    $html = '<div class="tb-gallery" style="display:grid;grid-template-columns:repeat(' . (int)$columns . ',1fr);gap:' . esc($gap) . ';">';

    foreach ($images as $img) {
        $src = is_array($img) ? ($img['src'] ?? '') : $img;
        $alt = is_array($img) ? ($img['alt'] ?? '') : '';

        if ($src) {
            $html .= '<div class="tb-gallery-item">';
            $html .= '<img src="' . esc($src) . '" alt="' . esc($alt) . '" loading="lazy" style="width:100%;height:auto;display:block;">';
            $html .= '</div>';
        }
    }

    $html .= '</div>';
    return $html;
}

/**
 * Render testimonial module content
 * Applies design: text_color, font_size, line_height, background_color, padding, border_radius
 */
function tb_render_module_testimonial(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $d = $module['design'] ?? [];
    $text = $c['text'] ?? '';
    $author = $c['author'] ?? '';
    $role = $c['role'] ?? '';
    $avatar = $c['avatar'] ?? '';
    $style = $d['style'] ?? 'card';

    // Build container styles
    $containerStyles = [];
    if (!empty($d['background_color'])) {
        $containerStyles[] = 'background-color:' . esc($d['background_color']);
    }
    if (!empty($d['padding'])) {
        $containerStyles[] = 'padding:' . esc($d['padding']);
    } else {
        $containerStyles[] = 'padding:30px';
    }
    if (!empty($d['border_radius'])) {
        $containerStyles[] = 'border-radius:' . esc($d['border_radius']);
    }
    if (!empty($d['box_shadow'])) {
        $containerStyles[] = 'box-shadow:' . esc($d['box_shadow']);
    }

    // Text styles
    $textColor = $d['text_color'] ?? '#e0e0e0';
    $fontSize = $d['font_size'] ?? '18px';
    $lineHeight = $d['line_height'] ?? '1.7';

    $containerStyleStr = !empty($containerStyles) ? ' style="' . implode(';', $containerStyles) . '"' : '';

    $html = '<div class="tb-testimonial tb-testimonial-' . esc($style) . '"' . $containerStyleStr . '>';

    // Quote icon
    $html .= '<div style="font-size:48px;color:' . esc($d['quote_color'] ?? 'rgba(255,255,255,0.2)') . ';line-height:1;margin-bottom:15px">"</div>';

    if ($avatar) {
        $html .= '<div class="tb-testimonial-avatar" style="margin-bottom:15px">';
        $html .= '<img src="' . esc($avatar) . '" alt="' . esc($author) . '" loading="lazy" style="width:60px;height:60px;border-radius:50%;object-fit:cover">';
        $html .= '</div>';
    }

    $html .= '<div class="tb-testimonial-content">';
    $html .= '<blockquote class="tb-testimonial-text" style="color:' . esc($textColor) . ';font-size:' . esc($fontSize) . ';line-height:' . esc($lineHeight) . ';font-style:italic;margin:0 0 20px">' . esc($text) . '</blockquote>';

    if ($author || $role) {
        $html .= '<div class="tb-testimonial-author">';
        if ($author) {
            $authorColor = $d['author_color'] ?? '#ffffff';
            $html .= '<span class="tb-testimonial-name" style="color:' . esc($authorColor) . ';font-weight:600;display:block">' . esc($author) . '</span>';
        }
        if ($role) {
            $roleColor = $d['role_color'] ?? '#94a3b8';
            $html .= '<span class="tb-testimonial-role" style="color:' . esc($roleColor) . ';font-size:14px">' . esc($role) . '</span>';
        }
        $html .= '</div>';
    }

    $html .= '</div>';
    $html .= '</div>';

    return $html;
}

/**
 * Render CTA module content
 */
function tb_render_module_cta(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $title = $c['title'] ?? '';
    $subtitle = $c['subtitle'] ?? '';
    $buttonText = $c['button_text'] ?? 'Get Started';
    $buttonUrl = $c['button_url'] ?? '#';
    $style = $module['design']['style'] ?? 'centered';

    $html = '<div class="tb-cta tb-cta-' . esc($style) . '">';

    if ($title) {
        $html .= '<h2 class="tb-cta-title">' . esc($title) . '</h2>';
    }
    if ($subtitle) {
        $html .= '<p class="tb-cta-subtitle">' . esc($subtitle) . '</p>';
    }
    if ($buttonText) {
        $html .= '<a href="' . esc($buttonUrl) . '" class="tb-cta-button">' . esc($buttonText) . '</a>';
    }

    $html .= '</div>';
    return $html;
}

/**
 * Render pricing module content
 */
function tb_render_module_pricing(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $title = $c['title'] ?? '';
    $price = $c['price'] ?? '';
    $period = $c['period'] ?? '/month';
    $features = $c['features'] ?? [];
    $buttonText = $c['button_text'] ?? 'Choose';
    $buttonUrl = $c['button_url'] ?? '#';
    $highlighted = $module['design']['highlighted'] ?? false;

    $highlightClass = $highlighted ? ' tb-pricing-highlighted' : '';
    $html = '<div class="tb-pricing' . $highlightClass . '">';

    if ($highlighted) {
        $html .= '<div class="tb-pricing-badge">Popular</div>';
    }

    if ($title) {
        $html .= '<h3 class="tb-pricing-title">' . esc($title) . '</h3>';
    }

    if ($price) {
        $html .= '<div class="tb-pricing-price">';
        $html .= '<span class="tb-pricing-amount">' . esc($price) . '</span>';
        $html .= '<span class="tb-pricing-period">' . esc($period) . '</span>';
        $html .= '</div>';
    }

    if (!empty($features)) {
        $html .= '<ul class="tb-pricing-features">';
        foreach ($features as $feature) {
            $featureText = is_array($feature) ? ($feature['text'] ?? '') : $feature;
            $html .= '<li>' . esc($featureText) . '</li>';
        }
        $html .= '</ul>';
    }

    if ($buttonText) {
        $html .= '<a href="' . esc($buttonUrl) . '" class="tb-pricing-button">' . esc($buttonText) . '</a>';
    }

    $html .= '</div>';
    return $html;
}

/**
 * Render form module content
 */
function tb_render_module_form(array $module, array $options = []): string
{
    $content = is_array($module['content'] ?? []) && !isset($module['content'][0]) ? $module['content'] : [];
    $title = $content['title'] ?? 'Get In Touch';
    $submitText = $content['submit_text'] ?? 'Send Message';
    $successMessage = $content['success_message'] ?? 'Thank you! Your message has been sent.';
    $recipientEmail = $content['recipient_email'] ?? '';
    $buttonStyle = $content['button_style'] ?? 'primary';
    $buttonFullWidth = $content['button_full_width'] ?? false;
    $style = $content['style'] ?? 'stacked';

    $fields = $content['fields'] ?? [
        ['type' => 'text', 'label' => 'Name', 'placeholder' => 'Your name', 'required' => true],
        ['type' => 'email', 'label' => 'Email', 'placeholder' => 'your@email.com', 'required' => true],
        ['type' => 'textarea', 'label' => 'Message', 'placeholder' => 'Your message...', 'required' => true]
    ];

    $btnClasses = 'tb-form-submit';
    if ($buttonFullWidth) {
        $btnClasses .= ' tb-form-submit-full';
    }

    $html = '<div class="tb-form-container">';

    if ($title) {
        $html .= '<h3 class="tb-form-title">' . esc($title) . '</h3>';
    }

    $html .= '<form class="tb-form tb-form-' . esc($style) . '" method="post" data-success="' . esc($successMessage) . '">';

    if ($recipientEmail) {
        $html .= '<input type="hidden" name="_recipient" value="' . esc($recipientEmail) . '">';
    }

    $html .= '<div class="tb-form-fields">';

    foreach ($fields as $index => $field) {
        $fieldType = $field['type'] ?? 'text';
        $fieldLabel = $field['label'] ?? '';
        $fieldPlaceholder = $field['placeholder'] ?? '';
        $fieldRequired = $field['required'] ?? false;
        $fieldName = 'field_' . $index;

        $html .= '<div class="tb-form-field tb-form-field-' . esc($fieldType) . '">';

        if ($fieldLabel) {
            $html .= '<label class="tb-form-label" for="' . esc($fieldName) . '">';
            $html .= esc($fieldLabel);
            if ($fieldRequired) {
                $html .= '<span class="tb-form-required">*</span>';
            }
            $html .= '</label>';
        }

        if ($fieldType === 'textarea') {
            $html .= '<textarea name="' . esc($fieldName) . '" id="' . esc($fieldName) . '" class="tb-form-input tb-form-textarea" placeholder="' . esc($fieldPlaceholder) . '"';
            if ($fieldRequired) {
                $html .= ' required';
            }
            $html .= ' rows="4"></textarea>';
        } elseif ($fieldType === 'select') {
            $opts = $field['options'] ?? [];
            $html .= '<select name="' . esc($fieldName) . '" id="' . esc($fieldName) . '" class="tb-form-input tb-form-select"';
            if ($fieldRequired) {
                $html .= ' required';
            }
            $html .= '>';
            $html .= '<option value="">' . esc($fieldPlaceholder ?: 'Select...') . '</option>';
            foreach ($opts as $opt) {
                $optValue = is_array($opt) ? ($opt['value'] ?? '') : $opt;
                $optLabel = is_array($opt) ? ($opt['label'] ?? $optValue) : $opt;
                $html .= '<option value="' . esc($optValue) . '">' . esc($optLabel) . '</option>';
            }
            $html .= '</select>';
        } else {
            $html .= '<input type="' . esc($fieldType) . '" name="' . esc($fieldName) . '" id="' . esc($fieldName) . '" class="tb-form-input" placeholder="' . esc($fieldPlaceholder) . '"';
            if ($fieldRequired) {
                $html .= ' required';
            }
            $html .= '>';
        }

        $html .= '</div>';
    }

    $html .= '</div>';
    $html .= '<button type="submit" class="' . esc($btnClasses) . ' tb-form-btn-' . esc($buttonStyle) . '">' . esc($submitText) . '</button>';
    $html .= '</form>';
    $html .= '</div>';

    return $html;
}

/**
 * Render fullwidth code module
 */
function tb_render_module_fullwidth_code(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $code = $content['code'] ?? '';
    $language = strtolower($content['language'] ?? 'javascript');

    $html = '<div class="tb-fullwidth-code">';
    
    // Execute code based on language type
    switch ($language) {
        case 'javascript':
        case 'js':
            $html .= '<script>' . $code . '</script>';
            break;
        case 'css':
            $html .= '<style>' . $code . '</style>';
            break;
        case 'html':
            $html .= $code;
            break;
        default:
            // Display as code block for other languages
            $html .= '<pre><code class="language-' . esc($language) . '">' . esc($code) . '</code></pre>';
            break;
    }
    
    $html .= '</div>';

    return $html;
}

/**
 * Render fullwidth image module
 */
function tb_render_module_fullwidth_image(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $src = $content['src'] ?? '';
    $alt = $content['alt'] ?? '';
    $link = $content['link'] ?? '';
    $height = $design['height'] ?? '400px';

    $html = '<div class="tb-fullwidth-image" style="height:' . esc($height) . '">';
    if ($src) {
        $img = '<img src="' . esc($src) . '" alt="' . esc($alt) . '" style="width:100%;height:100%;object-fit:cover">';
        if ($link) {
            $html .= '<a href="' . esc($link) . '">' . $img . '</a>';
        } else {
            $html .= $img;
        }
    }
    $html .= '</div>';

    return $html;
}

/**
 * Render fullwidth map module
 */
function tb_render_module_fullwidth_map(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $address = $content['address'] ?? '';
    $zoom = $content['zoom'] ?? 14;
    $height = $design['height'] ?? '400px';

    $html = '<div class="tb-fullwidth-map" style="height:' . esc($height) . '">';
    if ($address) {
        $encodedAddress = urlencode($address);
        $html .= '<iframe src="https://maps.google.com/maps?q=' . $encodedAddress . '&z=' . (int)$zoom . '&output=embed" width="100%" height="100%" style="border:0" allowfullscreen loading="lazy"></iframe>';
    }
    $html .= '</div>';

    return $html;
}

/**
 * Render fullwidth menu module
 */
function tb_render_module_fullwidth_menu(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $logo = $content['logo'] ?? '';
    $menuItems = $content['items'] ?? $content['menu_items'] ?? [];
    $bgColor = $design['background_color'] ?? '#1e1e2e';
    $textColor = $design['text_color'] ?? '#ffffff';
    $hoverColor = $design['hover_color'] ?? 'var(--primary)';

    $html = '<nav class="tb-fullwidth-menu" style="background:' . esc($bgColor) . ';color:' . esc($textColor) . ';padding:16px 24px;display:flex;justify-content:space-between;align-items:center">';
    if ($logo) {
        $html .= '<img src="' . esc($logo) . '" alt="Logo" style="height:40px">';
    }
    $html .= '<ul style="display:flex;gap:24px;list-style:none;margin:0;padding:0">';
    foreach ($menuItems as $item) {
        $label = $item['label'] ?? $item['text'] ?? '';
        $url = $item['url'] ?? '#';
        $html .= '<li><a href="' . esc($url) . '" style="color:' . esc($textColor) . ';text-decoration:none">' . esc($label) . '</a></li>';
    }
    $html .= '</ul>';
    $html .= '</nav>';

    return $html;
}

/**
 * Render fullwidth slider module
 */
function tb_render_module_fullwidth_slider(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $slides = $content['slides'] ?? [];
    $minHeight = $design['min_height'] ?? '600px';
    $showArrows = $design['show_arrows'] ?? true;
    $showDots = $design['show_dots'] ?? true;
    $autoplay = $design['autoplay'] ?? false;
    $autoplaySpeed = $design['autoplay_speed'] ?? 5000;

    if (empty($slides)) {
        return '<div class="tb-fullwidth-slider" style="min-height:' . esc($minHeight) . ';display:flex;align-items:center;justify-content:center;background:#f5f5f5;color:#999">No slides added</div>';
    }

    $sliderId = 'slider-' . uniqid();
    $slideCount = count($slides);

    $html = '<div class="tb-fullwidth-slider" id="' . $sliderId . '" style="position:relative;min-height:' . esc($minHeight) . ';overflow:hidden">';

    // Slides
    foreach ($slides as $i => $slide) {
        $bgImage = !empty($slide['image']) ? 'background-image:url(' . esc($slide['image']) . ');background-size:cover;background-position:center;' : 'background:linear-gradient(135deg,#667eea,#764ba2);';
        $display = $i === 0 ? 'flex' : 'none';
        $html .= '<div class="tb-slide" data-index="' . $i . '" style="position:absolute;inset:0;display:' . $display . ';align-items:center;justify-content:center;' . $bgImage . ';transition:opacity 0.5s">';
        $html .= '<div style="position:absolute;inset:0;background:rgba(0,0,0,0.4)"></div>';
        $html .= '<div style="position:relative;z-index:1;text-align:center;color:#fff;padding:20px;max-width:800px">';
        $html .= '<h2 style="font-size:clamp(24px,5vw,48px);margin:0 0 16px;font-weight:700">' . esc($slide['title'] ?? '') . '</h2>';
        $html .= '<p style="font-size:clamp(14px,2vw,20px);margin:0 0 24px;opacity:0.9">' . esc($slide['text'] ?? '') . '</p>';
        if (!empty($slide['button_text'])) {
            $html .= '<a href="' . esc($slide['button_url'] ?? '#') . '" style="display:inline-block;padding:14px 32px;background:var(--primary);color:#fff;text-decoration:none;border-radius:6px;font-weight:600;transition:opacity 0.3s" onmouseover="this.style.opacity=\'0.85\'" onmouseout="this.style.opacity=\'1\'">' . esc($slide['button_text']) . '</a>';
        }
        $html .= '</div></div>';
    }

    // Navigation Arrows
    if ($showArrows && $slideCount > 1) {
        $arrowStyle = 'position:absolute;top:50%;transform:translateY(-50%);z-index:10;width:50px;height:50px;border:none;background:rgba(255,255,255,0.9);color:#333;font-size:24px;cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background 0.3s,transform 0.3s;box-shadow:0 2px 10px rgba(0,0,0,0.2)';
        $html .= '<button class="tb-slider-prev" onclick="tbSliderPrev(\'' . $sliderId . '\')" style="' . $arrowStyle . ';left:20px" onmouseover="this.style.background=\'#fff\';this.style.transform=\'translateY(-50%) scale(1.1)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.9)\';this.style.transform=\'translateY(-50%) scale(1)\'">&#10094;</button>';
        $html .= '<button class="tb-slider-next" onclick="tbSliderNext(\'' . $sliderId . '\')" style="' . $arrowStyle . ';right:20px" onmouseover="this.style.background=\'#fff\';this.style.transform=\'translateY(-50%) scale(1.1)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.9)\';this.style.transform=\'translateY(-50%) scale(1)\'">&#10095;</button>';
    }

    // Navigation Dots
    if ($showDots && $slideCount > 1) {
        $html .= '<div class="tb-slider-dots" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);z-index:10;display:flex;gap:10px">';
        for ($i = 0; $i < $slideCount; $i++) {
            $activeDot = $i === 0 ? 'background:#fff' : 'background:rgba(255,255,255,0.5)';
            $html .= '<button class="tb-slider-dot" data-index="' . $i . '" onclick="tbSliderGoTo(\'' . $sliderId . '\',' . $i . ')" style="width:12px;height:12px;border-radius:50%;border:none;' . $activeDot . ';cursor:pointer;transition:background 0.3s"></button>';
        }
        $html .= '</div>';
    }

    $html .= '</div>';

    // Slider JavaScript (inline for self-contained module)
    $html .= '<script>
    (function() {
        var slider = document.getElementById("' . $sliderId . '");
        if (!slider) return;
        var slides = slider.querySelectorAll(".tb-slide");
        var dots = slider.querySelectorAll(".tb-slider-dot");
        var current = 0;
        var total = slides.length;
        
        window.tbSliderGoTo = function(id, index) {
            if (id !== "' . $sliderId . '") return;
            slides[current].style.display = "none";
            if (dots[current]) dots[current].style.background = "rgba(255,255,255,0.5)";
            current = (index + total) % total;
            slides[current].style.display = "flex";
            if (dots[current]) dots[current].style.background = "#fff";
        };
        
        window.tbSliderNext = function(id) {
            if (id !== "' . $sliderId . '") return;
            tbSliderGoTo(id, current + 1);
        };
        
        window.tbSliderPrev = function(id) {
            if (id !== "' . $sliderId . '") return;
            tbSliderGoTo(id, current - 1);
        };
        ' . ($autoplay ? '
        setInterval(function() { tbSliderNext("' . $sliderId . '"); }, ' . (int)$autoplaySpeed . ');' : '') . '
    })();
    </script>';

    return $html;
}

/**
 * Render fullwidth header module
 */
function tb_render_module_fullwidth_header(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $title = $content['title'] ?? 'Welcome';
    $subtitle = $content['subtitle'] ?? '';
    $buttonText = $content['button_text'] ?? '';
    $buttonUrl = $content['button_url'] ?? '#';
    $bgImage = $content['background_image'] ?? '';
    $minHeight = $design['min_height'] ?? '500px';
    $textAlign = $design['text_align'] ?? 'center';

    $bgStyle = $bgImage ? 'background-image:url(' . esc($bgImage) . ');background-size:cover;background-position:center;' : 'background:linear-gradient(135deg,#1e3a5f,#2d5016);';

    $html = '<header class="tb-fullwidth-header" style="position:relative;min-height:' . esc($minHeight) . ';display:flex;align-items:center;justify-content:center;' . $bgStyle . '">';
    $html .= '<div style="position:absolute;inset:0;background:rgba(0,0,0,0.5)"></div>';
    $html .= '<div style="position:relative;z-index:1;text-align:' . esc($textAlign) . ';color:#fff;padding:40px;max-width:800px">';
    $html .= '<h1 style="font-size:48px;margin:0 0 16px">' . esc($title) . '</h1>';
    if ($subtitle) {
        $html .= '<p style="font-size:20px;margin:0 0 24px;opacity:0.9">' . esc($subtitle) . '</p>';
    }
    if ($buttonText) {
        $html .= '<a href="' . esc($buttonUrl) . '" style="display:inline-block;padding:14px 32px;background:var(--primary);color:#fff;text-decoration:none;border-radius:6px;font-weight:600">' . esc($buttonText) . '</a>';
    }
    $html .= '</div>';
    $html .= '</header>';

    return $html;
}

/**
 * Render fullwidth portfolio module
 */
function tb_render_module_fullwidth_portfolio(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $items = $content['items'] ?? [];
    $showFilter = $content['show_filter'] ?? true;
    $columns = $design['columns'] ?? 3;
    $gap = $design['gap'] ?? '0';

    $categories = [];
    foreach ($items as $item) {
        $cat = $item['category'] ?? 'Uncategorized';
        if (!in_array($cat, $categories)) {
            $categories[] = $cat;
        }
    }

    $html = '<div class="tb-fullwidth-portfolio">';

    if ($showFilter && count($categories) > 0) {
        $html .= '<div class="tb-portfolio-filter" style="text-align:center;padding:20px">';
        $html .= '<button class="tb-filter-btn active" data-filter="all" style="margin:0 8px;padding:8px 16px;border:none;background:var(--primary);color:#fff;border-radius:4px;cursor:pointer">All</button>';
        foreach ($categories as $cat) {
            $html .= '<button class="tb-filter-btn" data-filter="' . esc($cat) . '" style="margin:0 8px;padding:8px 16px;border:1px solid #e2e8f0;background:#fff;border-radius:4px;cursor:pointer">' . esc($cat) . '</button>';
        }
        $html .= '</div>';
    }

    $html .= '<div class="tb-portfolio-grid" style="display:grid;grid-template-columns:repeat(' . (int)$columns . ',1fr);gap:' . esc($gap) . '">';
    foreach ($items as $item) {
        $html .= '<div class="tb-portfolio-item" data-category="' . esc($item['category'] ?? '') . '" style="position:relative;aspect-ratio:1;overflow:hidden;background:#e2e8f0">';
        if (!empty($item['image'])) {
            $html .= '<img src="' . esc($item['image']) . '" alt="' . esc($item['title'] ?? '') . '" style="width:100%;height:100%;object-fit:cover">';
        }
        $html .= '<div class="tb-portfolio-overlay" style="position:absolute;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff">';
        $html .= '<h4 style="margin:0 0 4px;font-weight:600;font-size:14px">' . esc($item['title'] ?? '') . '</h4>';
        $html .= '<span style="font-size:11px;opacity:0.8">' . esc($item['category'] ?? '') . '</span>';
        $html .= '</div>';
        $html .= '</div>';
    }
    $html .= '</div>';
    $html .= '</div>';

    // Add hover effect CSS
    $html .= '<style>.tb-portfolio-item:hover .tb-portfolio-overlay{opacity:1}</style>';

    return $html;
}

/**
 * Render fullwidth post slider module
 */
function tb_render_module_fullwidth_post_slider(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $postsCount = $content['posts_count'] ?? 5;
    $showExcerpt = $content['show_excerpt'] ?? true;
    $showDate = $content['show_date'] ?? true;
    $showAuthor = $content['show_author'] ?? true;
    $showReadMore = $content['show_read_more'] ?? true;
    $readMoreText = $content['read_more_text'] ?? 'Read More';
    $showArrows = $design['show_arrows'] ?? true;
    $showDots = $design['show_dots'] ?? true;
    $minHeight = $design['min_height'] ?? '500px';

    // Get recent posts from database
    $posts = [];
    try {
        $db = \core\Database::connection();
        $stmt = $db->prepare("SELECT * FROM articles WHERE status = 'published' ORDER BY created_at DESC LIMIT ?");
        $stmt->execute([(int)$postsCount]);
        $posts = $stmt->fetchAll(\PDO::FETCH_ASSOC);
    } catch (\Throwable $e) {
        return '';
    }

    if (empty($posts)) {
        return '';
    }

    $sliderId = 'post-slider-' . uniqid();
    $totalSlides = count($posts);

    $html = '<div class="tb-fullwidth-post-slider" id="' . $sliderId . '" data-total="' . $totalSlides . '" style="position:relative;min-height:' . esc($minHeight) . ';overflow:hidden">';

    foreach ($posts as $i => $post) {
        $bgImage = !empty($post['featured_image']) ? 'background-image:url(' . esc($post['featured_image']) . ');background-size:cover;background-position:center;' : 'background:linear-gradient(135deg,#334155,#222);';
        $display = $i === 0 ? 'flex' : 'none';
        $html .= '<div class="tb-post-slide" data-index="' . $i . '" style="position:absolute;inset:0;display:' . $display . ';align-items:center;justify-content:center;' . $bgImage . '">';
        $html .= '<div style="position:absolute;inset:0;background:rgba(0,0,0,0.5)"></div>';
        $html .= '<div style="position:relative;z-index:1;text-align:center;color:#fff;padding:40px;max-width:800px">';
        if ($showDate) {
            $html .= '<div style="font-size:12px;opacity:0.8;margin-bottom:8px">' . date('M d, Y', strtotime($post['created_at'])) . '</div>';
        }
        $html .= '<h2 style="font-size:36px;margin:0 0 12px">' . esc($post['title']) . '</h2>';
        if ($showExcerpt && !empty($post['excerpt'])) {
            $html .= '<p style="font-size:16px;margin:0 0 16px;opacity:0.9">' . esc(substr($post['excerpt'], 0, 150)) . '...</p>';
        }
        if ($showAuthor) {
            $html .= '<div style="font-size:12px;opacity:0.7;margin-bottom:20px">By ' . esc($post['author'] ?? 'Admin') . '</div>';
        }
        // Read More button - links to /blog/{slug}
        $postSlug = $post['slug'] ?? '';
        if ($showReadMore && $postSlug) {
            $html .= '<a href="/blog/' . esc($postSlug) . '" style="display:inline-block;padding:12px 28px;background:var(--primary);color:#fff;text-decoration:none;border-radius:6px;font-weight:' . esc($fontWeight) . ';font-size:14px">' . esc($readMoreText) . '</a>';
        }
        $html .= '</div></div>';
    }


    // Navigation arrows
    if ($showArrows && $totalSlides > 1) {
        $html .= '<button class="tb-slider-prev" onclick="tbSliderPrev(\'' . $sliderId . '\')" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);z-index:10;background:rgba(0,0,0,0.5);color:#fff;border:none;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center">&#10094;</button>';
        $html .= '<button class="tb-slider-next" onclick="tbSliderNext(\'' . $sliderId . '\')" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);z-index:10;background:rgba(0,0,0,0.5);color:#fff;border:none;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center">&#10095;</button>';
    }

    // Dots navigation
    if ($showDots && $totalSlides > 1) {
        $html .= '<div class="tb-slider-dots" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);z-index:10;display:flex;gap:10px">';
        for ($i = 0; $i < $totalSlides; $i++) {
            $active = $i === 0 ? 'background:#fff' : 'background:rgba(255,255,255,0.5)';
            $html .= '<button class="tb-slider-dot" data-index="' . $i . '" onclick="tbSliderGoTo(\'' . $sliderId . '\',' . $i . ')" style="width:12px;height:12px;border-radius:50%;border:none;cursor:pointer;' . $active . '"></button>';
        }
        $html .= '</div>';
    }

    $html .= '</div>';

    // Add slider JavaScript (only once per page)
    $html .= '<script>
    if (!window.tbSliderInit) {
        window.tbSliderInit = true;
        window.tbSliderCurrent = {};
        window.tbSliderNext = function(id) {
            var slider = document.getElementById(id);
            var total = parseInt(slider.dataset.total);
            var current = window.tbSliderCurrent[id] || 0;
            var next = (current + 1) % total;
            tbSliderGoTo(id, next);
        };
        window.tbSliderPrev = function(id) {
            var slider = document.getElementById(id);
            var total = parseInt(slider.dataset.total);
            var current = window.tbSliderCurrent[id] || 0;
            var prev = (current - 1 + total) % total;
            tbSliderGoTo(id, prev);
        };
        window.tbSliderGoTo = function(id, index) {
            var slider = document.getElementById(id);
            var slides = slider.querySelectorAll(".tb-post-slide, .tb-slide");
            var dots = slider.querySelectorAll(".tb-slider-dot");
            slides.forEach(function(s, i) { s.style.display = i === index ? "flex" : "none"; });
            dots.forEach(function(d, i) { d.style.background = i === index ? "#fff" : "rgba(255,255,255,0.5)"; });
            window.tbSliderCurrent[id] = index;
        };
    }
    </script>';

    return $html;
}


/**
 * Fallback renderer for unknown module types
 */

// ============================================
// RENDERER: blog
// ============================================
function tb_render_module_blog(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $postsCount = $content['posts_count'] ?? 6;
    $columns = $design['columns'] ?? 3;
    $showExcerpt = $content['show_excerpt'] ?? true;
    $showDate = $content['show_date'] ?? true;
    $showAuthor = $content['show_author'] ?? true;
    $showImage = $content['show_image'] ?? true;
    $categoryId = $content['category_id'] ?? null;

    $posts = [];
    try {
        $db = \core\Database::connection();
        $sql = "SELECT a.*, u.username as author_name FROM articles a LEFT JOIN users u ON a.author_id = u.id WHERE a.status = 'published'";
        if ($categoryId) $sql .= " AND a.category_id = " . intval($categoryId);
        $sql .= " ORDER BY a.published_at DESC, a.created_at DESC LIMIT " . intval($postsCount);
        $posts = $db->query($sql)->fetchAll(\PDO::FETCH_ASSOC);
    } catch (\Throwable $e) {
        // Table doesn't exist or other DB error - return placeholder
        return '';
    }

    if (empty($posts)) {
        return '';
    }

    $columnWidth = 'calc(' . (100 / $columns) . '% - 20px)';
    $html = '<div class="tb-blog" style="display:flex;flex-wrap:wrap;gap:20px">';

    foreach ($posts as $post) {
        $html .= '<article style="flex:0 0 ' . $columnWidth . ';background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)">';
        if ($showImage && !empty($post['featured_image'])) {
            $html .= '<img src="' . esc($post['featured_image']) . '" alt="' . esc($post['title']) . '" style="width:100%;height:200px;object-fit:cover">';
        }
        $html .= '<div style="padding:20px">';
        $html .= '<h3 style="margin:0 0 10px"><a href="/blog/' . esc($post['slug']) . '" style="color:#333;text-decoration:none">' . esc($post['title']) . '</a></h3>';
        if ($showDate || $showAuthor) {
            $html .= '<p style="color:#666;font-size:0.85em;margin:0 0 10px">';
            if ($showDate) $html .= date('d.m.Y', strtotime($post['created_at']));
            if ($showDate && $showAuthor) $html .= ' | ';
            if ($showAuthor) $html .= esc($post['author_name'] ?? 'Admin');
            $html .= '</p>';
        }
        if ($showExcerpt && !empty($post['excerpt'])) {
            $html .= '<p style="color:#555;line-height:1.5">' . esc($post['excerpt']) . '</p>';
        }
        $html .= '</div></article>';
    }

    $html .= '</div>';
    return $html;
}

// ============================================
// RENDERER: blurb
// Applies design: background_color, box_shadow, padding, border_radius, icon_color, text_color, etc.
// ============================================
function tb_render_module_blurb(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $title = $content['title'] ?? '';
    $text = $content['text'] ?? '';
    $icon = $content['icon'] ?? '';
    $image = $content['image'] ?? '';
    $useImage = $content['use_image'] ?? false;
    $url = $content['url'] ?? '';
    // Icon settings can be in content or design
    $iconColor = $content['icon_color'] ?? $design['icon_color'] ?? 'var(--primary)';
    $iconSize = $content['icon_size'] ?? $design['icon_size'] ?? '64px';
    $titleColor = $design['title_color'] ?? $design['text_color'] ?? 'inherit';
    $textColor = $design['text_color'] ?? '#666666';
    $alignment = $content['alignment'] ?? $design['text_align'] ?? $design['alignment'] ?? 'center';
    $layout = $content['layout'] ?? 'top'; // top, left, right

    // Build container styles
    $containerStyles = [];
    $flexDirection = $layout === 'left' ? 'row' : ($layout === 'right' ? 'row-reverse' : 'column');
    $containerStyles[] = 'display:flex';
    $containerStyles[] = 'flex-direction:' . $flexDirection;
    $containerStyles[] = 'align-items:center';
    $containerStyles[] = 'text-align:' . esc($alignment);
    $containerStyles[] = 'gap:20px';

    // Padding from design or default
    $padding = $design['padding'] ?? '20px';
    $containerStyles[] = 'padding:' . esc($padding);

    // Background color
    if (!empty($design['background_color'])) {
        $containerStyles[] = 'background-color:' . esc($design['background_color']);
    }

    // Border radius
    if (!empty($design['border_radius'])) {
        $containerStyles[] = 'border-radius:' . esc($design['border_radius']);
    }

    // Box shadow - support both string and individual properties
    if (!empty($design['box_shadow'])) {
        $containerStyles[] = 'box-shadow:' . esc($design['box_shadow']);
    } elseif (!empty($design['box_shadow_enabled']) || !empty($design['box_shadow_blur'])) {
        $sh = $design['box_shadow_horizontal'] ?? '0';
        $sv = $design['box_shadow_vertical'] ?? '4';
        $sb = $design['box_shadow_blur'] ?? '15';
        $ss = $design['box_shadow_spread'] ?? '0';
        $sc = $design['box_shadow_color'] ?? 'rgba(0,0,0,0.1)';
        $containerStyles[] = 'box-shadow:' . esc($sh) . 'px ' . esc($sv) . 'px ' . esc($sb) . 'px ' . esc($ss) . 'px ' . esc($sc);
    }

    // Border
    if (!empty($design['border_width']) && !empty($design['border_color'])) {
        $borderStyle = $design['border_style'] ?? 'solid';
        $containerStyles[] = 'border:' . esc($design['border_width']) . ' ' . esc($borderStyle) . ' ' . esc($design['border_color']);
    }

    $html = '<div class="tb-blurb" style="' . implode(';', $containerStyles) . '">';

    // Render icon or image
    if ($useImage && $image) {
        $html .= '<img src="' . esc($image) . '" alt="' . esc($title) . '" style="max-width:100px;margin-bottom:15px">';
    } elseif ($icon) {
        $html .= '<div class="tb-blurb-icon" style="font-size:' . esc($iconSize) . ';color:' . esc($iconColor) . ';line-height:1">' . tb_render_icon_from_format($icon, $iconSize, $iconColor) . '</div>';
    }

    $html .= '<div class="tb-blurb-content">';

    // Title with styling
    if ($title) {
        $titleStyles = ['margin:0 0 10px'];
        $titleStyles[] = 'color:' . esc($titleColor);
        if (!empty($design['title_size'])) {
            $titleStyles[] = 'font-size:' . esc($design['title_size']);
        }
        if (!empty($design['title_weight'])) {
            $titleStyles[] = 'font-weight:' . esc($design['title_weight']);
        }
        $titleHtml = '<h3 style="' . implode(';', $titleStyles) . '">' . esc($title) . '</h3>';
        $html .= $url ? '<a href="' . esc($url) . '" style="text-decoration:none">' . $titleHtml . '</a>' : $titleHtml;
    }

    // Text with styling
    if ($text) {
        $textStyles = ['margin:0', 'line-height:1.6'];
        $textStyles[] = 'color:' . esc($textColor);
        if (!empty($design['font_size'])) {
            $textStyles[] = 'font-size:' . esc($design['font_size']);
        }
        $html .= '<p style="' . implode(';', $textStyles) . '">' . esc($text) . '</p>';
    }

    $html .= '</div>'; // close tb-blurb-content
    $html .= '</div>'; // close tb-blurb
    return $html;
}

// ============================================
// RENDERER: circle_counter
// ============================================
function tb_render_module_circle_counter(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $percent = min(100, max(0, intval($content['percent'] ?? 75)));
    $title = $content['title'] ?? '';
    $circleColor = $design['circle_color'] ?? 'var(--primary)';
    $bgColor = $design['background_color'] ?? '#e0e0e0';
    $textColor = $design['text_color'] ?? 'inherit';
    $size = $design['size'] ?? 150;

    $circumference = 2 * 3.14159 * 45;
    $offset = $circumference - ($percent / 100) * $circumference;

    $html = '<div class="tb-circle-counter" style="text-align:center">';
    $html .= '<svg width="' . $size . '" height="' . $size . '" viewBox="0 0 100 100">';
    $html .= '<circle cx="50" cy="50" r="45" fill="none" stroke="' . esc($bgColor) . '" stroke-width="8"/>';
    $html .= '<circle cx="50" cy="50" r="45" fill="none" stroke="' . esc($circleColor) . '" stroke-width="8" stroke-dasharray="' . $circumference . '" stroke-dashoffset="' . $offset . '" transform="rotate(-90 50 50)" style="transition:stroke-dashoffset 1s ease"/>';
    $html .= '<text x="50" y="55" text-anchor="middle" font-size="20" fill="' . esc($textColor) . '">' . $percent . '%</text>';
    $html .= '</svg>';
    if ($title) $html .= '<p style="margin:10px 0 0;color:' . esc($textColor) . '">' . esc($title) . '</p>';
    $html .= '</div>';

    return $html;
}

// ============================================
// RENDERER: comments
// ============================================
function tb_render_module_comments(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $postId = $options['post_id'] ?? $content['post_id'] ?? 0;
    $bgColor = $design['background_color'] ?? '#f9f9f9';
    $textColor = $design['text_color'] ?? 'inherit';

    $html = '<div class="tb-comments" style="background:' . esc($bgColor) . ';padding:30px;border-radius:8px">';
    $html .= '<h3 style="color:' . esc($textColor) . ';margin:0 0 20px">Komentarze</h3>';

    if ($postId) {
        $comments = [];
        try {
            $db = \core\Database::connection();
            $stmt = $db->prepare("SELECT * FROM comments WHERE post_id = ? AND status = 'approved' ORDER BY created_at DESC");
            $stmt->execute([$postId]);
            $comments = $stmt->fetchAll(\PDO::FETCH_ASSOC);
        } catch (\Throwable $e) {
            // Comments table not available
        }

        if (empty($comments)) {
            $html .= '<p style="color:#666">No comments yet. Be the first!</p>';
        } else {
            foreach ($comments as $comment) {
                $html .= '<div style="border-bottom:1px solid #ddd;padding:15px 0">';
                $html .= '<strong style="color:' . esc($textColor) . '">' . esc($comment['author_name']) . '</strong>';
                $html .= '<span style="color:#999;font-size:0.85em;margin-left:10px">' . date('d.m.Y H:i', strtotime($comment['created_at'])) . '</span>';
                $html .= '<p style="margin:10px 0 0;color:' . esc($textColor) . '">' . esc($comment['content']) . '</p>';
                $html .= '</div>';
            }
        }
    }

    $html .= '<form class="tb-comment-form" method="post" style="margin-top:20px">';
    $html .= '<input type="hidden" name="post_id" value="' . intval($postId) . '">';
    $html .= '<input type="text" name="author_name" placeholder="Your name" required style="width:100%;padding:10px;margin-bottom:10px;border:1px solid #ddd;border-radius:4px">';
    $html .= '<textarea name="content" placeholder="Your comment" required style="width:100%;padding:10px;min-height:100px;border:1px solid #ddd;border-radius:4px"></textarea>';
    $html .= '<button type="submit" style="margin-top:10px;padding:10px 20px;background:var(--primary);color:#fff;border:none;border-radius:4px;cursor:pointer">Add Comment</button>';
    $html .= '</form></div>';

    return $html;
}

// ============================================
// RENDERER: countdown
// ============================================
function tb_render_module_countdown(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $targetDate = $content['target_date'] ?? date('Y-m-d', strtotime('+7 days'));
    $title = $content['title'] ?? '';
    $bgColor = $design['background_color'] ?? '#1e1e2e';
    $textColor = $design['text_color'] ?? '#ffffff';
    $accentColor = $design['accent_color'] ?? 'var(--primary)';

    $countdownId = 'countdown-' . uniqid();

    $html = '<div class="tb-countdown" id="' . $countdownId . '" data-target="' . esc($targetDate) . '" style="background:' . esc($bgColor) . ';padding:40px;text-align:center;border-radius:8px">';
    if ($title) $html .= '<h3 style="color:' . esc($textColor) . ';margin:0 0 20px">' . esc($title) . '</h3>';
    $html .= '<div style="display:flex;justify-content:center;gap:20px">';
    foreach (['dni', 'godz', 'min', 'sek'] as $unit) {
        $html .= '<div style="text-align:center"><div class="tb-cd-' . $unit . '" style="font-size:3em;font-weight:bold;color:' . esc($accentColor) . '">00</div><div style="color:' . esc($textColor) . ';font-size:0.9em">' . $unit . '</div></div>';
    }
    $html .= '</div></div>';

    return $html;
}

// ============================================
// RENDERER: counter
// ============================================
function tb_render_module_counter(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $number = $content['number'] ?? 0;
    $title = $content['title'] ?? '';
    $prefix = $content['prefix'] ?? '';
    $suffix = $content['suffix'] ?? '';
    $numberColor = $design['number_color'] ?? 'var(--primary)';
    $textColor = $design['text_color'] ?? 'inherit';
    $fontSize = $design['font_size'] ?? '48px';

    $html = '<div class="tb-counter" style="text-align:center;padding:20px">';
    $html .= '<div style="font-size:' . esc($fontSize) . ';font-weight:bold;color:' . esc($numberColor) . '">';
    $html .= esc($prefix) . '<span class="tb-counter-number" data-target="' . intval($number) . '">' . intval($number) . '</span>' . esc($suffix);
    $html .= '</div>';
    if ($title) $html .= '<p style="margin:10px 0 0;color:' . esc($textColor) . ';font-size:1.1em">' . esc($title) . '</p>';
    $html .= '</div>';

    return $html;
}

// ============================================
// RENDERER: hero
// ============================================
function tb_render_module_hero(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $title = $content['title'] ?? '';
    $subtitle = $content['subtitle'] ?? '';
    $text = $content['text'] ?? '';
    $buttonText = $content['button_text'] ?? '';
    $buttonUrl = $content['button_url'] ?? '#';
    $bgImage = $design['background_image'] ?? '';
    $bgColor = $design['background_color'] ?? '#1e1e2e';
    $textColor = $design['text_color'] ?? '#ffffff';
    $overlay = $design['overlay_opacity'] ?? 0.5;
    $minHeight = $design['min_height'] ?? '500px';
    $alignment = $design['alignment'] ?? 'center';

    $bgStyle = $bgImage ? "background-image:url('" . esc($bgImage) . "');background-size:cover;background-position:center" : "background:" . esc($bgColor);

    $html = '<div class="tb-hero" style="' . $bgStyle . ';min-height:' . esc($minHeight) . ';display:flex;align-items:center;justify-content:center;position:relative">';
    if ($bgImage) $html .= '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,' . floatval($overlay) . ')"></div>';
    $html .= '<div style="position:relative;z-index:1;text-align:' . esc($alignment) . ';padding:40px;max-width:800px">';
    if ($subtitle) $html .= '<p style="color:' . esc($textColor) . ';opacity:0.8;margin:0 0 10px;font-size:1.1em">' . esc($subtitle) . '</p>';
    if ($title) $html .= '<h1 style="color:' . esc($textColor) . ';margin:0 0 20px;font-size:3em">' . esc($title) . '</h1>';
    if ($text) $html .= '<p style="color:' . esc($textColor) . ';margin:0 0 30px;font-size:1.2em;line-height:1.6">' . esc($text) . '</p>';
    if ($buttonText) $html .= '<a href="' . esc($buttonUrl) . '" style="display:inline-block;padding:15px 35px;background:var(--primary);color:#fff;text-decoration:none;border-radius:4px;font-size:1.1em">' . esc($buttonText) . '</a>';
    $html .= '</div></div>';

    return $html;
}

// ============================================
// RENDERER: login
// ============================================
function tb_render_module_login(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $title = $content['title'] ?? 'Logowanie';
    $redirectUrl = $content['redirect_url'] ?? '/';
    $showRegister = $content['show_register_link'] ?? true;
    $bgColor = $design['background_color'] ?? '#ffffff';
    $textColor = $design['text_color'] ?? 'inherit';
    $buttonColor = $design['button_color'] ?? 'var(--primary)';

    $html = '<div class="tb-login" style="background:' . esc($bgColor) . ';padding:40px;border-radius:8px;max-width:400px;margin:0 auto">';
    if ($title) $html .= '<h2 style="color:' . esc($textColor) . ';margin:0 0 30px;text-align:center">' . esc($title) . '</h2>';
    $html .= '<form method="post" action="/auth/login">';
    $html .= '<input type="hidden" name="redirect" value="' . esc($redirectUrl) . '">';
    $html .= '<input type="email" name="email" placeholder="Email" required style="width:100%;padding:12px;margin-bottom:15px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box">';
    $html .= '<input type="password" name="password" placeholder="Password" required style="width:100%;padding:12px;margin-bottom:20px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box">';
    $html .= '<button type="submit" style="width:100%;padding:12px;background:' . esc($buttonColor) . ';color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:1em">Log In</button>';
    $html .= '</form>';
    if ($showRegister) $html .= '<p style="text-align:center;margin:20px 0 0;color:' . esc($textColor) . '">Don\'t have an account? <a href="/register" style="color:' . esc($buttonColor) . '">Sign Up</a></p>';
    $html .= '</div>';

    return $html;
}

// ============================================
// RENDERER: menu
// ============================================
function tb_render_module_menu(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $settings = $module['settings'] ?? [];
    $typo = $settings['typography_link'] ?? $settings['typography'] ?? [];
    
    // Settings can be in content, design, or settings - check all
    // Default to cms_menu with id 1 (header menu) if not specified
    $menuSource = $content['menu_source'] ?? 'cms_menu';
    $cmsMenuId = $content['cms_menu_id'] ?? 1;
    $orientation = $content['orientation'] ?? $design['orientation'] ?? 'horizontal';
    $alignment = $content['alignment'] ?? $design['alignment'] ?? 'center';
    $bgColor = $content['background_color'] ?? $design['background_color'] ?? 'transparent';
    $textColor = $content['text_color'] ?? $typo['color'] ?? $design['text_color'] ?? 'inherit';
    $hoverColor = $content['hover_color'] ?? $design['hover_color'] ?? 'var(--primary)';
    $gap = $content['gap'] ?? $design['gap'] ?? '24px';
    $fontSize = $content['font_size'] ?? $typo['font_size'] ?? $design['font_size'] ?? '16px';
    $fontWeight = $content['font_weight'] ?? $typo['font_weight'] ?? $design['font_weight'] ?? '500';
    $fontFamily = $typo['font_family'] ?? 'inherit';
    
    // Get menu items - always try CMS menu first
    $menuItems = [];
    
    // Try to fetch from CMS menu system
    try {
        $pdo = \core\Database::connection();
        
        // If custom items provided, use them
        if ($menuSource === 'custom' && !empty($content['items'])) {
            $menuItems = $content['items'];
        } else {
            // Fetch from CMS menu - try specified id or fallback to header location
            $stmt = $pdo->prepare("SELECT title, url, target FROM menu_items WHERE menu_id = ? AND is_active = 1 ORDER BY sort_order");
            $stmt->execute([(int)$cmsMenuId]);
            while ($row = $stmt->fetch(\PDO::FETCH_ASSOC)) {
                $menuItems[] = [
                    'label' => $row['title'],
                    'url' => $row['url'],
                    'target' => $row['target'] ?? '_self'
                ];
            }
            
            // If no items found and menu_id was default, try header location
            if (empty($menuItems) && $cmsMenuId == 1) {
                $stmt = $pdo->prepare("SELECT mi.title, mi.url, mi.target FROM menu_items mi JOIN menus m ON mi.menu_id = m.id WHERE m.location = 'header' AND mi.is_active = 1 ORDER BY mi.sort_order");
                $stmt->execute();
                while ($row = $stmt->fetch(\PDO::FETCH_ASSOC)) {
                    $menuItems[] = [
                        'label' => $row['title'],
                        'url' => $row['url'],
                        'target' => $row['target'] ?? '_self'
                    ];
                }
            }
        }
    } catch (\Exception $e) {
        // Silently fail, show empty menu
    }
    
    $flexDir = $orientation === 'vertical' ? 'column' : 'row';
    $justifyMap = ['left' => 'flex-start', 'center' => 'center', 'right' => 'flex-end'];
    $justify = $justifyMap[$alignment] ?? 'center';

    $html = '<nav class="tb-menu tb-menu-' . esc($orientation) . '">';
    $html .= '<ul style="display:flex;flex-direction:' . $flexDir . ';justify-content:' . $justify . ';gap:' . esc($gap) . ';list-style:none;margin:0;padding:0">';

    foreach ($menuItems as $item) {
        $label = $item['label'] ?? $item['text'] ?? $item['title'] ?? '';
        $url = $item['url'] ?? '#';
        $target = $item['target'] ?? '_self';
        $targetAttr = $target === '_blank' ? ' target="_blank" rel="noopener"' : '';
        $html .= '<li><a href="' . esc($url) . '"' . $targetAttr . ' style="color:' . esc($textColor) . ';font-size:' . esc($fontSize) . ';text-decoration:none;padding:10px 18px;display:inline-block;border-radius:6px;font-weight:' . esc($fontWeight) . ';transition:all 0.2s" onmouseover="this.style.color=\'' . esc($hoverColor) . '\';this.style.background=\'rgba(59,130,246,0.1)\'" onmouseout="this.style.color=\'' . esc($textColor) . '\';this.style.background=\'transparent\'">' . esc($label) . '</a></li>';
    }
    
    if (empty($menuItems)) {
        $html .= '<li style="color:' . esc($textColor) . ';opacity:0.5;font-size:' . esc($fontSize) . '">No menu items</li>';
    }

    $html .= '</ul></nav>';
    return $html;
}

// ============================================
// RENDERER: portfolio
// ============================================
function tb_render_module_portfolio(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $items = $content['items'] ?? [];
    $columns = $design['columns'] ?? 3;
    $gap = $design['gap'] ?? '20px';
    $showTitle = $content['show_title'] ?? true;
    $showCategory = $content['show_category'] ?? true;

    $columnWidth = 'calc(' . (100 / $columns) . '% - ' . $gap . ')';

    $html = '<div class="tb-portfolio" style="display:flex;flex-wrap:wrap;gap:' . esc($gap) . '">';

    foreach ($items as $item) {
        $image = $item['image'] ?? '';
        $title = $item['title'] ?? '';
        $category = $item['category'] ?? '';
        $url = $item['url'] ?? '#';

        $html .= '<div class="tb-portfolio-item" style="flex:0 0 ' . $columnWidth . ';position:relative;overflow:hidden;border-radius:8px">';
        // Check if image is valid URL
    $hasValidImage = $image && (str_starts_with($image, "http://") || str_starts_with($image, "https://") || str_starts_with($image, "/") || str_starts_with($image, "data:image/"));

    if ($hasValidImage) {
            $html .= '<a href="' . esc($url) . '">';
            $html .= '<img src="' . esc($image) . '" alt="' . esc($title) . '" style="width:100%;aspect-ratio:4/3;object-fit:cover;display:block;transition:transform 0.3s">';
            $html .= '<div style="position:absolute;bottom:0;left:0;right:0;padding:20px;background:linear-gradient(transparent,rgba(0,0,0,0.8));color:#fff">';
            if ($showTitle && $title) $html .= '<h4 style="margin:0 0 5px">' . esc($title) . '</h4>';
            if ($showCategory && $category) $html .= '<span style="opacity:0.8;font-size:0.9em">' . esc($category) . '</span>';
            $html .= '</div></a>';
        }
        $html .= '</div>';
    }

    $html .= '</div>';
    return $html;
}

// ============================================
// RENDERER: post_content
// ============================================
function tb_render_module_post_content(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $postContent = $options['post_content'] ?? $content['content'] ?? '';
    $textColor = $design['text_color'] ?? 'inherit';
    $fontSize = $design['font_size'] ?? '16px';
    $lineHeight = $design['line_height'] ?? '1.8';

    $html = '<div class="tb-post-content" style="color:' . esc($textColor) . ';font-size:' . esc($fontSize) . ';line-height:' . esc($lineHeight) . '">';
    $html .= $postContent;
    $html .= '</div>';

    return $html;
}

// ============================================
// RENDERER: post_slider
// ============================================
function tb_render_module_post_slider(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $postsCount = $content['posts_count'] ?? 5;
    $showExcerpt = $content['show_excerpt'] ?? true;
    $showDate = $content['show_date'] ?? true;
    $showAuthor = $content['show_author'] ?? true;
    $showReadMore = $content['show_read_more'] ?? true;
    $readMoreText = $content['read_more_text'] ?? 'Czytaj wiecej';
    $categoryId = $content['category_id'] ?? null;
    $autoplay = $content['autoplay'] ?? true;
    $interval = $content['interval'] ?? 5000;

    $posts = [];
    try {
        $db = \core\Database::connection();
        $sql = "SELECT a.*, u.username as author_name FROM articles a LEFT JOIN users u ON a.author_id = u.id WHERE a.status = 'published'";
        if ($categoryId) $sql .= " AND a.category_id = " . intval($categoryId);
        $sql .= " ORDER BY a.published_at DESC, a.created_at DESC LIMIT " . intval($postsCount);
        $posts = $db->query($sql)->fetchAll(\PDO::FETCH_ASSOC);
    } catch (\Throwable $e) {
        return '';
    }

    if (empty($posts)) {
        return '';
    }

    $sliderId = 'post-slider-' . uniqid();

    $html = '<div class="tb-post-slider" id="' . $sliderId . '" style="position:relative;overflow:hidden">';
    $html .= '<div class="tb-post-slider-track" style="display:flex;transition:transform 0.5s ease">';

    foreach ($posts as $post) {
        $html .= '<div class="tb-post-slide" style="min-width:100%;position:relative">';
        if (!empty($post['featured_image'])) {
            $html .= '<img src="' . esc($post['featured_image']) . '" alt="' . esc($post['title']) . '" style="width:100%;height:400px;object-fit:cover">';
        }
        $html .= '<div style="position:absolute;bottom:0;left:0;right:0;padding:40px;background:linear-gradient(transparent,rgba(0,0,0,0.8));color:#fff">';
        $html .= '<h3 style="margin:0 0 10px;font-size:1.8em">' . esc($post['title']) . '</h3>';
        if ($showDate || $showAuthor) {
            $html .= '<p style="margin:0 0 10px;opacity:0.8">';
            if ($showDate) $html .= date('d.m.Y', strtotime($post['created_at']));
            if ($showDate && $showAuthor) $html .= ' | ';
            if ($showAuthor) $html .= esc($post['author_name'] ?? 'Admin');
            $html .= '</p>';
        }
        if ($showExcerpt && !empty($post['excerpt'])) {
            $html .= '<p style="margin:0 0 15px;line-height:1.5">' . esc($post['excerpt']) . '</p>';
        }
        if ($showReadMore) {
            $html .= '<a href="/post/' . esc($post['slug']) . '" style="display:inline-block;padding:10px 25px;background:var(--primary);color:#fff;text-decoration:none;border-radius:4px">' . esc($readMoreText) . '</a>';
        }
        $html .= '</div></div>';
    }

    $html .= '</div>';
    $html .= '<button class="tb-slider-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.9);border:none;padding:15px 20px;cursor:pointer;font-size:18px">&lt;</button>';
    $html .= '<button class="tb-slider-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.9);border:none;padding:15px 20px;cursor:pointer;font-size:18px">&gt;</button>';
    $html .= '</div>';

    return $html;
}

// ============================================
// RENDERER: post_title
// ============================================
function tb_render_module_post_title(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $title = $options['post_title'] ?? $content['title'] ?? '';
    $tag = $design['tag'] ?? 'h1';
    $textColor = $design['text_color'] ?? 'inherit';
    $fontSize = $design['font_size'] ?? '2.5em';
    $alignment = $design['alignment'] ?? 'left';

    $allowedTags = ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'span'];
    $tag = in_array($tag, $allowedTags) ? $tag : 'h1';

    $html = '<' . $tag . ' class="tb-post-title" style="color:' . esc($textColor) . ';font-size:' . esc($fontSize) . ';text-align:' . esc($alignment) . ';margin:0">';
    $html .= esc($title);
    $html .= '</' . $tag . '>';

    return $html;
}

// ============================================
// RENDERER: posts_navigation
// ============================================
function tb_render_module_posts_navigation(array $module, array $options = []): string
{
    $content = is_array($module['content'] ?? []) && !isset($module['content'][0]) ? $module['content'] : [];
    $design = $module['design'] ?? [];
    $postId = $options['post_id'] ?? $content['post_id'] ?? 0;
    $prevText = $content['prev_text'] ?? 'Previous Post';
    $nextText = $content['next_text'] ?? 'Next Post';
    $bgColor = $design['background_color'] ?? '#f5f5f5';
    $textColor = $design['text_color'] ?? 'inherit';
    $linkColor = $design['link_color'] ?? 'var(--primary)';

    // Without post context, don't render navigation
    if (!$postId) {
        return '';
    }

    $html = '<nav class="tb-posts-navigation" style="display:flex;justify-content:space-between;padding:20px;background:' . esc($bgColor) . ';border-radius:8px">';

    if ($postId) {
        $prev = null;
        $next = null;
        try {
            $db = \core\Database::connection();

            $stmt = $db->prepare("SELECT id, title, slug FROM posts WHERE id < ? AND status = 'published' ORDER BY id DESC LIMIT 1");
            $stmt->execute([$postId]);
            $prev = $stmt->fetch(\PDO::FETCH_ASSOC);

            $stmt = $db->prepare("SELECT id, title, slug FROM posts WHERE id > ? AND status = 'published' ORDER BY id ASC LIMIT 1");
            $stmt->execute([$postId]);
            $next = $stmt->fetch(\PDO::FETCH_ASSOC);
        } catch (\Throwable $e) {
            // Posts table not available
        }

        if ($prev) {
            $html .= '<a href="/post/' . esc($prev['slug']) . '" style="color:' . esc($linkColor) . ';text-decoration:none">';
            $html .= '<span style="color:' . esc($textColor) . ';font-size:0.85em;display:block">' . esc($prevText) . '</span>';
            $html .= '<span style="font-weight:bold">' . esc($prev['title']) . '</span>';
            $html .= '</a>';
        } else {
            $html .= '<span></span>';
        }

        if ($next) {
            $html .= '<a href="/post/' . esc($next['slug']) . '" style="color:' . esc($linkColor) . ';text-decoration:none;text-align:right">';
            $html .= '<span style="color:' . esc($textColor) . ';font-size:0.85em;display:block">' . esc($nextText) . '</span>';
            $html .= '<span style="font-weight:bold">' . esc($next['title']) . '</span>';
            $html .= '</a>';
        }
    }

    $html .= '</nav>';
    return $html;
}

// ============================================
// RENDERER: search
// ============================================
function tb_render_module_search(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $placeholder = $content['placeholder'] ?? 'Search...';
    $buttonText = $content['button_text'] ?? 'Search';
    $showButton = $content['show_button'] ?? true;
    $bgColor = $design['background_color'] ?? '#ffffff';
    $borderColor = $design['border_color'] ?? '#dddddd';
    $buttonColor = $design['button_color'] ?? 'var(--primary)';

    $html = '<form class="tb-search" action="/search" method="get" style="display:flex;gap:10px">';
    $html .= '<input type="text" name="q" placeholder="' . esc($placeholder) . '" style="flex:1;padding:12px 15px;border:1px solid ' . esc($borderColor) . ';border-radius:4px;background:' . esc($bgColor) . ';font-size:1em">';
    if ($showButton) {
        $html .= '<button type="submit" style="padding:12px 25px;background:' . esc($buttonColor) . ';color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:1em">' . esc($buttonText) . '</button>';
    }
    $html .= '</form>';

    return $html;
}

// ============================================
// RENDERER: sidebar
// ============================================
function tb_render_module_sidebar(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $widgets = $content['widgets'] ?? [];
    $bgColor = $design['background_color'] ?? '#f9f9f9';
    $textColor = $design['text_color'] ?? 'inherit';
    $padding = $design['padding'] ?? '20px';

    $html = '<aside class="tb-sidebar" style="background:' . esc($bgColor) . ';padding:' . esc($padding) . ';border-radius:8px">';

    foreach ($widgets as $widget) {
        $widgetType = $widget['type'] ?? 'text';
        $widgetTitle = $widget['title'] ?? '';

        $html .= '<div class="tb-sidebar-widget" style="margin-bottom:25px">';
        if ($widgetTitle) $html .= '<h4 style="color:' . esc($textColor) . ';margin:0 0 15px;padding-bottom:10px;border-bottom:2px solid var(--primary)">' . esc($widgetTitle) . '</h4>';

        switch ($widgetType) {
            case 'recent_posts':
                $posts = [];
                try {
                    $db = \core\Database::connection();
                    $limit = $widget['limit'] ?? 5;
                    $posts = $db->query("SELECT title, slug, created_at FROM posts WHERE status = 'published' ORDER BY created_at DESC LIMIT " . intval($limit))->fetchAll(\PDO::FETCH_ASSOC);
                } catch (\Throwable $e) {
                    $html .= '<p style="color:#999;font-size:0.9em">Recent posts unavailable</p>';
                    break;
                }
                $html .= '<ul style="list-style:none;margin:0;padding:0">';
                foreach ($posts as $post) {
                    $html .= '<li style="margin-bottom:10px"><a href="/post/' . esc($post['slug']) . '" style="color:' . esc($textColor) . ';text-decoration:none">' . esc($post['title']) . '</a></li>';
                }
                $html .= '</ul>';
                break;

            case 'categories':
                $categories = [];
                try {
                    $db = \core\Database::connection();
                    $categories = $db->query("SELECT name, slug FROM categories ORDER BY name")->fetchAll(\PDO::FETCH_ASSOC);
                } catch (\Throwable $e) {
                    $html .= '<p style="color:#999;font-size:0.9em">Categories unavailable</p>';
                    break;
                }
                $html .= '<ul style="list-style:none;margin:0;padding:0">';
                foreach ($categories as $cat) {
                    $html .= '<li style="margin-bottom:8px"><a href="/category/' . esc($cat['slug']) . '" style="color:' . esc($textColor) . ';text-decoration:none">' . esc($cat['name']) . '</a></li>';
                }
                $html .= '</ul>';
                break;

            case 'text':
            default:
                $html .= '<div style="color:' . esc($textColor) . ';line-height:1.6">' . ($widget['content'] ?? '') . '</div>';
                break;
        }

        $html .= '</div>';
    }

    $html .= '</aside>';
    return $html;
}

// ============================================
// RENDERER: signup
// ============================================
function tb_render_module_signup(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $title = $content['title'] ?? 'Rejestracja';
    $redirectUrl = $content['redirect_url'] ?? '/';
    $showLogin = $content['show_login_link'] ?? true;
    $bgColor = $design['background_color'] ?? '#ffffff';
    $textColor = $design['text_color'] ?? 'inherit';
    $buttonColor = $design['button_color'] ?? 'var(--primary)';

    $html = '<div class="tb-signup" style="background:' . esc($bgColor) . ';padding:40px;border-radius:8px;max-width:400px;margin:0 auto">';
    if ($title) $html .= '<h2 style="color:' . esc($textColor) . ';margin:0 0 30px;text-align:center">' . esc($title) . '</h2>';
    $html .= '<form method="post" action="/auth/register">';
    $html .= '<input type="hidden" name="redirect" value="' . esc($redirectUrl) . '">';
    $html .= '<input type="text" name="name" placeholder="Full Name" required style="width:100%;padding:12px;margin-bottom:15px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box">';
    $html .= '<input type="email" name="email" placeholder="Email" required style="width:100%;padding:12px;margin-bottom:15px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box">';
    $html .= '<input type="password" name="password" placeholder="Password" required style="width:100%;padding:12px;margin-bottom:15px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box">';
    $html .= '<input type="password" name="password_confirm" placeholder="Confirm Password" required style="width:100%;padding:12px;margin-bottom:20px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box">';
    $html .= '<button type="submit" style="width:100%;padding:12px;background:' . esc($buttonColor) . ';color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:1em">Sign Up</button>';
    $html .= '</form>';
    if ($showLogin) $html .= '<p style="text-align:center;margin:20px 0 0;color:' . esc($textColor) . '">Already have an account? <a href="/login" style="color:' . esc($buttonColor) . '">Log In</a></p>';
    $html .= '</div>';

    return $html;
}

// ============================================
// RENDERER: slider
// ============================================
function tb_render_module_slider(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $slides = $content['slides'] ?? [];
    $autoplay = $content['autoplay'] ?? true;
    $interval = $content['interval'] ?? 5000;
    $showArrows = $content['show_arrows'] ?? true;
    $showDots = $content['show_dots'] ?? true;

    $sliderId = 'slider-' . uniqid();

    $html = '<div class="tb-slider" id="' . $sliderId . '" style="position:relative;overflow:hidden;width:100%">';
    $html .= '<div class="tb-slider-track" style="display:flex;transition:transform 0.5s ease">';

    foreach ($slides as $index => $slide) {
        $image = $slide['image'] ?? '';
        $title = $slide['title'] ?? '';
        $text = $slide['text'] ?? '';
        $buttonText = $slide['button_text'] ?? '';
        $buttonUrl = $slide['button_url'] ?? '#';

        $html .= '<div class="tb-slide" style="min-width:100%;position:relative">';
        // Check if image is valid URL
    $hasValidImage = $image && (str_starts_with($image, "http://") || str_starts_with($image, "https://") || str_starts_with($image, "/") || str_starts_with($image, "data:image/"));

    if ($hasValidImage) {
            $html .= '<img src="' . esc($image) . '" alt="' . esc($title) . '" style="width:100%;height:auto;display:block">';
        }
        if ($title || $text || $buttonText) {
            $html .= '<div class="tb-slide-content" style="position:absolute;bottom:20%;left:50%;transform:translateX(-50%);text-align:center;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.5)">';
            if ($title) $html .= '<h2 style="margin:0 0 10px;font-size:2.5em">' . esc($title) . '</h2>';
            if ($text) $html .= '<p style="margin:0 0 20px;font-size:1.2em">' . esc($text) . '</p>';
            if ($buttonText) $html .= '<a href="' . esc($buttonUrl) . '" style="display:inline-block;padding:12px 30px;background:var(--primary);color:#fff;text-decoration:none;border-radius:4px">' . esc($buttonText) . '</a>';
            $html .= '</div>';
        }
        $html .= '</div>';
    }

    $html .= '</div>';

    if ($showArrows && count($slides) > 1) {
        $html .= '<button class="tb-slider-prev" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);color:#fff;border:none;padding:15px 20px;cursor:pointer;font-size:20px">&lt;</button>';
        $html .= '<button class="tb-slider-next" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);color:#fff;border:none;padding:15px 20px;cursor:pointer;font-size:20px">&gt;</button>';
    }

    if ($showDots && count($slides) > 1) {
        $html .= '<div class="tb-slider-dots" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:10px">';
        for ($i = 0; $i < count($slides); $i++) {
            $active = $i === 0 ? '#fff' : 'rgba(255,255,255,0.5)';
            $html .= '<span style="width:12px;height:12px;border-radius:50%;background:' . $active . ';cursor:pointer"></span>';
        }
        $html .= '</div>';
    }

    $html .= '</div>';
    return $html;
}

// ============================================
// RENDERER: team
// ============================================
function tb_render_module_team(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $members = $content['members'] ?? [];
    $columns = $design['columns'] ?? 3;
    $showSocial = $content['show_social'] ?? true;
    $cardBg = $design['card_background'] ?? '#ffffff';
    $textColor = $design['text_color'] ?? 'inherit';
    $gap = $design['gap'] ?? '30px';

    $columnWidth = 'calc(' . (100 / $columns) . '% - ' . $gap . ')';

    $html = '<div class="tb-team" style="display:flex;flex-wrap:wrap;gap:' . esc($gap) . '">';

    foreach ($members as $member) {
        $name = $member['name'] ?? '';
        $position = $member['position'] ?? '';
        $photo = $member['photo'] ?? '';
        $bio = $member['bio'] ?? '';
        $social = $member['social'] ?? [];

        $html .= '<div class="tb-team-member" style="flex:0 0 ' . $columnWidth . ';background:' . esc($cardBg) . ';border-radius:8px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.1)">';

        if ($photo) {
            $html .= '<img src="' . esc($photo) . '" alt="' . esc($name) . '" style="width:100%;aspect-ratio:1;object-fit:cover">';
        }

        $html .= '<div style="padding:20px;text-align:center;color:' . esc($textColor) . '">';
        if ($name) $html .= '<h3 style="margin:0 0 5px;font-size:1.2em">' . esc($name) . '</h3>';
        if ($position) $html .= '<p style="margin:0 0 10px;color:#666;font-size:0.9em">' . esc($position) . '</p>';
        if ($bio) $html .= '<p style="margin:0 0 15px;font-size:0.95em;line-height:1.5">' . esc($bio) . '</p>';

        if ($showSocial && !empty($social)) {
            $html .= '<div style="display:flex;justify-content:center;gap:10px">';
            foreach ($social as $link) {
                $html .= '<a href="' . esc($link['url'] ?? '#') . '" target="_blank" style="color:#666;text-decoration:none">' . esc($link['icon'] ?? 'link') . '</a>';
            }
            $html .= '</div>';
        }

        $html .= '</div></div>';
    }

    $html .= '</div>';
    return $html;
}

// ============================================
// RENDERER: toggle
// ============================================
function tb_render_module_toggle(array $module, array $options = []): string
{
    $c = is_array($module["content"] ?? null) && !isset($module["content"][0]) ? $module["content"] : [];
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $items = $content['items'] ?? [];
    $openFirst = $content['open_first'] ?? false;
    $allowMultiple = $content['allow_multiple'] ?? true;
    $bgColor = $design['background_color'] ?? '#f5f5f5';
    $textColor = $design['text_color'] ?? 'inherit';
    $borderColor = $design['border_color'] ?? '#dddddd';
    $accentColor = $design['accent_color'] ?? 'var(--primary)';

    $toggleId = 'toggle-' . uniqid();

    $html = '<div class="tb-toggle" id="' . $toggleId . '" style="border:1px solid ' . esc($borderColor) . ';border-radius:8px;overflow:hidden">';

    foreach ($items as $index => $item) {
        $title = $item['title'] ?? 'Toggle Item';
        $body = $item['content'] ?? '';
        $isOpen = ($openFirst && $index === 0);
        $itemId = $toggleId . '-' . $index;

        $html .= '<div class="tb-toggle-item" style="border-bottom:1px solid ' . esc($borderColor) . '">';
        $html .= '<button type="button" onclick="tbToggleItem(this)" style="width:100%;padding:15px 20px;background:' . esc($bgColor) . ';color:' . esc($textColor) . ';border:none;text-align:left;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:1em;font-weight:' . esc($fontWeight) . '">';
        $html .= '<span>' . esc($title) . '</span>';
        $html .= '<span class="tb-toggle-icon" style="transition:transform 0.3s">' . ($isOpen ? '-' : '+') . '</span>';
        $html .= '</button>';
        $html .= '<div class="tb-toggle-content" style="padding:0 20px;max-height:' . ($isOpen ? '1000px' : '0') . ';overflow:hidden;transition:max-height 0.3s,padding 0.3s;' . ($isOpen ? 'padding:15px 20px' : '') . '">';
        $html .= '<div style="color:' . esc($textColor) . ';line-height:1.6">' . $body . '</div>';
        $html .= '</div></div>';
    }

    $html .= '</div>';
    return $html;
}

// ============================================
// RENDERER: video_slider
// ============================================
function tb_render_module_video_slider(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $videos = $content['videos'] ?? [];
    $showThumbnails = $content['show_thumbnails'] ?? true;
    $autoplay = $content['autoplay'] ?? false;
    $bgColor = $design['background_color'] ?? '#000000';

    $sliderId = 'video-slider-' . uniqid();

    $html = '<div class="tb-video-slider" id="' . $sliderId . '" style="background:' . esc($bgColor) . ';position:relative">';

    $html .= '<div class="tb-video-main" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden">';

    foreach ($videos as $index => $video) {
        $src = $video['src'] ?? '';
        $type = $video['type'] ?? 'video';
        $poster = $video['poster'] ?? '';
        $display = $index === 0 ? 'block' : 'none';

        $html .= '<div class="tb-video-item" data-index="' . $index . '" style="position:absolute;top:0;left:0;width:100%;height:100%;display:' . $display . '">';

        if ($type === 'youtube') {
            preg_match('/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/', $src, $matches);
            $youtubeId = $matches[1] ?? '';
            if ($youtubeId) {
                $html .= '<iframe src="https://www.youtube.com/embed/' . esc($youtubeId) . '" style="width:100%;height:100%;border:none" allowfullscreen></iframe>';
            }
        } elseif ($type === 'vimeo') {
            preg_match('/vimeo\.com\/(\d+)/', $src, $matches);
            $vimeoId = $matches[1] ?? '';
            if ($vimeoId) {
                $html .= '<iframe src="https://player.vimeo.com/video/' . esc($vimeoId) . '" style="width:100%;height:100%;border:none" allowfullscreen></iframe>';
            }
        } else {
            $html .= '<video src="' . esc($src) . '" poster="' . esc($poster) . '" controls style="width:100%;height:100%;object-fit:cover"' . ($autoplay && $index === 0 ? ' autoplay muted' : '') . '></video>';
        }

        $html .= '</div>';
    }

    $html .= '</div>';

    if ($showThumbnails && count($videos) > 1) {
        $html .= '<div class="tb-video-thumbnails" style="display:flex;gap:10px;padding:10px;overflow-x:auto">';
        foreach ($videos as $index => $video) {
            $poster = $video['poster'] ?? '';
            $title = $video['title'] ?? 'Video ' . ($index + 1);
            $html .= '<div style="flex:0 0 120px;cursor:pointer;opacity:' . ($index === 0 ? '1' : '0.6') . '">';
            if ($poster) {
                $html .= '<img src="' . esc($poster) . '" alt="' . esc($title) . '" style="width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:4px">';
            } else {
                $html .= '<div style="width:100%;aspect-ratio:16/9;background:#333;border-radius:4px;display:flex;align-items:center;justify-content:center;color:#fff">' . esc($title) . '</div>';
            }
            $html .= '</div>';
        }
        $html .= '</div>';
    }

    $html .= '</div>';
    return $html;
}

// ============================================
// RENDERER: audio
// ============================================
function tb_render_module_audio(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $audioUrl = $content['audio_url'] ?? '';
    $title = $content['title'] ?? '';
    $artist = $content['artist'] ?? '';
    $cover = $content['cover_image'] ?? '';
    $autoplay = $content['autoplay'] ?? false;
    $loop = $content['loop'] ?? false;
    $bgColor = $design['background_color'] ?? '#f5f5f5';
    $textColor = $design['text_color'] ?? 'inherit';

    $html = '<div class="tb-audio" style="background:' . esc($bgColor) . ';padding:20px;border-radius:8px;display:flex;align-items:center;gap:20px">';

    if ($cover) {
        $html .= '<img src="' . esc($cover) . '" alt="' . esc($title) . '" style="width:80px;height:80px;object-fit:cover;border-radius:4px">';
    }

    $html .= '<div style="flex:1;color:' . esc($textColor) . '">';
    if ($title) $html .= '<h3 style="margin:0 0 5px">' . esc($title) . '</h3>';
    if ($artist) $html .= '<p style="margin:0 0 10px;color:#666">' . esc($artist) . '</p>';
    $html .= '<audio controls style="width:100%"' . ($autoplay ? ' autoplay' : '') . ($loop ? ' loop' : '') . '>';
    $html .= '<source src="' . esc($audioUrl) . '" type="audio/mpeg">';
    $html .= 'Twoja przegladarka nie obsluguje elementu audio.';
    $html .= '</audio>';
    $html .= '</div></div>';

    return $html;
}

// ============================================
// RENDERER: bar_counters
// ============================================
function tb_render_module_bar_counters(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $bars = $content['bars'] ?? [];
    $barColor = $design['bar_color'] ?? 'var(--primary)';
    $bgColor = $design['background_color'] ?? '#e0e0e0';
    $textColor = $design['text_color'] ?? 'inherit';
    $height = $design['bar_height'] ?? '20px';

    $html = '<div class="tb-bar-counters" style="display:flex;flex-direction:column;gap:15px">';

    foreach ($bars as $bar) {
        $label = $bar['label'] ?? '';
        $percent = min(100, max(0, intval($bar['percent'] ?? 0)));

        $html .= '<div class="tb-bar-item">';
        $html .= '<div style="display:flex;justify-content:space-between;margin-bottom:5px;color:' . esc($textColor) . '">';
        $html .= '<span>' . esc($label) . '</span>';
        $html .= '<span>' . $percent . '%</span>';
        $html .= '</div>';
        $html .= '<div style="background:' . esc($bgColor) . ';border-radius:4px;overflow:hidden;height:' . esc($height) . '">';
        $html .= '<div style="width:' . $percent . '%;background:' . esc($barColor) . ';height:100%;border-radius:4px;transition:width 1s ease"></div>';
        $html .= '</div>';
        $html .= '</div>';
    }

    $html .= '</div>';
    return $html;
}

// ============================================
// RENDERER: social (alias for social_follow)
// ============================================
function tb_render_module_social(array $module, array $options = []): string
{
    return tb_render_module_social_follow($module, $options);
}

// ============================================
// RENDERER: social_follow
// ============================================
function tb_render_module_social_follow(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $networks = $content['networks'] ?? [];
    $urlNewWindow = $content['url_new_window'] ?? true;
    $showFollowButton = $content['show_follow_button'] ?? false;
    
    $iconSize = $design['icon_size'] ?? '44px';
    $iconColor = $design['icon_color'] ?? ''; // empty = brand colors
    $iconShape = $design['icon_shape'] ?? 'circle';
    $gap = $design['gap'] ?? '15px';
    $alignment = $design['alignment'] ?? 'left';
    $bgStyle = $design['background_style'] ?? 'filled';
    
    // Default networks if none provided
    if (empty($networks)) {
        $networks = [
            ['network' => 'facebook', 'url' => '#', 'enabled' => true],
            ['network' => 'twitter', 'url' => '#', 'enabled' => true],
            ['network' => 'instagram', 'url' => '#', 'enabled' => true],
        ];
    }
    
    // Filter enabled networks
    $enabledNetworks = array_filter($networks, fn($n) => !empty($n['enabled']) && !empty($n['url']));
    
    if (empty($enabledNetworks)) {
        $enabledNetworks = $networks; // fallback
    }
    
    // Brand colors for social networks
    $brandColors = [
        'facebook' => '#1877f2',
        'twitter' => '#1da1f2',
        'x' => '#000000',
        'instagram' => '#e4405f',
        'linkedin' => '#0a66c2',
        'youtube' => '#ff0000',
        'pinterest' => '#bd081c',
        'tiktok' => '#000000',
        'github' => 'inherit',
        'dribbble' => '#ea4c89',
        'vimeo' => '#1ab7ea',
        'snapchat' => '#fffc00',
        'whatsapp' => '#25d366',
        'telegram' => '#0088cc',
        'reddit' => '#ff4500',
        'discord' => '#5865f2',
        'twitch' => '#9146ff',
        'spotify' => '#1db954',
        'soundcloud' => '#ff5500',
        'behance' => '#1769ff',
    ];
    
    // SVG icons for social networks
    $icons = [
        'facebook' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>',
        'twitter' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>',
        'x' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>',
        'instagram' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>',
        'linkedin' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>',
        'youtube' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>',
        'pinterest' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.92-7.252 4.158 0 7.392 2.967 7.392 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607 0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017 0z"/></svg>',
        'tiktok' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/></svg>',
        'github' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>',
        'dribbble' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 24C5.385 24 0 18.615 0 12S5.385 0 12 0s12 5.385 12 12-5.385 12-12 12zm10.12-10.358c-.35-.11-3.17-.953-6.384-.438 1.34 3.684 1.887 6.684 1.992 7.308 2.3-1.555 3.936-4.02 4.395-6.87zm-6.115 7.808c-.153-.9-.75-4.032-2.19-7.77l-.066.02c-5.79 2.015-7.86 6.025-8.04 6.4 1.73 1.358 3.92 2.166 6.29 2.166 1.42 0 2.77-.29 4-.814zm-11.62-2.58c.232-.4 3.045-5.055 8.332-6.765.135-.045.27-.084.405-.12-.26-.585-.54-1.167-.832-1.74C7.17 11.775 2.206 11.71 1.756 11.7l-.004.312c0 2.633.998 5.037 2.634 6.855zm-2.42-8.955c.46.008 4.683.026 9.477-1.248-1.698-3.018-3.53-5.558-3.8-5.928-2.868 1.35-5.01 3.99-5.676 7.17zM9.6 2.052c.282.38 2.145 2.914 3.822 6 3.645-1.365 5.19-3.44 5.373-3.702-1.81-1.61-4.19-2.586-6.795-2.586-.825 0-1.63.1-2.4.285zm10.335 3.483c-.218.29-1.935 2.493-5.724 4.04.24.49.47.985.68 1.486.08.18.15.36.22.53 3.41-.43 6.8.26 7.14.33-.02-2.42-.88-4.64-2.31-6.38z"/></svg>',
        'vimeo' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.977 6.416c-.105 2.338-1.739 5.543-4.894 9.609-3.268 4.247-6.026 6.37-8.29 6.37-1.409 0-2.578-1.294-3.553-3.881L5.322 11.4C4.603 8.816 3.834 7.522 3.01 7.522c-.179 0-.806.378-1.881 1.132L0 7.197c1.185-1.044 2.351-2.084 3.501-3.128C5.08 2.701 6.266 1.984 7.055 1.91c1.867-.18 3.016 1.1 3.447 3.838.465 2.953.789 4.789.971 5.507.539 2.45 1.131 3.674 1.776 3.674.502 0 1.256-.796 2.265-2.385 1.004-1.589 1.54-2.797 1.612-3.628.144-1.371-.395-2.061-1.614-2.061-.574 0-1.167.121-1.777.391 1.186-3.868 3.434-5.757 6.762-5.637 2.473.06 3.628 1.664 3.493 4.797l-.013.01z"/></svg>',
        'whatsapp' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>',
        'telegram' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>',
        'reddit' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/></svg>',
        'discord' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189z"/></svg>',
        'twitch' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714z"/></svg>',
        'spotify' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>',
        'soundcloud' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M1.175 12.225c-.051 0-.094.046-.101.1l-.233 2.154.233 2.105c.007.058.05.098.101.098.05 0 .09-.04.099-.098l.255-2.105-.27-2.154c-.009-.06-.052-.1-.1-.1m-.899.828c-.06 0-.091.037-.104.094L0 14.479l.165 1.308c.014.057.045.094.09.094s.089-.037.099-.094l.21-1.308-.21-1.319c-.01-.057-.045-.09-.09-.09m1.83-1.229c-.061 0-.12.045-.12.104l-.21 2.563.225 2.458c0 .06.045.12.119.12.061 0 .105-.061.121-.12l.254-2.474-.254-2.548c-.016-.06-.061-.12-.121-.12m.945-.089c-.075 0-.135.06-.15.135l-.193 2.64.21 2.544c.016.077.075.138.149.138.075 0 .135-.061.15-.138l.24-2.544-.24-2.64c-.015-.074-.074-.135-.149-.135l-.017-.001zm1.155.36c-.005-.09-.075-.149-.159-.149-.09 0-.158.06-.164.149l-.217 2.43.2 2.563c.005.09.075.157.159.157.074 0 .148-.068.148-.158l.227-2.563-.227-2.444.033.015zm.809-1.709c-.101 0-.18.09-.18.181l-.21 3.957.187 2.563c0 .09.08.164.18.164.094 0 .174-.09.18-.18l.209-2.563-.209-3.972c-.008-.104-.088-.18-.18-.18m.959-.914c-.105 0-.195.09-.203.194l-.18 4.872.165 2.548c0 .12.09.209.195.209.104 0 .193-.089.21-.209l.193-2.548-.192-4.856c-.016-.12-.105-.21-.21-.21m.989-.449c-.121 0-.211.089-.225.209l-.165 5.275.165 2.52c.014.119.104.225.225.225.119 0 .225-.105.225-.225l.195-2.52-.196-5.275c0-.12-.105-.225-.225-.225m1.245.045c0-.135-.105-.24-.24-.24-.119 0-.24.105-.24.24l-.149 5.441.149 2.503c.016.135.121.24.256.24s.24-.105.24-.24l.164-2.503-.164-5.456-.016.015zm.749-.134c-.135 0-.255.119-.255.254l-.15 5.322.15 2.473c0 .15.12.255.255.255s.255-.12.255-.27l.15-2.474-.165-5.307c0-.148-.12-.27-.255-.27m1.005.166c-.164 0-.284.135-.284.285l-.103 5.143.135 2.474c0 .149.119.277.284.277.149 0 .271-.12.284-.285l.121-2.443-.135-5.112c-.012-.164-.135-.285-.285-.285m1.184-.945c-.165 0-.301.135-.313.3l-.106 6.094.119 2.441c.015.164.15.301.313.301s.299-.135.314-.301l.136-2.458-.136-6.093c-.015-.18-.149-.3-.314-.3m1.006-.547c-.18 0-.314.149-.33.329l-.12 6.612.135 2.503c0 .164.15.314.33.314.165 0 .313-.149.313-.33l.15-2.503-.164-6.597c-.016-.179-.164-.329-.329-.329m1.021-.133c-.18 0-.33.164-.345.343l-.119 6.69.135 2.474c.015.18.164.328.344.328.164 0 .33-.149.33-.328l.149-2.474-.148-6.69c0-.18-.15-.344-.33-.344m1.185-.104c-.195 0-.344.149-.359.358l-.12 6.75.119 2.473c.016.195.165.359.361.359s.344-.164.359-.359l.135-2.473-.136-6.75c-.014-.21-.164-.359-.359-.359m1.171.015c-.21 0-.36.149-.375.359l-.105 6.69.12 2.458c.015.195.165.36.375.36.195 0 .359-.165.375-.36l.12-2.458-.135-6.69c-.015-.21-.165-.375-.375-.375m1.215-.794c-.045-.012-.09-.012-.135-.012-.164 0-.314.045-.446.119-.015-.075-.015-.135-.015-.209 0-1.666-1.352-3.012-3.018-3.012-.811 0-1.531.375-2.04 1.006-.254-.119-.57-.18-.9-.18-1.381 0-2.504 1.125-2.504 2.504 0 .136.016.255.031.374h-.021c-1.291 0-2.339 1.05-2.339 2.34 0 1.291 1.05 2.34 2.339 2.34h8.939c.949 0 1.726-.778 1.726-1.726 0-.949-.777-1.725-1.726-1.725"/></svg>',
        'behance' => '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.938 4.503c.702 0 1.34.06 1.92.188.577.13 1.07.33 1.485.59.414.26.733.595.96 1.006.224.41.336.908.336 1.49 0 .652-.15 1.2-.453 1.645-.3.443-.757.815-1.365 1.12.826.27 1.444.72 1.854 1.35.41.63.617 1.388.617 2.275 0 .654-.136 1.234-.408 1.737-.27.504-.636.927-1.097 1.272-.46.346-1 .607-1.618.783-.616.177-1.265.265-1.95.265H0v-13.72h6.938zm-.34 5.6c.612 0 1.102-.145 1.47-.44.367-.293.55-.71.55-1.25 0-.318-.06-.583-.174-.793-.118-.21-.28-.38-.487-.51-.21-.127-.455-.217-.74-.275-.29-.058-.596-.086-.92-.086H3.12v3.355h3.48zm.2 5.87c.354 0 .686-.04.994-.12.308-.08.576-.204.804-.373.228-.168.408-.387.54-.656.13-.27.194-.592.194-.97 0-.773-.242-1.344-.726-1.712-.486-.37-1.13-.553-1.934-.553H3.12v4.386h3.68zM21.06 13.47c0 .505-.083.97-.252 1.392-.168.423-.404.79-.71 1.103-.302.313-.66.562-1.076.746-.414.185-.865.278-1.352.278-.54 0-1.04-.107-1.5-.323-.458-.217-.854-.51-1.184-.88-.333-.37-.595-.805-.79-1.3-.195-.497-.293-1.023-.293-1.58 0-.557.09-1.075.278-1.55.19-.475.454-.886.793-1.235.34-.35.74-.623 1.206-.82.465-.198.974-.296 1.528-.296.44 0 .87.08 1.285.236.415.16.78.384 1.093.673.313.29.562.638.75 1.042.187.404.295.852.322 1.344h-5.094c.022.32.09.61.205.873.118.262.27.486.46.67.19.187.41.33.666.432.256.1.532.15.828.15.503 0 .92-.102 1.253-.307.334-.206.577-.48.73-.82h2.05c-.11.343-.266.662-.466.96-.2.3-.438.556-.713.77-.275.214-.584.382-.927.502-.343.12-.713.18-1.108.18-.52 0-1.004-.095-1.456-.283-.45-.19-.845-.458-1.183-.803-.337-.346-.603-.76-.796-1.24-.195-.48-.292-.998-.292-1.555 0-.56.104-1.08.31-1.555.207-.476.487-.887.838-1.235.353-.346.765-.62 1.237-.818.47-.198.972-.296 1.504-.296.455 0 .894.082 1.32.246.425.163.8.396 1.123.698.32.302.58.667.77 1.094.19.428.31.897.363 1.41h-5.092c0-.22.044-.423.132-.61.088-.19.214-.356.376-.5.163-.144.354-.258.573-.342.218-.086.455-.13.71-.13.27 0 .518.046.746.138.228.09.424.217.588.377.163.16.293.353.39.578.095.225.15.472.164.74h-3.188v-.005zM15.21 7.23h5.88v1.36h-5.88z"/></svg>',
    ];
    
    // Shape styles
    $shapeStyles = [
        'circle' => 'border-radius:50%',
        'rounded' => 'border-radius:8px',
        'square' => 'border-radius:0',
    ];
    
    // Alignment mapping
    $justifyMap = [
        'left' => 'flex-start',
        'center' => 'center',
        'right' => 'flex-end',
    ];
    
    $target = $urlNewWindow ? ' target="_blank" rel="noopener noreferrer"' : '';
    
    $html = '<ul class="tb-social-follow" style="display:flex;justify-content:' . esc($justifyMap[$alignment] ?? 'flex-start') . ';gap:' . esc($gap) . ';list-style:none;margin:0;padding:0;flex-wrap:wrap">';
    
    foreach ($enabledNetworks as $network) {
        $networkName = $network['network'] ?? '';
        $url = $network['url'] ?? '#';
        $color = $iconColor ?: ($brandColors[$networkName] ?? 'inherit');
        $icon = $icons[$networkName] ?? '<span>' . esc(ucfirst($networkName)) . '</span>';
        $shape = $shapeStyles[$iconShape] ?? 'border-radius:50%';
        
        $bgColorStyle = '';
        $iconColorStyle = '';
        
        if ($bgStyle === 'filled') {
            $bgColorStyle = 'background:' . esc($color) . ';';
            $iconColorStyle = 'color:#fff;';
        } elseif ($bgStyle === 'outline') {
            $bgColorStyle = 'background:transparent;border:2px solid ' . esc($color) . ';';
            $iconColorStyle = 'color:' . esc($color) . ';';
        } else {
            $bgColorStyle = 'background:transparent;';
            $iconColorStyle = 'color:' . esc($color) . ';';
        }
        
        $html .= '<li class="tb-social-icon tb-social-' . esc($networkName) . '">';
        $html .= '<a href="' . esc($url) . '"' . $target . ' title="Follow on ' . esc(ucfirst($networkName)) . '" style="display:flex;align-items:center;justify-content:center;width:' . esc($iconSize) . ';height:' . esc($iconSize) . ';' . $bgColorStyle . $iconColorStyle . $shape . ';text-decoration:none;transition:opacity 0.3s,transform 0.3s" onmouseover="this.style.opacity=\'0.8\';this.style.transform=\'scale(1.1)\'" onmouseout="this.style.opacity=\'1\';this.style.transform=\'scale(1)\'">';
        $html .= '<span style="display:flex;width:60%;height:60%">' . $icon . '</span>';
        $html .= '</a>';
        $html .= '</li>';
    }
    
    $html .= '</ul>';
    
    return $html;
}

/**
 * Render the site footer template
 *
 * @param array $context Page context
 * @return string Rendered footer HTML
 */
function tb_render_footer(array $context = []): string
{
    return tb_render_template('footer', $context);
}

/**
 * Render a sidebar template
 *
 * @param array $context Page context
 * @return string Rendered sidebar HTML
 */
function tb_render_sidebar(array $context = []): string
{
    return tb_render_template('sidebar', $context);
}

/**
 * Render the 404 page template
 *
 * @param array $context Page context
 * @return string Rendered 404 HTML
 */
function tb_render_404(array $context = []): string
{
    return tb_render_template('404', $context);
}

/**
 * Render an archive template (for blog listing pages)
 *
 * @param array $context Page context including posts data
 * @return string Rendered archive HTML
 */
function tb_render_archive(array $context = []): string
{
    return tb_render_template('archive', $context);
}

/**
 * Render a single post template
 *
 * @param array $context Page context including post data
 * @return string Rendered single post HTML
 */
function tb_render_single(array $context = []): string
{
    return tb_render_template('single', $context);
}

/**
 * Check if a template type has an active template
 *
 * @param string $type Template type
 * @return bool True if an active template exists
 */
function tb_has_template(string $type): bool
{
    try {
        $db = \core\Database::connection();

        $stmt = $db->prepare("
            SELECT COUNT(*) FROM tb_site_templates
            WHERE type = ? AND is_active = 1
        ");
        $stmt->execute([$type]);

        return (int)$stmt->fetchColumn() > 0;
    } catch (\Throwable $e) {
        return false;
    }
}

/**
 * Get CSS for all template types (for including in <head>)
 *
 * @return string Combined CSS for theme builder templates
 */
function tb_get_template_styles(): string
{
    return '
    <style>
    /* Theme Builder Template Styles */
    .tb-template { width: 100%; }
    .tb-template-header { position: relative; z-index: 100; }
    .tb-template-footer { position: relative; z-index: 50; }
    .tb-section { position: relative; }
    .tb-section-inner { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .tb-row { display: flex; flex-wrap: wrap; margin: 0 -10px; }
    .tb-column { padding: 10px; box-sizing: border-box; flex-shrink: 0; }
    .tb-module { margin-bottom: 20px; }

    /* Responsive */
    @media (max-width: 768px) {
        .tb-column { width: 100% !important; }
        .tb-section-inner { padding: 0 15px; }
    }
    </style>
    ';
}
// =============================================
// RENDERER: logo
// =============================================
function tb_render_module_logo(array $module, array $options = []): string
{
    $content = $module['content'] ?? [];
    $design = $module['design'] ?? [];
    $advanced = $module['advanced'] ?? [];
    
    $image = $content['image'] ?? '';
    $alt = esc($content['image_alt'] ?? 'Site Logo');
    $linkUrl = esc($content['link_url'] ?? '/');
    $linkTarget = esc($content['link_target'] ?? '_self');
    $maxHeight = esc($content['max_height'] ?? '60px');
    $useSiteLogo = $content['use_site_logo'] ?? true;
    
    $alignment = esc($design['alignment'] ?? 'left');
    $padding = esc($design['padding'] ?? '10px');
    $hoverOpacity = esc($design['hover_opacity'] ?? '0.8');
    
    $cssClass = esc($advanced['css_class'] ?? '');
    $cssId = esc($advanced['css_id'] ?? '');
    $ariaLabel = esc($advanced['aria_label'] ?? 'Site Logo');
    
    // If no image set and use_site_logo is true, try to get from site settings
    if (empty($image) && $useSiteLogo) {
        try {
            $pdo = \core\Database::connection();
            // Try to get logo from theme settings or site settings
            $stmt = $pdo->query("SELECT value FROM site_settings WHERE `key` = 'site_logo' LIMIT 1");
            $row = $stmt->fetch(\PDO::FETCH_ASSOC);
            if ($row && !empty($row['value'])) {
                $image = $row['value'];
            }
        } catch (\Exception $e) {
            // Silently fail
        }
    }
    
    // Get site name for text fallback
    $siteName = 'Site';
    try {
        $pdo = \core\Database::connection();
        $stmt = $pdo->query("SELECT value FROM site_settings WHERE `key` = 'site_name' LIMIT 1");
        $row = $stmt->fetch(\PDO::FETCH_ASSOC);
        if ($row && !empty($row['value'])) {
            $siteName = $row['value'];
        }
    } catch (\Exception $e) {
        // Use default
    }
    
    $alignCss = match($alignment) {
        'center' => 'text-align:center;',
        'right' => 'text-align:right;',
        default => 'text-align:left;',
    };
    
    $idAttr = $cssId ? "id=\"{$cssId}\"" : '';
    $classAttr = "tb-logo" . ($cssClass ? " {$cssClass}" : '');
    
    $html = "<div {$idAttr} class=\"{$classAttr}\" style=\"{$alignCss}padding:{$padding}\">";
    
    // Check if image is valid URL
    $hasValidImage = $image && (str_starts_with($image, "http://") || str_starts_with($image, "https://") || str_starts_with($image, "/") || str_starts_with($image, "data:image/"));

    if ($hasValidImage) {
        $html .= "<a href=\"{$linkUrl}\" target=\"{$linkTarget}\" aria-label=\"{$ariaLabel}\" style=\"display:inline-block;transition:opacity 0.3s\" onmouseover=\"this.style.opacity={$hoverOpacity}\" onmouseout=\"this.style.opacity=1\">";
        $html .= "<img src=\"" . esc($image) . "\" alt=\"{$alt}\" style=\"max-height:{$maxHeight};width:auto;display:block\">";
        $html .= "</a>";
    } else {
        // Text logo fallback - show site name
        $html .= "<a href=\"{$linkUrl}\" target=\"{$linkTarget}\" style=\"display:inline-flex;align-items:center;font-size:1.5rem;font-weight:700;color:var(--text, #ffffff);text-decoration:none;transition:opacity 0.3s\" onmouseover=\"this.style.opacity={$hoverOpacity}\" onmouseout=\"this.style.opacity=1\">";
        $html .= esc($siteName);
        $html .= "</a>";
    }
    
    $html .= "</div>";
    
    return $html;
}
